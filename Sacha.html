<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-09-16 Mon 09:36 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sacha Chua's Emacs configuration</title>
<meta name="author" content="Sacha Chua" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://sachachua.com/assets/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://sachachua.com/assets/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://sachachua.com/assets/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://sachachua.com/assets/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Sacha Chua's Emacs configuration</h1>
</header><p>
Last exported:  2024-09-16 09:36
</p>

<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#babel-init">About this file</a>
<ul>
<li><a href="#orgb557645">Debugging tips</a></li>
<li><a href="#starting-up">Starting up</a></li>
<li><a href="#emacs-initialization">Emacs initialization</a>
<ul>
<li><a href="#add-package-sources">Add package sources</a></li>
<li><a href="#add-my-elisp-directory-and-other-files">Add my elisp directory and other files</a></li>
</ul>
</li>
<li><a href="#personal-information">Personal information</a></li>
<li><a href="#system-information">System information</a></li>
<li><a href="#reload">Reload</a></li>
<li><a href="#backups">Backups</a></li>
<li><a href="#history">History</a></li>
<li><a href="#windows-configuration">Disabling the toolbar</a></li>
<li><a href="#change-yes-or-no-to-y-or-n">Change "yes or no" to "y or n"</a></li>
<li><a href="#minibuffer-editing-more-space">Minibuffer editing - more space!</a></li>
<li><a href="#killing-text">Killing text</a></li>
</ul>
</li>
<li><a href="#keybindings">Keybindings</a>
<ul>
<li><a href="#org6149e92">Extended command list</a></li>
<li><a href="#menus">Menus</a></li>
<li><a href="#context-menus">Context menus</a></li>
<li><a href="#repeatable-commands">Repeatable commands</a></li>
<li><a href="#hydras">Hydra keyboard shortcuts</a>
<ul>
<li><a href="#hydra-completion">Emacs Hydra: Allow completion when I can't remember the command name</a></li>
</ul>
</li>
<li><a href="#which-key-and-which-key-posframe">which-key and which-key-posframe</a></li>
<li><a href="#key-chord">Key chords</a></li>
</ul>
</li>
<li><a href="#completion">Completion</a>
<ul>
<li><a href="#consult">Consult</a>
<ul>
<li><a href="#completing-blog-posts">Completing blog posts</a></li>
<li><a href="#completing-sketches">Completing sketches</a></li>
<li><a href="#consult-directory-navigation">Consult directory navigation</a></li>
<li><a href="#using-projects-as-a-source-for-consult-buffer">Using projects as a source for consult-buffer</a></li>
</ul>
</li>
<li><a href="#org5ca8338">Marginalia</a>
<ul>
<li><a href="#marginalia-and-annotating-journal-entries">Marginalia and annotating journal entries</a></li>
</ul>
</li>
<li><a href="#embark">Embark</a>
<ul>
<li><a href="#embark-qr">Using Embark and qrencode to show a QR code for the Org Mode link at point&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a></li>
<li><a href="#embark-video"><span class="todo TODO">TODO</span> Using Embark to act on video</a></li>
<li><a href="#embark-audio"><span class="todo TODO">TODO</span> Using Embark to act on audio</a></li>
<li><a href="#using-embark-to-insert-files-as-org-includes">Using Embark to insert files as Org INCLUDEs</a></li>
<li><a href="#using-embark-to-offer-context-sensitive-actions-for-org-elements">Using Embark to offer context-sensitive actions for Org elements</a></li>
<li><a href="#org77a8d72">Whichkey and Embark</a></li>
<li><a href="#org8c1d8d5">Embark and images</a>
<ul>
<li><a href="#embark-image"><span class="todo TODO">TODO</span> Using Embark to act on images</a></li>
</ul>
</li>
<li><a href="#embark-subed">Embark and subed</a></li>
<li><a href="#org8448eaf">Embark, symbols, and casual-symbol-overlay</a></li>
</ul>
</li>
<li><a href="#cargo-culted-stuff">Cargo-culted stuff</a></li>
</ul>
</li>
<li><a href="#appearance">Appearance</a>
<ul>
<li><a href="#color-theme-sometimes-comes-across-lists-odd">color-theme sometimes comes across lists. Odd!</a></li>
<li><a href="#display">Display</a></li>
<li><a href="#color-theme">Color theme</a>
<ul>
<li><a href="#set-up-a-light-on-dark-color-scheme">Set up a light-on-dark color scheme</a></li>
<li><a href="#making-highlight-sexp-follow-modus-themes-toggle">Making highlight-sexp follow modus-themes-toggle&#xa0;&#xa0;&#xa0;<span class="tag"><span class="elisp">elisp</span>&#xa0;<span class="emacs">emacs</span></span></a></li>
</ul>
</li>
<li><a href="#modeline">Modeline</a>
<ul>
<li><a href="#time-in-the-modeline">Time in the modeline</a></li>
<li><a href="#diminish">Diminish mode names in modeline</a></li>
<li><a href="#highlight-the-active-modeline-using-colours-from-modus-themes">Highlight the active modeline using colours from modus-themes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
</ul>
</li>
<li><a href="#prepare-for-emacsconf-screenshots-or-recordings">Prepare for EmacsConf screenshots or recordings</a></li>
</ul>
</li>
<li><a href="#navigation">Navigation</a>
<ul>
<li><a href="#quickly-jump-to-positions">Quickly jump to positions</a></li>
<li><a href="#undo-tree-mode-visualize-your-undos-and-branches">Undo tree mode - visualize your undos and branches</a></li>
<li><a href="#winner-mode-undo-and-redo-window-configuration">Winner mode - undo and redo window configuration</a></li>
<li><a href="#sort-read-file-name"><span class="todo TODO">TODO</span> Sort files in read-file-name</a></li>
<li><a href="#org6ec2f95">Downloaded files</a></li>
<li><a href="#searching">Searching</a>
<ul>
<li><a href="#deleting-things">Deleting things</a></li>
<li><a href="#org508d6a5">Transient for isearch</a></li>
<li><a href="#org4e222ce">Search invisible text</a></li>
<li><a href="#org94033e9">Occur</a></li>
</ul>
</li>
<li><a href="#ediff">Ediff</a></li>
<li><a href="#hideshow">Hideshow</a></li>
<li><a href="#pop-to-mark">Pop to mark</a></li>
<li><a href="#helm-swoop-quickly-finding-lines">Helm-swoop - quickly finding lines</a></li>
<li><a href="#highlight-line-mode">Highlight Line Mode</a></li>
<li><a href="#windmove-switching-between-windows">Windmove - switching between windows</a></li>
<li><a href="#frequently-accessed-files">Frequently-accessed files</a></li>
<li><a href="#smartscan">Smartscan</a></li>
<li><a href="#dired">Dired</a>
<ul>
<li><a href="#peep-dired">peep-dired</a></li>
<li><a href="#saving-photos">Saving photos</a></li>
</ul>
</li>
<li><a href="#move-to-beginning-of-line">Move to beginning of line</a></li>
<li><a href="#recent-files">Recent files</a></li>
<li><a href="#copy-filename-to-clipboard">Copy filename to clipboard</a></li>
<li><a href="#open-files-externally">Open files externally</a></li>
<li><a href="#toggle">Toggle</a></li>
<li><a href="#link-hint">link-hint</a></li>
<li><a href="#bookmarks">Bookmarks</a></li>
<li><a href="#dogears">Dogears</a></li>
<li><a href="#random">Randomness for serendipity</a>
<ul>
<li><a href="#building-a-today-i-learned-habit-and-displaying-the-documentation-for-random-emacs-commands">Building a today-I-learned habit, and displaying the documentation for random Emacs commands&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#shuffling-lines">Shuffling lines</a></li>
</ul>
</li>
<li><a href="#network-tramp-and-editing-files-over-ssh">Network: TRAMP and editing files over SSH</a></li>
<li><a href="#touch">Touch gestures</a></li>
</ul>
</li>
<li><a href="#reading">Reading</a></li>
<li><a href="#writing-and-editing">Writing and editing</a>
<ul>
<li><a href="#gif-screencast">gif-screencast</a></li>
<li><a href="#sentences-end-with-a-single-space">Sentences end with a single space</a></li>
<li><a href="#writeroom">Writeroom</a></li>
<li><a href="#try-redacting">Try redacting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="config">config</span></span></a></li>
<li><a href="#transcript-keywords"><span class="done DONE">DONE</span> Audio braindump workflow tweaks: Adding Org Mode hyperlinks to recordings based on keywords</a>
<ul>
<li><a href="#recognizing-keyword-phrases">Recognizing keyword phrases</a></li>
<li><a href="#splitting-the-lines-based-on-keywords-and-oopses">Splitting the lines based on keywords and oopses</a></li>
<li><a href="#preparing-the-vtt-subtitles">Preparing the VTT subtitles</a></li>
<li><a href="#formatting-the-subtitles-into-org-mode-subtrees">Formatting the subtitles into Org Mode subtrees</a></li>
<li><a href="#process-a-single-transcript-from-the-raw-text-file">Process a single transcript from the raw text file</a></li>
<li><a href="#process-multiple-files">Process multiple files</a></li>
<li><a href="#ideas-for-next-steps">Ideas for next steps</a></li>
</ul>
</li>
<li><a href="#markdown">Markdown</a></li>
<li><a href="#screenshot">Screenshot</a></li>
<li><a href="#avoiding-weasel-words">Avoiding weasel words</a></li>
<li><a href="#unfill-paragraph">Unfill paragraph</a></li>
<li><a href="#unicode">Unicode</a></li>
<li><a href="#clean-up-spaces">Clean up spaces</a></li>
<li><a href="#expand">Expand</a></li>
<li><a href="#write-about-keybindings">Write about keybindings</a></li>
<li><a href="#subed">Subtitles with Subed</a>
<ul>
<li><a href="#adjust-subtitles"><span class="todo TODO">TODO</span> Adjust subtitles</a></li>
<li><a href="#extract-part-of-a-video">Extract part of a video</a></li>
<li><a href="#hide-ids-and-times">Hide IDs and times</a></li>
<li><a href="#other-subtitle-code">Other subtitle code</a></li>
<li><a href="#using-emacs-to-fix-automatically-generated-subtitle-timestamps">Using Emacs to fix automatically generated subtitle timestamps&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#word-level">Using word-level timing information when editing subtitles or captions in Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#showing-captions">Showing captions</a></li>
<li><a href="#edit-text">Edit text</a></li>
<li><a href="#working-with-media">Working with media</a></li>
<li><a href="#org7bab297"><span class="todo TODO">TODO</span> Working with sections defined by NOTE comments</a></li>
<li><a href="#split-up-oops-better"><span class="todo TODO">TODO</span> Split up oops better</a></li>
<li><a href="#org-youtube-captions"><span class="todo TODO">TODO</span> Org Mode: Insert YouTube video with separate captions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#orge0664c0">Export transcript as list</a></li>
</ul>
</li>
<li><a href="#transcripts-from-my-phone">Transcripts from my phone</a></li>
<li><a href="#speech-recognition">Speech recognition</a>
<ul>
<li><a href="#using-emacs-lisp-to-send-audio-files-to-deepgram-and-format-vtts">TOBLOG Using Emacs Lisp to send audio files to Deepgram and format VTTs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="speech">speech</span></span></a></li>
<li><a href="#rerecognize">TOBLOG Rerecognize this audio and reprocess it</a></li>
<li><a href="#gladia">Gladia</a></li>
<li><a href="#live-speech"><span class="done DONE">DONE</span> Getting live speech into Emacs with Deepgram's streaming API&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="speech">speech</span></span></a>
<ul>
<li><a href="#general-code">General code</a></li>
<li><a href="#display-in-speech-buffer">Display in speech buffer</a></li>
<li><a href="#display-words-per-minute">Display words per minute</a></li>
<li><a href="#append-to-emacsconf-etherpad">Append to EmacsConf Etherpad</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#utf-8">UTF-8</a></li>
<li><a href="#wdiff">Wdiff</a></li>
</ul>
</li>
<li><a href="#org">Org Mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span></span></a>
<ul>
<li><a href="#org-files">My files</a></li>
<li><a href="#modules">Modules</a></li>
<li><a href="#keyboard-shortcuts">Keyboard shortcuts</a>
<ul>
<li><a href="#speed-commands">Speed commands</a></li>
</ul>
</li>
<li><a href="#org-navigation">Org navigation</a>
<ul>
<li><a href="#link-org-subtrees-and-navigate-between-them">Link Org subtrees and navigate between them</a></li>
<li><a href="#viewing-navigating-and-editing-the-org-tree">Viewing, navigating, and editing the Org tree</a></li>
<li><a href="#finding-my-place-on-a-small-mobile-screen-with-org-back-to-heading">Finding my place on a small mobile screen with org-back-to-heading</a></li>
<li><a href="#dealing-with-big-tables">Dealing with big tables</a></li>
</ul>
</li>
<li><a href="#taking-notes">Taking notes</a>
<ul>
<li><a href="#date-trees">Date trees</a></li>
<li><a href="#templates">Templates</a>
<ul>
<li><a href="#allow-refiling-in-the-middle-ish-of-a-capture">Allow refiling in the middle(ish) of a capture</a></li>
</ul>
</li>
<li><a href="#try-out-this-capture-command">Try out this capture command</a></li>
<li><a href="#estimating-wpm">Estimating WPM</a></li>
</ul>
</li>
<li><a href="#logbook">Logbook</a></li>
<li><a href="#tasks">Tasks</a>
<ul>
<li><a href="#managing-tasks">Managing tasks</a>
<ul>
<li><a href="#todo-keywords">Track TODO state</a></li>
<li><a href="#projects">Projects</a></li>
<li><a href="#tag-tasks-with-gtd-ish-contexts">Tag tasks with GTD-ish contexts</a></li>
<li><a href="#enable-filtering-by-effort-estimates">Enable filtering by effort estimates</a></li>
<li><a href="#track-time">Track time</a></li>
<li><a href="#habits">Habits</a></li>
</ul>
</li>
<li><a href="#subset">Estimating tasks</a></li>
<li><a href="#flexible-scheduling-of-tasks">Flexible scheduling of tasks</a></li>
<li><a href="#task-dependencies">Task dependencies</a></li>
<li><a href="#quick-way-to-archive-all-done-from-inbox">Quick way to archive all DONE from inbox&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="computer">computer</span></span></a></li>
<li><a href="#strike-through-done-headlines">Strike through DONE headlines</a></li>
</ul>
</li>
<li><a href="#templates">Templates</a>
<ul>
<li><a href="#structure-templates">Structure templates</a>
<ul>
<li><a href="#demarcate-but-for-begin-notes">Demarcate, but for all blocks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="config">config</span></span></a></li>
</ul>
</li>
<li><a href="#emacs-chats-emacs-hangouts">Emacs chats, Emacs hangouts</a></li>
</ul>
</li>
<li><a href="#org-agenda">Org agenda</a>
<ul>
<li><a href="#project_subtasks">Basic configuration</a></li>
<li><a href="#starting-my-weeks-on-saturday">Starting my weeks on Saturday</a></li>
<li><a href="#agenda_commands">Display projects with associated subtasks</a></li>
<li><a href="#org-agenda-custom-commands">Org agenda custom commands</a></li>
<li><a href="#making-it-easier-to-tag-inbox-items">Making it easier to tag inbox items</a></li>
<li><a href="#make-it-easy-to-mark-a-task-as-done">Make it easy to mark a task as done</a></li>
<li><a href="#make-it-easy-to-mark-a-task-as-done-and-create-a-follow-up-task">Make it easy to mark a task as done and create a follow-up task</a></li>
<li><a href="#capture-something-based-on-the-agenda">Capture something based on the agenda</a></li>
<li><a href="#sorting-by-date-and-priority">Sorting by date and priority</a></li>
<li><a href="#preventing-things-from-falling-through-the-cracks">Preventing things from falling through the cracks</a></li>
<li><a href="#synchronizing-with-google-calendar">Synchronizing with Google Calendar</a></li>
<li><a href="#projects">Projects</a></li>
</ul>
</li>
<li><a href="#reviews">Reviews</a>
<ul>
<li><a href="#weekly-review">Weekly review</a>
<ul>
<li><a href="#flickr-extract">Flickr extract</a></li>
<li><a href="#link-related-convenience-functions">Link-related convenience functions</a></li>
</ul>
</li>
<li><a href="#monthly-reviews">Monthly reviews</a></li>
</ul>
</li>
<li><a href="#filing">Filing</a>
<ul>
<li><a href="#bounce-to-another-file"><span class="todo TODO">TODO</span> Bounce to another file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="computer">computer</span>&#xa0;<span class="phone">phone</span></span></a></li>
<li><a href="#refiling">Basic refiling configuration</a>
<ul>
<li><a href="#jump-to-org-location-by-substring">TEACH Jump to Org location by substring</a></li>
<li><a href="#quick-way-to-jump">Quick way to jump</a></li>
</ul>
</li>
<li><a href="#refile-inbox"><span class="todo TODO">TODO</span> Refile inbox entries to a smaller set of org-refile-targets&#xa0;&#xa0;&#xa0;<span class="tag"><span class="dotemacs">dotemacs</span></span></a></li>
<li><a href="#refile-tags"><span class="done DONE">DONE</span> Automatically refiling Org Mode headings based on tags&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></a>
<ul>
<li><a href="#org9e9f3ae"><span class="todo TODO">TODO</span> refile inbox tags to this point</a></li>
</ul>
</li>
<li><a href="#destination">Moving lines around</a></li>
<li><a href="#organizing-my-blog-index">Organizing my blog index</a></li>
<li><a href="#quickly-refiling-org-mode-notes-to-headings-in-the-same-file">Refiling Org Mode notes to headings in the same file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></a></li>
</ul>
</li>
<li><a href="#org-contacts">Contacts</a></li>
<li><a href="#inserting-code">Inserting code</a></li>
<li><a href="#org-babel">Org Babel</a>
<ul>
<li><a href="#format-source">Format source</a></li>
<li><a href="#execute-named-babel-block"><span class="todo TODO">TODO</span> Execute named babel block</a></li>
<li><a href="#json">JSON</a>
<ul>
<li><a href="#jq">JQ</a></li>
</ul>
</li>
<li><a href="#org-block-indentation">Fix block indentation</a></li>
<li><a href="#let-s-try-literate-elisp">Let's try literate-elisp</a></li>
</ul>
</li>
<li><a href="#publishing">Publishing</a>
<ul>
<li><a href="#org5ba99fa">Counting words without blocks</a></li>
<li><a href="#org-mode-including-portions-of-files-between-two-regular-expressions">Org Mode: Including portions of files between two regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></a></li>
<li><a href="#ox-epub">ox-epub</a></li>
<li><a href="#config-footer"><span class="done DONE">DONE</span> Add a note to the bottom of blog posts exported from my config file</a></li>
<li><a href="#copy-linked-file-and-change-link">Copy linked file and change link</a></li>
<li><a href="#org-mode-create-a-quick-timestamped-note-and-capture-a-screenshot">Org Mode: Create a quick timestamped note and capture a screenshot&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a></li>
<li><a href="#11ty">11ty</a>
<ul>
<li><a href="#linking-to-blog-posts">Linking to blog posts</a></li>
<li><a href="#embark-11ty">embark-11ty&#xa0;&#xa0;&#xa0;<span class="tag"><span class="11ty">11ty</span>&#xa0;<span class="org">org</span>&#xa0;<span class="emacs">emacs</span>&#xa0;<span class="embark">embark</span></span></a></li>
<li><a href="#moving-my-org-post-subtree-to-the-11ty-directory">Moving my Org post subtree to the 11ty directory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="11ty">11ty</span>&#xa0;<span class="org">org</span>&#xa0;<span class="emacs">emacs</span>&#xa0;<span class="blogging">blogging</span></span></a></li>
</ul>
</li>
<li><a href="#cleaning-up-export">Cleaning up export</a></li>
<li><a href="#publish-without-prompting">Publish without prompting</a></li>
<li><a href="#special-blocks">Special blocks</a></li>
<li><a href="#adding-a-custom-header-argument-to-org-mode-source-blocks-and-using-that-argument-during-export">Adding a custom header argument to Org Mode source blocks and using that argument during export&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></a></li>
<li><a href="#stylesheet-header">Stylesheet / header</a></li>
<li><a href="#footer">Footer</a></li>
<li><a href="#copy-region">Copy region</a></li>
<li><a href="#utf-8-checkboxes">UTF-8 checkboxes</a></li>
<li><a href="#share-my-emacs-configuration">Share my Emacs configuration</a>
<ul>
<li><a href="#remembering-to-set-custom-ids-for-this-file">Remembering to set custom IDs for this file</a></li>
</ul>
</li>
<li><a href="#beamer">Beamer</a></li>
<li><a href="#plantuml">PlantUML</a></li>
<li><a href="#ox-hugo">ox-hugo</a></li>
<li><a href="#org-async-export-and-tangle">Org Mode: Asynchronous export and tangle of a large file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span></span></a></li>
<li><a href="#pdf">PDF</a></li>
</ul>
</li>
<li><a href="#org-roam">Org roam</a></li>
<li><a href="#org-links">Links</a>
<ul>
<li><a href="#ids">IDs</a></li>
<li><a href="#quick-links">Quick links</a></li>
<li><a href="#custom-links">Tag links</a></li>
<li><a href="#links-to-my-config">Links to my config</a>
<ul>
<li><a href="#orga3496fa"><span class="todo TODO">TODO</span> add dotemacs completion</a></li>
</ul>
</li>
<li><a href="#youtube">YouTube</a></li>
<li><a href="#videos">Videos</a></li>
<li><a href="#audio">Audio</a></li>
<li><a href="#git-projects">Using an Emacs Lisp macro to define quick custom Org Mode links to project files; plus URLs and search&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span>&#xa0;<span class="coding">coding</span></span></a>
<ul>
<li><a href="#web-link">Copy web link</a></li>
<li><a href="#org6789da6">Quickly search my code</a></li>
</ul>
</li>
<li><a href="#links-from-org-protocol">Links from org-protocol</a></li>
<li><a href="#fix-elisp-links">Fix elisp links</a></li>
<li><a href="#irc">IRC</a></li>
<li><a href="#org-dired">Dired</a></li>
</ul>
</li>
<li><a href="#org-protocol-open">Org protocol: following Org links from outside Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></a></li>
<li><a href="#add-custom-id"><span class="todo TODO">TODO</span> Speed command for adding a custom ID to Org Mode posts</a></li>
<li><a href="#journal">Journal</a>
<ul>
<li><a href="#working-with-journal-entries">Working with journal entries</a></li>
<li><a href="#tagging-journal-entries">Tagging journal entries</a></li>
<li><a href="#photos">Photos</a></li>
<li><a href="#org4194d48">Moments</a></li>
<li><a href="#org1be12ae">Slicing and dicing the journal entries</a></li>
</ul>
</li>
<li><a href="#attachments">Attachments</a></li>
<li><a href="#http">HTTP</a></li>
<li><a href="#lilypond">Lilypond</a></li>
<li><a href="#diagrams-and-graphics">Diagrams and graphics</a></li>
<li><a href="#counting">Counting</a></li>
<li><a href="#spreadsheets">Spreadsheets</a></li>
<li><a href="#literate-programming">Literate programming</a>
<ul>
<li><a href="#editing-source-code">Editing source code</a></li>
<li><a href="#copying-and-sharing-code">Copying and sharing code</a></li>
<li><a href="#tables">Tables</a></li>
</ul>
</li>
<li><a href="#invoices">Invoices</a></li>
<li><a href="#presentations">Presentations</a>
<ul>
<li><a href="#counting-words">Counting words</a></li>
</ul>
</li>
<li><a href="#allow-dashes-in-tags">Allow dashes in tags</a></li>
<li><a href="#orgffa28c1">Convert from Markdown</a></li>
<li><a href="#copying-information-from-my-phone">Copying information from my phone</a></li>
<li><a href="#emacs-news">Emacs packages, other settings for easy Emacs News generation</a>
<ul>
<li><a href="#ascii-export">ASCII export</a></li>
<li><a href="#reddit">Reddit</a></li>
<li><a href="#sorting-org-mode-lists-using-a-sequence-of-regular-expressions">Sorting Org Mode lists using a sequence of regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a></li>
<li><a href="#package-links">Package links</a></li>
</ul>
</li>
<li><a href="#save-when-emacs-loses-focus">Save when Emacs loses focus</a>
<ul>
<li><a href="#org-links">Org links</a></li>
</ul>
</li>
<li><a href="#clipboard">Clipboard</a></li>
<li><a href="#setting-properties">Setting properties</a></li>
<li><a href="#linking-to-and-exporting-function-definitions-in-org-mode">Linking to and exporting function definitions in Org Mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a>
<ul>
<li><a href="#org547d85b"><span class="todo TODO">TODO</span> Still allow linking to the file</a></li>
</ul>
</li>
<li><a href="#including-variables">Including variables</a></li>
<li><a href="#org-send-things-to-the-bottom-of-the-list">Org - send things to the bottom of the list</a></li>
<li><a href="#org3afe919">Appearance - org-modern, variable pitch</a></li>
</ul>
</li>
<li><a href="#multimedia">Multimedia</a>
<ul>
<li><a href="#org1935798">Renaming a set of files</a></li>
</ul>
</li>
<li><a href="#coding">Coding</a>
<ul>
<li><a href="#scan-bin-and-turn-the-scripts-into-interactive-commands"><span class="done DONE">DONE</span> Scan ~/bin and turn the scripts into interactive commands</a></li>
<li><a href="#csvs">CSVs</a></li>
<li><a href="#whitespace">Whitespace</a></li>
<li><a href="#python">Python</a></li>
<li><a href="#web-development">Web development</a></li>
<li><a href="#lsp">LSP</a></li>
<li><a href="#turbo-log">Turbo log</a></li>
<li><a href="#tab-width-of-2-is-compact-and-readable">Tab width of 2 is compact and readable</a></li>
<li><a href="#more-indentation-things">More indentation things</a></li>
<li><a href="#alignment">Alignment</a></li>
<li><a href="#yaml">YAML</a></li>
<li><a href="#expreg">Expand region with expreg</a></li>
<li><a href="#compilation">Compilation</a></li>
<li><a href="#emacs-lisp">Emacs Lisp</a>
<ul>
<li><a href="#easily-override-existing-functions">Easily override existing functions</a></li>
<li><a href="#lispy">Lispy</a>
<ul>
<li><a href="#keep-track-of-the-number-of-times-specified-commands-have-been-called">SOMEDAY Keep track of the number of times specified commands have been called</a></li>
<li><a href="#hydra-lispy">Emacs: Making a hydra cheatsheet for Lispy&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
</ul>
</li>
<li><a href="#smartparens-mode">Smartparens mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
<li><a href="#edit-list">Edit list&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
<li><a href="#libraries">General-purpose Emacs Lisp libraries</a></li>
<li><a href="#let-s-try-this-setup">Let's try this setup</a></li>
<li><a href="#edebug">Edebug</a></li>
<li><a href="#testing">Testing</a>
<ul>
<li><a href="#ert">ERT</a></li>
<li><a href="#buttercup">Buttercup</a></li>
<li><a href="#undercover">Undercover</a></li>
</ul>
</li>
<li><a href="#eldoc">Eldoc</a></li>
<li><a href="#refactoring">Refactoring&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
<li><a href="#jumping-to-code">Jumping to code</a></li>
<li><a href="#sorting">Sorting</a></li>
<li><a href="#evaluation">Evaluation</a></li>
<li><a href="#auto-insert">Auto insert</a></li>
<li><a href="#stubbing">Stubbing</a></li>
<li><a href="#helpful">Helpful</a></li>
<li><a href="#elisp-demos">elisp-demos</a></li>
</ul>
</li>
<li><a href="#snippets">Snippets</a></li>
<li><a href="#show-column-number">Show column number</a></li>
<li><a href="#don-t-show-whitespace-in-diff-but-show-context">Don't show whitespace in diff, but show context</a></li>
<li><a href="#javascript">Javascript</a>
<ul>
<li><a href="#indium">Indium</a></li>
<li><a href="#react">React</a></li>
</ul>
</li>
<li><a href="#html">HTML</a></li>
<li><a href="#shell">Shell</a>
<ul>
<li><a href="#shellcheck">Shellcheck</a></li>
<li><a href="#dwim-shell-command">dwim-shell-command</a></li>
</ul>
</li>
<li><a href="#magit">Magit - nice git interface</a>
<ul>
<li><a href="#make-this-better-by-adding-a-post-command-options-variable"><span class="todo TODO">TODO</span> Make this better by adding a post command options variable</a></li>
<li><a href="#org5fff014">Finding repos with uncommitted changes</a></li>
</ul>
</li>
<li><a href="#forge">Forge</a></li>
<li><a href="#checking-things-out">Checking things out</a></li>
<li><a href="#git-messenger-shows-commit-message">git-messenger - shows commit message</a></li>
<li><a href="#tag-files">Tag files</a></li>
<li><a href="#projects-and-projectile">Projects and projectile</a></li>
<li><a href="#exploring-melpa-recipes">Exploring MELPA recipes</a></li>
<li><a href="#ruby">Ruby</a></li>
<li><a href="#skewer">Skewer</a></li>
<li><a href="#autocomplete">Autocomplete</a></li>
<li><a href="#tern-for-javascript">Tern - for Javascript</a></li>
<li><a href="#docker">Docker</a></li>
<li><a href="#google-spreadsheets-and-python-automate-spreadsheet-stuff">SOMEDAY Google Spreadsheets and Python - automate spreadsheet stuff?</a></li>
<li><a href="#automation">Automation</a>
<ul>
<li><a href="#multiple-cursors-mode">Multiple cursors mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></a></li>
<li><a href="#org22842b4">iedit</a></li>
</ul>
</li>
<li><a href="#eshell">Eshell</a>
<ul>
<li><a href="#orgf7ec8f1">Eshell completion</a></li>
<li><a href="#correctly-complete-commands-in-subdirectories">Correctly complete commands in subdirectories</a></li>
</ul>
</li>
<li><a href="#org7dcabf0">SQLite</a></li>
<li><a href="#documentation">Documentation</a></li>
</ul>
</li>
<li><a href="#internet-relay-chat">Internet Relay Chat</a>
<ul>
<li><a href="#search-logs">Search logs</a></li>
</ul>
</li>
<li><a href="#mastodon">Mastodon</a>
<ul>
<li><a href="#copy-mastodon-link-for-emacs-news">Copy Mastodon link for Emacs News</a></li>
<li><a href="#storing-mastodon-links-in-org-mode">Storing Mastodon links in Org mode</a></li>
<li><a href="#mastodon-news">Collecting Emacs News from Mastodon</a></li>
<li><a href="#org5ac3684"><span class="done DONE">DONE</span> Combining Mastodon timelines using mastodon.el&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#following-people">Following people</a></li>
<li><a href="#mastodon-toot-subtree">Compose a Mastodon toot with the current Org subtree</a></li>
<li><a href="#posting-the-latest-screenshot-with-mastodon-el">Posting the latest screenshot with mastodon.el</a></li>
<li><a href="#mastodon-keyboard-shortcuts-via-hydra">Mastodon keyboard shortcuts via Hydra</a></li>
<li><a href="#mastodon-toot-config">Making it easier to toot my config</a></li>
<li><a href="#mastodon-org-contacts">Org contacts</a>
<ul>
<li><a href="#mastodon-org-contacts-capture">Capture</a></li>
<li><a href="#mastodon-org-contacts-complete">Completion</a></li>
</ul>
</li>
<li><a href="#org08d1e58">Copy Mastodon toot URL as author link</a></li>
<li><a href="#mastodon-org-feed">Collect my recent toots in an Org file so that I can refile them</a></li>
</ul>
</li>
<li><a href="#web">Web</a>
<ul>
<li><a href="#checking-urls">Checking URLs</a></li>
<li><a href="#search">Search</a></li>
<li><a href="#spookfox">Spookfox</a>
<ul>
<li><a href="#spookfox-babel">Running the current Org Mode Babel Javascript block from Emacs using Spookfox&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span>&#xa0;<span class="spookfox">spookfox</span></span></a></li>
<li><a href="#spookfox">Using Spookfox to scroll Firefox up and down from Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span>&#xa0;<span class="emacs">emacs</span></span></a></li>
<li><a href="#spookfox-insert-url">Emacs and Spookfox: org-capture the current tab from Firefox or a link from the page</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#self-tracking-statistics-and-other-data-transformations">Self-tracking, statistics, and other data transformations</a>
<ul>
<li><a href="#clock-in">Quantified Awesome</a></li>
<li><a href="#compare-time">Compare times and effort estimates</a>
<ul>
<li><a href="#using-the-calendar-date-echo-text-variable-to-help-plot-a-heatmap-on-a-year-long-calendar-in-emacs">Using the calendar-date-echo-text variable to help plot a heatmap on a year-long calendar in Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
</ul>
</li>
<li><a href="#workrave">Workrave</a></li>
<li><a href="#blog">Blog</a></li>
<li><a href="#time-tracking-previous-weekly-review">Time tracking, previous weekly review</a>
<ul>
<li><a href="#list-upcoming-tasks-so-that-i-can-see-if-i-m-overloaded">List upcoming tasks so that I can see if I'm overloaded</a></li>
<li><a href="#compare-time-use">Compare time use</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#on-my-phone">Emacs and my phone</a>
<ul>
<li><a href="#syncthing">Syncthing</a></li>
</ul>
</li>
<li><a href="#clipboard">Clipboard</a></li>
<li><a href="#mail-and-news">Mail and news</a>
<ul>
<li><a href="#notmuch">Notmuch</a>
<ul>
<li><a href="#act-on-current-message-with-embark">Act on current message with Embark</a></li>
</ul>
</li>
<li><a href="#gnus">Gnus</a>
<ul>
<li><a href="#windows">Windows</a></li>
</ul>
</li>
<li><a href="#approve-or-discard-mailman-messages">Approve or discard Mailman messages</a></li>
</ul>
</li>
<li><a href="#emacs-server">Emacs server</a></li>
<li><a href="#collaboration">Collaboration</a></li>
<li><a href="#streaming">Streaming</a>
<ul>
<li><a href="#simple-streaming">Simple streaming with FFmpeg</a></li>
<li><a href="#controlling-my-stream-audio-from-emacs-background-music-typing-sounds-and-push-to-talk">Controlling my stream audio from Emacs: background music, typing sounds, and push to talk&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></a></li>
<li><a href="#more-background-music">More background music</a></li>
<li><a href="#show-emacs-related-tasks">Show Emacs-related tasks</a></li>
<li><a href="#general-streaming-configuration">General streaming configuration</a></li>
<li><a href="#org4f57e2c">Stream message</a></li>
<li><a href="#playing-recordings">Playing recordings</a></li>
<li><a href="#stream-notes">Stream notes</a></li>
<li><a href="#streaming-chapters">Chapters</a></li>
<li><a href="#speech-to-text">CANCELLED Try continuous streaming and the Google Speech Recognition API</a></li>
</ul>
</li>
<li><a href="#file-misc">Miscellaneous</a>
<ul>
<li><a href="#ledger-personal-finance-in-my-config">Ledger</a></li>
<li><a href="#ssh-and-daemon">SSH and &#x2013;daemon</a></li>
<li><a href="#encryption">Encryption</a></li>
</ul>
</li>
<li><a href="#links">Other cool configs you may want to check out</a></li>
<li><a href="#inactive-infrequent-things">Inactive/infrequent things</a>
<ul>
<li><a href="#exwm">Exwm</a></li>
<li><a href="#emacspeak">Emacspeak</a></li>
<li><a href="#manage-photos-with-geeqie">TOBLOG Manage photos with geeqie</a></li>
<li><a href="#plover">Plover</a>
<ul>
<li><a href="#looking-things-up">Looking things up</a></li>
<li><a href="#adding-steno-hints-as-i-type">Adding steno hints as I type&#xa0;&#xa0;&#xa0;<span class="tag"><span class="steno">steno</span>&#xa0;<span class="emacs">emacs</span></span></a></li>
<li><a href="#running-plover-drills-from-emacs">Running Plover drills from Emacs</a></li>
<li><a href="#making-it-easier-to-execute-commands">Making it easier to execute commands</a></li>
<li><a href="#suggesting-briefs">Suggesting briefs</a></li>
<li><a href="#practising-within-emacs">Practising within Emacs</a></li>
<li><a href="#editing-subtitles">Editing subtitles</a></li>
<li><a href="#plover_clippy_buffer">Using inotify to add Plover Clippy suggestions into Emacs</a></li>
<li><a href="#stenoing-interface">Stenoing interface</a></li>
<li><a href="#cheat-sheets">Cheat sheets</a></li>
<li><a href="#coding-with-plover">Coding with Plover</a></li>
<li><a href="#measuring-wpm">Measuring WPM</a>
<ul>
<li><a href="#measure-strokes-per-second-strokes-per-word"><span class="todo TODO">TODO</span> measure strokes per second, strokes per word</a></li>
</ul>
</li>
<li><a href="#displaying-frequency-sorted-completions-with-stroke-hints">Displaying frequency-sorted completions with stroke hints</a></li>
</ul>
</li>
<li><a href="#mineclone">MineClone</a></li>
<li><a href="#emacsconf">EmacsConf</a></li>
<li><a href="#chatgpt-ai">ChatGPT, AI, and large-language models</a></li>
<li><a href="#chronos">Chronos timers</a></li>
<li><a href="#paint">Paint</a></li>
<li><a href="#oddmuse">Oddmuse</a></li>
<li><a href="#org-mapping-blog-posts-and-image-urls-from-bulk-exports">Org - mapping blog posts and image URLs from bulk exports</a></li>
<li><a href="#transcript-editing">Transcript editing</a></li>
<li><a href="#beeminder">Beeminder</a></li>
<li><a href="#animation-for-emacs-chats">Animation for Emacs chats</a></li>
<li><a href="#idle-timer">Idle timer</a></li>
<li><a href="#old-flickr-evernote-export">Old Flickr/Evernote export</a></li>
<li><a href="#completion-at-point">Completion at point?</a></li>
<li><a href="#enable-minibuffer-completion">Enable minibuffer completion</a></li>
<li><a href="#encryption">Encryption</a></li>
<li><a href="#drawing">Drawing</a>
<ul>
<li><a href="#imagemagick">Imagemagick</a></li>
<li><a href="#artrage">Artrage</a></li>
<li><a href="#tablet-clicks-count-as-drags">Tablet clicks count as drags</a></li>
<li><a href="#svg">SVG</a>
<ul>
<li><a href="#how-can-i-generate-png-frames-that-step-through-the-highlights"><span class="todo TODO">TODO</span> Animating SVGs</a></li>
</ul>
</li>
<li><a href="#finding-sketches">Finding sketches</a></li>
<li><a href="#sketch-rename-recolor">Renaming and recoloring sketches</a></li>
<li><a href="#org-mode-sketch-links">Org Mode sketch: links</a></li>
<li><a href="#org-mode-copy">Org Mode custom link: copy to clipboard&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a></li>
<li><a href="#config">Config</a></li>
<li><a href="#helm-completion-with-my-helm-org-sketches">Helm completion with my-helm-org-sketches</a></li>
<li><a href="#button-based-interface">Button-based interface</a></li>
<li><a href="#templates">Templates</a></li>
<li><a href="#easily-backfill-my-journal">Easily backfill my journal</a></li>
<li><a href="#rename-scanned-index-cards">Rename scanned index cards</a></li>
<li><a href="#automatically-resize-images">Automatically resize images</a></li>
<li><a href="#get-information-for-sketched-books">Get information for sketched books</a></li>
<li><a href="#make-it-easy-to-follow-up-on-a-sketch">Make it easy to follow up on a sketch</a></li>
<li><a href="#digital-index-piles-with-emacs">Digital index piles with Emacs</a></li>
<li><a href="#xournalpp-and-krita">Xournalpp and Krita</a></li>
<li><a href="#insert-point">Sketched books</a></li>
<li><a href="#other-sketches">Other sketches</a></li>
<li><a href="#other-sketch-related-functions">Other sketch-related functions</a></li>
<li><a href="#write-about-half-page-scans">SOMEDAY Write about half-page scans</a></li>
<li><a href="#supernote">Supernote</a></li>
<li><a href="#using-puppeteer-to-grab-an-image-from-the-supernote-s-screen-mirror"><span class="done DONE">DONE</span> Using Puppeteer to grab an image from the SuperNote's screen mirror&#xa0;&#xa0;&#xa0;<span class="tag"><span class="supernote">supernote</span></span></a></li>
</ul>
</li>
<li><a href="#tools-for-organizing">Tools for organizing</a></li>
<li><a href="#fun-and-games">Fun and games</a>
<ul>
<li><a href="#orgbe1004b"><span class="todo TODO">TODO</span> Make memes from Emacs</a></li>
<li><a href="#cubing">Cubing</a>
<ul>
<li><a href="#rubik-s-cube">Rubik's Cube</a></li>
<li><a href="#diagrams">Diagrams</a></li>
</ul>
</li>
<li><a href="#minecraft">Minecraft</a></li>
<li><a href="#typing-of-emacs">Typing of Emacs</a></li>
</ul>
</li>
<li><a href="#speech-synthesis-experimental">Speech synthesis (experimental)</a></li>
<li><a href="#shopping">Comparison-shopping with Org Mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></a></li>
</ul>
</li>
<li><a href="#style-stuff">Style stuff and other exports</a></li>
</ul>
</div>
</nav>
<div id="outline-container-babel-init" class="outline-2">
<h2 id="babel-init">About this file</h2>
<div class="outline-text-2" id="text-babel-init">
<p>
<a id="org47c0087"></a>
</p>

<p>
This is my personal config. It's really long, but that's partly
because I sometimes leave blog posts in it as commentary, and also
because I've got a lot of little customizations that I might not even
remember. =) If you want to see a table of contents and other
useful niceties, go to <a href="http://sachachua.com/dotemacs">http://sachachua.com/dotemacs</a> . Other links for
this page: <a href="https://raw.githubusercontent.com/sachac/.emacs.d/gh-pages/Sacha.org">Org Mode version</a>, <a href="http://github.com/sachac/.emacs.d/">Github repository</a>
</p>

<p>
If you're new to Emacs Lisp, you probably don't want to copy and paste
large chunks of this code. Instead, copy small parts of it (always
making sure to copy a complete set of parentheses) into your
<code>*scratch*</code> buffer or some other buffer in <code>emacs-lisp-mode</code>. Use <code>M-x
eval-buffer</code> to evaluate the code and see if you like the way that
Emacs behaves. See <a href="https://www.gnu.org/software/emacs/manual/html_mono/eintr.html">An Introduction to Programming in Emacs Lisp</a> for
more details on Emacs Lisp. You can also find the manual by using <code>C-h
i</code> (<code>info</code>) and choosing "Emacs Lisp Intro".
</p>

<p>
I've installed a lot of packages. See the section to
add the repositories to your configuration. When you see <code>use-package</code>
and a package name you might like, you can use <code>M-x package-install</code>
to install the package of that name.
</p>

<p>
If you're viewing the Org file, you can open source code blocks (those
are the ones in begin_src) in a separate buffer by moving your point
inside them and typing <code>C-c '</code> (<code>org-edit-special</code>). This opens another
buffer in <code>emacs-lisp-mode</code>, so you can use <code>M-x eval-buffer</code> to load
the changes. If you want to explore how functions work, use <code>M-x
edebug-defun</code> to set up debugging for that function, and then call it.
You can learn more about edebug in the <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Edebug.html">Emacs Lisp</a> manual.
</p>

<p>
I like using <code>(setq ...)</code> more than Customize because I can neatly
organize my configuration that way. Ditto for <code>use-package</code> - I mostly
use it to group together package-related config without lots of
<code>with-eval-after-load</code> calls, and it also makes declaring keybindings
easier.
</p>

<p>
Here's my init.el:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(load-file <span class="org-string">"~/sync/emacs/Sacha.el"</span>)
(load-file <span class="org-string">"~/sync/cloud/.emacs.secrets"</span>)

(put 'narrow-to-region 'disabled nil)
(put 'list-timers 'disabled nil)
(server-mode 1)
</pre>
</div>

<p>
Sacha.el is what <code>M-x org-babel-tangle</code> (<code>C-c C-v t</code>) produces.
</p>

<p>
<b>A note about Org updates:</b> I like running Org Mode from checked-out
source code instead of package.el. I add the Lisp directories to my
<code>load-path</code>, and I also use the <code>:load-path</code> option in my first
<code>use-package org</code> call to set the load path. One of those is probably
doing the trick and the other one is redundant, but maybe it's a
belt-and-suspenders sort of thing. Using the git checkout also makes
upgrading Org easy. All I have to do is <code>git pull; make</code>, and stuff
happens in an external Emacs process. Since I create <code>Sacha.el</code> via
<code>org-babel-tangle</code>, my Emacs config can load <code>Sacha.el</code> without
loading Org first.
</p>
</div>
<div id="outline-container-orgb557645" class="outline-3">
<h3 id="orgb557645">Debugging tips</h3>
<div class="outline-text-3" id="text-orgb557645">
<p>
If things break, I can use:
</p>

<ul class="org-ul">
<li><code>check-parens</code> to look for mismatched parentheses</li>
<li>package:bug-hunter to bisect my configuration</li>
<li><code>trace-function-background</code> to get information printed to a buffer</li>
<li><code>profiler-start</code> to find out more about slow functions</li>
</ul>
</div>
</div>
<div id="outline-container-starting-up" class="outline-3">
<h3 id="starting-up">Starting up</h3>
<div class="outline-text-3" id="text-starting-up">
<p>
Here's how we start:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org3cbef33"><span class="org-comment-delimiter">;; </span><span class="org-comment">-*- lexical-binding: t -*-</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">This sets up the load path so that we can override it</span>
(<span class="org-keyword">setq</span> warning-suppress-log-types '((package reinitialization)))  (package-initialize)
(add-to-list 'load-path <span class="org-string">"/usr/local/share/emacs/site-lisp"</span>)
(add-to-list 'load-path <span class="org-string">"~/vendor/org-mode/lisp"</span>)
(add-to-list 'load-path <span class="org-string">"~/vendor/org-mode/contrib/lisp"</span>)
(<span class="org-keyword">setq</span> custom-file <span class="org-string">"~/.config/emacs/custom-settings.el"</span>)
(<span class="org-keyword">setq</span> use-package-always-ensure t)
(load custom-file t)
</pre>
</div>
</div>
</div>
<div id="outline-container-emacs-initialization" class="outline-3">
<h3 id="emacs-initialization">Emacs initialization</h3>
<div class="outline-text-3" id="text-emacs-initialization">
</div>
<div id="outline-container-add-package-sources" class="outline-4">
<h4 id="add-package-sources">Add package sources</h4>
<div class="outline-text-4" id="text-add-package-sources">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">unless</span> (assoc-default <span class="org-string">"melpa"</span> package-archives)
  (add-to-list 'package-archives '(<span class="org-string">"melpa"</span> . <span class="org-string">"https://melpa.org/packages/"</span>) t))
(<span class="org-keyword">unless</span> (assoc-default <span class="org-string">"nongnu"</span> package-archives)
  (add-to-list 'package-archives '(<span class="org-string">"nongnu"</span> . <span class="org-string">"https://elpa.nongnu.org/nongnu/"</span>) t))
</pre>
</div>

<p>
Use <code>M-x package-refresh-contents</code> to reload the list of packages
after adding these for the first time.
</p>
</div>
</div>
<div id="outline-container-add-my-elisp-directory-and-other-files" class="outline-4">
<h4 id="add-my-elisp-directory-and-other-files">Add my elisp directory and other files</h4>
<div class="outline-text-4" id="text-add-my-elisp-directory-and-other-files">
<p>
Sometimes I load files outside the package system. As long as they're
in a directory in my <code>load-path</code>, Emacs can find them.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org19083a4">(add-to-list 'load-path <span class="org-string">"~/elisp"</span>)
(<span class="org-keyword">setq</span> use-package-verbose t)
(<span class="org-keyword">setq</span> use-package-always-ensure t)
(<span class="org-keyword">require</span> '<span class="org-constant">use-package</span>)
(<span class="org-keyword">use-package</span> quelpa)
(<span class="org-keyword">use-package</span> quelpa-use-package)
(quelpa-use-package-activate-advice)
(<span class="org-keyword">setq</span> load-prefer-newer t)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-personal-information" class="outline-3">
<h3 id="personal-information">Personal information</h3>
<div class="outline-text-3" id="text-personal-information">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> user-full-name <span class="org-string">"Sacha Chua"</span>
      user-mail-address <span class="org-string">"sacha@sachachua.com"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-system-information" class="outline-3">
<h3 id="system-information">System information</h3>
<div class="outline-text-3" id="text-system-information">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org5b6dde9">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-laptop-p</span> (<span class="org-keyword">or</span> (equal (system-name) <span class="org-string">"sacha-x230"</span>) (equal (system-name) <span class="org-string">"sacha-p52"</span>)))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-server-p</span> (<span class="org-keyword">and</span> (equal (system-name) <span class="org-string">"localhost"</span>) (equal user-login-name <span class="org-string">"sacha"</span>)))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-phone-p</span> (not (null (getenv <span class="org-string">"ANDROID_ROOT"</span>)))
  <span class="org-doc">"If non-nil, GNU Emacs is running on Termux."</span>)
(<span class="org-keyword">when</span> my-phone-p (<span class="org-keyword">setq</span> gnutls-algorithm-priority <span class="org-string">"NORMAL:-VERS-TLS1.3"</span>))
(global-auto-revert-mode)  <span class="org-comment-delimiter">; </span><span class="org-comment">simplifies syncing</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-reload" class="outline-3">
<h3 id="reload">Reload</h3>
<div class="outline-text-3" id="text-reload">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-reload-emacs-configuration</span> ()
  (<span class="org-keyword">interactive</span>)
  (load-file <span class="org-string">"~/proj/.emacs.d/Sacha.el"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-backups" class="outline-3">
<h3 id="backups">Backups</h3>
<div class="outline-text-3" id="text-backups">
<p>
This is one of the things people usually want to change right away. By default, Emacs saves backup files in the current directory. These are the files ending in <code>~</code> that are cluttering up your directory lists. The following code stashes them all in <code>~/.config/emacs/backups</code>, where I can find them with <code>C-x C-f</code> (<code>find-file</code>) if I really need to.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> backup-directory-alist '((<span class="org-string">"."</span> . <span class="org-string">"~/.config/emacs/backups"</span>)))
(<span class="org-keyword">with-eval-after-load</span> 'tramp
  (add-to-list 'tramp-backup-directory-alist
               (cons tramp-file-name-regexp nil)))
</pre>
</div>

<p>
Disk space is cheap. Save lots.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> delete-old-versions -1)
(<span class="org-keyword">setq</span> version-control t)
(<span class="org-keyword">setq</span> vc-make-backup-files t)
(<span class="org-keyword">setq</span> auto-save-file-name-transforms '((<span class="org-string">".*"</span> <span class="org-string">"~/.config/emacs/auto-save-list/"</span> t)))
</pre>
</div>
</div>
</div>
<div id="outline-container-history" class="outline-3">
<h3 id="history">History</h3>
<div class="outline-text-3" id="text-history">
<p>
From <a href="http://www.wisdomandwonder.com/wp-content/uploads/2014/03/C3F.html">http://www.wisdomandwonder.com/wp-content/uploads/2014/03/C3F.html</a>:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> savehist-file <span class="org-string">"~/.config/emacs/savehist"</span>)
(savehist-mode 1)
(<span class="org-keyword">setq</span> history-length t)
(<span class="org-keyword">setq</span> history-delete-duplicates t)
(<span class="org-keyword">setq</span> savehist-save-minibuffer-history 1)
(<span class="org-keyword">setq</span> savehist-additional-variables
      '(kill-ring
        search-ring
        regexp-search-ring))
</pre>
</div>
</div>
</div>
<div id="outline-container-windows-configuration" class="outline-3">
<h3 id="windows-configuration">Disabling the toolbar</h3>
<div class="outline-text-3" id="text-windows-configuration">
<p>
When you're starting out, the tool bar can be very helpful. <a href="http://sachachua.com/blog/2014/03/emacs-basics-using-mouse/">(Emacs Basics: Using the Mouse</a>). Eventually, you may want to reclaim that extra little bit of screenspace. The following code turns that thing off. (Although I changed my mind about the menu - I want that again.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(tool-bar-mode -1)
</pre>
</div>
</div>
</div>
<div id="outline-container-change-yes-or-no-to-y-or-n" class="outline-3">
<h3 id="change-yes-or-no-to-y-or-n">Change "yes or no" to "y or n"</h3>
<div class="outline-text-3" id="text-change-yes-or-no-to-y-or-n">
<p>
Lazy people like me never want to type "yes" when "y" will suffice.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(fset 'yes-or-no-p 'y-or-n-p)
</pre>
</div>
</div>
</div>
<div id="outline-container-minibuffer-editing-more-space" class="outline-3">
<h3 id="minibuffer-editing-more-space">Minibuffer editing - more space!</h3>
<div class="outline-text-3" id="text-minibuffer-editing-more-space">
<p>
Sometimes you want to be able to do fancy things with the text
that you're entering into the minibuffer. Sometimes you just want
to be able to read it, especially when it comes to lots of text.
This binds <code>C-M-e</code> in a minibuffer) so that you can edit the
contents of the minibuffer before submitting it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> miniedit
  <span class="org-builtin">:commands</span> minibuffer-edit
  <span class="org-builtin">:init</span> (miniedit-install))
</pre>
</div>
</div>
</div>
<div id="outline-container-killing-text" class="outline-3">
<h3 id="killing-text">Killing text</h3>
<div class="outline-text-3" id="text-killing-text">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> kill-ring-max 1000)
</pre>
</div>

<p>
From <a href="https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el">https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice</span> <span class="org-function-name">kill-region</span> (before slick-cut activate compile)
  <span class="org-doc">"When called interactively with no active region, kill a single line instead."</span>
  (<span class="org-keyword">interactive</span>
   (<span class="org-keyword">if</span> mark-active (list (region-beginning) (region-end))
     (list (line-beginning-position)
           (line-beginning-position 2)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-keybindings" class="outline-2">
<h2 id="keybindings">Keybindings</h2>
<div class="outline-text-2" id="text-keybindings">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(repeat-mode 1)
</pre>
</div>
</div>
<div id="outline-container-org6149e92" class="outline-3">
<h3 id="org6149e92">Extended command list</h3>
<div class="outline-text-3" id="text-org6149e92">
<p>
This code allows me to select a command from a short list of functions so that I can prompt my memory better. I wonder if this makes sense considering transient and hydra make keyboard shortcuts easier.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(my-execute-extended-command-from-list nil '(org-capture consult-buffer))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">Mostly the same as my/read-extended-command-from-list</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-read-extended-command-from-list</span> (list)
  <span class="org-doc">"Read command name to invoke in `</span><span class="org-doc"><span class="org-constant">execute-extended-command</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">minibuffer-with-setup-hook</span>
      (<span class="org-keyword">lambda</span> ()
        (add-hook 'post-self-insert-hook
                  (<span class="org-keyword">lambda</span> ()
                    (<span class="org-keyword">setq</span> execute-extended-command--last-typed
                          (minibuffer-contents)))
                  nil 'local)
        (<span class="org-keyword">setq-local</span> minibuffer-default-add-function
                    (<span class="org-keyword">lambda</span> ()
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">Get a command name at point in the original buffer</span>
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">to propose it after M-n.</span>
                      (<span class="org-keyword">let</span> ((def (<span class="org-keyword">with-current-buffer</span>
                                     (window-buffer (minibuffer-selected-window))
                                   (<span class="org-keyword">and</span> (commandp (function-called-at-point))
                                        (format <span class="org-string">"%S"</span> (function-called-at-point)))))
                            (all (sort (minibuffer-default-add-completions)
                                       #'string&lt;)))
                        (<span class="org-keyword">if</span> def
                            (cons def (delete def all))
                          all)))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Read a string, completing from and restricting to the set of</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">all defined commands.  Don't provide any initial input.</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Save the command read on the extended-command history list.</span>
    (completing-read
     (concat (<span class="org-keyword">cond</span>
              ((eq current-prefix-arg '-) <span class="org-string">"- "</span>)
              ((<span class="org-keyword">and</span> (consp current-prefix-arg)
                    (eq (car current-prefix-arg) 4)) <span class="org-string"><span class="org-warning">"C-u "</span></span><span class="org-warning">)</span>
              ((<span class="org-keyword">and</span> (consp current-prefix-arg)
                    (integerp (car current-prefix-arg)))
               (format <span class="org-string">"%d "</span> (car current-prefix-arg)))
              ((integerp current-prefix-arg)
               (format <span class="org-string">"%d "</span> current-prefix-arg)))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">This isn't strictly correct if `</span><span class="org-comment"><span class="org-constant">execute-extended-command</span></span><span class="org-comment">'</span>
             <span class="org-comment-delimiter">;; </span><span class="org-comment">is bound to anything else (e.g. [menu]).</span>
             <span class="org-comment-delimiter">;; </span><span class="org-comment">It could use (key-description (this-single-command-keys)),</span>
             <span class="org-comment-delimiter">;; </span><span class="org-comment">but actually a prompt other than "M-x" would be confusing,</span>
             <span class="org-comment-delimiter">;; </span><span class="org-comment">because "M-x" is a well-known prompt to read a command</span>
             <span class="org-comment-delimiter">;; </span><span class="org-comment">and it serves as a shorthand for "Extended command: ".</span>
             <span class="org-string">"M-x "</span>)
     (<span class="org-keyword">lambda</span> (string pred action)
       (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> suggest-key-bindings (eq action 'metadata))
           '(metadata
             (affixation-function . read-extended-command--affixation)
             (category . command))
         (complete-with-action action list string pred)))
     #'commandp t nil 'extended-command-history)))

<span class="org-comment-delimiter">;;; </span><span class="org-comment">Mostly the same as execute-extended-command</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-execute-extended-command-from-list</span> (prefixarg <span class="org-type">&amp;optional</span> command-name typed)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Based on Fexecute_extended_command in keyboard.c of Emacs.</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Aaron S. Hawley &lt;aaron.s.hawley(at)gmail.com&gt; 2009-08-24</span>
  <span class="org-doc">"Read a command name, then read the arguments and call the command.</span>
<span class="org-doc">To pass a prefix argument to the command you are</span>
<span class="org-doc">invoking, give a prefix argument to `</span><span class="org-doc"><span class="org-constant">execute-extended-command</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">declare</span> (interactive-only command-execute))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">FIXME: Remember the actual text typed by the user before completion,</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">so that we don't later on suggest the same shortening.</span>
  (<span class="org-keyword">interactive</span>
   (<span class="org-keyword">let</span> ((execute-extended-command--last-typed nil))
     (list current-prefix-arg
           (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> command-name (listp command-name))
               (my-read-extended-command-from-list command-name)
             (read-extended-command))
           execute-extended-command--last-typed)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Emacs&lt;24 calling-convention was with a single `</span><span class="org-comment"><span class="org-constant">prefixarg</span></span><span class="org-comment">' argument.</span>
  (<span class="org-keyword">when</span> (listp command-name)
    (<span class="org-keyword">let</span> ((current-prefix-arg prefixarg) <span class="org-comment-delimiter">; </span><span class="org-comment">for prompt</span>
          (execute-extended-command--last-typed nil))
      (<span class="org-keyword">setq</span> command-name
            (<span class="org-keyword">if</span> command-name
                (my/read-extended-command-from-list command-name)
              (read-extended-command)))
      (<span class="org-keyword">setq</span> typed execute-extended-command--last-typed)))
  (<span class="org-keyword">let*</span> ((function (<span class="org-keyword">and</span> (stringp command-name) (intern-soft command-name)))
         (binding (<span class="org-keyword">and</span> suggest-key-bindings
                       (not executing-kbd-macro)
                       (where-is-internal function overriding-local-map t))))
    (<span class="org-keyword">unless</span> (commandp function)
      (<span class="org-warning">error</span> <span class="org-string">"`</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' is not a valid command name"</span> command-name))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Some features, such as novice.el, rely on this-command-keys</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">including M-x COMMAND-NAME RET.</span>
    (set--this-command-keys (concat <span class="org-string">"\M-x"</span> (symbol-name function) <span class="org-string">"\r"</span>))
    (<span class="org-keyword">setq</span> this-command function)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Normally `</span><span class="org-comment"><span class="org-constant">real-this-command</span></span><span class="org-comment">' should never be changed, but here we really</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">want to pretend that M-x &lt;cmd&gt; RET is nothing more than a "key</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">binding" for &lt;cmd&gt;, so the command the user really wanted to run is</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">`</span><span class="org-comment"><span class="org-constant">function</span></span><span class="org-comment">' and not `</span><span class="org-comment"><span class="org-constant">execute-extended-command</span></span><span class="org-comment">'.  The difference is</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">visible in cases such as M-x &lt;cmd&gt; RET and then C-x z (bug#11506).</span>
    (<span class="org-keyword">setq</span> real-this-command function)
    (<span class="org-keyword">let</span> ((prefix-arg prefixarg))
      (command-execute function 'record))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">If enabled, show which key runs this command.</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">But first wait, and skip the message if there is input.</span>
    (<span class="org-keyword">let*</span> ((waited
            <span class="org-comment-delimiter">;; </span><span class="org-comment">If this command displayed something in the echo area;</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">wait a few seconds, then display our suggestion message.</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">FIXME: Wait *after* running post-command-hook!</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">FIXME: If execute-extended-command--shorter were</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">faster, we could compute the result here first too.</span>
            (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> suggest-key-bindings
                       (<span class="org-keyword">or</span> binding
                           (<span class="org-keyword">and</span> extended-command-suggest-shorter typed)))
              (sit-for (<span class="org-keyword">cond</span>
                        ((zerop (length (current-message))) 0)
                        ((numberp suggest-key-bindings) suggest-key-bindings)
                        (t 2))))))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> waited (not (consp unread-command-events)))
        (<span class="org-keyword">unless</span> (<span class="org-keyword">or</span> (not extended-command-suggest-shorter)
                    binding executing-kbd-macro (not (symbolp function))
                    (&lt;= (length (symbol-name function)) 2))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">There's no binding for CMD.  Let's try and find the shortest</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">string to use in M-x.</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">FIXME: Can be slow.  Cache it maybe?</span>
          (<span class="org-keyword">while-no-input</span>
            (<span class="org-keyword">setq</span> binding (execute-extended-command--shorter
                           (symbol-name function) typed))))
        (<span class="org-keyword">when</span> binding
          (<span class="org-keyword">with-temp-message</span>
              (format-message <span class="org-string">"You can run the command `</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' with %s"</span>
                              function
                              (<span class="org-keyword">if</span> (stringp binding)
                                  (concat <span class="org-string">"M-x "</span> binding <span class="org-string">" RET"</span>)
                                (key-description binding)))
            (sit-for (<span class="org-keyword">if</span> (numberp suggest-key-bindings)
                         suggest-key-bindings
                       2))))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-menus" class="outline-3">
<h3 id="menus">Menus</h3>
<div class="outline-text-3" id="text-menus">
<p>
Handy when I'm in tablet mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(define-key-after global-map [menu-bar my-menu] (cons <span class="org-string">"Shortcuts"</span> (make-sparse-keymap <span class="org-string">"Custom shortcuts"</span>)) 'tools)
(define-key global-map [menu-bar my-menu journal] '(<span class="org-string">"Show journal entries"</span> . my-show-missing-journal-entries))
(define-key global-map [menu-bar my-menu agenda] '(<span class="org-string">"Org agenda"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (org-agenda nil <span class="org-string">"a"</span>))))
(define-key global-map [menu-bar my-menu audio] '(<span class="org-string">"Process audio"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (shell-command <span class="org-string">"~/bin/process-audio &amp;"</span>))))
(define-key global-map [menu-bar my-menu new-index-card] '(<span class="org-string">"New index card"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>)
                                                                                (my-org-sketch-edit (my-prepare-index-card-template)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-context-menus" class="outline-3">
<h3 id="context-menus">Context menus</h3>
<div class="outline-text-3" id="text-context-menus">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'text-mode-hook 'context-menu-mode)
(<span class="org-keyword">with-eval-after-load</span> 'dired
  (add-hook 'dired-mode-hook 'context-menu-mode))
(add-hook 'shell-mode-hook 'context-menu-mode)
</pre>
</div>
</div>
</div>
<div id="outline-container-repeatable-commands" class="outline-3">
<h3 id="repeatable-commands">Repeatable commands</h3>
<div class="outline-text-3" id="text-repeatable-commands">
<p>
Based on <a href="http://oremacs.com/2015/01/14/repeatable-commands/">http://oremacs.com/2015/01/14/repeatable-commands/</a> . Modified to
accept <code>nil</code> as the first value if you don't want the keymap to run a
command by default, and to use <code>kbd</code> for the keybinding definitions.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-def-rep-command</span> (alist)
  <span class="org-doc">"Return a lambda that calls the first function of ALIST.</span>
<span class="org-doc">      It sets the transient map to all functions of ALIST,</span>
<span class="org-doc">      allowing you to repeat those functions as needed."</span>
  (<span class="org-keyword">let</span> ((keymap (make-sparse-keymap))
        (func (cdar alist)))
    (mapc (<span class="org-keyword">lambda</span> (x)
            (<span class="org-keyword">when</span> x
              (define-key keymap (kbd (car x)) (cdr x))))
          alist)
    (<span class="org-keyword">lambda</span> (arg)
      (<span class="org-keyword">interactive</span> <span class="org-string">"p"</span>)
      (<span class="org-keyword">when</span> func
        (funcall func arg))
      (set-transient-map keymap t))))
</pre>
</div>
</div>
</div>
<div id="outline-container-hydras" class="outline-3">
<h3 id="hydras">Hydra keyboard shortcuts</h3>
<div class="outline-text-3" id="text-hydras">
<p>
package:hydra offers customizable shortcuts. package:transient is another option.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> hydra <span class="org-builtin">:commands</span> defhydra)
(<span class="org-keyword">use-package</span> use-package-hydra)
(<span class="org-keyword">if</span> my-laptop-p
    (<span class="org-keyword">use-package</span> hydra-posframe <span class="org-builtin">:if</span> my-laptop-p <span class="org-builtin">:after</span> hydra))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'hydra
  (<span class="org-keyword">defhydra</span> my-window-movement ()
    (<span class="org-string">"&lt;left&gt;"</span> windmove-left)
    (<span class="org-string">"&lt;right&gt;"</span> windmove-right)
    (<span class="org-string">"&lt;down&gt;"</span> windmove-down)
    (<span class="org-string">"&lt;up&gt;"</span> windmove-up)
    (<span class="org-string">"y"</span> other-window <span class="org-string">"other"</span>)
    (<span class="org-string">"h"</span> switch-window <span class="org-string">"switch-window"</span>)
    (<span class="org-string">"b"</span> consult-buffer <span class="org-string">"buffer"</span>)
    (<span class="org-string">"f"</span> find-file <span class="org-string">"file"</span>)
    (<span class="org-string">"F"</span> find-file-other-window <span class="org-string">"other file"</span>)
    (<span class="org-string">"v"</span> (<span class="org-keyword">progn</span> (split-window-right) (windmove-right)))
    (<span class="org-string">"o"</span> delete-other-windows <span class="org-builtin">:color</span> blue)
    (<span class="org-string">"a"</span> ace-window)
    (<span class="org-string">"s"</span> ace-swap-window)
    (<span class="org-string">"d"</span> delete-window <span class="org-string">"delete"</span>)
    (<span class="org-string">"D"</span> ace-delete-window <span class="org-string">"ace delete"</span>)
    (<span class="org-string">"i"</span> ace-maximize-window <span class="org-string">"maximize"</span>)
     (<span class="org-string">"q"</span> nil)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'hydra
  (<span class="org-keyword">defhydra</span> my-shortcuts (<span class="org-builtin">:exit</span> t)
    (<span class="org-string">"j"</span> my-helm-journal <span class="org-string">"Journal"</span>)
    (<span class="org-string">"C"</span> my-resolve-orgzly-syncthing <span class="org-string">"Conflicts"</span>)
    (<span class="org-string">"n"</span> my-capture-timestamped-note <span class="org-string">"Note"</span>)
    (<span class="org-string">"c"</span> my-org-categorize-emacs-news/body <span class="org-string">"Categorize"</span>)
    (<span class="org-string">"d"</span> my-emacs-news-check-duplicates <span class="org-string">"Dupe"</span>)
    (<span class="org-string">"s"</span> save-buffer <span class="org-string">"Save"</span>)
    (<span class="org-string">"f"</span> my-file-shortcuts/body <span class="org-string">"File shortcut"</span>)
    (<span class="org-string">"+"</span> text-scale-increase <span class="org-string">"Increase"</span>)
    (<span class="org-string">"-"</span> text-scale-decrease <span class="org-string">"Decrease"</span>)
    (<span class="org-string">"G"</span> gif-screencast-start-or-stop <span class="org-string">"GIF screencast"</span>)
    (<span class="org-string">"g"</span> my-geeqie/body <span class="org-string">"Geeqie"</span>)
    (<span class="org-string">"r"</span> my-record-ffmpeg-toggle-recording <span class="org-string">"Record screen"</span>)
    (<span class="org-string">"l"</span> (my-toggle-or-create <span class="org-string">"*scratch*"</span> (<span class="org-keyword">lambda</span> () (switch-to-buffer (startup--get-buffer-create-scratch)))) <span class="org-string">"Lisp"</span>)
    (<span class="org-string">"e"</span> eshell-toggle <span class="org-string">"Eshell"</span>)
    (<span class="org-string">"w"</span> my-engine-dmode-hydra/body <span class="org-string">"Search web"</span>)
    (<span class="org-string">"E"</span> my-emacs-news/body <span class="org-string">"Emacs News"</span>))
  (keymap-global-set <span class="org-string">"&lt;f5&gt;"</span> #'my-shortcuts/body)
  (<span class="org-keyword">defhydra</span> my-emacs-news (<span class="org-builtin">:exit</span> t)
    <span class="org-doc">"Emacs News"</span>
    (<span class="org-string">"f"</span> (find-file <span class="org-string">"~/sync/emacs-news/index.org"</span>) <span class="org-string">"News"</span>)
    (<span class="org-string">"C"</span> (find-file <span class="org-string">"~/proj/emacs-calendar/README.org"</span>) <span class="org-string">"Calendar"</span>)
    (<span class="org-string">"C"</span> (find-file <span class="org-string">"/ssh:web:/var/www/emacslife.com/calendar/README.org"</span> <span class="org-string">"Calendar on server"</span>))
    (<span class="org-string">"d"</span> my-emacs-news-check-duplicates <span class="org-string">"Dupe"</span>)
    (<span class="org-string">"c"</span> my-org-categorize-emacs-news/body <span class="org-string">"Categorize"</span>)
    (<span class="org-string">"h"</span> (my-org-update-link-description <span class="org-string">"HN"</span>) <span class="org-string">"Link HN"</span>)
    (<span class="org-string">"i"</span> (my-org-update-link-description <span class="org-string">"Irreal"</span>) <span class="org-string">"Link Irreal"</span>)
    (<span class="org-string">"m"</span> my-share-emacs-news <span class="org-string">"Mail"</span>)
    (<span class="org-string">"t"</span> (browse-url <span class="org-string">"https://tweetdeck.twitter.com"</span>) <span class="org-string">"Twitter"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-update-link-description</span> (description)
  <span class="org-doc">"Update the current link's DESCRIPTION."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MDescription: "</span>)
  (<span class="org-keyword">let</span> (link)
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">cond</span>
       ((org-in-regexp org-link-bracket-re 1)
        (<span class="org-keyword">setq</span> link (org-link-unescape (match-string-no-properties 1)))
        (delete-region (match-beginning 0) (match-end 0))
        (insert (org-link-make-string link description))
        (sit-for 0))
       ((<span class="org-keyword">or</span> (org-in-regexp org-link-angle-re)
            (org-in-regexp org-link-plain-re))
        (<span class="org-keyword">setq</span> link (org-unbracket-string <span class="org-string">"&lt;"</span> <span class="org-string">"&gt;"</span> (match-string 0)))
        (delete-region (match-beginning 0) (match-end 0))
        (insert (org-link-make-string link description))
        (sit-for 0))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (org-in-regexp org-link-bracket-re 1)
    (goto-char (match-end 0))
    (insert <span class="org-string">"\n"</span>))
  (call-interactively 'org-insert-link))
</pre>
</div>


<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-switch-to-previous-buffer</span> ()
  <span class="org-doc">"Switch to previously open buffer.</span>
<span class="org-doc">      Repeated invocations toggle between the two most recently open buffers."</span>
  (<span class="org-keyword">interactive</span>)
  (switch-to-buffer (other-buffer (current-buffer) 1)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-check-agenda</span> ()
  <span class="org-doc">"Peek at agenda."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
   ((derived-mode-p 'org-agenda-mode)
    (<span class="org-keyword">if</span> (window-parent) (delete-window) (bury-buffer)))
   ((get-buffer <span class="org-string">"*Org Agenda*"</span>)
    (switch-to-buffer-other-window <span class="org-string">"*Org Agenda*"</span>))
   (t (org-agenda nil <span class="org-string">"a"</span>))))
</pre>
</div>

<p>
From <a href="https://github.com/abo-abo/hydra/wiki/Nesting-Hydras">https://github.com/abo-abo/hydra/wiki/Nesting-Hydras</a> :
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">hydra-stack</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-hydra-push</span> (expr)
  (<span class="org-keyword">push</span> `(<span class="org-keyword">lambda</span> () ,expr) hydra-stack))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-hydra-pop</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((x (<span class="org-keyword">pop</span> hydra-stack)))
    (<span class="org-keyword">when</span> x (funcall x))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-hydra-go-and-push</span> (expr)
  (<span class="org-keyword">push</span> hydra-curr-body-fn hydra-stack)
  (prin1 hydra-stack)
  (funcall expr))

<span class="org-comment-delimiter">;; </span><span class="org-comment">example (progn (hydra-b/body) (hydra-push '(hydra-a/body)))</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">or   ("q" hydra-pop "exit")</span>
</pre>
</div>
</div>
<div id="outline-container-hydra-completion" class="outline-4">
<h4 id="hydra-completion">Emacs Hydra: Allow completion when I can't remember the command name</h4>
<div class="outline-text-4" id="text-hydra-completion">
<p>
2021-04-29: Added the ability to complete using an arbitrary Hydra.
</p>

<p>
So it turns out that I'm pretty much zonked after a day with the
kiddo and have a hard time remembering keystrokes or speed-reading
<a href="https://sachachua.com/dotemacs#hydra-lispy">my Hydra cheat sheets</a>. I want to be able to use M-x-like completion
in my Hydra so that I can type a few characters and then maybe see
the shortcuts there. Here's what it looks like:
</p>


<figure id="orgc42f82b">
<img src="https://sachachua.com/blog/2021/04/emacs-hydra-allow-completion-when-i-can-t-remember-the-command-name/Screenshot_20210425_232535.png" alt="Screenshot_20210425_232535.png">

<figcaption><span class="figure-number">Figure 1: </span>Hydra completion</figcaption>
</figure>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-hydra-format-head</span> (h)
  (<span class="org-keyword">let</span> ((key-binding (elt h 0))
        (hint (elt h 2))
        (cmd (<span class="org-keyword">and</span> (elt h 1) (prin1-to-string (elt h 1)))))
    (<span class="org-keyword">if</span> cmd
        (format <span class="org-string">"%s (%s) - %s"</span> hint key-binding cmd)
      (format <span class="org-string">"%s (%s)"</span> hint key-binding))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-hydra-heads-to-candidates</span> (base)
  (mapcar (<span class="org-keyword">lambda</span> (h)
            (cons (my-hydra-format-head h) (hydra--head-name h base)))
          (symbol-value (intern (concat (symbol-name base) <span class="org-string">"/heads"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-hydra-execute-extended</span> (<span class="org-type">&amp;optional</span> _ hydra-base)
  (<span class="org-keyword">interactive</span> (list current-prefix-arg nil))
  (hydra-keyboard-quit)
  (<span class="org-keyword">let*</span> ((candidates (my-hydra-heads-to-candidates
                      (<span class="org-keyword">or</span> hydra-base
                          (intern
                           (replace-regexp-in-string <span class="org-string">"/body$"</span> <span class="org-string">""</span>
                                                     (symbol-name hydra-curr-body-fn))))))
         (command-name (completing-read <span class="org-string">"Cmd: "</span> candidates))
         (bind (assoc-default command-name candidates 'string=)))
    (<span class="org-keyword">cond</span>
     ((null bind) nil)
     ((hydra--callablep bind) (call-interactively bind)))))
</pre>
</div>

<p>
This is how I add it to all my hydras:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'hydra
  (define-key hydra-base-map (kbd <span class="org-string">"&lt;tab&gt;"</span>) #'my-hydra-execute-extended))
</pre>
</div>

<p>
Proooobably works? Very rough. Might be useful for those fuzzy-brain days.
</p>
</div>
</div>
</div>
<div id="outline-container-which-key-and-which-key-posframe" class="outline-3">
<h3 id="which-key-and-which-key-posframe">which-key and which-key-posframe</h3>
<div class="outline-text-3" id="text-which-key-and-which-key-posframe">
<p>
It's hard to remember keyboard shortcuts.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> which-key <span class="org-builtin">:init</span> (which-key-mode 1))
(<span class="org-keyword">use-package</span> which-key-posframe <span class="org-builtin">:if</span> my-laptop-p <span class="org-builtin">:init</span> (which-key-posframe-mode 1))
</pre>
</div>
</div>
</div>
<div id="outline-container-key-chord" class="outline-3">
<h3 id="key-chord">Key chords</h3>
<div class="outline-text-3" id="text-key-chord">
<p>
I'm on a Dvorak keyboard, so these might not work
for you. Experimenting with this. <code>key-chord</code> lets
you define keyboard shortcuts that use ordinary
keys typed in quick succession. I haven't been
using this lately, though&#x2026;
</p>

<p>
Some code from <a href="http://emacsredux.com/blog/2013/04/28/switch-to-previous-buffer/">http://emacsredux.com/blog/2013/04/28/switch-to-previous-buffer/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-key-chord-define</span> (keymap keys command)
  <span class="org-doc">"Define in KEYMAP, a key-chord of two keys in KEYS starting a COMMAND.</span>
<span class="org-doc">      \nKEYS can be a string or a vector of two elements. Currently only elements</span>
<span class="org-doc">      that corresponds to ascii codes in the range 32 to 126 can be used.</span>
<span class="org-doc">      \nCOMMAND can be an interactive function, a string, or nil.</span>
<span class="org-doc">      If COMMAND is nil, the key-chord is removed.</span>

<span class="org-doc">      MODIFICATION: Do not define the transposed key chord.</span>
<span class="org-doc">      "</span>
  (<span class="org-keyword">if</span> (/= 2 (length keys))
      (<span class="org-warning">error</span> <span class="org-string">"Key-chord keys must have two elements"</span>))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Exotic chars in a string are &gt;255 but define-key wants 128..255 for those</span>
  (<span class="org-keyword">let</span> ((key1 (logand 255 (aref keys 0)))
        (key2 (logand 255 (aref keys 1))))
    (define-key keymap (vector 'key-chord key1 key2) command)))
(fset 'key-chord-define 'my-key-chord-define)

</pre>
</div>

<p>
Now let's set up the actual keychords.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> key-chord
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:hydra</span> (my-key-chord-commands
          ()
          <span class="org-string">"Main"</span>
          (<span class="org-string">"k"</span> kill-sexp)
          (<span class="org-string">"h"</span> my-org-jump <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"x"</span> my-org-finish-previous-task-and-clock-in-new-one <span class="org-string">"Finish and clock in"</span> <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"b"</span> helm-buffers-list <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"f"</span> find-file <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"a"</span> my-org-check-agenda <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"c"</span> (call-interactively 'org-capture) <span class="org-string">"capture"</span> <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"t"</span> (org-capture nil <span class="org-string">"T"</span>) <span class="org-string">"Capture task"</span>)
          (<span class="org-string">"."</span> repeat)
          (<span class="org-string">"C-t"</span> transpose-chars)
          (<span class="org-string">"o"</span> my-org-off-my-computer <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"w"</span> my-engine-mode-hydra/body <span class="org-string">"web"</span> <span class="org-builtin">:exit</span> t)
          (<span class="org-string">"m"</span> imenu <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"i"</span> my-capture-timestamped-note-with-screenshot <span class="org-builtin">:exit</span> t)
          (<span class="org-string">"n"</span> my-capture-timestamped-note <span class="org-string">"Timestamped note"</span> <span class="org-builtin">:exit</span> t)
          (<span class="org-string">"q"</span> quantified-track <span class="org-builtin">:color</span> blue)
          (<span class="org-string">"r"</span> my-describe-random-interactive-function)
          (<span class="org-string">"l"</span> org-insert-last-stored-link)
          (<span class="org-string">"L"</span> my-org-insert-link))
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">setq</span> key-chord-one-key-delay 0.16)
  (<span class="org-keyword">setq</span> key-chord-two-keys-delay 0.002)
  (key-chord-define-global <span class="org-string">"uu"</span> 'undo)
  (key-chord-define-global <span class="org-string">"jr"</span> 'my-goto-random-char-hydra/my-goto-random-char)
  (key-chord-define-global <span class="org-string">"kk"</span> 'kill-whole-line)
  (key-chord-define-global <span class="org-string">"et"</span> 'my-stream-message)
  (key-chord-define-global <span class="org-string">"em"</span> 'embark-act)
  (key-chord-define-global <span class="org-string">".t"</span> 'my-stream/body)
  (key-chord-define-global <span class="org-string">"jj"</span> 'avy-goto-word-1)
  (key-chord-define-global <span class="org-string">"yy"</span> 'my-window-movement/body)
  (key-chord-define-global <span class="org-string">"jw"</span> 'switch-window)
  (key-chord-define-global <span class="org-string">"jl"</span> 'avy-goto-line)
  (key-chord-define-global <span class="org-string">"j."</span> 'join-lines/body)
  (key-chord-define-global <span class="org-string">"FF"</span> 'find-file)
  (key-chord-define-global <span class="org-string">"qq"</span> 'my-quantified-hydra/body)
  (key-chord-define-global <span class="org-string">"hh"</span> 'my-key-chord-commands/body)
  (key-chord-define-global <span class="org-string">"xx"</span> 'er/expand-region)
  (key-chord-define-global <span class="org-string">"  "</span> 'my-insert-space-or-expand)
  (key-chord-define-global <span class="org-string">"vv"</span> 'god-mode-all)
  (key-chord-define-global <span class="org-string">"JJ"</span> 'my-switch-to-previous-buffer)
  (key-chord-mode -1)) <span class="org-comment-delimiter">;; </span><span class="org-comment">disable for now</span>
</pre>
</div>

<p>
Hmm, good point about <code>C-t</code> being more useful as a Hydra than as <code>transpose-char</code>. It turns out I actually do use <code>C-t</code> a fair bit, but I can always add it back as an option.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"C-t"</span> 'my-key-chord-commands/body)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-completion" class="outline-2">
<h2 id="completion">Completion</h2>
<div class="outline-text-2" id="text-completion">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> vertico <span class="org-builtin">:config</span> (vertico-mode +1))
(<span class="org-keyword">use-package</span> orderless
  <span class="org-builtin">:custom</span>
  (completion-styles '(orderless basic))
  (completion-category-overrides '((file (styles basic partial-completion)))))
(<span class="org-keyword">use-package</span> prescient <span class="org-builtin">:config</span> (prescient-persist-mode +1))
(<span class="org-keyword">use-package</span> company-prescient <span class="org-builtin">:init</span> (company-prescient-mode +1))
</pre>
</div>
</div>
<div id="outline-container-consult" class="outline-3">
<h3 id="consult">Consult</h3>
<div class="outline-text-3" id="text-consult">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> consult
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/consult"</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">:quelpa (consult :fetcher github :repo "minad/consult")</span>
  <span class="org-builtin">:after</span> projectile
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-x r x"</span> . consult-register)
         (<span class="org-string">"C-x r b"</span> . consult-bookmark)
         (<span class="org-string">"C-c k"</span> . consult-kmacro)
         (<span class="org-string">"C-x M-:"</span> . consult-complex-command)     <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. repeat-complet-command</span>
         (<span class="org-string">"C-x 4 b"</span> . consult-buffer-other-window) <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. switch-to-buffer-other-window</span>
         (<span class="org-string">"C-x 5 b"</span> . consult-buffer-other-frame)
         (<span class="org-string">"M-#"</span> . consult-register-load)
         (<span class="org-string">"M-'"</span> . consult-register-store)          <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. abbrev-prefix-mark (unrelated)</span>
         (<span class="org-string">"C-M-#"</span> . consult-register)
         (<span class="org-string">"M-g o"</span> . consult-outline)
         (<span class="org-string">"M-g h"</span> . consult-org-heading)
         (<span class="org-string">"M-g a"</span> . consult-org-agenda)
         (<span class="org-string">"M-g m"</span> . consult-mark)
         (<span class="org-string">"C-x b"</span> . consult-buffer)
         (<span class="org-string">"M-g M-g"</span> . consult-goto-line)           <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. goto-line</span>
         (<span class="org-string">"M-g o"</span> . consult-outline)
         (<span class="org-string">"M-g m"</span> . consult-mark)
         (<span class="org-string">"M-g k"</span> . consult-global-mark)
         (<span class="org-string">"M-g i"</span> . consult-imenu)
         (<span class="org-string">"M-g I"</span> . consult-project-imenu)
         (<span class="org-string">"M-g e"</span> . consult-error)
         <span class="org-comment-delimiter">;; </span><span class="org-comment">M-s bindings (search-map)</span>
         (<span class="org-string">"M-s f"</span> . consult-find)
         (<span class="org-string">"M-s i"</span> . consult-info)
         (<span class="org-string">"M-s L"</span> . consult-locate)
         (<span class="org-string">"M-s g"</span> . consult-grep)
         (<span class="org-string">"M-s G"</span> . consult-git-grep)
         (<span class="org-string">"M-s r"</span> . consult-ripgrep)
         (<span class="org-string">"M-s l"</span> . consult-line)
         (<span class="org-string">"M-s m"</span> . consult-multi-occur)
         (<span class="org-string">"M-s k"</span> . consult-keep-lines)
         (<span class="org-string">"M-s u"</span> . consult-focus-lines)
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Isearch integration</span>
         (<span class="org-string">"M-s e"</span> . consult-isearch)
         (<span class="org-string">"M-g l"</span> . consult-line)
         (<span class="org-string">"M-s m"</span> . consult-multi-occur)
         (<span class="org-string">"C-x c o"</span> . consult-multi-occur)
         (<span class="org-string">"C-x c SPC"</span> . consult-mark)
         <span class="org-builtin">:map</span> isearch-mode-map
         (<span class="org-string">"M-e"</span> . consult-isearch)                 <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. isearch-edit-string</span>
         (<span class="org-string">"M-s e"</span> . consult-isearch)               <span class="org-comment-delimiter">;; </span><span class="org-comment">orig. isearch-edit-string</span>
         (<span class="org-string">"M-s l"</span> . consult-line))
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">setq</span> register-preview-delay 0
        register-preview-function #'consult-register-format)
  <span class="org-builtin">:custom</span>
  consult-preview-key '(<span class="org-builtin">:debounce</span> 0.2 any)
  consult-narrow-key <span class="org-string">"&lt;"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> consult-project-root-function #'projectile-project-root))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">declare-function</span> 'my-geeqie-view <span class="org-string">"Sacha.el"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-preview-image</span> (candidate state)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> my-sketch-preview candidate) (my-geeqie-view (list candidate)))
  nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-complete-sketch-filename</span> ()
  (<span class="org-keyword">interactive</span>)
  (consult--read (my-sketches)
       <span class="org-builtin">:sort</span> nil
       <span class="org-builtin">:state</span> 'my-preview-image
       <span class="org-builtin">:prompt</span> <span class="org-string">"Sketch: "</span>
       <span class="org-builtin">:category</span> 'sketch))
</pre>
</div>
</div>
<div id="outline-container-completing-blog-posts" class="outline-4">
<h4 id="completing-blog-posts">Completing blog posts</h4>
<div class="outline-text-4" id="text-completing-blog-posts">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-complete-blog-post-url</span> ()
  (<span class="org-keyword">let*</span>
      ((default-directory (expand-file-name <span class="org-string">"~/proj/static-blog/_site"</span>))
       (builder (consult--find-make-builder (list default-directory)))
       (input
        (consult--read (consult--async-command builder
                         (consult--async-filter (<span class="org-keyword">lambda</span> (x) (string-match <span class="org-string">"index.html"</span> x)))
                         (consult--async-map
                          (<span class="org-keyword">lambda</span> (x)
                            (string-remove-prefix default-directory x)))
                         (consult--async-highlight builder))
                       <span class="org-builtin">:prompt</span> <span class="org-string">"Post: "</span>
                       <span class="org-builtin">:sort</span> nil
                       <span class="org-builtin">:require-match</span> t
                       <span class="org-builtin">:category</span> 'file
                       )))
    (<span class="org-keyword">setq</span> input (replace-regexp-in-string <span class="org-string">"^blog:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">index\\.html$"</span> <span class="org-string">""</span> input))
    (concat <span class="org-string">"https://sachachua.com"</span>
            input)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-edit-blog-post</span> ()
  (<span class="org-keyword">interactive</span>)
  (consult-find <span class="org-string">"~/proj/static-blog/blog/"</span> <span class="org-string">".html#"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-view-blog-post-locally</span> ()
  (<span class="org-keyword">interactive</span>)
  (browse-url
   (concat <span class="org-string">"http://localhost:8080/"</span>
           (replace-regexp-in-string
            <span class="org-string">"index\\.html$"</span> <span class="org-string">""</span>
            (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/proj/static-blog/_site"</span>))
              (consult--find <span class="org-string">"Post: "</span> #'consult--find-builder <span class="org-string">".html#"</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-blog-post-url</span> (url)
  (<span class="org-keyword">interactive</span> (list (my-complete-blog-post-url)))
  (insert url))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-blog-post-link</span> (url)
  (<span class="org-keyword">interactive</span> (list (my-complete-blog-post-url)))
  (<span class="org-keyword">if</span> (derived-mode-p 'org-mode)
      (insert (org-link-make-string url
                                    (replace-regexp-in-string
                                     <span class="org-string">" :: Sacha Chua"</span> <span class="org-string">""</span>
                                     (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
                                       (dom-text (car
                                                  (dom-by-tag (libxml-parse-html-region
                                                               (point-min)
                                                               (point-max))
                                                              'title)))))))
    (insert url)))
</pre>
</div>
</div>
</div>
<div id="outline-container-completing-sketches" class="outline-4">
<h4 id="completing-sketches">Completing sketches</h4>
<div class="outline-text-4" id="text-completing-sketches">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-date-from-filename</span> (filename)
  (<span class="org-keyword">let</span> ((f (file-name-nondirectory filename)))
    (<span class="org-keyword">if</span> (string-match <span class="org-string">"^[-0-9]+"</span> f)
        (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> (match-string 0 f))
      nil)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-sketches</span> nil <span class="org-doc">"Cache for sketch filenames."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketches</span> ()
  (<span class="org-keyword">interactive</span>)
  (sort
   (apply 'append (mapcar (<span class="org-keyword">lambda</span> (dir)
                            (directory-files dir t <span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">jpe?g</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">svg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span>))
                          my-sketch-directories))
   (<span class="org-keyword">lambda</span> (a b)
     (string&lt; (concat (<span class="org-keyword">or</span> (my-date-from-filename b) <span class="org-string">"0"</span>) (file-name-nondirectory b))
              (concat (<span class="org-keyword">or</span> (my-date-from-filename a) <span class="org-string">"0"</span>) (file-name-nondirectory a))))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-sketch-preview</span> nil <span class="org-doc">"Non-nil means preview images."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-find-sketch</span> (file)
  (<span class="org-keyword">interactive</span> (list (my-complete-sketch-filename)))
  (find-file file))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-prepare-post</span> (file)
  (<span class="org-keyword">interactive</span> (list (my-complete-sketch-filename)))
  (insert (org-link-make-string (concat <span class="org-string">"sketchFull:"</span> (file-name-base file))))
  (<span class="org-keyword">let</span> ((text (my-sketch-text file)))
    (<span class="org-keyword">when</span> text
      (insert (format <span class="org-string">"\n\n#+begin_my_src \"Text from %s\"\n%s\n#"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-text</span> (file)
  (<span class="org-keyword">setq</span> file
        (<span class="org-keyword">if</span> (string-match <span class="org-string">".json"</span> file) file
          (concat (file-name-sans-extension file) <span class="org-string">".json"</span>)))
  (<span class="org-keyword">when</span> (file-exists-p file)
    (<span class="org-keyword">with-temp-buffer</span>
      (insert-file-contents file)
      (goto-char (point-min))
      (<span class="org-keyword">let</span> ((json-object-type 'alist))
        (assoc-default 'description (elt (assoc-default 'textAnnotations (json-read)) 0))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-insert-text-from-json</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FJSON: "</span>)
  (<span class="org-keyword">let</span> ((text (my-sketch-text file)))
    (insert (<span class="org-keyword">or</span> text <span class="org-string">""</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-consult-directory-navigation" class="outline-4">
<h4 id="consult-directory-navigation">Consult directory navigation</h4>
<div class="outline-text-4" id="text-consult-directory-navigation">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> consult-dir
       <span class="org-builtin">:ensure</span> t
       <span class="org-builtin">:bind</span> ((<span class="org-string">"C-x C-d"</span> . consult-dir)
              <span class="org-builtin">:map</span> minibuffer-local-completion-map
              (<span class="org-string">"C-x C-d"</span> . consult-dir)
              (<span class="org-string">"C-x C-j"</span> . consult-dir-jump-file)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">https://karthinks.com/software/jumping-directories-in-eshell/</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">eshell/z</span> (<span class="org-type">&amp;optional</span> regexp)
  <span class="org-doc">"Navigate to a previously visited directory in eshell, or to</span>
<span class="org-doc">any directory proferred by `</span><span class="org-doc"><span class="org-constant">consult-dir</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">let</span> ((eshell-dirs (delete-dups
                      (mapcar 'abbreviate-file-name
                              (ring-elements eshell-last-dir-ring)))))
    (<span class="org-keyword">cond</span>
     ((<span class="org-keyword">and</span> (not regexp) (<span class="org-keyword">featurep</span> '<span class="org-constant">consult-dir</span>))
      (<span class="org-keyword">let*</span> ((consult-dir--source-eshell `(<span class="org-builtin">:name</span> <span class="org-string">"Eshell"</span>
                                                 <span class="org-builtin">:narrow</span> ?e
                                                 <span class="org-builtin">:category</span> file
                                                 <span class="org-builtin">:face</span> consult-file
                                                 <span class="org-builtin">:items</span> ,eshell-dirs))
             (consult-dir-sources (cons consult-dir--source-eshell
                                        consult-dir-sources)))
        (eshell/cd (substring-no-properties
                    (consult-dir--pick <span class="org-string">"Switch directory: "</span>)))))
     (t (eshell/cd (<span class="org-keyword">if</span> regexp (eshell-find-previous-directory regexp)
                     (completing-read <span class="org-string">"cd: "</span> eshell-dirs)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-using-projects-as-a-source-for-consult-buffer" class="outline-4">
<h4 id="using-projects-as-a-source-for-consult-buffer">Using projects as a source for consult-buffer</h4>
<div class="outline-text-4" id="text-using-projects-as-a-source-for-consult-buffer">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> consult
  <span class="org-builtin">:after</span> projectile
  <span class="org-builtin">:defines</span> consult-buffer-sources
  <span class="org-builtin">:config</span>
  (projectile-load-known-projects)
  (<span class="org-keyword">setq</span> my-consult-source-projectile-projects
        `(<span class="org-builtin">:name</span> <span class="org-string">"Projectile projects"</span>
                <span class="org-builtin">:narrow</span>   ?P
                <span class="org-builtin">:category</span> project
                <span class="org-builtin">:action</span>   ,#'projectile-switch-project-by-name
                <span class="org-builtin">:items</span>    ,projectile-known-projects))
  (add-to-list 'consult-buffer-sources my-consult-source-projectile-projects 'append))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org5ca8338" class="outline-3">
<h3 id="org5ca8338">Marginalia</h3>
<div class="outline-text-3" id="text-org5ca8338">
<p>
**
</p>
<p>
:CUSTOM_ID: marginalia
</p>
<p>
<a href="https://www.reddit.com/r/emacs/comments/196pvtx/comment/khxa8ip/?share_id=-4IBSwNFQR_-Gd744ZcrH&amp;utm_content=2&amp;utm_medium=android_app&amp;utm_name=androidcss&amp;utm_source=share&amp;utm_term=2">Marginalia - add function name for aliases</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> marginalia <span class="org-builtin">:quelpa</span> (marginalia <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"minad/marginalia"</span>)
  <span class="org-builtin">:init</span>
  (marginalia-mode)
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> minibuffer-local-completion-map
              (<span class="org-string">"M-m"</span> . marginalia-cycle))
  <span class="org-builtin">:config</span>
  (add-to-list 'marginalia-prompt-categories '(<span class="org-string">"sketch"</span> . sketch))
  (add-to-list 'marginalia-censor-variables <span class="org-string">"-api-key"</span>)
  (<span class="org-keyword">cl-pushnew</span> #'marginalia-annotate-symbol-with-alias
        (alist-get 'command marginalia-annotator-registry))
  (<span class="org-keyword">cl-pushnew</span> #'marginalia-annotate-symbol-with-alias
        (alist-get 'function marginalia-annotator-registry))
  (<span class="org-keyword">cl-pushnew</span> #'marginalia-annotate-symbol-with-alias
        (alist-get 'symbol marginalia-annotator-registry)))

(<span class="org-keyword">defun</span> <span class="org-function-name">marginalia-annotate-alias</span> (cand)
  <span class="org-doc">"Annotate CAND with the function it aliases."</span>
  (<span class="org-keyword">when-let</span> ((sym (intern-soft cand))
             (alias (car (last (function-alias-p sym))))
             (name (<span class="org-keyword">and</span> (symbolp alias) (symbol-name alias))))
    (format <span class="org-string">" (%s)"</span> name)))

(<span class="org-keyword">defun</span> <span class="org-function-name">marginalia-annotate-symbol-with-alias</span> (cand)
  <span class="org-doc">"Annotate symbol CAND with its documentation string.</span>
<span class="org-doc">    Similar to `</span><span class="org-doc"><span class="org-constant">marginalia-annotate-symbol</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">when-let</span> (sym (intern-soft cand))
    (concat
     (marginalia-annotate-binding cand)
     (marginalia--fields
      ((marginalia-annotate-alias cand) <span class="org-builtin">:face</span> 'marginalia-function)
      ((marginalia--symbol-class sym) <span class="org-builtin">:face</span> 'marginalia-type)
      ((<span class="org-keyword">cond</span>
        ((fboundp sym) (marginalia--function-doc sym))
        ((facep sym) (documentation-property sym 'face-documentation))
        (t (documentation-property sym 'variable-documentation)))
       <span class="org-builtin">:truncate</span> 1.0 <span class="org-builtin">:face</span> 'marginalia-documentation)))))

</pre>
</div>
</div>
<div id="outline-container-marginalia-and-annotating-journal-entries" class="outline-4">
<h4 id="marginalia-and-annotating-journal-entries">Marginalia and annotating journal entries</h4>
<div class="outline-text-4" id="text-marginalia-and-annotating-journal-entries">
<p>
The following code annotates journal entries with their categories.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-marginalia-annotate-journal</span> (cand)
  (<span class="org-keyword">when-let</span> ((o (cdr (assoc cand my-journal-search-cache))))
    (marginalia--fields
     ((plist-get o <span class="org-builtin">:Category</span>)
<span class="org-builtin">:face</span> 'marginalia-documentation
<span class="org-builtin">:truncate</span> 13))))

(<span class="org-keyword">use-package</span> marginalia
  <span class="org-builtin">:config</span>
  (add-to-list 'marginalia-annotator-registry '(journal my-marginalia-annotate-journal builtin none)))

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-embark" class="outline-3">
<h3 id="embark">Embark</h3>
<div class="outline-text-3" id="text-embark">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> embark
  <span class="org-builtin">:after</span> org
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/embark"</span>
          <span class="org-comment-delimiter">; </span><span class="org-comment">:quelpa (embark :fetcher github :repo "oantolin/embark")</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> embark-prompter 'embark-keymap-prompter)
  (add-to-list 'embark-target-finders 'my-embark-org-element)
  (add-to-list 'embark-target-finders 'my-embark-subed-timestamp)
  (add-to-list 'embark-target-injection-hooks '(my-journal-post embark--allow-edit))
  (<span class="org-keyword">with-eval-after-load</span> 'subed
    (<span class="org-keyword">defvar-keymap</span> embark-subed-timestamp-actions
      <span class="org-builtin">:doc</span> <span class="org-doc">"Subed timestamp actions"</span>
      <span class="org-builtin">:parent</span> subed-mode-map
      <span class="org-string">"."</span> #'my-subed-set-timestamp-to-mpv-position
      <span class="org-string">"c"</span> #'my-subed-copy-timestamp-dwim
      <span class="org-string">"&lt;up&gt;"</span> #'my-subed-adjust-timestamp/my-subed-adjust-timestamp-up
      <span class="org-string">"w"</span> #'my-waveform-subed-show-after-time
      <span class="org-string">"&lt;down&gt;"</span> #'my-subed-adjust-timestamp/my-subed-adjust-timestamp-down))
  (<span class="org-keyword">defvar-keymap</span> embark-sketch-actions
    <span class="org-builtin">:doc</span> <span class="org-doc">"Org Mode sketch-related actions"</span>
    <span class="org-builtin">:parent</span> org-mode-map
    <span class="org-string">"o"</span> #'my-sketch-insert-file-as-link
    <span class="org-string">"v"</span> #'my-geeqie-view)
  (<span class="org-keyword">defvar-keymap</span> embark-journal-actions
    <span class="org-builtin">:doc</span> <span class="org-doc">"Journal"</span>
    <span class="org-string">"e"</span> #'my-journal-edit)
  (add-to-list 'embark-keymap-alist '(sketch . embark-sketch-actions))
  (add-to-list 'embark-keymap-alist '(subed-timestamp . embark-subed-timestamp-actions))
  (add-to-list 'embark-keymap-alist '(journal . embark-journal-actions))
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"C-."</span> . embark-act)
   (<span class="org-string">"C-;"</span> . embark-act)
   <span class="org-builtin">:map</span> minibuffer-local-map
   ((<span class="org-string">"C-c e"</span> . embark-act)
    (<span class="org-string">"C-;"</span> . embark-act)
    (<span class="org-string">"C-&lt;tab&gt;"</span> . embark-select)
    (<span class="org-string">"C-SPC"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (embark-select) (vertico-next))))
   <span class="org-builtin">:map</span> embark-collect-mode-map
   ((<span class="org-string">"C-c e"</span> . embark-act)
    (<span class="org-string">"C-;"</span> . embark-act)
    (<span class="org-string">"C-&lt;tab&gt;"</span> . embark-select))
   <span class="org-builtin">:map</span> embark-general-map
   ((<span class="org-string">"j"</span> . my-journal-post)
    (<span class="org-string">"m"</span> . my-stream-message)
    (<span class="org-string">"M-w"</span> . (<span class="org-keyword">lambda</span> (s) (<span class="org-keyword">interactive</span> <span class="org-string">"MString: "</span>) (kill-new s))))
   <span class="org-builtin">:map</span> embark-symbol-map
   (<span class="org-string">"r"</span> . erefactor-rename-symbol-in-buffer)
   <span class="org-builtin">:map</span> embark-url-map
   (<span class="org-string">"c"</span> . my-caption-show)
   ))
(<span class="org-keyword">with-eval-after-load</span> 'embark-org
  (define-key embark-org-src-block-map
   <span class="org-string">"i"</span> #'my-org-fix-block-indentation))
</pre>
</div>

<p>
Things I'm getting used to using:
</p>

<ul class="org-ul">
<li><code>C-. c</code> on an Org Mode source block to copy the contents</li>
</ul>
</div>
<div id="outline-container-embark-qr" class="outline-4">
<h4 id="embark-qr">Using Embark and qrencode to show a QR code for the Org Mode link at point&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h4>
<div class="outline-text-4" id="text-embark-qr">
<div class="update" id="org4d67b69">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-01-12 Fri]</span></span>: Added some code to display the QR code on the right side.
</p>

</div>

<p>
John Kitchin includes <a href="https://www.youtube.com/watch?v=rGGAr1AWkTc">little QR codes in his videos</a>. I
thought that was a neat touch that makes it easier for
people to jump to a link while they're watching. I'd like to
make it easier to show QR codes too. The following code lets
me show a QR code for the Org link at point. Since many of
my links use custom Org link types that aren't that useful
for people to scan, the code reuses the link resolution code
from <a href="https://sachachua.com/dotemacs#web-link">https://sachachua.com/dotemacs#web-link</a> so that I can get the regular
<code>https:</code> link.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-link-qr</span> (url)
  <span class="org-doc">"Display a QR code for URL in a buffer."</span>
  (<span class="org-keyword">let</span> ((buf (<span class="org-keyword">save-window-excursion</span> (qrencode--encode-to-buffer (my-org-stored-link-as-url url)))))
    (display-buffer-in-side-window buf '((side . right)))))

(<span class="org-keyword">use-package</span> qrencode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">with-eval-after-load</span> 'embark-org
    (define-key embark-org-link-map (kbd <span class="org-string">"q"</span>) #'my-org-link-qr)))
</pre>
</div>


<figure id="org7406bf1">
<img src="images/qr-code.svg" alt="qr-code.svg" class="org-svg">

<figcaption><span class="figure-number">Figure 2: </span>Screenshot of QR code for the link at point</figcaption>
</figure>
</div>
</div>
<div id="outline-container-embark-video" class="outline-4">
<h4 id="embark-video"><span class="todo TODO">TODO</span> Using Embark to act on video</h4>
<div class="outline-text-4" id="text-embark-video">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-video</span> ()
  <span class="org-doc">"Match video."</span>
  (<span class="org-keyword">let</span> ((extensions <span class="org-string">"youtu\\.?be</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">webm</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">mp4</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">flv</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span>))
    (<span class="org-keyword">if-let</span> ((link (<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
                        (org-element-context))))
        (<span class="org-keyword">when</span> (eq (org-element-type link) 'link)
          (<span class="org-keyword">cond</span>
           ((string-match extensions (org-element-property <span class="org-builtin">:path</span> link))
            (cons 'video (org-element-property <span class="org-builtin">:path</span> link)))))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (derived-mode-p 'dired-mode)
                 (string-match extensions (dired-get-filename)))
        (cons 'video (dired-get-filename))))))

(<span class="org-keyword">with-eval-after-load</span> 'embark
  (add-to-list 'embark-target-finders 'my-embark-video)
  (<span class="org-keyword">defvar-keymap</span> my-embark-video-actions
    <span class="org-builtin">:doc</span> <span class="org-doc">"video"</span>
    <span class="org-string">"d"</span> #'my-deepgram-recognize-audio
    <span class="org-string">"$"</span> #'my-deepgram-cost
    <span class="org-string">"m"</span> #'mpv-play
    <span class="org-string">"c"</span> #'my-caption-show
    <span class="org-string">"w"</span> #'my-audio-text
    <span class="org-string">"W"</span> #'waveform-show)
  (add-to-list 'embark-keymap-alist '(video . my-embark-video-actions)))
</pre>
</div>
</div>
</div>
<div id="outline-container-embark-audio" class="outline-4">
<h4 id="embark-audio"><span class="todo TODO">TODO</span> Using Embark to act on audio</h4>
<div class="outline-text-4" id="text-embark-audio">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-audio</span> ()
  <span class="org-doc">"Match audio."</span>
  (<span class="org-keyword">let</span> ((extensions <span class="org-string">"m4a</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">mp3</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">wav</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">ogg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">opus"</span>))
    (<span class="org-keyword">if-let</span> ((link (<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
                        (org-element-context))))
        (<span class="org-keyword">when</span> (eq (org-element-type link) 'link)
          (<span class="org-keyword">cond</span>
           ((string-match extensions (org-element-property <span class="org-builtin">:path</span> link))
            (cons 'audio (org-element-property <span class="org-builtin">:path</span> link)))))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (derived-mode-p 'dired-mode)
                 (string-match extensions (dired-get-filename)))
        (cons 'audio (dired-get-filename))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-text</span> (file <span class="org-type">&amp;optional</span> insert)
  <span class="org-doc">"Get the text for FILE audio.</span>
<span class="org-doc">If called interactively, copy to the kill ring."</span>
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"Audio: "</span>)))
  (<span class="org-keyword">let</span> (text)
    (<span class="org-keyword">cond</span>
     ((file-exists-p (concat (file-name-sans-extension file) <span class="org-string">".txt"</span>))
      (<span class="org-keyword">with-temp-buffer</span>
        (insert-file-contents (concat (file-name-sans-extension file) <span class="org-string">".txt"</span>))
        (<span class="org-keyword">setq</span> text (buffer-string))))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">no txt yet, is there a vtt?</span>
     ((file-exists-p (concat (file-name-sans-extension file) <span class="org-string">".vtt"</span>))
      (<span class="org-keyword">setq</span> text (subed-subtitle-list-text
                  (subed-parse-file (concat (file-name-sans-extension file) <span class="org-string">".vtt"</span>)))))
     <span class="org-comment-delimiter">;; </span><span class="org-comment">no VTT, let's recognize it</span>
     (t
      (my-deepgram-recognize-audio file)
      (<span class="org-keyword">when</span> (file-exists-p (concat (file-name-sans-extension file) <span class="org-string">".vtt"</span>))
        (<span class="org-keyword">setq</span> text (subed-subtitle-list-text
                    (subed-parse-file (concat (file-name-sans-extension file) <span class="org-string">".vtt"</span>)))))))
    (<span class="org-keyword">when</span> text
      (<span class="org-keyword">when</span> (called-interactively-p 'any)
        (<span class="org-keyword">if</span> insert
            (insert text <span class="org-string">"\n"</span>)
          (kill-new text)))
      text)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-in-audacity</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FFile: "</span>)
  (start-process <span class="org-string">"audacity"</span> nil <span class="org-string">"audacity"</span> file))

(<span class="org-keyword">with-eval-after-load</span> 'embark
  (add-to-list 'embark-target-finders 'my-embark-audio)
  (<span class="org-keyword">defvar-keymap</span> my-embark-audio-actions
    <span class="org-builtin">:doc</span> <span class="org-doc">"audio"</span>
    <span class="org-string">"a"</span> #'my-open-in-audacity
    <span class="org-string">"d"</span> #'my-deepgram-recognize-audio
    <span class="org-string">"$"</span> #'my-deepgram-cost
    <span class="org-string">"D"</span> #'my-audio-braindump-reprocess
    <span class="org-string">"m"</span> #'mpv-play
    <span class="org-string">"w"</span> #'my-audio-text
    <span class="org-string">"W"</span> #'waveform-show)
  (add-to-list 'embark-keymap-alist '(audio . my-embark-audio-actions)))
</pre>
</div>
</div>
</div>
<div id="outline-container-using-embark-to-insert-files-as-org-includes" class="outline-4">
<h4 id="using-embark-to-insert-files-as-org-includes">Using Embark to insert files as Org INCLUDEs</h4>
<div class="outline-text-4" id="text-using-embark-to-insert-files-as-org-includes">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-file-as-org-include</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"fFile: "</span>)
  (set-text-properties 0 (length file) nil file)
  (<span class="org-keyword">let</span> ((mode (assoc-default file auto-mode-alist 'string-match)))
    (insert
     (org-link-make-string (concat <span class="org-string">"file:"</span> file) (concat <span class="org-string">"Download "</span> (file-name-nondirectory file))) <span class="org-string">"\n"</span>
     <span class="org-string">"#+begin_my_details "</span> (file-name-nondirectory file) <span class="org-string">"\n"</span>
     (format <span class="org-string">"#+INCLUDE: %s"</span> (prin1-to-string file))
     (<span class="org-keyword">if</span> mode
         (concat <span class="org-string">" src "</span> (replace-regexp-in-string <span class="org-string">"-mode$"</span> <span class="org-string">""</span> (symbol-name mode)))
       <span class="org-string">""</span>)
     <span class="org-string">"\n"</span>
     <span class="org-string">"#+end_my_details\n"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-transform-org-link-to-include</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((link (org-element-lineage (org-element-context) '(link) t))
        (mode (assoc-default (org-element-property <span class="org-builtin">:path</span> link) auto-mode-alist 'string-match)))
    (<span class="org-keyword">when</span> link
      (delete-region (org-element-property <span class="org-builtin">:begin</span> link)
                     (org-element-property <span class="org-builtin">:end</span> link))
      (my-insert-file-as-org-include (org-element-property <span class="org-builtin">:path</span> link)))))


(<span class="org-keyword">with-eval-after-load</span> 'embark
  (define-key embark-file-map <span class="org-string">"O"</span> #'my-insert-file-as-org-include))
</pre>
</div>
</div>
</div>
<div id="outline-container-using-embark-to-offer-context-sensitive-actions-for-org-elements" class="outline-4">
<h4 id="using-embark-to-offer-context-sensitive-actions-for-org-elements">Using Embark to offer context-sensitive actions for Org elements</h4>
<div class="outline-text-4" id="text-using-embark-to-offer-context-sensitive-actions-for-org-elements">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org66b8964">(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-org-element</span> ()
  <span class="org-doc">"Target an Org Mode element at point."</span>
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">save-restriction</span>
        (<span class="org-keyword">when</span> (derived-mode-p 'org-agenda-mode)
          (org-goto-marker-or-bmk (org-get-at-bol 'org-marker))
          (org-back-to-heading))
        (<span class="org-keyword">when</span> (derived-mode-p 'org-mode)
          (<span class="org-keyword">let*</span> ((context <span class="org-comment-delimiter">;; </span><span class="org-comment">Borrowed from org-open-at-point</span>
                  <span class="org-comment-delimiter">;; </span><span class="org-comment">Only consider supported types, even if they are not the</span>
                  <span class="org-comment-delimiter">;; </span><span class="org-comment">closest one.</span>
                  (org-element-lineage (org-element-context)
                                       '(headline src-block link) t))
                 (type (org-element-type context))
                 (value (org-element-property <span class="org-builtin">:value</span> context)))
            (<span class="org-keyword">cond</span> ((eq type 'headline)
                   (cons 'org-heading (org-element-property <span class="org-builtin">:title</span> context)))
                  ((eq type 'src-block)
                   (cons 'org-src-block (org-element-property <span class="org-builtin">:name</span> context)))
                  ((eq type 'link)
                   (cons 'url (org-element-property <span class="org-builtin">:raw-link</span> context))))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-org-src-block-copy-noweb-reference</span> (element)
  (kill-new (<span class="org-keyword">if</span> (org-element-property element <span class="org-builtin">:parameters</span>)
                (format <span class="org-string">"&lt;&lt;%s(%s)&gt;&gt;"</span> (org-element-property element <span class="org-builtin">:name</span>)
                        (org-element-property element <span class="org-builtin">:parameters</span>))
              (format <span class="org-string">"&lt;&lt;%s&gt;&gt;"</span> (org-element-property element <span class="org-builtin">:parameters</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org77a8d72" class="outline-4">
<h4 id="org77a8d72">Whichkey and Embark</h4>
<div class="outline-text-4" id="text-org77a8d72">
<p>
From <a href="https://github.com/oantolin/embark/wiki/Additional-Configuration#use-which-key-like-a-key-menu-prompt">https://github.com/oantolin/embark/wiki/Additional-Configuration#use-which-key-like-a-key-menu-prompt</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">embark-which-key-indicator</span> ()
  <span class="org-doc">"An embark indicator that displays keymaps using which-key.</span>
<span class="org-doc">The which-key help message will show the type and value of the</span>
<span class="org-doc">current target followed by an ellipsis if there are further</span>
<span class="org-doc">targets."</span>
  (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;optional</span> keymap targets prefix)
    (<span class="org-keyword">if</span> (null keymap)
        (which-key--hide-popup-ignore-command)
      (which-key--show-keymap
       (<span class="org-keyword">if</span> (eq (plist-get (car targets) <span class="org-builtin">:type</span>) 'embark-become)
           <span class="org-string">"Become"</span>
         (format <span class="org-string">"Act on %s '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">'%s"</span>
                 (plist-get (car targets) <span class="org-builtin">:type</span>)
                 (embark--truncate-target (plist-get (car targets) <span class="org-builtin">:target</span>))
                 (<span class="org-keyword">if</span> (cdr targets) <span class="org-string">"&#8230;"</span> <span class="org-string">""</span>)))
       (<span class="org-keyword">if</span> prefix
           (<span class="org-keyword">pcase</span> (lookup-key keymap prefix 'accept-default)
             ((<span class="org-keyword">and</span> (pred keymapp) km) km)
             (_ (key-binding prefix 'accept-default)))
         keymap)
       nil nil t (<span class="org-keyword">lambda</span> (binding)
                   (not (string-suffix-p <span class="org-string">"-argument"</span> (cdr binding))))))))

(<span class="org-keyword">setq</span> embark-indicators
  '(embark-which-key-indicator
    embark-highlight-indicator
    embark-isearch-highlight-indicator))

(<span class="org-keyword">defun</span> <span class="org-function-name">embark-hide-which-key-indicator</span> (fn <span class="org-type">&amp;rest</span> args)
  <span class="org-doc">"Hide the which-key indicator immediately when using the completing-read prompter."</span>
  (which-key--hide-popup-ignore-command)
  (<span class="org-keyword">let</span> ((embark-indicators
         (remq #'embark-which-key-indicator embark-indicators)))
      (apply fn args)))

(<span class="org-keyword">with-eval-after-load</span> 'embark
  (advice-add #'embark-completing-read-prompter
              <span class="org-builtin">:around</span> #'embark-hide-which-key-indicator))
</pre>
</div>
</div>
</div>
<div id="outline-container-org8c1d8d5" class="outline-4">
<h4 id="org8c1d8d5">Embark and images</h4>
<div class="outline-text-4" id="text-org8c1d8d5">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-insert-file-as-link</span> (f)
  (<span class="org-keyword">interactive</span> <span class="org-string">"fSketch: "</span>)
  (insert (org-link-make-string (concat <span class="org-string">"sketch:"</span> (file-name-nondirectory f))) <span class="org-string">"\n"</span>))
</pre>
</div>
</div>
<div id="outline-container-embark-image" class="outline-5">
<h5 id="embark-image"><span class="todo TODO">TODO</span> Using Embark to act on images</h5>
<div class="outline-text-5" id="text-embark-image">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-image</span> ()
  <span class="org-doc">"Match images."</span>
  (<span class="org-keyword">let</span> ((extensions <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">svg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">gif</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\$"</span>))
    (<span class="org-keyword">if-let</span> ((link (<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
                        (org-element-context))))
        (<span class="org-keyword">when</span> (eq (org-element-type link) 'link)
          (<span class="org-keyword">cond</span>
           ((string-match <span class="org-string">"sketch"</span> (org-element-property <span class="org-builtin">:type</span> link))
            (cons 'image (my-get-sketch-filename (org-element-property <span class="org-builtin">:path</span> link))))
           ((string-match extensions (org-element-property <span class="org-builtin">:path</span> link))
            (cons 'image (org-element-property <span class="org-builtin">:path</span> link)))))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (derived-mode-p 'dired-mode)
                 (string-match extensions (dired-get-filename)))
        (cons 'image (dired-get-filename))))))
(<span class="org-keyword">with-eval-after-load</span> 'embark
  (add-to-list 'embark-target-finders 'my-embark-image))
</pre>
</div>

<p>
I want to:
</p>

<ul class="org-ul">
<li>open images in an annotation program, maybe <a href="https://github.com/phase1geo/Annotator">com.github.phase1geo.annotator</a></li>
<li>open images in <a href="https://krita.org/en/">Krita</a></li>
<li>replace with latest screenshot</li>
<li>copy text to kill ring</li>
<li>insert text as details block</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-image-open-in-annotator</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FImage: "</span>)
  (start-process <span class="org-string">"annotator"</span> nil <span class="org-string">"com.github.phase1geo.annotator"</span> (expand-file-name file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-image-open-in-krita</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FImage: "</span>)
  (start-process <span class="org-string">"krita"</span> nil <span class="org-string">"krita"</span> <span class="org-string">"--nosplash"</span> (expand-file-name file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-image-open-in-inkscape</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FImage: "</span>)
  (start-process <span class="org-string">"inkscape"</span> nil <span class="org-string">"inkscape"</span> (expand-file-name file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-image-open-in-gimp</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FImage: "</span>)
  (start-process <span class="org-string">"gimp"</span> nil <span class="org-string">"gimp"</span> (expand-file-name file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-in-firefox</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FItem: "</span>)
  (start-process <span class="org-string">"firefox"</span> nil <span class="org-string">"firefox"</span> (<span class="org-keyword">if</span> (string-match <span class="org-string">"^http"</span> file) file (expand-file-name file))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-image-recognize</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FFile: "</span>)
  (<span class="org-keyword">let</span> ((data (json-parse-string
               (<span class="org-keyword">if</span> (file-exists-p (concat (file-name-sans-extension file) <span class="org-string">".json"</span>))
                   (<span class="org-keyword">with-temp-buffer</span>
                     (insert-file-contents (concat (file-name-sans-extension file) <span class="org-string">".json"</span>))
                     (buffer-string))
                 (<span class="org-keyword">with-temp-file</span> (concat (file-name-sans-extension file) <span class="org-string">".json"</span>)
                   (call-process <span class="org-string">"gcloud"</span> nil t nil <span class="org-string">"ml"</span> <span class="org-string">"vision"</span> <span class="org-string">"detect-document"</span> (expand-file-name file))
                   (buffer-string)))
               <span class="org-builtin">:object-type</span> 'alist)))
    (<span class="org-keyword">if</span> (assoc-default 'responses data)
        (assoc-default 'text (assoc-default 'fullTextAnnotation (elt (assoc-default 'responses data) 0)))
      (assoc-default 'description (elt (assoc-default 'textAnnotations data) 0)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-image-copy-text</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FImage: "</span>)
  (kill-new (my-image-recognize file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-image-insert-text-as-details</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FImage: "</span>)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
             (eq (org-element-type (org-element-context)) 'link))
    (goto-char (org-element-end (org-element-context))))
  (insert <span class="org-string">"\n#+begin_my_details\n"</span> (my-image-recognize file) <span class="org-string">"\n#+end_my_details\n"</span>))

(<span class="org-keyword">with-eval-after-load</span> 'embark
  (<span class="org-keyword">defvar-keymap</span> my-embark-image-actions
      <span class="org-builtin">:doc</span> <span class="org-doc">"Images"</span>
      <span class="org-string">"k"</span> #'my-image-open-in-krita
      <span class="org-string">"a"</span> #'my-image-open-in-annotator
      <span class="org-string">"i"</span> #'my-image-open-in-inkscape
      <span class="org-string">"w"</span> #'my-image-copy-text
      <span class="org-string">"g"</span> #'my-image-open-in-gimp
      <span class="org-string">"f"</span> #'my-open-in-firefox
      <span class="org-string">"d"</span> #'my-image-insert-text-as-details)
  (add-to-list 'embark-keymap-alist '(image . my-embark-image-actions)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-embark-subed" class="outline-4">
<h4 id="embark-subed">Embark and subed</h4>
<div class="outline-text-4" id="text-embark-subed">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-set-timestamp-to-mpv-position</span> (<span class="org-type">&amp;optional</span> rest)
  (<span class="org-keyword">interactive</span>)
  (skip-chars-backward <span class="org-string">"0-9:,."</span>)
  (<span class="org-keyword">when</span> (looking-at <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
    (replace-match (<span class="org-keyword">save-match-data</span> (subed-msecs-to-timestamp subed-mpv-playback-position)) t t)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-subed-timestamp</span> ()
  (<span class="org-keyword">save-excursion</span>
    (skip-chars-backward <span class="org-string">"0-9:,."</span>)
    (<span class="org-keyword">when</span> (looking-at <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
      (list 'subed-timestamp
            (propertize
             (match-string 0)
             'ms (compile-media-timestamp-to-msecs (match-string 0))
             'position (<span class="org-keyword">if</span> (bolp) 'start 'stop))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-adjust-timestamp</span> (offset)
  (<span class="org-keyword">interactive</span> (list -100))
  (<span class="org-keyword">save-excursion</span>
    (skip-chars-backward <span class="org-string">"0-9:,."</span>)
    (<span class="org-keyword">when</span> (looking-at subed-vtt--regexp-timestamp)
      (<span class="org-keyword">let</span> ((new-ts (+ (subed-vtt--timestamp-to-msecs (match-string 0)) offset)))
        (replace-match (<span class="org-keyword">save-match-data</span>
                         (subed-vtt--msecs-to-timestamp new-ts)))
        (my-waveform-subed-show-after-time)
        new-ts))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-adjust-timestamp-up</span> (offset)
  (<span class="org-keyword">interactive</span> (list 100))
  (subed-mpv-jump (my-subed-adjust-timestamp (- offset))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-adjust-timestamp-down</span> (offset)
  (<span class="org-keyword">interactive</span> (list -100))
  (subed-mpv-jump (my-subed-adjust-timestamp (- offset))))

(<span class="org-keyword">defhydra</span> my-subed-adjust-timestamp ()
  (<span class="org-string">"&lt;up&gt;"</span> my-subed-adjust-timestamp-up <span class="org-string">"Up"</span> <span class="org-builtin">:exit</span> nil)
  (<span class="org-string">"&lt;down&gt;"</span> my-subed-adjust-timestamp-down <span class="org-string">"Down"</span> <span class="org-builtin">:exit</span> nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-copy-timestamp-from-previous</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((ms (<span class="org-keyword">save-excursion</span> (subed-backward-subtitle-time-stop) (subed-subtitle-msecs-stop))))
    (subed-set-subtitle-time-start ms)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-copy-timestamp-to-next</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((ms (subed-subtitle-msecs-stop)))
    (<span class="org-keyword">save-excursion</span>
      (subed-forward-subtitle-time-stop) (subed-set-subtitle-time-start ms))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-copy-timestamp-dwim</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (skip-chars-backward <span class="org-string">"0-9:,."</span>)
    (<span class="org-keyword">if</span> (bolp)
        (my-subed-copy-timestamp-from-previous)
      (my-subed-copy-timestamp-to-next))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org8448eaf" class="outline-4">
<h4 id="org8448eaf">Embark, symbols, and casual-symbol-overlay</h4>
<div class="outline-text-4" id="text-org8448eaf">
<p>
Link: <a href="http://yummymelon.com/devnull/announcing-casual-symbol-overlay.html">http://yummymelon.com/devnull/announcing-casual-symbol-overlay.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> casual-symbol-overlay
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">with-eval-after-load</span> 'embark
    (keymap-set embark-symbol-map <span class="org-string">"z"</span> #'casual-symbol-overlay-tmenu)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-cargo-culted-stuff" class="outline-3">
<h3 id="cargo-culted-stuff">Cargo-culted stuff</h3>
<div class="outline-text-3" id="text-cargo-culted-stuff">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-store-action-key+cmd</span> (cmd)
  (<span class="org-keyword">setq</span> keycast--this-command-keys (this-single-command-keys) keycast--this-command cmd))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-force-keycast-update</span> (<span class="org-type">&amp;rest</span> _)
  (force-mode-line-update t))
(<span class="org-keyword">use-package</span> keycast
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:after</span> embark
  <span class="org-builtin">:config</span> (<span class="org-keyword">dolist</span> (cmd '(embark-act embark-act-noexit embark-become))
            (advice-add cmd
                        <span class="org-builtin">:before</span> #'my-force-keycast-update)))

(<span class="org-keyword">use-package</span>
  embark
  <span class="org-builtin">:config</span>
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(setq embark-prompter 'embark-completing-read-prompter)</span>
  (advice-add 'embark-keymap-prompter <span class="org-builtin">:filter-return</span> #'my-store-action-key+cmd)
  (add-to-list 'embark-target-injection-hooks '(my-stream-message embark--allow-edit)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-appearance" class="outline-2">
<h2 id="appearance">Appearance</h2>
<div class="outline-text-2" id="text-appearance">
</div>
<div id="outline-container-color-theme-sometimes-comes-across-lists-odd" class="outline-3">
<h3 id="color-theme-sometimes-comes-across-lists-odd">color-theme sometimes comes across lists. Odd!</h3>
<div class="outline-text-3" id="text-color-theme-sometimes-comes-across-lists-odd">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defadvice</span> <span class="org-function-name">face-attribute</span> (around sacha activate)
  (<span class="org-keyword">if</span> (symbolp (ad-get-arg 0))
      ad-do-it))
</pre>
</div>
</div>
</div>
<div id="outline-container-display" class="outline-3">
<h3 id="display">Display</h3>
<div class="outline-text-3" id="text-display">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/adjust-opacity</span> (frame incr)
  (<span class="org-keyword">let*</span> ((oldalpha (<span class="org-keyword">or</span> (frame-parameter frame 'alpha) 100))
         (newalpha (+ incr oldalpha)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (&lt;= frame-alpha-lower-limit newalpha) (&gt;= 100 newalpha))
      (modify-frame-parameters frame (list (cons 'alpha newalpha))))))
(keymap-global-set <span class="org-string">"C-M-8"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (sanityinc/adjust-opacity nil -2)))
(keymap-global-set <span class="org-string">"C-M-9"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (sanityinc/adjust-opacity nil 2)))
(keymap-global-set <span class="org-string">"C-M-0"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (modify-frame-parameters nil `((alpha . 100)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-color-theme" class="outline-3">
<h3 id="color-theme">Color theme</h3>
<div class="outline-text-3" id="text-color-theme">
</div>
<div id="outline-container-set-up-a-light-on-dark-color-scheme" class="outline-4">
<h4 id="set-up-a-light-on-dark-color-scheme">Set up a light-on-dark color scheme</h4>
<div class="outline-text-4" id="text-set-up-a-light-on-dark-color-scheme">
<p>
I like light on dark because I find it to be more restful. The
color-theme in ELPA was a little odd, though, so we define some advice to make
it work. Some things still aren't quite right.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-setup-color-theme</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (display-graphic-p)
    (load-theme (car modus-themes-to-toggle))))
(<span class="org-keyword">use-package</span> modus-themes
  <span class="org-builtin">:quelpa</span> (modus-themes <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"protesilaos/modus-themes"</span>)
  <span class="org-builtin">:init</span> (<span class="org-keyword">setq</span> modus-themes-to-toggle '(modus-vivendi modus-operandi))
  <span class="org-builtin">:config</span> (my-setup-color-theme))
</pre>
</div>

<p>
I sometimes need to switch to a lighter background for screenshots.
For that, I use <code>modus-themes-operandi</code>.
</p>
</div>
</div>
<div id="outline-container-making-highlight-sexp-follow-modus-themes-toggle" class="outline-4">
<h4 id="making-highlight-sexp-follow-modus-themes-toggle">Making highlight-sexp follow modus-themes-toggle&#xa0;&#xa0;&#xa0;<span class="tag"><span class="elisp">elisp</span>&#xa0;<span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-making-highlight-sexp-follow-modus-themes-toggle">
<div class="update" id="org330af7f">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2023-01-27 Fri] </span></span> Prot just added a <a href="https://github.com/protesilaos/modus-themes/commit/0ca79257ef941ff5f9ec34f5d76eed2ff35d7752">modus-themes-get-color-value</a>
function. Yay! Also, it turns out that I need to update the overlay in
all the buffers.
</p>

</div>

<p>
I'm experimenting with using the <code>highlight-sexp</code> minor mode to
highlight my current s-expression, since I sometimes get confused
about what I'm modifying with smartparens. The highlight-sexp
background colour is hardcoded in the variable
<code>hl-sexp-background-color</code>, and will probably look terrible if you use
a light background. I wanted it to adapt when I use
<code>modus-themes-toggle</code>. Here's how that works:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>highlight-sexp demonstration</label><pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> highlight-sexp
  <span class="org-builtin">:quelpa</span>
  (highlight-sexp <span class="org-builtin">:repo</span> <span class="org-string">"daimrod/highlight-sexp"</span> <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:version</span> original)
  <span class="org-builtin">:after</span> modus-themes
  <span class="org-builtin">:hook</span>
  ((emacs-lisp-mode . highlight-sexp-mode)
   (modus-themes-after-load-theme . my-hl-sexp-update-all-overlays))
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">my-hl-sexp-update-overlay</span> ()
    (<span class="org-keyword">when</span> (overlayp hl-sexp-overlay)
      (overlay-put
       hl-sexp-overlay
       'face
       `(<span class="org-builtin">:background</span>
         ,(modus-themes-get-color-value 'bg-inactive)))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">my-hl-sexp-update-all-overlays</span> (<span class="org-type">&amp;rest</span> args)
    (<span class="org-keyword">dolist</span> (buf (buffer-list))
      (<span class="org-keyword">with-current-buffer</span> buf
        (<span class="org-keyword">when</span> highlight-sexp-mode
          (my-hl-sexp-update-overlay)))))
  (advice-add 'hl-sexp-create-overlay <span class="org-builtin">:after</span> 'my-hl-sexp-update-overlay))
</pre>
</div>

<p>
This is what it looks like:
</p>


<figure id="org9396e1c">
<img src="file:///home/sacha/proj/static-blog/blog/2023/01/making-highlight-sexp-follow-modus-themes-toggle/highlight-sexp.gif" alt="highlight-sexp.gif">

<figcaption><span class="figure-number">Figure 3: </span>Animation of highlight-sexp toggling along with modus-themes-toggle</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-modeline" class="outline-3">
<h3 id="modeline">Modeline</h3>
<div class="outline-text-3" id="text-modeline">
</div>
<div id="outline-container-time-in-the-modeline" class="outline-4">
<h4 id="time-in-the-modeline">Time in the modeline</h4>
<div class="outline-text-4" id="text-time-in-the-modeline">
<p>
I like having the clock.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(display-time-mode 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-diminish" class="outline-4">
<h4 id="diminish">Diminish mode names in modeline</h4>
<div class="outline-text-4" id="text-diminish">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> diminish <span class="org-builtin">:ensure</span> t)
</pre>
</div>
</div>
</div>
<div id="outline-container-highlight-the-active-modeline-using-colours-from-modus-themes" class="outline-4">
<h4 id="highlight-the-active-modeline-using-colours-from-modus-themes">Highlight the active modeline using colours from modus-themes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-highlight-the-active-modeline-using-colours-from-modus-themes">
<p>
I wanted to experiment with for colouring the mode line of the active window ever so slightly different to make it easier to see where the active window is. I usually have <code>global-hl-line-mode</code> turned on, so that highlight is another indicator, but let's see how this tweak feels. I modified the code so that it uses the theme colours from the currently-selected Modus themes, since I trust Prot's colour choices more than I trust mine. Thanks to Irreal for sharing Ignacio's comment!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-update-active-mode-line-colors</span> ()
  (set-face-attribute
   'mode-line nil
   <span class="org-builtin">:foreground</span> (modus-themes-get-color-value 'fg-mode-line-active)
   <span class="org-builtin">:background</span> (modus-themes-get-color-value 'bg-blue-subtle)
   <span class="org-builtin">:box</span> '(<span class="org-builtin">:line-width</span>
          1
          <span class="org-builtin">:color</span>
          (modus-themes-get-color-value 'border-mode-line-active))))
(<span class="org-keyword">use-package</span> modus-themes
  <span class="org-builtin">:hook</span>
  (modus-themes-after-load-theme . my-update-active-mode-line-colors))
</pre>
</div>

<div class="columns" id="org9c93453">
<div class="column50" id="org1915503">

<figure id="org8bf5ad8">
<a href="images/dark-mode-line.svg"><img src="images/dark-mode-line.svg" alt="dark-mode-line.svg" class="org-svg"></a>

<figcaption><span class="figure-number">Figure 4: </span>with dark mode</figcaption>
</figure>

</div>
<div class="column50" id="orgb3c55b6">

<figure id="org882d8c6">
<a href="images/light-mode-line.svg"><img src="images/light-mode-line.svg" alt="light-mode-line.svg" class="org-svg"></a>

<figcaption><span class="figure-number">Figure 5: </span>with light mode</figcaption>
</figure>

</div>

</div>
</div>
</div>
</div>
<div id="outline-container-prepare-for-emacsconf-screenshots-or-recordings" class="outline-3">
<h3 id="prepare-for-emacsconf-screenshots-or-recordings">Prepare for EmacsConf screenshots or recordings</h3>
<div class="outline-text-3" id="text-prepare-for-emacsconf-screenshots-or-recordings">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-emacsconf-prepare-for-screenshots</span> ()
  (<span class="org-keyword">interactive</span>)
  (shell-command <span class="org-string">"xrandr --output LVDS-1 --mode 1280x720"</span>)
  (modus-themes-load-theme 'modus-operandi)
  (my-hl-sexp-update-overlay)
  (set-face-attribute 'default nil <span class="org-builtin">:height</span> 170)
  (keycast-mode))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-emacsconf-back-to-normal</span> ()
  (<span class="org-keyword">interactive</span>)
  (shell-command <span class="org-string">"xrandr --output LVDS-1 --mode 1366x768"</span>)
  (modus-themes-load-theme 'modus-vivendi)
  (my-hl-sexp-update-overlay)
  (set-face-attribute 'default nil <span class="org-builtin">:height</span> 115)
  (keycast-mode -1))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-navigation" class="outline-2">
<h2 id="navigation">Navigation</h2>
<div class="outline-text-2" id="text-navigation">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(transient-mark-mode 1)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-close-other-buffers</span> ()
  (<span class="org-keyword">interactive</span>)
  (mapc (<span class="org-keyword">lambda</span> (buf)
          (<span class="org-keyword">unless</span> (buffer-modified-p buf)
            (kill-buffer buf)))
        (delete (current-buffer)
                (buffer-list))))
</pre>
</div>
</div>
<div id="outline-container-quickly-jump-to-positions" class="outline-3">
<h3 id="quickly-jump-to-positions">Quickly jump to positions</h3>
<div class="outline-text-3" id="text-quickly-jump-to-positions">
<p>
Quickly jump to a position in the current view.
</p>

<ul class="org-ul">
<li><a href="https://karthinks.com/software/avy-can-do-anything/">https://karthinks.com/software/avy-can-do-anything/</a></li>
<li><a href="https://www.reddit.com/r/emacs/comments/r6px3r/avy_can_do_anything_youre_using_avy_wrong/">https://www.reddit.com/r/emacs/comments/r6px3r/avy_can_do_anything_youre_using_avy_wrong/</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> avy
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">avy-action-exchange</span> (pt)
    <span class="org-doc">"Exchange sexp at PT with the one at point."</span>
    (set-mark pt)
    (transpose-sexps 0))

  (add-to-list 'avy-dispatch-alist '(?e . avy-action-exchange))

  (<span class="org-keyword">defun</span> <span class="org-function-name">avy-action-embark</span> (pt)
    (<span class="org-keyword">save-excursion</span>
      (goto-char pt)
      (embark-act))
    (select-window
     (cdr (ring-ref avy-ring 0)))
    t)
  (<span class="org-keyword">setf</span> (alist-get ?. avy-dispatch-alist) 'avy-action-embark)
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"M-j"</span> . avy-goto-char-timer)
  )

(<span class="org-keyword">use-package</span> avy-zap
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> avy-zap-forward-only t)
  (<span class="org-keyword">setq</span> avy-keys '(?a ?o ?e ?u ?i ?d ?h ?t ?n ?s))
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"M-z"</span> . avy-zap-up-to-char-dwim)
   (<span class="org-string">"M-Z"</span> . avy-zap-to-char-dwim)))
</pre>
</div>
</div>
</div>
<div id="outline-container-undo-tree-mode-visualize-your-undos-and-branches" class="outline-3">
<h3 id="undo-tree-mode-visualize-your-undos-and-branches">Undo tree mode - visualize your undos and branches</h3>
<div class="outline-text-3" id="text-undo-tree-mode-visualize-your-undos-and-branches">
<p>
People often struggle with the Emacs undo model, where there's really no concept of "redo" - you simply undo the undo.
</p>

<p>
This lets you use <code>C-x u</code> (<code>undo-tree-visualize</code>) to visually walk through the changes you've made, undo back to a certain point (or redo), and go down different branches.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> undo-tree
  <span class="org-builtin">:diminish</span> undo-tree-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (global-undo-tree-mode)
    (<span class="org-keyword">setq</span> undo-tree-visualizer-timestamps t)
    (<span class="org-keyword">setq</span> undo-tree-auto-save-history nil)
    (<span class="org-keyword">setq</span> undo-tree-visualizer-diff t)
    (<span class="org-keyword">setq</span> undo-tree-history-directory-alist '((<span class="org-string">"."</span> . <span class="org-string">"~/.config/emacs/backups/undo-tree"</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-winner-mode-undo-and-redo-window-configuration" class="outline-3">
<h3 id="winner-mode-undo-and-redo-window-configuration">Winner mode - undo and redo window configuration</h3>
<div class="outline-text-3" id="text-winner-mode-undo-and-redo-window-configuration">
<p>
<code>winner-mode</code> lets you use <code>C-c &lt;left&gt;</code> and <code>C-c &lt;right&gt;</code> to switch between window configurations. This is handy when something has popped up a buffer that you want to look at briefly before returning to whatever you were working on. When you're done, press <code>C-c &lt;left&gt;</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> winner
  <span class="org-builtin">:defer</span> t)
</pre>
</div>
</div>
</div>
<div id="outline-container-sort-read-file-name" class="outline-3">
<h3 id="sort-read-file-name"><span class="todo TODO">TODO</span> Sort files in read-file-name</h3>
<div class="outline-text-3" id="text-sort-read-file-name">
<p>
<a href="https://emacs.stackexchange.com/questions/55502/list-files-in-directory-in-reverse-order-of-date">https://emacs.stackexchange.com/questions/55502/list-files-in-directory-in-reverse-order-of-date</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defcustom</span> <span class="org-variable-name">file-name-completions-sort-function</span> #'files-sort-access-time
  <span class="org-doc">"Function for sorting the completion list of file names.</span>
<span class="org-doc">The function takes the list of file names as argument</span>
<span class="org-doc">and returns the sorted list."</span>
  <span class="org-builtin">:type</span> '(choice (<span class="org-keyword">function</span> <span class="org-builtin">:tag</span> <span class="org-string">"Sort Function"</span>) (const <span class="org-builtin">:tag</span> <span class="org-string">"Natural Order"</span> nil))
  <span class="org-builtin">:group</span> 'files)

(<span class="org-keyword">defun</span> <span class="org-function-name">files-sort-access-time</span> (files)
  <span class="org-doc">"Sort FILES list with respect to access time."</span>
  (sort
   files
   (<span class="org-keyword">lambda</span> (fn1 fn2)
     (time-less-p
      (file-attribute-access-time (file-attributes fn2))
      (file-attribute-access-time (file-attributes fn1))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">ad-completion-file-name-table</span> (fun string pred action)
  <span class="org-doc">"Add '</span><span class="org-doc"><span class="org-constant">display-sort-function</span></span><span class="org-doc">' to metadata.</span>
<span class="org-doc">If the completion action is metadata, add</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">file-name-completions-sort-function</span></span><span class="org-doc">' as display-sort-function.</span>
<span class="org-doc">Otherwise call FUN with STRING, PRED and ACTION as arguments."</span>
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (functionp file-name-completions-sort-function)
       (eq action 'metadata))
      (list 'metadata
        '(category . file)
        (cons 'display-sort-function file-name-completions-sort-function))
    (funcall fun string pred action)))

(advice-add 'completion-file-name-table <span class="org-builtin">:around</span> #'ad-completion-file-name-table)
</pre>
</div>
</div>
</div>
<div id="outline-container-org6ec2f95" class="outline-3">
<h3 id="org6ec2f95">Downloaded files</h3>
<div class="outline-text-3" id="text-org6ec2f95">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-download-dir</span> <span class="org-string">"~/Downloads"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-latest-download</span> ()
  (<span class="org-keyword">interactive</span>)
  (find-file (my-latest-file my-download-dir)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-attach-and-link-latest-download</span> ()
  (<span class="org-keyword">interactive</span>)
  (org-attach-attach (my-latest-file my-download-dir) nil 'cp)
  (org-insert-link nil (caar org-stored-links)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-latest-download</span> (dest <span class="org-type">&amp;optional</span> force)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FDestination: "</span>)
  (copy-file (my-latest-file my-download-dir) dest force))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-download-dired</span> ()
  (<span class="org-keyword">interactive</span>)
  (dired my-download-dir <span class="org-string">"-lt"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-searching" class="outline-3">
<h3 id="searching">Searching</h3>
<div class="outline-text-3" id="text-searching">
<p>
I should get the hang of using <code>helm-org-rifle</code> and <code>ripgrep</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-org-rifle-org-directory</span> ()
  (<span class="org-keyword">interactive</span>)
  (helm-org-rifle-directories (list org-directory) t))
(<span class="org-keyword">use-package</span> helm-org-rifle
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"M-g r r"</span> . helm-org-rifle)
  (<span class="org-string">"M-g r a"</span> . helm-org-rifle-org-agenda-files)
  (<span class="org-string">"M-g r o"</span> . helm-org-rifle-org-directory)
  )
(<span class="org-keyword">defun</span> <span class="org-function-name">my-consult-recoll-without-emacs-news</span> ()
  (<span class="org-keyword">interactive</span>)
  (consult-recoll--open (consult-recoll--search <span class="org-string">"-\"Emacs News\" "</span>)))
(<span class="org-keyword">use-package</span> consult-recoll
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> consult-recoll-search-flags nil)
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"M-s S"</span> . consult-recoll))
</pre>
</div>
</div>
<div id="outline-container-deleting-things" class="outline-4">
<h4 id="deleting-things">Deleting things</h4>
<div class="outline-text-4" id="text-deleting-things">
<p>
From Steve Purcell, who linked to <a href="http://www.emacswiki.org/emacs/ZapToISearch">http://www.emacswiki.org/emacs/ZapToISearch</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">zap-to-isearch</span> (rbeg rend)
  <span class="org-doc">"Kill the region between the mark and the closest portion of</span>
<span class="org-doc">      the isearch match string. The behaviour is meant to be analogous</span>
<span class="org-doc">      to zap-to-char; let's call it zap-to-isearch. The deleted region</span>
<span class="org-doc">      does not include the isearch word. This is meant to be bound only</span>
<span class="org-doc">      in isearch mode.  The point of this function is that oftentimes</span>
<span class="org-doc">      you want to delete some portion of text, one end of which happens</span>
<span class="org-doc">      to be an active isearch word. The observation to make is that if</span>
<span class="org-doc">      you use isearch a lot to move the cursor around (as you should,</span>
<span class="org-doc">      it is much more efficient than using the arrows), it happens a</span>
<span class="org-doc">      lot that you could just delete the active region between the mark</span>
<span class="org-doc">      and the point, not include the isearch word."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">when</span> (not mark-active)
    (<span class="org-warning">error</span> <span class="org-string">"Mark is not active"</span>))
  (<span class="org-keyword">let*</span> ((isearch-bounds (list isearch-other-end (point)))
         (ismin (apply 'min isearch-bounds))
         (ismax (apply 'max isearch-bounds))
         )
    (<span class="org-keyword">if</span> (&lt; (mark) ismin)
        (kill-region (mark) ismin)
      (<span class="org-keyword">if</span> (&gt; (mark) ismax)
          (kill-region ismax (mark))
        (<span class="org-warning">error</span> <span class="org-string">"Internal error in isearch kill function."</span>)))
    (isearch-exit)
    ))

(define-key isearch-mode-map [(meta z)] 'zap-to-isearch)
</pre>
</div>
</div>
</div>
<div id="outline-container-org508d6a5" class="outline-4">
<h4 id="org508d6a5">Transient for isearch</h4>
<div class="outline-text-4" id="text-org508d6a5">
<p>
From <a href="https://github.com/kickingvegas/cclisp/blob/fae13b5adb6cb667af23070d000f9bd91b6ba3d8/cc-isearch-menu.el#L96">https://github.com/kickingvegas/cclisp/blob/fae13b5adb6cb667af23070d000f9bd91b6ba3d8/cc-isearch-menu.el#L96</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">transient</span>)
(transient-define-prefix cc/isearch-menu ()
  <span class="org-string">"isearch Menu"</span>
  [[<span class="org-string">"Edit Search String"</span>
    (<span class="org-string">"e"</span>
     <span class="org-string">"Edit the search string (recursive)"</span>
     isearch-edit-string
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"w"</span>
     <span class="org-string">"Pull next word or character word from buffer"</span>
     isearch-yank-word-or-char
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"s"</span>
     <span class="org-string">"Pull next symbol or character from buffer"</span>
     isearch-yank-symbol-or-char
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"l"</span>
     <span class="org-string">"Pull rest of line from buffer"</span>
     isearch-yank-line
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"y"</span>
     <span class="org-string">"Pull string from kill ring"</span>
     isearch-yank-kill
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"t"</span>
     <span class="org-string">"Pull thing from buffer"</span>
     isearch-forward-thing-at-point
     <span class="org-builtin">:transient</span> nil)]

   [<span class="org-string">"Replace"</span>
    (<span class="org-string">"q"</span>
     <span class="org-string">"Start &#8216;</span><span class="org-string"><span class="org-constant">query-replace</span></span><span class="org-string">&#8217;"</span>
     isearch-query-replace
     <span class="org-builtin">:if-nil</span> buffer-read-only
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"x"</span>
     <span class="org-string">"Start &#8216;</span><span class="org-string"><span class="org-constant">query-replace-regexp</span></span><span class="org-string">&#8217;"</span>
     isearch-query-replace-regexp
     <span class="org-builtin">:if-nil</span> buffer-read-only
     <span class="org-builtin">:transient</span> nil)]]

  [[<span class="org-string">"Toggle"</span>
    (<span class="org-string">"X"</span>
     <span class="org-string">"Regexp searching"</span>
     isearch-toggle-regexp
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"S"</span>
     <span class="org-string">"Symbol searching"</span>
     isearch-toggle-symbol
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"W"</span>
     <span class="org-string">"Word searching"</span>
     isearch-toggle-word
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"F"</span>
     <span class="org-string">"Case fold"</span>
     isearch-toggle-case-fold
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"L"</span>
     <span class="org-string">"Lax whitespace"</span>
     isearch-toggle-lax-whitespace
     <span class="org-builtin">:transient</span> nil)]

   [<span class="org-string">"Misc"</span>
    (<span class="org-string">"o"</span>
     <span class="org-string">"occur"</span>
     isearch-occur
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"h"</span>
     <span class="org-string">"highlight"</span>
     isearch-highlight-regexp
     <span class="org-builtin">:transient</span> nil)
    (<span class="org-string">"H"</span>
     <span class="org-string">"highlight lines"</span>
     isearch-highlight-lines-matching-regexp
     <span class="org-builtin">:transient</span> nil)]])

(define-key isearch-mode-map (kbd <span class="org-string">"M-S"</span>) 'cc/isearch-menu)
</pre>
</div>
</div>
</div>
<div id="outline-container-org4e222ce" class="outline-4">
<h4 id="org4e222ce">Search invisible text</h4>
<div class="outline-text-4" id="text-org4e222ce">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> isearch-invisible t
      search-invisible t)
</pre>
</div>
</div>
</div>
<div id="outline-container-org94033e9" class="outline-4">
<h4 id="org94033e9">Occur</h4>
<div class="outline-text-4" id="text-org94033e9">
<p>
From <a href="https://emacs.ch/@bram85/111724372485640053">https://emacs.ch/@bram85/111724372485640053</a>:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'occur
  (keymap-set occur-mode-map <span class="org-string">"C-x C-q"</span> #'occur-edit-mode))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-ediff" class="outline-3">
<h3 id="ediff">Ediff</h3>
<div class="outline-text-3" id="text-ediff">
<p>
<a href="http://yummymelon.com/devnull/surprise-and-emacs-defaults.html">http://yummymelon.com/devnull/surprise-and-emacs-defaults.html</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> ediff-split-window-function 'split-window-horizontally)
(<span class="org-keyword">setq</span> ediff-window-setup-function 'ediff-setup-windows-plain)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-ediff-last-windows</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-store-pre-ediff-winconfig</span> ()
<span class="org-doc">"Store `</span><span class="org-doc"><span class="org-constant">current-window-configuration</span></span><span class="org-doc">' in variable `</span><span class="org-doc"><span class="org-constant">my-ediff-last-windows</span></span><span class="org-doc">'."</span>
(<span class="org-keyword">setq</span> my-ediff-last-windows (current-window-configuration)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-restore-pre-ediff-winconfig</span> ()
<span class="org-doc">"Restore window configuration to stored value in `</span><span class="org-doc"><span class="org-constant">my-ediff-last-windows</span></span><span class="org-doc">'."</span>
(set-window-configuration my-ediff-last-windows))

(add-hook 'ediff-before-setup-hook #'my-store-pre-ediff-winconfig)
(add-hook 'ediff-quit-hook #'my-restore-pre-ediff-winconfig)
</pre>
</div>
</div>
</div>
<div id="outline-container-hideshow" class="outline-3">
<h3 id="hideshow">Hideshow</h3>
<div class="outline-text-3" id="text-hideshow">
<p>
From <a href="https://karthinks.com/software/simple-folding-with-hideshow/">https://karthinks.com/software/simple-folding-with-hideshow/</a> :
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> hideshow
  <span class="org-builtin">:hook</span>
  (prog-mode . hs-minor-mode)
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"C-&lt;tab&gt;"</span> . hs-cycle)
  (<span class="org-string">"C-&lt;iso-lefttab&gt;"</span> . hs-global-cycle)
  (<span class="org-string">"C-S-&lt;tab&gt;"</span> . hs-global-cycle))
(<span class="org-keyword">defun</span> <span class="org-function-name">hs-cycle</span> (<span class="org-type">&amp;optional</span> level)
  (<span class="org-keyword">interactive</span> <span class="org-string">"p"</span>)
  (<span class="org-keyword">let</span> (message-log-max
        (inhibit-message t))
    (<span class="org-keyword">if</span> (= level 1)
        (<span class="org-keyword">pcase</span> last-command
          ('hs-cycle
           (hs-hide-level 1)
           (<span class="org-keyword">setq</span> this-command 'hs-cycle-children))
          ('hs-cycle-children
           <span class="org-comment-delimiter">;; </span><span class="org-comment">TODO: Fix this case. `</span><span class="org-comment"><span class="org-constant">hs-show-block</span></span><span class="org-comment">' needs to be</span>
           <span class="org-comment-delimiter">;; </span><span class="org-comment">called twice to open all folds of the parent</span>
           <span class="org-comment-delimiter">;; </span><span class="org-comment">block.</span>
           (<span class="org-keyword">save-excursion</span> (hs-show-block))
           (hs-show-block)
           (<span class="org-keyword">setq</span> this-command 'hs-cycle-subtree))
          ('hs-cycle-subtree
           (hs-hide-block))
          (_
           (<span class="org-keyword">if</span> (not (hs-already-hidden-p))
               (hs-hide-block)
             (hs-hide-level 1)
             (<span class="org-keyword">setq</span> this-command 'hs-cycle-children))))
      (hs-hide-level level)
      (<span class="org-keyword">setq</span> this-command 'hs-hide-level))))

(<span class="org-keyword">defun</span> <span class="org-function-name">hs-global-cycle</span> ()
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">pcase</span> last-command
      ('hs-global-cycle
       (<span class="org-keyword">save-excursion</span> (hs-show-all))
       (<span class="org-keyword">setq</span> this-command 'hs-global-show))
      (_ (hs-hide-all))))
</pre>
</div>
</div>
</div>
<div id="outline-container-pop-to-mark" class="outline-3">
<h3 id="pop-to-mark">Pop to mark</h3>
<div class="outline-text-3" id="text-pop-to-mark">
<p>
Handy way of getting back to previous places.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x p"</span> 'pop-to-mark-command)
(<span class="org-keyword">setq</span> set-mark-command-repeat-pop t)
</pre>
</div>
</div>
</div>
<div id="outline-container-helm-swoop-quickly-finding-lines" class="outline-3">
<h3 id="helm-swoop-quickly-finding-lines">Helm-swoop - quickly finding lines</h3>
<div class="outline-text-3" id="text-helm-swoop-quickly-finding-lines">
<p>
This promises to be a fast way to find things. Let's bind it to <code>Ctrl-Shift-S</code> to see if I can get used to that&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> helm-swoop
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"C-S-s"</span> . helm-swoop)
   (<span class="org-string">"M-i"</span> . helm-swoop)
   (<span class="org-string">"M-s M-s"</span> . helm-swoop)
   (<span class="org-string">"M-I"</span> . helm-swoop-back-to-last-point)
   (<span class="org-string">"C-c M-i"</span> . helm-multi-swoop)
   (<span class="org-string">"C-x M-i"</span> . helm-multi-swoop-all)
   )
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (define-key isearch-mode-map (kbd <span class="org-string">"M-i"</span>) 'helm-swoop-from-isearch)
    (define-key helm-swoop-map (kbd <span class="org-string">"M-i"</span>) 'helm-multi-swoop-all-from-helm-swoop))
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-highlight-line-mode" class="outline-3">
<h3 id="highlight-line-mode">Highlight Line Mode</h3>
<div class="outline-text-3" id="text-highlight-line-mode">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(global-hl-line-mode 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-windmove-switching-between-windows" class="outline-3">
<h3 id="windmove-switching-between-windows">Windmove - switching between windows</h3>
<div class="outline-text-3" id="text-windmove-switching-between-windows">
<p>
Windmove lets you move between windows with something more natural than cycling through <code>C-x o</code> (<code>other-window</code>).
Windmove doesn't behave well with Org, so we need to use different keybindings.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> windmove
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"&lt;f2&gt; &lt;right&gt;"</span> . windmove-right)
   (<span class="org-string">"&lt;f2&gt; &lt;left&gt;"</span> . windmove-left)
   (<span class="org-string">"&lt;f2&gt; &lt;up&gt;"</span> . windmove-up)
   (<span class="org-string">"&lt;f2&gt; &lt;down&gt;"</span> . windmove-down)
   ))
</pre>
</div>
</div>
</div>
<div id="outline-container-frequently-accessed-files" class="outline-3">
<h3 id="frequently-accessed-files">Frequently-accessed files</h3>
<div class="outline-text-3" id="text-frequently-accessed-files">
<p>
Registers allow you to jump to a file or other location quickly. To
jump to a register, use <code>C-x r j</code> followed by the letter of the
register. Using registers for all these file shortcuts is probably a bit of a waste since I can easily define my own keymap, but since I rarely go beyond register A anyway. Also, I might as well add shortcuts for refiling.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> bookmark-watch-bookmark-file 'silent)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-refile-map</span> (make-sparse-keymap))
(<span class="org-keyword">require</span> '<span class="org-constant">bookmark</span>)
(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-defshortcut</span> (key file)
  `(<span class="org-keyword">progn</span>
     (set-register ,key (cons 'file ,file))
     (bookmark-store ,file (list (cons 'filename ,file)
                                 (cons 'position 1)
                                 (cons 'front-context-string <span class="org-string">""</span>)) <span class="org-warning">nil)</span>
     (define-key my-refile-map
       (char-to-string ,key)
       (<span class="org-keyword">lambda</span> (prefix)
         (<span class="org-keyword">interactive</span> <span class="org-string">"p"</span>)
         (<span class="org-keyword">let</span> ((org-refile-targets '(((,file) <span class="org-builtin">:maxlevel</span> . 6)))
               (current-prefix-arg (<span class="org-keyword">or</span> current-prefix-arg '(4))))
           (call-interactively 'org-refile))))))


(define-key my-refile-map <span class="org-string">","</span> 'my-org-refile-to-previous-in-file)

(<span class="org-keyword">defmacro</span> <span class="org-function-name">defshortcuts</span> (name body <span class="org-type">&amp;optional</span> docstring <span class="org-type">&amp;rest</span> heads)
  (<span class="org-keyword">declare</span> (indent defun) (doc-string 3))
  (<span class="org-keyword">cond</span> ((stringp docstring))
        (t
         (<span class="org-keyword">setq</span> heads (cons docstring heads))
         (<span class="org-keyword">setq</span> docstring <span class="org-string">""</span>)))
  (list
   'progn
   (append `(<span class="org-keyword">defhydra</span> ,name (<span class="org-builtin">:exit</span> t))
           (mapcar (<span class="org-keyword">lambda</span> (h)
                     (list (elt h 0) (list 'find-file (elt h 1)) (elt h 2)))
                   heads))
   (cons 'progn
         (mapcar (<span class="org-keyword">lambda</span> (h) (list 'my-defshortcut (string-to-char (elt h 0)) (elt h 1)))
                 heads))))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">defshortcuts+</span> (name body <span class="org-type">&amp;optional</span> docstring <span class="org-type">&amp;rest</span> heads)
  (<span class="org-keyword">declare</span> (indent defun) (doc-string 3))
  (<span class="org-keyword">cond</span> ((stringp docstring))
        (t
         (<span class="org-keyword">setq</span> heads (cons docstring heads))
         (<span class="org-keyword">setq</span> docstring <span class="org-string">""</span>)))
  (list
   'progn
   (append `(defhydra+ ,name (<span class="org-builtin">:exit</span> t))
           (mapcar (<span class="org-keyword">lambda</span> (h)
                     (list (elt h 0) (list 'find-file (elt h 1)) (elt h 2)))
                   heads))
   (cons 'progn
         (mapcar (<span class="org-keyword">lambda</span> (h) (list 'my-defshortcut (string-to-char (elt h 0)) (elt h 1)))
                 heads))))

(<span class="org-keyword">use-package</span> hydra
  <span class="org-builtin">:config</span>
  (defshortcuts my-file-shortcuts ()
    (<span class="org-string">"C"</span> <span class="org-string">"~/proj/emacs-calendar/README.org"</span> <span class="org-string">"Emacs calendar"</span>)
    (<span class="org-string">"e"</span> <span class="org-string">"~/sync/emacs/Sacha.org"</span> <span class="org-string">"Config"</span>)
    (<span class="org-string">"E"</span> <span class="org-string">"~/sync/emacs-news/index.org"</span> <span class="org-string">"Emacs News"</span>)
    (<span class="org-string">"f"</span> <span class="org-string">"~/proj/font/README.org"</span> <span class="org-string">"Font"</span>)
    (<span class="org-string">"I"</span> <span class="org-string">"~/sync/orgzly/computer-inbox.org"</span> <span class="org-string">"Computer inbox"</span>)
    (<span class="org-string">"i"</span> <span class="org-string">"~/sync/orgzly/Inbox.org"</span> <span class="org-string">"Phone inbox"</span>)
    (<span class="org-string">"o"</span> <span class="org-string">"~/sync/orgzly/organizer.org"</span> <span class="org-string">"Main org file"</span>)
    (<span class="org-string">"s"</span> <span class="org-string">"~/proj/stream/index.org"</span> <span class="org-string">"Yay Emacs"</span>)
    (<span class="org-string">"b"</span> <span class="org-string">"~/sync/orgzly/business.org"</span> <span class="org-string">"Business"</span>)
    (<span class="org-string">"P"</span> <span class="org-string">"/scp:web:/mnt/prev/home/sacha/planet/en.ini"</span> <span class="org-string">"Planet Emacsen"</span>)
    (<span class="org-string">"p"</span> <span class="org-string">"~/sync/orgzly/posts.org"</span> <span class="org-string">"Posts"</span>)
    (<span class="org-string">"n"</span> <span class="org-string">"/ssh:web|sudo::/etc/nginx/sites-available"</span> <span class="org-string">"Nginx sites"</span>)
    (<span class="org-string">"w"</span> <span class="org-string">"~/Dropbox/public/sharing/index.org"</span> <span class="org-string">"Sharing index"</span>)
    (<span class="org-string">"W"</span> <span class="org-string">"~/Dropbox/public/sharing/blog.org"</span> <span class="org-string">"Blog index"</span>)
    (<span class="org-string">"1"</span> <span class="org-string">"~/proj/static-blog/"</span> <span class="org-string">"Static blog"</span>)
    (<span class="org-string">"r"</span> <span class="org-string">"~/sync/orgzly/reference.org"</span> <span class="org-string">"Reference"</span>)
    (<span class="org-string">"R"</span> <span class="org-string">"~/personal/reviews.org"</span> <span class="org-string">"Reviews"</span>)
    (<span class="org-string">"g"</span> <span class="org-string">"~/proj/sachac.github.io/evil-plans/index.org"</span> <span class="org-string">"Evil plans"</span>))
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"C-c f"</span> . #'my-file-shortcuts/body))
</pre>
</div>
</div>
</div>
<div id="outline-container-smartscan" class="outline-3">
<h3 id="smartscan">Smartscan</h3>
<div class="outline-text-3" id="text-smartscan">
<p>
From <a href="https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el">https://github.com/itsjeyd/emacs-config/blob/emacs24/init.el</a>, this makes <code>M-n</code> and <code>M-p</code> look for the symbol at point.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> smartscan
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:config</span> (global-smartscan-mode t))
</pre>
</div>
</div>
</div>
<div id="outline-container-dired" class="outline-3">
<h3 id="dired">Dired</h3>
<div class="outline-text-3" id="text-dired">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> dired-listing-switches <span class="org-string">"-altr"</span>)
(<span class="org-keyword">setq</span> dired-dwim-target 'dired-dwim-target-next)
</pre>
</div>

<p>
From <a href="http://www.masteringemacs.org/articles/2011/03/25/working-multiple-files-dired/">http://www.masteringemacs.org/articles/2011/03/25/working-multiple-files-dired/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">find-dired</span>)
(<span class="org-keyword">setq</span> find-ls-option '(<span class="org-string">"-print0 | xargs -0 ls -ld"</span> . <span class="org-string">"-ld"</span>))
</pre>
</div>
</div>
<div id="outline-container-peep-dired" class="outline-4">
<h4 id="peep-dired">peep-dired</h4>
<div class="outline-text-4" id="text-peep-dired">
<p>
Allow my use of <code>C-x C-q</code> while in peep-dired mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> peep-dired
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> peep-dired-mode-map
              (<span class="org-string">"SPC"</span> . nil)
              (<span class="org-string">"&lt;backspace&gt;"</span> . nil)))
</pre>
</div>
</div>
</div>
<div id="outline-container-saving-photos" class="outline-4">
<h4 id="saving-photos">Saving photos</h4>
<div class="outline-text-4" id="text-saving-photos">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-save-photo</span> (name)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MName: "</span>)
  (<span class="org-keyword">let*</span> ((file (dired-get-filename))
         new-name)
    (<span class="org-keyword">cond</span>
     ((string-match <span class="org-string">"CameraZOOM-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> file)
      (<span class="org-keyword">setq</span> new-name
            (format <span class="org-string">"%s-%s-%s %s.%s.%s.%s %s.jpg"</span>
                    (match-string 1 file)
                    (match-string 2 file)
                    (match-string 3 file)
                    (match-string 4 file)
                    (match-string 5 file)
                    (match-string 6 file)
                    (match-string 7 file)
                    name)))
     ((string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[\\.-]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[\\.-]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[\\.- ]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> file)
      (<span class="org-keyword">setq</span> new-name
            (format <span class="org-string">"%s-%s-%s %s.%s.%s %s.jpg"</span>
                    (match-string 1 file)
                    (match-string 2 file)
                    (match-string 3 file)
                    (match-string 4 file)
                    (match-string 5 file)
                    (match-string 6 file)
                    name)))
     (t (<span class="org-keyword">setq</span> new-name (concat (file-name-sans-extension (file-name-nondirectory file)) <span class="org-string">" "</span> name <span class="org-string">".jpg"</span>))))
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"A-"</span> name)
      (copy-file file (expand-file-name new-name my-kid-photo-directory)))
    (rename-file file (expand-file-name new-name <span class="org-string">"~/archives/2016/photos/selected/"</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-backup-media</span> ()
  (<span class="org-keyword">interactive</span>)
  (mapcar (<span class="org-keyword">lambda</span> (file)
            (rename-file
             file
             (expand-file-name
              (file-name-nondirectory file)
              (<span class="org-keyword">cond</span>
               ((string-match <span class="org-string">"mp4"</span> file) <span class="org-string">"~/archives/2016/videos/"</span>)
               ((string-match <span class="org-string">"mp3</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">wav"</span> file) <span class="org-string">"~/archives/2016/audio/"</span>)
               (t <span class="org-string">"~/archives/2016/photos/backup/"</span>)))))
          (dired-get-marked-files)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"b"</span> 'my-save-photo dired-mode-map)
(<span class="org-keyword">bind-key</span> <span class="org-string">"r"</span> 'my-backup-media dired-mode-map)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-move-to-beginning-of-line" class="outline-3">
<h3 id="move-to-beginning-of-line">Move to beginning of line</h3>
<div class="outline-text-3" id="text-move-to-beginning-of-line">
<p>
Copied from <a href="http://emacsredux.com/blog/2013/05/22/smarter-navigation-to-the-beginning-of-a-line/">http://emacsredux.com/blog/2013/05/22/smarter-navigation-to-the-beginning-of-a-line/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-smarter-move-beginning-of-line</span> (arg)
  <span class="org-doc">"Move point back to indentation of beginning of line.</span>

<span class="org-doc">      Move point to the first non-whitespace character on this line.</span>
<span class="org-doc">      If point is already there, move to the beginning of the line.</span>
<span class="org-doc">      Effectively toggle between the first non-whitespace character and</span>
<span class="org-doc">      the beginning of the line.</span>

<span class="org-doc">      If ARG is not nil or 1, move forward ARG - 1 lines first.  If</span>
<span class="org-doc">      point reaches the beginning or end of the buffer, stop there."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"^p"</span>)
  (<span class="org-keyword">setq</span> arg (<span class="org-keyword">or</span> arg 1))

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Move lines first</span>
  (<span class="org-keyword">when</span> (/= arg 1)
    (<span class="org-keyword">let</span> ((line-move-visual nil))
      (forward-line (1- arg))))

  (<span class="org-keyword">let</span> ((orig-point (point)))
    (back-to-indentation)
    (<span class="org-keyword">when</span> (= orig-point (point))
      (move-beginning-of-line 1))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">remap C-a to `</span><span class="org-comment"><span class="org-constant">smarter-move-beginning-of-line</span></span><span class="org-comment">'</span>
(global-set-key [remap move-beginning-of-line]
                'my-smarter-move-beginning-of-line)
</pre>
</div>
</div>
</div>
<div id="outline-container-recent-files" class="outline-3">
<h3 id="recent-files">Recent files</h3>
<div class="outline-text-3" id="text-recent-files">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">recentf</span>)
(<span class="org-keyword">setq</span> recentf-max-saved-items 200
      recentf-max-menu-items 15)
(recentf-mode)
</pre>
</div>
</div>
</div>
<div id="outline-container-copy-filename-to-clipboard" class="outline-3">
<h3 id="copy-filename-to-clipboard">Copy filename to clipboard</h3>
<div class="outline-text-3" id="text-copy-filename-to-clipboard">
<p>
<a href="http://emacsredux.com/blog/2013/03/27/copy-filename-to-the-clipboard/">http://emacsredux.com/blog/2013/03/27/copy-filename-to-the-clipboard/</a>
<a href="https://github.com/bbatsov/prelude">https://github.com/bbatsov/prelude</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">prelude-copy-file-name-to-clipboard</span> ()
  <span class="org-doc">"Copy the current buffer file name to the clipboard."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((filename (<span class="org-keyword">if</span> (equal major-mode 'dired-mode)
                      default-directory
                    (buffer-file-name))))
    (<span class="org-keyword">when</span> filename
      (kill-new filename)
      (message <span class="org-string">"Copied buffer file name '</span><span class="org-string"><span class="org-constant">%s</span></span><span class="org-string">' to the clipboard."</span> filename))))
</pre>
</div>
</div>
</div>
<div id="outline-container-open-files-externally" class="outline-3">
<h3 id="open-files-externally">Open files externally</h3>
<div class="outline-text-3" id="text-open-files-externally">
<p>
Copied from Prelude: <a href="http://emacsredux.com/blog/2013/03/27/open-file-in-external-program/">http://emacsredux.com/blog/2013/03/27/open-file-in-external-program/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">prelude-open-with</span> (arg)
  <span class="org-doc">"Open visited file in default external program.</span>

<span class="org-doc">      With a prefix ARG always prompt for command to use."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">when</span> buffer-file-name
    (shell-command (concat
                    (<span class="org-keyword">cond</span>
                     ((<span class="org-keyword">and</span> (not arg) (eq system-type 'darwin)) <span class="org-string">"open"</span>)
                     ((<span class="org-keyword">and</span> (not arg) (member system-type '(gnu gnu/linux gnu/kfreebsd))) <span class="org-string">"xdg-open"</span>)
                     (t (read-shell-command <span class="org-string">"Open current file with: "</span>)))
                    <span class="org-string">" "</span>
                    (shell-quote-argument buffer-file-name)))))

</pre>
</div>

<p>
Don't use docview for PDFs.
(add-to-list 'org-file-apps '("pdf" . "evince %s"))
</p>
</div>
</div>
<div id="outline-container-toggle" class="outline-3">
<h3 id="toggle">Toggle</h3>
<div class="outline-text-3" id="text-toggle">
<p>
Based on <a href="https://www.reddit.com/r/emacs/comments/l4v1ux/one_of_the_most_useful_small_lisp_functions_in_my-">https://www.reddit.com/r/emacs/comments/l4v1ux/one_of_the_most_useful_small_lisp_functions_in_my-</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-toggle-or-create</span> (buffer-name buffer-create-fn <span class="org-type">&amp;optional</span> switch-cont)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((target-buf (get-buffer buffer-name)))
    (prin1 target-buf)
    (<span class="org-keyword">cond</span>
     ((equal (current-buffer) target-buf) (switch-to-buffer nil))
     (target-buf
      (switch-to-buffer target-buf)
      (<span class="org-keyword">if</span> switch-cont (funcall switch-cont)))
     (t (funcall buffer-create-fn)
        (<span class="org-keyword">if</span> switch-cont (funcall switch-cont))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-link-hint" class="outline-3">
<h3 id="link-hint">link-hint</h3>
<div class="outline-text-3" id="text-link-hint">
<p>
This should make it easier to jump to a link.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> link-hint
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"M-g u"</span> . link-hint-open-link)
  (<span class="org-string">"M-g U"</span> . link-hint-open-multiple-links))
</pre>
</div>
</div>
</div>
<div id="outline-container-bookmarks" class="outline-3">
<h3 id="bookmarks">Bookmarks</h3>
<div class="outline-text-3" id="text-bookmarks">
<p>
<a href="http://yummymelon.com/devnull/using-bookmarks-in-emacs-like-you-do-in-web-browsers.html">http://yummymelon.com/devnull/using-bookmarks-in-emacs-like-you-do-in-web-browsers.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">easy-menu-define</span> cc/bookmarks-menu nil
  <span class="org-doc">"Keymap for CC Bookmarks Menu"</span>
  '(<span class="org-string">"Bookmarks"</span>
    [<span class="org-string">"Edit Bookmarks"</span> list-bookmarks
     <span class="org-builtin">:help</span> <span class="org-string">"Display a list of existing bookmarks."</span>]
    [<span class="org-string">"--"</span> nil]
    [<span class="org-string">"Add Bookmark&#8230;"</span> bookmark-set-no-overwrite
     <span class="org-builtin">:help</span> <span class="org-string">"Set a bookmark named NAME at the current location."</span>]
    [<span class="org-string">"---"</span> nil]
    [<span class="org-string">"Jump to Bookmark&#8230;"</span> bookmark-jump
     <span class="org-builtin">:help</span> <span class="org-string">"Jump to bookmark"</span>]))
(easy-menu-add-item global-map '(menu-bar)
                    cc/bookmarks-menu
                    <span class="org-string">"Tools"</span>)
(defhydra+ my-shortcuts (<span class="org-builtin">:exit</span> t)
  (<span class="org-string">"b"</span> bookmark-jump <span class="org-string">"Jump to bookmark"</span>)
  (<span class="org-string">"B"</span> bookmark-set-no-overwrite <span class="org-string">"Set bookmark"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-dogears" class="outline-3">
<h3 id="dogears">Dogears</h3>
<div class="outline-text-3" id="text-dogears">
<p>
<a href="https://github.com/alphapapa/dogears.el">https://github.com/alphapapa/dogears.el</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">    <span class="org-comment-delimiter">;; </span><span class="org-comment">Install and load `</span><span class="org-comment"><span class="org-constant">quelpa-use-package</span></span><span class="org-comment">'.</span>
(<span class="org-keyword">use-package</span> dogears
  <span class="org-comment-delimiter">;; </span><span class="org-comment">:quelpa (dogears :fetcher github :repo "alphapapa/dogears.el")</span>

  <span class="org-comment-delimiter">;; </span><span class="org-comment">These bindings are optional, of course:</span>
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> global-map
              (<span class="org-string">"M-g d"</span> . dogears-go)
              (<span class="org-string">"M-g M-b"</span> . dogears-back)
              (<span class="org-string">"M-g M-f"</span> . dogears-forward)
              (<span class="org-string">"M-g M-d"</span> . dogears-list)
              (<span class="org-string">"M-g M-D"</span> . dogears-sidebar)))
</pre>
</div>
</div>
</div>
<div id="outline-container-random" class="outline-3">
<h3 id="random">Randomness for serendipity</h3>
<div class="outline-text-3" id="text-random">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-goto-random-char</span> ()
  (<span class="org-keyword">interactive</span>)
  (goto-char (random (point-max))))
</pre>
</div>
</div>
<div id="outline-container-building-a-today-i-learned-habit-and-displaying-the-documentation-for-random-emacs-commands" class="outline-4">
<h4 id="building-a-today-i-learned-habit-and-displaying-the-documentation-for-random-emacs-commands">Building a today-I-learned habit, and displaying the documentation for random Emacs commands&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-building-a-today-i-learned-habit-and-displaying-the-documentation-for-random-emacs-commands">
<p>
I'd like to build a habit of regularly learning one small thing each
day in one of three domains: tech, life, and learning. My measurable
output would probably be in the form of index cards, tweets, blog
posts, and notes (in org-capture, Dropbox, or Evernote). I can get
input from various sources like blog posts, videos, books, webpages,
and so on.
</p>

<p>
A little bit of randomness might be useful for learning more about
Emacs. Emacswiki has a <a href="http://www.emacswiki.org/emacs?action=random">random page</a> function, but the chunks are often
a little large or irrelevant. On the other hand, displaying a random
command from the packages that I already have loaded into my Emacs -
that might be a good way to discover interesting things.
</p>

<p>
I started by looking at <code>apropos-command</code>, which led me to
<code>apropos-internal</code>, which is a C function that referred to <code>obarray</code>.
Using <code>obarray</code> by itself didn't work (suspiciously few elements, so I
often ended up looking at emms-related functions). I eventually found
<a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Creating-Symbols.html">mapatoms</a>, which seems to do a better job at listing an appreciable
number of interactive functions. I filtered the list to include only
documented functions that had not been marked as obsolete: 8,415 in
my current Emacs, which should be plenty to go through. =)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-describe-random-interactive-function</span> ()
  (<span class="org-keyword">interactive</span>)
  <span class="org-string">"Show the documentation for a random interactive function.</span>
<span class="org-string">     Consider only documented, non-obsolete functions."</span>
  (<span class="org-keyword">let</span> (result)
    (mapatoms
     (<span class="org-keyword">lambda</span> (s)
       (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (commandp s)
                  (documentation s t)
                  (null (get s 'byte-obsolete-info)))
         (<span class="org-keyword">setq</span> result (cons s result)))))
    (describe-function (elt result (random (length result))))))
</pre>
</div>

<p>
I've added this to a <a href="https://www.emacswiki.org/emacs/KeyChord">key-chord</a> + <a href="https://github.com/abo-abo/hydra">hydra</a> keymap as a repeatable
function, so I can type <code>hh</code> to start my Hydra and then type <code>r</code> as
many times as I want in order to show the documentation for a random
interactive function. If you're curious about that, you can see the
<a href="http://sachachua.com/dotemacs#key-chord">key-chord section of my config</a>.
</p>

<p>
Anyway, today I learned more about <code>obarray</code> and <code>mapatoms</code> - they're
not interactive functions, but they were handy for building this
little bit of code. We'll see how it goes! =)
</p>
</div>
</div>
<div id="outline-container-shuffling-lines" class="outline-4">
<h4 id="shuffling-lines">Shuffling lines</h4>
<div class="outline-text-4" id="text-shuffling-lines">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-shuffle-lines-in-region</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((list (split-string (buffer-substring beg end) <span class="org-string">"[\r\n]+"</span>)))
    (delete-region beg end)
    (insert (string-join (seq-sort-by (<span class="org-keyword">lambda</span> (_) (random)) #'&lt;= list) <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-network-tramp-and-editing-files-over-ssh" class="outline-3">
<h3 id="network-tramp-and-editing-files-over-ssh">Network: TRAMP and editing files over SSH</h3>
<div class="outline-text-3" id="text-network-tramp-and-editing-files-over-ssh">
<p>
Emacs lets you edit files on remote servers, which is pretty darn
cool. On Windows, these things help a little.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">when</span> (eq system-type 'windows-nt)
  (<span class="org-keyword">setq</span> tramp-default-method <span class="org-string">"plink"</span>)
  (<span class="org-keyword">setq</span> tramp-auto-save-directory <span class="org-string">"c:\\sacha\\tmp"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-touch" class="outline-3">
<h3 id="touch">Touch gestures</h3>
<div class="outline-text-3" id="text-touch">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-02-01 Thu]</span></span>
From <a href="https://kitchingroup.cheme.cmu.edu/blog/2014/08/31/Using-Mac-gestures-in-Emacs/">https://kitchingroup.cheme.cmu.edu/blog/2014/08/31/Using-Mac-gestures-in-Emacs/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">*my-previous-buffer*</span> t
  <span class="org-doc">"can we switch?"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-previous-buffer</span> ()
  (<span class="org-keyword">interactive</span>)
  (message <span class="org-string">"custom prev: *my-previous-buffer*=%s"</span> *my-previous-buffer*)
  (<span class="org-keyword">when</span> *my-previous-buffer*
    (previous-buffer)
    (<span class="org-keyword">setq</span> *my-previous-buffer* nil)
    (run-at-time <span class="org-string">"1 sec"</span> nil (<span class="org-keyword">lambda</span> ()
                               (<span class="org-keyword">setq</span> *my-previous-buffer* t)))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">*my-next-buffer*</span> t
  <span class="org-doc">"can we switch?"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-next-buffer</span> ()
  (<span class="org-keyword">interactive</span>)
  (message <span class="org-string">"custom prev: *my-next-buffer*=%s"</span> *my-next-buffer*)
  (<span class="org-keyword">when</span> *my-next-buffer*
    (next-buffer)
    (<span class="org-keyword">setq</span> *my-next-buffer* nil)
    (run-at-time <span class="org-string">"1 sec"</span> nil (<span class="org-keyword">lambda</span> ()
                               (<span class="org-keyword">setq</span> *my-next-buffer* t)))))

(keymap-global-set <span class="org-string">"&lt;triple-wheel-right&gt;"</span> 'my-previous-buffer)
(keymap-global-set <span class="org-string">"&lt;triple-wheel-left&gt;"</span> 'my-next-buffer)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-reading" class="outline-2">
<h2 id="reading">Reading</h2>
<div class="outline-text-2" id="text-reading">
<p>
<a href="https://github.com/xahlee/xah_emacs_init/blob/master/xah_emacs_font.el">https://github.com/xahlee/xah_emacs_init/blob/master/xah_emacs_font.el</a>
From Xah Lee:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">xah-toggle-margin-right</span> ()
  <span class="org-doc">"Toggle the right margin between `</span><span class="org-doc"><span class="org-constant">fill-column</span></span><span class="org-doc">' or window width.</span>
<span class="org-doc">     This command is convenient when reading novel, documentation."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (eq (cdr (window-margins)) nil)
      (set-window-margins nil 0 (- (window-body-width) fill-column))
    (set-window-margins nil 0 0)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> pdf-tools
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (pdf-tools-install)
  (<span class="org-keyword">setq</span> pdf-view-resize-factor 1.1)
  (<span class="org-keyword">setq-default</span> pdf-view-display-size 'fit-page)
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-writing-and-editing" class="outline-2">
<h2 id="writing-and-editing">Writing and editing</h2>
<div class="outline-text-2" id="text-writing-and-editing">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(keymap-global-set <span class="org-string">"M-c"</span> #'capitalize-dwim)
(<span class="org-keyword">setq-default</span> fill-column 50)
</pre>
</div>
</div>
<div id="outline-container-gif-screencast" class="outline-3">
<h3 id="gif-screencast">gif-screencast</h3>
<div class="outline-text-3" id="text-gif-screencast">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> gif-screencast
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"s-s"</span> . gif-screencast-start-or-stop)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> gif-screencast-output-directory my-recordings-dir))

(<span class="org-keyword">use-package</span> giffy
  <span class="org-builtin">:quelpa</span> (giffy <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"larsmagne/giffy"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-giffy-open-gif</span> (file)
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"GIF: "</span>)))
  (<span class="org-keyword">let</span> ((directory (make-temp-file (concat <span class="org-string">"giffy-"</span> (file-name-base file)) t)))
  <span class="org-comment-delimiter">;;</span><span class="org-comment">TODO</span>
    )
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-sentences-end-with-a-single-space" class="outline-3">
<h3 id="sentences-end-with-a-single-space">Sentences end with a single space</h3>
<div class="outline-text-3" id="text-sentences-end-with-a-single-space">
<p>
In my world, sentences end with a single space. This makes
sentence navigation commands work for me.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> sentence-end-double-space nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-writeroom" class="outline-3">
<h3 id="writeroom">Writeroom</h3>
<div class="outline-text-3" id="text-writeroom">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> writeroom-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> writeroom-global-effects (remove 'writeroom-set-fullscreen
                                         writeroom-global-effects)))
</pre>
</div>
</div>
</div>
<div id="outline-container-try-redacting" class="outline-3">
<h3 id="try-redacting">Try redacting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="config">config</span></span></h3>
<div class="outline-text-3" id="text-try-redacting">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact</span> (s)
  <span class="org-doc">"Replace S with x characters."</span>
  (make-string (length s) ?x))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-region</span> (beg end <span class="org-type">&amp;optional</span> func)
  <span class="org-doc">"Redact from BEG to END."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((overlay (make-overlay beg end)))
    (overlay-put overlay 'redact t)
    (overlay-put overlay 'display
                 (<span class="org-keyword">cond</span>
                  ((functionp func)
                   (funcall func))
                  ((stringp func)
                   func)
                  (t (make-string (- end beg) ?x))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-regexp-replacement</span> (regexp replacement <span class="org-type">&amp;optional</span> beg end)
  <span class="org-doc">"Redact buffer content matching regexp."</span>
  (<span class="org-keyword">interactive</span> (list (read-regexp <span class="org-string">"Redact regexp: "</span> 'regexp-history-last)
                     (read-string <span class="org-string">"Replacement (ex: \\1 \\,(my-redact \\2)): "</span>)))
  (<span class="org-keyword">setq</span> beg (<span class="org-keyword">or</span> beg (point-min)))
  (<span class="org-keyword">setq</span> end (<span class="org-keyword">or</span> end (point-max)))
  (<span class="org-keyword">when</span> (stringp replacement)
    (<span class="org-keyword">setq</span> replacement (query-replace-compile-replacement replacement t)))
  (<span class="org-keyword">save-excursion</span>
    (goto-char beg)
    (<span class="org-keyword">while</span> (re-search-forward regexp end t)
      (my-redact-region
       (match-beginning 0) (match-end 0)
       (<span class="org-keyword">with-temp-buffer</span>
         (insert (match-string 0))
         (goto-char (point-min))

         )
       (replace-regexp-in-string regexp replacement (match-string 0))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-regexp</span> (regexp <span class="org-type">&amp;optional</span> beg end func)
  <span class="org-doc">"Redact buffer content matching regexp."</span>
  (<span class="org-keyword">interactive</span> (list (string-trim (read-regexp <span class="org-string">"Redact regexp: "</span> 'regexp-history-last))))
  (<span class="org-keyword">save-excursion</span>
    (goto-char (<span class="org-keyword">or</span> beg (point-min)))
    (<span class="org-keyword">while</span> (re-search-forward regexp (<span class="org-keyword">or</span> end (point-max)) t)
      (my-redact-region (match-beginning 0) (match-end 0) func))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-unredact</span> ()
  (<span class="org-keyword">interactive</span>)
  (mapc 'delete-overlay
        (seq-filter (<span class="org-keyword">lambda</span> (overlay) (overlay-get overlay 'redact))
                    (overlays-in (point-min) (point-max)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-email-string</span> (s)
  (replace-regexp-in-string
   <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[-+_~a-zA-Z0-9][-+_.~:a-zA-Z0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">@</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[-a-zA-Z0-9]+[-.a-zA-Z0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
   (<span class="org-keyword">lambda</span> (sub)
     (concat
      (make-string (length (match-string 1 sub)) ?x)
      <span class="org-string">"@"</span>
      (make-string (length (match-string 2 sub)) ?x)))
   s))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-emails</span> (<span class="org-type">&amp;rest</span> _)
  (<span class="org-keyword">interactive</span>)
  (my-redact-regexp
   <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[-+_~a-zA-Z0-9][-+_.~:a-zA-Z0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">@</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[-a-zA-Z0-9]+[-.a-zA-Z0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
   nil nil
   (<span class="org-keyword">lambda</span> () (my-redact-email-string (match-string 0)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-emacsconf-org</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-redact-regexp-replacement
   <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">^:EMAIL:[ \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
   <span class="org-string">"\\1 \\,(my-redact \\2)"</span>
   ))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-tabulated-list-in-rectangle</span> (regexp beg end)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">tabulated columns use substrings with display properties</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">so we should skip any characters that have text-property-any 'display</span>
  (<span class="org-keyword">interactive</span> (list (read-regexp <span class="org-string">"Redact regexp: "</span> 'regexp-history-last)
                     (min (point) (mark))
                     (max (point) (mark))))
  (apply-on-rectangle
   (<span class="org-keyword">lambda</span> (start-col end-col)
     (<span class="org-keyword">let</span> ((start-pos (<span class="org-keyword">and</span> (move-to-column start-col) (point)))
           (end-pos (<span class="org-keyword">and</span> (move-to-column end-col) (point)))
           display-prop)
       (<span class="org-keyword">save-restriction</span>
         (narrow-to-region start-pos end-pos)
         (goto-char start-pos)
         (<span class="org-keyword">setq</span> display-prop (text-property-search-forward 'display))
         (<span class="org-keyword">if</span> display-prop
             (<span class="org-keyword">while</span> display-prop
               (my-redact-regexp regexp start-pos (prop-match-beginning display-prop))
               (<span class="org-keyword">setq</span> start-pos (prop-match-end display-prop))
               (<span class="org-keyword">setq</span> display-prop (text-property-search-forward 'display)))
           (my-redact-regexp regexp start-pos end-pos)))))
   beg end))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-redact-regexp-in-rectangle</span> (regexp beg end)
  (<span class="org-keyword">interactive</span> (list (read-regexp <span class="org-string">"Redact regexp: "</span> 'regexp-history-last)
                     (min (point) (mark))
                     (max (point) (mark))))
  (apply-on-rectangle (<span class="org-keyword">lambda</span> (start-col end-col)
                        (my-redact-regexp regexp
                                          (<span class="org-keyword">and</span> (move-to-column start-col) (point))
                                          (<span class="org-keyword">and</span> (move-to-column end-col) (point))))
                      beg end))

(advice-add
 #'notmuch-show
 <span class="org-builtin">:after</span> #'my-redact-emails)
</pre>
</div>
</div>
</div>
<div id="outline-container-transcript-keywords" class="outline-3">
<h3 id="transcript-keywords"><span class="done DONE">DONE</span> Audio braindump workflow tweaks: Adding Org Mode hyperlinks to recordings based on keywords</h3>
<div class="outline-text-3" id="text-transcript-keywords">
<div class="update" id="org05f34d8">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2023-12-24 Sun] </span></span> Added a quick video!
</p>

</div>

<p>

</p>

<div class="my_details" id="orgf272928">
<p>

</p>

</div>

<p>
Audio recording is handy for capturing thoughts as I wait, walk around, or do chores. But my wireless earbuds don't have a good mic, I rarely got back to reviewing the wall of text, and I don't trust speech recognition to catch all my words.
</p>

<p>
Here's a new brain-dumping workflow that I've been experimenting with, though. I use a lapel mic to record in my phone. Google Recorder gives me an audio file as well as a rough transcript right away.
</p>

<div class="my_details" id="org218b943">

<figure id="orgbde0d81">
<img src="images/braindump-recording.gif" alt="braindump-recording.gif" style="max-height:80vh">

</figure>

</div>

<p>
I copy those with Syncthing.
</p>

<p>
If I use keywords like "start" or "stop" along with things like "topic", "reminder", or "summary", then I can put those on separate lines automatically (<code>my-audio-braindump-prepare-alignment-breaks</code>).
</p>

<pre class="example" id="org03dbe6b">
...
News. Miscellaneous little tasks that he doing. I do want to
finish that blog post about the playlist Just so that it's out.
Something else that people can, you know, refer to or that I can refer
to. Uh, And at some point I want to think about, This second brain
stuff.
So, right now, What's my current state? Uh,
START CHAPTER second brain STOP CHAPTER
Right now, I dumped everything into originally. In my inbox, if I come
across an interesting website. As usually in my phone. So then I share
it. As. Something links at those or four none. Uh, into my inbox.
...
</pre>

<p>
I use <code>subed-align</code> to get the timestamps, and add the headings.
</p>

<div class="org-src-container">
<pre class="src src-subed-vtt">00:20:18.680 --&gt; 00:20:24.679
So, right now, What's my current state? Uh,

NOTE CHAPTER: second brain

00:20:24.680 --&gt; 00:20:30.719
START CHAPTER second brain STOP CHAPTER
</pre>
</div>

<p>
I can then create an Org Mode TODO item with a quick hyperlinked summary as well as my transcript.
</p>


<figure id="org3318b37">
<img src="images/braindump-summary.svg" alt="braindump-summary.svg" class="org-svg" style="max-height:80vh">

<figcaption><span class="figure-number">Figure 6: </span>Summary with headings and links</figcaption>
</figure>

<p>
I can jump to the audio if there are misrecognized words.
</p>

<div class="my_details" id="org2e4bacd">

<figure id="orgd2f5bca">
<img src="images/braindump-vtt.png" alt="braindump-vtt.png" style="max-height:80vh">

<figcaption><span class="figure-number">Figure 7: </span>Following the link to the chapter in the VTT file</figcaption>
</figure>

</div>

<p>
I can use subed-waveform to tweak the start and end times. (<code>subed-waveform-show-current</code>, then left-clicking to set the start or right-clicking to set the end, or using keybindings to adjust the start/stop).
</p>

<p>
Someday I'll write code to send sections to a better speech
recognition engine or to AI. In the meantime, this is pretty good.
</p>

<p>
Here's how the code works:
</p>
</div>
<div id="outline-container-recognizing-keyword-phrases" class="outline-4">
<h4 id="recognizing-keyword-phrases">Recognizing keyword phrases</h4>
<div class="outline-text-4" id="text-recognizing-keyword-phrases">
<p>
There are several things I want to do while dictating.
</p>

<ul class="org-ul">
<li>I want to mark different topics so that it's easy to find the section where I was talking about something.</li>
<li>I might want to set tags or priorities, or even schedule something (today, tomorrow, next week, next month).</li>
<li>I can also use commands to trigger different things, like sending the section to a better speech recognition engine.</li>
</ul>

<p>
By analyzing the text, I might be able to make my own command system.
</p>

<p>
So far, for starting keywords, I can use "start", "begin", or "open".
I pair that with one of these part keywords:
</p>

<ul class="org-ul">
<li>"section", "chapter", "topic", "summary": I use these pretty interchangeably at the moment. I want them to make a new Org heading.</li>
<li>"next steps": could be handy for being able to quickly see what to do next</li>
<li>"reminder":</li>
<li>"interruption": don't know what I'll use this for yet, but it might be useful to note this.</li>
<li>"tag", "keyword": maybe use this to add tags to the current section?</li>
</ul>

<p>
Then the code can extract the text until the matching "stop/close/end
&lt;part&gt;", assuming it happens within 50 words or so.
(<code>my-audio-braindump-close-keyword-distance-words</code>)
</p>

<p>
Sometimes keywords get misrecognized. "Begin summary" sometimes
becomes "again summary" or "the game summary". I could try "open" and
"close". Commercial dictation programs like Dragon NaturallySpeaking
use "open" and "close" for punctuation, so that would probably work
fine. "Start" works well, but "end" doesn't because it can confused
with "and".
</p>

<p>
Sometimes an extra word sneaks in, either because I say it or because
the speech recognition tries too hard to guess. "Begin reminder" ends
up as "Begin a reminder." I changed from using regular expressions
that searched for just start-keyword + part-keyword to one that looked
for the start of the keyword phrase and then looked for the next
keyword within the next X words. (<code>my-audio-braindump-scan-for-part-keyword</code>)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-audio-braindump-open-keywords</span> '(<span class="org-string">"start"</span> <span class="org-string">"begin"</span> <span class="org-string">"open"</span>))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-audio-braindump-close-keywords</span> '(<span class="org-string">"stop"</span> <span class="org-string">"end"</span> <span class="org-string">"close"</span>))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-audio-braindump-part-keywords</span> '(<span class="org-string">"summary"</span> <span class="org-string">"chapter"</span> <span class="org-string">"topic"</span>
                                      <span class="org-string">"section"</span>
                                 <span class="org-string">"action"</span> <span class="org-string">"idea"</span> <span class="org-string">"journal"</span> <span class="org-string">"reminder"</span>
                                 <span class="org-string">"command"</span> <span class="org-string">"interruption"</span> <span class="org-string">"note"</span>
                                 <span class="org-string">"next step"</span> <span class="org-string">"next steps"</span> <span class="org-string">"tags"</span> <span class="org-string">"tag"</span> <span class="org-string">"keywords"</span> <span class="org-string">"keyword"</span>))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-audio-braindump-part-keyword-distance-words</span> 2 <span class="org-doc">"Number of words to scan for part keyword."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-audio-braindump-close-keyword-distance-words</span> 50 <span class="org-doc">"number of words to scan for stop keyword.</span>
<span class="org-doc">Put the keywords on the same line if found."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-scan-for-part-keyword</span> (before-part <span class="org-type">&amp;optional</span> part-keywords within-distance before-distance)
  <span class="org-doc">"Look for BEFORE-PART followed by PART-KEYWORDS.</span>
<span class="org-doc">There might be WITHIN-DISTANCE words between BEFORE-PART and PART-KEYWORDS,</span>
<span class="org-doc">and the pair might be within BEFORE-DISTANCE from point.</span>
<span class="org-doc">Distances are in words.</span>
<span class="org-doc">Return (start end before-part part) if found, nil otherwise."</span>
  (<span class="org-keyword">setq</span> before-part (<span class="org-keyword">pcase</span> before-part
                      ('start my-audio-braindump-open-keywords)
                      ('stop my-audio-braindump-close-keywords)
                      ('nil (append my-audio-braindump-open-keywords my-audio-braindump-close-keywords))
                      (_ before-part)))
  (<span class="org-keyword">setq</span> part-keywords (<span class="org-keyword">or</span> part-keywords my-audio-braindump-part-keywords))
  (<span class="org-keyword">when</span> (stringp part-keywords) (<span class="org-keyword">setq</span> part-keywords (list part-keywords)))
  (<span class="org-keyword">setq</span> within-distance (<span class="org-keyword">or</span> within-distance my-audio-braindump-part-keyword-distance-words))
  (<span class="org-keyword">setq</span> before-distance (<span class="org-keyword">if</span> (eq before-distance t)
                            (point-max)
                          (<span class="org-keyword">or</span> before-distance my-audio-braindump-close-keyword-distance-words)))
  (<span class="org-keyword">let</span> (result
        start end
        (before-point (<span class="org-keyword">save-excursion</span> (forward-word before-distance) (point)))
        before-word
        part-word)
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">when</span> (looking-at (regexp-opt before-part))
        (<span class="org-keyword">setq</span> before-word (match-string 0) start (match-beginning 0))
        (<span class="org-keyword">when</span> (re-search-forward (regexp-opt part-keywords) (<span class="org-keyword">save-excursion</span> (forward-word within-distance) (point)) t)
          (<span class="org-keyword">setq</span> result (list start (match-end 0) before-word (match-string 0)))))
      (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not result)
                  (re-search-forward (regexp-opt before-part) before-point t))
        (<span class="org-keyword">setq</span> before-word (match-string 0) start (match-beginning 0))
        (<span class="org-keyword">when</span> (re-search-forward (regexp-opt part-keywords) (<span class="org-keyword">save-excursion</span> (forward-word within-distance) (point)) t)
          (<span class="org-keyword">setq</span> result (list start (match-end 0) before-word (match-string 0)))))
      (<span class="org-keyword">when</span> result (goto-char (elt result 1)))
      result)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-audio-braindump-scan-for-part-keyword</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"some text start a reminder hello world stop there and do something stop reminder more text"</span>)
    (goto-char (point-min))
    (<span class="org-keyword">let</span> ((result (my-audio-braindump-scan-for-part-keyword 'start nil)))
      (expect (elt result 2) <span class="org-builtin">:to-equal</span> <span class="org-string">"start"</span>)
      (expect (elt result 3) <span class="org-builtin">:to-equal</span> <span class="org-string">"reminder"</span>))
    (<span class="org-keyword">let</span> ((result (my-audio-braindump-scan-for-part-keyword 'stop <span class="org-string">"reminder"</span>)))
      (expect (elt result 2) <span class="org-builtin">:to-equal</span> <span class="org-string">"stop"</span>)
      (expect (elt result 3) <span class="org-builtin">:to-equal</span> <span class="org-string">"reminder"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-splitting-the-lines-based-on-keywords-and-oopses" class="outline-4">
<h4 id="splitting-the-lines-based-on-keywords-and-oopses">Splitting the lines based on keywords and oopses</h4>
<div class="outline-text-4" id="text-splitting-the-lines-based-on-keywords-and-oopses">
<p>
Now I can use that to scan through the text. I want to put commands on
their own lines so that <code>subed-align</code> will get the timestamp for that
segment and so that the commands are easier to parse.
</p>

<p>
I also want to detect "oops" and split things up so that the start of
that line matches my correction after the "oops". I use
<a href="https://sachachua.com/dotemacs/index.html#split-up-oops-better">my-subed-split-oops</a> for that, which I should write about in another
post. By putting the oops fragment on its own line, I can use
<code>subed-align</code> to get a timestamp for just that segment. Then I can
either use <code>flush-lines</code> to get rid of anything with "oops" in it. I
can even remove the subtitle and use <code>subed-record-compile-media</code> to
compile audio/video without that segment, if I want to use the audio
without rerecording it.
</p>

<pre class="example" id="org763fa3f">
And the way I can help is by jotting words down in a mind map,
typing her sentences. Oops
typing, her sentences And generating, follow-up questions.
</pre>

<p>
I also all-caps the keyword phrases so that they're easier to see when
skimming the text file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-prepare-alignment-breaks</span> ()
  <span class="org-doc">"Split lines in preparation for forced alignment with aeneas.</span>

<span class="org-doc">Split \"oops\" so that it's at the end of the line and the</span>
<span class="org-doc">previous line starts with roughly the same words as the next</span>
<span class="org-doc">line, for easier removal.</span>

<span class="org-doc">Add a linebreak before \"begin/start\" followed by</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">my-audio-braindump-part-keywords</span></span><span class="org-doc">'.</span>

<span class="org-doc">Add a linebreak after \"stop\" followed by</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">my-audio-braindump-part-keywords</span></span><span class="org-doc">'.</span>

<span class="org-doc">Look for begin keyword ... stop keyword with at most</span>
<span class="org-doc">`</span><span class="org-doc"><span class="org-constant">my-audio-braindump-part-keyword-distance-words</span></span><span class="org-doc">' between them and put them on one</span>
<span class="org-doc">line."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((case-fold-search t) result close-result)
    (my-split-oops)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">break "begin/start keyword"</span>
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> result (my-audio-braindump-scan-for-part-keyword 'start nil nil t))
      (goto-char (car result))
      (delete-region (car result) (elt result 1))
      (insert <span class="org-string">"\n"</span> (upcase (concat (elt result 2) <span class="org-string">" "</span> (elt result 3))) <span class="org-string">"\n"</span>))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">break stop</span>
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> result (my-audio-braindump-scan-for-part-keyword 'stop nil nil t))
      (goto-char (car result))
      (delete-region (car result) (elt result 1))
      (insert (upcase (concat (elt result 2) <span class="org-string">" "</span> (elt result 3))) <span class="org-string">"\n"</span>))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">try to get start and end sections on one line</span>
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> result (my-audio-braindump-scan-for-part-keyword 'start nil nil t))
      (goto-char (elt result 1))
      (<span class="org-keyword">setq</span> stop-result (my-audio-braindump-scan-for-part-keyword 'stop (elt result 3)))
      (<span class="org-keyword">if</span> stop-result
          (<span class="org-keyword">progn</span>
            (goto-char (car stop-result))
            (<span class="org-keyword">while</span> (re-search-backward <span class="org-string">" *\n+ *"</span> (car result) t)
              (replace-match <span class="org-string">" "</span>)))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">no stop keyword; are we on an empty line? If so, just merge it with the next one</span>
        (<span class="org-keyword">when</span> (looking-at <span class="org-string">"\n+ *"</span>)
          (replace-match <span class="org-string">" "</span>))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">remove empty lines</span>
    (goto-char (point-min))
    (<span class="org-keyword">when</span> (looking-at <span class="org-string">"\n+"</span>) (replace-match <span class="org-string">""</span>))
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"\n\n+"</span> nil t)
      (replace-match <span class="org-string">"\n"</span>))
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">" *\n *"</span> nil t)
      (replace-match <span class="org-string">"\n"</span>))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-audio-braindump-prepare-alignment-breaks</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"some text start a reminder hello world stop there and do something stop reminder more text"</span>)
    (goto-char (point-min))
    (my-audio-braindump-prepare-alignment-breaks)
    (expect (buffer-string) <span class="org-builtin">:to-equal</span>
            <span class="org-string">"some text</span>
<span class="org-string">START REMINDER hello world stop there and do something STOP REMINDER</span>
<span class="org-string">more text"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-preparing-the-vtt-subtitles" class="outline-4">
<h4 id="preparing-the-vtt-subtitles">Preparing the VTT subtitles</h4>
<div class="outline-text-4" id="text-preparing-the-vtt-subtitles">
<p>
<code>subed-align</code> gives me a VTT subtitle file with timestamps and text. I
add NOTE comments with the keywords and make <code>subed:</code> links to the
timestamps using the <code>ol-subed.el</code> that I just added.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-get-subtitle-note-based-on-keywords</span> (sub-text)
  (<span class="org-keyword">let</span> ((case-fold-search t))
    (<span class="org-keyword">when</span> (string-match (concat <span class="org-string">"^"</span>
                                (regexp-opt my-audio-braindump-open-keywords)
                                <span class="org-string">" </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span> (regexp-opt my-audio-braindump-part-keywords) <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> "</span>
                                (regexp-opt my-audio-braindump-close-keywords) <span class="org-string">" "</span>
                                (regexp-opt my-audio-braindump-part-keywords) <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?$"</span>)
                        sub-text)
      (concat (match-string 1 sub-text) <span class="org-string">": "</span> (match-string 2 sub-text)))))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-audio-braindump-get-subtitle-note-based-on-keywords</span> ()
  (expect (my-audio-braindump-get-subtitle-note-based-on-keywords <span class="org-string">"BEGIN NEXT STEPS . Think about how dictation helps me practice slower speed. CLOSE NEXT STEPS"</span>)
          <span class="org-builtin">:to-equal</span> <span class="org-string">"NEXT STEPS: . Think about how dictation helps me practice slower speed."</span>)
  (expect (my-audio-braindump-get-subtitle-note-based-on-keywords <span class="org-string">"START SUMMARY hello world STOP SUMMARY"</span>)
          <span class="org-builtin">:to-equal</span> <span class="org-string">"SUMMARY: hello world"</span>)
  (expect (my-audio-braindump-get-subtitle-note-based-on-keywords <span class="org-string">"START CHAPTER hello world again"</span>)
          <span class="org-builtin">:to-equal</span> <span class="org-string">"CHAPTER: hello world again"</span>)
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-formatting-the-subtitles-into-org-mode-subtrees" class="outline-4">
<h4 id="formatting-the-subtitles-into-org-mode-subtrees">Formatting the subtitles into Org Mode subtrees</h4>
<div class="outline-text-4" id="text-formatting-the-subtitles-into-org-mode-subtrees">
<p>
The last step is to take the list of subtitles and format it into the subtree.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">todo: sort the completion? https://emacs.stackexchange.com/questions/55502/list-files-in-directory-in-reverse-order-of-date</span>
<span class="org-comment-delimiter">;;</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-insert-subtitles-as-org-tree</span> (vtt-filename)
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"VTT: "</span> (expand-file-name <span class="org-string">"./"</span> my-phone-recording-dir) nil t nil
                                     (<span class="org-keyword">lambda</span> (s) (string-match <span class="org-string">"\\.vtt$"</span> s)))))
  (<span class="org-keyword">let*</span> ((subtitles
          (mapcar (<span class="org-keyword">lambda</span> (sub)
                    (<span class="org-keyword">unless</span> (elt sub 4)
                      (<span class="org-keyword">setf</span> (elt sub 4)
                            (my-audio-braindump-get-subtitle-note-based-on-keywords (elt sub 3))))
                    sub)
                  (subed-parse-file vtt-filename)))
         (start-date (my-audio-braindump-get-file-start-time vtt-filename))
         chapters tags
         start-of-entry)
    (<span class="org-keyword">setq</span> start-of-entry (point))
    (insert (format <span class="org-string">"* TODO Review braindump from %s  :braindump:\n\n"</span> (file-name-base vtt-filename)))
    (org-entry-put (point) <span class="org-string">"CREATED"</span>
                   (concat <span class="org-string">"["</span> (format-time-string
                                (cdr org-timestamp-formats)
                                (my-audio-braindump-get-file-start-time
                                 (file-name-nondirectory vtt-filename))) <span class="org-string"><span class="org-warning">"]"</span></span><span class="org-warning">))</span>
    (insert
     (format <span class="org-string">"%s - %s - %s\n"</span>
             (org-link-make-string (concat <span class="org-string">"file:"</span> (file-name-sans-extension vtt-filename) <span class="org-string">".vtt"</span>)
                                   <span class="org-string">"VTT"</span>)
             (org-link-make-string (concat <span class="org-string">"file:"</span> (file-name-sans-extension vtt-filename) <span class="org-string">".txt"</span>)
                                   <span class="org-string">"Text"</span>)
             (org-link-make-string (concat <span class="org-string">"file:"</span> (file-name-sans-extension vtt-filename) <span class="org-string">".m4a"</span>)
                                   <span class="org-string">"Audio"</span>)))
    (<span class="org-keyword">save-excursion</span>
      (insert <span class="org-string">"** Transcript\n"</span>)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">add each subtitle; add an ID in case we change the title</span>
      (mapc
       (<span class="org-keyword">lambda</span> (sub)
         (<span class="org-keyword">when</span> (elt sub 4)
           (<span class="org-keyword">let</span> ((note (my-audio-braindump-get-subtitle-note-based-on-keywords (elt sub 3))))
             (insert (concat <span class="org-string">"*** "</span>
                             note <span class="org-string">" "</span>
                             (org-link-make-string
                              (format <span class="org-string">"subed:%s::%s"</span>
                                      vtt-filename
                                      (my-msecs-to-timestamp (elt sub 1)))
                              <span class="org-string">"VTT"</span>)
                             <span class="org-string">"\n\n"</span>))
             (org-entry-put (point) <span class="org-string">"CREATED"</span>
                   (concat <span class="org-string">"["</span> (format-time-string
                                (cdr org-timestamp-formats)
                                (time-add start-date
                                          (seconds-to-time (/ (elt sub 1) 1000.0)))) <span class="org-string"><span class="org-warning">"]"</span></span><span class="org-warning">))</span>
             (org-entry-put (point) <span class="org-string">"START"</span> (my-msecs-to-timestamp (elt sub 2)))
             (<span class="org-keyword">when</span> (elt sub 4)
               (<span class="org-keyword">when</span> (string-match <span class="org-string">"command: .*recognize"</span> (elt sub 4))
                 (<span class="org-keyword">save-excursion</span>
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">TODO: scope this to just the section someday</span>
                   (goto-char start-of-entry)
                   (org-set-tags (append (list <span class="org-string">"recognize"</span>) (org-get-tags)))))
               (<span class="org-keyword">when</span> (string-match <span class="org-string">"command: .*outline"</span> (elt sub 4))
                 (<span class="org-keyword">save-excursion</span>
                   (goto-char start-of-entry)
                   (org-set-tags (append (list <span class="org-string">"outline"</span>) (org-get-tags)))))
               (<span class="org-keyword">when</span> (string-match <span class="org-string">"^time"</span> (elt sub 4))
                 (insert <span class="org-string">"["</span> (org-format-time-string (cdr org-timestamp-formats)
                                                     (time-add start-date (seconds-to-time (/ (elt sub 1) 1000))))
                         <span class="org-string">"]\n"</span>))
               (<span class="org-keyword">when</span> (string-match <span class="org-string">"command: .+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">high</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">low</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> (elt sub 4))
                 (<span class="org-keyword">save-excursion</span>
                   (goto-char start-of-entry)
                   (org-priority (<span class="org-keyword">if</span> (string= (downcase (match-string 1)) <span class="org-string">"high"</span>) ?A ?C))))
               (<span class="org-keyword">when</span> (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">tags?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">keywords?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> (elt sub 4))
                 (<span class="org-keyword">save-excursion</span>
                   (goto-char start-of-entry)
                   (org-set-tags (append (split-string (match-string 1) <span class="org-string">" "</span>) (org-get-tags))))))
             (add-to-list 'chapters
                          (format <span class="org-string">"- %s (%s)"</span>
                                  (org-link-make-string (concat <span class="org-string">"id:"</span> (org-id-get-create))
                                                        note)
                                  (org-link-make-string
                                   (format <span class="org-string">"subed:%s::%s"</span>
                                           vtt-filename
                                           (my-msecs-to-timestamp (elt sub 1)))
                                   <span class="org-string">"VTT"</span>)))))
         (insert (elt sub 3) <span class="org-string">"\n"</span>))
       subtitles))
    (<span class="org-keyword">when</span> chapters
      (insert (string-join (nreverse chapters) <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my-file-start-time</span> (filename <span class="org-type">&amp;optional</span> base-date)
  <span class="org-doc">"Return the local time based on FILENAME."</span>
  (<span class="org-keyword">setq</span> filename (file-name-base filename))
  (<span class="org-keyword">cond</span>
   ((string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[-T]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][\\.-][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[\\.-][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> filename)
    (date-to-time (concat (match-string 1 filename) <span class="org-string">"T"</span>
                          (replace-regexp-in-string <span class="org-string">"[\\.-]"</span> <span class="org-string">":"</span> (match-string 2 filename)))))
   ((string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">Copy of </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ][</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ][</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+ at </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> filename)
    (<span class="org-keyword">let*</span> ((day (match-string 1 filename))
           (hour (match-string 2 filename))
           (min (match-string 3 filename))
           (changed-time (<span class="org-keyword">or</span> base-date (file-attribute-modification-time
                                        (file-attributes filename))))
           (decoded-time (decode-time changed-time)))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">get the day on or before changed-time</span>
      (<span class="org-keyword">if</span> (string= (format-time-string <span class="org-string">"%a"</span> changed-time) day)
          (encode-time (append
                        (list
                         0
                         (string-to-number min)
                         (string-to-number hour))
                        (seq-drop decoded-time 3)))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">synchronized maybe within the week after</span>
        (<span class="org-keyword">let</span> ((org-read-date-prefer-future nil))
          (org-read-date t t
                         (concat <span class="org-string">"--"</span> day <span class="org-string">" "</span> hour <span class="org-string">":"</span> min)
                         nil changed-time)))))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-file-start-time</span> ()
  (should
   (equal (format-time-string <span class="org-string">"%Y-%m-%d %H:%M:%S"</span>
                              (my-file-start-time <span class="org-string">"2024-01-05-09-46-59.flv"</span>))
          <span class="org-string">"2024-01-05 09:46:59"</span>))
  (should
   (equal (format-time-string <span class="org-string">"%Y-%m-%d %H:%M:%S"</span>
                              (my-file-start-time <span class="org-string">"2024-01-08T12.49.vtt"</span>))
          <span class="org-string">"2024-01-08 12:49:00"</span>))
  (should
   (equal (format-time-string <span class="org-string">"%Y-%m-%d %H:%M:%S"</span>
                              (my-file-start-time <span class="org-string">"Sunday at 15-30.vtt"</span>
                                                  (date-to-time <span class="org-string">"2023-01-12"</span>)))
          <span class="org-string">"2023-01-08 15:30:00"</span>))
  (should
   (time-equal-p (my-file-start-time <span class="org-string">"Sunday at 12-49.txt"</span>)
                 (org-read-date t t <span class="org-string">"-sun 12:49"</span>))))

(<span class="org-keyword">defalias</span> '<span class="org-function-name">my-audio-braindump-get-file-start-time</span> #'my-file-start-time)
</pre>
</div>
</div>
</div>
<div id="outline-container-process-a-single-transcript-from-the-raw-text-file" class="outline-4">
<h4 id="process-a-single-transcript-from-the-raw-text-file">Process a single transcript from the raw text file</h4>
<div class="outline-text-4" id="text-process-a-single-transcript-from-the-raw-text-file">
<p>
So now we put that all together: rename the file using the calculated
start time, prepare the alignment breaks, align the file to get the
timestamps, and add the subtree to an Org file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-audio-braindump-file</span> <span class="org-string">"~/sync/orgzly/braindump.org"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-make-todo</span> (text-file <span class="org-type">&amp;optional</span> force)
  <span class="org-doc">"Add TEXT-FILE as a TODO."</span>
  (<span class="org-keyword">interactive</span> (list (buffer-file-name) current-prefix-arg))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">rename the files to use the timestamps</span>
  (<span class="org-keyword">unless</span> (string-match <span class="org-string">"^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]"</span>
                        (file-name-base text-file))
    (<span class="org-keyword">setq</span> text-file (my-audio-braindump-rename-files-based-on-time text-file)))
  (<span class="org-keyword">let*</span> ((recording (concat (file-name-sans-extension text-file) <span class="org-string">".m4a"</span>))
         (start (my-audio-braindump-get-file-start-time text-file))
         (vtt (concat (file-name-sans-extension text-file) <span class="org-string">".vtt"</span>))
         chapters
         (title (concat <span class="org-string">"Review braindump "</span> text-file))
         existing)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">check if already exists</span>
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect my-audio-braindump-file)
      (<span class="org-keyword">save-excursion</span>
        (goto-char (point-min))
        (<span class="org-keyword">setq</span> existing (org-find-exact-headline-in-buffer title))))
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> existing (not force))
        (<span class="org-keyword">progn</span>
          (message <span class="org-string">"Going to existing heading"</span>)
          (org-goto-marker-or-bmk existing))
      (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (null my-audio-braindump-last-processed-time)
              (time-less-p my-audio-braindump-last-processed-time start))
          (customize-save-variable 'my-audio-braindump-last-processed-time start))
      (find-file text-file)
      (my-audio-braindump-prepare-alignment-breaks)
      (save-buffer)
      (<span class="org-keyword">when</span> (file-exists-p vtt) (delete-file vtt))
      (<span class="org-keyword">when</span> (get-file-buffer vtt) (kill-buffer (get-file-buffer vtt)))
      (subed-align recording text-file <span class="org-string">"VTT"</span>)
      (<span class="org-keyword">when</span> (get-file-buffer vtt) (kill-buffer (get-file-buffer vtt)))
      (find-file my-audio-braindump-file)
      (goto-char (point-min))
      (<span class="org-keyword">if</span> existing
          (<span class="org-keyword">progn</span>
            (org-goto-marker-or-bmk existing)
            (delete-region (point) (org-end-of-subtree)))
        (org-next-visible-heading 1))
      (my-audio-braindump-insert-subtitles-as-org-tree vtt))))
</pre>
</div>
</div>
</div>
<div id="outline-container-process-multiple-files" class="outline-4">
<h4 id="process-multiple-files">Process multiple files</h4>
<div class="outline-text-4" id="text-process-multiple-files">
<p>
I want to process multiple files in one batch.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-process</span> (files <span class="org-type">&amp;optional</span> force)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">cond</span>
                      ((<span class="org-keyword">and</span> (derived-mode-p 'dired-mode)
                            (dired-get-marked-files))
                       (dired-get-marked-files))
                      ((derived-mode-p 'dired-mode)
                       (list (dired-get-filename)))
                      ((string-match <span class="org-string">"\\.txt$"</span> (buffer-file-name))
                       (list (buffer-file-name)))
                      (t (read-file-name <span class="org-string">"Transcript: "</span>)))
                     current-prefix-arg))
  (mapc (<span class="org-keyword">lambda</span> (f)
          (<span class="org-keyword">when</span> (string-match <span class="org-string">"txt"</span> f)
            (my-audio-braindump-make-todo f force))) <span class="org-warning">files))</span>
</pre>
</div>

<p>
It would be nice to have it automatically keep track of the latest one
that's been processed, maybe via <code>customize-save-variable</code>. This still
needs some tinkering with.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defcustom</span> <span class="org-variable-name">my-audio-braindump-last-processed-time</span> nil
  <span class="org-doc">"The timestamp of the last processed transcript."</span>
  <span class="org-builtin">:group</span> 'sacha
  <span class="org-builtin">:type</span> '(repeat integer))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-process-since-last</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((files
         (seq-filter
          (<span class="org-keyword">lambda</span> (f)
            (<span class="org-keyword">or</span> (null my-audio-braindump-last-processed-time)
                (time-less-p my-audio-braindump-last-processed-time
                             (my-audio-braindump-get-file-start-time f))))
          (directory-files my-phone-recording-dir 'full <span class="org-string">" at [0-9][0-9]-[0-9][0-9]\\.txt</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]T[0-9][0-9]\\.[0-9][0-9]\\.txt"</span>))))
    (mapc (<span class="org-keyword">lambda</span> (f)
            (my-audio-braindump-make-todo f)
            (<span class="org-keyword">let</span> ((start (my-audio-braindump-get-file-start-time f)))
              (<span class="org-keyword">if</span> (time-less-p my-audio-braindump-last-processed-time start)
                  (<span class="org-keyword">setq</span> my-audio-braindump-last-processed-time start))))
          files))
  (customize-save-variable 'my-audio-braindump-last-processed-time my-audio-braindump-last-processed-time))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-new-filename</span> (text-file <span class="org-type">&amp;optional</span> base-date)
  (<span class="org-keyword">if</span> (string-match <span class="org-string">"^[0-9][0-9][0-9][0-9]"</span> text-file)
      text-file     <span class="org-comment-delimiter">; </span><span class="org-comment">no change, already uses date</span>
    (<span class="org-keyword">let*</span> ((base (file-name-base text-file))
           (start (my-audio-braindump-get-file-start-time base base-date))
           (rest (<span class="org-keyword">if</span> (string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[-0-9T\\.]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">.+? at [0-9][0-9]-[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> .+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> base)
                     (match-string 2 base)
                   <span class="org-string">""</span>))
           (new-base (format-time-string <span class="org-string">"%Y-%m-%dT%H.%M"</span> start)))
      (concat new-base rest <span class="org-string">"."</span> (file-name-extension text-file)))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-audio-braindump-new-filename</span> ()
 (should
  (equal (my-audio-braindump-new-filename <span class="org-string">"Wednesday at 18-58.txt"</span> (date-to-time <span class="org-string">"2023-01-01"</span>))
         <span class="org-string">"2022-12-28T18.58.txt"</span>))
 (should
  (equal (my-audio-braindump-new-filename <span class="org-string">"Wednesday at 18-58 extra text.txt"</span> (date-to-time <span class="org-string">"2023-01-01"</span>))
         <span class="org-string">"2022-12-28T18.58 extra text.txt"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-rename-files-based-on-time</span> (text-file)
  <span class="org-doc">"Rename TEXT-FILE based on date. Return the new text file."</span>
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode) (dired-get-filename)
                       (buffer-file-name))))
  (<span class="org-keyword">if</span> (string-match <span class="org-string">"^[0-9][0-9][0-9][0-9]"</span> text-file)
      text-file     <span class="org-comment-delimiter">; </span><span class="org-comment">no change, already uses date</span>
    (<span class="org-keyword">let</span> ((new-name (my-audio-braindump-new-filename (file-name-nondirectory text-file))))
      (<span class="org-keyword">if</span> (file-exists-p (expand-file-name new-name
                                           (file-name-directory text-file)))
          (<span class="org-warning">error</span> <span class="org-string">"%s already exists"</span> new-base)
        (<span class="org-keyword">dolist</span> (ext '(<span class="org-string">".txt"</span> <span class="org-string">".m4a"</span> <span class="org-string">".vtt"</span>))
          (<span class="org-keyword">if</span> (file-exists-p (concat (file-name-sans-extension text-file) ext))
              (rename-file (concat (file-name-sans-extension text-file) ext)
                           (expand-file-name (concat (file-name-sans-extension new-name) ext)
                                             (file-name-directory text-file)))))
        (expand-file-name new-name
                          (file-name-directory text-file))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-ideas-for-next-steps" class="outline-4">
<h4 id="ideas-for-next-steps">Ideas for next steps</h4>
<div class="outline-text-4" id="text-ideas-for-next-steps">
<ul class="org-ul">
<li>Make the commands process things even more automatically.</li>
<li>Experiment with just sending everything to OpenAI Whisper instead of conditionally sending it based on the keywords (which might not be recognized).</li>
<li>See if I want to reuse more sentences or move them around.</li>
<li>Find out where people who have thought about dictation keywords have their notes; probably don't have to reinvent the wheel here</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-markdown" class="outline-3">
<h3 id="markdown">Markdown</h3>
<div class="outline-text-3" id="text-markdown">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> markdown-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">njk</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">md</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span> . markdown-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-screenshot" class="outline-3">
<h3 id="screenshot">Screenshot</h3>
<div class="outline-text-3" id="text-screenshot">
<p>
Based on <a href="https://www.reddit.com/r/emacs/comments/idz35e/emacs_27_can_take_svg_screenshots_of_itself/">https://www.reddit.com/r/emacs/comments/idz35e/emacs_27_can_take_svg_screenshots_of_itself/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">screenshot-svg</span> ()
  <span class="org-doc">"Save a screenshot of the current frame as an SVG image.</span>
<span class="org-doc">Saves to a temp file and puts the filename in the kill ring."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((filename
          (expand-file-name
           (format-time-string <span class="org-string">"%Y-%m-%d-%H-%M-%S.svg"</span>)
           my-recordings-dir))
         (data (x-export-frames nil 'svg)))
    (<span class="org-keyword">with-temp-file</span> filename
      (insert data))
    (kill-new filename)
    (message filename)))
(keymap-global-set <span class="org-string">"C-c s"</span> #'screenshot-svg)
</pre>
</div>
</div>
</div>
<div id="outline-container-avoiding-weasel-words" class="outline-3">
<h3 id="avoiding-weasel-words">Avoiding weasel words</h3>
<div class="outline-text-3" id="text-avoiding-weasel-words">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> artbollocks-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:load-path</span>  <span class="org-string">"~/elisp/artbollocks-mode"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> artbollocks-weasel-words-regex
          (concat <span class="org-string">"\\b"</span> (regexp-opt
                         '(<span class="org-string">"one of the"</span>
                           <span class="org-string">"should"</span>
                           <span class="org-string">"just"</span>
                           <span class="org-string">"sort of"</span>
                           <span class="org-string">"a lot"</span>
                           <span class="org-string">"probably"</span>
                           <span class="org-string">"maybe"</span>
                           <span class="org-string">"perhaps"</span>
                           <span class="org-string">"I think"</span>
                           <span class="org-string">"really"</span>
                           <span class="org-string">"pretty"</span>
                           <span class="org-string">"nice"</span>
                           <span class="org-string">"action"</span>
                           <span class="org-string">"utilize"</span>
                           <span class="org-string">"leverage"</span>) <span class="org-warning">t) </span><span class="org-string"><span class="org-warning">"\\b"</span></span><span class="org-warning">))</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Don't show the art critic words, or at least until I figure</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">out my own jargon</span>
    (<span class="org-keyword">setq</span> artbollocks-jargon nil)))
</pre>
</div>
</div>
</div>
<div id="outline-container-unfill-paragraph" class="outline-3">
<h3 id="unfill-paragraph">Unfill paragraph</h3>
<div class="outline-text-3" id="text-unfill-paragraph">
<p>
I unfill paragraphs a lot because Wordpress likes adding extra <code>&lt;br&gt;</code> tags if I don't. (I should probably just tweak my Wordpress installation.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-unfill-paragraph</span> (<span class="org-type">&amp;optional</span> region)
  <span class="org-doc">"Takes a multi-line paragraph and makes it into a single line of text."</span>
  (<span class="org-keyword">interactive</span> (<span class="org-keyword">progn</span>
                 (barf-if-buffer-read-only)
                 (list t)))
  (<span class="org-keyword">let</span> ((fill-column (point-max)))
    (fill-paragraph nil region)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"M-Q"</span> 'my-unfill-paragraph)
</pre>
</div>

<p>
I never actually justify text, so I might as well change the way
<code>fill-paragraph</code> works. With the code below, <code>M-q</code> will fill the
paragraph normally, and <code>C-u M-q</code> will unfill it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-fill-or-unfill-paragraph</span> (<span class="org-type">&amp;optional</span> unfill region)
  <span class="org-doc">"Fill paragraph (or REGION).</span>
<span class="org-doc">        With the prefix argument UNFILL, unfill it instead."</span>
  (<span class="org-keyword">interactive</span> (<span class="org-keyword">progn</span>
                 (barf-if-buffer-read-only)
                 (list (<span class="org-keyword">if</span> current-prefix-arg 'unfill) t)))
  (<span class="org-keyword">let</span> ((fill-column (<span class="org-keyword">if</span> unfill (point-max) fill-column)))
    (fill-paragraph nil region)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"M-q"</span> 'my-fill-or-unfill-paragraph)
</pre>
</div>

<p>
Also, <code>visual-line-mode</code> is so much better than <code>auto-fill-mode</code>. It doesn't actually break the text into multiple lines - it only looks that way.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(remove-hook 'text-mode-hook #'turn-on-auto-fill)
(add-hook 'text-mode-hook 'turn-on-visual-line-mode)
</pre>
</div>
</div>
</div>
<div id="outline-container-unicode" class="outline-3">
<h3 id="unicode">Unicode</h3>
<div class="outline-text-3" id="text-unicode">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-insert-unicode</span> (unicode-name)
  `(<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>)
     (insert-char (cdr (assoc-string ,unicode-name (ucs-names))))))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x 8 s"</span> (my-insert-unicode <span class="org-string">"ZERO WIDTH SPACE"</span>))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x 8 S"</span> (my-insert-unicode <span class="org-string">"SNOWMAN"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-clean-up-spaces" class="outline-3">
<h3 id="clean-up-spaces">Clean up spaces</h3>
<div class="outline-text-3" id="text-clean-up-spaces">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"M-SPC"</span> 'cycle-spacing)
</pre>
</div>
</div>
</div>
<div id="outline-container-expand" class="outline-3">
<h3 id="expand">Expand</h3>
<div class="outline-text-3" id="text-expand">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> save-abbrevs 'silently)
(<span class="org-keyword">bind-key</span> <span class="org-string">"M-/"</span> 'hippie-expand)
</pre>
</div>

<p>
From <a href="https://github.com/purcell/emacs.d/blob/master/lisp/init-auto-complete.el">https://github.com/purcell/emacs.d/blob/master/lisp/init-auto-complete.el</a> - Exclude very large buffers from dabbrev
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/dabbrev-friend-buffer</span> (other-buffer)
  (&lt; (buffer-size other-buffer) (* 1 1024 1024)))
(<span class="org-keyword">setq</span> dabbrev-friend-buffer-function 'sanityinc/dabbrev-friend-buffer)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> hippie-expand-try-functions-list
      '(yas-hippie-try-expand
        try-expand-all-abbrevs
        try-complete-file-name-partially
        try-complete-file-name
        try-expand-dabbrev
        try-expand-dabbrev-from-kill
        try-expand-dabbrev-all-buffers
        try-expand-list
        try-expand-line
        try-complete-lisp-symbol-partially
        try-complete-lisp-symbol))
</pre>
</div>
</div>
</div>
<div id="outline-container-write-about-keybindings" class="outline-3">
<h3 id="write-about-keybindings">Write about keybindings</h3>
<div class="outline-text-3" id="text-write-about-keybindings">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">hmm, doesn't quite work for looking things up yet. I basically want a programmatic where-is for a specific keymap</span>
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-keybinding-maps</span> '(subed-mode-map subed-waveform-minor-mode-map subed-waveform-svg-map))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-keybinding</span> (symbol)
  (<span class="org-keyword">interactive</span> (list (find-function-read)))
  (<span class="org-keyword">when</span> (listp symbol)
    (<span class="org-keyword">setq</span> symbol (car symbol)))
  (<span class="org-keyword">let</span> (result keys)
    (map-keymap
     (<span class="org-keyword">lambda</span> (event def)
       (<span class="org-keyword">cond</span> ((<span class="org-keyword">and</span> (symbolp def))
              (<span class="org-keyword">push</span> (list def event) result))
             ((<span class="org-keyword">and</span> (listp def) (eq 'keymap (car def)))
              (apply 'append
                     (map-keymap
                      (<span class="org-keyword">lambda</span> (event def)
                        (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (symbolp def))
                          (<span class="org-keyword">push</span> (list def event) result)))
                      def)))))
     subed-mode-map)
    (<span class="org-keyword">setq</span> keys (assoc-default symbol result))
    (<span class="org-keyword">when</span> keys
      (kill-new (key-description keys))
      (message <span class="org-string">"%s"</span> (key-description keys)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-subed" class="outline-3">
<h3 id="subed">Subtitles with Subed</h3>
<div class="outline-text-3" id="text-subed">
</div>
<div id="outline-container-adjust-subtitles" class="outline-4">
<h4 id="adjust-subtitles"><span class="todo TODO">TODO</span> Adjust subtitles</h4>
<div class="outline-text-4" id="text-adjust-subtitles">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-move-succeeding-subtitles-based-on-mpv</span> ()
  <span class="org-doc">"Move current and succeeding subtitles so that current starts at MPV playing position."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> subed-mpv-playback-position
      (subed-move-subtitles
       (- subed-mpv-playback-position (subed-subtitle-msecs-start))
       (point) (point-max))
    (<span class="org-warning">error</span> <span class="org-string">"Need playback position."</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-check-random</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((list (subed-subtitle-list))
         (pos (random (length list))))
    (subed-jump-to-subtitle-id
     (subed-msecs-to-timestamp (elt (elt list pos) 1)))
    (subed-mpv-jump-to-current-subtitle)
    (subed-mpv-unpause)))
</pre>
</div>
</div>
</div>
<div id="outline-container-extract-part-of-a-video" class="outline-4">
<h4 id="extract-part-of-a-video">Extract part of a video</h4>
<div class="outline-text-4" id="text-extract-part-of-a-video">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-get-region-start-stop</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (cons (<span class="org-keyword">save-excursion</span>
          (goto-char (min beg end))
          (subed-subtitle-msecs-start))
        (<span class="org-keyword">save-excursion</span>
          (goto-char (max beg end))
          (subed-subtitle-msecs-stop))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-extend-file-name</span> (original name <span class="org-type">&amp;optional</span> extension)
  <span class="org-doc">"Add NAME to the end of ORIGINAL, before the file extension."</span>
  (concat (file-name-sans-extension original) <span class="org-string">" "</span> name <span class="org-string">"."</span>
          (<span class="org-keyword">or</span> extension (file-name-extension original))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-adjust-subtitles</span> (offset)
  <span class="org-doc">"Change all of the start and end times by OFFSET."</span>
  (<span class="org-keyword">interactive</span> (list (subed--string-to-msecs (read-string <span class="org-string">"Time: "</span>))))
  (subed-for-each-subtitle (point-min) (point-max) nil
    (subed-adjust-subtitle-time-start offset t t)
    (subed-adjust-subtitle-time-stop offset t t))
  (subed-regenerate-ids))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-write-adjusted-subtitles</span> (source-file start-msecs end-msecs dest-file)
  (<span class="org-keyword">let</span> ((s (<span class="org-keyword">with-current-buffer</span> (find-file-noselect source-file)
             (buffer-substring-no-properties
              (subed-jump-to-subtitle-id-at-msecs start-msecs)
              (<span class="org-keyword">progn</span> (subed-jump-to-subtitle-id-at-msecs end-msecs) (subed-jump-to-subtitle-end)))))
        (offset (- start-msecs)))
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect dest-file)
      (erase-buffer)
      (insert s)
      (my-adjust-subtitles offset)
      (save-buffer)
      (buffer-file-name))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-msecs-to-timestamp</span> (msecs)
  <span class="org-doc">"Convert MSECS to string in the format HH:MM:SS.MS."</span>
  (concat (format-seconds <span class="org-string">"%02h:%02m:%02s"</span> (/ msecs 1000))
          <span class="org-string">"."</span> (format <span class="org-string">"%03d"</span> (mod msecs 1000))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-make-animated-gif</span> (beg end name)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r\nMName: "</span>)
  (<span class="org-keyword">let*</span> ((video-file (subed-guess-video-file))
         (msecs (my-subed-get-region-start-stop beg end))
         (new-file (my-extend-file-name video-file name <span class="org-string">"gif"</span>))
         cmd)
    (<span class="org-keyword">when</span> (&gt; (length name) 0)
      (<span class="org-keyword">setq</span> cmd
            (format <span class="org-string">"ffmpeg -y -i %s -ss %s -t %s -vf subtitles=%s -r 10 -c:a copy -shortest -async 1 %s"</span>
                    (shell-quote-argument video-file)
                    (my-msecs-to-timestamp (car msecs))
                    (my-msecs-to-timestamp (- (cdr msecs) (car msecs)))
                    (shell-quote-argument (my-subed-write-adjusted-subtitles beg end name))
                    (shell-quote-argument new-file)))
      (message <span class="org-string">"%s"</span> cmd)
      (kill-new cmd)
      (shell-command cmd))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-ffmpeg-make-mute-filter</span> (segments)
  (mapconcat
   (<span class="org-keyword">lambda</span> (s)
     (format <span class="org-string">"volume=enable='between(t,%.3f,%.3f)':volume=0"</span>
             (/ (car s) 1000.0)
             (/ (cdr s) 1000.0)))
   segments <span class="org-string">", "</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-cut-video</span> (beg end name video-file caption-file <span class="org-type">&amp;optional</span> kill-only)
  (<span class="org-keyword">interactive</span>
   (append
    (<span class="org-keyword">if</span> (use-region-p)
        (list (point) (mark))
      (list (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-id))
            (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-end))))
    (list
     (expand-file-name (read-file-name <span class="org-string">"New video filename: "</span>))
     (<span class="org-keyword">if</span> (derived-mode-p 'subed-mode) (expand-file-name (subed-media-file))
       (read-file-name <span class="org-string">"Video: "</span>))
     (<span class="org-keyword">if</span> (derived-mode-p 'subed-mode) (expand-file-name (buffer-file-name))
       (read-file-name <span class="org-string">"Captions: "</span>)))))
  (<span class="org-keyword">let*</span>
      ((msecs (my-subed-get-region-start-stop beg end))
       (new-file name)
       cmd)
    (<span class="org-keyword">when</span> (&gt; (length name) 0)
      (<span class="org-keyword">setq</span> cmd
            (format <span class="org-string">"ffmpeg -y -i %s -i %s -ss %s -t %s -shortest -async 1 %s"</span>
                    (shell-quote-argument caption-file)
                    (shell-quote-argument video-file)
                    (my-msecs-to-timestamp
                     (car msecs))
                    (my-msecs-to-timestamp
                     (-
                      (cdr msecs)
                      (car msecs)))
                    (shell-quote-argument new-file)))
      (message <span class="org-string">"%s"</span> cmd)
      (<span class="org-keyword">if</span> kill-only (kill-new cmd)
        (shell-command cmd)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-hide-ids-and-times" class="outline-4">
<h4 id="hide-ids-and-times">Hide IDs and times</h4>
<div class="outline-text-4" id="text-hide-ids-and-times">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">my-subed-hide-nontext-minor-mode</span>
  <span class="org-doc">"Minor mode for hiding non-text stuff."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-hide-nontext-overlay</span> (start end)
  (<span class="org-keyword">let</span> ((new-overlay (make-overlay start end)))
    (overlay-put new-overlay 'invisible t)
    (overlay-put new-overlay 'intangible t)
    (overlay-put new-overlay 'evaporate t)
    (overlay-put new-overlay 'read-only t)
    (overlay-put new-overlay 'hide-non-text t)
    (<span class="org-keyword">with-silent-modifications</span>
      (add-text-properties start end '(read-only t)))
    new-overlay))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-hide-nontext</span> ()
  (<span class="org-keyword">interactive</span>)
  (remove-overlays (point-min) (point-max) 'invisible t)
  (<span class="org-keyword">when</span> my-subed-hide-nontext-minor-mode
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (subed-jump-to-subtitle-id)
      (my-subed-hide-nontext-overlay (point-min) (subed-jump-to-subtitle-text))
      (<span class="org-keyword">let</span> (next)
        (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> next (<span class="org-keyword">save-excursion</span> (subed-forward-subtitle-text)))
          (subed-jump-to-subtitle-end)
          (my-subed-hide-nontext-overlay (1+ (point)) (1- next))
          (subed-forward-subtitle-text))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-show-all</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((inhibit-read-only t))
    (<span class="org-keyword">with-silent-modifications</span>
      (remove-text-properties (point-min) (point-max) '(read-only t))
      (remove-overlays (point-min) (point-max) 'invisible t))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-ignore-read-only</span> (f <span class="org-type">&amp;rest</span> args)
  (<span class="org-keyword">let</span> ((inhibit-read-only t))
    (apply f args)
    (my-subed-hide-nontext)))

(advice-add 'subed-split-and-merge-dwim <span class="org-builtin">:around</span> #'my-ignore-read-only)
(advice-add 'subed-split-subtitle <span class="org-builtin">:around</span> #'my-ignore-read-only)
(advice-add 'subed-merge-with-next <span class="org-builtin">:around</span> #'my-ignore-read-only)
(advice-add 'subed-merge-with-previous <span class="org-builtin">:around</span> #'my-ignore-read-only)
(advice-add 'subed-regenerate-ids <span class="org-builtin">:around</span> #'my-ignore-read-only)
(advice-add 'subed-kill-subtitle <span class="org-builtin">:around</span> #'my-ignore-read-only)
</pre>
</div>
</div>
</div>
<div id="outline-container-other-subtitle-code" class="outline-4">
<h4 id="other-subtitle-code">Other subtitle code</h4>
<div class="outline-text-4" id="text-other-subtitle-code">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-forward-word</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Skip timestamps."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"^p"</span>)
  (<span class="org-keyword">setq</span> arg (<span class="org-keyword">or</span> arg 1))
  (<span class="org-keyword">let</span> ((end (<span class="org-keyword">or</span> (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-end)) (point))))
    (loop while (&gt; arg 0)
          do
          (forward-word 1)
          (skip-syntax-forward <span class="org-string">"^\s"</span>)
          (<span class="org-keyword">setq</span> arg (1- arg))
          (<span class="org-keyword">when</span> (&gt; (point) end)
            (subed-jump-to-subtitle-text)
            (forward-word 1)
            (skip-syntax-forward <span class="org-string">"^\s"</span>)
            (<span class="org-keyword">setq</span> end (<span class="org-keyword">or</span> (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-end)) (point)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-backward-word</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Skip timestamps."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"^p"</span>)
  (<span class="org-keyword">setq</span> arg (<span class="org-keyword">or</span> arg 1))
  (<span class="org-keyword">let</span> ((end (<span class="org-keyword">or</span> (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-text)) (point))))
    (loop while (&gt; arg 0)
          do
          (backward-word 1)
          (<span class="org-keyword">setq</span> arg (1- arg))
          (<span class="org-keyword">when</span> (&lt; (point) end)
            (subed-backward-subtitle-text)
            (<span class="org-keyword">setq</span> end (point))
            (subed-jump-to-subtitle-end)
            (backward-word 1)))))

(<span class="org-keyword">defhydra</span> my-subed ()
  <span class="org-doc">"Make it easier to split and merge"</span>
  (<span class="org-string">"e"</span> subed-jump-to-subtitle-end <span class="org-string">"End"</span>)
  (<span class="org-string">"s"</span> subed-jump-to-subtitle-text <span class="org-string">"Start"</span>)
  (<span class="org-string">"f"</span> my-subed-forward-word <span class="org-string">"Forward word"</span>)
  (<span class="org-string">"b"</span> my-subed-backward-word <span class="org-string">"Backward word"</span>)
  (<span class="org-string">"w"</span> avy-goto-word-1-below <span class="org-string">"Jump to word"</span>)
  (<span class="org-string">"n"</span> subed-forward-subtitle-text <span class="org-string">"Forward subtitle"</span>)
  (<span class="org-string">"p"</span> subed-backward-subtitle-text <span class="org-string">"Backward subtitle"</span>)
  (<span class="org-string">".p"</span> (subed-split-and-merge-dwim 'prev) <span class="org-string">"Split and merge with previous"</span>)
  (<span class="org-string">".n"</span> (subed-split-and-merge-dwim 'next) <span class="org-string">"Split and merge with next"</span>)
  (<span class="org-string">"mp"</span> subed-merge-with-previous <span class="org-string">"Merge previous"</span>)
  (<span class="org-string">"mn"</span> subed-merge-with-next <span class="org-string">"Merge next"</span>)
  (<span class="org-string">"j"</span> subed-mpv-jump-to-current-subtitle <span class="org-string">"MPV current"</span>)
  (<span class="org-string">"1"</span> (subed-mpv-playback-speed 1.0) <span class="org-string">"1x speed"</span>)
  (<span class="org-string">"2"</span> (subed-mpv-playback-speed 0.7) <span class="org-string">"0.7x speed"</span>)
  (<span class="org-string">"3"</span> (subed-mpv-playback-speed 0.5) <span class="org-string">"0.5x speed"</span>)
  (<span class="org-string">" "</span> subed-mpv-pause <span class="org-string">"Pause"</span>)
  (<span class="org-string">"["</span> (subed-mpv-seek -1000) <span class="org-string">"-1s"</span>)
  (<span class="org-string">"]"</span> (subed-mpv-seek 1000) <span class="org-string">"-1s"</span>)
  (<span class="org-string">";"</span> (re-search-forward <span class="org-string">"[,\\.;]"</span>) <span class="org-string">"Search for break"</span>)
  (<span class="org-string">"uu"</span> (subed-split-and-merge-dwim 'prev) <span class="org-string">"Split and merge with previous"</span>)
  (<span class="org-string">"hh"</span> (subed-split-and-merge-dwim 'next) <span class="org-string">"Split and merge with next"</span>)
  (<span class="org-string">"hu"</span> subed-merge-with-previous <span class="org-string">"Merge with previous"</span>)
  (<span class="org-string">"uh"</span> subed-merge-with-next <span class="org-string">"Merge with next"</span>)
  (<span class="org-string">"lf"</span> subed-mpv-find-video <span class="org-string">"Find video file"</span>)
  (<span class="org-string">"lu"</span> subed-mpv-play-url <span class="org-string">"Find video at URL"</span>)
  (<span class="org-string">"x"</span> kill-word <span class="org-string">"Kill word"</span>)
  (<span class="org-string">"S"</span> save-buffer <span class="org-string">"Save"</span>)
  (<span class="org-string">"o"</span> (insert <span class="org-string">"\n"</span>) (<span class="org-keyword">let</span> ((fill-column (point-max))) (fill-paragraph))))
(<span class="org-keyword">use-package</span> subed
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-comment-delimiter">;; </span><span class="org-comment">:quelpa (subed :fetcher github :repo "rndusr/subed" :files (:defaults "subed/*.el"))</span>
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/subed/subed"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> subed-subtitle-spacing 1)
  (key-chord-define subed-mode-map <span class="org-string">"hu"</span> 'my-subed/body)
  (key-chord-define subed-mode-map <span class="org-string">"ht"</span> 'my-subed/body)
  (<span class="org-keyword">setq</span> subed-loop-seconds-before 0 subed-loop-seconds-after 0)
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> subed-mode-map
        (<span class="org-string">"M-j"</span> . avy-goto-char-timer)
        (<span class="org-string">"M-j"</span> . subed-mpv-jump-to-current-subtitle)
        (<span class="org-string">"M-!"</span> . subed-mpv-seek)))
(<span class="org-keyword">use-package</span> subed-record
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/proj/subed-record"</span>
  <span class="org-builtin">:config</span>
  (remove-hook 'subed-sanitize-functions 'subed-sort)
  (<span class="org-keyword">setq</span> subed-record-ffmpeg-args (split-string <span class="org-string">"-y -f pulse -i alsa_input.usb-Blue_Microphones_Yeti_Stereo_Microphone_REV8-00.analog-stereo"</span>))
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> subed-mode-map (<span class="org-string">"C-c C-c"</span> . subed-record-compile-video)))
</pre>
</div>
</div>
</div>
<div id="outline-container-using-emacs-to-fix-automatically-generated-subtitle-timestamps" class="outline-4">
<h4 id="using-emacs-to-fix-automatically-generated-subtitle-timestamps">Using Emacs to fix automatically generated subtitle timestamps&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-using-emacs-to-fix-automatically-generated-subtitle-timestamps">
<p>
I like how people are making more and more Emacs-related videos. I
think subtitles, transcripts, and show notes would go a long way to
helping people quickly search, skim, and squeeze these videos into
their day.
</p>

<p>
Youtube's automatically-generated subtitles overlap. I think some
players scroll the subtitles, but the ones I use just display them
in alternating positions. I like to have non-overlapping subtitles,
so here's some code that works with <a href="https://github.com/rndusr/subed">subed.el</a> to fix the timestamps.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-fix-timestamps</span> ()
  <span class="org-doc">"Change all ending timestamps to the start of the next subtitle."</span>
  (<span class="org-keyword">interactive</span>)
  (goto-char (point-max))
  (<span class="org-keyword">let</span> ((timestamp (subed-subtitle-msecs-start)))
    (<span class="org-keyword">while</span> (subed-backward-subtitle-time-start)
      (subed-set-subtitle-time-stop timestamp)
      (<span class="org-keyword">setq</span> timestamp (subed-subtitle-msecs-start)))))
</pre>
</div>

<p>
Then it's easy to <a href="https://sachachua.com/blog/2020/12/editing-subtitles-in-emacs-with-subed-with-synchronized-video-playback-through-mpv/">edit the subtitles</a> (punctuation, capitalization,
special terms), especially with the shortcuts for splitting and
merging subtitles.
</p>

<p>
For transcripts with starting and ending timestamps per paragraph, I
like using the merge shortcut to merge all the subtitles for a
paragraph together. Here's a sample: <a href="https://emacsconf.org/2020/talks/05/">https://emacsconf.org/2020/talks/05/</a>
</p>

<p>
Tonight I edited automatically-generated subtitles for a screencast
that was about 40 minutes long. The resulting file had 1157
captions, so about 2 seconds each. I finished it in about 80
minutes, pretty much the 2x speed that I've been seeing. I can
probably get a little faster if I figure out good workflows for:
</p>

<ul class="org-ul">
<li>jumping: avy muscle memory, maybe?</li>
<li>splitting things into sentences and phrases</li>
<li><p>
fixing common speech recognition errors (ex: emax -&gt; Emacs, which I handle with regex replaces; maybe a list of them?)
</p>

<p>
I experimented with making a hydra for this before, but thinking
about the keys to use slowed me down a bit and it didn't flow very
well. Might be worth tinkering with.
</p>

<p>
Transcribing from scratch takes me about 4-5x playtime. I haven't
tweaked out my workflow for that one yet because I've only
transcribed one talk with subed.el , and there's a pretty big
backlog of talks that already have automatically generated
subtitles to edit.
</p>

<p>
So that's another thing I (or other people) can occasionally do to
help out even if I don't have enough focused time to think about a
programming challenge or do a podcast myself. And I get to learn
more in the process, too. Fun!
</p></li>
</ul>
</div>
</div>
<div id="outline-container-word-level" class="outline-4">
<h4 id="word-level">Using word-level timing information when editing subtitles or captions in Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-word-level">
<div class="update" id="orgd4e5137">
<p>
2022-10-26: <a href="file:///blog/2022/10/subed-el-word-level-timing-improvements/">Merged word-level timing support into subed.el</a>, so I don't need my old caption functions.
</p>

</div>

<div class="update" id="orgd503988">
<p>
2022-04-18: Switched to using yt-dlp.
</p>

</div>

<p>
I like to split captions at logical points, such as at the end of a
phrase or sentence. At first, I used subed.el to play the video for
the caption, pausing it at the appropriate point and then calling
<code>subed-split-subtitle</code> to split at the playback position. Then I
modified <code>subed-split-subtitle</code> to split at the video position that's
proportional to the text position, so that it's roughly in the right
spot even if I'm not currently listening. That got me most of the way
to being able to quickly edit subtitles.
</p>

<p>
It turns out that word-level timing is actually available from YouTube
if I download the autogenerated SRV2 file using yt-dlp, which I
can do with the following function:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-caption-download-srv2</span> (id)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MID: "</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">subed-word-data</span>)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"v=</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&amp;]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> id) (<span class="org-keyword">setq</span> id (match-string 1 id)))
  (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"/tmp"</span>))
    (call-process <span class="org-string">"yt-dlp"</span> nil nil nil <span class="org-string">"--write-auto-sub"</span> <span class="org-string">"--write-sub"</span> <span class="org-string">"--no-warnings"</span> <span class="org-string">"--sub-lang"</span> <span class="org-string">"en"</span> <span class="org-string">"--skip-download"</span> <span class="org-string">"--sub-format"</span> <span class="org-string">"srv2"</span>
                  (concat <span class="org-string">"https://youtu.be/"</span> id))
    (subed-word-data-load-from-file (my-latest-file <span class="org-string">"/tmp"</span> <span class="org-string">"\\.srv2\\'"</span>))))
</pre>
</div>

<div class="update" id="orge703abd">
<p>
2022-10-26: I can also generate a SRV2-ish file using
torchaudio, which I can then load with
<code>subed-word-data-load-from-file</code>.
</p>

</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-caption-fix-common-errors</span> (data)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (mapc (<span class="org-keyword">lambda</span> (e)
                  (<span class="org-keyword">when</span> (string-match (concat <span class="org-string">"\\&lt;"</span> (regexp-opt (<span class="org-keyword">if</span> (listp e) (seq-remove (<span class="org-keyword">lambda</span> (s) (string= <span class="org-string">""</span> s)) e)
                                                                  (list e)))
                                              <span class="org-string">"\\&gt;"</span>)
                                      (alist-get 'text o))
                    (map-put! o 'text (replace-match (car (<span class="org-keyword">if</span> (listp e) e (list e))) t t (alist-get 'text o)))))
                my-subed-common-edits))
        data))
</pre>
</div>

<p>
Assuming I start editing from the beginning of the file, then the part
of the captions file after point is mostly unedited. That means I can
match the remainder of the current caption with the word-level timing
to try to figure out the time to use when splitting the subtitle,
falling back to the proportional method if the data is not available.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">subed-avy-set-up-actions</span> ()
  (<span class="org-keyword">interactive</span>)
  (make-local-variable 'avy-dispatch-alist)
  (add-to-list
   'avy-dispatch-alist
   (cons ?, 'subed-split-subtitle)))

(<span class="org-keyword">use-package</span> subed
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/proj/subed/subed"</span>
  <span class="org-builtin">:mode</span>
  ((<span class="org-string">"\\.vtt\\'"</span> . subed-vtt-mode)
   (<span class="org-string">"\\.srt\\'"</span> . subed-srt-mode)
   (<span class="org-string">"\\.ass\\'"</span> . subed-ass-mode))
  <span class="org-builtin">:init</span>
  (autoload 'subed-vtt-mode <span class="org-string">"subed-vtt"</span> nil t)
  (autoload 'subed-srt-mode <span class="org-string">"subed-srt"</span> nil t)
  (autoload 'subed-ass-mode <span class="org-string">"subed-ass"</span> nil t)
  (autoload 'subed-txt-mode <span class="org-string">"subed-txt"</span> nil t)
  (<span class="org-keyword">require</span> '<span class="org-constant">subed-autoloads</span>)
  <span class="org-builtin">:hook</span>
  (subed-mode . display-fill-column-indicator-mode)
  (subed-mode . subed-avy-set-up-actions)
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> subed-mode-map
        (<span class="org-string">"M-,"</span> . subed-split-subtitle)
        (<span class="org-string">"M-."</span> . subed-merge-dwim))
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Remember cursor position between sessions</span>
  (add-hook 'subed-mode-hook 'save-place-local-mode)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Some reasonable defaults</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Replay subtitles as you adjust their start or stop time with M-[, M-], M-{, or M-}</span>
  (add-hook 'subed-mode-hook 'subed-enable-replay-adjusted-subtitle)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Loop over subtitles</span>
  (add-hook 'subed-mode-hook 'subed-enable-loop-over-current-subtitle)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Show characters per second</span>
  (add-hook 'subed-mode-hook 'subed-enable-show-cps)
  (add-hook 'subed-mode-hook (<span class="org-keyword">lambda</span> () (remove-hook 'before-save-hook 'subed-sort t)))
  (<span class="org-keyword">with-eval-after-load</span> 'consult
    (advice-add 'consult-buffer <span class="org-builtin">:around</span>
                (<span class="org-keyword">lambda</span> (f <span class="org-type">&amp;rest</span> r)
                  (<span class="org-keyword">let</span> ((subed-auto-play-media nil))
                    (apply f r)))))

  )
</pre>
</div>

<p>
That way, I can use the word-level timing information for most of the
reformatting, but I can easily replay segments of the video if I'm
unsure about a word that needs to be changed.
</p>

<p>
If I want to generate a VTT based on the caption data, breaking it at
certain words, these functions help:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-caption-breaks</span>
  '(<span class="org-string">"the"</span> <span class="org-string">"this"</span> <span class="org-string">"we"</span> <span class="org-string">"we're"</span> <span class="org-string">"I"</span> <span class="org-string">"finally"</span> <span class="org-string">"but"</span> <span class="org-string">"and"</span> <span class="org-string">"when"</span>)
  <span class="org-doc">"List of words to try to break at."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-caption-make-groups</span> (list <span class="org-type">&amp;optional</span> threshold)
  (<span class="org-keyword">let</span> (result
        current-item
        done
        (current-length 0)
        (limit (<span class="org-keyword">or</span> threshold 70))
        (lower-limit 30)
        (break-regexp (concat <span class="org-string">"\\&lt;"</span> (regexp-opt my-caption-breaks) <span class="org-string">"\\&gt;"</span>)))
    (<span class="org-keyword">while</span> list
      (<span class="org-keyword">cond</span>
       ((null (car list)))
       ((string-match <span class="org-string">"^\n*$"</span> (alist-get 'text (car list)))
        (<span class="org-keyword">push</span> (cons '(text . <span class="org-string">" "</span>) (car list)) current-item)
        (<span class="org-keyword">setq</span> current-length (1+ current-length)))
       ((&lt; (+ current-length (length (alist-get 'text (car list)))) limit)
        (<span class="org-keyword">setq</span> current-item (cons (car list) current-item)
              current-length (+ current-length (length (alist-get 'text (car list))) 1)))
       (t (<span class="org-keyword">setq</span> done nil)
          (<span class="org-keyword">while</span> (not done)
          (<span class="org-keyword">cond</span>
           ((&lt; current-length lower-limit)
            (<span class="org-keyword">setq</span> done t))
           ((<span class="org-keyword">and</span> (string-match break-regexp (alist-get 'text (car current-item)))
                 (not (string-match break-regexp (alist-get 'text (cadr current-item)))))
            (<span class="org-keyword">setq</span> current-length (- current-length (length (alist-get 'text (car current-item)))))
            (<span class="org-keyword">push</span> (<span class="org-keyword">pop</span> current-item) list)
            (<span class="org-keyword">setq</span> done t))
           (t
            (<span class="org-keyword">setq</span> current-length (- current-length (length (alist-get 'text (car current-item)))))
            (<span class="org-keyword">push</span> (<span class="org-keyword">pop</span> current-item) list))))
          (<span class="org-keyword">push</span> nil list)
          (<span class="org-keyword">setq</span> result (cons (reverse current-item) result) current-item nil current-length 0)))
      (<span class="org-keyword">setq</span> list (cdr list)))
    (reverse result)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-caption-format-as-subtitle</span> (list <span class="org-type">&amp;optional</span> word-timing)
  <span class="org-doc">"Turn a LIST of the form (((start . ms) (end . ms) (text . s)) ...) into VTT.</span>
<span class="org-doc">If WORD-TIMING is non-nil, include word-level timestamps."</span>
  (format <span class="org-string">"%s --&gt; %s\n%s\n\n"</span>
          (subed-vtt--msecs-to-timestamp (alist-get 'start (car list)))
          (subed-vtt--msecs-to-timestamp (alist-get 'end (car (last list))))
          (s-trim (mapconcat (<span class="org-keyword">lambda</span> (entry)
                               (<span class="org-keyword">if</span> word-timing
                                   (format <span class="org-string">" &lt;%s&gt;%s"</span>
                                           (subed-vtt--msecs-to-timestamp (alist-get 'start entry))
                                           (string-trim (alist-get 'text entry)))
                                 (alist-get 'text entry)))
                             list <span class="org-string">""</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-caption-to-vtt</span> (<span class="org-type">&amp;optional</span> data)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-temp-file</span> <span class="org-string">"captions.vtt"</span>
    (insert <span class="org-string">"WEBVTT\n\n"</span>
            (mapconcat
             (<span class="org-keyword">lambda</span> (entry) (my-caption-format-as-subtitle entry))
             (my-caption-make-groups
              (<span class="org-keyword">or</span> data (my-caption-fix-common-errors subed-word-data--cache)))
             <span class="org-string">""</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-showing-captions" class="outline-4">
<h4 id="showing-captions">Showing captions</h4>
<div class="outline-text-4" id="text-showing-captions">
<p>
This tidbit displays a buffer with the text of the subtitles so that I can quickly skim it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-caption-show</span> (url)
  (<span class="org-keyword">interactive</span> (list
                (<span class="org-keyword">let</span> ((link (<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
                                 (org-element-context))))
                  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> link
                           (eq (org-element-type link) 'link))
                      (read-string (format <span class="org-string">"URL (%s): "</span> (org-element-property <span class="org-builtin">:raw-link</span> link)) nil nil
                                   (org-element-property <span class="org-builtin">:raw-link</span> link))
                    (read-string <span class="org-string">"URL: "</span>)))))
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (listp url) (org-element-property <span class="org-builtin">:raw-link</span> url)) (<span class="org-keyword">setq</span> url (org-element-property <span class="org-builtin">:raw-link</span> url)))
  (delete-other-windows)
  (split-window-right)
  (<span class="org-keyword">if</span> (string-match <span class="org-string">"http"</span> url)
      (<span class="org-keyword">with-current-buffer-window</span> <span class="org-string">"*Captions*"</span>
          'display-buffer-same-window
          nil
        (org-mode)
        (<span class="org-keyword">save-excursion</span>
          (my-org-insert-youtube-video-with-transcript url)))
    (<span class="org-keyword">unless</span> (file-exists-p (concat (file-name-sans-extension url) <span class="org-string">".vtt"</span>))
      (my-deepgram-recognize-audio url))
    (find-file (concat (file-name-sans-extension url) <span class="org-string">".vtt"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-edit-text" class="outline-4">
<h4 id="edit-text">Edit text</h4>
<div class="outline-text-4" id="text-edit-text">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defcustom</span> <span class="org-variable-name">my-subed-common-edits</span>
  '(<span class="org-string">"I"</span>
    <span class="org-string">"I've"</span>
    <span class="org-string">"I'm"</span>
    <span class="org-string">"Mendeley"</span>
    <span class="org-string">"JavaScript"</span>
    <span class="org-string">"RSS"</span>
    (<span class="org-string">"going to"</span> <span class="org-string">"gonna"</span>)
    (<span class="org-string">"want to"</span> <span class="org-string">"wanna"</span>)
    (<span class="org-string">"transient"</span> <span class="org-string">"transit"</span>)
    (<span class="org-string">""</span> <span class="org-string">"uh"</span> <span class="org-string">"um"</span>)
    (<span class="org-string">"Magit"</span> <span class="org-string">"maggot"</span>)
    (<span class="org-string">"Emacs"</span> <span class="org-string">"e-max"</span> <span class="org-string">"emex"</span> <span class="org-string">"emax"</span> <span class="org-string">"bmx"</span> <span class="org-string">"imax"</span>)
    (<span class="org-string">"Emacs News"</span> <span class="org-string">"emacs news"</span>)
    (<span class="org-string">"Emacs Lisp"</span> <span class="org-string">"emacs list"</span>)
    (<span class="org-string">"EmacsConf"</span> <span class="org-string">"emacs conf"</span> <span class="org-string">"imaxconf"</span>)
    (<span class="org-string">"ivy"</span> <span class="org-string">"iv"</span>)
    (<span class="org-string">"UI"</span> <span class="org-string">"ui"</span>)
    (<span class="org-string">"TECO"</span> <span class="org-string">"tico"</span>)
    (<span class="org-string">"org-roam"</span> <span class="org-string">"orgrim"</span> <span class="org-string">"orgrom"</span>)
    (<span class="org-string">"non-nil"</span> <span class="org-string">"non-nail"</span>)
    (<span class="org-string">"commits"</span> <span class="org-string">"comets"</span>)
    <span class="org-string">"SQL"</span>
    <span class="org-string">"arXiv"</span>
    <span class="org-string">"Montessori"</span>
    <span class="org-string">"SVG"</span>
    <span class="org-string">"YouTube"</span> <span class="org-string">"GitHub"</span> <span class="org-string">"GitLab"</span> <span class="org-string">"OmegaT"</span> <span class="org-string">"Linux"</span> <span class="org-string">"SourceForge"</span>
    <span class="org-string">"LaTeX"</span>
    <span class="org-string">"Lisp"</span>
    <span class="org-string">"Org"</span>
    <span class="org-string">"IRC"</span>
    <span class="org-string">"Reddit"</span>
    <span class="org-string">"PowerPoint"</span>
    <span class="org-string">"SQLite"</span>
    <span class="org-string">"SQL"</span>
    <span class="org-string">"I'll"</span>
    <span class="org-string">"I'd"</span>
    <span class="org-string">"PDFs"</span>
    <span class="org-string">"PDF"</span>
    <span class="org-string">"ASCII"</span>
    (<span class="org-string">"Spacemacs"</span> <span class="org-string">"spacemax"</span>)
    <span class="org-string">"Elisp"</span>
    <span class="org-string">"Reddit"</span>
    <span class="org-string">"TextMate"</span>
    <span class="org-string">"macOS"</span>
    <span class="org-string">"API"</span>
    <span class="org-string">"IntelliSense"</span>
    (<span class="org-string">"EXWM"</span> <span class="org-string">"axwm"</span>)
    (<span class="org-string">"Emacs's"</span> <span class="org-string">"emax's"</span>)
    (<span class="org-string">"BIDI"</span> <span class="org-string">"bd"</span>)
    (<span class="org-string">"Perso-Arabic"</span> <span class="org-string">"personal arabic"</span>)
    <span class="org-string">"Persian"</span>
    <span class="org-string">"URL"</span>
    <span class="org-string">"HTML"</span>
    (<span class="org-string">"vdo.ninja"</span> <span class="org-string">"Video Ninja"</span>))
  <span class="org-doc">"Commonly-misrecognized words or words that need special capitalization."</span>
  <span class="org-builtin">:group</span> 'sachac
  <span class="org-builtin">:type</span> '(repeat (choice string
                         (repeat string))))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-add-common-edit</span> (beg end replacement)
  <span class="org-doc">"Add this word to the misrecognized words."</span>
  (<span class="org-keyword">interactive</span>
   (<span class="org-keyword">let</span> ((beg (<span class="org-keyword">if</span> (region-active-p) (min (point) (mark))
                (skip-syntax-backward <span class="org-string">"w"</span>)
                (point)))
         (end (<span class="org-keyword">if</span> (region-active-p) (max (point) (mark))
                (<span class="org-keyword">save-excursion</span> (forward-word 1) (point)))))
     (list beg end
           (completing-read
            (format <span class="org-string">"Replacement (%s): "</span> (buffer-substring beg end))
            (mapcar (<span class="org-keyword">lambda</span> (o) (<span class="org-keyword">if</span> (stringp o) o (car o))) my-subed-common-edits)))))
  (customize-set-variable
   'my-subed-common-edits
   (<span class="org-keyword">cond</span>
    ((member replacement my-subed-common-edits)
     (cons (list replacement (buffer-substring-no-properties beg end))
           (delete replacement my-subed-common-edits)))
    ((assoc replacement my-subed-common-edits)
     (setcdr (assoc replacement my-subed-common-edits)
             (append (list replacement) (cdr (assoc replacement my-subed-common-edits))))
     my-subed-common-edits)
    (t
     (<span class="org-keyword">push</span> (list replacement (buffer-substring-no-properties beg end))
           my-subed-common-edits))))
  (delete-region beg end)
  (insert replacement))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-find-next-fix-point</span> ()
  (<span class="org-keyword">when</span> (re-search-forward
         (format <span class="org-string">"\\&lt;</span><span class="org-string"><span class="org-variable-name">%s\\</span></span><span class="org-string">&gt;"</span>
                 (downcase
                  (regexp-opt (seq-mapcat
                               (<span class="org-keyword">lambda</span> (o)
                                 (<span class="org-keyword">if</span> (listp o)
                                     (<span class="org-keyword">if</span> (string= (car o) <span class="org-string">""</span>) (cdr o) o)
                                   (list o)))
                               my-subed-common-edits))))
         nil t)
    (goto-char (match-beginning 0))
    (seq-find (<span class="org-keyword">lambda</span> (o)
                (<span class="org-keyword">if</span> (listp o)
                    (seq-find (<span class="org-keyword">lambda</span> (s) (string= (downcase s) (downcase (match-string 0)))) o)
                  (string= (downcase o) (downcase (match-string 0)))))
              my-subed-common-edits)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-fix-common-error</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((entry (my-subed-find-next-fix-point)))
    (replace-match (<span class="org-keyword">if</span> (listp entry) (car entry) entry) t t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-fix-common-errors</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (done entry correction)
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span>
            (not done)
            (<span class="org-keyword">setq</span> entry (my-subed-find-next-fix-point)))
      (<span class="org-keyword">setq</span> correction (<span class="org-keyword">if</span> (listp entry) (car entry) entry))
      (<span class="org-keyword">let*</span> ((c (read-char (format <span class="org-string">"%s (yn.): "</span> correction))))
        (<span class="org-keyword">cond</span>
         ((= c ?y) (replace-match correction t t))
         ((= c ?n) (goto-char (match-end 0)))
         ((= c ?j) (subed-mpv-jump-to-current-subtitle))
         ((= c ?.) (<span class="org-keyword">setq</span> done t)))
        ))))
</pre>
</div>
</div>
</div>
<div id="outline-container-working-with-media" class="outline-4">
<h4 id="working-with-media">Working with media</h4>
<div class="outline-text-4" id="text-working-with-media">
<p>
You can get these from <a href="https://github.com/sachac">https://github.com/sachac</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> waveform <span class="org-builtin">:load-path</span> <span class="org-string">"~/proj/waveform-el"</span> <span class="org-builtin">:if</span> my-laptop-p)
(<span class="org-keyword">use-package</span> compile-media <span class="org-builtin">:load-path</span> <span class="org-string">"~/proj/compile-media"</span> <span class="org-builtin">:if</span> my-laptop-p
)
</pre>
</div>
</div>
</div>
<div id="outline-container-org7bab297" class="outline-4">
<h4 id="org7bab297"><span class="todo TODO">TODO</span> Working with sections defined by NOTE comments</h4>
<div class="outline-text-4" id="text-org7bab297">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-group-sections</span> (subtitles)
  <span class="org-doc">"Return a list of ((:comment ... :start-ms ... :stop-ms ... :subtitles ...) ...)."</span>
  (reverse
   (seq-reduce (<span class="org-keyword">lambda</span> (prev val)
                 (<span class="org-keyword">if</span> (elt val 4)
                     (cons
                      (list <span class="org-builtin">:comment</span> (elt val 4)
                            <span class="org-builtin">:start-ms</span> (elt val 1)
                            <span class="org-builtin">:stop-ms</span> (elt val 2)
                            <span class="org-builtin">:subtitles</span> (list val))
                      prev)
                   (<span class="org-keyword">when</span> (&gt; (elt val 2) (plist-get (car prev) <span class="org-builtin">:stop-ms</span>))
                     (setcar prev (plist-put (car prev) <span class="org-builtin">:stop-ms</span> (elt val 2))))
                   (setcar
                    prev
                    (plist-put (car prev) <span class="org-builtin">:subtitles</span> (nconc (plist-get (car prev) <span class="org-builtin">:subtitles</span>)
                                                            (list val))))
                   prev))
               (cdr subtitles)
               (list
                (list <span class="org-builtin">:comment</span> (elt (car subtitles) 4)
                      <span class="org-builtin">:start-ms</span> (elt (car subtitles) 1)
                      <span class="org-builtin">:stop-ms</span> (elt (car subtitles) 2)
                      <span class="org-builtin">:subtitles</span> (list (car subtitles)))))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-subed-group-sections</span> ()
 (should
  (equal (my-subed-group-sections '((nil 0 99 <span class="org-string">"Test"</span> <span class="org-string">"Intro"</span>)
                                    (nil 100 199 <span class="org-string">"A"</span>)
                                    (nil 200 299 <span class="org-string">"B"</span> <span class="org-string">"Conclusion"</span>)
                                    (nil 300 399 <span class="org-string">"C"</span>)
                                    (nil 400 499 <span class="org-string">"D"</span>)))
         '((<span class="org-builtin">:comment</span> <span class="org-string">"Intro"</span> <span class="org-builtin">:start-ms</span> 0 <span class="org-builtin">:stop-ms</span> 199
                     <span class="org-builtin">:subtitles</span>
                     ((nil 0 99 <span class="org-string">"Test"</span> <span class="org-string">"Intro"</span>)
                      (nil 100 199 <span class="org-string">"A"</span>)))
           (<span class="org-builtin">:comment</span> <span class="org-string">"Conclusion"</span> <span class="org-builtin">:start-ms</span> 200 <span class="org-builtin">:stop-ms</span> 499
                     <span class="org-builtin">:subtitles</span>
                     ((nil 200 299 <span class="org-string">"B"</span> <span class="org-string">"Conclusion"</span>)
                      (nil 300 399 <span class="org-string">"C"</span>) (nil 400 499 <span class="org-string">"D"</span>)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-mark-section</span> ()
  <span class="org-doc">"Return the start and end of the current section.</span>
<span class="org-doc">The current section is defined by NOTE comments."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((start
          (<span class="org-keyword">save-excursion</span>
            (<span class="org-keyword">if</span> (subed-subtitle-comment)
                (<span class="org-keyword">progn</span> (subed-jump-to-subtitle-comment) (point))
              <span class="org-comment-delimiter">;; </span><span class="org-comment">keep going backwards</span>
              (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not (bobp))
                          (<span class="org-keyword">if</span> (subed-backward-subtitle-start-pos)
                              (not (subed-subtitle-comment))
                            (goto-char (point-min)))))
              (subed-jump-to-subtitle-comment)
              (point))))
         (end
          (<span class="org-keyword">save-excursion</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">keep going backwards</span>
            (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not (eobp))
                        (<span class="org-keyword">if</span> (subed-forward-subtitle-start-pos)
                            (not (subed-jump-to-subtitle-comment))
                          (goto-char (point-max)))))
            (subed-jump-to-subtitle-comment))))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> start end)
      (push-mark start)
      (goto-char end)
      (activate-mark))))
</pre>
</div>
</div>
</div>
<div id="outline-container-split-up-oops-better" class="outline-4">
<h4 id="split-up-oops-better"><span class="todo TODO">TODO</span> Split up oops better</h4>
<div class="outline-text-4" id="text-split-up-oops-better">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-split-oops</span> ()
  <span class="org-doc">"Look for oops and make it easier to split."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((scan-window 300))
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"oops[,</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">.]?[ \n]+"</span> nil t)
      (<span class="org-keyword">let</span> ((start (min (line-beginning-position) (- (point) scan-window)))
            start-search
            found
            search-for)
        (<span class="org-keyword">if</span> (bolp)
            (<span class="org-keyword">progn</span>
              (backward-char)
              (<span class="org-keyword">setq</span> start (min (line-beginning-position) (- (point) scan-window))))
          (insert <span class="org-string">"\n"</span>))
        (<span class="org-keyword">save-excursion</span>
          (<span class="org-keyword">setq</span> start-search (point))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">look for 1..5 words back</span>
          (goto-char
           (<span class="org-keyword">or</span>
            (<span class="org-keyword">cl-loop</span>
             for n downfrom 5 downto 1
             do
             (<span class="org-keyword">save-excursion</span>
               (<span class="org-keyword">dotimes</span> (_ n) (forward-word))
               (<span class="org-keyword">setq</span> search-for (downcase (string-trim (buffer-substring start-search (point)))))
               (goto-char start-search)
               (<span class="org-keyword">when</span> (re-search-backward (regexp-quote search-for) start t)
                 (goto-char (match-beginning 0))
                 (<span class="org-keyword">cl-return</span> (point)))))
            (<span class="org-keyword">and</span> (call-interactively 'isearch-backward) (point))))
          (insert <span class="org-string">"\n"</span>))))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> subed-align-options <span class="org-string">"task_adjust_boundary_offset_percent=0.5"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-delete-oops</span> (<span class="org-type">&amp;optional</span> skip-only)
  (<span class="org-keyword">interactive</span> (list current-prefix-arg))
  (<span class="org-keyword">atomic-change-group</span>
    (subed-for-each-subtitle (point-min) (point-max) t
      (<span class="org-keyword">when</span> (string-match <span class="org-string">"\\boops\\b"</span> (subed-subtitle-text))
        (<span class="org-keyword">if</span> skip-only
            (subed-set-subtitle-comment <span class="org-string">"#+SKIP"</span>)
          (subed-kill-subtitle))))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-subed-delete-oops</span> ()
  (<span class="org-keyword">let</span> ((test '((nil 0 99 <span class="org-string">"Hello"</span>)
                (nil 100 199 <span class="org-string">"Hello oops"</span>)
                (nil 200 299 <span class="org-string">"Hello world"</span>)
                (nil 299 300 <span class="org-string">"Hello again oops"</span>))))
    (should
     (equal
      (<span class="org-keyword">with-temp-buffer</span>
        (subed-vtt-mode)
        (subed-append-subtitle-list test)
        (my-subed-delete-oops)
        (subed-subtitle-list-text (subed-subtitle-list) t))
      <span class="org-string">"Hello\nHello world\n"</span>))
    (should
     (equal
      (<span class="org-keyword">with-temp-buffer</span>
        (subed-vtt-mode)
        (subed-append-subtitle-list test)
        (my-subed-delete-oops t)
        (subed-subtitle-list-text (subed-subtitle-list) t))
      <span class="org-string">"Hello\n\n#+SKIP\n\nHello oops\nHello world\n\n#+SKIP\n\nHello again oops\n"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-skip-oops</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-subed-delete-oops t))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-record-wpm</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((wpm (subed-wpm
              (seq-remove (<span class="org-keyword">lambda</span> (o) (<span class="org-keyword">and</span> (elt o 4) (string-match <span class="org-string">"skip"</span> (elt o 4))))
                          (subed-subtitle-list)))))
    (apply 'message
            <span class="org-string">"%d wpm (%d words / %.1f minutes)"</span> wpm)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-prepare-for-cleaning</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-subed-delete-oops)
  (goto-char (point-min))
  (subed-forward-subtitle-id)
  (subed-set-subtitle-comment (concat <span class="org-string">"#+OUTPUT: "</span> (file-name-sans-extension (buffer-file-name)) <span class="org-string">"-cleaned.opus"</span>)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-phone-recording-dir</span> <span class="org-string">"~/sync/Phone"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-copy-recording</span> (filename destination)
  (<span class="org-keyword">interactive</span>
   (list
    (buffer-file-name)
    (file-name-directory
     (read-file-name (format <span class="org-string">"Copy %s to: "</span>
                             (file-name-base (buffer-file-name)))
                     nil nil nil nil #'file-directory-p))))
  (<span class="org-keyword">dolist</span> (ext '(<span class="org-string">"m4a"</span> <span class="org-string">"txt"</span> <span class="org-string">"json"</span> <span class="org-string">"vtt"</span>))
    (<span class="org-keyword">when</span> (file-exists-p (concat (file-name-sans-extension filename) <span class="org-string">"."</span> ext))
      (copy-file (concat (file-name-sans-extension filename) <span class="org-string">"."</span> ext)
                 destination t)))
  (<span class="org-keyword">when</span> (get-file-buffer filename)
    (kill-buffer (get-file-buffer filename))
    (dired destination)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-copy-latest-phone-recording</span> (destination)
  <span class="org-doc">"Copy the latest recording transcript and audio to DESTINATION."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (file-name-directory
     (read-file-name (format <span class="org-string">"Move %s to: "</span>
                             (file-name-base (my-latest-file my-phone-recording-dir <span class="org-string">".txt"</span>)))
                     nil nil nil nil #'file-directory-p))))
  (<span class="org-keyword">let</span> ((base (file-name-base (my-latest-file my-phone-recording-dir <span class="org-string">".txt"</span>))))
    (rename-file (expand-file-name (concat base <span class="org-string">".txt"</span>) my-phone-recording-dir)
                 destination)
    (rename-file (expand-file-name (concat base <span class="org-string">".m4a"</span>) my-phone-recording-dir)
                 destination)
    (find-file (expand-file-name (concat base <span class="org-string">".txt"</span>) destination))
    (<span class="org-keyword">save-excursion</span> (my-split-oops))
    (goto-char (point-min))
    (flush-lines <span class="org-string">"^$"</span>)
    (goto-char (point-min))
    (subed-forward-subtitle-id)
    (subed-set-subtitle-comment
     (concat <span class="org-string">"#+OUTPUT: "</span>
             (file-name-base (buffer-file-name))
             <span class="org-string">"-cleaned.opus"</span>))))



</pre>
</div>
</div>
</div>
<div id="outline-container-org-youtube-captions" class="outline-4">
<h4 id="org-youtube-captions"><span class="todo TODO">TODO</span> Org Mode: Insert YouTube video with separate captions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-org-youtube-captions">
<p>
I'm playing around with some ideas for making it easier to post a
video with its captions on a webpage or in an Org file so that it's
easier to skim or search.
</p>

<p>
This requires the <code>yt-dlp</code> command. I'm also learning how to use
<code>dash.el</code>'s threading macro, so you'll need to install that as well if
you want to run it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">dash</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-msecs-to-timestamp</span> (msecs)
  <span class="org-doc">"Convert MSECS to string in the format HH:MM:SS.MS."</span>
  (concat (format-seconds <span class="org-string">"%02h:%02m:%02s"</span> (/ msecs 1000))
          <span class="org-string">"."</span> (format <span class="org-string">"%03d"</span> (mod msecs 1000))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-youtube-video-with-transcript</span> (url)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MURL: "</span>)
  (<span class="org-keyword">let*</span> ((id (<span class="org-keyword">if</span> (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">v=</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">youtu\\.be/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&amp;]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> url) (match-string 1 url) url))
         (temp-file (make-temp-name <span class="org-string">"org-youtube-"</span>))
         (temp-file-name (concat temp-file <span class="org-string">".en.srv1"</span>))
         data)
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (call-process <span class="org-string">"yt-dlp"</span> nil nil nil
                             <span class="org-string">"--write-sub"</span> <span class="org-string">"--write-auto-sub"</span>  <span class="org-string">"--no-warnings"</span> <span class="org-string">"--sub-lang"</span> <span class="org-string">"en"</span> <span class="org-string">"--skip-download"</span> <span class="org-string">"--sub-format"</span> <span class="org-string">"srv1"</span>
                             <span class="org-string">"-o"</span> temp-file
                             (format <span class="org-string">"https://youtube.com/watch?v=%s"</span> id))
               (file-exists-p temp-file-name))
      (insert
       (format <span class="org-string">"#+begin_export html</span>
<span class="org-string">&lt;iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/%s\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen&gt;&lt;/iframe&gt;\n#+end_export\n"</span> id)
       <span class="org-string">"\n"</span>
       (mapconcat (<span class="org-keyword">lambda</span> (o)
                    (format <span class="org-string">"| [[https://youtube.com/watch?v=%s&amp;t=%ss][%s]] | %s |\n"</span>
                            id
                            (<span class="org-keyword">dom-attr</span> o 'start)
                            (my-msecs-to-timestamp (* 1000 (string-to-number (<span class="org-keyword">dom-attr</span> o 'start))))
                            (-&gt;&gt; (dom-text o)
                                 (replace-regexp-in-string <span class="org-string">"[ \n]+"</span> <span class="org-string">" "</span>)
                                 (replace-regexp-in-string <span class="org-string">"&amp;#39;"</span> <span class="org-string">"'"</span>)
                                 (replace-regexp-in-string <span class="org-string">"&amp;quot;"</span> <span class="org-string">"\""</span>))))
                  (dom-by-tag (xml-parse-file temp-file-name) 'text)
                  <span class="org-string">""</span>))
      (delete-file temp-file-name))))
</pre>
</div>

<p>
It makes an embedded Youtube video and a table with captions below it.
The Org file doesn't look too bad, either.
</p>


<figure id="orgd2739d9">
<img src="https://sachachua.com/blog/wp-content/uploads/2021/04/Screenshot_20210401_234956.png" alt="Screenshot_20210401_234956.png">

</figure>

<p>
I decided to stick to standard Org syntax so that I can read it in
Emacs too. With the current implementation, clicking on the timestamps
jumps to that position in the video, but on the Youtube website. I
haven't coded anything fancy like keeping the embedded video at a
fixed position, controlling it from the clicks, or highlighting the
current position. It's a start, though!
</p>

<p>
Here's the output of running it with my talk from the last EmacsConf.
</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/RuK7lv1uyRo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=0s">00:00:00.000</a></td>
<td class="org-left">I'm Sacha Chua, and welcome to EmacsConf 2020.</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=4s">00:00:04.000</a></td>
<td class="org-left">To kick things off, here are ten cool things</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=7s">00:00:07.000</a></td>
<td class="org-left">that people have been working on</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=8s">00:00:08.000</a></td>
<td class="org-left">since the conference last year.</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=10s">00:00:10.000</a></td>
<td class="org-left">If you want to follow the links</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=11s">00:00:11.000</a></td>
<td class="org-left">or if you'd like to add something I've missed,</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=14s">00:00:14.000</a></td>
<td class="org-left">add them to the collaborative pad</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=16s">00:00:16.000</a></td>
<td class="org-left">if you're watching this live</td>
</tr>

<tr>
<td class="org-left"><a href="https://youtube.com/watch?v=RuK7lv1uyRo&amp;t=17s">00:00:17.000</a></td>
<td class="org-left">or check out the EmacsConf wiki page for this talk.</td>
</tr>
</tbody>
</table>

<p>
&#x2026; (omitted for brevity)
</p>
</div>
</div>
<div id="outline-container-orge0664c0" class="outline-4">
<h4 id="orge0664c0">Export transcript as list</h4>
<div class="outline-text-4" id="text-orge0664c0">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cl-defun</span> <span class="org-function-name">my-subed-as-org-list-with-times</span> (file <span class="org-type">&amp;key</span> from to)
  (<span class="org-keyword">when</span> (stringp from) (<span class="org-keyword">setq</span> from (compile-media-timestamp-to-msecs from)))
  (<span class="org-keyword">when</span> (stringp to) (<span class="org-keyword">setq</span> to (compile-media-timestamp-to-msecs to)))
  (mapconcat
   (<span class="org-keyword">lambda</span> (o)
     (format <span class="org-string">"- @@html:&lt;span class=\"audio-time\" data-start=\"%.3f\" data-stop=\"%.3f\"&gt;%s&lt;/span&gt;@@: *%s*:\n  %s\n\n"</span>
       (/ (plist-get o <span class="org-builtin">:start-ms</span>) 1000.0)
       (/ (plist-get o <span class="org-builtin">:stop-ms</span>) 1000.0)
       (replace-regexp-in-string <span class="org-string">"^00:0?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\.[0-9]+$"</span> <span class="org-string">""</span> (my-msecs-to-timestamp (plist-get o <span class="org-builtin">:start-ms</span>)))
       (plist-get o <span class="org-builtin">:comment</span>)
       (string-trim (replace-regexp-in-string
         <span class="org-string">"[ \n]+"</span> <span class="org-string">" "</span>
         (subed-subtitle-list-text (plist-get o <span class="org-builtin">:subtitles</span>))))))
   (my-subed-group-sections
    (seq-filter (<span class="org-keyword">lambda</span> (sub)
      (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> (not from) (&gt;= (elt sub 1) from))
           (<span class="org-keyword">or</span> (not to) (&lt; (elt sub 2) to))))
    (subed-parse-file file)))
   <span class="org-string">""</span>))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-transcripts-from-my-phone" class="outline-3">
<h3 id="transcripts-from-my-phone">Transcripts from my phone</h3>
<div class="outline-text-3" id="text-transcripts-from-my-phone">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-audio-braindump-dir</span> <span class="org-string">"~/sync/Phone"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-latest-braindump</span> ()
  (<span class="org-keyword">interactive</span>)
  (find-file (my-latest-file my-audio-braindump-dir <span class="org-string">"\\.txt"</span>))
  (kill-new (buffer-string)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-latest-braindump</span> ()
  (<span class="org-keyword">interactive</span>)
  (insert-file-contents (my-latest-file my-audio-braindump-dir <span class="org-string">"\\.txt"</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-dired</span> ()
  (<span class="org-keyword">interactive</span>)
  (dired my-audio-braindump-dir <span class="org-string">"-lt"</span>))
(<span class="org-keyword">defalias</span> '<span class="org-function-name">my-phone-dired</span> #'my-audio-braindump-dired)
</pre>
</div>
</div>
</div>
<div id="outline-container-speech-recognition" class="outline-3">
<h3 id="speech-recognition">Speech recognition</h3>
<div class="outline-text-3" id="text-speech-recognition">
</div>
<div id="outline-container-using-emacs-lisp-to-send-audio-files-to-deepgram-and-format-vtts" class="outline-4">
<h4 id="using-emacs-lisp-to-send-audio-files-to-deepgram-and-format-vtts">TOBLOG Using Emacs Lisp to send audio files to Deepgram and format VTTs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="speech">speech</span></span></h4>
<div class="outline-text-4" id="text-using-emacs-lisp-to-send-audio-files-to-deepgram-and-format-vtts">
<p>
I've been experimenting with Deepgram's API for speech
recognition because it can handle larger files than OpenAI
Whisper's API, so I don't have to worry about chunking my
files into 15-minute segments. It also supports diarization,
which means identifying different speakers. That's handy for
things like the EmacsConf Q&amp;A sessions, which involve
multiple people.
</p>

<p>
I think the built-in VTT formatter doesn't handle speaker
identification, so I wrote some Emacs Lisp to send an audio
file for recognition, save the JSON, and format the results
as a VTT subtitle file. I also split the captions a little
closer to the way I like to do them, starting a new subtitle
if the line exceeds <code>my-deepgram-length-threshold</code> or
<code>my-deepgram-time-threshold</code>, or if we're after a punctuated
word and the current subtitle is more than halfway to the
length threshold. Someday I'll figure out how to get it to
split on prepositions.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-deepgram-length-threshold</span> 45 <span class="org-doc">"Number of characters."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-deepgram-time-threshold</span> 10 <span class="org-doc">"Number of seconds since the first word."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-deepgram-recognize-audio</span> (audio-file <span class="org-type">&amp;optional</span> diarize)
  <span class="org-doc">"Send AUDIO-FILE to Deepgram, save the JSON, and create a VTT.</span>
<span class="org-doc">If DIARIZE is non-nil, identify speakers."</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">subed</span>)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> (auth-info-password (car (auth-source-search <span class="org-builtin">:host</span> <span class="org-string">"https://api.deepgram.com"</span>)))
                         (read-file-name <span class="org-string">"Audio file: "</span>)
                       (<span class="org-warning">error</span> <span class="org-string">"Please put deepgram API key in auth sources."</span>))))
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Deepgram*"</span>)
    (erase-buffer)
    (<span class="org-keyword">unless</span> (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">opus</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">wav</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">mp3</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> audio-file)
      (<span class="org-keyword">if</span> (file-exists-p (concat (file-name-sans-extension audio-file) <span class="org-string">".opus"</span>))
          (<span class="org-keyword">setq</span> audio-file (concat (file-name-sans-extension audio-file) <span class="org-string">".opus"</span>))
        (call-process <span class="org-string">"ffmpeg"</span> nil t t <span class="org-string">"-i"</span> (expand-file-name audio-file)
                      <span class="org-string">"-ac"</span> <span class="org-string">"1"</span> <span class="org-string">"-y"</span>
                      (expand-file-name (concat (file-name-sans-extension audio-file) <span class="org-string">".opus"</span>)))
        (<span class="org-keyword">setq</span> audio-file (concat (file-name-sans-extension audio-file) <span class="org-string">".opus"</span>))))
    (<span class="org-keyword">unless</span> (file-exists-p (expand-file-name (concat (file-name-sans-extension audio-file) <span class="org-string">".json"</span>)))
      (call-process
       <span class="org-string">"curl"</span> nil t t <span class="org-string">"--request"</span> <span class="org-string">"POST"</span> <span class="org-string">"--header"</span>
       (concat <span class="org-string">"Authorization: Token "</span> (auth-info-password (car (auth-source-search <span class="org-builtin">:host</span> <span class="org-string">"https://api.deepgram.com"</span>))))
       <span class="org-string">"--header"</span> (concat <span class="org-string">"Content-Type: "</span> (mailcap-file-name-to-mime-type audio-file))
       <span class="org-string">"--data-binary"</span> (concat <span class="org-string">"@"</span> (expand-file-name audio-file))
       <span class="org-string">"--url"</span>
       (concat
        <span class="org-string">"https://api.deepgram.com/v1/listen?punctuate=true&amp;model=whisper-large&amp;smart_format=true&amp;utterances=true"</span>
        (<span class="org-keyword">if</span> diarize
            <span class="org-string">"&amp;diarize=true"</span>
          <span class="org-string">""</span>))
       <span class="org-string">"-o"</span>
       (expand-file-name (concat (file-name-sans-extension audio-file) <span class="org-string">".json"</span>))))
    (my-deepgram-convert-json-to-vtt (concat (file-name-sans-extension audio-file) <span class="org-string">".json"</span>)))
  (find-file (concat (file-name-sans-extension audio-file) <span class="org-string">".vtt"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-emacsconf-extract-deepgram-recognize-qa-for-talk</span> (talk)
  <span class="org-doc">"Send the QA (or main) Opus file for TALK to Deepgram.</span>
<span class="org-doc">Save the results as JSON and VTT."</span>
  (<span class="org-keyword">interactive</span> (list (emacsconf-complete-talk-info)))
  (<span class="org-keyword">setq</span> talk (emacsconf-resolve-talk talk))
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (emacsconf-talk-file talk <span class="org-string">"--answers--original.json"</span>)
          (emacsconf-talk-file talk <span class="org-string">"--original.json"</span>))
      (message <span class="org-string">"Files already exist for %s"</span> (plist-get talk <span class="org-builtin">:slug</span>))
      (<span class="org-keyword">if-let</span> ((file
                (<span class="org-keyword">or</span> (emacsconf-talk-file talk <span class="org-string">"--answers--original.opus"</span>)
                    (emacsconf-talk-file talk <span class="org-string">"--original.opus"</span>))))
          (my-deepgram-recognize-audio file)
        (<span class="org-warning">error</span> <span class="org-string">"No file to recognize for %s"</span> (plist-get talk <span class="org-builtin">:slug</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-deepgram-parse</span> (json-file)
  <span class="org-doc">"Convert JSON-FILE into a list of subtitles."</span>
  (<span class="org-keyword">let*</span> ((json-object-type 'alist)
         (json (json-read-file json-file))
         (words
          (assoc-default
           'words
           (aref (assoc-default 'alternatives (aref (<span class="org-keyword">let-alist</span> json .results.channels) 0)) 0)))
         (halfway-length (/ my-deepgram-length-threshold 2))
         subtitles
         current
         current-length
         last-speaker
         last-text
         current-text)
    (<span class="org-keyword">dolist</span> (speaker (seq-group-by (<span class="org-keyword">lambda</span> (o) (assoc-default 'speaker o)) words))
      (<span class="org-keyword">setq</span> current-length 0 current nil)
      (<span class="org-keyword">dolist</span> (word (cdr speaker))
        (<span class="org-keyword">let-alist</span> word
          <span class="org-comment-delimiter">;; </span><span class="org-comment">determine whether we are adding to the existing one.</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">start a new one if length &gt; length-threshold</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">or time &gt; time-threshold</span>
          (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (&gt; (+ (length .punctuated_word)
                          current-length)
                       my-deepgram-length-threshold)
                    (<span class="org-keyword">and</span> (car current)
                         (&gt; .start (+ (assoc-default 'start (car current))
                                      my-deepgram-time-threshold))))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">copy the previous subtitle</span>
            (<span class="org-keyword">push</span> current subtitles)
            (<span class="org-keyword">setq</span> current nil current-length 0))
          (<span class="org-keyword">push</span> word current)
          (<span class="org-keyword">setq</span> current-length (+ (length .punctuated_word) current-length 1))
          (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string-match <span class="org-string">"[,\\.?]"</span> .punctuated_word)
                     (&gt; current-length halfway-length))
            (<span class="org-keyword">push</span> current subtitles)
            (<span class="org-keyword">setq</span> current nil current-length 0))))
      (<span class="org-keyword">when</span> current (<span class="org-keyword">push</span> current subtitles)))
    (seq-keep
     (<span class="org-keyword">lambda</span> (entry)
       (<span class="org-keyword">setq</span> current-text
             (mapconcat (<span class="org-keyword">lambda</span> (w) (assoc-default 'punctuated_word w))
                        (reverse entry) <span class="org-string">" "</span>))
       (<span class="org-keyword">when</span> (not (string= (downcase current-text) (<span class="org-keyword">or</span> last-text <span class="org-string">""</span>)))
         (<span class="org-keyword">setq</span> last-text (downcase current-text))
         (list nil
               (* (assoc-default 'start (car (last entry)) nil 0) 1000)
               (* (assoc-default 'end (car entry) nil 0) 1000)
               <span class="org-comment-delimiter">;; </span><span class="org-comment">add speaker tag?</span>
               (concat
                (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (assoc-default 'speaker (car entry))
                         (<span class="org-keyword">or</span> (null last-speaker)
                             (not (eq last-speaker (assoc-default 'speaker (car entry))))))
                    (<span class="org-keyword">progn</span>
                      (<span class="org-keyword">setq</span> last-speaker (assoc-default 'speaker (car entry)))
                      (format <span class="org-string">"[Speaker %d]: "</span> (assoc-default 'speaker (car entry))))
                  <span class="org-string">""</span>)
                current-text
                ))))
     (sort subtitles
           (<span class="org-keyword">lambda</span> (a b)
             <span class="org-comment-delimiter">;; </span><span class="org-comment">sort by time</span>
             (&lt; (assoc-default 'start (car a) nil 0)
                (assoc-default 'start (car b) nil 0)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-deepgram-convert-json-to-vtt</span> (json-file <span class="org-type">&amp;optional</span> force)
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"JSON: "</span>) current-prefix-arg))
  <span class="org-string">"Convert JSON-FILE into a VTT."</span>
  (subed-create-file
   (concat (file-name-sans-extension json-file) <span class="org-string">".vtt"</span>)
   (my-deepgram-parse json-file)
   force))

(<span class="org-keyword">defconst</span> <span class="org-variable-name">deepgram-whisper-large-per-min</span> 0.0048)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-deepgram-cost</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FFile: "</span>)
  (<span class="org-keyword">let*</span> ((whisper-large-per-min deepgram-whisper-large-per-min)
         (nova2-streaming-per-min 0.0059)
         (duration (/ (ceiling (/ (compile-media-get-file-duration-ms file) 1000.0)) 60))
         (msg (format <span class="org-string">"%.1f minutes: USD %.2f batch, USD %.2f streaming"</span>
                      duration
                      (* duration whisper-large-per-min)
                      (* duration nova2-streaming-per-min))))
    (<span class="org-keyword">when</span> (called-interactively-p 'any)
      (message <span class="org-string">"%s"</span> msg)
      (kill-new msg))
    (list
     duration
     (* duration whisper-large-per-min)
     (* duration nova2-streaming-per-min))))
</pre>
</div>
</div>
</div>
<div id="outline-container-rerecognize" class="outline-4">
<h4 id="rerecognize">TOBLOG Rerecognize this audio and reprocess it</h4>
<div class="outline-text-4" id="text-rerecognize">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-audio-braindump-reprocess</span> (audio-file)
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">let</span> ((default (<span class="org-keyword">cond</span>
                    ((derived-mode-p 'org-mode)
                     (<span class="org-keyword">save-excursion</span>
                       (org-back-to-heading)
                       (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"\\[</span><span class="org-string"><span class="org-constant">Audio\\</span></span><span class="org-string">]"</span> nil (<span class="org-keyword">save-excursion</span> (org-end-of-subtree)))
                         (org-element-property <span class="org-builtin">:path</span> (org-element-context)))))
                    ((file-exists-p (concat (file-name-sans-extension (buffer-file-name)) <span class="org-string">".m4a"</span>))
                     (concat (file-name-sans-extension (buffer-file-name)) <span class="org-string">".m4a"</span>)))))
      (read-file-name (<span class="org-keyword">if</span> default (format <span class="org-string">"Audio (%s): "</span> default)
                        <span class="org-string">"Audio: "</span>)
                      nil default))))
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">unless</span> (file-exists-p (concat (file-name-sans-extension audio-file) <span class="org-string">".json"</span>))
      (my-deepgram-recognize-audio audio-file))
    (<span class="org-keyword">with-temp-file</span> (concat (file-name-sans-extension audio-file) <span class="org-string">".txt"</span>)
      (insert
       (subed-subtitle-list-text
        (my-deepgram-parse (concat (file-name-sans-extension audio-file) <span class="org-string">".json"</span>))))
      (goto-char (point-min))
      (my-audio-braindump-prepare-alignment-breaks))
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (concat (file-name-sans-extension audio-file) <span class="org-string">".txt"</span>))
      (subed-align audio-file (concat (file-name-sans-extension audio-file) <span class="org-string">".txt"</span>) <span class="org-string">"VTT"</span>)))
  (find-file my-audio-braindump-braindump-file)
  (goto-char (point-min))
  (my-audio-braindump-insert-subtitles-as-org-tree (concat (file-name-sans-extension audio-file) <span class="org-string">".vtt"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-gladia" class="outline-4">
<h4 id="gladia">Gladia</h4>
<div class="outline-text-4" id="text-gladia">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-gladia-parse</span> (json-file)
  <span class="org-doc">"Convert JSON-FILE into a list of subtitles."</span>
  (<span class="org-keyword">let*</span> ((json-object-type 'alist)
         (json (json-read-file json-file))
         (words
          (seq-mapcat (<span class="org-keyword">lambda</span> (pred) (seq-map (<span class="org-keyword">lambda</span> (w)
                                                (append
                                                 (list
                                                  (cons 'speaker (<span class="org-keyword">when</span> (not (string= <span class="org-string">"speaker_not_activated"</span> (assoc-default 'speaker pred)))
                                                                   (assoc-default 'speaker pred)))
                                                  (cons 'start (assoc-default 'time_begin pred))
                                                  (cons 'end (assoc-default 'time_end pred))
                                                  (cons 'punctuated_word (string-trim (assoc-default 'word w))))
                                                 w))
                                              (assoc-default 'words pred)))
                      (assoc-default 'prediction json)))
         (halfway-length (/ my-deepgram-length-threshold 2))
         subtitles
         current
         current-length
         last-speaker
         last-text
         current-text)
    (<span class="org-keyword">dolist</span> (speaker (seq-group-by (<span class="org-keyword">lambda</span> (o) (assoc-default 'speaker o)) words))
      (<span class="org-keyword">setq</span> current-length 0 current nil)
      (<span class="org-keyword">dolist</span> (word (cdr speaker))
        (<span class="org-keyword">let-alist</span> word
          <span class="org-comment-delimiter">;; </span><span class="org-comment">determine whether we are adding to the existing one.</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">start a new one if length &gt; length-threshold</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">or time &gt; time-threshold</span>
          (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (&gt; (+ (length .punctuated_word)
                          current-length)
                       my-deepgram-length-threshold)
                    (<span class="org-keyword">and</span> (car current)
                         (&gt; .start (+ (assoc-default 'start (car current))
                                      my-deepgram-time-threshold))))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">copy the previous subtitle</span>
            (<span class="org-keyword">push</span> current subtitles)
            (<span class="org-keyword">setq</span> current nil current-length 0))
          (<span class="org-keyword">push</span> word current)
          (<span class="org-keyword">setq</span> current-length (+ (length .punctuated_word) current-length 1))
          (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string-match <span class="org-string">"[,\\.?]"</span> .punctuated_word)
                     (&gt; current-length halfway-length))
            (<span class="org-keyword">push</span> current subtitles)
            (<span class="org-keyword">setq</span> current nil current-length 0))))
      (<span class="org-keyword">when</span> current (<span class="org-keyword">push</span> current subtitles)))
    (seq-keep
     (<span class="org-keyword">lambda</span> (entry)
       (<span class="org-keyword">setq</span> current-text
             (mapconcat (<span class="org-keyword">lambda</span> (w) (assoc-default 'punctuated_word w))
                        (nreverse entry) <span class="org-string">" "</span>))
       (<span class="org-keyword">when</span> (not (string= (downcase current-text) (<span class="org-keyword">or</span> last-text <span class="org-string">""</span>)))
         (<span class="org-keyword">setq</span> last-text (downcase current-text))
         (list nil
               (* (assoc-default 'start (car entry) nil 0) 1000)
               (* (assoc-default 'end (car (last entry)) nil 0) 1000)
               <span class="org-comment-delimiter">;; </span><span class="org-comment">add speaker tag?</span>
               (concat
                (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (assoc-default 'speaker (car entry))
                         (<span class="org-keyword">or</span> (null last-speaker)
                             (not (eq last-speaker (assoc-default 'speaker (car entry))))))
                    (<span class="org-keyword">progn</span>
                      (<span class="org-keyword">setq</span> last-speaker (assoc-default 'speaker (car entry)))
                      (format <span class="org-string">"[Speaker %s]: "</span> (assoc-default 'speaker (car entry))))
                  <span class="org-string">""</span>)
                current-text
                ))))
     (sort subtitles
           (<span class="org-keyword">lambda</span> (a b)
             <span class="org-comment-delimiter">;; </span><span class="org-comment">sort by time</span>
             (&lt; (assoc-default 'start (car a) nil 0)
                (assoc-default 'start (car b) nil 0)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-gladia-recognize-audio</span> (audio-file <span class="org-type">&amp;optional</span> diarize other-options)
  <span class="org-doc">"Send AUDIO-FILE to Gladia, save the JSON, and create a VTT.</span>
<span class="org-doc">If DIARIZE is non-nil, identify speakers."</span>
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> (getenv <span class="org-string">"GLADIA_API_KEY"</span>)
                         (read-file-name <span class="org-string">"Audio file: "</span>)
                       (<span class="org-warning">error</span> <span class="org-string">"Please specify GLADIA_API_KEY."</span>))))
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*recognition*"</span>)
    (erase-buffer)
    (call-process
     <span class="org-string">"curl"</span> nil t t <span class="org-string">"--request"</span> <span class="org-string">"POST"</span> <span class="org-string">"--header"</span>
     (concat <span class="org-string">"x-gladia-key: "</span> (getenv <span class="org-string">"GLADIA_API_KEY"</span>))
     <span class="org-string">"--header"</span> (concat <span class="org-string">"Content-Type: multipart/form-data"</span> )
     <span class="org-string">"--header"</span> (concat <span class="org-string">"Accept: application/json"</span>)
     <span class="org-string">"-F"</span> (concat <span class="org-string">"audio=@"</span> (expand-file-name audio-file) <span class="org-string">";type="</span> (mailcap-file-name-to-mime-type audio-file))
     <span class="org-string">"-F"</span> (concat <span class="org-string">"toggle_noise_reduction=true&amp;output_format=json"</span> (<span class="org-keyword">or</span> other-options <span class="org-string">""</span>) (<span class="org-keyword">if</span> diarize <span class="org-string">"&amp;toggle_diarization=true"</span> <span class="org-string">""</span>))
     <span class="org-string">"--url"</span> <span class="org-string">"https://api.gladia.io/audio/text/audio-transcription?toggle_noise_reduction=true&amp;output_format=json"</span>
     <span class="org-string">"-o"</span>
     (expand-file-name (concat (file-name-sans-extension audio-file) <span class="org-string">".json"</span>)))
    (subed-create-file
     (concat (file-name-sans-extension audio-file) <span class="org-string">".vtt"</span>)
     (my-gladia-parse (concat (file-name-sans-extension audio-file) <span class="org-string">".json"</span>))))
  (find-file (concat (file-name-sans-extension audio-file) <span class="org-string">".vtt"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-live-speech" class="outline-4">
<h4 id="live-speech"><span class="done DONE">DONE</span> Getting live speech into Emacs with Deepgram's streaming API&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="speech">speech</span></span></h4>
<div class="outline-text-4" id="text-live-speech">
<div class="update" id="org22a0da8">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2023-12-26 Tue]</span></span>: Reorganized code to call a list of functions and pass the recognition results. Added Etherpad. Took out the mode; will just use the functions. Related:</li>
</ul>

</div>

<p>
This is a quick demonstration of using <a href="https://developers.deepgram.com/reference/streaming">Deepgram's streaming API</a> to do
speech recognition live. It isn't as accurate as OpenAI Whisper but
since Whisper doesn't have a streaming API, it'll do for now. I can
correct misrecognized words manually. I tend to talk really quickly,
so it displays the words per minute in my modeline. I put the words
into an Org Mode buffer so I can toggle headings with avy and cycle
visibility. When I'm done, it saves the text, JSON, and WAV for
further processing. I think it'll be handy to have a quick way to take
live notes during interviews or when I'm thinking out loud. Could be
fun!
</p>

<p>

</p>

<p>
I'm still getting some weirdness when the mode turns on when I don't
expect it, so that's something to look into. Maybe I won't use it as a
mode for now. I'll just use <code>my-live-speech-start</code> and
<code>my-live-speech-stop</code>.
</p>
</div>
<div id="outline-container-general-code" class="outline-5">
<h5 id="general-code">General code</h5>
<div class="outline-text-5" id="text-general-code">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-buffer</span> <span class="org-string">"*Speech*"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-process</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-output-buffer</span> <span class="org-string">"*Speech JSON*"</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-functions</span>
  '(my-live-speech-display-in-speech-buffer
    my-live-speech-display-wpm
    my-live-speech-append-to-etherpad)
  <span class="org-doc">"Functions to call with one argument, the recognition results."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-start</span> ()
  <span class="org-doc">"Turn on live captions."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create my-live-speech-buffer)
    (<span class="org-keyword">unless</span> (process-live-p my-live-speech-process)
      (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/proj/deepgram-live"</span>))
        (message <span class="org-string">"%s"</span> default-directory)
        (<span class="org-keyword">with-current-buffer</span> (get-buffer-create my-live-speech-output-buffer)
          (erase-buffer))
        (<span class="org-keyword">setq</span> my-live-speech-recent-words nil
              my-live-speech-wpm-string <span class="org-string">"READY "</span>)
        (<span class="org-keyword">setq</span> my-deepgram-process
              (make-process
               <span class="org-builtin">:command</span> '(<span class="org-string">"bash"</span> <span class="org-string">"run.sh"</span>)
               <span class="org-builtin">:name</span> <span class="org-string">"speech"</span>
               <span class="org-builtin">:filter</span> 'my-live-speech-json-filter
               <span class="org-builtin">:sentinel</span> #'my-live-speech-process-sentinel
               <span class="org-builtin">:buffer</span> my-live-speech-output-buffer)))
      (org-mode))
    (display-buffer (current-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-stop</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (process-live-p my-live-speech-process)
      (kill-process my-live-speech-process))
  (<span class="org-keyword">setq</span> my-live-speech-wpm-string nil))

<span class="org-comment-delimiter">;; </span><span class="org-comment">(define-minor-mode my-live-speech-mode</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment"> "Show live speech and display WPM.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Need to check how to reliably turn this on and off."</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment"> :global t :group 'sachac</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment"> (if my-live-speech-mode</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">     (my-live-speech-start)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">   (my-live-speech-stop)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">   (setq my-live-speech-wpm-string nil)))</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">based on subed-mpv::client-filter</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-handle-json</span> (line-object)
  <span class="org-doc">"Process the JSON object in LINE."</span>
  (run-hook-with-args 'my-live-speech-functions (json-parse-string line <span class="org-builtin">:object-type</span> 'alist)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-process-sentinel</span> (proc event)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"finished"</span> event)
    (my-live-speech-stop)
    <span class="org-comment-delimiter">;</span><span class="org-comment">(my-live-speech-mode -1)</span>
    ))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-json-filter</span> (proc string)
  (<span class="org-keyword">when</span> (buffer-live-p (process-buffer proc))
    (<span class="org-keyword">with-current-buffer</span> (process-buffer proc)
      (<span class="org-keyword">let*</span> ((proc-mark (process-mark proc))
             (moving (= (point) proc-mark)))
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">insert the output</span>
        (<span class="org-keyword">save-excursion</span>
          (goto-char proc-mark)
          (insert string)
          (set-marker proc-mark (point)))
        (<span class="org-keyword">if</span> moving (goto-char proc-mark))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">process and remove all complete lines of JSON (lines are complete if ending with \n)</span>
        (<span class="org-keyword">let</span> ((pos (point-min)))
          (<span class="org-keyword">while</span> (<span class="org-keyword">progn</span> (goto-char pos)
                        (end-of-line)
                        (equal (following-char) ?\n))
            (<span class="org-keyword">let*</span> ((end (point))
                   (line (buffer-substring pos end)))
              (delete-region pos (+ end 1))
              (<span class="org-keyword">with-current-buffer</span> (get-buffer my-live-speech-buffer)
                (my-live-speech-handle-json line)))))))))
</pre>
</div>

<p>
Python code based on <a href="https://developers.deepgram.com/docs/getting-started-with-the-streaming-test-suite">the Deepgram streaming test suite</a>:
</p>

<div class="my_details" id="orgbee81fd">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Based on streaming-test-suite</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">https://developers.deepgram.com/docs/getting-started-with-the-streaming-test-suite</span>

<span class="org-keyword">import</span> pyaudio
<span class="org-keyword">import</span> asyncio
<span class="org-keyword">import</span> json
<span class="org-keyword">import</span> os
<span class="org-keyword">import</span> websockets
<span class="org-keyword">from</span> datetime <span class="org-keyword">import</span> datetime
<span class="org-keyword">import</span> wave
<span class="org-keyword">import</span> sys

<span class="org-variable-name">startTime</span> <span class="org-operator">=</span> datetime.now()
<span class="org-variable-name">key</span> <span class="org-operator">=</span> os.environ[<span class="org-string">'DEEPGRAM_API_KEY'</span>]
<span class="org-variable-name">live_json</span> <span class="org-operator">=</span> os.environ.get(<span class="org-string">'LIVE_CAPTIONS_JSON'</span>, <span class="org-constant">True</span>)
<span class="org-variable-name">all_mic_data</span> <span class="org-operator">=</span> []
<span class="org-variable-name">all_transcripts</span> <span class="org-operator">=</span> []
<span class="org-variable-name">all_words</span> <span class="org-operator">=</span> []
<span class="org-variable-name">FORMAT</span> <span class="org-operator">=</span> pyaudio.paInt16
<span class="org-variable-name">CHANNELS</span> <span class="org-operator">=</span> 1
<span class="org-variable-name">RATE</span> <span class="org-operator">=</span> 16000
<span class="org-variable-name">CHUNK</span> <span class="org-operator">=</span> 8000

<span class="org-variable-name">audio_queue</span> <span class="org-operator">=</span> asyncio.Queue()
<span class="org-variable-name">REALTIME_RESOLUTION</span> <span class="org-operator">=</span> 0.250
<span class="org-variable-name">SAMPLE_SIZE</span> <span class="org-operator">=</span> 0

<span class="org-keyword">def</span> <span class="org-function-name">save_info</span>():
    <span class="org-keyword">global</span> SAMPLE_SIZE
    <span class="org-variable-name">base</span> <span class="org-operator">=</span> startTime.strftime(<span class="org-string">'%Y%m%d%H%M'</span>)
    <span class="org-variable-name">wave_file_path</span> <span class="org-operator">=</span> os.path.abspath(f<span class="org-string">"</span>{base}<span class="org-string">.wav"</span>)
    <span class="org-variable-name">wave_file</span> <span class="org-operator">=</span> wave.<span class="org-builtin">open</span>(wave_file_path, <span class="org-string">"wb"</span>)
    wave_file.setnchannels(CHANNELS)
    wave_file.setsampwidth(SAMPLE_SIZE)
    wave_file.setframerate(RATE)
    wave_file.writeframes(b<span class="org-string">""</span>.join(all_mic_data))
    wave_file.close()
    <span class="org-keyword">with</span> <span class="org-builtin">open</span>(f<span class="org-string">"</span>{base}<span class="org-string">.txt"</span>, <span class="org-string">"w"</span>) <span class="org-keyword">as</span> f:
        f.write(<span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span>.join(all_transcripts))
    <span class="org-keyword">with</span> <span class="org-builtin">open</span>(f<span class="org-string">"</span>{base}<span class="org-string">.json"</span>, <span class="org-string">"w"</span>) <span class="org-keyword">as</span> f:
        f.write(json.dumps(all_words))
    <span class="org-keyword">if</span> live_json:
        <span class="org-builtin">print</span>(f<span class="org-string">'{{"msg": "&#128994; Saved to </span>{base}<span class="org-string">.txt , </span>{base}<span class="org-string">.json , </span>{base}<span class="org-string">.wav", "base": "</span>{base}<span class="org-string">"}}'</span>)
    <span class="org-keyword">else</span>:
        <span class="org-builtin">print</span>(f<span class="org-string">"&#128994; Saved to </span>{base}<span class="org-string">.txt , </span>{base}<span class="org-string">.json , </span>{base}<span class="org-string">.wav"</span>)

<span class="org-comment-delimiter"># </span><span class="org-comment">Used for microphone streaming only.</span>
<span class="org-keyword">def</span> <span class="org-function-name">mic_callback</span>(input_data, frame_count, time_info, status_flag):
    audio_queue.put_nowait(input_data)
    <span class="org-keyword">return</span> (input_data, pyaudio.paContinue)

<span class="org-keyword">async def</span> <span class="org-function-name">run</span>(key, method<span class="org-operator">=</span><span class="org-string">"mic"</span>, <span class="org-builtin">format</span><span class="org-operator">=</span><span class="org-string">"text"</span>, <span class="org-operator">**</span>kwargs):
    <span class="org-variable-name">deepgram_url</span> <span class="org-operator">=</span> f<span class="org-string">'wss://api.deepgram.com/v1/listen?punctuate=true&amp;smart_format=true&amp;utterances=true&amp;encoding=linear16&amp;sample_rate=16000'</span>
    <span class="org-keyword">async with</span> websockets.connect(
        deepgram_url, extra_headers<span class="org-operator">=</span>{<span class="org-string">"Authorization"</span>: <span class="org-string">"Token {}"</span>.<span class="org-builtin">format</span>(key)}
    ) <span class="org-keyword">as</span> ws:
        <span class="org-keyword">async def</span> <span class="org-function-name">sender</span>(ws):
            <span class="org-keyword">try</span>:
                <span class="org-keyword">while</span> <span class="org-constant">True</span>:
                    <span class="org-variable-name">mic_data</span> <span class="org-operator">=</span> <span class="org-keyword">await</span> audio_queue.get()
                    all_mic_data.append(mic_data)
                    <span class="org-keyword">await</span> ws.send(mic_data)
            <span class="org-keyword">except</span> websockets.exceptions.ConnectionClosedOK:
                <span class="org-keyword">await</span> ws.send(json.dumps({<span class="org-string">"type"</span>: <span class="org-string">"CloseStream"</span>}))
                <span class="org-keyword">if</span> live_json:
                    <span class="org-builtin">print</span>(<span class="org-string">'{"msg": "Closed."}'</span>)
                <span class="org-keyword">else</span>:
                    <span class="org-builtin">print</span>(<span class="org-string">"Closed."</span>)
        <span class="org-keyword">async def</span> <span class="org-function-name">receiver</span>(ws):
            <span class="org-keyword">global</span> all_words
            <span class="org-string">"""Print out the messages received from the server."""</span>
            <span class="org-variable-name">first_message</span> <span class="org-operator">=</span> <span class="org-constant">True</span>
            <span class="org-variable-name">first_transcript</span> <span class="org-operator">=</span> <span class="org-constant">True</span>
            <span class="org-variable-name">transcript</span> <span class="org-operator">=</span> <span class="org-string">""</span>
            <span class="org-keyword">async for</span> msg <span class="org-keyword">in</span> ws:
                <span class="org-variable-name">res</span> <span class="org-operator">=</span> json.loads(msg)
                <span class="org-keyword">if</span> first_message:
                    <span class="org-variable-name">first_message</span> <span class="org-operator">=</span> <span class="org-constant">False</span>
                <span class="org-keyword">try</span>:
                    <span class="org-comment-delimiter"># </span><span class="org-comment">handle local server messages</span>
                    <span class="org-keyword">if</span> res.get(<span class="org-string">"msg"</span>):
                        <span class="org-keyword">if</span> live_json:
                            <span class="org-builtin">print</span>(json.dumps(res))
                        <span class="org-keyword">else</span>:
                            <span class="org-builtin">print</span>(res[<span class="org-string">"msg"</span>])
                    <span class="org-keyword">if</span> res.get(<span class="org-string">"is_final"</span>):
                        <span class="org-variable-name">transcript</span> <span class="org-operator">=</span> (
                            res.get(<span class="org-string">"channel"</span>, {})
                            .get(<span class="org-string">"alternatives"</span>, [{}])[0]
                            .get(<span class="org-string">"transcript"</span>, <span class="org-string">""</span>)
                        )
                        <span class="org-keyword">if</span> transcript <span class="org-operator">!=</span> <span class="org-string">""</span>:
                            <span class="org-keyword">if</span> first_transcript:
                                <span class="org-variable-name">first_transcript</span> <span class="org-operator">=</span> <span class="org-constant">False</span>
                            <span class="org-keyword">if</span> live_json:
                                <span class="org-builtin">print</span>(json.dumps(res.get(<span class="org-string">"channel"</span>, {}).get(<span class="org-string">"alternatives"</span>, [{}])[0]))
                            <span class="org-keyword">else</span>:
                                <span class="org-builtin">print</span>(transcript)
                            all_transcripts.append(transcript)
                            <span class="org-variable-name">all_words</span> <span class="org-operator">=</span> all_words <span class="org-operator">+</span> res.get(<span class="org-string">"channel"</span>, {}).get(<span class="org-string">"alternatives"</span>, [{}])[0].get(<span class="org-string">"words"</span>, [])
                        <span class="org-comment-delimiter"># </span><span class="org-comment">if using the microphone, close stream if user says "goodbye"</span>
                        <span class="org-keyword">if</span> method <span class="org-operator">==</span> <span class="org-string">"mic"</span> <span class="org-keyword">and</span> <span class="org-string">"goodbye"</span> <span class="org-keyword">in</span> transcript.lower():
                            <span class="org-keyword">await</span> ws.send(json.dumps({<span class="org-string">"type"</span>: <span class="org-string">"CloseStream"</span>}))
                            <span class="org-keyword">if</span> live_json:
                                <span class="org-builtin">print</span>(<span class="org-string">'{"msg": "Done."}'</span>)
                            <span class="org-keyword">else</span>:
                                <span class="org-builtin">print</span>(<span class="org-string">"Done."</span>)
                    <span class="org-comment-delimiter"># </span><span class="org-comment">handle end of stream</span>
                    <span class="org-keyword">if</span> res.get(<span class="org-string">"created"</span>):
                        save_info()
                <span class="org-keyword">except</span> <span class="org-type">KeyError</span>:
                    <span class="org-builtin">print</span>(f<span class="org-string">"&#128308; ERROR: Received unexpected API response! </span>{msg}<span class="org-string">"</span>)

        <span class="org-comment-delimiter"># </span><span class="org-comment">Set up microphone if streaming from mic</span>
        <span class="org-keyword">async def</span> <span class="org-function-name">microphone</span>():
            <span class="org-variable-name">audio</span> <span class="org-operator">=</span> pyaudio.PyAudio()
            <span class="org-variable-name">stream</span> <span class="org-operator">=</span> audio.<span class="org-builtin">open</span>(
                <span class="org-builtin">format</span><span class="org-operator">=</span>FORMAT,
                channels<span class="org-operator">=</span>CHANNELS,
                rate<span class="org-operator">=</span>RATE,
                <span class="org-builtin">input</span><span class="org-operator">=</span><span class="org-constant">True</span>,
                frames_per_buffer<span class="org-operator">=</span>CHUNK,
                stream_callback<span class="org-operator">=</span>mic_callback,
            )

            stream.start_stream()

            <span class="org-keyword">global</span> SAMPLE_SIZE
            <span class="org-variable-name">SAMPLE_SIZE</span> <span class="org-operator">=</span> audio.get_sample_size(FORMAT)

            <span class="org-keyword">while</span> stream.is_active():
                <span class="org-keyword">await</span> asyncio.sleep(0.1)

            stream.stop_stream()
            stream.close()

        <span class="org-variable-name">functions</span> <span class="org-operator">=</span> [
            asyncio.ensure_future(sender(ws)),
            asyncio.ensure_future(receiver(ws)),
        ]

        functions.append(asyncio.ensure_future(microphone()))
        <span class="org-keyword">if</span> live_json:
            <span class="org-builtin">print</span>(<span class="org-string">'{"msg": "Ready."}'</span>)
        <span class="org-keyword">else</span>:
            <span class="org-builtin">print</span>(<span class="org-string">"&#128994; Ready."</span>)
        <span class="org-keyword">await</span> asyncio.gather(<span class="org-operator">*</span>functions)

<span class="org-keyword">def</span> <span class="org-function-name">main</span>():
    <span class="org-doc">"""Entrypoint for the example."""</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">Parse the command-line arguments.</span>
    <span class="org-keyword">try</span>:
        asyncio.run(run(key, <span class="org-string">"mic"</span>, <span class="org-string">"text"</span>))
    <span class="org-keyword">except</span> websockets.exceptions.InvalidStatusCode <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(f<span class="org-string">'&#128308; ERROR: Could not connect to Deepgram! </span>{e.headers.get("dg<span class="org-operator">-</span>error")}<span class="org-string">'</span>)
        <span class="org-builtin">print</span>(
            f<span class="org-string">'&#128308; Please contact Deepgram Support (developers@deepgram.com) with request ID </span>{e.headers.get("dg<span class="org-operator">-</span>request<span class="org-operator">-</span><span class="org-builtin">id</span>")}<span class="org-string">'</span>
        )
        <span class="org-keyword">return</span>
    <span class="org-keyword">except</span> websockets.exceptions.ConnectionClosedError <span class="org-keyword">as</span> e:
        <span class="org-variable-name">error_description</span> <span class="org-operator">=</span> f<span class="org-string">"Unknown websocket error."</span>
        <span class="org-builtin">print</span>(
            f<span class="org-string">"&#128308; ERROR: Deepgram connection unexpectedly closed with code </span>{e.code}<span class="org-string"> and payload </span>{e.reason}<span class="org-string">"</span>
        )

        <span class="org-keyword">if</span> e.reason <span class="org-operator">==</span> <span class="org-string">"DATA-0000"</span>:
            <span class="org-variable-name">error_description</span> <span class="org-operator">=</span> <span class="org-string">"The payload cannot be decoded as audio. It is either not audio data or is a codec unsupported by Deepgram."</span>
        <span class="org-keyword">elif</span> e.reason <span class="org-operator">==</span> <span class="org-string">"NET-0000"</span>:
            <span class="org-variable-name">error_description</span> <span class="org-operator">=</span> <span class="org-string">"The service has not transmitted a Text frame to the client within the timeout window. This may indicate an issue internally in Deepgram's systems or could be due to Deepgram not receiving enough audio data to transcribe a frame."</span>
        <span class="org-keyword">elif</span> e.reason <span class="org-operator">==</span> <span class="org-string">"NET-0001"</span>:
            <span class="org-variable-name">error_description</span> <span class="org-operator">=</span> <span class="org-string">"The service has not received a Binary frame from the client within the timeout window. This may indicate an internal issue in Deepgram's systems, the client's systems, or the network connecting them."</span>

        <span class="org-builtin">print</span>(f<span class="org-string">"&#128308; </span>{error_description}<span class="org-string">"</span>)
        <span class="org-comment-delimiter"># </span><span class="org-comment">TODO: update with link to streaming troubleshooting page once available</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">print(f'&#128308; Refer to our troubleshooting suggestions: ')</span>
        <span class="org-builtin">print</span>(
            f<span class="org-string">"&#128308; Please contact Deepgram Support (developers@deepgram.com) with the request ID listed above."</span>
        )
        <span class="org-keyword">return</span>

    <span class="org-keyword">except</span> websockets.exceptions.ConnectionClosedOK:
        <span class="org-keyword">return</span>

    <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(f<span class="org-string">"&#128308; ERROR: Something went wrong! </span>{e}<span class="org-string">"</span>)
        save_info()
        <span class="org-keyword">return</span>


<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> <span class="org-operator">==</span> <span class="org-string">"__main__"</span>:
    sys.<span class="org-constant">exit</span>(main() <span class="org-keyword">or</span> 0)
</pre>
</div>

</div>

<p>
The Python script sends the microphone stream to Deepgram and prints
out the JSON output. The Emacs Lisp code starts an asynchronous
process and reads the JSON output, displaying the transcript and
calculating the WPM based on the words. run.sh just loads the venv for
this project (requirements.txt based on the streaming text suite) and
then runs app.py, since some of the Python library versions conflict
with other things I want to experiment with.
</p>

<p>
I also added
<code>my-live-speech-wpm-string</code> to my <code>mode-line-format</code> manually using
Customize, since I wanted it displayed on the left side instead of
getting lost when I turn <code>keycast-mode</code> on.
</p>

<p>
I'm still a little anxious about accidentally leaving a process
running, so I check with <code>ps aux | grep python3</code>. Eventually I'll
figure out how to make sure everything gets properly stopped when I'm
done.
</p>

<p>
Anyway, there it is!
</p>
</div>
</div>
<div id="outline-container-display-in-speech-buffer" class="outline-5">
<h5 id="display-in-speech-buffer">Display in speech buffer</h5>
<div class="outline-text-5" id="text-display-in-speech-buffer">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-display-in-speech-buffer</span> (recognition-results)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create my-live-speech-buffer)
    (<span class="org-keyword">let-alist</span> recognition-results
      (<span class="org-keyword">let*</span> ((pos (point))
             (at-end (eobp)))
        (goto-char (point-max))
        (<span class="org-keyword">unless</span> (eolp) (insert <span class="org-string">"\n"</span>))
        (<span class="org-keyword">when</span> .msg
          (insert .msg <span class="org-string">"\n"</span>))
        (<span class="org-keyword">when</span> .transcript
          (insert .transcript <span class="org-string">"\n"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">scroll to the bottom if being displayed</span>
        (<span class="org-keyword">if</span> at-end
            (<span class="org-keyword">when</span> (get-buffer-window (current-buffer))
              (set-window-point (get-buffer-window (current-buffer)) (point)))
          (goto-char pos))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-toggle-heading</span> ()
  <span class="org-doc">"Toggle a line as a heading."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer my-live-speech-buffer)
    (display-buffer (current-buffer))
    (<span class="org-keyword">with-selected-window</span> (get-buffer-window (get-buffer my-live-speech-buffer))
      (<span class="org-keyword">let</span> ((avy-all-windows nil))
        (avy-goto-line 1))
      (org-toggle-heading 1))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-cycle-visibility</span> ()
  <span class="org-doc">"Get a quick overview."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer my-live-speech-buffer)
    (display-buffer (current-buffer))
    (<span class="org-keyword">if</span> (eq org-cycle-global-status 'contents)
        (<span class="org-keyword">progn</span>
          (run-hook-with-args 'org-cycle-pre-hook 'all)
          (org-fold-show-all '(headings blocks))
          (<span class="org-keyword">setq</span> org-cycle-global-status 'all)
          (run-hook-with-args 'org-cycle-hook 'all))
      (run-hook-with-args 'org-cycle-pre-hook 'contents)
      (org-cycle-content)
      (<span class="org-keyword">setq</span> org-cycle-global-status 'contents)
      (run-hook-with-args 'org-cycle-hook 'contents))))
</pre>
</div>
</div>
</div>
<div id="outline-container-display-words-per-minute" class="outline-5">
<h5 id="display-words-per-minute">Display words per minute</h5>
<div class="outline-text-5" id="text-display-words-per-minute">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-wpm-window-seconds</span> 15 <span class="org-doc">"How many seconds to calculate WPM for."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-recent-words</span> nil <span class="org-doc">"Words spoken in `</span><span class="org-doc"><span class="org-constant">my-live-speech-wpm-window-minutes</span></span><span class="org-doc">'."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-wpm</span> nil <span class="org-doc">"Current WPM."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-wpm-colors</span>  <span class="org-comment-delimiter">; </span><span class="org-comment">haven't figured out how to make these work yet</span>
  '((180 <span class="org-builtin">:foreground</span> <span class="org-string">"red"</span>)
    (170 <span class="org-builtin">:foreground</span> <span class="org-string">"yellow"</span>)
    (160 <span class="org-builtin">:foreground</span> <span class="org-string">"green"</span>)))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-wpm-string</span> nil <span class="org-doc">"Add this somewhere in `</span><span class="org-doc"><span class="org-constant">mode-line-format</span></span><span class="org-doc">'."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-wpm-string</span> ()
  (propertize
   (format <span class="org-string">"%d WPM "</span> my-live-speech-wpm)
   'face
   (cdr (seq-find (<span class="org-keyword">lambda</span> (row) (&gt; my-live-speech-wpm (car row))) my-live-speech-wpm-colors))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-display-wpm</span> (recognition-results)
  (<span class="org-keyword">let-alist</span> recognition-results
    (<span class="org-keyword">when</span> .words
      <span class="org-comment-delimiter">;; </span><span class="org-comment">calculate WPM</span>
      (<span class="org-keyword">setq</span> my-live-speech-recent-words
            (append my-live-speech-recent-words .words nil))
      (<span class="org-keyword">let</span> ((threshold (- (assoc-default 'end (aref .words (1- (length .words))))
                          my-live-speech-wpm-window-seconds)))
        (<span class="org-keyword">setq</span> my-live-speech-recent-words
              (seq-filter
               (<span class="org-keyword">lambda</span> (o)
                 (&gt;= (assoc-default 'start o)
                     threshold))
               my-live-speech-recent-words))
        (<span class="org-keyword">setq</span> my-live-speech-wpm
              (/
               (length my-live-speech-recent-words)
               (/ (- (assoc-default 'end (aref .words (1- (length .words))))
                     (assoc-default 'start (car my-live-speech-recent-words)))
                  60.0)))
        (<span class="org-keyword">setq</span> my-live-speech-wpm-string (my-live-speech-wpm-string))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-append-to-emacsconf-etherpad" class="outline-5">
<h5 id="append-to-emacsconf-etherpad">Append to EmacsConf Etherpad</h5>
<div class="outline-text-5" id="text-append-to-emacsconf-etherpad">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-live-speech-etherpad-id</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-live-speech-append-to-etherpad</span> (recognition-results)
  (<span class="org-keyword">when</span> my-live-speech-etherpad-id
    (emacsconf-pad-append-text my-live-speech-etherpad-id (concat <span class="org-string">" "</span> (assoc-default 'transcript recognition-results)))))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-utf-8" class="outline-3">
<h3 id="utf-8">UTF-8</h3>
<div class="outline-text-3" id="text-utf-8">
<p>
From <a href="http://www.wisdomandwonder.com/wordpress/wp-content/uploads/2014/03/C3F.html">http://www.wisdomandwonder.com/wordpress/wp-content/uploads/2014/03/C3F.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(prefer-coding-system 'utf-8)
(<span class="org-keyword">when</span> (display-graphic-p)
  (<span class="org-keyword">setq</span> x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)))
</pre>
</div>
</div>
</div>
<div id="outline-container-wdiff" class="outline-3">
<h3 id="wdiff">Wdiff</h3>
<div class="outline-text-3" id="text-wdiff">
<p>
This uses the <a href="https://www.gnu.org/software/wdiff/">wdiff</a> tool for word-based diffs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-wdiff</span> (old-file new-file)
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"Original: "</span>)
                     (buffer-file-name)))
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*wdiff*"</span>)
    (erase-buffer)
    (call-process <span class="org-string">"wdiff"</span> nil t t old-file new-file)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">{\\+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">-\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\+}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
        (add-text-properties (match-beginning 0) (match-end 0)
                             (list 'face (<span class="org-keyword">if</span> (string= (match-string 1) <span class="org-string">"[-"</span>)
                                             'diff-removed
                                           'diff-added))))
    (switch-to-buffer (current-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-wdiff-buffer-with-file</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((s (buffer-string))
        (temp-file (make-temp-file <span class="org-string">"temp"</span>)))
    (<span class="org-keyword">with-temp-file</span> temp-file
      (insert s))
    (my-wdiff (buffer-file-name) temp-file)
    (delete-file temp-file)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org" class="outline-2">
<h2 id="org">Org Mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span></span></h2>
<div class="outline-text-2" id="text-org">
<p>
I use <a href="http://www.orgmode.org">Org Mode</a> to take notes, publish my blog, and do all sorts of
stuff.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:load-path</span> (<span class="org-string">"~/vendor/org-mode/lisp"</span> <span class="org-string">"~/vendor/org-mode/contrib/lisp"</span>)
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> org-mode-map
        (<span class="org-string">"C-M-&lt;return&gt;"</span> . org-insert-subheading))
  <span class="org-builtin">:custom</span>
  (org-export-with-sub-superscripts nil)
  (org-fold-catch-invisible-edits 'smart))
</pre>
</div>
</div>
<div id="outline-container-org-files" class="outline-3">
<h3 id="org-files">My files</h3>
<div class="outline-text-3" id="text-org-files">
<p>
#<a id="org45ec926"></a>
</p>

<p>
Here are the Org files I use. I should probably organize them better. =)
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">organizer.org</td>
<td class="org-left">My main Org file. Inbox for M-x org-capture, tasks, weekly reviews, etc.</td>
</tr>

<tr>
<td class="org-left">news.org</td>
<td class="org-left">inbox for Emacs News</td>
</tr>

<tr>
<td class="org-left">business.org</td>
<td class="org-left">Business-related notes and TODOs</td>
</tr>

<tr>
<td class="org-left">people.org</td>
<td class="org-left">People-related tasks</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/evil-plans">evil-plans/index.org</a></td>
<td class="org-left">High-level goals</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/outline">sharing/index.org</a></td>
<td class="org-left">Things to write about</td>
</tr>

<tr>
<td class="org-left">decisions.org</td>
<td class="org-left">Pending, current, and reviewed decisions</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/blog/index">blog.org</a></td>
<td class="org-left">Topic index for my blog</td>
</tr>

<tr>
<td class="org-left"><a href="http://sachachua.com/my-learning">learning.org</a></td>
<td class="org-left">Learning plan</td>
</tr>

<tr>
<td class="org-left">outline.org</td>
<td class="org-left">Huge outline of notes by category</td>
</tr>

<tr>
<td class="org-left">tracking.org</td>
<td class="org-left">Temporary Org file for tracking various things</td>
</tr>

<tr>
<td class="org-left">delegation.org</td>
<td class="org-left">Templates for assigning tasks - now using Google Docs instead</td>
</tr>

<tr>
<td class="org-left">books.org</td>
<td class="org-left">Huge file with book notes</td>
</tr>

<tr>
<td class="org-left">calendar.org</td>
<td class="org-left">Now using this with org-gcal</td>
</tr>

<tr>
<td class="org-left">ideal.org</td>
<td class="org-left">Planning ideal days</td>
</tr>

<tr>
<td class="org-left">archive.org</td>
<td class="org-left">Archived subtrees</td>
</tr>

<tr>
<td class="org-left">latin.org</td>
<td class="org-left">Latin notes</td>
</tr>

<tr>
<td class="org-left">101things.org</td>
<td class="org-left">Old goals for 101 things in 1001 days</td>
</tr>

<tr>
<td class="org-left">life.org</td>
<td class="org-left">Questions, processes, tools</td>
</tr>

<tr>
<td class="org-left">sewing.org</td>
<td class="org-left">Sewing projects, fabric tracking, etc.</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><a href="http://stackoverflow.com/questions/8146313/emacs-auto-save-for-org-mode-only">emacs auto save for org-mode only - Stack Overflow</a></li>
</ul>
</div>
</div>
<div id="outline-container-modules" class="outline-3">
<h3 id="modules">Modules</h3>
<div class="outline-text-3" id="text-modules">
<p>
Org has a whole bunch of optional modules. These are the ones I'm
currently experimenting with.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-modules '(org-habit
                    org-mouse
                    org-protocol
                    org-annotate-file
                    org-eval
                    org-expiry
                    org-interactive-query
                    org-collector
                    org-panel
                    org-screen
                    org-toc))
(eval-after-load 'org
  '(org-load-modules-maybe t))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Prepare stuff for org-export-backends</span>
(<span class="org-keyword">setq</span> org-export-backends '(org latex icalendar html ascii))
</pre>
</div>
</div>
</div>
<div id="outline-container-keyboard-shortcuts" class="outline-3">
<h3 id="keyboard-shortcuts">Keyboard shortcuts</h3>
<div class="outline-text-3" id="text-keyboard-shortcuts">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c r"</span> 'org-capture)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c a"</span> 'org-agenda)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c l"</span> 'org-store-link)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c L"</span> 'org-insert-link-global)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c O"</span> 'org-open-at-point-global)
</pre>
</div>

<p>
<code>append-next-kill</code> is more useful to me than <code>org-table-copy-region</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-M-w"</span> 'append-next-kill org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-TAB"</span> 'org-cycle org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c v"</span> 'org-show-todo-tree org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-r"</span> 'org-refile org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c R"</span> 'org-reveal org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c o"</span> 'my-org-follow-entry-link org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c d"</span> 'my-org-move-line-to-destination org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c t s"</span>  'my-split-sentence-and-capitalize org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c t -"</span>  'my-split-sentence-delete-word-and-capitalize org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c t d"</span>  'my-delete-word-and-capitalize org-mode-map)

  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-p C-p"</span> 'my-org-publish-maybe org-mode-map)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-r"</span> 'my-org-refile-and-jump org-mode-map))
</pre>
</div>

<p>
I don't use the diary, but I do use the clock a lot.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org-agenda
  (<span class="org-keyword">bind-key</span> <span class="org-string">"i"</span> 'org-agenda-clock-in org-agenda-mode-map))
</pre>
</div>
</div>
<div id="outline-container-speed-commands" class="outline-4">
<h4 id="speed-commands">Speed commands</h4>
<div class="outline-text-4" id="text-speed-commands">
<p>
These are great for quickly acting on tasks.
</p>

<ul class="org-ul">
<li>hello
<ul class="org-ul">
<li>world</li>
<li>this</li>
</ul></li>
<li>world here</li>
</ul>



<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-use-effective-time t)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-use-speed-commands-for-headings-and-lists</span> ()
  <span class="org-doc">"Activate speed commands on list items too."</span>
  (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> (looking-at org-outline-regexp) (looking-back <span class="org-string">"^</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">**"</span> nil))
      (<span class="org-keyword">save-excursion</span> (<span class="org-keyword">and</span> (looking-at (org-item-re)) (looking-back <span class="org-string">"^[ \t]*"</span> nil)))))
(<span class="org-keyword">setq</span> org-use-speed-commands 'my-org-use-speed-commands-for-headings-and-lists)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-subtree-text</span> ()
  (<span class="org-keyword">save-excursion</span>
    (buffer-substring (<span class="org-keyword">save-excursion</span> (org-end-of-meta-data t) (point)) (org-end-of-subtree))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-mark-done</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-org-with-current-task (org-todo <span class="org-string">"DONE"</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-mark-done-and-add-to-journal</span> (<span class="org-type">&amp;optional</span> note category)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> current-prefix-arg
                         (read-string (format <span class="org-string">"Note (%s): "</span> (org-get-heading t t t t)))
                       (org-get-heading t t t t))
                     (<span class="org-keyword">or</span> (org-entry-get (point) <span class="org-string">"JOURNAL_CAT"</span>) (my-journal-read-category (my-journal-guess-category)))))
  (my-org-with-current-task
   (org-todo <span class="org-string">"DONE"</span>)
   (org-entry-put (point) <span class="org-string">"JOURNAL_CAT"</span> category)
   (<span class="org-keyword">let*</span> ((title (<span class="org-keyword">or</span> note (org-get-heading t t t t)))
          (zid (org-entry-get (point) <span class="org-string">"ZIDSTRING"</span>))
          (other (<span class="org-keyword">if</span> current-prefix-arg (substring-no-properties (my-org-subtree-text))))
          (date (<span class="org-keyword">unless</span> zid
                         (format-time-string <span class="org-string">"%Y-%m-%d %H:%M"</span>
                                             (<span class="org-keyword">let</span> ((base-date (org-read-date nil t (org-entry-get (point) <span class="org-string">"CREATED"</span>))))
                                               (<span class="org-keyword">if</span> (string-match <span class="org-string">"Yesterday "</span> title)
                                                   (<span class="org-keyword">progn</span>
                                                     (<span class="org-keyword">setq</span> title (replace-match <span class="org-string">""</span> nil nil title))
                                                     (org-read-date nil t <span class="org-string">"--1"</span> nil (org-time-string-to-time (org-entry-get (point) <span class="org-string">"CREATED"</span>))))
                                                 base-date))))))
     (<span class="org-keyword">if</span> zid
         (my-journal-update (list <span class="org-builtin">:ZIDString</span> zid <span class="org-builtin">:Note</span> title <span class="org-builtin">:Category</span> category <span class="org-builtin">:Other</span> other))
       (org-entry-put (point) <span class="org-string">"ZIDSTRING"</span>
                      (plist-get
                       (my-journal-post title
                                        <span class="org-builtin">:Category</span> category
                                        <span class="org-builtin">:Other</span> other
                                        <span class="org-builtin">:Date</span> date)
                       <span class="org-builtin">:ZIDString</span>)))
     (org-back-to-heading)
     (my-copy-observation))))

(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">let</span> ((listvar (<span class="org-keyword">if</span> (boundp 'org-speed-commands) 'org-speed-commands
                   'org-speed-commands-user)))
    (add-to-list listvar '(<span class="org-string">"A"</span> org-archive-subtree-default))
    (add-to-list listvar '(<span class="org-string">"x"</span> org-todo <span class="org-string">"DONE"</span>))
    (add-to-list listvar '(<span class="org-string">"X"</span> call-interactively 'my-org-mark-done-and-add-to-journal))
    (add-to-list listvar '(<span class="org-string">"y"</span> org-todo-yesterday <span class="org-string">"DONE"</span>))
    (add-to-list listvar '(<span class="org-string">"!"</span> my-org-clock-in-and-track))
    (add-to-list listvar '(<span class="org-string">"s"</span> call-interactively 'org-schedule))
    (add-to-list listvar '(<span class="org-string">"d"</span> my-org-move-line-to-destination))
    (add-to-list listvar '(<span class="org-string">"i"</span> call-interactively 'org-clock-in))
    (add-to-list listvar '(<span class="org-string">"o"</span> call-interactively 'org-clock-out))
    (add-to-list listvar '(<span class="org-string">"$"</span> call-interactively 'org-archive-subtree)))
  (<span class="org-keyword">bind-key</span> <span class="org-string">"!"</span> 'my-org-clock-in-and-track org-agenda-mode-map))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org-navigation" class="outline-3">
<h3 id="org-navigation">Org navigation</h3>
<div class="outline-text-3" id="text-org-navigation">
<p>
From <a href="http://stackoverflow.com/questions/15011703/is-there-an-emacs-org-mode-command-to-jump-to-an-org-heading">http://stackoverflow.com/questions/15011703/is-there-an-emacs-org-mode-command-to-jump-to-an-org-heading</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-goto-interface 'outline-path-completion
      org-goto-max-level 10)
(<span class="org-keyword">require</span> '<span class="org-constant">imenu</span>)
(<span class="org-keyword">setq</span> org-startup-folded nil)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c j"</span> 'org-clock-goto) <span class="org-comment-delimiter">;; </span><span class="org-comment">jump to current task from anywhere</span>
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c C-w"</span> 'org-refile)
(<span class="org-keyword">setq</span> org-cycle-include-plain-lists 'integrate)
(<span class="org-keyword">setq</span> org-catch-invisible-edits 'show-and-error)
</pre>
</div>
</div>
<div id="outline-container-link-org-subtrees-and-navigate-between-them" class="outline-4">
<h4 id="link-org-subtrees-and-navigate-between-them">Link Org subtrees and navigate between them</h4>
<div class="outline-text-4" id="text-link-org-subtrees-and-navigate-between-them">
<p>
The following code makes it easier for me to link trees with entries, as in <a href="http://sachachua.com/evil-plans">http://sachachua.com/evil-plans</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-follow-entry-link</span> ()
  <span class="org-doc">"Follow the defined link for this entry."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (org-entry-get (point) <span class="org-string">"LINK"</span>)
      (org-open-link-from-string (org-entry-get (point) <span class="org-string">"LINK"</span>))
    (org-open-at-point)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-link-projects</span> (location)
  <span class="org-doc">"Add link properties between the current subtree and the one specified by LOCATION."</span>
  (<span class="org-keyword">interactive</span>
   (list (<span class="org-keyword">let</span> ((org-refile-use-cache nil))
           (org-refile-get-location <span class="org-string">"Location"</span>))))
  (<span class="org-keyword">let</span> ((link1 (org-store-link nil)) link2)
    (<span class="org-keyword">save-window-excursion</span>
      (org-refile 4 nil location)
      (<span class="org-keyword">setq</span> link2 (org-store-link nil))
      (org-set-property <span class="org-string">"LINK"</span> link1))
    (org-set-property <span class="org-string">"LINK"</span> link2)))
</pre>
</div>
</div>
</div>
<div id="outline-container-viewing-navigating-and-editing-the-org-tree" class="outline-4">
<h4 id="viewing-navigating-and-editing-the-org-tree">Viewing, navigating, and editing the Org tree</h4>
<div class="outline-text-4" id="text-viewing-navigating-and-editing-the-org-tree">
<p>
I often cut and paste subtrees. This makes it easier to cut
something and paste it elsewhere in the hierarchy.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c k"</span> 'org-cut-subtree org-mode-map)
  (<span class="org-keyword">setq</span> org-yank-adjusted-subtrees t))
</pre>
</div>
</div>
</div>
<div id="outline-container-finding-my-place-on-a-small-mobile-screen-with-org-back-to-heading" class="outline-4">
<h4 id="finding-my-place-on-a-small-mobile-screen-with-org-back-to-heading">Finding my place on a small mobile screen with org-back-to-heading</h4>
<div class="outline-text-4" id="text-finding-my-place-on-a-small-mobile-screen-with-org-back-to-heading">
<p>
There's probably a better way to do this. I'm surprised
org-back-to-heading isn't interactive yet. It's useful.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-back-to-heading</span> ()
  (<span class="org-keyword">interactive</span>)
  (org-back-to-heading))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> org-mode-map
              (<span class="org-string">"C-c b"</span> . my-org-back-to-heading)
              (<span class="org-string">"C-c p"</span> . org-display-outline-path)))
</pre>
</div>
</div>
</div>
<div id="outline-container-dealing-with-big-tables" class="outline-4">
<h4 id="dealing-with-big-tables">Dealing with big tables</h4>
<div class="outline-text-4" id="text-dealing-with-big-tables">
<p>
Sometimes I forget where I am in a big table. This would be nice to turn into a minor mode someday.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-show-row-and-column</span> (point)
  (<span class="org-keyword">interactive</span> <span class="org-string">"d"</span>)
  (<span class="org-keyword">save-excursion</span>
    (goto-char point)
    (<span class="org-keyword">let</span> ((row (s-trim (org-table-get nil 1)))
          (col (s-trim (org-table-get 1 nil)))
          (message-log-max nil))
      (message <span class="org-string">"%s - %s"</span> row col))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-taking-notes" class="outline-3">
<h3 id="taking-notes">Taking notes</h3>
<div class="outline-text-3" id="text-taking-notes">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-directory <span class="org-string">"~/sync/orgzly/"</span>)
(<span class="org-keyword">setq</span> org-default-notes-file <span class="org-string">"~/sync/orgzly/organizer.org"</span>)
</pre>
</div>
</div>
<div id="outline-container-date-trees" class="outline-4">
<h4 id="date-trees">Date trees</h4>
<div class="outline-text-4" id="text-date-trees">
<p>
This quickly adds a same-level heading for the succeeding day.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-heading-for-next-day</span> ()
  <span class="org-doc">"Insert a same-level heading for the following day."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((new-date
         (seconds-to-time
          (+ 86400.0
             (float-time
              (org-read-date nil 'to-time (elt (org-heading-components) 4)))))))
    (org-insert-heading-after-current)
    (insert (format-time-string <span class="org-string">"%Y-%m-%d\n\n"</span> new-date))))
</pre>
</div>
</div>
</div>
<div id="outline-container-templates" class="outline-4">
<h4 id="templates">Templates</h4>
<div class="outline-text-4" id="text-templates">
<p>
I use <code>org-capture</code> templates to quickly jot down tasks, ledger
entries, notes, and other semi-structured pieces of information.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-contacts-template-email</span> (<span class="org-type">&amp;optional</span> return-value)
  <span class="org-doc">"Try to return the contact email for a template.</span>
<span class="org-doc">         If not found return RETURN-VALUE or something that would ask the user."</span>
  (<span class="org-keyword">eval-when-compile</span> (<span class="org-keyword">require</span> '<span class="org-constant">gnus-art</span> nil t))
  (<span class="org-keyword">eval-when-compile</span> (<span class="org-keyword">require</span> '<span class="org-constant">org-contacts</span> nil t))
  (<span class="org-keyword">or</span> (cadr (<span class="org-keyword">if</span> (gnus-alive-p)
                (<span class="org-keyword">gnus-with-article-headers</span>
                  (mail-extract-address-components
                   (<span class="org-keyword">or</span> (mail-fetch-field <span class="org-string">"Reply-To"</span>) (mail-fetch-field <span class="org-string">"From"</span>) <span class="org-string">""</span>)))))
      return-value
      (concat <span class="org-string">"%^{"</span> org-contacts-email-property <span class="org-string">"}p"</span>)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-basic-task-template</span> <span class="org-string">"* TODO %^{Task}</span>
<span class="org-string">         :PROPERTIES:</span>
<span class="org-string">         :Effort: %^{effort|1:00|0:05|0:15|0:30|2:00|4:00}</span>
<span class="org-string">         :END:</span>
<span class="org-string">         Captured %&lt;%Y-%m-%d %H:%M&gt;</span>
<span class="org-string">         %?</span>

<span class="org-string">         %i</span>
<span class="org-string">         "</span> <span class="org-doc">"Basic task data"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-inbox-file</span> <span class="org-string">"~/sync/orgzly/Inbox.org"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-ledger-file</span> <span class="org-string">"~/cloud/ledger/current.ledger"</span>)
(<span class="org-keyword">with-eval-after-load</span> 'org-capture
  (<span class="org-keyword">setq</span> org-capture-templates
        (seq-uniq
         (append

      `((<span class="org-string">"r"</span> <span class="org-string">"Note"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* %?\n:PROPERTIES:\n:CREATED: %U\n:END:\n\n%i\n\n- %a"</span>
         <span class="org-builtin">:prepend</span> t)
        (<span class="org-string">"t"</span> <span class="org-string">"Task with annotation"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:\n%a\n"</span>
         <span class="org-builtin">:prepend</span> t)
        (<span class="org-string">"i"</span> <span class="org-string">"Interrupting task"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* STARTED %^{Task}\n:PROPERTIES:\n:CREATED: %U\n:END:\n%a\n"</span>
         <span class="org-builtin">:clock-in</span> <span class="org-builtin">:clock-resume</span>
         <span class="org-builtin">:prepend</span> t)
        (<span class="org-string">"T"</span> <span class="org-string">"Task without annotation"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* TODO %^{Task}\n:PROPERTIES:\n:CREATED: %U\n:END:\n\n"</span>
         <span class="org-builtin">:prepend</span> t)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">From https://takeonrules.com/2022/10/16/adding-another-function-to-my-workflow/</span>
        (<span class="org-string">"c"</span> <span class="org-string">"Contents to current clocked task"</span>
         plain (clock)
         <span class="org-string">"%i%?"</span>
         <span class="org-builtin">:empty-lines</span> 1)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">("p" "Podcast log - timestamped" item</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">(file+olp+datetree "~/sync/orgzly/timestamped.org")</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">"%&lt;%H:%M:%S,%3N&gt; %^{Note}"</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">:immediate-finish t)</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">("b" "Plover note" table-line</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">(file+headline "~/proj/plover-notes/README.org" "Brief notes")</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">"| %^{Stroke} | %^{Translation} | %^{Note} |"</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">:immediate-finish t)</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">("c" "Plover review from clippy" table-line</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">(file+headline "~/proj/plover-notes/README.org" "For review")</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">"%(let ((last (my-clippy-last))) (format \"| %s | %s |\" (car last) (cdr last)))"</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">:immediate-finish t)</span>

        (<span class="org-string">"."</span> <span class="org-string">"Today"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* TODO %^{Task}\nSCHEDULED: %t\n:PROPERTIES:\n:CREATED: %U\n:END:\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"v"</span> <span class="org-string">"Video"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* TODO %^{Task}  :video:\nSCHEDULED: %t\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"e"</span> <span class="org-string">"Errand"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* TODO %^{Task}  :errands:\n:PROPERTIES:\n:CREATED: %U\n:END:\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"n"</span> <span class="org-string">"Note"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* %^{Note}\n:PROPERTIES:\n:CREATED: %U\n:END:\n"</span>
         <span class="org-builtin">:immediate-finish</span> t)
        (<span class="org-string">"N"</span> <span class="org-string">"Note"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* %^{Note}\n:PROPERTIES:\n:CREATED: %U\n:END:\n"</span>
         <span class="org-builtin">:prepend</span> t)
        (<span class="org-string">"s"</span> <span class="org-string">"Screenshot"</span> entry
         (file ,my-org-inbox-file)
         <span class="org-string">"* %^{Note}\n:PROPERTIES:\n:CREATED: %U\n:END:\n\n[[file:%(my-latest-file my-screenshot-directory)]]\n"</span>
         <span class="org-builtin">:prepend</span> t)
        (<span class="org-string">"b"</span> <span class="org-string">"Business task"</span> entry
         (file+headline <span class="org-string">"~/personal/business.org"</span> <span class="org-string">"Tasks"</span>)
         ,my-org-basic-task-template)
        (<span class="org-string">"j"</span> <span class="org-string">"Journal entry"</span> plain
         (file+olp+datetree <span class="org-string">"~/sync/orgzly/journal.org"</span>)
         <span class="org-string">"%K - %a\n%i\n%?\n"</span>
         <span class="org-builtin">:unnarrowed</span> t)
        (<span class="org-string">"db"</span> <span class="org-string">"Done - Business"</span> entry
         (file+headline <span class="org-string">"~/personal/business.org"</span> <span class="org-string">"Tasks"</span>)
         <span class="org-string">"* DONE %^{Task}\nSCHEDULED: %^t\n%?"</span>)
        (<span class="org-string">"dp"</span> <span class="org-string">"Done - People"</span> entry
         (file+headline <span class="org-string">"~/personal/people.org"</span> <span class="org-string">"Tasks"</span>)
         <span class="org-string">"* DONE %^{Task}\nSCHEDULED: %^t\n%?"</span>)
        (<span class="org-string">"dt"</span> <span class="org-string">"Done - Task"</span> entry
         (file+headline <span class="org-string">"~/sync/orgzly/organizer.org"</span> <span class="org-string">"Inbox"</span>)
         <span class="org-string">"* DONE %^{Task}\nSCHEDULED: %^t\n%?"</span>)
        (<span class="org-string">"q"</span> <span class="org-string">"Quick note"</span> item
         (file+headline <span class="org-string">"~/sync/orgzly/organizer.org"</span> <span class="org-string">"Quick notes"</span>))
        (<span class="org-string">"l"</span> <span class="org-string">"Ledger"</span>)
        (<span class="org-string">"lc"</span> <span class="org-string">"Cash expense"</span> plain
         (file ,my-ledger-file)
         <span class="org-string">"%(ledger-read-date \"Date: \") * %^{Payee}</span>
<span class="org-string">             Expenses:Cash</span>
<span class="org-string">             Expenses:%^{Account}  %^{Amount}</span>
<span class="org-string">           "</span>)
        (<span class="org-string">"lb"</span> <span class="org-string">"BDO CAD"</span> plain
         (file ,my-ledger-file)
         <span class="org-string">"%(ledger-read-date \"Date: \") * %^{Payee}</span>
<span class="org-string">             Expenses:Play    $ %^{Amount}</span>
<span class="org-string">             Assets:BDO</span>
<span class="org-string">           "</span>)
        (<span class="org-string">"lp"</span> <span class="org-string">"BDO PHP"</span> plain
         (file ,my-ledger-file)
         <span class="org-string">"%(ledger-read-date \"Date: \") * %^{Payee}</span>
<span class="org-string">             Expenses:Play    PHP %^{Amount}</span>
<span class="org-string">             Assets:BDO</span>
<span class="org-string">           "</span>)
        (<span class="org-string">"B"</span> <span class="org-string">"Book"</span> entry
         (file+datetree <span class="org-string">"~/personal/books.org"</span> <span class="org-string">"Inbox"</span>)
         <span class="org-string">"* %^{Title}  %^g</span>
<span class="org-string">           %i</span>
<span class="org-string">           *Author(s):* %^{Author} \\\\</span>
<span class="org-string">           *ISBN:* %^{ISBN}</span>

<span class="org-string">           %?</span>

<span class="org-string">           *Review on:* %^t \\</span>
<span class="org-string">           %a</span>
<span class="org-string">           %U"</span>
         <span class="org-builtin">:clock-in</span> <span class="org-builtin">:clock-resume</span>)
        (<span class="org-string">"C"</span> <span class="org-string">"Contact"</span> entry (file <span class="org-string">"~/sync/orgzly/people.org"</span>)
         <span class="org-string">"* %(org-contacts-template-name)</span>
<span class="org-string">:PROPERTIES:</span>
<span class="org-string">:EMAIL: %(my-org-contacts-template-email)</span>
<span class="org-string">:END:"</span>)
        (<span class="org-string">"y"</span> <span class="org-string">"Yay Emacs"</span> entry (file+headline <span class="org-string">"~/proj/stream/index.org"</span> <span class="org-string">"Notes for this session"</span>)
         <span class="org-string">"* %?\n:PROPERTIES:\n:CREATED: %U\n:END:\n</span>

<span class="org-string">%i</span>

<span class="org-string">%a</span>
<span class="org-string">"</span>))
      org-capture-templates))))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-M-r"</span> 'org-capture)



<span class="org-comment-delimiter">;;</span><span class="org-comment">(bind-key (kbd "&lt;f5&gt;") 'org-capture)</span>
</pre>
</div>
</div>
<div id="outline-container-allow-refiling-in-the-middle-ish-of-a-capture" class="outline-5">
<h5 id="allow-refiling-in-the-middle-ish-of-a-capture">Allow refiling in the middle(ish) of a capture</h5>
<div class="outline-text-5" id="text-allow-refiling-in-the-middle-ish-of-a-capture">
<p>
This lets me use <code>C-c C-r</code> to refile a capture and then jump to the
new location. I wanted to be able to file tasks under projects so that
they could inherit the QUANTIFIED property that I use to track time
(and any Beeminder-related properties too), but I also wanted to be
able to clock in on them.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-and-jump</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (derived-mode-p 'org-capture-mode)
      (org-capture-refile)
    (call-interactively 'org-refile))
  (org-refile-goto-last-stored))
(eval-after-load 'org-capture
  '(bind-key <span class="org-string">"C-c C-r"</span> 'my-org-refile-and-jump org-capture-mode-map))

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-try-out-this-capture-command" class="outline-4">
<h4 id="try-out-this-capture-command">Try out this capture command</h4>
<div class="outline-text-4" id="text-try-out-this-capture-command">
<p>
From <a href="https://takeonrules.com/2022/10/16/adding-another-function-to-my-workflow/">https://takeonrules.com/2022/10/16/adding-another-function-to-my-workflow/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> git-link)
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c c"</span> 'jf/capture-region-contents-with-metadata)
(<span class="org-keyword">defun</span> <span class="org-function-name">jf/capture-region-contents-with-metadata</span> (start end parg)
  <span class="org-doc">"Write selected text between START and END to currently clocked `</span><span class="org-doc"><span class="org-constant">org-mode</span></span><span class="org-doc">' entry.</span>

<span class="org-doc">With PARG kill the content instead."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r\nP"</span>)
  (<span class="org-keyword">let</span> ((text (jf/region-contents-get-with-metadata start end)))
    (<span class="org-keyword">if</span> (car parg)
  (kill-new text)
      (org-capture-string (concat <span class="org-string">"-----\n"</span> text) <span class="org-string">"c"</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">jf/region-contents-get-with-metadata</span> (start end)
      <span class="org-doc">"Get the region contents between START and END and return an `</span><span class="org-doc"><span class="org-constant">org-mode</span></span><span class="org-doc">' formatted string."</span>
      (<span class="org-keyword">require</span> '<span class="org-constant">magit</span>)
      (<span class="org-keyword">require</span> '<span class="org-constant">git-link</span>)
      (<span class="org-keyword">let*</span> ((file-name (buffer-file-name (current-buffer)))
       (org-src-mode (replace-regexp-in-string
          <span class="org-string">"-mode"</span>
          <span class="org-string">""</span>
          (format <span class="org-string">"%s"</span> major-mode)))
       (func-name (which-function))
       (type (<span class="org-keyword">if</span> (derived-mode-p 'prog-mode) <span class="org-string">"SRC"</span> <span class="org-string">"EXAMPLE"</span>))
       (code-snippet (buffer-substring-no-properties start end))
       (file-base (file-name-nondirectory file-name))
       (line-number (line-number-at-pos (region-beginning)))
       (remote-link (<span class="org-keyword">when</span> (magit-list-remotes)
          (<span class="org-keyword">progn</span>
            (call-interactively 'git-link)
            (car kill-ring))))
       (initial-txt (<span class="org-keyword">if</span> (null func-name)
            (format <span class="org-string">"From [[file:%s::%s][%s]]:"</span>
              file-name
              line-number
              file-base)
          (format <span class="org-string">"From ~%s~ (in [[file:%s::%s][%s]]):"</span>
            func-name
            file-name
            line-number
            file-base))))
  (format (concat <span class="org-string">"\n- Local :: %s"</span>
      (<span class="org-keyword">when</span> remote-link (format <span class="org-string">"\n- Remote :: %s"</span> remote-link))
      <span class="org-string">"\n\n#+BEGIN_%s %s"</span>
      <span class="org-string">"\n%s"</span>
      <span class="org-string">"\n#+END_%s\n"</span>)
    initial-txt
    type
    org-src-mode
    code-snippet
    type)))
</pre>
</div>
</div>
</div>
<div id="outline-container-estimating-wpm" class="outline-4">
<h4 id="estimating-wpm">Estimating WPM</h4>
<div class="outline-text-4" id="text-estimating-wpm">
<p>
I'm curious about how fast I type some things.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">org-clock</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-entry-wpm</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-restriction</span>
    (<span class="org-keyword">save-excursion</span>
      (org-narrow-to-subtree)
      (goto-char (point-min))
      (<span class="org-keyword">let*</span> ((words (count-words-region (point-min) (point-max)))
             (minutes (org-clock-sum-current-item))
             (wpm (/ words minutes)))
        (message <span class="org-string">"WPM: %d (words: %d, minutes: %d)"</span> wpm words minutes)
        (kill-new (number-to-string wpm))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-logbook" class="outline-3">
<h3 id="logbook">Logbook</h3>
<div class="outline-text-3" id="text-logbook">
<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-log-note</span> (note)
  <span class="org-doc">"Add NOTE to the current entry's logbook."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MNote: "</span>)
  (<span class="org-keyword">setq</span> org-log-note-window-configuration (current-window-configuration))
  (move-marker org-log-note-return-to (point))
  (move-marker org-log-note-marker (point))
  (<span class="org-keyword">setq</span> org-log-note-purpose 'note)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert note)
    (org-store-log-note)))
</pre>
</div>
</div>
</div>
<div id="outline-container-tasks" class="outline-3">
<h3 id="tasks">Tasks</h3>
<div class="outline-text-3" id="text-tasks">
</div>
<div id="outline-container-managing-tasks" class="outline-4">
<h4 id="managing-tasks">Managing tasks</h4>
<div class="outline-text-4" id="text-managing-tasks">
</div>
<div id="outline-container-todo-keywords" class="outline-5">
<h5 id="todo-keywords">Track TODO state</h5>
<div class="outline-text-5" id="text-todo-keywords">
<p>
<a id="org59f75a9"></a>
</p>

<p>
The parentheses indicate keyboard shortcuts that I can use to set the
task state. <code>@</code> and <code>!</code> toggle logging. <code>@</code> prompts you for a note,
and <code>!</code> automatically logs the timestamp of the state change.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-todo-keywords
      '((sequence
         <span class="org-string">"STARTED(s)"</span>
         <span class="org-string">"TODO(t)"</span>  <span class="org-comment-delimiter">; </span><span class="org-comment">next action</span>
         <span class="org-string">"TOBLOG(b)"</span>  <span class="org-comment-delimiter">; </span><span class="org-comment">next action</span>
         <span class="org-string">"WAITING(w@/!)"</span>
         <span class="org-string">"SOMEDAY(.)"</span> <span class="org-string">"BLOCKED(k@/!)"</span> <span class="org-string">"|"</span> <span class="org-string">"DONE(x!)"</span> <span class="org-string">"CANCELLED(c)"</span>)
        (sequence <span class="org-string">"PROJECT"</span> <span class="org-string">"|"</span> <span class="org-string">"DONE(x)"</span>)
        (sequence <span class="org-string">"LEARN"</span> <span class="org-string">"TRY"</span> <span class="org-string">"TEACH"</span> <span class="org-string">"|"</span> <span class="org-string">"COMPLETE(x)"</span>)
        (sequence <span class="org-string">"TOSKETCH"</span> <span class="org-string">"SKETCHED"</span> <span class="org-string">"|"</span> <span class="org-string">"POSTED"</span>)
        (sequence <span class="org-string">"TOBUY"</span> <span class="org-string">"TOSHRINK"</span> <span class="org-string">"TOCUT"</span>  <span class="org-string">"TOSEW"</span> <span class="org-string">"|"</span> <span class="org-string">"DONE(x)"</span>)
        (sequence <span class="org-string">"TODELEGATE(-)"</span> <span class="org-string">"DELEGATED(d)"</span> <span class="org-string">"|"</span> <span class="org-string">"COMPLETE(x)"</span>)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-todo-keyword-faces
      '((<span class="org-string">"TODO"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"green"</span> <span class="org-builtin">:weight</span> bold))
        (<span class="org-string">"DONE"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"cyan"</span> <span class="org-builtin">:weight</span> bold))
        (<span class="org-string">"WAITING"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"red"</span> <span class="org-builtin">:weight</span> bold))
        (<span class="org-string">"SOMEDAY"</span> . (<span class="org-builtin">:foreground</span> <span class="org-string">"gray"</span> <span class="org-builtin">:weight</span> bold))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-log-done 'time)
</pre>
</div>
</div>
</div>
<div id="outline-container-projects" class="outline-5">
<h5 id="projects">Projects</h5>
<div class="outline-text-5" id="text-projects">
<p>
Projects are headings with the <code>:project:</code> tag, so we generally don't
want that tag inherited, except when we display unscheduled tasks that
don't belong to any projects.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
</pre>
</div>

<p>
This code makes it easy for me to focus on one project and its tasks.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">let</span> ((listvar (<span class="org-keyword">if</span> (boundp 'org-speed-commands) 'org-speed-commands
                   'org-speed-commands-user)))
    (add-to-list listvar '(<span class="org-string">"N"</span> org-narrow-to-subtree))
    (add-to-list listvar '(<span class="org-string">"W"</span> widen))
    (add-to-list listvar '(<span class="org-string">"T"</span> my-org-agenda-for-subtree))
    (add-to-list listvar '(<span class="org-string">"b"</span> my-org-bounce-to-file))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-for-subtree</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (derived-mode-p 'org-agenda-mode) (org-agenda-switch-to))
  (my-org-with-current-task
   (<span class="org-keyword">let</span> ((org-agenda-view-columns-initially t))
     (org-agenda nil <span class="org-string">"t"</span> 'subtree))))

</pre>
</div>

<p>
There's probably a proper way to do this, maybe with <code>&lt;</code>. Oh, that would work nicely. <code>&lt; C-c a t</code> too.
</p>

<p>
And sorting:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">let</span> ((listvar (<span class="org-keyword">if</span> (boundp 'org-speed-commands) 'org-speed-commands
                   'org-speed-commands-user)))
    (add-to-list listvar '(<span class="org-string">"S"</span> call-interactively 'org-sort))))
</pre>
</div>
</div>
</div>
<div id="outline-container-tag-tasks-with-gtd-ish-contexts" class="outline-5">
<h5 id="tag-tasks-with-gtd-ish-contexts">Tag tasks with GTD-ish contexts</h5>
<div class="outline-text-5" id="text-tag-tasks-with-gtd-ish-contexts">
<p>
This defines keyboard shortcuts for those, too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-tag-alist '((<span class="org-string">"work"</span> . ?b)
                      (<span class="org-string">"home"</span> . ?h)
                      (<span class="org-string">"writing"</span> . ?w)
                      (<span class="org-string">"errands"</span> . ?e)
                      (<span class="org-string">"drawing"</span> . ?d)
                      (<span class="org-string">"coding"</span> . ?c)
                      (<span class="org-string">"video"</span> . ?v)
                      (<span class="org-string">"kaizen"</span> . ?k)
                      (<span class="org-string">"phone"</span> . ?p)
                      (<span class="org-string">"learning"</span> . ?a)
                      (<span class="org-string">"reading"</span> . ?r)
                      (<span class="org-string">"computer"</span> . ?l)
                      (<span class="org-string">"quantified"</span> . ?q)
                      (<span class="org-string">"shopping"</span> .?s)
                      (<span class="org-string">"focus"</span> . ?f)))
</pre>
</div>
</div>
</div>
<div id="outline-container-enable-filtering-by-effort-estimates" class="outline-5">
<h5 id="enable-filtering-by-effort-estimates">Enable filtering by effort estimates</h5>
<div class="outline-text-5" id="text-enable-filtering-by-effort-estimates">
<p>
That way, it's easy to see short tasks that I can finish.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'org-global-properties
             '(<span class="org-string">"Effort_ALL"</span>. <span class="org-string">"0:05 0:15 0:30 1:00 2:00 3:00 4:00"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-track-time" class="outline-5">
<h5 id="track-time">Track time</h5>
<div class="outline-text-5" id="text-track-time">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> org-expiry-inactive-timestamps t)
    (<span class="org-keyword">setq</span> org-clock-idle-time nil)
    (<span class="org-keyword">setq</span> org-log-done 'time)
    (<span class="org-keyword">setq</span> org-clock-auto-clock-resolution nil)
    (<span class="org-keyword">setq</span> org-clock-continuously nil)
    (<span class="org-keyword">setq</span> org-clock-persist t)
    (<span class="org-keyword">setq</span> org-clock-in-switch-to-state <span class="org-string">"STARTED"</span>)
    (<span class="org-keyword">setq</span> org-clock-in-resume nil)
    (<span class="org-keyword">setq</span> org-show-notification-handler 'message)
    (<span class="org-keyword">setq</span> org-clock-report-include-clocking-task t))
  <span class="org-builtin">:config</span>
  (org-clock-persistence-insinuate))
</pre>
</div>

<p>
Too many clock entries clutter up a heading.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-log-into-drawer <span class="org-string">"LOGBOOK"</span>)
(<span class="org-keyword">setq</span> org-clock-into-drawer 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-habits" class="outline-5">
<h5 id="habits">Habits</h5>
<div class="outline-text-5" id="text-habits">
<p>
I like using org-habits to track consistency. My task names tend
to be a bit long, though, so I've configured the graph column to
show a little bit more to the right.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-habit-graph-column 80)
(<span class="org-keyword">setq</span> org-habit-show-habits-only-for-today nil)
</pre>
</div>

<p>
If you want to use habits, be sure to schedule your tasks and add a STYLE property with the value of <code>habit</code> to the tasks you want displayed.
</p>
</div>
</div>
</div>
<div id="outline-container-subset" class="outline-4">
<h4 id="subset">Estimating tasks</h4>
<div class="outline-text-4" id="text-subset">
<p>
From "Add an effort estimate on the fly when clocking in" on the
<a href="http://orgmode.org/worg/org-hacks.html">Org Hacks</a> page:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'org-clock-in-prepare-hook
          'my-org-mode-ask-effort)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-mode-ask-effort</span> ()
  <span class="org-doc">"Ask for an effort estimate when clocking in."</span>
  (<span class="org-keyword">unless</span> (org-entry-get (point) <span class="org-string">"Effort"</span>)
    (<span class="org-keyword">let</span> ((effort
           (completing-read
            <span class="org-string">"Effort: "</span>
            (org-entry-get-multivalued-property (point) <span class="org-string">"Effort"</span>))))
      (<span class="org-keyword">unless</span> (equal effort <span class="org-string">""</span>)
        (org-set-property <span class="org-string">"Effort"</span> effort)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-flexible-scheduling-of-tasks" class="outline-4">
<h4 id="flexible-scheduling-of-tasks">Flexible scheduling of tasks</h4>
<div class="outline-text-4" id="text-flexible-scheduling-of-tasks">
<p>
I (theoretically) want to be able to schedule tasks for dates like the first Saturday
of every month. Fortunately, <a href="http://stackoverflow.com/questions/13555385/org-mode-how-to-schedule-repeating-tasks-for-the-first-saturday-of-every-month">someone else has figured that out!</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Get this from https://raw.github.com/chenfengyuan/elisp/master/next-spec-day.el</span>
(load <span class="org-string">"~/elisp/next-spec-day.el"</span> t)
</pre>
</div>
</div>
</div>
<div id="outline-container-task-dependencies" class="outline-4">
<h4 id="task-dependencies">Task dependencies</h4>
<div class="outline-text-4" id="text-task-dependencies">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-enforce-todo-dependencies t)
(<span class="org-keyword">setq</span> org-track-ordered-property-with-tag t)
(<span class="org-keyword">setq</span> org-agenda-dim-blocked-tasks t)
</pre>
</div>
</div>
</div>
<div id="outline-container-quick-way-to-archive-all-done-from-inbox" class="outline-4">
<h4 id="quick-way-to-archive-all-done-from-inbox">Quick way to archive all DONE from inbox&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="computer">computer</span></span></h4>
<div class="outline-text-4" id="text-quick-way-to-archive-all-done-from-inbox">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-clean-up-inbox</span> ()
  <span class="org-doc">"Archive all DONE tasks and sort the remainder by TODO order."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (find-file my-org-inbox-file)
    (my-org-archive-done-tasks 'file)
    (goto-char (point-min))
    (<span class="org-keyword">if</span> (org-at-heading-p) (<span class="org-keyword">save-excursion</span> (insert <span class="org-string">"\n"</span>)))
    (org-sort-entries nil ?p)
    (goto-char (point-min))
    (org-sort-entries nil ?o)
    (save-buffer)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-archive-done-tasks</span> (<span class="org-type">&amp;optional</span> scope)
  <span class="org-doc">"Archive finished or cancelled tasks.</span>
<span class="org-doc">       SCOPE can be 'file or 'tree."</span>
  (<span class="org-keyword">interactive</span>)
  (org-map-entries
   (<span class="org-keyword">lambda</span> ()
     (org-archive-subtree)
     (<span class="org-keyword">setq</span> org-map-continue-from (outline-previous-heading)))
   <span class="org-string">"TODO=\"DONE\"|TODO=\"CANCELLED\""</span> (<span class="org-keyword">or</span> scope (<span class="org-keyword">if</span> (org-before-first-heading-p) 'file 'tree))))
</pre>
</div>
</div>
</div>
<div id="outline-container-strike-through-done-headlines" class="outline-4">
<h4 id="strike-through-done-headlines">Strike through DONE headlines</h4>
<div class="outline-text-4" id="text-strike-through-done-headlines">
<p>
I wanted a quick way to visually distinguish DONE tasks from tasks I
still need to do. This <a href="http://lists.gnu.org/archive/html/emacs-orgmode/2007-03/msg00179.html">handy snippet from the Emacs Org-mode mailing list</a> does the trick by striking through the headlines for DONE tasks.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-fontify-done-headline t)
(custom-set-faces
 '(org-done ((t (<span class="org-builtin">:foreground</span> <span class="org-string">"PaleGreen"</span>
                             <span class="org-builtin">:weight</span> normal
                             <span class="org-builtin">:strike-through</span> t))))
 '(org-headline-done
   ((((class color) (min-colors 16) (background dark))
     (<span class="org-builtin">:foreground</span> <span class="org-string">"LightSalmon"</span> <span class="org-builtin">:strike-through</span> t)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-templates" class="outline-3">
<h3 id="templates">Templates</h3>
<div class="outline-text-3" id="text-templates">
</div>
<div id="outline-container-structure-templates" class="outline-4">
<h4 id="structure-templates">Structure templates</h4>
<div class="outline-text-4" id="text-structure-templates">
<p>
Org makes it easy to insert blocks by typing <code>&lt;s[TAB]</code>, etc.
I hardly ever use LaTeX, but I insert a lot of Emacs Lisp blocks, so I
redefine <code>&lt;l</code> to insert a Lisp block instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-structure-template-alist
      '((<span class="org-string">"a"</span> . <span class="org-string">"export ascii"</span>)
        (<span class="org-string">"C"</span> . <span class="org-string">"center"</span>)
        (<span class="org-string">"c"</span> . <span class="org-string">"comment"</span>)
        (<span class="org-string">"d"</span> . <span class="org-string">"my_details"</span>)
        (<span class="org-string">"e"</span> . <span class="org-string">"example"</span>)
        (<span class="org-string">"E"</span> . <span class="org-string">"export"</span>)
        (<span class="org-string">"m"</span> . <span class="org-string">"export md"</span>)
        (<span class="org-string">"h"</span> . <span class="org-string">"export html"</span>)
        (<span class="org-string">"j"</span> . <span class="org-string">"src js :spookfox t"</span>)
        (<span class="org-string">"l"</span> . <span class="org-string">"src emacs-lisp"</span>)
        (<span class="org-string">"p"</span> . <span class="org-string">"src python"</span>)
        (<span class="org-string">"n"</span> . <span class="org-string">"notes"</span>)
        (<span class="org-string">"q"</span> . <span class="org-string">"quote"</span>)
        (<span class="org-string">"s"</span> . <span class="org-string">"src"</span>)
        (<span class="org-string">"S"</span> . <span class="org-string">"src sh"</span>)
        (<span class="org-string">"u"</span> . <span class="org-string">"update"</span>)
        (<span class="org-string">"v"</span> . <span class="org-string">"verse"</span>)))
</pre>
</div>

<p>
This lets me nest quotes. <a href="http://emacs.stackexchange.com/questions/2404/exporting-org-mode-nested-blocks-to-html">http://emacs.stackexchange.com/questions/2404/exporting-org-mode-nested-blocks-to-html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-html-quote2</span> (block backend info)
  (<span class="org-keyword">when</span> (org-export-derived-backend-p backend 'html)
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"\\`&lt;div class=\"quote2\"&gt;"</span> block)
      (<span class="org-keyword">setq</span> block (replace-match <span class="org-string">"&lt;blockquote&gt;"</span> t nil block))
      (string-match <span class="org-string">"&lt;/div&gt;\n\\'"</span> block)
      (<span class="org-keyword">setq</span> block (replace-match <span class="org-string">"&lt;/blockquote&gt;\n"</span> t nil block))
      block)))
(eval-after-load 'ox
  '(add-to-list 'org-export-filter-special-block-functions 'my-org-html-quote2))
</pre>
</div>
</div>
<div id="outline-container-demarcate-but-for-begin-notes" class="outline-5">
<h5 id="demarcate-but-for-begin-notes">Demarcate, but for all blocks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="config">config</span></span></h5>
<div class="outline-text-5" id="text-demarcate-but-for-begin-notes">
<p>
I often want to split an Org Mode block so that I can add stuff in between. This code is based on
<a href="https://scripter.co/splitting-an-org-block-into-two/">https://scripter.co/splitting-an-org-block-into-two/</a> .
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">modi/org-split-block</span> ()
  <span class="org-doc">"Sensibly split the current Org block at point."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (modi/org-in-any-block-p)
      (<span class="org-keyword">save-match-data</span>
        (<span class="org-keyword">save-restriction</span>
          (widen)
          (<span class="org-keyword">let</span> ((case-fold-search t)
                (at-bol (bolp))
                block-start
                block-end)
            (<span class="org-keyword">save-excursion</span>
              (re-search-backward <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?1:</span></span><span class="org-string">[[:blank:]]*#\\+begin_.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> .*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*$"</span> nil nil 1)
              (<span class="org-keyword">setq</span> block-start (match-string-no-properties 0))
              (<span class="org-keyword">setq</span> block-end (replace-regexp-in-string
                               <span class="org-string">"begin_"</span> <span class="org-string">"end_"</span> <span class="org-comment-delimiter">;</span><span class="org-comment">Replaces "begin_" with "end_", "BEGIN_" with "END_"</span>
                               (match-string-no-properties 1))))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Go to the end of current line, if not at the BOL</span>
            (<span class="org-keyword">unless</span> at-bol
              (end-of-line 1))
            (insert (concat (<span class="org-keyword">if</span> at-bol <span class="org-string">""</span> <span class="org-string">"\n"</span>)
                            block-end
                            <span class="org-string">"\n\n"</span>
                            block-start
                            (<span class="org-keyword">if</span> at-bol <span class="org-string">"\n"</span> <span class="org-string">""</span>)))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Go to the line before the inserted "#+begin_ .." line</span>
            (beginning-of-line (<span class="org-keyword">if</span> at-bol -1 0)))))
    (message <span class="org-string">"Point is not in an Org block"</span>)))
(<span class="org-keyword">defalias</span> '<span class="org-function-name">my-org-demarcate-block</span> #'modi/org-split-block)
(<span class="org-keyword">defalias</span> '<span class="org-function-name">my-org-split-block</span> #'modi/org-split-block)


(<span class="org-keyword">defun</span> <span class="org-function-name">modi/org-in-any-block-p</span> ()
  <span class="org-doc">"Return non-nil if the point is in any Org block.</span>

<span class="org-doc">The Org block can be *any*: src, example, verse, etc., even any</span>
<span class="org-doc">Org Special block.</span>

<span class="org-doc">This function is heavily adapted from `</span><span class="org-doc"><span class="org-constant">org-between-regexps-p</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">save-match-data</span>
    (<span class="org-keyword">let</span> ((pos (point))
          (case-fold-search t)
          (block-begin-re <span class="org-string">"^[[:blank:]]*#\\+begin_</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?1:</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> .*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*$"</span>)
          (limit-up (<span class="org-keyword">save-excursion</span> (outline-previous-heading)))
          (limit-down (<span class="org-keyword">save-excursion</span> (outline-next-heading)))
          beg end)
      (<span class="org-keyword">save-excursion</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Point is on a block when on BLOCK-BEGIN-RE or if</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">BLOCK-BEGIN-RE can be found before it...</span>
        (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> (org-in-regexp block-begin-re)
                 (re-search-backward block-begin-re limit-up <span class="org-builtin">:noerror</span>))
             (<span class="org-keyword">setq</span> beg (match-beginning 0))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">... and BLOCK-END-RE after it...</span>
             (<span class="org-keyword">let</span> ((block-end-re (concat <span class="org-string">"^[[:blank:]]*#\\+end_"</span>
                                         (match-string-no-properties 1)
                                         <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> .*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*$"</span>)))
               (goto-char (match-end 0))
               (re-search-forward block-end-re limit-down <span class="org-builtin">:noerror</span>))
             (&gt; (<span class="org-keyword">setq</span> end (match-end 0)) pos)
             <span class="org-comment-delimiter">;; </span><span class="org-comment">... without another BLOCK-BEGIN-RE in-between.</span>
             (goto-char (match-beginning 0))
             (not (re-search-backward block-begin-re (1+ beg) <span class="org-builtin">:noerror</span>))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">Return value.</span>
             (cons beg end))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-emacs-chats-emacs-hangouts" class="outline-4">
<h4 id="emacs-chats-emacs-hangouts">Emacs chats, Emacs hangouts</h4>
<div class="outline-text-4" id="text-emacs-chats-emacs-hangouts">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-link-youtube-time</span> (url beg end)
  <span class="org-doc">"Link times of the form h:mm to YouTube video at URL.</span>
<span class="org-doc">       Works on region defined by BEG and END."</span>
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"URL: "</span> (org-entry-get-with-inheritance <span class="org-string">"YOUTUBE"</span>)) (point) (mark)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">save-restriction</span>
      (narrow-to-region beg end)
      (goto-char (point-min))
      (<span class="org-keyword">let</span> ((char (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\?"</span> url) <span class="org-string">"&amp;"</span> <span class="org-string">"?"</span>)))
        (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> ::"</span> nil t)
          (replace-match
           (format <span class="org-string">"[[%s%st=%sh%sm%ss][%s]] "</span>
                   url
                   char
                   (match-string 2)
                   (match-string 3)
                   (<span class="org-keyword">or</span> (match-string 5) <span class="org-string">"0"</span>)
                   (match-string 1)) <span class="org-warning">nil t))))))</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-clean-up-google-hangout-chat</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;hr.*?div class=\"Kc-Ma-m\".*?&gt;"</span> nil t)
      (replace-match <span class="org-string">"\n| "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;div class=\"Kc-yi-m\"&gt;"</span> nil t)
      (replace-match <span class="org-string">" | "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;/div&gt;&lt;div class=\"Kc-ib\"&gt;"</span> nil t)
      (replace-match <span class="org-string">" | "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;a rel=\"nofollow\" target=\"_blank\" href=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\"&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/a&gt;"</span> nil t)
      (replace-match <span class="org-string">"[[\\1][\\2]]"</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;"</span> nil t)
      (replace-match <span class="org-string">" |"</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&amp;nbsp;"</span> nil t)
      (replace-match <span class="org-string">" "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/div&gt;&lt;div class=\"Kc-ib\"&gt;"</span> nil t)
      (replace-match <span class="org-string">" "</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;img.*?&gt;"</span> nil t)
      (replace-match <span class="org-string">""</span>)))
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;wbr&gt;"</span> nil t)
      (replace-match <span class="org-string">""</span>)))
  )
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org-agenda" class="outline-3">
<h3 id="org-agenda">Org agenda</h3>
<div class="outline-text-3" id="text-org-agenda">
</div>
<div id="outline-container-project_subtasks" class="outline-4">
<h4 id="project_subtasks">Basic configuration</h4>
<div class="outline-text-4" id="text-project_subtasks">
<p>
I have quite a few Org files, but I keep my agenda items and TODOs in
only a few of them them for faster scanning.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-kid-org-file</span> nil <span class="org-doc">"Defined in secrets"</span>)
(<span class="org-keyword">setq</span> org-agenda-files
      (delq nil
            (mapcar (<span class="org-keyword">lambda</span> (x) (<span class="org-keyword">and</span> x (file-exists-p x) x))
                    `(<span class="org-string">"~/sync/orgzly/organizer.org"</span>
                      <span class="org-string">"~/sync/orgzly/Inbox.org"</span>
                      <span class="org-string">"~/sync/orgzly/garden.org"</span>
                      <span class="org-string">"~/sync/orgzly/decisions.org"</span>
                      <span class="org-string">"~/sync/orgzly/computer-inbox.org"</span>
                      <span class="org-string">"~/sync/orgzly/crafts.org"</span>
                      <span class="org-string">"~/sync/emacs/Sacha.org"</span>
                      <span class="org-string">"~/proj/stream/index.org"</span>
                      <span class="org-string">"~/proj/plover-notes/README.org"</span>
                      <span class="org-string">"~/personal/sewing.org"</span>
                      <span class="org-string">"~/sync/orgzly/people.org"</span>
                      <span class="org-string">"~/sync/orgzly/business.org"</span>
                      <span class="org-string">"~/Dropbox/wsmef/trip.txt"</span>
                      ,my-kid-org-file
                      <span class="org-string">"~/personal/orgzly.org"</span>
                      <span class="org-string">"~/personal/calendar.org"</span>
                      <span class="org-string">"~/Dropbox/tasker/summary.txt"</span>
                      <span class="org-string">"~/Dropbox/public/sharing/index.org"</span>
                      <span class="org-string">"~/dropbox/public/sharing/learning.org"</span>
                      <span class="org-string">"~/proj/emacs-notes/tasks.org"</span>
                      <span class="org-string">"~/proj/sachac.github.io/evil-plans/index.org"</span>
                      <span class="org-string">"~/sync/orgzly/cooking.org"</span>
                      <span class="org-string">"~/sync/orgzly/routines.org"</span>))))
(<span class="org-keyword">setq</span> org-agenda-dim-blocked-tasks nil)
(add-to-list 'auto-mode-alist '(<span class="org-string">"\\.txt$"</span> . org-mode))
</pre>
</div>


<p>
I like looking at two days at a time when I plan using the Org
agenda. I want to see my log entries, but I don't want to see
scheduled items that I've finished. I like seeing a time grid so that
I can get a sense of how appointments are spread out.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-agenda-span 2)
(<span class="org-keyword">setq</span> org-agenda-tags-column -100) <span class="org-comment-delimiter">; </span><span class="org-comment">take advantage of the screen width</span>
(<span class="org-keyword">setq</span> org-agenda-sticky nil)
(<span class="org-keyword">setq</span> org-agenda-inhibit-startup t)
(<span class="org-keyword">setq</span> org-agenda-use-tag-inheritance t)
(<span class="org-keyword">setq</span> org-agenda-show-log t)
(<span class="org-keyword">setq</span> org-agenda-skip-scheduled-if-done t)
(<span class="org-keyword">setq</span> org-agenda-skip-deadline-if-done t)
(<span class="org-keyword">setq</span> org-agenda-skip-deadline-prewarning-if-scheduled 'pre-scheduled)
(<span class="org-keyword">setq</span> org-agenda-time-grid
      '((daily today require-timed)
        (800 1000 1200 1400 1600 1800 2000)
        <span class="org-string">"......"</span> <span class="org-string">"----------------"</span>))
(<span class="org-keyword">setq</span> org-columns-default-format <span class="org-string">"%14SCHEDULED %Effort{:} %1PRIORITY %TODO %50ITEM %TAGS"</span>)
</pre>
</div>

<p>
Some other keyboard shortcuts:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"Y"</span> 'org-agenda-todo-yesterday org-agenda-mode-map)
</pre>
</div>
</div>
</div>
<div id="outline-container-starting-my-weeks-on-saturday" class="outline-4">
<h4 id="starting-my-weeks-on-saturday">Starting my weeks on Saturday</h4>
<div class="outline-text-4" id="text-starting-my-weeks-on-saturday">
<p>
I like looking at weekends as <a href="http://sachachua.com/blog/2010/11/week-beginnings/">week beginnings</a> instead, so I want the
Org agenda to start on Saturdays.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-agenda-start-on-weekday 6)
</pre>
</div>
</div>
</div>
<div id="outline-container-agenda_commands" class="outline-4">
<h4 id="agenda_commands">Display projects with associated subtasks</h4>
<div class="outline-text-4" id="text-agenda_commands">
<p>
I wanted a view that showed projects with a few subtasks underneath
them. Here's a sample of the output:
</p>

<pre class="example" id="orgad20221">
Headlines with TAGS match: +PROJECT
Press `C-u r' to search again with new search string
  organizer:  Set up communication processes for Awesome Foundation Toronto
  organizer:  TODO Announce the next pitch night
  organizer:  TODO Follow up with the winner of the previous pitch night for any news to include in the updates

  organizer:  Tidy up the house so that I can find things quickly
  organizer:  TODO Inventory all the things in closets and boxes         :@home:
  organizer:  TODO Drop things off for donation                       :@errands:

  organizer:  Learn how to develop for Android devices
</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-project-agenda</span> ()
  <span class="org-doc">"Return the project headline and up to `</span><span class="org-doc"><span class="org-constant">org-agenda-max-entries</span></span><span class="org-doc">' tasks."</span>
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let*</span> ((marker (org-agenda-new-marker))
           (heading
            (org-agenda-format-item <span class="org-string">""</span> (org-get-heading) (org-get-category) nil))
           (org-agenda-restrict t)
           (org-agenda-restrict-begin (point))
           (org-agenda-restrict-end (org-end-of-subtree 'invisible))
           <span class="org-comment-delimiter">;; </span><span class="org-comment">Find the TODO items in this subtree</span>
           (list (org-agenda-get-day-entries (buffer-file-name) (calendar-current-date) <span class="org-builtin">:todo</span>)))
      (org-add-props heading
          (list 'face 'defaults
                'done-face 'org-agenda-done
                'undone-face 'default
                'mouse-face 'highlight
                'org-not-done-regexp org-not-done-regexp
                'org-todo-regexp org-todo-regexp
                'org-complex-heading-regexp org-complex-heading-regexp
                'help-echo
                (format <span class="org-string">"mouse-2 or RET jump to org file %s"</span>
                        (abbreviate-file-name
                         (<span class="org-keyword">or</span> (buffer-file-name (buffer-base-buffer))
                             (buffer-name (buffer-base-buffer))))))
        'org-marker marker
        'org-hd-marker marker
        'org-category (org-get-category)
        'type <span class="org-string">"tagsmatch"</span>)
      (concat heading <span class="org-string">"\n"</span>
              (org-agenda-finalize-entries list)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-projects-and-tasks</span> (match)
  <span class="org-doc">"Show TODOs for all `</span><span class="org-doc"><span class="org-constant">org-agenda-files</span></span><span class="org-doc">' headlines matching MATCH."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MString: "</span>)
  (<span class="org-keyword">let</span> ((todo-only nil))
    (<span class="org-keyword">if</span> org-agenda-overriding-arguments
        (<span class="org-keyword">setq</span> todo-only (car org-agenda-overriding-arguments)
              match (nth 1 org-agenda-overriding-arguments)))
    (<span class="org-keyword">let*</span> ((org-tags-match-list-sublevels
            org-tags-match-list-sublevels)
           (completion-ignore-case t)
           rtn rtnall files file pos matcher
           buffer)
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (stringp match) (not (string-match <span class="org-string">"\\S-"</span> match)))
        (<span class="org-keyword">setq</span> match nil))
      (<span class="org-keyword">when</span> match
        (<span class="org-keyword">setq</span> matcher (org-make-tags-matcher match)
              match (car matcher) matcher (cdr matcher)))
      (<span class="org-keyword">catch</span> '<span class="org-constant">exit</span>
        (<span class="org-keyword">if</span> org-agenda-sticky
            (<span class="org-keyword">setq</span> org-agenda-buffer-name
                  (<span class="org-keyword">if</span> (stringp match)
                      (format <span class="org-string">"*Org Agenda(%s:%s)*"</span>
                              (<span class="org-keyword">or</span> org-keys (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> todo-only <span class="org-string">"M"</span>) <span class="org-string">"m"</span>)) match)
                    (format <span class="org-string">"*Org Agenda(%s)*"</span> (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> todo-only <span class="org-string">"M"</span>) <span class="org-string">"m"</span>)))))
        (org-agenda-prepare (concat <span class="org-string">"TAGS "</span> match))
        (org-compile-prefix-format 'tags)
        (org-set-sorting-strategy 'tags)
        (<span class="org-keyword">setq</span> org-agenda-query-string match)
        (<span class="org-keyword">setq</span> org-agenda-redo-command
              (list 'org-tags-view `(<span class="org-keyword">quote</span> ,todo-only)
                    (list 'if 'current-prefix-arg nil `(<span class="org-keyword">quote</span> ,org-agenda-query-string))))
        (<span class="org-keyword">setq</span> files (org-agenda-files nil 'ifmode)
              rtnall nil)
        (<span class="org-keyword">while</span> (<span class="org-keyword">setq</span> file (<span class="org-keyword">pop</span> files))
          (<span class="org-keyword">catch</span> '<span class="org-constant">nextfile</span>
            (org-check-agenda-file file)
            (<span class="org-keyword">setq</span> buffer (<span class="org-keyword">if</span> (file-exists-p file)
                             (org-get-agenda-file-buffer file)
                           (<span class="org-warning">error</span> <span class="org-string">"No such file %s"</span> file)))
            (<span class="org-keyword">if</span> (not buffer)
                <span class="org-comment-delimiter">;; </span><span class="org-comment">If file does not exist, error message to agenda</span>
                (<span class="org-keyword">setq</span> rtn (list
                           (format <span class="org-string">"ORG-AGENDA-ERROR: No such org-file %s"</span> file))
                      rtnall (append rtnall rtn))
              (<span class="org-keyword">with-current-buffer</span> buffer
                (<span class="org-keyword">unless</span> (derived-mode-p 'org-mode)
                  (<span class="org-warning">error</span> <span class="org-string">"Agenda file %s is not in `</span><span class="org-string"><span class="org-constant">org-mode</span></span><span class="org-string">'"</span> file))
                (<span class="org-keyword">save-excursion</span>
                  (<span class="org-keyword">save-restriction</span>
                    (<span class="org-keyword">if</span> org-agenda-restrict
                        (narrow-to-region org-agenda-restrict-begin
                                          org-agenda-restrict-end)
                      (widen))
                    (<span class="org-keyword">setq</span> rtn (org-scan-tags 'my-org-agenda-project-agenda matcher todo-only))
                    (<span class="org-keyword">setq</span> rtnall (append rtnall rtn))))))))
        (<span class="org-keyword">if</span> org-agenda-overriding-header
            (insert (org-add-props (copy-sequence org-agenda-overriding-header)
                        nil 'face 'org-agenda-structure) <span class="org-string"><span class="org-warning">"\n"</span></span><span class="org-warning">)</span>
          (insert <span class="org-string">"Headlines with TAGS match: "</span>)
          (add-text-properties (point-min) (1- (point))
                               (list 'face 'org-agenda-structure
                                     'short-heading
                                     (concat <span class="org-string">"Match: "</span> match)))
          (<span class="org-keyword">setq</span> pos (point))
          (insert match <span class="org-string">"\n"</span>)
          (add-text-properties pos (1- (point)) (list 'face 'org-warning))
          (<span class="org-keyword">setq</span> pos (point))
          (<span class="org-keyword">unless</span> org-agenda-multi
            (insert <span class="org-string">"Press `C-u r' to search again with new search string\n"</span>))
          (add-text-properties pos (1- (point)) (list 'face 'org-agenda-structure)))
        (org-agenda-mark-header-line (point-min))
        (<span class="org-keyword">when</span> rtnall
          (insert (mapconcat 'identity rtnall <span class="org-string">"\n"</span>) <span class="org-string">""</span>))
        (goto-char (point-min))
        (<span class="org-keyword">or</span> org-agenda-multi (org-agenda-fit-window-to-buffer))
        (add-text-properties (point-min) (point-max)
                             `(org-agenda-type tags
                                               org-last-args (,todo-only ,match)
                                               org-redo-cmd ,org-agenda-redo-command
                                               org-series-cmd ,org-cmd))
        (org-agenda-finalize)
        (<span class="org-keyword">setq</span> buffer-read-only t)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-agenda-custom-commands" class="outline-4">
<h4 id="org-agenda-custom-commands">Org agenda custom commands</h4>
<div class="outline-text-4" id="text-org-agenda-custom-commands">
<p>
There are quite a few custom commands here, and I often forget to use
them. =) But it's good to define them, and over time, I'll get the
hang of using these more!
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Key</td>
<td class="org-left">Description</td>
</tr>

<tr>
<td class="org-left">.</td>
<td class="org-left">What am I waiting for?</td>
</tr>

<tr>
<td class="org-left">T</td>
<td class="org-left">Not really an agenda command - shows the to-do tree in the current file</td>
</tr>

<tr>
<td class="org-left">b</td>
<td class="org-left">Shows business-related tasks</td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left">Shows personal tasks and miscellaneous tasks (o: organizer)</td>
</tr>

<tr>
<td class="org-left">w</td>
<td class="org-left">Show all tasks for the upcoming week</td>
</tr>

<tr>
<td class="org-left">W</td>
<td class="org-left">Show all tasks for the upcoming week, aside from the routine ones</td>
</tr>

<tr>
<td class="org-left">g &#x2026;</td>
<td class="org-left">Show tasks by context: b - business; c - coding; w - writing; p - phone; d - drawing, h - home</td>
</tr>

<tr>
<td class="org-left">0</td>
<td class="org-left">Show common contexts with up to 3 tasks each, so that I can choose what I feel like working on</td>
</tr>

<tr>
<td class="org-left">) (shift-0)</td>
<td class="org-left">Show common contexts with all the tasks associated with them</td>
</tr>

<tr>
<td class="org-left">9</td>
<td class="org-left">Show common contexts with up to 3 unscheduled tasks each</td>
</tr>

<tr>
<td class="org-left">( (shift-9)</td>
<td class="org-left">Show common contexts with all the unscheduled tasks associated with them</td>
</tr>

<tr>
<td class="org-left">d</td>
<td class="org-left">Timeline for today (agenda, clock summary)</td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left">Unscheduled tasks to do if I have free time</td>
</tr>

<tr>
<td class="org-left">U</td>
<td class="org-left">Unscheduled tasks that are not part of projects</td>
</tr>

<tr>
<td class="org-left">P</td>
<td class="org-left">Tasks by priority</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">My projects</td>
</tr>

<tr>
<td class="org-left">2</td>
<td class="org-left">Projects with tasks</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"&lt;apps&gt; a"</span> 'org-agenda)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-agenda-contexts</span>
  '((tags-todo <span class="org-string">"phone"</span>)
    (tags-todo <span class="org-string">"work"</span>)
    (tags-todo <span class="org-string">"drawing"</span>)
    (tags-todo <span class="org-string">"coding"</span>)
    (tags-todo <span class="org-string">"writing"</span>)
    (tags-todo <span class="org-string">"computer"</span>)
    (tags-todo <span class="org-string">"home"</span>)
    (tags-todo <span class="org-string">"errands"</span>))
  <span class="org-doc">"Usual list of contexts."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-skip-scheduled</span> ()
  (org-agenda-skip-entry-if 'scheduled 'deadline 'regexp <span class="org-string">"\n]+&gt;"</span>))

(<span class="org-keyword">use-package</span> org-super-agenda
  <span class="org-builtin">:init</span>
  (org-super-agenda-mode 1))
(<span class="org-keyword">use-package</span> org-ql)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-projects</span> ()
  (<span class="org-keyword">interactive</span>)
(org-ql-search (org-agenda-files)
  '(and (todo <span class="org-string">"TODO"</span> <span class="org-string">"WAITING"</span>) (ancestors (tags <span class="org-string">"project"</span>)))
  <span class="org-builtin">:super-groups</span> '((<span class="org-builtin">:auto-parent</span> t))))

(<span class="org-keyword">setq</span> org-agenda-custom-commands
      `((<span class="org-string">"a"</span> <span class="org-string">"Agenda"</span>
         ((agenda <span class="org-string">""</span> ((org-agenda-span 2)))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">(alltodo</span>
          <span class="org-comment-delimiter">;;  </span><span class="org-comment">""</span>
          <span class="org-comment-delimiter">;;  </span><span class="org-comment">((org-agenda-overriding-header "")</span>
          <span class="org-comment-delimiter">;;   </span><span class="org-comment">(org-super-agenda-groups</span>
          <span class="org-comment-delimiter">;;    </span><span class="org-comment">'((:name "Inbox, unscheduled"</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:and (:scheduled nil</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">                            :file-path "Inbox.org"</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">                            )</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:order 1)</span>
          <span class="org-comment-delimiter">;;      </span><span class="org-comment">(:name "Important, unscheduled"</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:and (:priority "A"</span>
          <span class="org-comment-delimiter">;;                             </span><span class="org-comment">:scheduled nil)</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:order 2)</span>

          <span class="org-comment-delimiter">;;      </span><span class="org-comment">(:name "Project-related, unscheduled"</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:and (:tag "project" :date nil :todo ("STARTED" "WAITING" "TODO"))</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:order 3)</span>
          <span class="org-comment-delimiter">;;      </span><span class="org-comment">(:name "Waiting"</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:and (:todo "WAITING"</span>
          <span class="org-comment-delimiter">;;                         </span><span class="org-comment">:scheduled nil)</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:order 4)</span>
          <span class="org-comment-delimiter">;;      </span><span class="org-comment">(:discard (:todo "SOMEDAY"</span>
          <span class="org-comment-delimiter">;;                       </span><span class="org-comment">:category "cooking"</span>
          <span class="org-comment-delimiter">;;                       </span><span class="org-comment">:date t))</span>
          <span class="org-comment-delimiter">;;      </span><span class="org-comment">(:name "Unscheduled"</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:scheduled nil</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">:order 5)</span>
          <span class="org-comment-delimiter">;;      </span><span class="org-comment">(:discard (:anything t))</span>
          <span class="org-comment-delimiter">;;      </span><span class="org-comment">)</span>
          <span class="org-comment-delimiter">;;    </span><span class="org-comment">)))</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">(tags-todo "TODO=\"TODO\"-project-cooking-routine-errands-shopping-video-evilplans"</span>
          <span class="org-comment-delimiter">;;            </span><span class="org-comment">((org-agenda-skip-function 'my-org-agenda-skip-scheduled)</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">(org-agenda-prefix-format "%-6e ")</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">(org-agenda-overriding-header "Unscheduled TODO entries: ")</span>
          <span class="org-comment-delimiter">;;             </span><span class="org-comment">(org-agenda-sorting-strategy '(priority-down effort-up tag-up category-keep))))</span>
          ))
        (<span class="org-string">"e"</span> <span class="org-string">"Emacs"</span> tags <span class="org-string">"emacs"</span>)
        (<span class="org-string">"n"</span> <span class="org-string">"Emacs News"</span> tags <span class="org-string">"news"</span> ((org-agenda-files '(<span class="org-string">"~/sync/orgzly/Inbox.org"</span>
                                                           <span class="org-string">"~/sync/orgzly/news.org"</span>))))
        (<span class="org-string">"E"</span> <span class="org-string">"Emacsconf"</span> tags-todo <span class="org-string">"emacsconf"</span>
         ((org-agenda-sorting-strategy '(priority-down effort-up category-keep)))
         )
        (<span class="org-string">"i"</span> <span class="org-string">"Inbox"</span> alltodo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/sync/orgzly/Inbox.org"</span> <span class="org-string">"~/sync/orgzly/computer-inbox.org"</span>))))
        (<span class="org-string">"t"</span> tags-todo <span class="org-string">"-cooking"</span>
         ((org-agenda-sorting-strategy '(todo-state-up priority-down effort-up))))
        (<span class="org-string">"T"</span> tags-todo <span class="org-string">"TODO=\"TODO\"-goal-routine-cooking-SCHEDULED={.+}"</span> nil <span class="org-string">"~/cloud/agenda/nonroutine.html"</span>)
        (<span class="org-string">"f"</span> tags-todo <span class="org-string">"focus-TODO=\"DONE\"-TODO=\"CANCELLED\""</span>)
        (<span class="org-string">"b"</span> todo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/sync/orgzly/business.org"</span>))))
        (<span class="org-string">"B"</span> todo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/Dropbox/books"</span>))))
        (<span class="org-string">"x"</span> <span class="org-string">"Column view"</span> todo <span class="org-string">""</span>      <span class="org-comment-delimiter">; </span><span class="org-comment">Column view</span>
         ((org-agenda-prefix-format <span class="org-string">""</span>)
          (org-agenda-cmp-user-defined 'my-org-sort-agenda-items-todo)
          (org-agenda-view-columns-initially t)
          ))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Weekly review</span>
        (<span class="org-string">"w"</span> <span class="org-string">"Weekly review"</span> agenda <span class="org-string">""</span>
         ((org-agenda-span 7)
          (org-agenda-log-mode 1)) <span class="org-string"><span class="org-warning">"~/cloud/agenda/this-week.html"</span></span><span class="org-warning">)</span>
        (<span class="org-string">"W"</span> <span class="org-string">"Weekly review sans routines"</span> agenda <span class="org-string">""</span>
         ((org-agenda-span 7)
          (org-agenda-log-mode 1)
          (org-agenda-tag-filter-preset '(<span class="org-string">"-routine"</span>))) <span class="org-string"><span class="org-warning">"~/cloud/agenda/this-week-nonroutine.html"</span></span><span class="org-warning">)</span>
        (<span class="org-string">"2"</span> <span class="org-string">"Bi-weekly review"</span> agenda <span class="org-string">""</span> ((org-agenda-span 14) (org-agenda-log-mode 1)))
        (<span class="org-string">"5"</span> <span class="org-string">"Quick tasks"</span> tags-todo <span class="org-string">"EFFORT&gt;=\"0:05\"&amp;EFFORT&lt;=\"0:15\""</span>)
        (<span class="org-string">"0"</span> <span class="org-string">"Unestimated tasks"</span> tags-todo <span class="org-string">"EFFORT=\"\""</span>)
        (<span class="org-string">"gb"</span> <span class="org-string">"Business"</span> todo <span class="org-string">""</span>
         ((org-agenda-files '(<span class="org-string">"~/sync/orgzly/business.org"</span>))
          (org-agenda-view-columns-initially t)))
        (<span class="org-string">"gc"</span> <span class="org-string">"Coding"</span> tags-todo <span class="org-string">"@coding"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gw"</span> <span class="org-string">"Writing"</span> tags-todo <span class="org-string">"@writing"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gp"</span> <span class="org-string">"Phone"</span> tags-todo <span class="org-string">"@phone"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gd"</span> <span class="org-string">"Drawing"</span> tags-todo <span class="org-string">"@drawing"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gh"</span> <span class="org-string">"Home"</span> tags-todo <span class="org-string">"@home"</span>
         ((org-agenda-view-columns-initially t)))
        (<span class="org-string">"gk"</span> <span class="org-string">"Kaizen"</span> tags-todo <span class="org-string">"kaizen"</span>
         ((org-agenda-view-columns-initially t))
         (<span class="org-string">"~/cloud/agenda/kaizen.html"</span>))
        (<span class="org-string">"ge"</span> <span class="org-string">"Errands"</span> tags-todo <span class="org-string">"errands"</span>
         ((org-agenda-view-columns-initially t))
         (<span class="org-string">"~/cloud/agenda/errands.html"</span>))
        (<span class="org-string">"c"</span> <span class="org-string">"Top 3 by context"</span>
         ,my-org-agenda-contexts
         ((org-agenda-sorting-strategy '(priority-up effort-down))
          (org-agenda-max-entries 3)))
        (<span class="org-string">"C"</span> <span class="org-string">"All by context"</span>
         ,my-org-agenda-contexts
         ((org-agenda-sorting-strategy '(priority-down effort-down))
          (org-agenda-max-entries nil)))
        (<span class="org-string">"9"</span> <span class="org-string">"Unscheduled top 3 by context"</span>
         ,my-org-agenda-contexts
         ((org-agenda-skip-function 'my-org-agenda-skip-scheduled)
          (org-agenda-sorting-strategy '(priority-down effort-down))
          (org-agenda-max-entries 3)))
        (<span class="org-string">"("</span> <span class="org-string">"All unscheduled by context"</span>
         ,my-org-agenda-contexts
         ((org-agenda-skip-function 'my-org-agenda-skip-scheduled)
          (org-agenda-sorting-strategy '(priority-down effort-down))
          ))
        (<span class="org-string">"d"</span> <span class="org-string">"Timeline for today"</span> ((agenda <span class="org-string">""</span> ))
         ((org-agenda-ndays 1)
          (org-agenda-show-log t)
          (org-agenda-log-mode-items '(clock closed))
          (org-agenda-clockreport-mode t)
          (org-agenda-entry-types '())))
        (<span class="org-string">"."</span> <span class="org-string">"Waiting for"</span> todo <span class="org-string">"WAITING"</span>)
        (<span class="org-string">"u"</span> <span class="org-string">"Unscheduled tasks"</span> tags-todo <span class="org-string">"-someday-TODO=\"SOMEDAY\"-TODO=\"DELEGATED\"-TODO=\"WAITING\"-project-cooking-routine"</span>
         ((org-agenda-skip-function 'my-org-agenda-skip-scheduled)
          (org-agenda-view-columns-initially nil)
          (org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-overriding-header <span class="org-string">"Unscheduled TODO entries: "</span>)
          (org-columns-default-format <span class="org-string">"%50ITEM %TODO %3PRIORITY %Effort{:} %TAGS"</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down effort-up tag-up category-keep))))
        (<span class="org-string">"r"</span> <span class="org-string">"Unscheduled, untagged tasks"</span> tags-todo <span class="org-string">"-someday-TODO=\"SOMEDAY\"-TODO=\"DELEGATED\"-TODO=\"WAITING\"-project-cooking-routine-evilplans-computer-writing-phone-sewing-home-errands-shopping"</span>
         ((org-agenda-skip-function 'my-org-agenda-skip-scheduled)
          (org-agenda-view-columns-initially nil)
          (org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-overriding-header <span class="org-string">"Unscheduled TODO entries: "</span>)
          (org-columns-default-format <span class="org-string">"%50ITEM %TODO %3PRIORITY %Effort{:} %TAGS"</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down effort-up tag-up category-keep))))
        (<span class="org-string">"!"</span> <span class="org-string">"Someday"</span> tags-todo <span class="org-string">"TODO=\"SOMEDAY\""</span>
         ((org-agenda-skip-function 'my-org-agenda-skip-scheduled)
          (org-agenda-view-columns-initially nil)
          (org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-overriding-header <span class="org-string">"Someday: "</span>)
          (org-columns-default-format <span class="org-string">"%50ITEM %TODO %3PRIORITY %Effort{:} %TAGS"</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down effort-up tag-up category-keep))))
        (<span class="org-string">"U"</span> <span class="org-string">"Unscheduled tasks outside projects"</span> tags-todo <span class="org-string">"-project-cooking-routine"</span>
         ((org-agenda-skip-function 'my-org-agenda-skip-scheduled)
          (org-tags-exclude-from-inheritance nil)
          (org-agenda-view-columns-initially nil)
          (org-agenda-overriding-header <span class="org-string">"Unscheduled TODO entries outside projects: "</span>)
          (org-agenda-sorting-strategy '(todo-state-up priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"P"</span> <span class="org-string">"By priority"</span>
         ((tags-todo <span class="org-string">"+PRIORITY=\"A\""</span>)
          (tags-todo <span class="org-string">"+PRIORITY=\"B\""</span>)
          (tags-todo <span class="org-string">"+PRIORITY=\"\""</span>)
          (tags-todo <span class="org-string">"+PRIORITY=\"C\""</span>))
         ((org-agenda-prefix-format <span class="org-string">"%-10c %-10T %e "</span>)
          (org-agenda-sorting-strategy '(priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"pp"</span> tags <span class="org-string">"+project-someday-TODO=\"DONE\"-TODO=\"SOMEDAY\"-inactive"</span>
         ((org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-sorting-strategy '(priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"p."</span> tags <span class="org-string">"+project-TODO=\"DONE\""</span>
         ((org-tags-exclude-from-inheritance '(<span class="org-string">"project"</span>))
          (org-agenda-sorting-strategy '(priority-down tag-up category-keep effort-down))))
        (<span class="org-string">"S"</span> tags-todo <span class="org-string">"TODO=\"STARTED\""</span>)
        (<span class="org-string">"C"</span> <span class="org-string">"Cooking"</span>
         ((tags <span class="org-string">"vegetables"</span>)
          (tags <span class="org-string">"chicken"</span>)
          (tags <span class="org-string">"beef"</span>)
          (tags <span class="org-string">"pork"</span>)
          (tags <span class="org-string">"other"</span>))
         ((org-agenda-files '(<span class="org-string">"~/sync/orgzly/cooking.org"</span>))
          (org-agenda-view-columns-initially t)
          (org-agenda-sorting-strategy '(scheduled-up time-down todo-state-up)))
         )
        (<span class="org-string">"8"</span> <span class="org-string">"List projects with tasks"</span> my-org-agenda-projects-and-tasks
         <span class="org-string">"+PROJECT"</span>
         ((org-agenda-max-entries 3)))))

</pre>
</div>
</div>
</div>
<div id="outline-container-making-it-easier-to-tag-inbox-items" class="outline-4">
<h4 id="making-it-easier-to-tag-inbox-items">Making it easier to tag inbox items</h4>
<div class="outline-text-4" id="text-making-it-easier-to-tag-inbox-items">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-complete-tags-always-offer-all-agenda-tags t)
(<span class="org-keyword">setq</span> org-use-fast-tag-selection nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-make-it-easy-to-mark-a-task-as-done" class="outline-4">
<h4 id="make-it-easy-to-mark-a-task-as-done">Make it easy to mark a task as done</h4>
<div class="outline-text-4" id="text-make-it-easy-to-mark-a-task-as-done">
<p>
Great for quickly going through the to-do list. Gets rid of one
extra keystroke. ;)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-done</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Mark current TODO as done.</span>
<span class="org-doc">       This changes the line at point, all other lines in the agenda referring to</span>
<span class="org-doc">       the same tree node, and the headline of the tree node in the Org-mode file."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (org-agenda-todo <span class="org-string">"DONE"</span>))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Override the key definition for org-exit</span>
(define-key org-agenda-mode-map <span class="org-string">"x"</span> 'my-org-agenda-done)
</pre>
</div>
</div>
</div>
<div id="outline-container-make-it-easy-to-mark-a-task-as-done-and-create-a-follow-up-task" class="outline-4">
<h4 id="make-it-easy-to-mark-a-task-as-done-and-create-a-follow-up-task">Make it easy to mark a task as done and create a follow-up task</h4>
<div class="outline-text-4" id="text-make-it-easy-to-mark-a-task-as-done-and-create-a-follow-up-task">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-mark-done-and-add-followup</span> ()
  <span class="org-doc">"Mark the current TODO as done and add another task after it.</span>
<span class="org-doc">       Creates it at the same level as the previous task, so it's better to use</span>
<span class="org-doc">       this with to-do items than with projects or headings."</span>
  (<span class="org-keyword">interactive</span>)
  (org-agenda-todo <span class="org-string">"DONE"</span>)
  (org-agenda-switch-to)
  (org-capture 0 <span class="org-string">"t"</span>))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Override the key definition</span>
(define-key org-agenda-mode-map <span class="org-string">"F"</span> 'my-org-agenda-mark-done-and-add-followup)
</pre>
</div>
</div>
</div>
<div id="outline-container-capture-something-based-on-the-agenda" class="outline-4">
<h4 id="capture-something-based-on-the-agenda">Capture something based on the agenda</h4>
<div class="outline-text-4" id="text-capture-something-based-on-the-agenda">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-new</span> ()
  <span class="org-doc">"Create a new note or task at the current agenda item.</span>
<span class="org-doc">       Creates it at the same level as the previous task, so it's better to use</span>
<span class="org-doc">       this with to-do items than with projects or headings."</span>
  (<span class="org-keyword">interactive</span>)
  (org-agenda-switch-to)
  (org-capture 0))
<span class="org-comment-delimiter">;; </span><span class="org-comment">New key assignment</span>
(define-key org-agenda-mode-map <span class="org-string">"N"</span> 'my-org-agenda-new)
</pre>
</div>
</div>
</div>
<div id="outline-container-sorting-by-date-and-priority" class="outline-4">
<h4 id="sorting-by-date-and-priority">Sorting by date and priority</h4>
<div class="outline-text-4" id="text-sorting-by-date-and-priority">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-agenda-sorting-strategy
      '((agenda time-up priority-down tag-up category-keep)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(todo user-defined-up todo-state-up priority-down effort-up)</span>
        (todo todo-state-up priority-down effort-up)
        (tags user-defined-up)
        (search category-keep)))
(<span class="org-keyword">setq</span> org-agenda-cmp-user-defined 'my-org-sort-agenda-items-user-defined)
(<span class="org-keyword">require</span> '<span class="org-constant">cl</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-get-context</span> (txt)
  <span class="org-doc">"Find the context."</span>
  (car (member-if
        (<span class="org-keyword">lambda</span> (item) (string-match <span class="org-string">"@"</span> item))
        (get-text-property 1 'tags txt))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-compare-dates</span> (a b)
  <span class="org-doc">"Return 1 if A should go after B, -1 if B should go after A, or 0 if a = b."</span>
  (<span class="org-keyword">cond</span>
   ((<span class="org-keyword">and</span> (= a 0) (= b 0)) nil)
   ((= a 0) 1)
   ((= b 0) -1)
   ((&gt; a b) 1)
   ((&lt; a b) -1)
   (t nil)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-complete-cmp</span> (a b)
  (<span class="org-keyword">let*</span> ((state-a (<span class="org-keyword">or</span> (get-text-property 1 'todo-state a) <span class="org-string">""</span>))
         (state-b (<span class="org-keyword">or</span> (get-text-property 1 'todo-state b) <span class="org-string">""</span>)))
    (<span class="org-keyword">or</span>
     (<span class="org-keyword">if</span> (member state-a org-done-keywords-for-agenda) 1)
     (<span class="org-keyword">if</span> (member state-b org-done-keywords-for-agenda) -1))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-date-cmp</span> (a b)
  (<span class="org-keyword">let*</span> ((sched-a (<span class="org-keyword">or</span> (get-text-property 1 'org-scheduled a) 0))
         (sched-b (<span class="org-keyword">or</span> (get-text-property 1 'org-scheduled b) 0))
         (deadline-a (<span class="org-keyword">or</span> (get-text-property 1 'org-deadline a) 0))
         (deadline-b (<span class="org-keyword">or</span> (get-text-property 1 'org-deadline b) 0)))
    (<span class="org-keyword">or</span>
     (my-org-compare-dates
      (my-org-min-date sched-a deadline-a)
      (my-org-min-date sched-b deadline-b)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-min-date</span> (a b)
  <span class="org-doc">"Return the smaller of A or B, except for 0."</span>
  (funcall (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt; a 0) (&gt; b 0)) 'min 'max) a b))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sort-agenda-items-user-defined</span> (a b)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">compare by deadline, then scheduled date; done tasks are listed at the very bottom</span>
  (<span class="org-keyword">or</span>
   (my-org-complete-cmp a b)
   (my-org-date-cmp a b)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-context-cmp</span> (a b)
  <span class="org-doc">"Compare CONTEXT-A and CONTEXT-B."</span>
  (<span class="org-keyword">let</span> ((context-a (my-org-get-context a))
        (context-b (my-org-get-context b)))
    (<span class="org-keyword">cond</span>
     ((null context-a) +1)
     ((null context-b) -1)
     ((string&lt; context-a context-b) -1)
     ((string&lt; context-b context-a) +1)
     (t nil))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sort-agenda-items-todo</span> (a b)
  (<span class="org-keyword">or</span>
   (org-cmp-time a b)
   (my-org-complete-cmp a b)
   (my-org-context-cmp a b)
   (my-org-date-cmp a b)
   (org-cmp-todo-state a b)
   (org-cmp-priority a b)
   (org-cmp-effort a b)))
</pre>
</div>
</div>
</div>
<div id="outline-container-preventing-things-from-falling-through-the-cracks" class="outline-4">
<h4 id="preventing-things-from-falling-through-the-cracks">Preventing things from falling through the cracks</h4>
<div class="outline-text-4" id="text-preventing-things-from-falling-through-the-cracks">
<p>
This helps me keep track of unscheduled tasks, because I sometimes
forget to assign tasks a date. I also want to keep track of stuck projects.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-agenda-list-unscheduled</span> (<span class="org-type">&amp;rest</span> ignore)
  <span class="org-doc">"Create agenda view for tasks that are unscheduled and not done."</span>
  (<span class="org-keyword">let*</span> ((org-agenda-todo-ignore-with-date t)
         (org-agenda-overriding-header <span class="org-string">"List of unscheduled tasks: "</span>))
    (org-agenda-get-todos)))
(<span class="org-keyword">setq</span> org-stuck-projects
      '(<span class="org-string">"+PROJECT-MAYBE-DONE"</span>
        (<span class="org-string">"TODO"</span>)
        nil
        <span class="org-string">"\\&lt;</span><span class="org-string"><span class="org-variable-name">IGNORE\\</span></span><span class="org-string">&gt;"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-synchronizing-with-google-calendar" class="outline-4">
<h4 id="synchronizing-with-google-calendar">Synchronizing with Google Calendar</h4>
<div class="outline-text-4" id="text-synchronizing-with-google-calendar">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-gcal-notify</span> (title mes)
  (message <span class="org-string">"%s - %s"</span> title mes))
(<span class="org-keyword">use-package</span> org-gcal
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/elisp/org-gcal.el"</span>
  <span class="org-builtin">:init</span> (fset 'org-gcal-notify 'my-org-gcal-notify))
</pre>
</div>
</div>
</div>
<div id="outline-container-projects" class="outline-4">
<h4 id="projects">Projects</h4>
<div class="outline-text-4" id="text-projects">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-show-active-projects</span> ()
  <span class="org-doc">"Show my current projects."</span>
  (<span class="org-keyword">interactive</span>)
  (org-tags-view nil <span class="org-string">"project-inactive-someday"</span>))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-reviews" class="outline-3">
<h3 id="reviews">Reviews</h3>
<div class="outline-text-3" id="text-reviews">
</div>
<div id="outline-container-weekly-review" class="outline-4">
<h4 id="weekly-review">Weekly review</h4>
<div class="outline-text-4" id="text-weekly-review">
<p>
<a id="org9d6fecd"></a>
</p>

<p>
I regularly post <a href="http://sachachua.com/blog/category/weekly">weekly reviews</a> to keep track of what I'm done,
remind me to plan for the upcoming week, and list blog posts,
sketches, and links. I want to try out grouping tasks by topic first,
then breaking it down into previous/next week.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> quantified <span class="org-builtin">:ensure</span> nil <span class="org-builtin">:load-path</span> <span class="org-string">"~/sync/cloud/elisp"</span> <span class="org-builtin">:unless</span> my-phone-p)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-weekly-review-line-regexp</span>
  <span class="org-string">"^  </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">: +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">Sched[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+: +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?TODO </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[      ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[[:alnum:]_@#%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?[        ]*$"</span>
  <span class="org-doc">"Regular expression matching lines to include."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-weekly-done-line-regexp</span>
  <span class="org-string">"^  </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">: +.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">Clocked</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">Closed</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">TODO</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">DONE</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[       ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[[:alnum:]_@#%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?[        ]*$"</span>
  <span class="org-doc">"Regular expression matching lines to include as completed tasks."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-quantified-get-hours</span> (category time-summary)
  <span class="org-doc">"Return the number of hours based on the time summary."</span>
  (<span class="org-keyword">if</span> (stringp category)
      (<span class="org-keyword">if</span> (assoc category time-summary) (/ (cdr (assoc category time-summary)) 3600.0) 0)
    (apply '+ (mapcar (<span class="org-keyword">lambda</span> (x) (my-quantified-get-hours x time-summary)) category))))

(<span class="org-keyword">defun</span> <span class="org-function-name">_my-extract-tasks-from-agenda</span> (string matchers prefix line-re)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert string)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward line-re nil t)
      (<span class="org-keyword">let</span> ((temp-list matchers))
        (<span class="org-keyword">while</span> temp-list
          (<span class="org-keyword">if</span> (<span class="org-keyword">save-match-data</span>
                (string-match (car (car temp-list)) (match-string 1)))
              (<span class="org-keyword">progn</span>
                (add-to-list (cdr (car temp-list)) (concat prefix (match-string 3)) t)
                (<span class="org-keyword">setq</span> temp-list nil)))
          (<span class="org-keyword">setq</span> temp-list (cdr temp-list)))))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">_my-extract-tasks-from-agenda</span> ()
  (<span class="org-keyword">let</span> (list-a list-b (line-re <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>))
    (_my-extract-tasks-from-agenda
     <span class="org-string">"listA: Task 1\nother: Task 2\nlistA: Task 3"</span>
     '((<span class="org-string">"listA"</span> . list-a)
       (<span class="org-string">"."</span> . list-b))
     <span class="org-string">"- [ ] "</span>
     line-re)
    (should (equal list-a '(<span class="org-string">"- [ ] Task 1"</span> <span class="org-string">"- [ ] Task 3"</span>)))
    (should (equal list-b '(<span class="org-string">"- [ ] Task 2"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">_my-get-upcoming-tasks</span> ()
  (<span class="org-keyword">save-window-excursion</span>
    (org-agenda nil <span class="org-string">"W"</span>)
    (_my-extract-tasks-from-agenda (buffer-string)
                                   '((<span class="org-string">"routines"</span> . ignore)
                                     (<span class="org-string">"business"</span> . business-next)
                                     (<span class="org-string">"people"</span> . relationships-next)
                                     (<span class="org-string">"tasks"</span> . emacs-next)
                                     (<span class="org-string">"."</span> . life-next))
                                   <span class="org-string">"  - [ ] "</span>
                                   my-weekly-review-line-regexp)))
(<span class="org-keyword">defun</span> <span class="org-function-name">_my-get-previous-tasks</span> ()
  (<span class="org-keyword">let</span> (string)
    (<span class="org-keyword">save-window-excursion</span>
      (org-agenda nil <span class="org-string">"W"</span>)
      (org-agenda-later -1)
      (org-agenda-log-mode 16)
      (<span class="org-keyword">setq</span> string (buffer-string))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Get any completed tasks from the current week as well</span>
      (org-agenda-later 1)
      (org-agenda-log-mode 16)
      (<span class="org-keyword">setq</span> string (concat string <span class="org-string">"\n"</span> (buffer-string)))
      (_my-extract-tasks-from-agenda string
                                     '((<span class="org-string">"routines"</span> . ignore)
                                       (<span class="org-string">"business"</span> . business)
                                       (<span class="org-string">"people"</span> . relationships)
                                       (<span class="org-string">"tasks"</span> . emacs)
                                       (<span class="org-string">"."</span> . life))
                                     <span class="org-string">"  - [X] "</span>
                                     my-weekly-done-line-regexp))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-summarize-focus-areas</span> (date)
  <span class="org-doc">"Summarize previous and upcoming tasks as a list."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date-analyze (<span class="org-keyword">if</span> current-prefix-arg (org-read-date) <span class="org-string">"-fri"</span>) nil '(0 0 0))))
  (<span class="org-keyword">let</span> (business relationships life business-next relationships-next life-next string emacs emacs-next
                 start end time-summary biz-time ignore base-date)
    (<span class="org-keyword">setq</span> base-date (apply 'encode-time date))
    (<span class="org-keyword">setq</span> start (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (- (time-to-number-of-days base-date) 6))))
    (<span class="org-keyword">setq</span> end (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (1+ (time-to-number-of-days base-date)))))
    (<span class="org-keyword">setq</span> time-summary (quantified-summarize-time start end))
    (<span class="org-keyword">setq</span> biz-time (my-quantified-get-hours <span class="org-string">"Business"</span> time-summary))
    (_my-get-upcoming-tasks)
    (_my-get-previous-tasks)
    (<span class="org-keyword">setq</span> string
          (concat
           (format <span class="org-string">"- *A- (Childcare)* (%.1fh - %d%% of total)\n"</span>
                   (my-quantified-get-hours '(<span class="org-string">"A-"</span>) time-summary)
                   (/ (my-quantified-get-hours '(<span class="org-string">"A-"</span>) time-summary) 1.68))
           (format <span class="org-string">"- *Business* (%.1fh - %d%%)\n"</span> biz-time (/ biz-time 1.68))
           (mapconcat 'identity business <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity business-next <span class="org-string">"\n"</span>)
           <span class="org-string">"\n"</span>
           (format <span class="org-string">"  - *Earn* (%.1fh - %d%% of Business)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Business - Earn"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Business - Earn"</span> time-summary) (* 0.01 biz-time)))
           (format <span class="org-string">"  - *Build* (%.1fh - %d%% of Business)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Business - Build"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Business - Build"</span> time-summary) (* 0.01 biz-time)))
           (format <span class="org-string">"  - *Connect* (%.1fh - %d%% of Business)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Business - Connect"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Business - Connect"</span> time-summary) (* 0.01 biz-time)))
           (format <span class="org-string">"- *Relationships* (%.1fh - %d%%)\n"</span>
                   (my-quantified-get-hours '(<span class="org-string">"Discretionary - Social"</span>
                                              <span class="org-string">"Discretionary - Family"</span>) <span class="org-warning">time-summary)</span>
                   (/ (my-quantified-get-hours '(<span class="org-string">"Discretionary - Social"</span>
                                                 <span class="org-string">"Discretionary - Family"</span>) <span class="org-warning">time-summary) 1.68))</span>
           (mapconcat 'identity relationships <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity relationships-next <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           <span class="org-string">"\n"</span>
           (format <span class="org-string">"- *Discretionary - Productive* (%.1fh - %d%%)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Discretionary - Productive"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Discretionary - Productive"</span> time-summary) 1.68))
           (format <span class="org-string">"  - *Drawing* (%.1fh)\n"</span>
                   (my-quantified-get-hours '(<span class="org-string">"Discretionary - Productive - Drawing"</span>)  time-summary))
           (format <span class="org-string">"  - *Emacs* (%.1fh)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Discretionary - Productive - Emacs"</span> time-summary))
           (mapconcat 'identity emacs <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity emacs-next <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (format <span class="org-string">"  - *Coding* (%.1fh)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Discretionary - Productive - Coding"</span> time-summary))
           (mapconcat 'identity life <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (mapconcat 'identity life-next <span class="org-string">"\n"</span>) <span class="org-string">"\n"</span>
           (format <span class="org-string">"  - *Sewing* (%.1fh)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Discretionary - Productive - Sewing"</span> time-summary))
           (format <span class="org-string">"  - *Writing* (%.1fh)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Discretionary - Productive - Writing"</span> time-summary))
           (format <span class="org-string">"- *Discretionary - Play* (%.1fh - %d%%)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Discretionary - Play"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Discretionary - Play"</span> time-summary) 1.68))
           (format <span class="org-string">"- *Personal routines* (%.1fh - %d%%)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Personal"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Personal"</span> time-summary) 1.68))
           (format <span class="org-string">"- *Unpaid work* (%.1fh - %d%%)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Unpaid work"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Unpaid work"</span> time-summary) 1.68))
           (format <span class="org-string">"- *Sleep* (%.1fh - %d%% - average of %.1f per day)\n"</span>
                   (my-quantified-get-hours <span class="org-string">"Sleep"</span> time-summary)
                   (/ (my-quantified-get-hours <span class="org-string">"Sleep"</span> time-summary) 1.68)
                   (/ (my-quantified-get-hours <span class="org-string">"Sleep"</span> time-summary) 7)
                   )))
    (<span class="org-keyword">if</span> (called-interactively-p 'any)
        (insert string)
      string)))
</pre>
</div>

<p>
I use this to put together a quick summary of how I spent my time.
</p>

<p>
The following code makes it easy to add a line:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-add-line-item-task</span> (task)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTask: "</span>)
  (org-insert-heading)
  (insert <span class="org-string">"[ ] "</span> task)
  (<span class="org-keyword">let</span> ((org-capture-entry '(<span class="org-string">"t"</span> <span class="org-string">"Tasks"</span> entry
                             (file+headline <span class="org-string">"~/sync/orgzly/organizer.org"</span> <span class="org-string">"Tasks"</span>)
                             <span class="org-string">""</span>)))
    (org-capture nil <span class="org-string">"t"</span>)
    (insert <span class="org-string">"TODO "</span> task <span class="org-string">"\nSCHEDULED: &lt;"</span> (org-read-date) <span class="org-string">"&gt;"</span>)))
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(define-key org-mode-map (kbd "C-c t") 'my-org-add-line-item-task)</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-list-from-rss</span> (url from-date <span class="org-type">&amp;optional</span> to-date)
    <span class="org-doc">"Convert URL to an Org list"</span>
    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"&lt;\\?xml"</span>)
      (goto-char (match-beginning 0))
      (<span class="org-keyword">let*</span> ((feed (xml-parse-region (point) (point-max)))
             (is-rss (&gt; (length (xml-get-children (car feed) 'entry)) 0)))
        (mapconcat (<span class="org-keyword">lambda</span> (link)
                     (format <span class="org-string">"- %s\n"</span>
                             (org-link-make-string (car link) (cdr link))))
                   (<span class="org-keyword">if</span> is-rss
                       (mapcar
                        (<span class="org-keyword">lambda</span> (entry)
                          (cons
                           (xml-get-attribute (car
                                               (<span class="org-keyword">or</span>
                                                (seq-filter (<span class="org-keyword">lambda</span> (x) (string= (xml-get-attribute x 'rel) <span class="org-string">"alternate"</span>))
                                                            (xml-get-children entry 'link))
                                                (xml-get-children entry 'link))) <span class="org-warning">'href)</span>
                           (elt (car (xml-get-children entry 'title)) 2)))
                        (-filter (<span class="org-keyword">lambda</span> (entry)
                                   (<span class="org-keyword">let</span> ((entry-date (elt (car (xml-get-children entry 'updated)) 2)))
                                     (<span class="org-keyword">and</span>
                                      (org-string&lt;= from-date entry-date)
                                      (<span class="org-keyword">or</span> (null to-date) (string&lt; entry-date to-date)))))
                                 (xml-get-children (car feed) 'entry)))
                     (mapcar (<span class="org-keyword">lambda</span> (entry)
                               (cons
                                (caddr (car (xml-get-children entry 'link)))
                                (caddr (car (xml-get-children entry 'title)))))
                             (-filter (<span class="org-keyword">lambda</span> (entry)
                                        (<span class="org-keyword">let</span> ((entry-time (format-time-string <span class="org-string">"%Y-%m-%d"</span>
                                                                              (date-to-time (elt (car (xml-get-children entry 'pubDate)) 2))
                                                                              t)))
                                          (<span class="org-keyword">and</span>
                                           (not (string&lt; entry-time from-date))
                                           (<span class="org-keyword">or</span> (null to-date) (string&lt; entry-time to-date)))))
                                      (xml-get-children (car (xml-get-children (car feed) 'channel)) 'item))))
                   <span class="org-string">""</span>))))

</pre>
</div>

<p>
Now we put it all together&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-prepare-weekly-review</span> (<span class="org-type">&amp;optional</span> date skip-urls)
  <span class="org-doc">"Prepare weekly review template."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date nil nil nil <span class="org-string">"Ending on Fri: "</span> nil <span class="org-string">"-fri"</span>)))
  (<span class="org-keyword">let*</span> ((post-date (current-time))
   (base-date (apply 'encode-time (org-read-date-analyze date nil '(0 0 0))))
   start end links prev
   (title (format-time-string <span class="org-string">"Weekly review: Week ending %B %e, %Y"</span> base-date))
   (post-location (concat (format-time-string <span class="org-string">"%Y/%m/"</span> post-date) (my-make-slug title))))
    (<span class="org-keyword">setq</span> start (format-time-string <span class="org-string">"%Y-%m-%d 0:00"</span> (days-to-time (- (time-to-number-of-days base-date) 6)) (current-time-zone)))
    (<span class="org-keyword">setq</span> end (format-time-string <span class="org-string">"%Y-%m-%d 0:00"</span> (days-to-time (1+ (time-to-number-of-days base-date))) (current-time-zone)))
    (<span class="org-keyword">setq</span> prev (format-time-string <span class="org-string">"%Y-%m-%d 0:00"</span> (days-to-time (- (time-to-number-of-days base-date) 7 6)) (current-time-zone)))
    (outline-next-heading)
    (insert
     <span class="org-string">"** "</span> title <span class="org-string">"  :weekly:\n"</span>
     (format
      <span class="org-string">":PROPERTIES:</span>
<span class="org-string">:EXPORT_DATE: %s</span>
<span class="org-string">:EXPORT_ELEVENTY_PERMALINK: %s</span>
<span class="org-string">:EXPORT_ELEVENTY_FILE_NAME: %s</span>
<span class="org-string">:END:\n"</span>
      (format-time-string <span class="org-string">"%Y-%m-%dT%T%z"</span>)
      (concat <span class="org-string">"/blog/"</span> post-location <span class="org-string">"/"</span>)
      (concat <span class="org-string">"blog/"</span> post-location))
     (my-org-summarize-journal-csv start end nil my-journal-category-map my-journal-categories)
     <span class="org-string">"\n\n*Blog posts*\n\n"</span>
     (my-org-list-from-rss <span class="org-string">"https://sachachua.com/blog/feed"</span> start end)
     <span class="org-string">"\n\n*Sketches*\n\n"</span>
     (my-sketches-export-and-extract start end) <span class="org-string">"\n"</span>
     <span class="org-string">"\n\n#+begin_my_details Time\n"</span>
     (orgtbl-to-orgtbl
      (my-quantified-compare prev start start end
                             '(<span class="org-string">"A-"</span>
                               <span class="org-string">"Business"</span>
                               <span class="org-string">"Discretionary - Play"</span>
                               <span class="org-string">"Unpaid work"</span>
                               <span class="org-string">"Discretionary - Social"</span>
                               <span class="org-string">"Discretionary - Family"</span>
                               <span class="org-string">"Sleep"</span>
                               <span class="org-string">"Discretionary - Productive"</span>
                               <span class="org-string">"Personal"</span>)
                             <span class="org-string">"The other week %"</span> <span class="org-string">"Last week %"</span>)
      nil)
     <span class="org-string">"\n#+end_my_details\n\n"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-missing-weekly-reviews</span> ()
  <span class="org-doc">"Prepare missing weekly reviews based on LAST_REVIEW property."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((today (substring (org-read-date nil nil <span class="org-string">"."</span>) 0 10))
  (date (org-entry-get (point) <span class="org-string">"LAST_REVIEW"</span>)))
    (<span class="org-keyword">while</span> (string&lt; date today)
(<span class="org-keyword">setq</span> date (substring (org-read-date nil nil <span class="org-string">"++1w"</span> nil (org-time-string-to-time date)) 0 10))
(<span class="org-keyword">unless</span> (string&lt; today date)
  (<span class="org-keyword">save-excursion</span>
    (my-org-prepare-weekly-review date))
  (org-entry-put (point) <span class="org-string">"LAST_REVIEW"</span> date)))))
</pre>
</div>
</div>
<div id="outline-container-flickr-extract" class="outline-5">
<h5 id="flickr-extract">Flickr extract</h5>
<div class="outline-text-5" id="text-flickr-extract">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">_my-clean-up-flickr-list</span> (list)
  (<span class="org-keyword">setq</span> list
        (replace-regexp-in-string <span class="org-string">"\\[\""</span> <span class="org-string">"["</span> list))
  (<span class="org-keyword">setq</span> list
        (replace-regexp-in-string <span class="org-string">"&lt;a href=\"\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\"]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.*?&gt;.*?&lt;/a&gt;"</span>
                                  <span class="org-string">"[[\\1][\\2]]"</span> list))
  (<span class="org-keyword">setq</span> list
        (replace-regexp-in-string <span class="org-string">"\"</span>
<span class="org-string">        "</span> <span class="org-string">""</span> (replace-regexp-in-string <span class="org-string">"\"\\]"</span> <span class="org-string">"]"</span> list))))

(<span class="org-keyword">defun</span> <span class="org-function-name">_my-format-flickr-link-for-org</span> (x)
  (<span class="org-keyword">let</span> ((title (assoc-default <span class="org-string">"FileName"</span> x)))
    (format
     <span class="org-string">"- %s %s"</span>
     (org-link-make-string
      (assoc-default <span class="org-string">"URL"</span> x)
      title)
     (<span class="org-keyword">if</span> (string= (assoc-default <span class="org-string">"Description"</span> x) <span class="org-string">""</span>)
         <span class="org-string">""</span>
       (concat <span class="org-string">"- "</span>
               (replace-regexp-in-string
                <span class="org-string">"&lt;a href=\"\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\"\".*?&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/a&gt;"</span>
                (<span class="org-keyword">lambda</span> (string)
                  (org-link-make-string
                   (match-string 1 string)
                   (match-string 2 string)))
                (assoc-default <span class="org-string">"Description"</span> x)))))))


(<span class="org-keyword">defun</span> <span class="org-function-name">_my-parse-and-filter-flickr-csv-buffer</span> (start end)
  (sort
   (delq nil
         (mapcar (<span class="org-keyword">lambda</span> (x)
                   (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (string&lt; (assoc-default <span class="org-string">"FileName"</span> x) end)
                            (org-string&lt;= start (assoc-default <span class="org-string">"FileName"</span> x)))
                       x))
                 (csv-parse-buffer t)))
   (<span class="org-keyword">lambda</span> (a b)
     (string&lt; (assoc-default <span class="org-string">"FileName"</span> a)
              (assoc-default <span class="org-string">"FileName"</span> b)))))


(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketches-export-and-extract</span> (start end <span class="org-type">&amp;optional</span> do-insert update-db filter)
  <span class="org-doc">"Create a list of links to sketches."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date) (org-read-date) t current-prefix-arg (read-string <span class="org-string">"Filter: "</span>)))
  (<span class="org-keyword">let</span> ((value
         (mapconcat
          (<span class="org-keyword">lambda</span> (filename)
            (<span class="org-keyword">let</span> ((base (file-name-nondirectory filename)))
              (format <span class="org-string">"- %s\n"</span>
                      (org-link-make-string
                       (replace-regexp-in-string <span class="org-string">"#"</span> <span class="org-string">"%23"</span>
                                                 (concat <span class="org-string">"sketch:"</span> base))
                       base))))
          (<span class="org-keyword">let</span> ((my-sketch-directories '(<span class="org-string">"~/sync/sketches"</span>))) (my-get-sketch-filenames-between-dates start end filter))
          <span class="org-string">""</span>)))
    (<span class="org-keyword">if</span> do-insert
        (insert value)
      value)))
</pre>
</div>
</div>
</div>
<div id="outline-container-link-related-convenience-functions" class="outline-5">
<h5 id="link-related-convenience-functions">Link-related convenience functions</h5>
<div class="outline-text-5" id="text-link-related-convenience-functions">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">kensanata/resolve-redirect</span> (url)
  <span class="org-doc">"Resolve shortened URL by launching `curl --head' and parsing the result."</span>
  (<span class="org-keyword">let*</span> ((curl (shell-command-to-string
                (format <span class="org-string">"curl --silent --head %s"</span> url)))
         (location (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (string-match <span class="org-string">"^HTTP/1</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">.1 301"</span> curl)
                              (string-match <span class="org-string">"^Location: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> curl))
                     (match-string 1 curl))))
    (<span class="org-keyword">or</span> location url)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-resolve-urls-in-region</span> (beg end)
  <span class="org-doc">"Expand URLs between BEG and END."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">save-restriction</span>
      (narrow-to-region beg end)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-link-bracket-re nil t)
        (replace-match (<span class="org-keyword">save-match-data</span> (kensanata/resolve-redirect
                                         (match-string 1))) <span class="org-warning">t t nil 1))</span>
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-link-re-with-space nil t)
        (replace-match (<span class="org-keyword">save-match-data</span> (kensanata/resolve-redirect
                                         (match-string 0))) <span class="org-warning">t t nil)))))</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-urls-in-region</span> (beg end)
  <span class="org-doc">"Open URLs between BEG and END.</span>
<span class="org-doc">        TODO: Get better at detecting and opening all URLs"</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">save-restriction</span>
      (narrow-to-region beg end)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-link-any-re nil t)
        (<span class="org-keyword">save-excursion</span>
          (backward-char)
          (browse-url (match-string 0)))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-monthly-reviews" class="outline-4">
<h4 id="monthly-reviews">Monthly reviews</h4>
<div class="outline-text-4" id="text-monthly-reviews">
<p>
<a id="orge3e673e"></a>
</p>

<p>
I want to be able to see what I worked on in a month so that I can write my <a href="http://sachachua.com/blog/category/monthly">monthly reviews</a>. This code makes it easy to display a month's clocked tasks and time. I haven't been particularly thorough in tracking time before, but now that I have a shortcut that logs in Quantified Awesome as well as in Org, I should end up clocking more.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-review-month</span> (start-date)
  <span class="org-doc">"Review the month's clocked tasks and time."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Set to the beginning of the month</span>
  (<span class="org-keyword">setq</span> start-date (concat (substring start-date 0 8) <span class="org-string">"01"</span>))
  (<span class="org-keyword">let</span> ((org-agenda-show-log t)
        (org-agenda-start-with-log-mode t)
        (org-agenda-start-with-clockreport-mode t)
        (org-agenda-clockreport-parameter-plist '(<span class="org-builtin">:link</span> t <span class="org-builtin">:maxlevel</span> 3)))
    (org-agenda-list nil start-date 'month)))
</pre>
</div>

<p>
Here's a function like <code>my-org-prepare-weekly-review</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my-list-blog-posts</span> (start-date end-date)
  (seq-filter (<span class="org-keyword">lambda</span> (o)
                (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> (null start-date) (string&lt; start-date (plist-get o <span class="org-builtin">:date</span>)))
                     (<span class="org-keyword">or</span> (null end-date) (string&lt; (plist-get o <span class="org-builtin">:date</span>) end-date))))
              (<span class="org-keyword">let</span> ((json-object-type 'plist))
                (json-read-file <span class="org-string">"~/proj/static-blog/_site/blog/all/index.json"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-get-last-week</span> ()
  <span class="org-doc">"Return dates for filtering last week."</span>
  (<span class="org-keyword">if</span> (string= (format-time-string <span class="org-string">"%u"</span>) <span class="org-string">"6"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">my week starts on Saturday</span>
      (cons (org-read-date nil nil <span class="org-string">"-1w"</span>) (org-read-date nil nil <span class="org-string">"."</span>))
    (cons (org-read-date nil nil <span class="org-string">"-2sat"</span>) (org-read-date nil nil <span class="org-string">"-sat"</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-get-month</span> (<span class="org-type">&amp;optional</span> date-string)
  <span class="org-doc">"Return start of month containing DATE and start of following month.</span>
<span class="org-doc">       Result is (START . NEXT)."</span>
  (<span class="org-keyword">let*</span> ((date (decode-time (<span class="org-keyword">if</span> (stringp date-string) (org-read-date nil t date-string) date-string)))
         (month (elt date 4))
         (year (elt date 5))
         start-date
         end-date)
    (<span class="org-keyword">calendar-increment-month</span> month year 1)
    (cons
     (format <span class="org-string">"%4d-%02d-01"</span> (elt date 5) (elt date 4))
     (format <span class="org-string">"%4d-%02d-01"</span> year month))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-prepare-monthly-review</span> (time)
  (<span class="org-keyword">interactive</span> (list (org-read-date nil t)))
  (<span class="org-keyword">let*</span> ((date (decode-time time))
         (month (elt date 4))
         (year (elt date 5))
         (post-date (current-time))
         post-location
         title
         start-date
         end-date
         previous-date
         posts
         sketches
         org-date
         time)
    (<span class="org-keyword">calendar-increment-month</span> month year -1)
    (<span class="org-keyword">setq</span> start-date (format <span class="org-string">"%4d-%02d-01 0:00"</span> year month)
          end-date (format <span class="org-string">"%4d-%02d-01 0:00"</span> (elt date 5) (elt date 4))
          title (format-time-string <span class="org-string">"Monthly review: %B %Y"</span> (encode-time 0 0 0 1 month year))
          post-location (concat (format-time-string <span class="org-string">"%Y/%m/"</span> post-date) (my-make-slug title))
          posts (mapconcat (<span class="org-keyword">lambda</span> (o) (concat <span class="org-string">"- "</span> (org-link-make-string (concat <span class="org-string">"https://sachachua.com"</span> (plist-get o <span class="org-builtin">:permalink</span>))
                                                                          (plist-get o <span class="org-builtin">:title</span>))))
                           (my-list-blog-posts
                            (substring start-date 0 10)
                            (substring end-date 0 10))
                           <span class="org-string">"\n"</span>)
          sketches (my-sketches-export-and-extract (substring start-date 0 10) (substring end-date 0 10) nil t))
    (<span class="org-keyword">calendar-increment-month</span> month year -1)
    (<span class="org-keyword">setq</span> previous-date (format <span class="org-string">"%4d-%02d-01 0:00"</span> year month))
    (<span class="org-keyword">setq</span> time (my-quantified-compare previous-date start-date start-date end-date '(<span class="org-string">"Business"</span> <span class="org-string">"Discretionary - Play"</span> <span class="org-string">"Unpaid work"</span> <span class="org-string">"A-"</span> <span class="org-string">"Discretionary - Family"</span> <span class="org-string">"Discretionary - Social"</span> <span class="org-string">"Sleep"</span> <span class="org-string">"Discretionary - Productive"</span> <span class="org-string">"Personal"</span>) <span class="org-string">"Previous month %"</span> <span class="org-string">"This month %"</span>))
    (goto-char (line-end-position))
    (insert
     <span class="org-string">"\n\n** "</span> title <span class="org-string">"  :monthly:review:\n"</span>
     (my-org-summarize-journal-csv start-date end-date <span class="org-string">"monthly-highlight"</span> my-journal-category-map my-journal-categories) <span class="org-string">"\n\n"</span>
     <span class="org-string">"*Blog posts*\n"</span>
     posts <span class="org-string">"\n\n"</span>
     <span class="org-string">"*Sketches*\n\n"</span>
     sketches
     <span class="org-string">"*Time*\n\n"</span>
     (orgtbl-to-orgtbl time nil))
    (my-org-11ty-prepare-subtree)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-prepare-yearly-review</span> (previous-date start-date end-date)
  (<span class="org-keyword">let*</span> ((posts (mapconcat (<span class="org-keyword">lambda</span> (o) (concat <span class="org-string">"- "</span> (org-link-make-string (concat <span class="org-string">"https://sachachua.com"</span> (plist-get o <span class="org-builtin">:permalink</span>))
                                                                          (plist-get o <span class="org-builtin">:title</span>))))
                           (my-list-blog-posts
                            (substring start-date 0 10)
                            (substring end-date 0 10))
                           <span class="org-string">"\n"</span>)
                )
         (sketches (my-sketches-export-and-extract (substring start-date 0 10) (substring end-date 0 10) nil t))
         (time (my-quantified-compare previous-date start-date start-date end-date '(<span class="org-string">"Business"</span> <span class="org-string">"Discretionary - Play"</span> <span class="org-string">"Unpaid work"</span> <span class="org-string">"A-"</span> <span class="org-string">"Discretionary - Family"</span> <span class="org-string">"Discretionary - Social"</span> <span class="org-string">"Sleep"</span> <span class="org-string">"Discretionary - Productive"</span> <span class="org-string">"Personal"</span>) <span class="org-string">"2020-2021 %"</span> <span class="org-string">"2021-2022 %"</span>))
         )
    (insert
     <span class="org-string">"*Blog posts*\n\n"</span> posts <span class="org-string">"\n\n"</span>
     <span class="org-string">"*Sketches*\n\n"</span> sketches
     <span class="org-string">"*Time*\n\n"</span> (orgtbl-to-orgtbl time nil))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-filing" class="outline-3">
<h3 id="filing">Filing</h3>
<div class="outline-text-3" id="text-filing">
</div>
<div id="outline-container-bounce-to-another-file" class="outline-4">
<h4 id="bounce-to-another-file"><span class="todo TODO">TODO</span> Bounce to another file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="computer">computer</span>&#xa0;<span class="phone">phone</span></span></h4>
<div class="outline-text-4" id="text-bounce-to-another-file">
<p>
On my phone, Emacs in Termux is nice for scripting, and Orgzly is nice
for editing long text. Let's see if this function lets me quickly
bounce things around from one place to another.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-bounce-to-file</span> (file)
  <span class="org-doc">"Toggle subtree between its home file and another file.</span>
<span class="org-doc">Limitations: Reinserts entry at bottom of subtree, uses kill ring."</span>
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"File: "</span>)))
  (<span class="org-keyword">if</span> (string= (buffer-file-name) (expand-file-name file))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Return it</span>
      (<span class="org-keyword">let</span> ((location (org-entry-get (point) <span class="org-string">"BOUNCE"</span>)))
        (<span class="org-keyword">when</span> location
          (<span class="org-keyword">setq</span> location (read location))
          (org-cut-subtree)
          (save-buffer)
          (<span class="org-keyword">with-current-buffer</span> (find-file (car location))
            (<span class="org-keyword">save-restriction</span>
              (widen)
              (goto-char (org-find-olp location))
              (org-end-of-subtree)
              (<span class="org-keyword">unless</span> (bolp) (insert <span class="org-string">"\n"</span>))
              (org-paste-subtree (length location) nil nil t)
              (save-buffer)))))
    (org-entry-put (point) <span class="org-string">"BOUNCE"</span> (prin1-to-string (cons (buffer-file-name) (org-get-outline-path))))
    (org-cut-subtree)
    (save-buffer)
    (<span class="org-keyword">with-current-buffer</span> (find-file file)
      (<span class="org-keyword">save-restriction</span>
        (widen)
        (goto-char (point-max))
        (<span class="org-keyword">unless</span> (bolp) (insert <span class="org-string">"\n"</span>))
        (org-yank)
        (save-buffer)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-refiling" class="outline-4">
<h4 id="refiling">Basic refiling configuration</h4>
<div class="outline-text-4" id="text-refiling">
<p>
<code>org-refile</code> lets you organize notes by typing in the headline to file them under.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-reverse-note-order t) <span class="org-comment-delimiter">; </span><span class="org-comment">I want new notes prepended</span>
(<span class="org-keyword">setq</span> org-refile-use-outline-path 'file)
(<span class="org-keyword">setq</span> org-outline-path-complete-in-steps nil)
(<span class="org-keyword">setq</span> org-refile-allow-creating-parent-nodes 'confirm)
(<span class="org-keyword">setq</span> org-refile-use-cache nil)
(<span class="org-keyword">setq</span> org-blank-before-new-entry nil)

(<span class="org-keyword">setq</span> org-refile-targets
      '(((<span class="org-string">"~/sync/orgzly/organizer.org"</span>
          <span class="org-string">"~/sync/orgzly/routines.org"</span>
          <span class="org-string">"~/sync/orgzly/business.org"</span>
          <span class="org-string">"~/sync/orgzly/reference.org"</span>
          <span class="org-string">"~/sync/orgzly/garden.org"</span>
          <span class="org-string">"~/sync/orgzly/decisions.org"</span>
          <span class="org-string">"~/sync/emacs/Sacha.org"</span>
          <span class="org-string">"~/sync/orgzly/posts.org"</span>
          <span class="org-string">"~/sync/orgzly/people.org"</span>
          <span class="org-string">"~/sync/orgzly/Inbox.org"</span>
          <span class="org-string">"~/proj/emacsconf/wiki/2023/organizers-notebook/index.org"</span>)
         . (<span class="org-builtin">:maxlevel</span> . 5))))
</pre>
</div>
</div>
<div id="outline-container-jump-to-org-location-by-substring" class="outline-5">
<h5 id="jump-to-org-location-by-substring">TEACH Jump to Org location by substring</h5>
<div class="outline-text-5" id="text-jump-to-org-location-by-substring">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Example: (org-refile 4 nil (my-org-refile-get-location-by-substring "Other Emacs"))</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-get-location-by-substring</span> (regexp <span class="org-type">&amp;optional</span> file)
  <span class="org-doc">"Return the refile location identified by REGEXP."</span>
  (<span class="org-keyword">let</span> ((org-refile-targets org-refile-targets) tbl)
    (<span class="org-keyword">setq</span> org-refile-target-table (org-refile-get-targets)))
  (<span class="org-keyword">unless</span> org-refile-target-table
    (<span class="org-warning">user-error</span> <span class="org-string">"No refile targets"</span>))
  (cl-find regexp org-refile-target-table
           <span class="org-builtin">:test</span>
           (<span class="org-keyword">lambda</span> (a b)
             (<span class="org-keyword">and</span>
              (string-match a (car b))
              (<span class="org-keyword">or</span> (null file)
                  (string-match file (elt b 1)))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-subtree-to</span> (name)
  (org-refile nil nil (my-org-refile-get-location-exact name)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-get-location-exact</span> (name <span class="org-type">&amp;optional</span> file)
  <span class="org-doc">"Return the refile location identified by NAME."</span>
  (<span class="org-keyword">let</span> ((org-refile-targets org-refile-targets) tbl)
    (<span class="org-keyword">setq</span> org-refile-target-table (org-refile-get-targets)))
  (<span class="org-keyword">unless</span> org-refile-target-table
    (<span class="org-warning">user-error</span> <span class="org-string">"No refile targets"</span>))
  (cl-find name org-refile-target-table
           <span class="org-builtin">:test</span> (<span class="org-keyword">lambda</span> (a b)
                   (<span class="org-keyword">and</span> (string-equal a (car b))
                        (<span class="org-keyword">or</span> (null file)
                            (string-match file (elt b 1)))))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Example: (my-org-clock-in-refile "Off my computer")</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-clock-in-refile</span> (location <span class="org-type">&amp;optional</span> file)
  <span class="org-doc">"Clocks into LOCATION.</span>
<span class="org-doc">        LOCATION and FILE can also be regular expressions for `</span><span class="org-doc"><span class="org-constant">my-org-refile-get-location-by-substring</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span> (list (my-org-refile-get-location)))
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">if</span> (stringp location) (<span class="org-keyword">setq</span> location (my-org-refile-get-location-by-substring location file)))
      (org-refile 4 nil location)
      (org-clock-in))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-finish-previous-task-and-clock-in-new-one</span> (location <span class="org-type">&amp;optional</span> file)
  (<span class="org-keyword">interactive</span> (list (my-org-refile-get-location)))
  (<span class="org-keyword">save-window-excursion</span>
    (org-clock-goto)
    (org-todo 'done))
  (my-org-clock-in-and-track-by-name location file))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-clock-in-and-track-by-name</span> (location <span class="org-type">&amp;optional</span> file)
  (<span class="org-keyword">interactive</span> (list (my-org-refile-get-location)))
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">if</span> (stringp location) (<span class="org-keyword">setq</span> location (my-org-refile-get-location-exact location file)))
      (org-refile 4 nil location)
      (my-org-clock-in-and-track))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-off-my-computer</span> (category)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MCategory: "</span>)
  (<span class="org-keyword">eval-when-compile</span> (<span class="org-keyword">require</span> '<span class="org-constant">quantified</span> nil t))
  (my-org-clock-in-refile <span class="org-string">"Off my computer"</span>)
  (quantified-track category))
</pre>
</div>
</div>
</div>
<div id="outline-container-quick-way-to-jump" class="outline-5">
<h5 id="quick-way-to-jump">Quick way to jump</h5>
<div class="outline-text-5" id="text-quick-way-to-jump">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-jump</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((current-prefix-arg '(4)))
    (call-interactively 'org-refile)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-refile-inbox" class="outline-4">
<h4 id="refile-inbox"><span class="todo TODO">TODO</span> Refile inbox entries to a smaller set of org-refile-targets&#xa0;&#xa0;&#xa0;<span class="tag"><span class="dotemacs">dotemacs</span></span></h4>
<div class="outline-text-4" id="text-refile-inbox">
<p>
When I'm filing things from my inbox, I want a faster refile that
considers a smaller set of entries.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-to-subset</span> (arg)
  <span class="org-doc">"Refile to a smaller set of targets."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">let</span> ((org-refile-targets '((<span class="org-string">"~/sync/orgzly/organizer.org"</span> . (<span class="org-builtin">:tag</span> . <span class="org-string">"inboxtarget"</span>))
                              (<span class="org-string">"~/sync/orgzly/organizer.org"</span> . (<span class="org-builtin">:maxlevel</span> . 3))
                              (<span class="org-string">"~/sync/orgzly/resources.org"</span> . (<span class="org-builtin">:maxlevel</span> . 1))
                              (nil . (<span class="org-builtin">:level</span> . 1))
                              (<span class="org-string">"~/proj/stream/index.org"</span> . (<span class="org-builtin">:maxlevel</span> . 3))
                              (<span class="org-string">"~/sync/emacs/Inbox.org"</span> . (<span class="org-builtin">:maxlevel</span> . 1))
                              (<span class="org-string">"~/sync/emacs/Sacha.org"</span> . (<span class="org-builtin">:maxlevel</span> . 4))
                              (<span class="org-string">"~/sync/orgzly/people.org"</span> . (<span class="org-builtin">:maxlevel</span> . 2)))))
    (org-refile arg)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-to-target-or-subset</span> (<span class="org-type">&amp;optional</span> arg)
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">or</span> (my-org-refile-current-entry-to-tag-target)
      (my-org-refile-to-subset arg)))

(keymap-global-set <span class="org-string">"C-c w"</span> 'my-org-refile-to-target-or-subset)
</pre>
</div>

<p>
Next steps might include filtering out private stuff, but I don't think I'll use this while streaming, so it might be okay for now.
</p>
</div>
</div>
<div id="outline-container-refile-tags" class="outline-4">
<h4 id="refile-tags"><span class="done DONE">DONE</span> Automatically refiling Org Mode headings based on tags&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-refile-tags">
<p>
I have lots of different things in my Org Mode inbox. Following the <a href="https://fortelabs.com/blog/para/">PARA</a> method, I want to file them under projects, areas, resources, or archive so that I can find related things later. Actually, no, I don't <i>want</i> to refile them. I do want to be able to:
</p>

<ul class="org-ul">
<li>find all the pieces related to something when I'm ready to start working on a task</li>
<li>find useful links again, especially if I can use my own words</li>
</ul>

<p>
Refiling is annoying on my phone, so I tend to wait until I'm back at
my computer. But even with <code>org-refile-use-outline-path</code> set to <code>file</code>
and the ability to specify substrings, there's still a bit of
friction.
</p>

<p>
Tagging is a little easier to do on my phone. I can add a few tags
when I share a webpage or create a task.
</p>

<p>
I thought it would be nice to have something that automatically
refiles my inbox headings tagged with various tags to other subtrees
where I've set a <code>:TAG_TARGET:</code> property or something like that. For
example, I can set the <code>TAG_TARGET</code> property to <code>emacsconf</code> to mean
that anything tagged with <code>:emacsconf:</code> should get filed under there.
</p>

<p>
<a href="https://emacs.stackexchange.com/questions/36360/recursively-refiling-all-subtrees-with-tag-to-a-destination-org-mode">https://emacs.stackexchange.com/questions/36360/recursively-refiling-all-subtrees-with-tag-to-a-destination-org-mode</a> &#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defcustom</span> <span class="org-variable-name">my-org-refile-tag-targets</span> nil
  <span class="org-doc">"Searches and IDs."</span>
  <span class="org-builtin">:group</span> 'sacha
  <span class="org-builtin">:type</span> '(repeat (cons string string string)))

(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-tag-target-files</span>
    (append '(<span class="org-string">"~/sync/orgzly/news.org"</span>
              <span class="org-string">"~/sync/orgzly/resources.org"</span>
              <span class="org-string">"~/proj/stream/index.org"</span>)
            org-agenda-files)
    <span class="org-doc">"Files to check for tag targets."</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-update-tag-targets</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((org-agenda-files my-org-tag-target-files))
    (<span class="org-keyword">setq</span> my-org-refile-tag-targets
          (<span class="org-keyword">let</span> (list)
            (org-map-entries
             (<span class="org-keyword">lambda</span> ()
               (list (concat <span class="org-string">"+"</span> (org-entry-get (point) <span class="org-string">"TAG_TARGET"</span>))
                     (org-id-get-create)
                     (org-entry-get (point) <span class="org-string">"ITEM"</span>)))
             <span class="org-string">"TAG_TARGET={.}"</span> 'agenda))))
  (customize-save-variable 'my-org-refile-tag-targets my-org-refile-tag-targets))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-add-tag-target</span> (tag)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTag: "</span>)
  (org-entry-put (point) <span class="org-string">"TAG_TARGET"</span> tag)
  (<span class="org-keyword">push</span> (list (concat <span class="org-string">"+"</span> tag)
              (org-id-get-create)
              (org-entry-get (point) <span class="org-string">"ITEM"</span>))
        my-org-refile-tag-targets)
  (customize-save-variable 'my-org-refile-tag-targets my-org-refile-tag-targets))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-current-entry-to-tag-target</span> (<span class="org-type">&amp;optional</span> arg target-marker)
  (<span class="org-keyword">interactive</span> (list current-prefix-arg (cadr (my-org-tag-target-for-entry-at-point))))
  (<span class="org-keyword">unless</span> target-marker
    (<span class="org-keyword">setq</span> target-marker (cadr (my-org-tag-target-for-entry-at-point))))
  (<span class="org-keyword">when</span> (stringp target-marker)
    (<span class="org-keyword">setq</span> target-marker (org-id-find target-marker t)))
  (<span class="org-keyword">when</span> target-marker
    (org-refile
     arg nil
     (<span class="org-keyword">with-current-buffer</span> (marker-buffer target-marker)
       (goto-char target-marker)
       (list (org-get-heading)
             (buffer-file-name (marker-buffer target-marker))
             nil
             target-marker)))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Based on https://emacs.stackexchange.com/questions/36360/recursively-refiling-all-subtrees-with-tag-to-a-destination-org-mode</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-matches-to-heading</span> (match target-heading-id <span class="org-type">&amp;optional</span> scope copy)
  <span class="org-doc">"Refile all headings within SCOPE (per `</span><span class="org-doc"><span class="org-constant">org-map-entries</span></span><span class="org-doc">') to TARGET-HEADING-ID."</span>
  (<span class="org-keyword">if-let</span> (target-marker (org-id-find target-heading-id t))
      (<span class="org-keyword">let*</span> ((target-rfloc (<span class="org-keyword">with-current-buffer</span> (marker-buffer target-marker)
                             (goto-char target-marker)
                             (list (org-get-heading)
                                   (buffer-file-name (marker-buffer target-marker))
                                   nil
                                   target-marker)))
             (headings-to-copy (org-map-entries (<span class="org-keyword">lambda</span> () (point-marker)) match scope)))
        (mapc
         (<span class="org-keyword">lambda</span> (heading-marker)
           (<span class="org-keyword">with-current-buffer</span> (marker-buffer heading-marker)
             (goto-char heading-marker)
             (org-refile nil nil target-rfloc (<span class="org-keyword">when</span> copy <span class="org-string">"Copy"</span>))))
         (nreverse headings-to-copy))
        (message <span class="org-string">"%s %d headings!"</span>
                 (<span class="org-keyword">if</span> copy <span class="org-string">"Copied"</span> <span class="org-string">"Refiled"</span>)
                 (length headings-to-copy)))
    (<span class="org-warning">warn</span> <span class="org-string">"Could not find target heading %S"</span> target-heading-id)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-tag-target-for-entry-at-point</span> ()
  <span class="org-doc">"Return the `</span><span class="org-doc"><span class="org-constant">my-org-refile-tag-targets</span></span><span class="org-doc">' entry that matches point."</span>
  (<span class="org-keyword">let</span> ((tags (org-get-tags (point)))
        (level (org-current-level))
        (todo (org-get-todo-state))
        matcher)
    (<span class="org-keyword">catch</span> '<span class="org-constant">found</span>
      (<span class="org-keyword">dolist</span> (target my-org-refile-tag-targets)
        (<span class="org-keyword">setq</span> matcher (cdr (org-make-tags-matcher (car target))))
        (<span class="org-keyword">when</span> (funcall matcher todo tags level)
          (<span class="org-keyword">throw</span> '<span class="org-constant">found</span> target))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-to-tag-targets</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">dolist</span> (rule my-org-refile-tag-targets)
    (my-org-refile-matches-to-heading (car rule) (cadr rule))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-inbox-to-tag-targets</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (find-file-noselect my-org-inbox-file)
    (<span class="org-keyword">dolist</span> (rule my-org-refile-tag-targets)
      (my-org-refile-matches-to-heading (car rule) (cadr rule) 'file))))
</pre>
</div>

<p>
So when I'm ready, I can call <code>my-org-refile-to-tag-targets</code> and have
lots of things disappear from my inbox.
</p>

<p>
Next step might be to write a function that will refile just the
current subtree (either going straight to the tag target or prompting
me for a destination if there isn't a matching one), so I can look at
stuff, decide if it needs to be scheduled first or something like
that, and then send it somewhere. There must be something I can pass a
property match to and it'll tell me if it matches the current
subtree - probably something along the lines of
<code>org-make-tags-matcher</code>&#x2026;
</p>

<p>
Anyway, just wanted to share this!
</p>
</div>
<div id="outline-container-org9e9f3ae" class="outline-5">
<h5 id="org9e9f3ae"><span class="todo TODO">TODO</span> refile inbox tags to this point</h5>
<div class="outline-text-5" id="text-org9e9f3ae">
</div>
</div>
</div>
<div id="outline-container-destination" class="outline-4">
<h4 id="destination">Moving lines around</h4>
<div class="outline-text-4" id="text-destination">
<p>
This makes it easier to reorganize lines in my weekly review.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-move-line-to-destination</span> ()
  <span class="org-doc">"Moves the current list item to DESTINATION in the current buffer.</span>
<span class="org-doc">If no DESTINATION is found, move it to the end of the list</span>
<span class="org-doc">and indent it one level."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">let</span> ((string
             (buffer-substring-no-properties
              (line-beginning-position) (line-end-position)))
            (case-fold-search nil)
            found)
        (delete-region (line-beginning-position) (1+ (line-end-position)))
        (<span class="org-keyword">save-excursion</span>
          (goto-char (point-min))
          (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"DESTINATION"</span> nil t)
            (insert <span class="org-string">"\n"</span> (make-string (- (match-beginning 0) (line-beginning-position)) ?\ ) (s-trim string))
            (<span class="org-keyword">setq</span> found t)))
        (<span class="org-keyword">unless</span> found
          (org-end-of-item-list)
          (insert string <span class="org-string">"\n"</span>))))))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-move-line-to-end-of-list</span> ()
  <span class="org-doc">"Move the current list item to the end of the list."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> ((string (buffer-substring-no-properties (line-beginning-position)
                                                  (line-end-position))))
      (delete-region (line-beginning-position) (1+ (line-end-position)))
      (org-end-of-item-list)
      (insert string))))

</pre>
</div>
</div>
</div>
<div id="outline-container-organizing-my-blog-index" class="outline-4">
<h4 id="organizing-my-blog-index">Organizing my blog index</h4>
<div class="outline-text-4" id="text-organizing-my-blog-index">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-file-blog-index-entries</span> ()
  <span class="org-doc">"Keep filing until I press `</span><span class="org-doc"><span class="org-constant">C-g</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">while</span> t
    (my-org-file-blog-index-entry
     (line-beginning-position) (1+ (line-end-position))
     (<span class="org-keyword">let</span> ((org-refile-targets
            '((<span class="org-string">"~/proj/sharing/blog.org"</span> . (<span class="org-builtin">:maxlevel</span> . 3)))))
       (<span class="org-keyword">save-excursion</span> (org-refile-get-location <span class="org-string">"Location"</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-file-blog-index-entry</span> (beg end location)
  <span class="org-doc">"Copy entries into blog.org."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">if</span> (region-active-p) (point) (line-beginning-position))
    (<span class="org-keyword">if</span> (region-active-p) (mark) (1+ (line-end-position)))
    (<span class="org-keyword">let</span> ((org-refile-targets
           '((<span class="org-string">"~/proj/sharing/blog.org"</span> . (<span class="org-builtin">:maxlevel</span> . 3)))))
      (<span class="org-keyword">save-excursion</span> (org-refile-get-location <span class="org-string">"Location"</span>)))))
  (<span class="org-keyword">let</span> ((s
         (replace-regexp-in-string
          <span class="org-string">"^[ \t]*- </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[</span><span class="org-string"><span class="org-constant">X\\</span></span><span class="org-string">] </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
          <span class="org-string">"- [X] "</span>
          (buffer-substring-no-properties beg end))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">if we're already in blog.org, delete the previous entry</span>
    (<span class="org-keyword">if</span> (string= buffer-file-name (expand-file-name <span class="org-string">"~/proj/sharing/blog.org"</span>))
        (delete-region beg end))
    (<span class="org-keyword">save-window-excursion</span>
      (<span class="org-keyword">save-excursion</span>
        (find-file (nth 1 location))
        (<span class="org-keyword">save-excursion</span>
          (<span class="org-keyword">save-restriction</span>
            (widen)
            (goto-char (nth 3 location))
            (re-search-forward org-list-full-item-re nil t)
            (goto-char (line-beginning-position))
            (insert s)
            (org-update-statistics-cookies nil)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-quickly-refiling-org-mode-notes-to-headings-in-the-same-file" class="outline-4">
<h4 id="quickly-refiling-org-mode-notes-to-headings-in-the-same-file">Refiling Org Mode notes to headings in the same file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-quickly-refiling-org-mode-notes-to-headings-in-the-same-file">
<p>
I spent some time tidying up my <a href="https://sachachua.com/dotemacs">Emacs
configuration</a> . I used <code>org-babel-demarcate-block</code>
to split up some long <code>#+begin_src...#+end_src</code>
blocks and refiled sections to group them
together. I also promoted more sections to
top-level headings in order to make the most of
the side navigation provided by the <a href="https://github.com/fniessen/org-html-themes">Read the Org
setup file</a> based on <a href="https://docs.readthedocs.io/en/latest/">Read the Docs</a>. These functions
were helpful:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org1206b06">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-in-file</span> (<span class="org-type">&amp;optional</span> prefix)
  <span class="org-doc">"Refile to a target within the current file."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((org-refile-targets (list (cons nil '(<span class="org-builtin">:maxlevel</span> . 5)))))
    (call-interactively 'org-refile)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-refile-to-previous</span> ()
  <span class="org-doc">"Refile subtree to last position from `</span><span class="org-doc"><span class="org-constant">my-org-refile-in-file</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-selected-window</span>
    (<span class="org-keyword">when</span> (eq major-mode 'org-agenda-mode)
      (org-agenda-switch-to))
    (org-cut-subtree)
    (<span class="org-keyword">save-window-excursion</span>
      (<span class="org-keyword">save-excursion</span>
        (bookmark-jump (plist-get org-bookmark-names-plist <span class="org-builtin">:last-refile</span>))
        (<span class="org-keyword">let</span> ((level (org-current-level)))
          (org-end-of-subtree t t)
          (org-paste-subtree))))))

(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">push</span> '(<span class="org-string">"w"</span> call-interactively 'org-refile) org-speed-commands)
  (<span class="org-keyword">push</span> '(<span class="org-string">"W"</span> call-interactively 'my-org-refile-in-file) org-speed-commands)
  (<span class="org-keyword">push</span> '(<span class="org-string">"."</span> call-interactively 'my-org-refile-to-previous) org-speed-commands))
</pre>
</div>

<p>
I usually have <code>org-refile-targets</code> set to a long
list of files so that I can use <code>C-u C-c C-w</code> to
jump to headings from anywhere, but I just wanted
to refile other things in my configuration, so it
was nice to limit the scope to just that file.
</p>

<p>
I like using <code>org-speed-commands</code> to give me quick
shortcuts when I'm at headings.
</p>
</div>
</div>
</div>
<div id="outline-container-org-contacts" class="outline-3">
<h3 id="org-contacts">Contacts</h3>
<div class="outline-text-3" id="text-org-contacts">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org-contacts
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-contacts-files '(<span class="org-string">"~/sync/orgzly/people.org"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-inserting-code" class="outline-3">
<h3 id="inserting-code">Inserting code</h3>
<div class="outline-text-3" id="text-inserting-code">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-defun</span> (function)
  <span class="org-doc">"Inserts an Org source block with the definition for FUNCTION."</span>
  (<span class="org-keyword">interactive</span> (find-function-read))
  (<span class="org-keyword">let*</span> ((buffer-point (<span class="org-keyword">condition-case</span> nil (find-definition-noselect function nil) (<span class="org-warning">error</span> nil)))
         (new-buf (car buffer-point))
         (new-point (cdr buffer-point))
         definition)
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> buffer-point new-point)
        (<span class="org-keyword">with-current-buffer</span> new-buf <span class="org-comment-delimiter">;; </span><span class="org-comment">Try to get original definition</span>
          (<span class="org-keyword">save-excursion</span>
            (goto-char new-point)
            (<span class="org-keyword">setq</span> definition (buffer-substring-no-properties (point) (<span class="org-keyword">save-excursion</span> (end-of-defun) (point))))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Fallback: Print function definition</span>
      (<span class="org-keyword">setq</span> definition (concat (prin1-to-string (symbol-function function)) <span class="org-string">"\n"</span>)))
    (<span class="org-keyword">if</span> (org-in-src-block-p)
        (insert definition)
      (insert <span class="org-string">"#+begin_src emacs-lisp\n"</span> definition <span class="org-string">"#+end_src\n"</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-function-and-key</span> (keys)
  (<span class="org-keyword">interactive</span> (caar (help--read-key-sequence)))
  (insert (format <span class="org-string">"=%s= (=%s=)"</span> (symbol-name (key-binding keys t))
                  (key-description keys))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:hook</span> (org-mode . org-indent-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-indent-indentation-per-level 2)
  (<span class="org-keyword">setq</span> org-edit-src-content-indentation 0)
  (<span class="org-keyword">setq</span> org-src-preserve-indentation t))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-babel" class="outline-3">
<h3 id="org-babel">Org Babel</h3>
<div class="outline-text-3" id="text-org-babel">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org032c3e3">(<span class="org-keyword">setq</span> org-babel-default-header-args
      '((<span class="org-builtin">:session</span> . <span class="org-string">"none"</span>)
        (<span class="org-builtin">:results</span> . <span class="org-string">"drawer replace"</span>)
        (<span class="org-builtin">:comments</span> . <span class="org-string">"both"</span>)
        (<span class="org-builtin">:exports</span> . <span class="org-string">"code"</span>)
        (<span class="org-builtin">:cache</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:eval</span> . <span class="org-string">"never-export"</span>)
        (<span class="org-builtin">:hlines</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:tangle</span> . <span class="org-string">"no"</span>)))
(<span class="org-keyword">setq</span> org-edit-src-auto-save-idle-delay 5)
</pre>
</div>
</div>
<div id="outline-container-format-source" class="outline-4">
<h4 id="format-source">Format source</h4>
<div class="outline-text-4" id="text-format-source">
<p>
<a href="https://apps.bram85.nl/git/bram/gists/src/commit/118c5a579a231862f4d1a548afe071e450af4e03/gists/format-org-mode-source-blocks.el">gists/format-org-mode-source-blocks.el at 118c5a579a231862f4d1a548afe071e450af4e03 - gists - Forgejo</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> format-all <span class="org-builtin">:if</span> my-laptop-p)

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">my/format-all-advice</span> ()
    (<span class="org-keyword">ignore-errors</span>               <span class="org-comment-delimiter">; </span><span class="org-comment">in case there's no language support</span>
      (format-all-buffer)))
  (advice-add #'org-edit-src-exit <span class="org-builtin">:before</span> #'my/format-all-advice))
</pre>
</div>
</div>
</div>
<div id="outline-container-execute-named-babel-block" class="outline-4">
<h4 id="execute-named-babel-block"><span class="todo TODO">TODO</span> Execute named babel block</h4>
<div class="outline-text-4" id="text-execute-named-babel-block">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org32b5dd7">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-execute-src-block-by-name</span> (name)
  (<span class="org-keyword">interactive</span> (list (completing-read <span class="org-string">"Block: "</span>(org-babel-src-block-names))))
  (<span class="org-keyword">save-excursion</span>
    (goto-char (point-min))
    (<span class="org-keyword">when</span> (re-search-forward (format <span class="org-string">"^#\\+NAME:[ \t]+%s[ \t]*$"</span> (regexp-quote name)) nil t)
      (org-babel-execute-src-block))))
</pre>
</div>
</div>
</div>
<div id="outline-container-json" class="outline-4">
<h4 id="json">JSON</h4>
<div class="outline-text-4" id="text-json">
<p>
From <a href="https://isamert.net/2022/01/04/dealing-with-apis-jsons-and-databases-in-org-mode.html">https://isamert.net/2022/01/04/dealing-with-apis-jsons-and-databases-in-org-mode.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-execute:json</span> (body params)
  (<span class="org-keyword">let</span> ((jq (cdr (assoc <span class="org-builtin">:jq</span> params)))
        (node (cdr (assoc <span class="org-builtin">:node</span> params))))
    (<span class="org-keyword">cond</span>
     (jq
      (<span class="org-keyword">with-temp-buffer</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Insert the JSON into the temp buffer</span>
        (insert body)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Run jq command on the whole buffer, and replace the buffer</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">contents with the result returned from jq</span>
        (shell-command-on-region (point-min) (point-max) (format <span class="org-string">"jq -r \"%s\""</span> jq) nil 't)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">Return the contents of the temp buffer as the result</span>
        (buffer-string)))
     (node
      (<span class="org-keyword">with-temp-buffer</span>
        (insert (format <span class="org-string">"const it = %s;"</span> body))
        (insert node)
        (shell-command-on-region (point-min) (point-max) <span class="org-string">"node -p"</span> nil 't)
        (buffer-string))))))
</pre>
</div>
</div>
<div id="outline-container-jq" class="outline-5">
<h5 id="jq">JQ</h5>
<div class="outline-text-5" id="text-jq">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> jq-mode
  <span class="org-builtin">:vc</span> (<span class="org-builtin">:url</span> <span class="org-string">"https://github.com/ljos/jq-mode"</span>)
  <span class="org-builtin">:config</span>
  (org-babel-do-load-languages 'org-babel-load-languages
                               '((jq . t))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org-block-indentation" class="outline-4">
<h4 id="org-block-indentation">Fix block indentation</h4>
<div class="outline-text-4" id="text-org-block-indentation">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-fix-block-indentation</span> ()
  <span class="org-doc">"Fix the indentation of the current src block."</span>
  (<span class="org-keyword">interactive</span>)
  (org-edit-special)
  (indent-region (point-min) (point-max))
  (org-edit-src-exit))
</pre>
</div>
</div>
</div>
<div id="outline-container-let-s-try-literate-elisp" class="outline-4">
<h4 id="let-s-try-literate-elisp">Let's try literate-elisp</h4>
<div class="outline-text-4" id="text-let-s-try-literate-elisp">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> literate-elisp <span class="org-builtin">:if</span> my-laptop-p)
</pre>
</div>

<p>
Then I should be able to use <code>literate-elisp-load-file</code> and still be able to jump to functions by definition.
</p>
</div>
</div>
</div>
<div id="outline-container-publishing" class="outline-3">
<h3 id="publishing">Publishing</h3>
<div class="outline-text-3" id="text-publishing">
</div>
<div id="outline-container-org5ba99fa" class="outline-4">
<h4 id="org5ba99fa">Counting words without blocks</h4>
<div class="outline-text-4" id="text-org5ba99fa">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-subtree-text-without-blocks</span> ()
  <span class="org-doc">"Don't include source blocks or links."</span>
  (<span class="org-keyword">let</span> ((text <span class="org-string">""</span>))
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">save-restriction</span>
        (org-back-to-heading)
        (org-narrow-to-subtree)
        (org-end-of-meta-data)
        (<span class="org-keyword">setq</span> text (buffer-substring (point) (point-max)))))
    (<span class="org-keyword">with-temp-buffer</span>
      (insert text)
      (org-mode)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward org-link-any-re nil t)
        (replace-match (<span class="org-keyword">or</span> (match-string 3) <span class="org-string">"(link)"</span>)))
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^ *#\\+begin"</span> nil t)
       (<span class="org-keyword">let</span> ((block (org-element-context)))
         (<span class="org-keyword">unless</span> (eq (org-element-type block) 'quote-block)
           (delete-region (org-element-begin block)
                          (org-element-end block)))))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"\n\n+"</span> nil t)
        (replace-match <span class="org-string">"\n"</span>))
      (string-trim
       (buffer-string)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-subtree-count-words-without-blocks</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((text (my-org-subtree-text-without-blocks)))
    (<span class="org-keyword">with-temp-buffer</span>
      (insert text)
      (message <span class="org-string">"%s"</span> (count-words--buffer-format)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-subtree-copy-words-without-blocks</span> ()
  (<span class="org-keyword">interactive</span>)
  (kill-new (my-org-subtree-text-without-blocks)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-mode-including-portions-of-files-between-two-regular-expressions" class="outline-4">
<h4 id="org-mode-including-portions-of-files-between-two-regular-expressions">Org Mode: Including portions of files between two regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-org-mode-including-portions-of-files-between-two-regular-expressions">
<div class="update" id="orga4d16ce">
<ul class="org-ul">
<li>2023-10-11 Wed: Include images inline.</li>
<li>2023-09-10: Use <code>consult-line</code> instead of <code>consult--line</code>.</li>
</ul>

</div>

<p>
I'd like to refer to snippets of code, but lines are too fragile to
use as references for code and posts that I want to easily update. I'd
like to specify a <code>from-regexp</code> and a <code>to-regexp</code> instead in order to
collect the lines between those regexps (including the ones with the
regexps themselves). <code>org-export-expand-include-keyword</code> looked a bit
hairy to extend since it uses regular expressions to match parameter
values. For this quick experiment, I decided to make a custom link
type instead. This allows me to refer to parts of code with a link like this:
</p>

<p>
<code>[[my-include:~/proj/static-blog/assets/css/style.css::from-regexp=Start of copy code&amp;to-regexp=End of copy code&amp;wrap=src js]]</code>
</p>

<p>
which will turn into this snippet from my stylesheet:

</p>

<p>
Here's the Emacs Lisp code to do that. <code>my-include-complete</code> function
reuses <code>my-include-open</code> to narrow to the file, and
<code>my-include-complete</code> uses <code>consult-line</code> so that we can specify the
prompt.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span class="org-string">"my-include"</span>
 <span class="org-builtin">:follow</span> #'my-include-open
 <span class="org-builtin">:export</span> #'my-include-export
 <span class="org-builtin">:complete</span> #'my-include-complete)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-include-open</span> (path <span class="org-type">&amp;optional</span> _)
  <span class="org-doc">"Narrow to the region specified in PATH."</span>
  (<span class="org-keyword">let</span> (params start end)
    (<span class="org-keyword">if</span> (string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">::</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> path)
        (<span class="org-keyword">setq</span> params (<span class="org-keyword">save-match-data</span> (org-protocol-convert-query-to-plist (match-string 2 path)))
              path (match-string 1 path)))
    (find-file path)
    (<span class="org-keyword">if</span> (plist-get params <span class="org-builtin">:name</span>)
        (<span class="org-keyword">when</span> (org-babel-find-named-block (plist-get params <span class="org-builtin">:name</span>))
          (goto-char (org-babel-find-named-block (plist-get params <span class="org-builtin">:name</span>)))
          (<span class="org-keyword">let</span> ((block (org-element-context)))
            (narrow-to-region (org-element-begin block)
                              (org-element-end block))))
      (<span class="org-keyword">setq</span> start
            (<span class="org-keyword">or</span>
             (<span class="org-keyword">and</span>
              (plist-get params <span class="org-builtin">:from-regexp</span>)
              (<span class="org-keyword">progn</span>
                (goto-char (point-min))
                (<span class="org-keyword">when</span> (re-search-forward (url-unhex-string (plist-get params <span class="org-builtin">:from-regexp</span>)))
                  (line-beginning-position))))
             (<span class="org-keyword">progn</span>
               (goto-char (point-min))
               (point))))
      (<span class="org-keyword">setq</span> end
            (<span class="org-keyword">or</span>
             (<span class="org-keyword">and</span>
              (plist-get params <span class="org-builtin">:to-regexp</span>)
              (<span class="org-keyword">progn</span>
                (<span class="org-keyword">when</span> (re-search-forward (url-unhex-string (plist-get params <span class="org-builtin">:to-regexp</span>)))
                  (line-end-position))))
             (<span class="org-keyword">progn</span>
               (goto-char (point-max))
               (point))))
      (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (not (= start (point-min)))
                (not (= end (point-max))))
        (narrow-to-region start end)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-include-export</span> (path _ format _)
  <span class="org-doc">"Export PATH to FORMAT using the specified wrap parameter."</span>
  (<span class="org-keyword">let</span> (params body start end)
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">::</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> path)
      (<span class="org-keyword">setq</span> params (<span class="org-keyword">save-match-data</span> (org-protocol-convert-query-to-plist (match-string 2 path)))
            path (match-string 1 path)))
    (<span class="org-keyword">with-temp-buffer</span>
      (insert-file-contents-literally path)
      (<span class="org-keyword">when</span> (string-match <span class="org-string">"\\.org$"</span> path)
        (org-mode))
      (<span class="org-keyword">if</span> (plist-get params <span class="org-builtin">:name</span>)
          (<span class="org-keyword">when</span> (org-babel-find-named-block (plist-get params <span class="org-builtin">:name</span>))
            (goto-char (org-babel-find-named-block (plist-get params <span class="org-builtin">:name</span>)))
            (<span class="org-keyword">let</span> ((block (org-element-context)))
              (<span class="org-keyword">setq</span> start (org-element-begin block)
                    end (org-element-end block))))
        (goto-char (point-min))
        (<span class="org-keyword">when</span> (plist-get params <span class="org-builtin">:from-regexp</span>)
          (re-search-forward (url-unhex-string (plist-get params <span class="org-builtin">:from-regexp</span>)))
          (goto-char (match-beginning 0)))
        (<span class="org-keyword">setq</span> start (point))
        (<span class="org-keyword">setq</span> end (point-max))
        (<span class="org-keyword">when</span> (plist-get params <span class="org-builtin">:to-regexp</span>)
          (re-search-forward (url-unhex-string (plist-get params <span class="org-builtin">:to-regexp</span>)))
          (<span class="org-keyword">setq</span> end (match-beginning 0))))
      (<span class="org-keyword">setq</span> body (buffer-substring start end)))
    (<span class="org-keyword">with-temp-buffer</span>
      (<span class="org-keyword">when</span> (plist-get params <span class="org-builtin">:wrap</span>)
        (<span class="org-keyword">let*</span> ((wrap (plist-get params <span class="org-builtin">:wrap</span>))
               block args)
          (<span class="org-keyword">when</span> (string-match <span class="org-string">"\\&lt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\S-+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> +.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span> wrap)
            (<span class="org-keyword">setq</span> block (match-string 1 wrap))
            (<span class="org-keyword">setq</span> args (match-string 2 wrap))
            (<span class="org-keyword">setq</span> body (format <span class="org-string">"#+BEGIN_%s%s\n%s\n#+END_%s\n"</span>
                               block (<span class="org-keyword">or</span> args <span class="org-string">""</span>)
                               body
                               block)))))
      (<span class="org-keyword">when</span> (plist-get params <span class="org-builtin">:summary</span>)
        (<span class="org-keyword">setq</span> body (format <span class="org-string">"#+begin_my_details %s\n%s\n#+end_my_details\n"</span>
                           (plist-get params <span class="org-builtin">:summary</span>)
                           body)))
      (insert body)
      (org-export-as format nil nil t))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-include-complete</span> ()
  <span class="org-doc">"Include a section of a file from one line to another, specified with regexps."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">consult</span>)
  (<span class="org-keyword">let</span> ((file (read-file-name <span class="org-string">"File: "</span>)))
    (<span class="org-keyword">save-window-excursion</span>
      (find-file file)
      (concat <span class="org-string">"my-include:"</span>
              file
              <span class="org-string">"?from-regexp="</span>
              (<span class="org-keyword">let</span> ((curr-line (line-number-at-pos
                                (point)
                                consult-line-numbers-widen))
                    (prompt <span class="org-string">"From line: "</span>))
                (goto-char (point-min))
                (consult-line)
                (url-hexify-string
                 (regexp-quote (buffer-substring (line-beginning-position) (line-end-position)))))
              <span class="org-string">"&amp;to-regexp="</span>
              (<span class="org-keyword">let</span> ((curr-line (line-number-at-pos
                                (point)
                                consult-line-numbers-widen))
                    (prompt <span class="org-string">"To line: "</span>))
                (goto-char (point-min))
                (consult-line
                 nil (point))
                (url-hexify-string
                 (regexp-quote (buffer-substring (line-beginning-position) (line-end-position)))))
              <span class="org-string">"&amp;wrap=src "</span> (replace-regexp-in-string <span class="org-string">"-mode$"</span> <span class="org-string">""</span> (symbol-name major-mode))))))
</pre>
</div>

<p>
This code displays the images inline.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-display-included-images</span> (<span class="org-type">&amp;optional</span> include-linked refresh beg end)
  <span class="org-doc">"Display inline images for my-include types."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">when</span> (display-graphic-p)
    (<span class="org-keyword">when</span> refresh
      (org-remove-inline-images beg end)
      (<span class="org-keyword">when</span> (fboundp 'clear-image-cache) (clear-image-cache)))
    (<span class="org-keyword">let</span> ((end (<span class="org-keyword">or</span> end (point-max))))
      (<span class="org-keyword">org-with-point-at</span> (<span class="org-keyword">or</span> beg (point-min))))
    (<span class="org-keyword">let*</span> ((case-fold-search t)
           (file-extension-re <span class="org-string">"\\.svg"</span>)
           (file-types-re (format <span class="org-string">"\\[\\[my-include:"</span>)))
      (<span class="org-keyword">while</span> (re-search-forward file-types-re end t)
        (<span class="org-keyword">let*</span> ((link (org-element-lineage (<span class="org-keyword">save-match-data</span> (org-element-context)) 'link t))
               (inner-start (match-beginning 1))
               (path
                (<span class="org-keyword">cond</span>
                 ((not link) nil)
                 <span class="org-comment-delimiter">;; </span><span class="org-comment">file link without a description</span>
                 ((<span class="org-keyword">or</span> (not (org-element-contents-begin link)) include-linked)
                  (org-element-property <span class="org-builtin">:path</span> link))
                 ((not inner-start) nil)
                 (t (<span class="org-keyword">org-with-point-at</span> inner-start
                      (<span class="org-keyword">and</span> (looking-at
                            (<span class="org-keyword">if</span> (char-equal ?&lt; (char-after inner-start))
                                org-link-angle-re
                              org-link-plain-re))
                           <span class="org-comment-delimiter">;; </span><span class="org-comment">File name must fill the whole</span>
                           <span class="org-comment-delimiter">;; </span><span class="org-comment">description.</span>
                           (= (org-element-contents-end link)
                              (match-end 0))
                           (<span class="org-keyword">progn</span>
                             (<span class="org-keyword">setq</span> linktype (match-string 1))
                             (match-string 2))))))))
          (<span class="org-keyword">when</span> (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\?"</span> path)
            (<span class="org-keyword">setq</span> path (match-string 1 path)))
          (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> path (string-match-p file-extension-re path))
            (<span class="org-keyword">let</span> ((file (expand-file-name path)))
              <span class="org-comment-delimiter">;; </span><span class="org-comment">Expand environment variables.</span>
              (<span class="org-keyword">when</span> file (<span class="org-keyword">setq</span> file (substitute-in-file-name file)))
              (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> file (file-exists-p file))
                (<span class="org-keyword">let</span> ((width (org-display-inline-image--width link))
                      (old (get-char-property-and-overlay
                            (org-element-begin link)
                            'org-image-overlay)))
                  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (car-safe old) refresh)
                      (image-flush (overlay-get (cdr old) 'display))
                    (<span class="org-keyword">let</span> ((image (org--create-inline-image file width)))
                      (<span class="org-keyword">when</span> image
                        (<span class="org-keyword">let</span> ((ov (make-overlay
                                   (org-element-begin link)
                                   (<span class="org-keyword">progn</span>
                                     (goto-char
                                      (org-element-end link))
                                     (skip-chars-backward <span class="org-string">" \t"</span>)
                                     (point)))))
                          <span class="org-comment-delimiter">;; </span><span class="org-comment">FIXME: See bug#59902.  We cannot rely</span>
                          <span class="org-comment-delimiter">;; </span><span class="org-comment">on Emacs to update image if the file</span>
                          <span class="org-comment-delimiter">;; </span><span class="org-comment">has changed.</span>
                          (image-flush image)
                          (overlay-put ov 'display image)
                          (overlay-put ov 'face 'default)
                          (overlay-put ov 'org-image-overlay t)
                          (overlay-put
                           ov 'modification-hooks
                           (list 'org-display-inline-remove-overlay))
                          (<span class="org-keyword">when</span> (boundp 'image-map)
                            (overlay-put ov 'keymap image-map))
                          (<span class="org-keyword">push</span> ov org-inline-image-overlays))))))))))))))

</pre>
</div>
</div>
</div>
<div id="outline-container-ox-epub" class="outline-4">
<h4 id="ox-epub">ox-epub</h4>
<div class="outline-text-4" id="text-ox-epub">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ox-epub
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-epub-style-default (concat org-epub-style-default <span class="org-string">"\n  p.my-verse { white-space: pre }\n"</span>)))

</pre>
</div>
</div>
</div>
<div id="outline-container-config-footer" class="outline-4">
<h4 id="config-footer"><span class="done DONE">DONE</span> Add a note to the bottom of blog posts exported from my config file</h4>
<div class="outline-text-4" id="text-config-footer">
<p>
Update: 2021-04-18: Tweaked the code so that I could add it to
the main <code>org-export-filter-body-functions</code> list now that I'm
using Eleventy and ox-11ty.el instead of Wordpress and org2blog.
</p>

<p>
I occasionally post snippets from my Emacs configuration file,
drafting the notes directly in my literate config. I figured it
might be a good idea to include a link to my config at the end of
the posts, but I didn't want to scatter redundant links in my
config file itself. Wouldn't it be cool if the link could be
automatically added whenever I post a subtree from my config
file? I think the code below accomplishes that.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-export-filter-body-add-emacs-configuration-link</span> (string backend info)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (plist-get info <span class="org-builtin">:input-file</span>) (string-match <span class="org-string">"\\.emacs\\.d/Sacha\\.org</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">sync/emacs/Sacha\\.org"</span> (plist-get info <span class="org-builtin">:input-file</span>)))
    (concat string
            (<span class="org-keyword">let</span> ((id (org-entry-get-with-inheritance <span class="org-string">"CUSTOM_ID"</span>)))
              (format
               (<span class="org-keyword">if</span> (eq backend 'md)
                   <span class="org-string">"\nThis is part of my [Emacs configuration](https://sachachua.com/dotemacs%s)\n"</span>
                 <span class="org-string">"\n&lt;div class=\"note\"&gt;This is part of my &lt;a href=\"https://sachachua.com/dotemacs%s\"&gt;Emacs configuration.&lt;/a&gt;&lt;/div&gt;"</span>)
               (<span class="org-keyword">if</span> id (concat <span class="org-string">"#"</span> id) <span class="org-string">""</span>))))))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">with-eval-after-load</span> 'ox
    (add-to-list 'org-export-filter-body-functions #'my-org-export-filter-body-add-emacs-configuration-link)))
</pre>
</div>
</div>
</div>
<div id="outline-container-copy-linked-file-and-change-link" class="outline-4">
<h4 id="copy-linked-file-and-change-link">Copy linked file and change link</h4>
<div class="outline-text-4" id="text-copy-linked-file-and-change-link">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-copy-linked-file-and-change-link</span> (destination)
  (<span class="org-keyword">interactive</span> (list (read-file-name (format <span class="org-string">"Copy %s to: "</span>
                                             (file-name-nondirectory (org-element-property <span class="org-builtin">:path</span> (org-element-context)))))))
  (<span class="org-keyword">let*</span> ((elem (org-element-context))
         (path (org-element-property <span class="org-builtin">:path</span> elem))
         (description (org-element-property <span class="org-builtin">:description</span> elem)))
    (copy-file path destination t)
    (delete-region (org-element-begin elem) (org-element-end elem))
    (insert (org-link-make-string (concat <span class="org-string">"file:"</span> (file-relative-name (<span class="org-keyword">if</span> (file-directory-p destination)
                                                                          (expand-file-name (file-name-nondirectory path)
                                                                                            destination)
                                                                        destination)))
                                  description))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-copy-linked-files</span> (destination)
  (<span class="org-keyword">interactive</span> (list (read-file-name (format <span class="org-string">"Copy %s to: "</span>
                                             (file-name-nondirectory (org-element-property <span class="org-builtin">:path</span> (org-element-context)))))))
  (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"file:"</span> nil t)
    (<span class="org-keyword">let*</span> ((elem (org-element-context))
           (path (org-element-property <span class="org-builtin">:path</span> elem))
           (description (org-element-property <span class="org-builtin">:description</span> elem)))
      (<span class="org-keyword">unless</span> (string-match (concat <span class="org-string">"^"</span> (regexp-quote (expand-file-name destination))) (expand-file-name path))
        (my-org-copy-linked-file-and-change-link destination)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-mode-create-a-quick-timestamped-note-and-capture-a-screenshot" class="outline-4">
<h4 id="org-mode-create-a-quick-timestamped-note-and-capture-a-screenshot">Org Mode: Create a quick timestamped note and capture a screenshot&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h4>
<div class="outline-text-4" id="text-org-mode-create-a-quick-timestamped-note-and-capture-a-screenshot">
<p>
I wanted to be able to quickly create timestamped notes and possibly
capture a screenshot. Prompting for a value inside an
<code>org-capture-template</code> disrupts my screen a little, so maybe this will
make it as easy as possible. I could probably do this without going
through org-capture-templates, but I wanted to take advantage of the
fact that Org Mode will deal with the date tree and finding the right
position itself.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-screenshot-directory</span> <span class="org-string">"~/recordings"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-screenshot</span> (file <span class="org-type">&amp;optional</span> note)
  (<span class="org-keyword">interactive</span> (list
                (<span class="org-keyword">if</span> current-prefix-arg
                    (expand-file-name
                     (consult--read
                      (reverse (directory-files my-screenshot-directory nil <span class="org-string">"\\.png$"</span>))
                      <span class="org-builtin">:sort</span> nil
                      <span class="org-builtin">:require-match</span> t
                      <span class="org-builtin">:category</span> 'file
                      <span class="org-builtin">:state</span> (<span class="org-keyword">lambda</span> (candidate state)
                               (<span class="org-keyword">when</span> candidate
                                 (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (expand-file-name candidate my-screenshot-directory))
                                   (display-buffer (current-buffer))))))
                     my-screenshot-directory)
                  (my-latest-file my-screenshot-directory))))
  (<span class="org-keyword">if</span> (derived-mode-p 'mastodon-toot-mode)
      (mastodon-toot--attach-media file (<span class="org-keyword">or</span> note (read-string <span class="org-string">"Caption: "</span>)))
    (<span class="org-keyword">save-window-excursion</span>
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"webm"</span> file)
          (<span class="org-keyword">progn</span>
            (mpv-play file)
            (insert (org-link-make-string (concat <span class="org-string">"video:"</span> file <span class="org-string">"?caption="</span> (<span class="org-keyword">or</span> note (read-string <span class="org-string">"Caption: "</span>)))) <span class="org-string">"\n"</span>))
        (<span class="org-keyword">with-current-buffer</span> (find-file-noselect file) (display-buffer (current-buffer)))
        (insert <span class="org-string">"#+CAPTION: "</span> (<span class="org-keyword">or</span> note (read-string <span class="org-string">"Caption: "</span>)) <span class="org-string">"\n"</span>
                (org-link-make-string (concat <span class="org-string">"file:"</span> file)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-last-screenshot-to-file</span> (new-filename)
  (<span class="org-keyword">interactive</span> (list (read-file-name (format <span class="org-string">"Copy %s to: "</span> (file-name-nondirectory (my-latest-file my-screenshot-directory))))))
  (copy-file (my-latest-file my-screenshot-directory) new-filename))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-last-screenshot-and-insert-into-org</span> (new-filename caption)
  (<span class="org-keyword">interactive</span> (list (read-file-name (format <span class="org-string">"Copy %s to: "</span> (file-name-nondirectory (my-latest-file my-screenshot-directory))))
                     (read-string <span class="org-string">"Caption: "</span>)))
  (copy-file (my-latest-file my-screenshot-directory) new-filename t)
  (insert <span class="org-string">"#+CAPTION: "</span> caption <span class="org-string">"\n"</span>
          (org-link-make-string (concat <span class="org-string">"file:"</span> (file-relative-name new-filename))) <span class="org-string">"\n"</span>))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-capture-prefill-template</span> (template <span class="org-type">&amp;rest</span> values)
  <span class="org-doc">"Pre-fill TEMPLATE with VALUES."</span>
  (<span class="org-keyword">setq</span> template (<span class="org-keyword">or</span> template (org-capture-get <span class="org-builtin">:template</span>)))
  (<span class="org-keyword">with-temp-buffer</span>
    (insert template)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward
            (concat <span class="org-string">"%</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span>
                    <span class="org-string">"\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"&lt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&gt;\n]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[tTuUaliAcxkKInfF]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-a-zA-Z]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"\\^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">{</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">}]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">}</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                    <span class="org-string">"?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[gGtTuUCLp]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">"</span>
                    <span class="org-string">"%\\\\</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[1-9][0-9]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                    <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>) <span class="org-warning">nil t)</span>
      (<span class="org-keyword">if</span> (car values)
          (replace-match (car values) nil t))
      (<span class="org-keyword">setq</span> values (cdr values)))
    (buffer-string)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-capture-timestamped-note</span> (time note)
  <span class="org-doc">"Disable Helm and capture a quick timestamped note."</span>
  (<span class="org-keyword">interactive</span> (list (current-time) (read-string <span class="org-string">"Note: "</span>)))
  (<span class="org-keyword">let</span> ((helm-completing-read-handlers-alist '((org-capture . nil)))
        (entry (org-capture-select-template <span class="org-string">"p"</span>)))
    (org-capture-set-plist entry)
    (org-capture-get-template)
    (org-capture-set-target-location)
    (org-capture-put
     <span class="org-builtin">:template</span> (org-capture-fill-template
                (my-org-capture-prefill-template (org-capture-get <span class="org-builtin">:template</span>)
                                                 (format-time-string <span class="org-string">"%H:%M:%S,%3N"</span>)
                                                 note)))
    (org-capture-place-template)
    (org-capture-finalize)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-capture-timestamped-note-with-screenshot</span> (time note)
  <span class="org-doc">"Include a link to the latest screenshot."</span>
  (<span class="org-keyword">interactive</span> (list (current-time) (read-string <span class="org-string">"Note: "</span>)))
  (kill-new (my-latest-file my-screenshot-directory))
  (my-capture-timestamped-note time note))
</pre>
</div>
</div>
</div>
<div id="outline-container-11ty" class="outline-4">
<h4 id="11ty">11ty</h4>
<div class="outline-text-4" id="text-11ty">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ox-11ty
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/proj/ox-11ty"</span>
  <span class="org-builtin">:config</span>
  (advice-add 'org-11ty--front-matter <span class="org-builtin">:filter-return</span> #'my-org-11ty-rewrite-tags))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-11ty-serve-process</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-rewrite-tags</span> (info)
  <span class="org-doc">"Turn OneWordTags into one-word-tags."</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">s</span>)
  (<span class="org-keyword">dolist</span> (field '(<span class="org-builtin">:categories</span> <span class="org-builtin">:tags</span>))
    (<span class="org-keyword">when</span> (plist-get info field)
      (plist-put info field
                 (mapcar (<span class="org-keyword">lambda</span> (s)
                           (<span class="org-keyword">if</span> (string-match <span class="org-string">"^_"</span> s)
                               s
                             (s-dashed-words s)))
                         (plist-get info field)))))
  info)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-unpublish</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)
    (delete-directory (expand-file-name (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)
                                        my-11ty-base-dir)
                      t)
    (delete-directory (expand-file-name (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)
                                        (expand-file-name <span class="org-string">"_site"</span> my-11ty-base-dir))
                      t)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-copy-permalink</span> ()
  (<span class="org-keyword">interactive</span>)
  (kill-new (concat <span class="org-string">"https://sachachua.com"</span> (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-browse-local</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">unless</span> (seq-find (<span class="org-keyword">lambda</span> (o) (string-match <span class="org-string">"--serve"</span> (assoc-default 'args (cdr o) nil <span class="org-string">""</span>)))
                    (proced-process-attributes))
    (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/proj/static-blog"</span>))
      (<span class="org-keyword">setq</span> my-org-11ty-serve-process (start-process <span class="org-string">"serve"</span> nil <span class="org-string">"make"</span> <span class="org-string">"serve"</span>))))
  (browse-url <span class="org-string">"http://localhost:8080/blog"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-serve-stop</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (process-live-p my-org-11ty-serve-process)
      (stop-process my-org-11ty-serve-process)
    (<span class="org-keyword">when-let</span> ((proc (seq-find (<span class="org-keyword">lambda</span> (o) (string-match <span class="org-string">"--serve"</span> (assoc-default 'args (cdr o) nil <span class="org-string">""</span>)))
                               (proced-process-attributes))))
      (call-process <span class="org-string">"kill"</span> nil nil nil (number-to-string) (car proc)))))


(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-prepare-subtree</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">unless</span> (<span class="org-keyword">or</span> (org-entry-get (point) <span class="org-string">"EXPORT_DATE"</span>)
              (org-entry-get-with-inheritance <span class="org-string">"DATE"</span>))
    (org-entry-put (point) <span class="org-string">"EXPORT_DATE"</span> (format-time-string <span class="org-string">"%Y-%m-%dT%T%z"</span>)))
  (<span class="org-keyword">let</span> ((path (concat <span class="org-string">"blog/"</span> (format-time-string <span class="org-string">"%Y/%m/"</span>)
                      (my-make-slug (org-get-heading t t t t))
                      <span class="org-string">"/"</span>)))
    (<span class="org-keyword">unless</span> (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>)
      (org-entry-put (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span> (concat <span class="org-string">"/"</span> path)))
    (<span class="org-keyword">unless</span> (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)
      (org-entry-put (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span> path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-rename-subtree</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((new-path (concat <span class="org-string">"blog/"</span> (format-time-string <span class="org-string">"%Y/%m/"</span>)
                          (my-make-slug (org-get-heading t t t t))
                          <span class="org-string">"/"</span>)))
    (<span class="org-keyword">when</span> (not (string= new-path (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)))
      (<span class="org-keyword">when</span>
          (file-exists-p (expand-file-name
                          (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)
                          my-11ty-base-dir))
        (rename-file (expand-file-name
                      (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)
                      my-11ty-base-dir)
                     (expand-file-name
                      new-path
                      my-11ty-base-dir)))
      (org-entry-put (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span> (concat <span class="org-string">"/"</span> path))
      (org-entry-put (point) <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span> path))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-11ty-convert-to-njk</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((filename (buffer-file-name))
         (old-buffer (current-buffer))
         (new-name (concat (file-name-base filename) <span class="org-string">".njk"</span>)))
    (save-buffer)
    (rename-file filename new-name)
    (find-file new-name)
    (kill-buffer old-buffer)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-11ty-browse-page</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>)
      (browse-url (concat <span class="org-string">"http://localhost:8080"</span> (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>)))
    (<span class="org-keyword">let*</span> ((json-object-type 'plist)
           (data (json-read-file (concat (file-name-base (buffer-file-name)) <span class="org-string">".11tydata.json"</span>))))
      (browse-url (concat <span class="org-string">"http://localhost:8080"</span> (plist-get data <span class="org-builtin">:permalink</span>))) )))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-pathname</span> ()
  (<span class="org-keyword">if</span> (derived-mode-p 'org-mode)
      (file-name-directory (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>))
    (<span class="org-keyword">let</span> ((url (thing-at-point 'url)))
      (<span class="org-keyword">when</span> url
        (url-file-directory (url-filename (url-generic-parse-url url)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-find-post</span> (url)
  (<span class="org-keyword">interactive</span> (list (my-org-11ty-pathname)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">check in posts.org</span>
  (find-file <span class="org-string">"~/sync/orgzly/posts.org"</span>)
  (<span class="org-keyword">let</span> ((pos (org-find-property <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span> url)))
    (<span class="org-keyword">when</span> pos (goto-char pos))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-find-file</span> (file)
  (<span class="org-keyword">interactive</span>
   (list
    (completing-read
     (<span class="org-keyword">if</span> (my-org-11ty-pathname)
         (format <span class="org-string">"Post (%s): "</span> (concat <span class="org-string">"/"</span> (my-org-11ty-pathname)))
       <span class="org-string">"Post: "</span>)
     (mapcar (<span class="org-keyword">lambda</span> (o) (replace-regexp-in-string <span class="org-string">"^~/proj/static-blog</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">index.html$"</span> <span class="org-string">""</span> o))
             (directory-files-recursively <span class="org-string">"~/proj/static-blog/blog"</span> <span class="org-string">"index\\.html"</span> nil))
     nil nil nil nil (concat <span class="org-string">"/"</span> (my-org-11ty-pathname)))))
  (find-file
   (expand-file-name
    <span class="org-string">"index.html"</span>
    (expand-file-name
     (concat <span class="org-string">"."</span> file)
     <span class="org-string">"~/proj/static-blog"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-post-to-mastodon</span> (<span class="org-type">&amp;optional</span> post-automatically)
  (<span class="org-keyword">interactive</span> (list current-prefix-arg))
  (<span class="org-keyword">let</span> ((message (concat (org-entry-get (point) <span class="org-string">"ITEM"</span>) <span class="org-string">" https://sachachua.com"</span> (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>))))
    (<span class="org-keyword">if</span> post-automatically
        (my-mastodon-toot-public-string message)
      (mastodon-toot)
      (insert message))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">https://kitchingroup.cheme.cmu.edu/blog/2013/05/05/Getting-keyword-options-in-org-files/</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-keywords</span> ()
  <span class="org-doc">"Parse the buffer and return a cons list of (property . value).</span>
<span class="org-doc">This is extracted from lines like:</span>
<span class="org-doc">#+PROPERTY: value"</span>
  (org-element-map (org-element-parse-buffer 'element) 'keyword
    (<span class="org-keyword">lambda</span> (keyword) (cons (org-element-property <span class="org-builtin">:key</span> keyword)
                            (org-element-property <span class="org-builtin">:value</span> keyword)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-11ty-copy-file-and-insert-into-org</span> (filename caption)
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"File: "</span>)
                     (read-string <span class="org-string">"Caption: "</span>)))
  (<span class="org-keyword">let</span> ((path (expand-file-name
               (file-name-nondirectory filename)
               (expand-file-name
                (org-entry-get-with-inheritance
                 <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)
                (assoc-default <span class="org-string">"ELEVENTY_BASE_DIR"</span> (my-org-keywords)))
               )))
    (copy-file filename path t)
    (insert <span class="org-string">"#+CAPTION: "</span> caption <span class="org-string">"\n"</span>
            (org-link-make-string (concat <span class="org-string">"file:"</span> path)) <span class="org-string">"\n"</span>)))


</pre>
</div>
</div>
<div id="outline-container-linking-to-blog-posts" class="outline-5">
<h5 id="linking-to-blog-posts">Linking to blog posts</h5>
<div class="outline-text-5" id="text-linking-to-blog-posts">
<div class="update" id="org0ff8622">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2024-01-19 Fri]</span></span>: added link description</li>
</ul>

</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-blog-complete</span> ()
  (concat <span class="org-string">"blog:"</span>
          (completing-read
           <span class="org-string">"Post: "</span>
           (mapcar (<span class="org-keyword">lambda</span> (o) (replace-regexp-in-string <span class="org-string">"^~/proj/static-blog</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">index.html$"</span> <span class="org-string">""</span> o))
                   (directory-files-recursively <span class="org-string">"~/proj/static-blog/blog"</span> <span class="org-string">"index\\.html"</span> nil)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-blog-export</span> (link desc format _)
  (<span class="org-keyword">let</span> ((path (concat <span class="org-string">"https://sachachua.com"</span> link)))
    (<span class="org-keyword">pcase</span> format
      ((<span class="org-keyword">or</span> 'html '11ty) (format <span class="org-string">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
      ('latex (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
      ('texinfo (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
      ('ascii (format <span class="org-string">"%s (%s)"</span> desc path)))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-blog-open</span> (link <span class="org-type">&amp;rest</span> _)
  <span class="org-doc">"Find the post if it exists, or open the HTML."</span>
  (find-file <span class="org-string">"~/sync/orgzly/posts.org"</span>)
  (<span class="org-keyword">let</span> ((pos (org-find-property <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span> link)))
    (<span class="org-keyword">if</span> pos (goto-char pos)
      (find-file (expand-file-name <span class="org-string">"index.html"</span> (expand-file-name (concat <span class="org-string">"."</span> link) <span class="org-string">"~/proj/static-blog"</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-link-insert-description</span> (link <span class="org-type">&amp;optional</span> description)
  (<span class="org-keyword">unless</span> description
    (my-page-title (my-org-link-as-url link))))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"blog"</span>
   <span class="org-builtin">:follow</span> #'my-org-blog-open
   <span class="org-builtin">:insert-description</span> #'my-org-link-insert-description
   <span class="org-builtin">:export</span> #'my-org-blog-export
   <span class="org-builtin">:complete</span> #'my-org-blog-complete))
</pre>
</div>
</div>
</div>
<div id="outline-container-embark-11ty" class="outline-5">
<h5 id="embark-11ty">embark-11ty&#xa0;&#xa0;&#xa0;<span class="tag"><span class="11ty">11ty</span>&#xa0;<span class="org">org</span>&#xa0;<span class="emacs">emacs</span>&#xa0;<span class="embark">embark</span></span></h5>
<div class="outline-text-5" id="text-embark-11ty">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-11ty-base-dir</span> <span class="org-string">"~/proj/static-blog/"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-11ty-find-org</span> (url)
  (<span class="org-keyword">interactive</span> (list (my-complete-blog-post-url)))
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"https://sachachua\\.com</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">/blog/.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> (my-org-link-as-url url))
    (<span class="org-keyword">let</span> ((path (match-string 1 url))
          pos)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">check my config</span>
      (<span class="org-keyword">catch</span> '<span class="org-constant">found</span>
        (<span class="org-keyword">dolist</span> (file '(<span class="org-string">"~/sync/emacs/Sacha.org"</span>
                        <span class="org-string">"~/sync/orgzly/posts.org"</span>))
          (<span class="org-keyword">with-current-buffer</span> (find-file-noselect file)
            (<span class="org-keyword">setq</span> pos (org-find-property <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span> path))
            (<span class="org-keyword">when</span> pos
              (switch-to-buffer (current-buffer))
              (goto-char pos)
              (<span class="org-keyword">throw</span> '<span class="org-constant">found</span> (buffer-file-name)))))
        (<span class="org-keyword">when</span> (file-exists-p
               (expand-file-name <span class="org-string">"index.org"</span>
                                 (concat my-11ty-base-dir path)))
          (find-file
           (expand-file-name <span class="org-string">"index.org"</span> (concat my-11ty-base-dir path)))
          (<span class="org-keyword">throw</span> '<span class="org-constant">found</span> (buffer-file-name)))))))
(<span class="org-keyword">with-eval-after-load</span> 'embark
  (define-key embark-url-map <span class="org-string">"v"</span> #'my-embark-11ty-find-org)
  (define-key embark-org-link-map <span class="org-string">"v"</span> #'my-embark-11ty-find-org))
</pre>
</div>
</div>
</div>
<div id="outline-container-moving-my-org-post-subtree-to-the-11ty-directory" class="outline-5">
<h5 id="moving-my-org-post-subtree-to-the-11ty-directory">Moving my Org post subtree to the 11ty directory&#xa0;&#xa0;&#xa0;<span class="tag"><span class="11ty">11ty</span>&#xa0;<span class="org">org</span>&#xa0;<span class="emacs">emacs</span>&#xa0;<span class="blogging">blogging</span></span></h5>
<div class="outline-text-5" id="text-moving-my-org-post-subtree-to-the-11ty-directory">
<p>
I sometimes want to move the Org source for my blog posts to the same
directory as the 11ty-exported HTML. This should make it easier to
update and reexport blog posts in the future. The following code
copies or moves the subtree to the 11ty export directory.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-copy-subtree</span> (<span class="org-type">&amp;optional</span> do-cut)
  <span class="org-doc">"Copy the subtree for the current post to the 11ty export directory.</span>
<span class="org-doc">With prefix arg, move the subtree."</span>
  (<span class="org-keyword">interactive</span> (list current-prefix-arg))
  (<span class="org-keyword">let*</span> ((file-properties
          (<span class="org-keyword">save-restriction</span>
            (<span class="org-keyword">save-excursion</span>
              (widen)
              (goto-char (point-min))
              (<span class="org-keyword">cl-loop</span> while (re-search-forward <span class="org-string">"^#\\+ELEVENTY.*"</span> nil t)
                       collect (match-string 0)))))
         (entry-properties (org-entry-properties))
         (filename (expand-file-name
                    <span class="org-string">"index.org"</span>
                    (expand-file-name
                     (assoc-default <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span> entry-properties)
                     (car (assoc-default <span class="org-string">"ELEVENTY_BASE_DIR"</span> file-properties))))))
    (<span class="org-keyword">unless</span> (file-directory-p (file-name-directory filename))
      (make-directory (file-name-directory filename) t))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">find the heading that sets the current EXPORT_ELEVENTY_FILE_NAME</span>
    (goto-char
     (org-find-property <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span> (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_FILE_NAME"</span>)))
    (org-copy-subtree 1 (<span class="org-keyword">if</span> do-cut 'cut))
    (<span class="org-keyword">with-temp-file</span> filename
      (org-mode)
      (insert (<span class="org-keyword">or</span>
               (string-join file-properties
                            <span class="org-string">"\n"</span>)
               <span class="org-string">""</span>)
              <span class="org-string">"\n"</span>)
      (org-yank))
    <span class="org-comment-delimiter">;</span><span class="org-comment">(find-file filename)</span>
    <span class="org-comment-delimiter">;</span><span class="org-comment">(goto-char (point-min))</span>
    ))
</pre>
</div>

<p>
Then this adds a link to it:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-export-filter-body-add-index-link</span> (info)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span>
         (plist-get info <span class="org-builtin">:file-name</span>)
         (plist-get info <span class="org-builtin">:base-dir</span>)
         (file-exists-p (expand-file-name
                         <span class="org-string">"index.org"</span>
                         (expand-file-name
                          (plist-get info <span class="org-builtin">:file-name</span>)
                          (plist-get info <span class="org-builtin">:base-dir</span>)))))
    (goto-char (point-max))
    (insert
     (format <span class="org-string">"&lt;div&gt;&lt;a href=\"%sindex.org\"&gt;View org source for this post&lt;/a&gt;&lt;/div&gt;"</span>
             (plist-get info <span class="org-builtin">:permalink</span>)))))

(<span class="org-keyword">with-eval-after-load</span> 'ox-11ty
  (add-to-list 'org-11ty-process-export-functions #'my-org-export-filter-body-add-index-link))
</pre>
</div>

<p>
Then I want to wrap the whole thing up in an export function:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-export</span> (<span class="org-type">&amp;optional</span> async subtreep visible-only body-only ext-plist)
  (<span class="org-keyword">let*</span> ((info (org-11ty--get-info subtreep visible-only))
         (file (org-11ty--base-file-name subtreep visible-only)))
    (<span class="org-keyword">unless</span> (string= (plist-get info <span class="org-builtin">:input-file</span>)
                     (expand-file-name
                      <span class="org-string">"index.org"</span>
                      (expand-file-name
                       (plist-get info <span class="org-builtin">:file-name</span>)
                       (plist-get info <span class="org-builtin">:base-dir</span>))))
      (<span class="org-keyword">save-window-excursion</span>
        (my-org-11ty-copy-subtree)))
    (org-11ty-export-to-11tydata-and-html async subtreep visible-only body-only ext-plist)
    <span class="org-comment-delimiter">;</span><span class="org-comment">(my-org-11ty-find-file)</span>
    ))
</pre>
</div>

<p>
Now to figure out how to override the export menu. Totally messy hack!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'ox-11ty
  (<span class="org-keyword">map-put</span> (caddr (org-export-backend-menu (org-export-get-backend '11ty)))
           ?1 (list <span class="org-string">"To Org, 11tydata.json, HTML"</span> 'my-org-11ty-export)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-cleaning-up-export" class="outline-4">
<h4 id="cleaning-up-export">Cleaning up export</h4>
<div class="outline-text-4" id="text-cleaning-up-export">
<p>
Timestamps and section numbers make my published files look more
complicated than they are. Let's turn them off by default, and let's use fancy HTML5.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org3a59ac7">(<span class="org-keyword">setq</span> org-html-doctype <span class="org-string">"html5"</span>)
(<span class="org-keyword">setq</span> org-html-html5-fancy t)
(<span class="org-keyword">setq</span> org-export-with-section-numbers nil)
(<span class="org-keyword">setq</span> org-html-include-timestamps nil)
(<span class="org-keyword">setq</span> org-export-with-sub-superscripts nil)
(<span class="org-keyword">setq</span> org-export-with-toc nil)
(<span class="org-keyword">setq</span> org-html-toplevel-hlevel 2)
(<span class="org-keyword">setq</span> org-export-htmlize-output-type 'css)
(<span class="org-keyword">setq</span> org-export-with-broken-links t)
(<span class="org-keyword">setq</span> org-ascii-text-width 10000)
(<span class="org-keyword">setq-default</span> tab-width 2)
</pre>
</div>

<p>
This makes it easier to publish my files:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-publish-project-alist
      '((<span class="org-string">"stream"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"~/proj/stream"</span>
         )
        (<span class="org-string">"emacs-config"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"~/.config/emacs"</span>
         <span class="org-builtin">:publishing-directory</span> <span class="org-string">"~/.config/emacs"</span>
         <span class="org-builtin">:publishing-function</span> my-org-html-publish-to-html-trustingly
         )
        (<span class="org-string">"book-notes"</span>
         <span class="org-builtin">:base-directory</span> <span class="org-string">"c:/sacha/Dropbox/books"</span>
         <span class="org-builtin">:publishing-directory</span> <span class="org-string">"c:/sacha/Dropbox/books/html"</span>
         <span class="org-builtin">:publishing-function</span> my-org-html-publish-to-html-trustingly
         <span class="org-builtin">:makeindex</span> t)))
<span class="org-comment-delimiter">;</span><span class="org-comment">(load "~/proj/dev/emacs-chats/build-site.el" t)</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">(load "~/proj/dev/emacs-notes/build-site.el" t)</span>
</pre>
</div>

<p>
If a file is in a publishing project, publish it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-publish-maybe</span> ()
  (<span class="org-keyword">require</span> '<span class="org-constant">ox-publish</span>)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">if</span> (org-publish-get-project-from-filename
         (buffer-file-name (buffer-base-buffer)) 'up)
        (org-publish-current-file t)
      (my-org-html-export-trustingly))))
</pre>
</div>

<p>
Make it easy to publish and browse a file.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-publish-and-browse</span> ()
  (<span class="org-keyword">interactive</span>)
  (save-buffer)
  (my-org-publish-maybe)
  (browse-url (org-export-output-file-name <span class="org-string">".html"</span> nil default-directory)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"&lt;apps&gt; b"</span> 'my-org-publish-and-browse)
</pre>
</div>
</div>
</div>
<div id="outline-container-publish-without-prompting" class="outline-4">
<h4 id="publish-without-prompting">Publish without prompting</h4>
<div class="outline-text-4" id="text-publish-without-prompting">
<p>
I want to be able to export without having to say yes to code blocks all the time.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-html-export-trustingly</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((org-confirm-babel-evaluate nil))
    (org-html-export-to-html)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-html-publish-to-html-trustingly</span> (plist filename pub-dir)
  (<span class="org-keyword">let</span> ((org-confirm-babel-evaluate nil))
    (org-html-publish-to-html plist filename pub-dir)))
</pre>
</div>
</div>
</div>
<div id="outline-container-special-blocks" class="outline-4">
<h4 id="special-blocks">Special blocks</h4>
<div class="outline-text-4" id="text-special-blocks">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orgbf5c65e">(<span class="org-keyword">use-package</span> org-special-block-extras
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:hook</span> (org-mode . org-special-block-extras-mode)
  <span class="org-builtin">:init</span> (<span class="org-keyword">setq</span> org-special-block-add-html-extra nil)
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Use short names like &#8216;</span><span class="org-comment"><span class="org-constant">defblock</span></span><span class="org-comment">&#8217; instead of the fully qualified name</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">&#8216;</span><span class="org-comment"><span class="org-constant">org-special-block-extras--defblock</span></span><span class="org-comment">&#8217;</span>
  (setcdr org-special-block-extras-mode-map nil)
  (org-defblock my_details (title <span class="org-string">"Details"</span> title-color <span class="org-string">"Green"</span>)
              <span class="org-string">"Top level (HTML &amp; 11ty)OSPE-RESPECT-NEWLINES? Enclose contents in a folded up box."</span>
              (<span class="org-keyword">cond</span>
               ((eq backend '11ty)
                (format
                 <span class="org-string">"{%% details \"%s\"%%}\n%s\n{%% enddetails %%}"</span>
                 title contents))
               ((eq backend 'html)
                (format
                 <span class="org-string">"&lt;details class=\"code-details\"</span>
<span class="org-string">                 style =\"padding: 1em;</span>
<span class="org-string">                          border-radius: 15px;</span>
<span class="org-string">                          font-size: 0.9em;</span>
<span class="org-string">                          box-shadow: 0.05em 0.1em 5px 0.01em  #00000057;\"&gt;</span>
<span class="org-string">                  &lt;summary&gt;</span>
<span class="org-string">                    &lt;strong&gt;</span>
<span class="org-string">                      &lt;font face=\"Courier\" size=\"3\" color=\"%s\"&gt;</span>
<span class="org-string">                         %s</span>
<span class="org-string">                      &lt;/font&gt;</span>
<span class="org-string">                    &lt;/strong&gt;</span>
<span class="org-string">                  &lt;/summary&gt;</span>
<span class="org-string">                  %s</span>
<span class="org-string">               &lt;/details&gt;"</span>
                 title-color title contents))))

  (org-defblock columns nil nil
              <span class="org-string">"Top level (HTML &amp; wp &amp; 11ty)OSPE-RESPECT-NEWLINES? Split into columns using Foundation."</span>
              (format <span class="org-string">"&lt;div class=\"row\"&gt;%s&lt;/div&gt;"</span> contents))
  (org-defblock column50 nil nil
              <span class="org-string">"Top level (HTML &amp; wp &amp; 11ty)OSPE-RESPECT-NEWLINES? Split into columns."</span>
              (format <span class="org-string">"&lt;div class=\"columns small-12 medium-6 large-6\"&gt;%s&lt;/div&gt;"</span> contents))
)

</pre>
</div>
</div>
</div>
<div id="outline-container-adding-a-custom-header-argument-to-org-mode-source-blocks-and-using-that-argument-during-export" class="outline-4">
<h4 id="adding-a-custom-header-argument-to-org-mode-source-blocks-and-using-that-argument-during-export">Adding a custom header argument to Org Mode source blocks and using that argument during export&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-adding-a-custom-header-argument-to-org-mode-source-blocks-and-using-that-argument-during-export">
<p>
I sometimes want to put long source blocks in a
<code>&lt;details&gt;&lt;summary&gt;...&lt;/summary&gt;...&lt;/details&gt;</code> block when I export to
HTML, so that they're tucked away in a collapsible block. I tried
using <code>https://github.com/alhassy/org-special-block-extras</code> to define
my own <code>#+begin_my_details "summary text" ... #+end_my_details</code> block,
but source blocks inside <code>my_details</code> doesn't get fontlocked properly
while in the Org file. I wanted to add a <code>:summary</code> attribute to the
regular src blocks, and to change the HTML export to wrap the code in
<code>details</code> if the summary was specified.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-babel-exp-code-template <span class="org-string">"#+begin_src %lang%switches%flags :summary %summary\n%body\n#+end_src"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-html-src-block</span> (src-block _contents info)
  (<span class="org-keyword">let*</span> ((result (org-html-src-block src-block _contents info))
         (block-info
          (<span class="org-keyword">org-with-point-at</span> (org-element-property <span class="org-builtin">:begin</span> src-block)
            (org-babel-get-src-block-info)))
         (summary (assoc-default <span class="org-builtin">:summary</span> (elt block-info 2))))
    (<span class="org-keyword">if</span> (member summary '(<span class="org-string">"%summary"</span> <span class="org-string">""</span>))
        result
      (format <span class="org-string">"&lt;details&gt;&lt;summary&gt;%s&lt;/summary&gt;%s&lt;/details&gt;"</span>
              summary
              result))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-11ty-src-block</span> (src-block _contents info)
  (<span class="org-keyword">let*</span> ((result (org-11ty-src-block src-block _contents info))
         (block-info
          (<span class="org-keyword">org-with-point-at</span> (org-element-property <span class="org-builtin">:begin</span> src-block)
            (org-babel-get-src-block-info)))
         (summary (assoc-default <span class="org-builtin">:summary</span> (elt block-info 2))))
    (<span class="org-keyword">if</span> (member summary '(<span class="org-string">"%summary"</span> <span class="org-string">""</span>))
        result
      (format <span class="org-string">"&lt;details&gt;&lt;summary&gt;%s&lt;/summary&gt;%s&lt;/details&gt;"</span>
              summary
              result))))

(<span class="org-keyword">with-eval-after-load</span> 'ox-html
  (map-put!
   (org-export-backend-transcoders (org-export-get-backend 'html))
   'src-block 'my-org-html-src-block))
(<span class="org-keyword">with-eval-after-load</span> 'ox-11ty
  (map-put!
   (org-export-backend-transcoders (org-export-get-backend '11ty))
   'src-block 'my-org-11ty-src-block))
</pre>
</div>

<p>
So now I can use it by specifying blocks like this:
</p>

<pre class="example" id="org9576ec4">
#+begin_src emacs-lisp :summary "Code for adding a :summary argument and using it during export"
;; code goes here
#+end_src
</pre>

<p>
It took me a bit of digging around to figure this out. When I added
the <code>:summary</code> attribute, <code>org-babel-get-src-block-info</code> found it when
I was in the Org file, but by the time <code>my-org-html-src-block</code> was
called, the block had been replaced with a copy that didn't have the
header argument. I dug around using edebug's <code>d</code> command for
displaying the backtrace, stepping through various functions. I found
out that in the process for exporting source code blocks,
<code>org-babel-exp-code</code> replaces the source block with the value of
<code>org-babel-exp-code-template</code>, substituting certain values. Adding the
<code>summary</code> flag to that and retrieving the summary information using
<code>org-babel-get-src-block-info</code> worked. I originally used <code>advice-add</code>
to override <code>org-html-src-block</code>, but I think I'll try replacing the
transcoder.
</p>

<p>
Adding custom header arguments could be useful for different
export-related tweaks (someone wanted to <a href="https://www.reddit.com/r/emacs/comments/fhac4x/how_can_i_create_a_custom_property_for_orgmode/">create an argument for
highlighting certain lines</a> but hadn't figured it out in that
thread). If there's a more elegant way to do this, I'd love to find
out!
</p>
</div>
</div>
<div id="outline-container-stylesheet-header" class="outline-4">
<h4 id="stylesheet-header">Stylesheet / header</h4>
<div class="outline-text-4" id="text-stylesheet-header">
<p>
Might as well take advantage of my stylesheet:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orgd040cb8">(<span class="org-keyword">setq</span> org-html-head <span class="org-string">"</span>
<span class="org-string">       &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://sachachua.com/assets/css/style.css\"&gt;&lt;/link&gt;</span>
<span class="org-string">       &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://sachachua.com/assets/css/org-export.css\"&gt;&lt;/link&gt;</span>
<span class="org-string">       &lt;script src=\"https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js\"&gt;&lt;/script&gt;</span>
<span class="org-string">       &lt;script src=\"https://sachachua.com/assets/js/misc.js\"&gt;&lt;/script&gt;"</span>)
(<span class="org-keyword">setq</span> org-html-htmlize-output-type 'css)
(<span class="org-keyword">setq</span> org-src-fontify-natively t)
</pre>
</div>
</div>
</div>
<div id="outline-container-footer" class="outline-4">
<h4 id="footer">Footer</h4>
<div class="outline-text-4" id="text-footer">
<p>
Make it easy to scroll to the top:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-preamble <span class="org-string">"&lt;a name=\"top\" id=\"top\"&gt;&lt;/a&gt;"</span>)
(<span class="org-keyword">setq</span> org-html-postamble <span class="org-string">"</span>
<span class="org-string">       &lt;style type=\"text/css\"&gt;</span>
<span class="org-string">       .back-to-top {</span>
<span class="org-string">           position: fixed;</span>
<span class="org-string">           bottom: 2em;</span>
<span class="org-string">           right: 0px;</span>
<span class="org-string">           text-decoration: none;</span>
<span class="org-string">           color: #000000;</span>
<span class="org-string">           background-color: rgba(235, 235, 235, 0.80);</span>
<span class="org-string">           font-size: 12px;</span>
<span class="org-string">           padding: 1em;</span>
<span class="org-string">           display: none;</span>
<span class="org-string">       }</span>

<span class="org-string">       .back-to-top:hover {</span>
<span class="org-string">           background-color: rgba(135, 135, 135, 0.50);</span>
<span class="org-string">       }</span>
<span class="org-string">       &lt;/style&gt;</span>

<span class="org-string">       &lt;div class=\"back-to-top\"&gt;</span>
<span class="org-string">       &lt;a href=\"#top\"&gt;Back to top&lt;/a&gt; | &lt;a href=\"mailto:sacha@sachachua.com\"&gt;E-mail me&lt;/a&gt;</span>
<span class="org-string">       &lt;/div&gt;</span>

<span class="org-string">       &lt;script type=\"text/javascript\"&gt;</span>
<span class="org-string">           var offset = 220;</span>
<span class="org-string">           var duration = 500;</span>
<span class="org-string">           jQuery(window).scroll(function() {</span>
<span class="org-string">               if (jQuery(this).scrollTop() &gt; offset) {</span>
<span class="org-string">                   jQuery('</span><span class="org-string"><span class="org-constant">.back-to-top</span></span><span class="org-string">').fadeIn(duration);</span>
<span class="org-string">               } else {</span>
<span class="org-string">                   jQuery('</span><span class="org-string"><span class="org-constant">.back-to-top</span></span><span class="org-string">').fadeOut(duration);</span>
<span class="org-string">               }</span>
<span class="org-string">           });</span>
<span class="org-string">       &lt;/script&gt;"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-copy-region" class="outline-4">
<h4 id="copy-region">Copy region</h4>
<div class="outline-text-4" id="text-copy-region">
<p>
Sometimes I want a region's HTML in my kill-ring/clipboard without any of the extra fluff:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-copy-region-as-html</span> (beg end <span class="org-type">&amp;optional</span> level)
  <span class="org-doc">"Make it easier to copy code for Wordpress posts and other things."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r\np"</span>)
  (<span class="org-keyword">let</span> ((org-export-html-preamble nil)
        (org-html-toplevel-hlevel (<span class="org-keyword">or</span> level 3)))
    (kill-new
     (org-export-string-as (buffer-substring beg end) 'html t))))
</pre>
</div>

<p>
Sometimes I want a subtree:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-copy-subtree-as-html</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-org-copy-region-as-html
   (org-back-to-heading)
   (org-end-of-subtree)))
</pre>
</div>
</div>
</div>
<div id="outline-container-utf-8-checkboxes" class="outline-4">
<h4 id="utf-8-checkboxes">UTF-8 checkboxes</h4>
<div class="outline-text-4" id="text-utf-8-checkboxes">
<p>
This snippet turns <code>- [X]</code> into ☑ and <code>- [ ]</code> into ☐, but leaves <code>[-]</code> alone.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-html-checkbox-type 'unicode)
(<span class="org-keyword">setq</span> org-html-checkbox-types
      '((unicode (on . <span class="org-string">"&lt;span class=\"task-done\"&gt;&amp;#x2611;&lt;/span&gt;"</span>)
                 (off . <span class="org-string">"&lt;span class=\"task-todo\"&gt;&amp;#x2610;&lt;/span&gt;"</span>)
                 (trans . <span class="org-string">"&lt;span class=\"task-in-progress\"&gt;[-]&lt;/span&gt;"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-share-my-emacs-configuration" class="outline-4">
<h4 id="share-my-emacs-configuration">Share my Emacs configuration</h4>
<div class="outline-text-4" id="text-share-my-emacs-configuration">
<p>
This code gets around the fact that my config is called Sacha.org, but
I want it to export as sacha-emacs.org in my Dropbox's public
directory. Although now that I'm shifting to Github Pages, maybe I
don't need this any more&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-share-emacs</span> ()
  <span class="org-doc">"Share my Emacs configuration."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((destination-dir <span class="org-string">"~/Dropbox/Public/"</span>)
         (destination-filename <span class="org-string">"sacha-emacs.org"</span>))
    (my-save-new-packages)
    (<span class="org-keyword">with-current-buffer</span> (find-file <span class="org-string">"~/.config/emacs/Sacha.org"</span>)
      (<span class="org-keyword">save-restriction</span>
        (<span class="org-keyword">save-excursion</span>
          (widen)
          (write-region (point-min) (point-max)
                        (expand-file-name destination-filename destination-dir))
          (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (expand-file-name
                                                    destination-filename destination-dir))
            (org-babel-tangle-file buffer-file-name
                                   (expand-file-name
                                    <span class="org-string">"sacha-emacs.el"</span> destination-dir) <span class="org-string"><span class="org-warning">"emacs-lisp"</span></span><span class="org-warning">)</span>
            (org-html-export-to-html)))))))
</pre>
</div>
</div>
<div id="outline-container-remembering-to-set-custom-ids-for-this-file" class="outline-5">
<h5 id="remembering-to-set-custom-ids-for-this-file">Remembering to set custom IDs for this file</h5>
<div class="outline-text-5" id="text-remembering-to-set-custom-ids-for-this-file">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-assign-custom-ids</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((custom-ids
         (org-map-entries (<span class="org-keyword">lambda</span> () (org-entry-get (point) <span class="org-string">"CUSTOM_ID"</span>)) <span class="org-string">"CUSTOM_ID={.}"</span>)))
    (org-map-entries
     (<span class="org-keyword">lambda</span> ()
       (<span class="org-keyword">let</span> ((slug
              (replace-regexp-in-string
               <span class="org-string">"^-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">-$"</span> <span class="org-string">""</span>
               (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">A-Za-z0-9]+"</span> <span class="org-string">"-"</span>
                                         (downcase (string-join (org-get-outline-path t) <span class="org-string">" "</span>))))))
         (<span class="org-keyword">while</span> (member slug custom-ids)
           (<span class="org-keyword">setq</span> slug (read-string <span class="org-string">"Manually set custom ID: "</span>)))
         (org-entry-put (point) <span class="org-string">"CUSTOM_ID"</span> slug)))
     <span class="org-string">"-CUSTOM_ID={.}"</span>)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-beamer" class="outline-4">
<h4 id="beamer">Beamer</h4>
<div class="outline-text-4" id="text-beamer">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">require</span> '<span class="org-constant">ox-latex</span>)
  (add-to-list 'org-latex-classes
               '(<span class="org-string">"beamer"</span>
                 <span class="org-string">"\\documentclass</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">[presentation</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">]</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{beamer</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>
                 (<span class="org-string">"\\section</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\section*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsubsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsubsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)))
  (add-to-list 'org-latex-classes
               '(<span class="org-string">"memoir"</span>
                 <span class="org-string">"\\documentclass</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{memoir</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>
                 (<span class="org-string">"\\section</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\section*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>)
                 (<span class="org-string">"\\subsubsection</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span> . <span class="org-string">"\\subsubsection*</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">{%s</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">}"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-plantuml" class="outline-4">
<h4 id="plantuml">PlantUML</h4>
<div class="outline-text-4" id="text-plantuml">
<div class="org-src-container">
<pre class="src src-emacs-lisp">     (<span class="org-keyword">setq</span> org-plantuml-jar-path (expand-file-name <span class="org-string">"/usr/share/plantuml/plantuml.jar"</span>))
(add-to-list 'org-src-lang-modes '(<span class="org-string">"plantuml"</span> . plantuml))
</pre>
</div>
</div>
</div>
<div id="outline-container-ox-hugo" class="outline-4">
<h4 id="ox-hugo">ox-hugo</h4>
<div class="outline-text-4" id="text-ox-hugo">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ox-hugo
  <span class="org-builtin">:ensure</span> t            <span class="org-comment-delimiter">;</span><span class="org-comment">Auto-install the package from Melpa (optional)</span>
  <span class="org-builtin">:after</span> ox)
</pre>
</div>
</div>
</div>
<div id="outline-container-org-async-export-and-tangle" class="outline-4">
<h4 id="org-async-export-and-tangle">Org Mode: Asynchronous export and tangle of a large file&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span></span></h4>
<div class="outline-text-4" id="text-org-async-export-and-tangle">
<p>
I have a pretty large <a href="https://sachachua.com/dotemacs">Emacs configuration file</a>. It's annoying to wait
11 seconds for it to export to HTML or 12 seconds to tangle.
Fortunately, Org Mode allows me to export asynchronously. I tried it
out from <code>org-export-dispatch</code> (<code>C-c C-e</code>) by using the <code>C-a</code> option.
It worked pretty well, but it was a bit slow because it loaded my full
configuration. Fortunately, there's a way to use a smaller
configuration that focuses on just the packages needed.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org1ceaed5">(<span class="org-keyword">setq</span> org-export-async-init-file <span class="org-string">"~/.config/emacs/org-async-export-config.el"</span>)
(<span class="org-keyword">setq</span> org-export-async-debug t)
</pre>
</div>

<p>
I've named the source blocks, and this block assembles the config from
those named blocks by using noweb.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">&lt;&lt;org-async-variables&gt;&gt;
&lt;&lt;startup&gt;&gt;
&lt;&lt;system-info&gt;&gt;
&lt;&lt;package-setup&gt;&gt;
&lt;&lt;org-babel-default-header-args&gt;&gt;
&lt;&lt;org-styles&gt;&gt;
&lt;&lt;org-special-blocks&gt;&gt;
&lt;&lt;org-clean-up-export&gt;&gt;
</pre>
</div>

<p>
This is what the code looks like when it's expanded:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-export-async-init-file <span class="org-string">"~/.config/emacs/org-async-export-config.el"</span>)
(<span class="org-keyword">setq</span> org-export-async-debug t)
<span class="org-comment-delimiter">;; </span><span class="org-comment">-*- lexical-binding: t -*-</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">This sets up the load path so that we can override it</span>
(<span class="org-keyword">setq</span> warning-suppress-log-types '((package reinitialization)))  (package-initialize)
(add-to-list 'load-path <span class="org-string">"/usr/local/share/emacs/site-lisp"</span>)
(add-to-list 'load-path <span class="org-string">"~/vendor/org-mode/lisp"</span>)
(add-to-list 'load-path <span class="org-string">"~/vendor/org-mode/contrib/lisp"</span>)
(<span class="org-keyword">setq</span> custom-file <span class="org-string">"~/.config/emacs/custom-settings.el"</span>)
(<span class="org-keyword">setq</span> use-package-always-ensure t)
(load custom-file t)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-laptop-p</span> (<span class="org-keyword">or</span> (equal (system-name) <span class="org-string">"sacha-x230"</span>) (equal (system-name) <span class="org-string">"sacha-p52"</span>)))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-server-p</span> (<span class="org-keyword">and</span> (equal (system-name) <span class="org-string">"localhost"</span>) (equal user-login-name <span class="org-string">"sacha"</span>)))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-phone-p</span> (not (null (getenv <span class="org-string">"ANDROID_ROOT"</span>)))
  <span class="org-doc">"If non-nil, GNU Emacs is running on Termux."</span>)
(<span class="org-keyword">when</span> my-phone-p (<span class="org-keyword">setq</span> gnutls-algorithm-priority <span class="org-string">"NORMAL:-VERS-TLS1.3"</span>))
(global-auto-revert-mode)  <span class="org-comment-delimiter">; </span><span class="org-comment">simplifies syncing</span>
(add-to-list 'load-path <span class="org-string">"~/elisp"</span>)
(<span class="org-keyword">setq</span> use-package-verbose t)
(<span class="org-keyword">setq</span> use-package-always-ensure t)
(<span class="org-keyword">require</span> '<span class="org-constant">use-package</span>)
(<span class="org-keyword">use-package</span> quelpa)
(<span class="org-keyword">use-package</span> quelpa-use-package)
(quelpa-use-package-activate-advice)
(<span class="org-keyword">setq</span> load-prefer-newer t)
(<span class="org-keyword">setq</span> org-babel-default-header-args
      '((<span class="org-builtin">:session</span> . <span class="org-string">"none"</span>)
        (<span class="org-builtin">:results</span> . <span class="org-string">"drawer replace"</span>)
        (<span class="org-builtin">:comments</span> . <span class="org-string">"both"</span>)
        (<span class="org-builtin">:exports</span> . <span class="org-string">"code"</span>)
        (<span class="org-builtin">:cache</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:eval</span> . <span class="org-string">"never-export"</span>)
        (<span class="org-builtin">:hlines</span> . <span class="org-string">"no"</span>)
        (<span class="org-builtin">:tangle</span> . <span class="org-string">"no"</span>)))
(<span class="org-keyword">setq</span> org-edit-src-auto-save-idle-delay 5)
(<span class="org-keyword">setq</span> org-html-head <span class="org-string">"</span>
<span class="org-string">       &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://sachachua.com/assets/css/style.css\"&gt;&lt;/link&gt;</span>
<span class="org-string">       &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"https://sachachua.com/assets/css/org-export.css\"&gt;&lt;/link&gt;</span>
<span class="org-string">       &lt;script src=\"https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js\"&gt;&lt;/script&gt;</span>
<span class="org-string">       &lt;script src=\"https://sachachua.com/assets/js/misc.js\"&gt;&lt;/script&gt;"</span>)
(<span class="org-keyword">setq</span> org-html-htmlize-output-type 'css)
(<span class="org-keyword">setq</span> org-src-fontify-natively t)
(<span class="org-keyword">use-package</span> org-special-block-extras
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:hook</span> (org-mode . org-special-block-extras-mode)
  <span class="org-builtin">:init</span> (<span class="org-keyword">setq</span> org-special-block-add-html-extra nil)
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Use short names like &#8216;</span><span class="org-comment"><span class="org-constant">defblock</span></span><span class="org-comment">&#8217; instead of the fully qualified name</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">&#8216;</span><span class="org-comment"><span class="org-constant">org-special-block-extras--defblock</span></span><span class="org-comment">&#8217;</span>
  (setcdr org-special-block-extras-mode-map nil)
  (org-defblock my_details (title <span class="org-string">"Details"</span> title-color <span class="org-string">"Green"</span>)
              <span class="org-string">"Top level (HTML &amp; 11ty)OSPE-RESPECT-NEWLINES? Enclose contents in a folded up box."</span>
              (<span class="org-keyword">cond</span>
               ((eq backend '11ty)
                (format
                 <span class="org-string">"{%% details \"%s\"%%}\n%s\n{%% enddetails %%}"</span>
                 title contents))
               ((eq backend 'html)
                (format
                 <span class="org-string">"&lt;details class=\"code-details\"</span>
<span class="org-string">                 style =\"padding: 1em;</span>
<span class="org-string">                          border-radius: 15px;</span>
<span class="org-string">                          font-size: 0.9em;</span>
<span class="org-string">                          box-shadow: 0.05em 0.1em 5px 0.01em  #00000057;\"&gt;</span>
<span class="org-string">                  &lt;summary&gt;</span>
<span class="org-string">                    &lt;strong&gt;</span>
<span class="org-string">                      &lt;font face=\"Courier\" size=\"3\" color=\"%s\"&gt;</span>
<span class="org-string">                         %s</span>
<span class="org-string">                      &lt;/font&gt;</span>
<span class="org-string">                    &lt;/strong&gt;</span>
<span class="org-string">                  &lt;/summary&gt;</span>
<span class="org-string">                  %s</span>
<span class="org-string">               &lt;/details&gt;"</span>
                 title-color title contents))))

  (org-defblock columns nil nil
              <span class="org-string">"Top level (HTML &amp; wp &amp; 11ty)OSPE-RESPECT-NEWLINES? Split into columns using Foundation."</span>
              (format <span class="org-string">"&lt;div class=\"row\"&gt;%s&lt;/div&gt;"</span> contents))
  (org-defblock column50 nil nil
              <span class="org-string">"Top level (HTML &amp; wp &amp; 11ty)OSPE-RESPECT-NEWLINES? Split into columns."</span>
              (format <span class="org-string">"&lt;div class=\"columns small-12 medium-6 large-6\"&gt;%s&lt;/div&gt;"</span> contents))
)

(<span class="org-keyword">setq</span> org-html-doctype <span class="org-string">"html5"</span>)
(<span class="org-keyword">setq</span> org-html-html5-fancy t)
(<span class="org-keyword">setq</span> org-export-with-section-numbers nil)
(<span class="org-keyword">setq</span> org-html-include-timestamps nil)
(<span class="org-keyword">setq</span> org-export-with-sub-superscripts nil)
(<span class="org-keyword">setq</span> org-export-with-toc nil)
(<span class="org-keyword">setq</span> org-html-toplevel-hlevel 2)
(<span class="org-keyword">setq</span> org-export-htmlize-output-type 'css)
(<span class="org-keyword">setq</span> org-export-with-broken-links t)
(<span class="org-keyword">setq</span> org-ascii-text-width 10000)
(<span class="org-keyword">setq-default</span> tab-width 2)
</pre>
</div>

<p>
I want my config file to be tangled and exported
to HTML regularly so that I don't forget to do so.
The following code exports my config, but only if
I saved it myself instead of when I auto-save it
by focusing away from Emacs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-org-debounce-idle-timer</span> (seconds var body <span class="org-type">&amp;rest</span> args)
  `(<span class="org-keyword">progn</span>
     (<span class="org-keyword">defvar</span> ,var nil <span class="org-doc">"Timer."</span>)
     (<span class="org-keyword">when</span> (timerp ,var) (cancel-timer ,var))
     (<span class="org-keyword">setq</span> ,var (run-with-idle-timer ,seconds nil ,body ,@args))))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-unfocusing</span> nil <span class="org-doc">"Non-nil when I'm in the middle of unfocusing."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-async-export-and-tangle</span> ()
  (async-start
   `(<span class="org-keyword">lambda</span> ()
      <span class="org-comment-delimiter">;; </span><span class="org-comment">make async emacs aware of packages (for byte-compilation)</span>
      (package-initialize)
      (<span class="org-keyword">setq</span> package-enable-at-startup nil)
      (<span class="org-keyword">require</span> '<span class="org-constant">org</span>)
      (<span class="org-keyword">setq-default</span> tab-width 2)
      (<span class="org-keyword">setq</span> org-babel-default-header-args
            '((<span class="org-builtin">:session</span> . <span class="org-string">"none"</span>)
              (<span class="org-builtin">:results</span> . <span class="org-string">"drawer replace"</span>)
              (<span class="org-builtin">:comments</span> . <span class="org-string">"both"</span>)
              (<span class="org-builtin">:exports</span> . <span class="org-string">"code"</span>)
              (<span class="org-builtin">:cache</span> . <span class="org-string">"no"</span>)
              (<span class="org-builtin">:eval</span> . <span class="org-string">"never-export"</span>)
              (<span class="org-builtin">:hlines</span> . <span class="org-string">"no"</span>)
              (<span class="org-builtin">:tangle</span> . <span class="org-string">"no"</span>)))
      (<span class="org-keyword">setq</span> org-edit-src-auto-save-idle-delay 5)
      (org-babel-tangle-file ,(buffer-file-name))
      )
   (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> results) (message <span class="org-string">"Tangled."</span>)))
  (org-html-export-to-html t))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-export-and-tangle-if-saved-in-focus</span> ()
  (<span class="org-keyword">when</span> (frame-focus-state)
    (message <span class="org-string">"Scheduling export..."</span>)
    (my-org-debounce-idle-timer
     10
     my-export-org-config
     (<span class="org-keyword">lambda</span> (buf)
       (<span class="org-keyword">with-current-buffer</span> buf
         (my-org-async-export-and-tangle)))
     (current-buffer))))
(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">my-org-export-and-tangle-when-saved-in-focus-mode</span>
  <span class="org-doc">"Toggle a mode for exporting and tangling when saved.</span>
<span class="org-doc">Interactively with no argument, this command toggles the mode.</span>
<span class="org-doc">A positive prefix argument enables the mode, any other prefix</span>
<span class="org-doc">argument disables it.  From Lisp, argument omitted or nil enables</span>
<span class="org-doc">the mode, `</span><span class="org-doc"><span class="org-constant">toggle</span></span><span class="org-doc">' toggles the state."</span>
  <span class="org-builtin">:group</span> 'my
  (<span class="org-keyword">if</span> my-org-export-and-tangle-when-saved-in-focus-mode
      (add-hook 'after-save-hook #'my-org-export-and-tangle-if-saved-in-focus nil t)
    (remove-hook 'after-save-hook #'my-org-export-and-tangle-if-saved-in-focus t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-save-and-tangle-my-config</span> ()
  (<span class="org-keyword">when</span> (string= (buffer-file-name) (expand-file-name <span class="org-string">"~/sync/emacs/Sacha.org"</span>)) (my-org-export-and-tangle-when-saved-in-focus-mode 1)))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:hook</span> ((org-mode . my-org-save-and-tangle-my-config)))
</pre>
</div>

<p>
Let's see if this makes it easier for me to tweak things.
</p>
</div>
</div>
<div id="outline-container-pdf" class="outline-4">
<h4 id="pdf">PDF</h4>
<div class="outline-text-4" id="text-pdf">
<p>
<a href="https://so.nwalsh.com/2020/01/05-latex">https://so.nwalsh.com/2020/01/05-latex</a> , but I use letter paper instead of A4.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-latex-compiler <span class="org-string">"xelatex"</span>)
(<span class="org-keyword">setq</span> org-latex-pdf-process
      (list (concat <span class="org-string">"latexmk -"</span>
                    org-latex-compiler
                    <span class="org-string">" -recorder -synctex=1 -bibtex-cond %b"</span>)))
(<span class="org-keyword">setq</span> org-latex-default-packages-alist
      '((<span class="org-string">""</span> <span class="org-string">"graphicx"</span> t)
        (<span class="org-string">""</span> <span class="org-string">"grffile"</span> t)
        (<span class="org-string">""</span> <span class="org-string">"longtable"</span> nil)
        (<span class="org-string">""</span> <span class="org-string">"wrapfig"</span> nil)
        (<span class="org-string">""</span> <span class="org-string">"rotating"</span> nil)
        (<span class="org-string">"normalem"</span> <span class="org-string">"ulem"</span> t)
        (<span class="org-string">""</span> <span class="org-string">"amsmath"</span> t)
        (<span class="org-string">""</span> <span class="org-string">"textcomp"</span> t)
        (<span class="org-string">""</span> <span class="org-string">"amssymb"</span> t)
        (<span class="org-string">""</span> <span class="org-string">"capt-of"</span> nil)
        (<span class="org-string">""</span> <span class="org-string">"hyperref"</span> nil)))
(<span class="org-keyword">setq</span> org-latex-classes
'((<span class="org-string">"article"</span>
<span class="org-string">"\\RequirePackage{fix-cm}</span>
<span class="org-string">\\PassOptionsToPackage{svgnames}{xcolor}</span>
<span class="org-string">\\documentclass[11pt]{article}</span>
<span class="org-string">\\usepackage{fontspec}</span>
<span class="org-string">\\setmainfont{Noto Sans}</span>
<span class="org-string">\\setsansfont[Scale=MatchLowercase]{Noto Sans}</span>
<span class="org-string">\\setmonofont[Scale=MatchLowercase]{Hack}</span>
<span class="org-string">\\usepackage{sectsty}</span>
<span class="org-string">\\allsectionsfont{\\sffamily}</span>
<span class="org-string">\\usepackage{enumitem}</span>
<span class="org-string">\\setlist[description]{style=unboxed,font=\\sffamily\\bfseries}</span>
<span class="org-string">\\usepackage{listings}</span>
<span class="org-string">\\lstset{frame=single,aboveskip=1em,</span>
<span class="org-string">  framesep=.5em,backgroundcolor=\\color{AliceBlue},</span>
<span class="org-string">  rulecolor=\\color{LightSteelBlue},framerule=1pt}</span>
<span class="org-string">\\usepackage{xcolor}</span>
<span class="org-string">\\newcommand\\basicdefault[1]{\\scriptsize\\color{Black}\\ttfamily#1}</span>
<span class="org-string">\\lstset{basicstyle=\\basicdefault{\\spaceskip1em}}</span>
<span class="org-string">\\lstset{literate=</span>
<span class="org-string">      {&#167;}{{\\S}}1</span>
<span class="org-string">      {&#169;}{{\\raisebox{.125ex}{\\copyright}\\enspace}}1</span>
<span class="org-string">      {&#171;}{{\\guillemotleft}}1</span>
<span class="org-string">      {&#187;}{{\\guillemotright}}1</span>
<span class="org-string">      {&#193;}{{\\'A}}1</span>
<span class="org-string">      {&#196;}{{\\\"A}}1</span>
<span class="org-string">      {&#201;}{{\\'E}}1</span>
<span class="org-string">      {&#205;}{{\\'I}}1</span>
<span class="org-string">      {&#211;}{{\\'O}}1</span>
<span class="org-string">      {&#214;}{{\\\"O}}1</span>
<span class="org-string">      {&#218;}{{\\'U}}1</span>
<span class="org-string">      {&#220;}{{\\\"U}}1</span>
<span class="org-string">      {&#223;}{{\\ss}}2</span>
<span class="org-string">      {&#224;}{{\\`a}}1</span>
<span class="org-string">      {&#225;}{{\\'a}}1</span>
<span class="org-string">      {&#228;}{{\\\"a}}1</span>
<span class="org-string">      {&#233;}{{\\'e}}1</span>
<span class="org-string">      {&#237;}{{\\'i}}1</span>
<span class="org-string">      {&#243;}{{\\'o}}1</span>
<span class="org-string">      {&#246;}{{\\\"o}}1</span>
<span class="org-string">      {&#250;}{{\\'u}}1</span>
<span class="org-string">      {&#252;}{{\\\"u}}1</span>
<span class="org-string">      {&#185;}{{\\textsuperscript1}}1</span>
<span class="org-string">            {&#178;}{{\\textsuperscript2}}1</span>
<span class="org-string">            {&#179;}{{\\textsuperscript3}}1</span>
<span class="org-string">      {&#305;}{{\\i}}1</span>
<span class="org-string">      {&#8212;}{{---}}1</span>
<span class="org-string">      {&#8217;}{{'}}1</span>
<span class="org-string">      {&#8230;}{{\\dots}}1</span>
<span class="org-string">            {&#11168;}{{$\\hookleftarrow$}}1</span>
<span class="org-string">      {&#9251;}{{\\textvisiblespace}}1,</span>
<span class="org-string">      keywordstyle=\\color{DarkGreen}\\bfseries,</span>
<span class="org-string">      identifierstyle=\\color{DarkRed},</span>
<span class="org-string">      commentstyle=\\color{Gray}\\upshape,</span>
<span class="org-string">      stringstyle=\\color{DarkBlue}\\upshape,</span>
<span class="org-string">      emphstyle=\\color{Chocolate}\\upshape,</span>
<span class="org-string">      showstringspaces=false,</span>
<span class="org-string">      columns=fullflexible,</span>
<span class="org-string">      keepspaces=true}</span>
<span class="org-string">\\usepackage[margin=1in,left=1.5in]{geometry}</span>
<span class="org-string">\\usepackage{parskip}</span>
<span class="org-string">\\makeatletter</span>
<span class="org-string">\\renewcommand{\\maketitle}{%</span>
<span class="org-string">  \\begingroup\\parindent0pt</span>
<span class="org-string">  \\sffamily</span>
<span class="org-string">  \\Huge{\\bfseries\\@title}\\par\\bigskip</span>
<span class="org-string">  \\LARGE{\\bfseries\\@author}\\par\\medskip</span>
<span class="org-string">  \\normalsize\\@date\\par\\bigskip</span>
<span class="org-string">  \\endgroup\\@afterindentfalse\\@afterheading}</span>
<span class="org-string">\\makeatother</span>
<span class="org-string">[DEFAULT-PACKAGES]</span>
<span class="org-string">\\hypersetup{linkcolor=Blue,urlcolor=DarkBlue,</span>
<span class="org-string">  citecolor=DarkRed,colorlinks=true}</span>
<span class="org-string">\\AtBeginDocument{\\renewcommand{\\UrlFont}{\\ttfamily}}</span>
<span class="org-string">[PACKAGES]</span>
<span class="org-string">[EXTRA]"</span>
(<span class="org-string">"\\section{%s}"</span> . <span class="org-string">"\\section*{%s}"</span>)
(<span class="org-string">"\\subsection{%s}"</span> . <span class="org-string">"\\subsection*{%s}"</span>)
(<span class="org-string">"\\subsubsection{%s}"</span> . <span class="org-string">"\\subsubsection*{%s}"</span>)
(<span class="org-string">"\\paragraph{%s}"</span> . <span class="org-string">"\\paragraph*{%s}"</span>)
(<span class="org-string">"\\subparagraph{%s}"</span> . <span class="org-string">"\\subparagraph*{%s}"</span>))

(<span class="org-string">"report"</span> <span class="org-string">"\\documentclass[11pt]{report}"</span>
(<span class="org-string">"\\part{%s}"</span> . <span class="org-string">"\\part*{%s}"</span>)
(<span class="org-string">"\\chapter{%s}"</span> . <span class="org-string">"\\chapter*{%s}"</span>)
(<span class="org-string">"\\section{%s}"</span> . <span class="org-string">"\\section*{%s}"</span>)
(<span class="org-string">"\\subsection{%s}"</span> . <span class="org-string">"\\subsection*{%s}"</span>)
(<span class="org-string">"\\subsubsection{%s}"</span> . <span class="org-string">"\\subsubsection*{%s}"</span>))

(<span class="org-string">"book"</span> <span class="org-string">"\\documentclass[11pt]{book}"</span>
(<span class="org-string">"\\part{%s}"</span> . <span class="org-string">"\\part*{%s}"</span>)
(<span class="org-string">"\\chapter{%s}"</span> . <span class="org-string">"\\chapter*{%s}"</span>)
(<span class="org-string">"\\section{%s}"</span> . <span class="org-string">"\\section*{%s}"</span>)
(<span class="org-string">"\\subsection{%s}"</span> . <span class="org-string">"\\subsection*{%s}"</span>)
(<span class="org-string">"\\subsubsection{%s}"</span> . <span class="org-string">"\\subsubsection*{%s}"</span>))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org-roam" class="outline-3">
<h3 id="org-roam">Org roam</h3>
<div class="outline-text-3" id="text-org-roam">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org-roam
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:hook</span>
  (after-init . org-roam-mode)
  <span class="org-builtin">:custom</span>
  (org-roam-directory <span class="org-string">"/home/sacha/sync/org-roam"</span>)
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> org-roam-mode-map
          ((<span class="org-string">"C-c n l"</span> . org-roam)
           (<span class="org-string">"C-c n f"</span> . org-roam-find-file)
           (<span class="org-string">"C-c n g"</span> . org-roam-graph))
          <span class="org-builtin">:map</span> org-mode-map
          ((<span class="org-string">"C-c n i"</span> . org-roam-insert))
          ((<span class="org-string">"C-c n I"</span> . org-roam-insert-immediate))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-links" class="outline-3">
<h3 id="org-links">Links</h3>
<div class="outline-text-3" id="text-org-links">
</div>
<div id="outline-container-ids" class="outline-4">
<h4 id="ids">IDs</h4>
<div class="outline-text-4" id="text-ids">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-id-method 'ts)
(<span class="org-keyword">setq</span> org-id-link-to-org-use-id 'create-if-interactive-and-no-custom-id)
</pre>
</div>
</div>
</div>
<div id="outline-container-quick-links" class="outline-4">
<h4 id="quick-links">Quick links</h4>
<div class="outline-text-4" id="text-quick-links">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-link-abbrev-alist
      '((<span class="org-string">"google"</span> . <span class="org-string">"http://www.google.com/search?q="</span>)
        (<span class="org-string">"gmap"</span> . <span class="org-string">"http://maps.google.com/maps?q=%s"</span>)
        ))
</pre>
</div>
</div>
</div>
<div id="outline-container-custom-links" class="outline-4">
<h4 id="custom-links">Tag links</h4>
<div class="outline-text-4" id="text-custom-links">
<p>
From <a href="http://endlessparentheses.com/use-org-mode-links-for-absolutely-anything.html?source=rss">http://endlessparentheses.com/use-org-mode-links-for-absolutely-anything.html?source=rss</a>
</p>

<blockquote>
<p>
(org-add-link-type
"tag" 'endless/follow-tag-link)
</p>

<p>
(defun endless/follow-tag-link (tag)
"Display a list of TODO headlines with tag TAG.
With prefix argument, also display headlines without a TODO keyword."
(org-tags-view (null current-prefix-arg) tag))
</p>
</blockquote>
</div>
</div>
<div id="outline-container-links-to-my-config" class="outline-4">
<h4 id="links-to-my-config">Links to my config</h4>
<div class="outline-text-4" id="text-links-to-my-config">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-dotemacs-export</span> (path desc format _)
  <span class="org-doc">"Export dotemacs link."</span>
  (<span class="org-keyword">pcase</span> format
   ((<span class="org-keyword">or</span> 'html '11ty 'md)
    (format <span class="org-string">"&lt;a href=\"https://sachachua.com/dotemacs#%s\"&gt;%s&lt;/a&gt;"</span> path (<span class="org-keyword">or</span> desc path)))
  ('ascii
    desc)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-dotemacs-complete</span> ()
  <span class="org-doc">"Prompt for dotemacs."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (find-file-noselect <span class="org-string">"~/sync/emacs/Sacha.org"</span>)
    (concat <span class="org-string">"dotemacs:"</span> (org-read-property-value <span class="org-string">"CUSTOM_ID"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-dotemacs-insert-description</span> (link <span class="org-type">&amp;optional</span> description)
  (<span class="org-keyword">unless</span> description))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-dotemacs-open</span> (path)
  (<span class="org-keyword">with-current-buffer</span> (find-file-noselect <span class="org-string">"~/sync/emacs/Sacha.org"</span>)
    (<span class="org-keyword">when-let</span> ((pos (org-find-property <span class="org-string">"CUSTOM_ID"</span> path)))
      (switch-to-buffer (current-buffer))
      (goto-char pos))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-dotemacs-store</span> ()
  (<span class="org-keyword">when</span> (string= (buffer-file-name)
                 (expand-file-name <span class="org-string">"~/sync/emacs/Sacha.org"</span>))
    (org-link-store-props
     <span class="org-builtin">:link</span> (concat <span class="org-string">"dotemacs:"</span> (org-entry-get (point) <span class="org-string">"CUSTOM_ID"</span>))
     <span class="org-builtin">:content</span> (org-entry-get (point) <span class="org-string">"ITEM"</span>))))

(org-link-set-parameters
 <span class="org-string">"dotemacs"</span>
 <span class="org-builtin">:complete</span> #'my-org-dotemacs-complete
 <span class="org-builtin">:store</span> #'my-org-dotemacs-store
 <span class="org-builtin">:insert-description</span> #'my-org-dotemacs-insert-description
 <span class="org-builtin">:export</span> #'my-org-dotemacs-export
 <span class="org-builtin">:follow</span> #'my-org-dotemacs-open)
</pre>
</div>
</div>
<div id="outline-container-orga3496fa" class="outline-5">
<h5 id="orga3496fa"><span class="todo TODO">TODO</span> add dotemacs completion</h5>
<div class="outline-text-5" id="text-orga3496fa">
</div>
</div>
</div>
<div id="outline-container-youtube" class="outline-4">
<h4 id="youtube">YouTube</h4>
<div class="outline-text-4" id="text-youtube">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-yt-iframe-format</span>
  (concat <span class="org-string">"&lt;div class=\"yt-video\"&gt;&lt;iframe width=\"456\""</span>
          <span class="org-string">" height=\"315\""</span>
          <span class="org-string">" title=""YouTube video player\""</span>
          <span class="org-string">" src=\"https://www.youtube-nocookie.com/embed/%s?enablejsapi=1\""</span>
          <span class="org-string">" frameborder=\"0\""</span>
          <span class="org-string">" allowfullscreen&gt;%s&lt;/iframe&gt;&lt;a href=\"%s\"&gt;Watch on YouTube&lt;/a&gt;&lt;/div&gt;"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-yt-export</span> (path desc format _)
  <span class="org-doc">"Export time link or embed."</span>
  (<span class="org-keyword">pcase</span> format
    ((<span class="org-keyword">or</span> 'html '11ty 'md)
     (<span class="org-keyword">cond</span>
      (desc (format <span class="org-string">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span> path (<span class="org-keyword">or</span> desc path)))
      ((string-match <span class="org-string">"t="</span> path) (format <span class="org-string">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span> path (<span class="org-keyword">or</span> desc path)))
      (t (format my-org-yt-iframe-format
                 (<span class="org-keyword">cond</span>
                  ((string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">v=</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">tu\\.be/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">live/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&amp;]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> path)
                   (match-string 1 path))
                  ((string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">live_stream\\?channel.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> path)
                   (match-string 1 path))
                  (t path))
                 (<span class="org-keyword">or</span> desc <span class="org-string">""</span>)
                 path))))
    ('ascii
     desc)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-yt-convert-time</span> (time)
  (<span class="org-keyword">let</span> ((split-time (reverse (split-string time <span class="org-string">":"</span>))))
    (format <span class="org-string">"%sh%sm%ss"</span>
            (<span class="org-keyword">or</span> (elt split-time 2) <span class="org-string">"0"</span>)
            (<span class="org-keyword">or</span> (elt split-time 1) <span class="org-string">"0"</span>)
            (<span class="org-keyword">or</span> (elt split-time 0) <span class="org-string">"0"</span>))))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-yt-convert-time</span> ()
  (should
   (string=
    (my-org-yt-convert-time <span class="org-string">"1:02"</span>)
    <span class="org-string">"0h1m02s"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-yt-complete</span> ()
  <span class="org-doc">"Prompt for a timestamp and link to a video."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((url (read-string <span class="org-string">"URL: "</span> (<span class="org-keyword">when</span> (derived-mode-p 'org-mode)
                                     (org-entry-get (point) <span class="org-string">"YOUTUBE"</span>))))
         (time (read-string <span class="org-string">"Time: "</span>))
         (split-time (reverse (split-string time <span class="org-string">":"</span>))))
    (concat <span class="org-string">"yt:"</span>
            url
            (<span class="org-keyword">if</span> (string= time <span class="org-string">""</span>)
                <span class="org-string">""</span>
              (concat
               (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\?"</span> url) <span class="org-string">"&amp;t="</span> <span class="org-string">"?t="</span>)
               (format <span class="org-string">"%sh%sm%ss"</span>
                       (<span class="org-keyword">or</span> (elt split-time 2) <span class="org-string">"0"</span>)
                       (<span class="org-keyword">or</span> (elt split-time 1) <span class="org-string">"0"</span>)
                       (<span class="org-keyword">or</span> (elt split-time 0) <span class="org-string">"0"</span>)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-yt-insert-description</span> (link <span class="org-type">&amp;optional</span> description)
  (<span class="org-keyword">unless</span> description
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"t=</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9hms]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> link)
      (<span class="org-keyword">let</span> ((split-time (cdr (reverse (split-string (match-string 1 link) <span class="org-string">"[hms]"</span>)))))
        (concat
         (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (elt split-time 2) (not (string= (elt split-time 2) <span class="org-string">"0"</span>)))
             (concat (elt split-time 2) <span class="org-string">":"</span>)
           <span class="org-string">""</span>)
         (<span class="org-keyword">if</span> (elt split-time 1)
             (concat (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (<span class="org-keyword">and</span> (elt split-time 2) (not (string= (elt split-time 2) <span class="org-string">"0"</span>)))
                              (&lt; (length (elt split-time 1)) 2))
                         <span class="org-string">"0"</span> <span class="org-string">""</span>)
                     (elt split-time 1) <span class="org-string">":"</span>)
           <span class="org-string">""</span>)
         (concat (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (elt split-time 1) (&lt; (length (elt split-time 0)) 2)) <span class="org-string">"0"</span> <span class="org-string">""</span>)
                 (elt split-time 0)))))))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-yt-insert-description</span> ()
  (should
   (string=
    (my-org-yt-insert-description <span class="org-string">"yt:somevideo?t=0h1m2s"</span>)
    <span class="org-string">"1:02"</span>))
  (should
   (string=
    (my-org-yt-insert-description <span class="org-string">"yt:somevideo?t=1h2m3s"</span>)
    <span class="org-string">"1:02:03"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-yt-open</span> (path)
  (browse-url path))
(org-link-set-parameters <span class="org-string">"yt"</span> <span class="org-builtin">:complete</span> #'my-org-yt-complete
                         <span class="org-builtin">:insert-description</span> #'my-org-yt-insert-description
                         <span class="org-builtin">:export</span> #'my-org-yt-export
                         <span class="org-builtin">:follow</span> #'my-org-yt-open)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-copy-region-as-plain-text</span> (beg end)
  <span class="org-doc">"Copy as plain text, removing links."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-restriction</span>
    (narrow-to-region beg end)
    (kill-new (org-export-as 'ascii nil nil t))))

</pre>
</div>
</div>
</div>
<div id="outline-container-videos" class="outline-4">
<h4 id="videos">Videos</h4>
<div class="outline-text-4" id="text-videos">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span class="org-string">"video"</span>
 <span class="org-builtin">:export</span> #'my-org-video-export
 <span class="org-builtin">:follow</span> #'my-org-video-follow
 <span class="org-builtin">:complete</span> #'my-org-video-complete)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-video-follow</span> (path _)
  (<span class="org-keyword">cond</span>
   ((string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">https://.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> path)
    (mpv-start (concat (match-string 1 path) <span class="org-string">"?t="</span> (my-org-yt-convert-time (match-string 2 path)))))
   ((string-match <span class="org-string">"https:"</span> path)
    (mpv-start path))
   ((string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9:]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> path)
    (mpv-start (expand-file-name (match-string 1 path))
               (concat <span class="org-string">"--start=+"</span> (match-string 2 path))))
   (t (mpv-play (expand-file-name (replace-regexp-in-string <span class="org-string">"\\?.*"</span> <span class="org-string">""</span> path))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-video-replace-with-permalink</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((elem (org-element-context))
         (path (org-element-property <span class="org-builtin">:path</span> elem))
         (description (org-element-property <span class="org-builtin">:description</span> elem))
         (permalink (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span> t)))
    (delete-region (org-element-begin elem) (org-element-end elem))
    (insert (org-link-make-string (concat <span class="org-string">"video:https://sachachua.com"</span> permalink (file-name-nondirectory path))
                                  description))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-video-export</span> (link desc format info)
  <span class="org-doc">"Export PATH to FORMAT using the specified wrap parameter."</span>
  (<span class="org-keyword">if</span> desc
      (org-export-string-as (org-link-make-string link desc) format)
    (<span class="org-keyword">pcase</span> format
      ((<span class="org-keyword">or</span> 'html '11ty 'md)
       (<span class="org-keyword">let*</span> ((path-and-query (url-path-and-query (url-generic-parse-url link)))
              (params (<span class="org-keyword">and</span> (cdr path-and-query) (url-parse-query-string (cdr path-and-query))))
              body)
         (<span class="org-keyword">setq</span> body
               (format
                <span class="org-string">"&lt;video%s%s src=\"%s\" type=\"%s\"&gt;%s&lt;a href=\"%s\"&gt;Download the video&lt;/a&gt;%s&lt;/video&gt;"</span>
                (<span class="org-keyword">if</span> (string= (<span class="org-keyword">or</span> (car (assoc-default <span class="org-string">"controls"</span> params 'string= '(<span class="org-string">"1"</span>))) <span class="org-string">"1"</span>) <span class="org-string">"0"</span>)
                    <span class="org-string">""</span>
                  <span class="org-string">" controls=\"1\""</span>)
                (<span class="org-keyword">if</span> (string= (<span class="org-keyword">or</span> (car (assoc-default <span class="org-string">"autoplay"</span> params 'string= '(<span class="org-string">"0"</span>))) <span class="org-string">"0"</span>) <span class="org-string">"0"</span>)
                    <span class="org-string">""</span>
                  <span class="org-string">" autoplay=\"1\""</span>)
                (car path-and-query)
                (mailcap-file-name-to-mime-type (car path-and-query))
                (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"captions"</span> params)
                    (format <span class="org-string">"&lt;track kind=\"subtitles\" label=\"Captions\" src=\"%s\" srclang=\"en\" default&gt;&lt;/track&gt;"</span>
                            (expand-file-name (car (assoc-default <span class="org-string">"captions"</span> params))))
                  <span class="org-string">""</span>)
                (car path-and-query)
                (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"captions-below"</span> params)
                    <span class="org-string">"&lt;div class=\"captions\" style=\"display: none\"&gt;&lt;/div&gt;"</span>
                  <span class="org-string">""</span>)
                ))
         (<span class="org-keyword">when</span> (assoc-default <span class="org-string">"caption"</span> params)
           (<span class="org-keyword">setq</span> body (format <span class="org-string">"&lt;figure&gt;%s&lt;figcaption&gt;&lt;div&gt;%s&lt;/div&gt;&lt;/figcaption&gt;&lt;/figure&gt;"</span>
                              body
                              (car (assoc-default <span class="org-string">"caption"</span> params)))))
         body))
      (_ path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-video-complete</span> ()
  <span class="org-doc">"Complete video reference."</span>
  (<span class="org-keyword">interactive</span>)
  (concat <span class="org-string">"video:"</span> (read-file-name <span class="org-string">"File: "</span>)))

</pre>
</div>
</div>
</div>
<div id="outline-container-audio" class="outline-4">
<h4 id="audio">Audio</h4>
<div class="outline-text-4" id="text-audio">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span class="org-string">"audio"</span>
 <span class="org-builtin">:export</span> #'my-org-audio-export
 <span class="org-builtin">:complete</span> #'my-org-audio-complete)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-audio-replace-with-permalink</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((elem (org-element-context))
         (path (org-element-property <span class="org-builtin">:path</span> elem))
         (description (org-element-property <span class="org-builtin">:description</span> elem))
         (permalink (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span> t)))
    (delete-region (org-element-begin elem) (org-element-end elem))
    (insert (org-link-make-string (concat <span class="org-string">"audio:https://sachachua.com"</span> permalink (file-name-nondirectory path))
                                  description))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-audio-export</span> (link desc format _)
  <span class="org-doc">"Export PATH to FORMAT using the specified wrap parameter."</span>
  (<span class="org-keyword">if</span> desc
      (org-export-string-as (org-link-make-string link desc) format)
    (<span class="org-keyword">pcase</span> format
      ((<span class="org-keyword">or</span> 'html '11ty 'md)
       (<span class="org-keyword">let*</span> ((path-and-query (url-path-and-query (url-generic-parse-url link)))
              (params (<span class="org-keyword">and</span> (cdr path-and-query) (url-parse-query-string (cdr path-and-query)))))
         (format
          <span class="org-string">"&lt;div class=\"audio\"&gt;&lt;audio%s%s%s preload=\"metadata\" src=\"%s\" type=\"%s\"&gt;&lt;a href=\"%s\"&gt;Download the audio&lt;/a&gt;%s&lt;/audio&gt;%s&lt;/div&gt;"</span>
          (<span class="org-keyword">if</span> (string= (<span class="org-keyword">or</span> (assoc-default <span class="org-string">"controls"</span> params 'string= <span class="org-string">"1"</span>) <span class="org-string">"1"</span>) <span class="org-string">"0"</span>)
              <span class="org-string">""</span>
            <span class="org-string">" controls=\"1\""</span>)
          (<span class="org-keyword">if</span> (string= (<span class="org-keyword">or</span> (assoc-default <span class="org-string">"autoplay"</span> params 'string= <span class="org-string">"0"</span>) <span class="org-string">"0"</span>) <span class="org-string">"0"</span>)
              <span class="org-string">""</span>
            <span class="org-string">" autoplay=\"1\""</span>)
          (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"id"</span> params)
              (format <span class="org-string">" id=\"%s\""</span> (car (assoc-default <span class="org-string">"id"</span> params)))
            <span class="org-string">""</span>)
          (car path-and-query)
          (mailcap-file-name-to-mime-type (car path-and-query))
          (car path-and-query)
          (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"captions"</span> params)
              (format <span class="org-string">"&lt;track kind=\"subtitles\" label=\"Captions\" src=\"%s\" srclang=\"en\" default&gt;&lt;/track&gt;"</span>
                      (car (assoc-default <span class="org-string">"captions"</span> params)))
            <span class="org-string">""</span>)
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (assoc-default <span class="org-string">"captions"</span> params)
                   (assoc-default <span class="org-string">"id"</span> params))
              (format  <span class="org-string">"&lt;div class=\"captions\" style=\"display: none\"&gt;&lt;/div&gt;"</span>
                       (car (assoc-default <span class="org-string">"id"</span> params)))
            <span class="org-string">""</span>)
          )))
      (_ path))))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-audio-export</span> ()
 (should
  (string-match
   <span class="org-string">"&lt;audio controls=\"1\" id=\"play-this\" src=\"test.opus\" type=\"audio/ogg\"&gt;&lt;a href=\"test.opus\"&gt;Download the audio&lt;/a&gt;&lt;track kind=\"subtitles\" label=\"Captions\" src=\"test.vtt\" srclang=\"en\" default&gt;&lt;/track&gt;&lt;/audio&gt;"</span>
   (my-org-audio-export
    <span class="org-string">"test.opus?id=play-this&amp;captions=test.vtt"</span>
    nil
    'html
    nil
    )
   )))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-audio-complete</span> ()
  <span class="org-doc">"Complete audio reference."</span>
  (<span class="org-keyword">interactive</span>)
  (concat <span class="org-string">"audio:"</span> (read-file-name <span class="org-string">"File: "</span>)))

</pre>
</div>
</div>
</div>
<div id="outline-container-git-projects" class="outline-4">
<h4 id="git-projects">Using an Emacs Lisp macro to define quick custom Org Mode links to project files; plus URLs and search&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span>&#xa0;<span class="coding">coding</span></span></h4>
<div class="outline-text-4" id="text-git-projects">
<div class="update" id="org933e386">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2024-01-12 Fri] </span></span> Added embark action to copy the exported link URL.</li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2024-01-11 Thu] </span></span> Switched to using Github links since Codeberg's down.</li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2024-01-11 Thu] </span></span> Updated my-copy-link to just return the link if called from Emacs Lisp. Fix getting the properties.</li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2024-01-08 Mon] </span></span> Add tip from Omar about <code>embark-around-action-hooks</code></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2024-01-08 Mon] </span></span> Simplify code by using <code>consult--grep-position</code></li>
</ul>

</div>

<summary id="orgea0d0fa">
<p>
Summary (882 words): Emacs macros make it easy to define sets of related functions for custom Org links. This makes it easier to link to projects and export or copy the links to the files in the web-based repos. You can also use that information to consult-ripgrep across lots of projects.
</p>
</summary>

<p>
I'd like to get better at writing notes while coding and at turning
those notes into blog posts and videos. I want to be able to link to
files in projects easily with the ability to complete, follow, and
export links. For example, <code>[[subed:subed.el]]</code> should become
, which opens the file if I'm in Emacs and exports a
link if I'm publishing a post. I've been making custom link types
using <code>org-link-set-parameters</code>. I think it's time to make a macro
that defines that set of functions for me. Emacs Lisp macros are a
great way to write code to write code.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-project-web-base-list</span> nil <span class="org-doc">"Local path . web repo URLs for easy linking."</span>)

(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-org-project-link</span> (type file-path git-url)
  `(<span class="org-keyword">progn</span>
     (<span class="org-keyword">defun</span> ,(intern (format <span class="org-string">"my-org-%s-complete"</span> type)) ()
       ,(format <span class="org-string">"Complete a file from %s."</span> type)
       (concat ,type <span class="org-string">":"</span> (completing-read <span class="org-string">"File: "</span>
                                          (projectile-project-files ,file-path))))
     (<span class="org-keyword">defun</span> ,(intern (format <span class="org-string">"my-org-%s-follow"</span> type)) (link _)
       ,(format <span class="org-string">"Open a file from %s."</span> type)
       (find-file
        (expand-file-name
         link
         ,file-path)))
     (<span class="org-keyword">defun</span> ,(intern (format <span class="org-string">"my-org-%s-export"</span> type)) (link desc format _)
       <span class="org-doc">"Export link to file."</span>
       (<span class="org-keyword">setq</span> desc (<span class="org-keyword">or</span> desc link))
       (<span class="org-keyword">when</span> ,git-url
         (<span class="org-keyword">setq</span> link (concat ,git-url (replace-regexp-in-string <span class="org-string">"^/"</span> <span class="org-string">""</span> link))))
       (<span class="org-keyword">pcase</span> format
         ((<span class="org-keyword">or</span> 'html '11ty) (format <span class="org-string">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span>
                                   link
                                   (<span class="org-keyword">or</span> desc link)))
         ('md (<span class="org-keyword">if</span> desc (format <span class="org-string">"[%s](%s)"</span> desc link)
                (format <span class="org-string">"&lt;%s&gt;"</span> link)))
         ('latex (format <span class="org-string">"\\href{%s}{%s}"</span> link desc))
         ('texinfo (format <span class="org-string">"@uref{%s,%s}"</span> link desc))
         ('ascii (format <span class="org-string">"%s (%s)"</span> desc link))
         (_ (format <span class="org-string">"%s (%s)"</span> desc link))))
     (<span class="org-keyword">with-eval-after-load</span> 'org
       (org-link-set-parameters
        ,type
        <span class="org-builtin">:complete</span> (<span class="org-keyword">quote</span> ,(intern (format <span class="org-string">"my-org-%s-complete"</span> type)))
        <span class="org-builtin">:export</span> (<span class="org-keyword">quote</span> ,(intern (format <span class="org-string">"my-org-%s-export"</span> type)))
        <span class="org-builtin">:follow</span> (<span class="org-keyword">quote</span> ,(intern (format <span class="org-string">"my-org-%s-follow"</span> type))))
       (<span class="org-keyword">cl-pushnew</span> (cons (expand-file-name ,file-path) ,git-url)
                   my-project-web-base-list
                   <span class="org-builtin">:test</span> 'equal))))
</pre>
</div>

<p>
Then I can define projects this way:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(my-org-project-link <span class="org-string">"subed"</span>
                     <span class="org-string">"~/proj/subed/subed/"</span>
                     <span class="org-string">"https://github.com/sachac/subed/blob/main/subed/"</span>
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">"https://codeberg.org/sachac/subed/src/branch/main/subed/"</span>
                     )
(my-org-project-link <span class="org-string">"emacsconf-el"</span>
                     <span class="org-string">"~/proj/emacsconf/lisp/"</span>
                     <span class="org-string">"https://git.emacsconf.org/emacsconf-el/tree/"</span>)
(my-org-project-link <span class="org-string">"subed-record"</span>
                     <span class="org-string">"~/proj/subed-record/"</span>
                     <span class="org-string">"https://github.com/sachac/subed-record/blob/main/"</span>
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">"https://codeberg.org/sachac/subed-record/src/branch/main/"</span>
                     )
(my-org-project-link <span class="org-string">"compile-media"</span>
                     <span class="org-string">"~/proj/compile-media/"</span>
                     <span class="org-string">"https://github.com/sachac/compile-media/blob/main/"</span>
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">"https://codeberg.org/sachac/compile-media/src/branch/main/"</span>
                     )
(my-org-project-link <span class="org-string">"ox-11ty"</span>
                     <span class="org-string">"~/proj/ox-11ty/"</span>
                     <span class="org-string">"https://github.com/sachac/ox-11ty/blob/master/"</span>)
</pre>
</div>

<p>
And I can complete them with the usual <code>C-c C-l</code> (<code>org-insert-link</code>) process:
</p>


<figure id="orgf10fe5d">
<img src="images/completing-custom-links.gif" alt="completing-custom-links.gif">

<figcaption><span class="figure-number">Figure 8: </span>Completing a custom link with <code>org-insert-link</code></figcaption>
</figure>

<p>
Sketches are handled by <a href="https://sachachua.com/dotemacs#org-mode-sketch-links">my Org Mode sketch links</a>, but we can add them anyway.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cl-pushnew</span> (cons (expand-file-name <span class="org-string">"~/sync/sketches/"</span>) <span class="org-string">"https://sketches.sachachua.com/filename/"</span>)
            my-project-web-base-list
            <span class="org-builtin">:test</span> 'equal)
</pre>
</div>

<p>
I've been really liking being able to refer to various emacsconf-el
files by just selecting the link type and completing the filename, so
maybe it'll be easier to write about lots of other stuff if I extend
that to my other projects.
</p>
</div>
<div id="outline-container-web-link" class="outline-5">
<h5 id="web-link">Copy web link</h5>
<div class="outline-text-5" id="text-web-link">
<div class="update" id="org3899dd3">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-01-20 Sat]</span></span>: Fix Wayback link handling.
<span class="timestamp-wrapper"><span class="timestamp">[2024-01-19 Fri]</span></span>: Add Wayback machine.
</p>

</div>

<p>
Keeping a list of projects and their web versions also makes it easier
for me to get the URL for something. I try to post as much as possible
on the Web so that it's easier for me to find things again and so that
other people can pick up ideas from my notes. Things are a bit
scattered: <a href="https://sachachua.com">my blog</a>, repositories on <a href="https://github.com/sachac/">Github</a> and <a href="https://codeberg.org/sachac/">Codeberg</a>, <a href="https://sketches.sachachua.com">my
sketches</a>&#x2026; I don't want to think about <i>where</i> the code has ended
up, I just want to grab the URL. If I'm going to put the link into an
Org Mode document, that's super easy. I just take advantage of the
things I've added to <code>org-store-link</code>. If I'm going to put it into an
e-mail or a toot or wherever else, I just want the bare URL.
</p>

<p>
I can think of two ways to approach this. One is a command that copies
just the URL by figuring it out from the buffer filename, which allows
me to special-case a bunch of things:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-link</span> (<span class="org-type">&amp;optional</span> filename skip-links)
  <span class="org-doc">"Return the URL of this file.</span>
<span class="org-doc">If FILENAME is non-nil, use that instead.</span>
<span class="org-doc">If SKIP-LINKS is non-nil, skip custom links.</span>
<span class="org-doc">If we're in a Dired buffer, use the file at point."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> filename (<span class="org-keyword">or</span> filename
                     (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode) (dired-get-filename))
                     (buffer-file-name)))
  (<span class="org-keyword">if-let*</span>
      ((project-re (concat <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span> (regexp-opt (mapcar 'car my-project-web-base-list)) <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                           <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>))
       (url (<span class="org-keyword">cond</span>
             ((<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
                   (eq (org-element-type (org-element-context)) 'link)
                   (not skip-links))
              (<span class="org-keyword">pcase</span> (org-element-property <span class="org-builtin">:type</span> (org-element-context))
                ((<span class="org-keyword">or</span> <span class="org-string">"https"</span> <span class="org-string">"http"</span>)
                 (org-element-property <span class="org-builtin">:raw-link</span> (org-element-context)))
                (<span class="org-string">"yt"</span>
                 (org-element-property <span class="org-builtin">:path</span> (org-element-context)))
                <span class="org-comment-delimiter">;; </span><span class="org-comment">if it's a custom link, visit it and get the link</span>
                (_
                 (<span class="org-keyword">save-window-excursion</span>
                   (org-open-at-point)
                   (my-copy-link nil t)))))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">links to my config usually have a CUSTOM_ID property</span>
             ((string= (buffer-file-name) (expand-file-name <span class="org-string">"~/sync/emacs/Sacha.org"</span>))
              (concat <span class="org-string">"https://sachachua.com/dotemacs#"</span> (org-entry-get-with-inheritance <span class="org-string">"CUSTOM_ID"</span>)))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">blog post drafts have permalinks</span>
             ((<span class="org-keyword">and</span> (derived-mode-p 'org-mode) (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>))
              (concat <span class="org-string">"https://sachachua.com"</span> (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>)))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">some projects have web repos</span>
             ((string-match
               project-re filename)
              (concat (assoc-default (match-string 1 filename) my-project-web-base-list)
                      (url-hexify-string (match-string 2 filename)))))))
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">when</span> (called-interactively-p 'any)
          (kill-new url)
          (message <span class="org-string">"%s"</span> url))
        url)
    (<span class="org-warning">error</span> <span class="org-string">"Couldn't figure out URL."</span>)))
</pre>
</div>

<p>
Another approach is to hitch a ride on the Org Mode link storage and
export functions and just grab the URL from whatever link I've stored
with <code>org-store-link</code>, which I've bound to <code>C-c l</code>. I almost always
have an HTML version of the exported link. We can even use XML parsing
instead of regular expressions.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-link-as-url</span> (link)
  <span class="org-doc">"Return the final URL for LINK."</span>
  (<span class="org-keyword">dom-attr</span>
   (dom-by-tag
    (<span class="org-keyword">with-temp-buffer</span>
      (insert (org-export-string-as link 'html t))
      (xml-parse-region (point-min) (point-max)))
    'a)
   'href))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-stored-link-as-url</span> (<span class="org-type">&amp;optional</span> link insert)
  <span class="org-doc">"Copy the stored link as a plain URL.</span>
<span class="org-doc">If LINK is specified, use that instead."</span>
  (<span class="org-keyword">interactive</span> (list nil current-prefix-arg))
  (<span class="org-keyword">setq</span> link (<span class="org-keyword">or</span> link (caar org-stored-links)))
  (<span class="org-keyword">let</span> ((url (<span class="org-keyword">if</span> link
                 (my-org-link-as-url link)
               (<span class="org-warning">error</span> <span class="org-string">"No stored link"</span>))))
    (<span class="org-keyword">when</span> (called-interactively-p 'any)
      (<span class="org-keyword">if</span> url
          (<span class="org-keyword">if</span> insert (insert url) (kill-new url))
        (<span class="org-warning">error</span> <span class="org-string">"Could not find URL."</span>)))
    url))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-stored-link-as-url</span> ()
  (should
   (string= (my-org-stored-link-as-url <span class="org-string">"[[dotemacs:web-link]]"</span>)
            <span class="org-string">"https://sachachua.com/dotemacs#web-link"</span>))
  (should
   (string= (my-org-stored-link-as-url <span class="org-string">"[[dotemacs:org-mode-sketch-links][my Org Mode sketch links]]"</span>)
            <span class="org-string">"https://sachachua.com/dotemacs#org-mode-sketch-links"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-org-copy-exported-url-as-wayback</span> (link <span class="org-type">&amp;rest</span> _)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MLink: "</span>)
  (<span class="org-keyword">let</span> ((url  (my-embark-org-copy-exported-url link)))
    (<span class="org-keyword">when</span> (not (string-match (regexp-quote <span class="org-string">"^https://web.archive.org"</span>) url))
      (<span class="org-keyword">setq</span> url (concat <span class="org-string">"https://web.archive.org/web/"</span> (format-time-string <span class="org-string">"%Y%m%d%H%M%S/"</span>)
                        url)))
    (<span class="org-keyword">when</span> (called-interactively-p 'any)
      (kill-new url)
      (message <span class="org-string">"Copied %s"</span> url))
    url))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-embark-org-copy-exported-url</span> (link <span class="org-type">&amp;rest</span> _)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MLink: \np"</span>)
  (<span class="org-keyword">let</span> ((url (my-org-link-as-url link)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (derived-mode-p 'org-mode)
               (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>)
               (string-match <span class="org-string">"^/"</span> url))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">local file links are copied to blog directories</span>
      (<span class="org-keyword">setq</span> url (concat <span class="org-string">"https://sachachua.com"</span>
                        (org-entry-get-with-inheritance <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>)
                        (replace-regexp-in-string
                         <span class="org-string">"[\\?&amp;].*"</span>
                         <span class="org-string">""</span>
                         (file-name-nondirectory link)))))
    (<span class="org-keyword">when</span> (called-interactively-p 'any)
      (kill-new url)
      (message <span class="org-string">"Copied %s"</span> url))
    url))

(<span class="org-keyword">with-eval-after-load</span> 'embark-org
  (define-key embark-org-link-map
              <span class="org-string">"u"</span>
              #'my-embark-org-copy-exported-url)
  (define-key embark-org-link-map
              <span class="org-string">"U"</span>
              #'my-embark-org-copy-exported-url-as-wayback)
  (define-key embark-org-link-copy-map
              <span class="org-string">"u"</span>
              #'my-embark-org-copy-exported-url)
  (define-key embark-org-link-copy-map
              <span class="org-string">"U"</span>
              #'my-embark-org-copy-exported-url-as-wayback))
</pre>
</div>

<p>
We'll see which one I end up using. I think both approaches might come in handy.
</p>
</div>
</div>
<div id="outline-container-org6789da6" class="outline-5">
<h5 id="org6789da6">Quickly search my code</h5>
<div class="outline-text-5" id="text-org6789da6">
<p>
Since <code>my-project-web-base-list</code> is a list of projects I often think
about or write about, I can also make something that searches through
them. That way, I don't have to care about where my code is.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-consult-ripgrep-code</span> ()
  (<span class="org-keyword">interactive</span>)
  (consult-ripgrep (mapcar 'car my-project-web-base-list)))
</pre>
</div>

<p>
I can add <code>.rgignore</code> files in directories to tell ripgrep to ignore
things like <code>node_modules</code> or <code>*.json</code>.
</p>

<p>
I also want to search my Emacs configuration at the same time,
although links to my config are handled by <a href="https://sachachua.com/dotemacs#links-to-my-config">my dotemacs link type</a> so
I'll leave the URL as nil. This is also the way I can handle other
unpublished directories.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cl-pushnew</span> (cons (expand-file-name <span class="org-string">"~/sync/emacs/Sacha.org"</span>) nil)
            my-project-web-base-list
            <span class="org-builtin">:test</span> 'equal)
(<span class="org-keyword">cl-pushnew</span> (cons (expand-file-name <span class="org-string">"~/proj/static-blog/_includes"</span>) nil)
            my-project-web-base-list
            <span class="org-builtin">:test</span> 'equal)
(<span class="org-keyword">cl-pushnew</span> (cons (expand-file-name <span class="org-string">"~/bin"</span>) nil)
            my-project-web-base-list
            <span class="org-builtin">:test</span> 'equal)
</pre>
</div>

<p>
Actually, let's throw my blog posts and Org files in there as well,
since I often have code snippets. If it gets to be too much, I can
always have different commands search different things.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cl-pushnew</span> (cons (expand-file-name <span class="org-string">"~/proj/static-blog/blog/"</span>) <span class="org-string">"https://sachachua.com/blog/"</span>)
            my-project-web-base-list
            <span class="org-builtin">:test</span> 'equal)
(<span class="org-keyword">cl-pushnew</span> (cons (expand-file-name <span class="org-string">"~/sync/orgzly"</span>) nil)
            my-project-web-base-list
            <span class="org-builtin">:test</span> 'equal)
</pre>
</div>


<figure id="orgbaf1546">
<img src="images/ripgrep-code.gif" alt="ripgrep-code.gif">

<figcaption><span class="figure-number">Figure 9: </span>Using my-consult-ripgrep-code</figcaption>
</figure>

<p>
I don't have anything bound to <code>M-s c</code> (code) yet, so let's try that.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(keymap-global-set <span class="org-string">"M-s c"</span> #'my-consult-ripgrep-code)
</pre>
</div>

<p>
At some point, it might be fun to get Embark set up so that I can grab
a link to something right from the consult-ripgrep interface. In the
meantime, I can always jump to it and get the link.
</p>
</div>
<ul class="org-ul">
<li><a id="org9b8a17d"></a>Tip from Omar: embark-around-action-hooks<br>
<div class="outline-text-6" id="text-org9b8a17d">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-01-07 Sun] </span></span> I modified oantolin's suggestion from the comments to work with <code>consult-ripgrep</code>, since <code>consult-ripgrep</code> gives me <code>consult-grep</code> targets instead of <code>consult-location</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cl-defun</span> <span class="org-function-name">embark-consult--at-location</span> (<span class="org-type">&amp;rest</span> args <span class="org-type">&amp;key</span> target type run <span class="org-type">&amp;allow-other-keys</span>)
  <span class="org-doc">"RUN action at the target location."</span>
  (<span class="org-keyword">save-window-excursion</span>
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">save-restriction</span>
        (<span class="org-keyword">pcase</span> type
          ('consult-location (consult--jump (consult--get-location target)))
          ('org-heading (org-goto-marker-or-bmk (get-text-property 0 'org-marker target)))
          ('consult-grep (consult--jump (consult--grep-position target)))
          ('file (find-file target)))
        (apply run args)))))

(<span class="org-keyword">cl-pushnew</span> #'embark-consult--at-location (alist-get 'org-store-link embark-around-action-hooks))
</pre>
</div>

<p>
I think I can use it with <code>M-s c</code> to search for the code, then <code>C-.
C-c l</code> on the matching line, where <code>C-c l</code> is my regular keybinding
for storing links. Thanks, Omar!
</p>

<p>
In general, I don't want to have to think about where something is on
my laptop or where it's published on the Web, I just want to write
about it. One step closer, yay Emacs!
</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-links-from-org-protocol" class="outline-4">
<h4 id="links-from-org-protocol">Links from org-protocol</h4>
<div class="outline-text-4" id="text-links-from-org-protocol">
<p>
So that I can easily add links at point. Formatted as an Org list for now.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-protocol-insert-link</span> (info)
  <span class="org-doc">"Store and insert the link at point based on INFO."</span>
  (org-protocol-store-link info)
  (<span class="org-keyword">with-current-buffer</span> (window-buffer (selected-window))
    (insert <span class="org-string">"- "</span>)
    (org-insert-last-stored-link 1)
    (insert <span class="org-string">"\n"</span>)))
(eval-after-load 'org-protocol
  '(add-to-list 'org-protocol-protocol-alist
                '(<span class="org-string">"insert-link"</span> <span class="org-builtin">:protocol</span> <span class="org-string">"insert-link"</span> <span class="org-builtin">:function</span> my-org-protocol-insert-link)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">javascript:location.href = '</span><span class="org-comment"><span class="org-constant">org-protocol://copy-thumbnail?thumbnail=</span></span><span class="org-comment">' + encodeURIComponent(document.querySelector('meta[property=\"og:image\"]') ? document.querySelector('meta[property=\"og:image\"]').getAttribute('</span><span class="org-comment"><span class="org-constant">content</span></span><span class="org-comment">') : '') + '</span><span class="org-comment"><span class="org-constant">&amp;title=</span></span><span class="org-comment">' + encodeURIComponent(document.title) + '</span><span class="org-comment"><span class="org-constant">&amp;url=</span></span><span class="org-comment">' + encodeURIComponent(location.href) + '</span><span class="org-comment"><span class="org-constant">&amp;videoId=</span></span><span class="org-comment">' + ((typeof(videoId) !== '</span><span class="org-comment"><span class="org-constant">undefined</span></span><span class="org-comment">' ? videoId : (document.querySelector('meta[itemprop=\"videoId\"]') ? document.querySelector('meta[itemprop=\"videoId\"]').getAttribute('</span><span class="org-comment"><span class="org-constant">content</span></span><span class="org-comment">') : '')) || '')</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-youtube-info</span> (url)
  (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
    (goto-char (point-min))
    (<span class="org-keyword">prog1</span>
        (list
         <span class="org-builtin">:url</span>
         url
         <span class="org-builtin">:title</span>
         (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;title&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/title&gt;"</span> nil t)
           (match-string 1))
         <span class="org-builtin">:duration</span>
         (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"approxDurationMs\":\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
           (format-seconds <span class="org-string">"%.2h:%.2m:%.2s%z"</span> (/ (string-to-number (match-string 1)) 1000))))
      (kill-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-link-video</span> (list)
  (<span class="org-keyword">when</span> (stringp list) (<span class="org-keyword">setq</span> list (list <span class="org-builtin">:url</span> list)))
  (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously (concat <span class="org-string">"https://video.link/bookmarklet?url="</span> (url-encode-url (plist-get list <span class="org-builtin">:url</span>))))
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"&lt;input type=\"text\" id=\"safeURL\" readonly=\"readonly\" value=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
          (plist-put list <span class="org-builtin">:url</span> (match-string-no-properties 1))
        (plist-put list <span class="org-builtin">:url</span> (replace-regexp-in-string <span class="org-string">"watch"</span> <span class="org-string">"watch_popup"</span> (plist-get list <span class="org-builtin">:url</span>)))))
    (<span class="org-keyword">when</span> (string= (<span class="org-keyword">or</span> (plist-get list <span class="org-builtin">:thumbnail</span>) <span class="org-string">""</span>) <span class="org-string">""</span>)
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"&lt;img id=\"videoThumb\" src=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
          (plist-put list <span class="org-builtin">:thumbnail</span> (match-string-no-properties 1)))))
    list))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-protocol-copy-thumbnail</span> (info)
  <span class="org-doc">"Store and insert the link at point based on INFO."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MURL: "</span>)
  (<span class="org-keyword">when</span> (stringp info) (<span class="org-keyword">setq</span> info (list <span class="org-builtin">:url</span> info)))
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"youtube\\.com"</span> (plist-get info <span class="org-builtin">:url</span>))
    (<span class="org-keyword">setq</span> info (my-link-video info)))
  (<span class="org-keyword">let</span> ((date (format-time-string <span class="org-string">"%Y-%m-%d"</span>)))
    (kill-new
     (<span class="org-keyword">if</span> (string= (plist-get info <span class="org-builtin">:videoId</span>) <span class="org-string">""</span>)
         (format <span class="org-string">"{{&lt;thumbnail image=\"%s\" title=\"%s\" link=\"%s\" date=\"%s\"&gt;}}\n"</span>
                 (plist-get info <span class="org-builtin">:thumbnail</span>)
                 (plist-get info <span class="org-builtin">:title</span>)
                 (plist-get info <span class="org-builtin">:url</span>)
                 date
                 )
       (format <span class="org-string">"{{&lt;youtube id=\"%s\" title=\"%s\" link=\"%s\" date=\"%s\"&gt;}}\n"</span>
               (plist-get info <span class="org-builtin">:videoId</span>)
               (plist-get info <span class="org-builtin">:title</span>)
               (plist-get info <span class="org-builtin">:url</span>)
               date))))
  nil)
(eval-after-load 'org-protocol
  '(add-to-list 'org-protocol-protocol-alist
                '(<span class="org-string">"copy-thumbnail"</span> <span class="org-builtin">:protocol</span> <span class="org-string">"copy-thumbnail"</span> <span class="org-builtin">:function</span> my-org-protocol-copy-thumbnail)))

</pre>
</div>
</div>
</div>
<div id="outline-container-fix-elisp-links" class="outline-4">
<h4 id="fix-elisp-links">Fix elisp links</h4>
<div class="outline-text-4" id="text-fix-elisp-links">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-elisp-link-export</span> (link description format <span class="org-type">&amp;optional</span> arg)
  (<span class="org-keyword">pcase</span> format
   ('html (format <span class="org-string">"&lt;span title=\"%s\"&gt;%s&lt;/span&gt;"</span> (replace-regexp-in-string <span class="org-string">"\""</span> <span class="org-string">"&amp;quot;"</span> link) description))
   ((<span class="org-keyword">or</span> 'icalendar 'ascii) description)
   ))
(org-link-set-parameters
 <span class="org-string">"elisp"</span>
 <span class="org-builtin">:export</span> 'my-org-elisp-link-export)
</pre>
</div>
</div>
</div>
<div id="outline-container-irc" class="outline-4">
<h4 id="irc">IRC</h4>
<div class="outline-text-4" id="text-irc">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-link-set-parameters
 <span class="org-string">"ircs"</span>
 <span class="org-builtin">:export</span>
 (<span class="org-keyword">lambda</span> (link description format)
   <span class="org-doc">"Export an ircs link.</span>
<span class="org-doc">See `</span><span class="org-doc"><span class="org-constant">org-link-parameters</span></span><span class="org-doc">' for details about LINK, DESCRIPTION and</span>
<span class="org-doc">FORMAT."</span>
   (<span class="org-keyword">let</span> ((desc (<span class="org-keyword">or</span> description link)))
     (<span class="org-keyword">pcase</span> format
       (`html (format <span class="org-string">"&lt;a href=\"ircs:%s\"&gt;%s&lt;/a&gt;"</span> link desc))
       (`md (format <span class="org-string">"[%s](ircs:%s)"</span> desc link))
       (_ nil)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-dired" class="outline-4">
<h4 id="org-dired">Dired</h4>
<div class="outline-text-4" id="text-org-dired">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> dired-dwim-target t)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-get-links-in-region</span> (beg end)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> (results)
      (goto-char (min beg end))
      (<span class="org-keyword">while</span> (re-search-forward org-any-link-re (max beg end) t)
        (add-to-list 'results (org-element-context)))
      results)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-dired-file-links-in-region</span> (beg end)
  <span class="org-doc">"Display a Dired buffer for the file links in the selected region."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((files
         (-map
          (<span class="org-keyword">lambda</span> (x)
            (expand-file-name (org-link-unescape (plist-get (cadr x) <span class="org-builtin">:path</span>))))
          (-filter
           (<span class="org-keyword">lambda</span> (x)
             (string= (plist-get (cadr x) <span class="org-builtin">:type</span>) <span class="org-string">"file"</span>))
           (my-org-get-links-in-region beg end)))))
    (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Files*"</span>)
      (<span class="org-keyword">let</span> ((inhibit-read-only t))
        (erase-buffer)
        (apply 'call-process <span class="org-string">"ls"</span> nil t nil <span class="org-string">"-lR"</span> files))
      (dired-virtual <span class="org-string">"/"</span>)
      (switch-to-buffer (current-buffer)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org-protocol-open" class="outline-3">
<h3 id="org-protocol-open">Org protocol: following Org links from outside Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="org">org</span>&#xa0;<span class="emacs">emacs</span></span></h3>
<div class="outline-text-3" id="text-org-protocol-open">
<p>
<code>_xor</code> had an interesting idea: can we use <code>org-protocol</code> to link to
things inside Emacs, so that we can have a webpage with bookmarks into
our Org files? Here's a quick hack that reuses <code>org-store-link</code> and
<code>org-link-open</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-protocol-open-link</span> (info)
  <span class="org-doc">"Process an org-protocol://open style url with INFO."</span>
  (org-link-open (car (org-element-parse-secondary-string (plist-get info <span class="org-builtin">:link</span>) '(link)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-protocol-copy-open-link</span> (arg)
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (kill-new (concat <span class="org-string">"org-protocol://open?link="</span> (url-hexify-string (org-store-link arg)))))

(<span class="org-keyword">with-eval-after-load</span> 'org
  (add-to-list 'org-protocol-protocol-alist
               '(<span class="org-string">"org-open"</span> <span class="org-builtin">:protocol</span> <span class="org-string">"open"</span> <span class="org-builtin">:function</span> org-protocol-open-link)))
</pre>
</div>

<p>
To make exporting and following easier, we also need a little code to
handle <code>org-protocol</code> links inside Org.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-protocol-follow</span> (path <span class="org-type">&amp;rest</span> _)
  <span class="org-doc">"Follow the org-protocol link for PATH."</span>
  (org-protocol-check-filename-for-protocol (concat <span class="org-string">"org-protocol:"</span> path) nil nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-protocol-export</span> (path desc format info)
  <span class="org-doc">"Export an org-protocol link."</span>
  (<span class="org-keyword">setq</span> path (concat <span class="org-string">"org-protocol:"</span> path))
  (<span class="org-keyword">setq</span> desc (<span class="org-keyword">or</span> desc path))
  (<span class="org-keyword">pcase</span> format
    (`html (format <span class="org-string">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
    (`11ty (format <span class="org-string">"&lt;a href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
    (`latex (org-latex-link path desc info))
    (`ascii (org-ascii-link path desc info))
    (`md (org-md-link path desc info))
    (_ path)))

(<span class="org-keyword">with-eval-after-load</span> 'org
  (org-link-set-parameters <span class="org-string">"org-protocol"</span>
                           <span class="org-builtin">:follow</span> #'org-protocol-follow
                           <span class="org-builtin">:export</span> #'org-protocol-export))
</pre>
</div>

<p>
Now I can use <code>org-protocol-copy-open-link</code> to copy a link to the
current location, and I can put it into my Org files.
</p>

<p>
Example bare link to the Org manual, which will work only if you have
<code>open</code> in the <code>org-protocol-protocol-alist</code>:
</p>

<p>
org-protocol://open?link=%5B%5Binfo%3Aorg%23Protocols%5D%5Borg%23Protocols%5D%5D
</p>

<p>
With a description:
</p>

<p>

</p>
</div>
</div>
<div id="outline-container-add-custom-id" class="outline-3">
<h3 id="add-custom-id"><span class="todo TODO">TODO</span> Speed command for adding a custom ID to Org Mode posts</h3>
<div class="outline-text-3" id="text-add-custom-id">
<p>
Nudged by <a href="https://amitp.blogspot.com/2021/04/automatically-generate-ids-for-emacs.html">Amit's post about adding custom IDs to Org headings</a>, I
decided to write a speed command to add a custom ID with a reasonable
default, and to make it happen whenever I post something from my Emacs
config (like this one). I'm running out of brainspace for speed
commands, so I'm going to try sticking it into a hydra so that I can
add future things to the hydra instead. I'll probably figure out some
kind of <a href="https://sachachua.com/blog/2021/04/emacs-making-a-hydra-cheatsheet-for-lispy/">cheat sheet thing</a> for speed commands too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-make-slug</span> (s)
  (<span class="org-keyword">thread-last</span> s
    (downcase)
    (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">a-z0-9]+"</span> <span class="org-string">"-"</span>)
    (replace-regexp-in-string <span class="org-string">"^-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">-$"</span> <span class="org-string">""</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-set-custom-id</span> (id)
  <span class="org-doc">"Set the CUSTOM_ID property to ID at point."</span>
  (<span class="org-keyword">interactive</span> (list
                (<span class="org-keyword">let</span> ((default-custom-id (my-make-slug (string-join (org-get-outline-path t) <span class="org-string">" "</span>))))
                  (read-string (format <span class="org-string">"ID (%s): "</span> default-custom-id) nil nil default-custom-id))))
  (org-entry-put (point) <span class="org-string">"CUSTOM_ID"</span> id))

(<span class="org-keyword">with-eval-after-load</span> 'hydra
  (define-key hydra-base-map (kbd <span class="org-string">"&lt;down&gt;"</span>) 'my-hydra-pop)
  (define-key hydra-base-map (kbd <span class="org-string">"&lt;up&gt;"</span>) (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (my-hydra-go-and-push 'my-shortcuts/body)))


  (<span class="org-keyword">defhydra</span> my-hydra/org-speed-commands ()
    (<span class="org-string">"i"</span> my-org-set-custom-id <span class="org-string">"CUSTOM_ID"</span> <span class="org-builtin">:exit</span> t)
    (<span class="org-string">"&lt;up&gt;"</span> my-hydra/org-mode/body <span class="org-builtin">:exit</span> t)
    (<span class="org-string">"u"</span> (my-hydra-go-and-push 'my-hydra/org-mode/body) <span class="org-builtin">:exit</span> t <span class="org-builtin">:hint</span> nil))
  (<span class="org-keyword">defhydra</span> my-hydra/org-mode (<span class="org-builtin">:foreign-keys</span> run)
    (<span class="org-string">"b"</span> my-org-back-to-heading <span class="org-string">"Heading"</span>)
    (<span class="org-string">"n"</span> org-forward-heading-same-level <span class="org-string">"Next"</span>)
    (<span class="org-string">"p"</span> org-backward-heading-same-level <span class="org-string">"Previous"</span>)
    (<span class="org-string">"a"</span> org-archive-subtree-default <span class="org-string">"Archive"</span>)
    (<span class="org-string">"j"</span> my-org-mark-done-and-add-to-journal <span class="org-string">"Journal"</span> <span class="org-builtin">:exit</span> t)
    (<span class="org-string">"k"</span> org-cut-subtree <span class="org-string">"Kill"</span>)
    (<span class="org-string">"&lt;up&gt;"</span> (my-hydra-go-and-push 'my-shortcuts/body) <span class="org-builtin">:exit</span> t hint nil)
    (<span class="org-string">"u"</span> (my-hydra-go-and-push 'my-shortcuts/body) <span class="org-builtin">:exit</span> t <span class="org-builtin">:hint</span> nil)
    (<span class="org-string">"&lt;f14&gt;"</span> nil <span class="org-string">"Exit"</span> <span class="org-builtin">:exit</span> t))
  (<span class="org-keyword">defhydra</span> my-hydra/org-link ()
    (<span class="org-string">"RET"</span> org-open-at-point <span class="org-string">"Open"</span>)
    (<span class="org-string">"e"</span> org-insert-link <span class="org-string">"Edit"</span>)
    (<span class="org-string">"c"</span> my-caption-show <span class="org-string">"Captions"</span>)
    (<span class="org-string">"w"</span> my-org-link-element-copy-link <span class="org-string">"Copy link"</span>)
    (<span class="org-string">"u"</span> (my-hydra-go-and-push 'my-hydra/org-mode/body) <span class="org-builtin">:exit</span> t <span class="org-builtin">:hint</span> nil)
    (<span class="org-string">"&lt;up&gt;"</span> (my-hydra-go-and-push 'my-hydra/org-mode/body) <span class="org-builtin">:exit</span> t <span class="org-builtin">:hint</span> nil))
  (<span class="org-keyword">defhydra</span> my-hydra/org-src ()
    (<span class="org-string">"e"</span> org-babel-execute-src-block <span class="org-string">"Exec"</span>)
    (<span class="org-string">"E"</span> my-org-execute-src-block-by-name <span class="org-string">"Exec by name"</span>)
    (<span class="org-string">"i"</span> org-edit-special <span class="org-string">"Edit"</span>)
    (<span class="org-string">"d"</span> org-babel-demarcate-block <span class="org-string">"Demarcate"</span>)
    (<span class="org-string">"g"</span> org-babel-goto-named-src-block <span class="org-string">"Goto"</span>)
    (<span class="org-string">"r"</span> org-babel-open-src-block-result <span class="org-string">"Result"</span>)
    (<span class="org-string">"x"</span> org-babel-expand-src-block <span class="org-string">"Expand"</span>)
    (<span class="org-string">"t"</span> (org-babel-tangle '(4)) <span class="org-string">"Tangle at point"</span>)
    (<span class="org-string">"T"</span> (org-babel-tangle '(16)) <span class="org-string">"Tangle target file"</span>)
    (<span class="org-string">"u"</span> (my-hydra-go-and-push 'my-hydra/org-mode/body) <span class="org-builtin">:exit</span> t <span class="org-builtin">:hint</span> nil)
    (<span class="org-string">"&lt;up&gt;"</span> (my-hydra-go-and-push 'my-hydra/org-mode/body) <span class="org-builtin">:exit</span> t <span class="org-builtin">:hint</span> nil)
    )
  (<span class="org-keyword">defun</span> <span class="org-function-name">my-hydra/dwim</span> ()
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">if</span> (derived-mode-p 'org-mode)
        (<span class="org-keyword">let</span> ((context (org-element-context)))
          (<span class="org-keyword">cond</span>
           ((<span class="org-keyword">and</span> (bolp) (looking-at org-outline-regexp))
            (my-hydra/org-speed-commands/body))
           ((org-in-src-block-p) (my-hydra/org-src/body))
           ((eq (org-element-type context) 'link) (my-hydra/org-link/body))
           (t (my-hydra/org-mode/body))))
      (my-shortcuts/body)))
  (define-key org-mode-map (kbd <span class="org-string">"&lt;f14&gt;"</span>) 'my-hydra/dwim)
  (keymap-global-set  <span class="org-string">"&lt;f14&gt;"</span> 'my-hydra/dwim))
</pre>
</div>
</div>
</div>
<div id="outline-container-journal" class="outline-3">
<h3 id="journal">Journal</h3>
<div class="outline-text-3" id="text-journal">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-journal-category-map</span>
  '((<span class="org-string">"Gross"</span> . <span class="org-string">"Gross motor"</span>)
    (<span class="org-string">"Fine"</span> . <span class="org-string">"Fine motor"</span>)
    (<span class="org-string">"8 - Kaizen"</span> . <span class="org-string">"Kaizen"</span>)
    (<span class="org-string">"9 - Us"</span> . <span class="org-string">"Us"</span>)
    (<span class="org-string">"Self-care"</span> . <span class="org-string">"Self-care and independence"</span>))
  <span class="org-doc">"Alist of string replacements for journal categories."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-journal-categories</span>
  '(<span class="org-string">"Kaizen"</span> <span class="org-string">"Us"</span> <span class="org-string">"Field trip"</span> <span class="org-string">"Gross motor"</span> <span class="org-string">"Fine motor"</span>
    <span class="org-string">"Sensory"</span> <span class="org-string">"Language"</span> <span class="org-string">"Music"</span> <span class="org-string">"Art"</span>
    <span class="org-string">"Self-care and independence"</span> <span class="org-string">"Eating"</span> <span class="org-string">"Sleep"</span> <span class="org-string">"Emotion"</span>
    <span class="org-string">"Household"</span> <span class="org-string">"Social"</span> <span class="org-string">"Pretend"</span> <span class="org-string">"Cognition"</span> <span class="org-string">"World"</span> <span class="org-string">"Other"</span> <span class="org-string">"Oops"</span> <span class="org-string">"Thoughts"</span> <span class="org-string">"Consulting"</span> <span class="org-string">"Track"</span> <span class="org-string">"Uncategorized"</span>)
  <span class="org-doc">"List of categories to display.</span>
<span class="org-doc">      Unknown categories will be added to the end."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-date</span> (o) (elt o 3))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-note</span> (o) (car o))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-week-highlight</span> (o) (elt o 4))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-category</span> (o) (elt o 1))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-pictures</span> (o) (<span class="org-keyword">when</span> (string&gt; (elt o 2) <span class="org-string">""</span>) (split-string (elt o 2) <span class="org-string">","</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-id</span> (o) (elt o 7))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-status</span> (o) (elt o 8))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-other</span> (o) (elt o 9))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-zidstring</span> (o) (elt o 11))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-group-journal-entries</span> (filtered <span class="org-type">&amp;optional</span> category-map categories)
  (<span class="org-keyword">setq</span> category-map (<span class="org-keyword">or</span> category-map (my-journal-category-map)))
  (<span class="org-keyword">setq</span> categories (<span class="org-keyword">or</span> categories (my-journal-categories)))
  (<span class="org-keyword">let*</span> ((grouped (-group-by 'my-journal-category filtered))
         (mapped-list
          (mapcar
           (<span class="org-keyword">lambda</span> (o)
             (cons (<span class="org-keyword">or</span> (assoc-default (car o) category-map) (car o))
                   (cdr o)))
           grouped))
         (sorted-list
          (delq nil
                (append
                 (mapcar (<span class="org-keyword">lambda</span> (cat)
                           (<span class="org-keyword">when</span> (assoc-default cat mapped-list)
                             (cons cat (assoc-default cat mapped-list))))
                         categories)
                 (-remove (<span class="org-keyword">lambda</span> (o) (member (car o) categories)) mapped-list)))))
    sorted-list))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-date-to-string</span> (date <span class="org-type">&amp;optional</span> base-date)
  <span class="org-doc">"Return the Org date specified by DATE.</span>
<span class="org-doc">      This is relative to BASE-DATE if specified."</span>
  (org-read-date nil nil date nil (<span class="org-keyword">when</span> base-date (org-read-date nil t base-date))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-date-to-string</span> ()
  (should (string= (my-org-date-to-string <span class="org-string">"++1"</span> <span class="org-string">"2018-08-01"</span>) <span class="org-string">"2018-08-02"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-filter-journal-csv</span> (filename <span class="org-type">&amp;optional</span> from to highlight base-date)
  <span class="org-doc">"Return a list of matching entries."</span>
  (<span class="org-keyword">setq</span> from (<span class="org-keyword">and</span> from (substring (my-org-date-to-string from base-date) 0 10))
        to (<span class="org-keyword">and</span> to (substring (my-org-date-to-string to base-date) 0 10)))
  (<span class="org-keyword">let*</span> ((data (pcsv-parse-file filename))
         (filtered
          (-filter
           (<span class="org-keyword">lambda</span> (o)
             (<span class="org-keyword">let</span> ((date (my-journal-date o)))
               (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> (null from) (not (string&lt; date from)))
                    (<span class="org-keyword">or</span> (null to) (string&lt; date to))
                    (<span class="org-keyword">and</span> (not (string= (my-journal-status o) <span class="org-string">"Deleted"</span>)))
                    (not (string-match <span class="org-string">"^!"</span> (my-journal-note o)))
                    (string-equal
                     <span class="org-string">"true"</span>
                     (<span class="org-keyword">cond</span>
                      ((null highlight) <span class="org-string">"true"</span>)
                      ((string-equal highlight <span class="org-string">"week"</span>) (my-journal-week-highlight o))
                      (t <span class="org-string">"true"</span>))))))
           data)))
    filtered))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-read-category</span> (<span class="org-type">&amp;optional</span> initial)
  (consult--read my-journal-categories <span class="org-builtin">:sort</span> nil <span class="org-builtin">:prompt</span> <span class="org-string">"Category: "</span> <span class="org-builtin">:initial</span> initial))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-guess-category</span> ()
  (<span class="org-keyword">save-excursion</span>
    (org-back-to-heading)
    (org-end-of-meta-data)
    (<span class="org-keyword">let</span> ((text (buffer-substring-no-properties (point) (org-end-of-subtree))))
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"#gardening"</span> text)
          <span class="org-string">"Household"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-post</span> (note <span class="org-type">&amp;rest</span> plist)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Note: "</span>)
                     <span class="org-builtin">:Date</span> (concat (org-read-date <span class="org-string">"Date: "</span>) <span class="org-string">" 23:00"</span>)
                     <span class="org-builtin">:Category</span> (my-journal-read-category (<span class="org-keyword">condition-case</span> nil (my-journal-guess-category) (<span class="org-warning">error</span> nil)))
                     <span class="org-builtin">:Other</span> (read-string <span class="org-string">"Other: "</span>)))
  (<span class="org-keyword">setq</span> plist (append `(<span class="org-builtin">:Note</span> ,note) plist))
  (<span class="org-keyword">let</span> ((url-request-method <span class="org-string">"POST"</span>)
        (url-request-extra-headers '((<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>)))
        (json-object-type 'plist)
        (url-request-data (encode-coding-string (json-encode-plist plist) 'utf-8))
        data)
    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously (concat my-journal-url <span class="org-string">"/api/entries"</span>))
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"^$"</span>)
      (<span class="org-keyword">setq</span> data (json-read))
      (message <span class="org-string">"%s"</span> (plist-get data <span class="org-builtin">:ZIDString</span>))
      data)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-get-by-zidstring</span> (zidstring)
  (my-journal-get (concat <span class="org-string">"api/entries/"</span> zidstring)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-insert-ref</span> (zidstring)
  (<span class="org-keyword">interactive</span> (list (my-journal-completing-read)))
  (insert (org-link-make-string (concat <span class="org-string">"ref:"</span> (my-journal-id-from-string zidstring)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-edit</span> (zidstring)
  (<span class="org-keyword">interactive</span> (list (my-journal-completing-read)))
  (<span class="org-keyword">let*</span> ((id (my-journal-id-from-string zidstring))
         (entry (<span class="org-keyword">and</span> id (my-journal-get-by-zidstring id))))
    (<span class="org-keyword">if</span> (null id)
        (my-journal-post zidstring
                         <span class="org-builtin">:Category</span> (my-journal-read-category (plist-get entry <span class="org-builtin">:Category</span>))
                         <span class="org-builtin">:Other</span> (read-string <span class="org-string">"Other: "</span> (plist-get entry <span class="org-builtin">:Other</span>)))
      (plist-put entry <span class="org-builtin">:Note</span> (read-string (format <span class="org-string">"Note (%s): "</span> (plist-get entry <span class="org-builtin">:Note</span>))))
      (plist-put entry <span class="org-builtin">:Category</span> (my-journal-read-category (plist-get entry <span class="org-builtin">:Category</span>)))
      (plist-put entry <span class="org-builtin">:Other</span> (read-string <span class="org-string">"Other: "</span> (plist-get entry <span class="org-builtin">:Other</span>)))
      (my-journal-update entry))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-update</span> (plist)
  <span class="org-doc">"Update journal entry using PLIST."</span>
  (<span class="org-keyword">let</span> ((url-request-method <span class="org-string">"PUT"</span>)
        (url-request-data (json-encode-plist plist)))
    (my-json-request (concat my-journal-url <span class="org-string">"/api/entries/"</span> (plist-get plist <span class="org-builtin">:ZIDString</span>)))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">(my-journal-post "Hello, world")</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-get-entries</span> (<span class="org-type">&amp;optional</span> from to search)
  <span class="org-doc">"Return parsed CSV of entries limited by FROM, TO, and SEARCH."</span>
  (<span class="org-keyword">with-current-buffer</span>
      (url-retrieve-synchronously (format <span class="org-string">"%s/api/entries.csv?from=%s&amp;to=%s&amp;regex=1&amp;q=%s"</span>
                                          my-journal-url
                                          (<span class="org-keyword">or</span> from <span class="org-string">""</span>)
                                          (<span class="org-keyword">or</span> to <span class="org-string">""</span>)
                                          (<span class="org-keyword">or</span> search <span class="org-string">""</span>)))
    (goto-char (point-min))
    (delete-region (point-min) (search-forward <span class="org-string">"\n\n"</span>))
    (cdr (pcsv-parse-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-get</span> (url) (my-json-request (concat my-journal-url <span class="org-string">"/"</span> url)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-get-entry</span> (zid) (my-journal-get (format <span class="org-string">"api/entries/zid/%s"</span> zid)))
</pre>
</div>

<p>
The following code lets me complete journal entries and get their ZIDs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orga299f45">(<span class="org-keyword">defun</span> <span class="org-function-name">my-json-request</span> (url)
  (<span class="org-keyword">let</span> ((json-object-type 'plist)
        (url-request-extra-headers (cons '(<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>) url-request-extra-headers)))
    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"^$"</span> nil t)
      (json-read))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-journal-search-cache</span> nil <span class="org-doc">"List of search results."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-search-query</span> (query-str)
  (<span class="org-keyword">let*</span> ((url-request-method <span class="org-string">"GET"</span>)
         (json-response (my-journal-get (format <span class="org-string">"api/entries?q=%s&amp;limit=50&amp;sort=date&amp;regex=1"</span>
                                                 query-str))))
    (<span class="org-keyword">setq</span> my-journal-search-cache (mapcar (<span class="org-keyword">lambda</span> (o)
              (cons
               (format <span class="org-string">"%s %s"</span>
                       (plist-get o <span class="org-builtin">:ZIDString</span>)
                       (plist-get o <span class="org-builtin">:Note</span>))
               o))
            json-response))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-search-query-async</span> (query-str next)
  (<span class="org-keyword">let*</span> ((url-request-method <span class="org-string">"GET"</span>)
         (url-request-extra-headers (cons '(<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>) url-request-extra-headers)))
    (url-retrieve
     (format <span class="org-string">"%s/api/entries?q=%s&amp;limit=50&amp;sort=date&amp;regex=1"</span>
             my-journal-url
       query-str)
     (<span class="org-keyword">lambda</span> (status)
       (goto-char (point-min))
       (re-search-forward <span class="org-string">"^$"</span> nil t)
       (<span class="org-keyword">setq</span> my-journal-search-cache
             (mapcar (<span class="org-keyword">lambda</span> (o)
                       (cons
                        (format <span class="org-string">"%s %s"</span>
                                (plist-get o <span class="org-builtin">:ZIDString</span>)
                                (plist-get o <span class="org-builtin">:Note</span>))
                        o))
                     (<span class="org-keyword">let</span> ((json-object-type 'plist))
                       (json-read))))
       (funcall next 'flush)
       (<span class="org-keyword">if</span> my-journal-search-cache (funcall next my-journal-search-cache))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal--async-search</span> (next)
  (<span class="org-keyword">lambda</span> (action)
    (<span class="org-keyword">cond</span>
     ((eq action 'setup)                <span class="org-comment-delimiter">;; </span><span class="org-comment">Should figure out how to start</span>
      (my-journal-search-query-async <span class="org-string">""</span> next))
     ((<span class="org-keyword">and</span> (stringp action) (not (string= action <span class="org-string">""</span>)))
      (my-journal-search-query-async action next))
     (t (funcall next action)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-completing-read</span> ()
  (<span class="org-keyword">interactive</span>)
  (consult--read
   (<span class="org-keyword">thread-first</span> (consult--async-sink)
     (consult--async-refresh-immediate)
     (my-journal--async-search)
     (consult--async-throttle)
     (consult--async-split))
   <span class="org-builtin">:sort</span> nil
   <span class="org-builtin">:prompt</span> <span class="org-string">"Entry: "</span>
   <span class="org-builtin">:category</span> 'journal))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-id-from-string</span> (s)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"^[-0-9]+"</span> s) (match-string 0 s)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-view</span> (s)
  (<span class="org-keyword">interactive</span> (list (my-journal-completing-read)))
  (my-org-journal-open (my-journal-id-from-string s)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-sketch-large</span> (zid)
  <span class="org-doc">"Create a large sketch based on ZID."</span>
  (<span class="org-keyword">interactive</span> (list (my-journal-completing-read)))
  (<span class="org-keyword">let</span> ((filename (expand-file-name (format <span class="org-string">"%s.psd"</span>
                                             (my-journal-id-from-string zid))
                                    my-sketch-inbox-directory)))
    (<span class="org-keyword">unless</span> (file-exists-p filename)
      (copy-file my-sketch-large-template-file filename))
    (my-org-sketch-open filename)))
</pre>
</div>

<p>
I should probably figure out how to switch this over to my Consult-based workflow:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-format-entry</span> (type o)
  (<span class="org-keyword">cond</span>
   ((eq type 'org-link-zid-only)
    (org-link-make-string (format <span class="org-string">"journal:%s"</span> (cdr (assoc 'ZIDString o)))))
   ((eq type 'list-item-with-zid)
    (format <span class="org-string">"- %s (%s)\n"</span>
            (assoc-default 'Note o)
            (org-link-make-string
             (format <span class="org-string">"journal:%s"</span> (assoc-default 'ZIDString o)))))
   ((eq type 'list-item)
    (format <span class="org-string">"- %s\n"</span> (assoc-default 'Note o)))
   ((eq type 'text)
    (assoc-default 'Note o))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-format-entries</span> (type list)
  (mapconcat
   (<span class="org-keyword">lambda</span> (o) (my-journal-format-entry type o))
   (reverse list)
   (<span class="org-keyword">cond</span>
    ((eq type 'org-link-zid-only) <span class="org-string">", "</span>)
    ((eq type 'list-item-with-zid) <span class="org-string">""</span>)
    ((eq type 'list-item) <span class="org-string">""</span>)
    ((eq type 'text) <span class="org-string">" "</span>))))
</pre>
</div>

<p>
This lets me define a custom link type.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-journal-open</span> (id <span class="org-type">&amp;optional</span> arg)
  (browse-url (format <span class="org-string">"%s/zid/%s"</span> my-journal-url id)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-journal-export</span> (link description format <span class="org-type">&amp;optional</span> arg)
  (<span class="org-keyword">let*</span> ((path (concat <span class="org-string">"%s/zid/"</span> my-journal-url link))
         (image (concat <span class="org-string">"%s/zid/"</span> my-journal-url link))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">cond</span>
     ((<span class="org-keyword">or</span> (eq format 'html) (eq format 'wp))
      (<span class="org-keyword">if</span> description
          (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc)
        (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;&lt;img src=\"%s\"&gt;&lt;br /&gt;%s&lt;/a&gt;"</span> path image desc)))
     ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
     ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
     ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
     (t path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-journal-complete</span> (<span class="org-type">&amp;optional</span> prefix)
  (cdr (assoc 'ZIDString (helm-comp-read <span class="org-string">"Entry: "</span> 'my-helm-journal-search <span class="org-builtin">:volatile</span> t))))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"journal"</span>
   <span class="org-builtin">:follow</span> 'my-org-journal-open
   <span class="org-builtin">:export</span> 'my-org-journal-export
   <span class="org-builtin">:complete</span> 'my-org-journal-complete))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-journal-summarize</span> (from to <span class="org-type">&amp;optional</span> search category-map categories)
  (my-org-group-journal-entries (my-journal-get-entries from to search) category-map categories))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-journal-format-tree</span> (groups <span class="org-type">&amp;optional</span> include)
  (mapconcat
   (<span class="org-keyword">lambda</span> (o)
     (concat <span class="org-string">"- *"</span> (car o) <span class="org-string">"*\n"</span>
             (mapconcat
              (<span class="org-keyword">lambda</span> (i)
                (concat <span class="org-string">"  - "</span>
                        (<span class="org-keyword">if</span> (member 'date include) (concat (my-journal-date i) <span class="org-string">" "</span>) <span class="org-string">""</span>)
                        (replace-regexp-in-string <span class="org-string">"\\\""</span> <span class="org-string">"\""</span> (my-journal-note i))
                        (<span class="org-keyword">if</span> (member 'zid include) (concat <span class="org-string">" "</span> (my-journal-zidstring i)) <span class="org-string">""</span>)
                        <span class="org-comment-delimiter">;; </span><span class="org-comment">(if (string= "" (my-journal-category i))</span>
                        <span class="org-comment-delimiter">;;     </span><span class="org-comment">""</span>
                        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(format " (%s)" (my-journal-category i)))</span>
                        <span class="org-string">"\n"</span>))
              (reverse (cdr o)) <span class="org-string">""</span>)))
   groups <span class="org-string">""</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-summarize-journal-csv</span> (from to <span class="org-type">&amp;optional</span> search category-map categories include)
  (<span class="org-keyword">interactive</span>
   (list (org-read-date nil nil nil <span class="org-string">"From: "</span>)
         (org-read-date nil nil nil <span class="org-string">"To: "</span>)
         (read-string <span class="org-string">"Search: "</span>)
         my-journal-category-map
         my-journal-categories
         nil))
  (<span class="org-keyword">let</span> ((list (my-org-journal-format-tree
               (my-org-group-journal-entries
                (my-journal-get-entries from to search)
                category-map categories)
               include)))
    (<span class="org-keyword">if</span> (called-interactively-p 'any) (insert list) list)))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-read-journal-category</span> ()
  (completing-read <span class="org-string">"Category: "</span> my-journal-categories))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-update-journal-entry</span> (old-text new-text category)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Old: "</span>)
                     (read-string <span class="org-string">"New: "</span>)
                     (my-read-journal-category)))
  (my-send-intent <span class="org-string">"com.sachachua.journal.categorize"</span>
                  (list (cons <span class="org-string">"text"</span> old-text)
                        (cons <span class="org-string">"newtext"</span> (<span class="org-keyword">or</span> new-text old-text))
                        (cons <span class="org-string">"category"</span> (<span class="org-keyword">or</span> category <span class="org-string">"Uncategorized"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-create-journal-entry</span> (new-text category)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Text: "</span>)
                     (my-read-journal-category)))
  (my-update-journal-entry new-text new-text category))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-export-journal-entries</span> ()
  <span class="org-doc">"Trigger task to export. Phone must be unlocked."</span>
  (<span class="org-keyword">interactive</span>)
  (my-send-intent <span class="org-string">"com.sachachua.journal.export"</span> '((<span class="org-string">"a"</span> . <span class="org-string">"b"</span>))))

(<span class="org-keyword">use-package</span> csv
  <span class="org-builtin">:commands</span> csv--read-line)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-prompt-for-uncategorized-entries</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((key-list '(<span class="org-string">"Note"</span> <span class="org-string">"Date"</span> <span class="org-string">"highlight week"</span> <span class="org-string">"Category"</span> <span class="org-string">"month"</span> <span class="org-string">"Time"</span> <span class="org-string">"Link"</span> <span class="org-string">"ELECT"</span>))
        x new-text category done)
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not (eobp)) (not done))
      (forward-char 1)
      (<span class="org-keyword">setq</span> x (csv--read-line key-list))
      (<span class="org-keyword">when</span> (string= (assoc-default <span class="org-string">"Category"</span> x nil <span class="org-string">""</span>) <span class="org-string">""</span>)
        (<span class="org-keyword">setq</span> text (read-string <span class="org-string">"Text: "</span> (assoc-default <span class="org-string">"Note"</span> x nil <span class="org-string">""</span>)))
        (<span class="org-keyword">setq</span> category (completing-read <span class="org-string">"Category: "</span> (cons <span class="org-string">"."</span> my-journal-categories)))
        (<span class="org-keyword">if</span> (string= category <span class="org-string">"."</span>)
            (<span class="org-keyword">setq</span> done t)
          (my-update-journal-entry (assoc-default <span class="org-string">"Note"</span> x nil <span class="org-string">""</span>) text category))))))
</pre>
</div>
</div>
<div id="outline-container-working-with-journal-entries" class="outline-4">
<h4 id="working-with-journal-entries">Working with journal entries</h4>
<div class="outline-text-4" id="text-working-with-journal-entries">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-insert-matching-entries</span> (from to match)
  (<span class="org-keyword">interactive</span> (list (org-read-date <span class="org-string">"From: "</span>) (org-read-date <span class="org-string">"To: "</span>) (read-string <span class="org-string">"Match: "</span>)))
  (insert
  (mapconcat
   (<span class="org-keyword">lambda</span> (o)
     (format <span class="org-string">"- %s %s"</span> (my-journal-zidstring o) (my-journal-note o)))
   (seq-filter (<span class="org-keyword">lambda</span> (o) (string-match match (my-journal-other o)))
    (my-journal-get-entries from to))
   <span class="org-string">"\n"</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-convert-to-refs</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-restriction</span>
    (goto-char beg)
    (narrow-to-region beg end)
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^- </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> .*?$"</span> nil t)
      (replace-match <span class="org-string">"ref:\\1"</span>))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-get-refs-from-region</span> (beg end)
    (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
    (<span class="org-keyword">save-excursion</span>
      (goto-char beg)
      (<span class="org-keyword">cl-loop</span> for pos = (re-search-forward <span class="org-string">" </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> "</span> end t)
               while pos
               collect (match-string 1))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-add-tag</span> (tag beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTag: \nr"</span>)
  (<span class="org-keyword">let*</span> ((url-request-method <span class="org-string">"POST"</span>)
         (url-request-extra-headers '((<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>)))
         (zids (my-journal-get-refs-from-region beg end))
         (json-object-type 'plist)
         (url-request-data (json-encode-plist (list <span class="org-builtin">:zids</span> zids <span class="org-builtin">:tags</span> (split-string tag <span class="org-string">" "</span>)))))
    (pp (my-journal-get <span class="org-string">"api/entries/tag/bulk"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-remove-tag</span> (tag beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTag: \nr"</span>)
  (<span class="org-keyword">let*</span> ((url-request-method <span class="org-string">"DELETE"</span>)
         (url-request-extra-headers '((<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>)))
         (zids (my-journal-get-refs-from-region beg end))
         (json-object-type 'plist)
         (url-request-data (json-encode-plist (list <span class="org-builtin">:zids</span> zids <span class="org-builtin">:tags</span> (split-string tag <span class="org-string">" "</span>)))))
    (pp (my-journal-get <span class="org-string">"api/entries/tag/bulk"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-post-with-refs</span> (note date other beg end)
  (<span class="org-keyword">interactive</span> (list
                (read-string <span class="org-string">"Note: "</span>)
                (concat (org-read-date <span class="org-string">"Date: "</span>) <span class="org-string">" 23:00"</span>)
                (read-string <span class="org-string">"Other: "</span>)
                (min (point) (mark))
                (max (point) (mark))))
  (my-journal-post note <span class="org-builtin">:Date</span> date <span class="org-builtin">:Other</span> (concat other <span class="org-string">"\n"</span>
                                                  (mapconcat (<span class="org-keyword">lambda</span> (o) (concat <span class="org-string">"ref:"</span> o))
                                                             (my-journal-get-refs-from-region beg end)
                                                             <span class="org-string">" "</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-tagging-journal-entries" class="outline-4">
<h4 id="tagging-journal-entries">Tagging journal entries</h4>
<div class="outline-text-4" id="text-tagging-journal-entries">
<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-list-toggle-monthly-highlight</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((entry (tabulated-list-get-entry)))
    (<span class="org-keyword">setf</span> (elt entry 3) (<span class="org-keyword">if</span> (string-match <span class="org-string">"#monthly-highlight"</span> (elt entry 3))
                            (replace-regexp-in-string <span class="org-string">" ?#monthly-highlight"</span> <span class="org-string">""</span> (elt entry 3))
                          (string-trim (concat (elt entry 3) <span class="org-string">" #monthly-highlight"</span>))))
    (my-journal-update
     (list <span class="org-builtin">:ZIDString</span> (elt entry 0)
           <span class="org-builtin">:Other</span> (elt entry 3)))
    (tabulated-list-print t t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-list-echo</span> ()
  (<span class="org-keyword">interactive</span>)
  (message <span class="org-string">"%s -- %s"</span> (elt (tabulated-list-get-entry) 2) (elt (tabulated-list-get-entry) 3)))

(<span class="org-keyword">defvar-keymap</span> my-journal-list-mode-map
  <span class="org-builtin">:parent</span> tabulated-list-mode-map
  <span class="org-string">"t"</span> #'my-journal-list-toggle-monthly-highlight
  <span class="org-string">"v"</span> #'my-journal-list-echo)

(<span class="org-keyword">define-derived-mode</span> <span class="org-function-name">my-journal-list-mode</span> tabulated-list-mode <span class="org-string">"Journal"</span>
  <span class="org-doc">"Major mode for journal entries."</span>
  (<span class="org-keyword">setq</span> tabulated-list-format [(<span class="org-string">"ZID"</span> 14 t)
                               (<span class="org-string">"Category"</span> 10 t)
                               (<span class="org-string">"Note"</span> 80 nil)
                               (<span class="org-string">"Other"</span> 30 nil)])
  (tabulated-list-init-header)
  (tabulated-list-print t))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-list</span> (start end filter)
  (<span class="org-keyword">interactive</span> (list (org-read-date <span class="org-string">"Start: "</span>) (org-read-date <span class="org-string">"End: "</span>)
                     (read-string <span class="org-string">"Filter: "</span>)))
  (switch-to-buffer (get-buffer-create <span class="org-string">"*journal*"</span>))
  (<span class="org-keyword">setq</span> tabulated-list-entries
        (mapcar
         (<span class="org-keyword">lambda</span> (row)
           (list
            (my-journal-zidstring row)
            (vector
             (my-journal-zidstring row)
             (my-journal-category row)
             (replace-regexp-in-string <span class="org-string">"\n"</span> <span class="org-string">" "</span> (my-journal-note row))
             (replace-regexp-in-string <span class="org-string">"\n"</span> <span class="org-string">" "</span> (my-journal-other row)))))
         (my-journal-get-entries start end filter)))
  (my-journal-list-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-photos" class="outline-4">
<h4 id="photos">Photos</h4>
<div class="outline-text-4" id="text-photos">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-image-caption</span> (file)
  (<span class="org-keyword">let</span> ((caption (shell-command-to-string (format <span class="org-string">"exiftool -s -s -s -ImageDescription %s"</span> (shell-quote-argument file)))))
    (<span class="org-keyword">when</span> (&gt; (length caption) 0) (format <span class="org-string">"#+CAPTION: %s"</span> caption))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-image-link-with-caption</span> (file)
  (<span class="org-keyword">let</span> ((caption (my-get-image-caption file)))
    (insert (<span class="org-keyword">or</span> caption <span class="org-string">""</span>) (org-link-make-string file) <span class="org-string">"\n"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-caption-current-image</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((link (org-element-link-parser)) caption)
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> link (org-element-property <span class="org-builtin">:path</span> link))
      (<span class="org-keyword">setq</span> caption (my-get-image-caption (org-element-property <span class="org-builtin">:path</span> link)))
      (<span class="org-keyword">when</span> caption (insert caption)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-set-image-caption</span> (file caption)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode) (dired-get-filename) (buffer-file-name))
                     (read-string <span class="org-string">"Caption: "</span>)))
  (shell-command (format <span class="org-string">"exiftool -ImageDescription=\"%s\" %s"</span> (shell-quote-argument caption) (shell-quote-argument file))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-photo-directory</span> <span class="org-string">"/mnt/nfs/photos/inbox"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-photo-rating</span> (file)
  (<span class="org-keyword">let</span> ((rating (shell-command-to-string (concat <span class="org-string">"exiftool -s -s -s -Rating "</span> (shell-quote-argument file)))))
    (string-to-number rating)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-make-photo-list</span> (start end <span class="org-type">&amp;optional</span> rating require-description)
  (<span class="org-keyword">interactive</span> (list (org-read-date <span class="org-string">"Start: "</span>) (org-read-date <span class="org-string">"End: "</span>)))
  (-filter
   (<span class="org-keyword">lambda</span> (filename)
     (<span class="org-keyword">and</span> (string&gt; (file-name-nondirectory filename) start)
          (string&gt; end (file-name-nondirectory filename))
          (<span class="org-keyword">if</span> rating (&gt;= (my-get-photo-rating filename) rating) t)
          (<span class="org-keyword">if</span> require-description (my-get-image-caption filename) t)))
   (directory-files my-photo-directory t <span class="org-string">".*\\.jpg$"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-get-photo</span> (id)
  <span class="org-doc">"Open the photo identified by ID."</span>
  (car (directory-files my-photo-directory t (concat id <span class="org-string">".*\\.jpg"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-open-photo</span> (id)
  (find-file (my-org-get-photo id)))

                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(my-make-photo-list "2018-06-10" "2018-06-15" nil t)</span>
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(my-get-photo-rating  (my-org-get-photo "2018-06-10-18-16-31"))</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-significant-moments</span> (start end <span class="org-type">&amp;optional</span> rating)
  (<span class="org-keyword">interactive</span> (list (org-read-date <span class="org-string">"Start: "</span>) (org-read-date <span class="org-string">"End: "</span>) 3))
  (<span class="org-keyword">let</span> ((result
         (mapconcat (<span class="org-keyword">lambda</span> (file)
                      (<span class="org-keyword">let</span> ((caption (my-get-image-caption file)))
                        (<span class="org-keyword">if</span> caption
                            (concat caption (org-link-make-string file) <span class="org-string">"\n"</span>)
                          (concat (org-link-make-string file) <span class="org-string">"\n"</span>))))
                    (my-make-photo-list start end 3)
                    <span class="org-string">"\n"</span>)))
    (<span class="org-keyword">if</span> (called-interactively-p 'any) (insert result) result)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org4194d48" class="outline-4">
<h4 id="org4194d48">Moments</h4>
<div class="outline-text-4" id="text-org4194d48">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-moments</span> (date)
  (<span class="org-keyword">interactive</span> (list (org-read-date <span class="org-string">"Start: "</span>)))
  (my-journal-post (concat <span class="org-string">"Moments starting "</span> date <span class="org-string">" #moment"</span>) <span class="org-builtin">:Date</span> (concat date <span class="org-string">" 23:00"</span>) <span class="org-builtin">:Category</span> <span class="org-string">"Thoughts"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-org1be12ae" class="outline-4">
<h4 id="org1be12ae">Slicing and dicing the journal entries</h4>
<div class="outline-text-4" id="text-org1be12ae">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-filter-by-category</span> (category list)
  (reverse (seq-filter (<span class="org-keyword">lambda</span> (o) (string= (my-journal-category o) <span class="org-string">"Eating"</span>))
                       list)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-group-by-month</span> (list)
  (seq-group-by (<span class="org-keyword">lambda</span> (o)
                  (substring (my-journal-date o) 0 7))
                list))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-filter-by-month</span> (month-regexp list)
  (seq-filter (<span class="org-keyword">lambda</span> (o)
                (string-match month-regexp
                              (substring (my-journal-date o) 5 7)))
                list))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-group-by-month-day</span> (list)
  (seq-group-by (<span class="org-keyword">lambda</span> (o)
                  (substring (my-journal-date o) 5))
                list))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-list-with-day</span> (list)
  (mapconcat (<span class="org-keyword">lambda</span> (o)
               (concat <span class="org-string">"  - "</span> (substring (my-journal-date o) 8) <span class="org-string">" "</span>
                       (replace-regexp-in-string <span class="org-string">"#.*"</span> <span class="org-string">""</span> (my-journal-note o))))
             list
             <span class="org-string">"\n"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-list-with-year</span> (list)
  (mapconcat (<span class="org-keyword">lambda</span> (o)
               (concat <span class="org-string">"  - "</span> (substring (my-journal-date o) 0 4) <span class="org-string">" "</span>
                       (replace-regexp-in-string <span class="org-string">"#.*"</span> <span class="org-string">""</span> (my-journal-note o))))
             list
             <span class="org-string">"\n"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-journal-this-month-by-day</span> (list)
  (mapconcat (<span class="org-keyword">lambda</span> (group)
               (format
                <span class="org-string">"- %s\n%s"</span>
                (car group)
                (my-journal-list-with-year (cdr group))))
             (cl-sort
              (my-journal-group-by-month-day
               (my-journal-filter-by-month (format-time-string <span class="org-string">"%02m"</span>)
                                           list))
            'string&lt;
            <span class="org-builtin">:key</span> #'car)
           <span class="org-string">"\n"</span>))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-attachments" class="outline-3">
<h3 id="attachments">Attachments</h3>
<div class="outline-text-3" id="text-attachments">
<p>
Org lets you attach files to an Org file. Haven't gotten the hang of this yet, but looks interesting.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org-attach
  <span class="org-builtin">:ensure</span> nil
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-attach-store-link-p 'attached)
  (<span class="org-keyword">setq</span> org-attach-auto-tag nil))

</pre>
</div>
</div>
</div>
<div id="outline-container-http" class="outline-3">
<h3 id="http">HTTP</h3>
<div class="outline-text-3" id="text-http">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ob-http)
</pre>
</div>
</div>
</div>
<div id="outline-container-lilypond" class="outline-3">
<h3 id="lilypond">Lilypond</h3>
<div class="outline-text-3" id="text-lilypond">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> lilypond-init
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/lilypond/elisp"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-babel-lilypond-arrange-mode t
        org-babel-lilypond-commands '(<span class="org-string">"lilypond"</span> <span class="org-string">"timidity"</span> <span class="org-string">"timidity"</span>)
        org-babel-lilypond-gen-pdf nil
        org-babel-lilypond-display-pdf-post-tangle nil)
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.ly\\'"</span> . LilyPond-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-diagrams-and-graphics" class="outline-3">
<h3 id="diagrams-and-graphics">Diagrams and graphics</h3>
<div class="outline-text-3" id="text-diagrams-and-graphics">
<p>
Ooooh. Graphviz and Ditaa make it easier to create diagrams from Emacs. See <a href="http://sachachua.com/evil-plans">http://sachachua.com/evil-plans</a> for examples and source.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ob-mermaid)
(<span class="org-keyword">setq</span> org-ditaa-jar-path <span class="org-string">"c:/sacha/Dropbox/bin/ditaa.jar"</span>)
(<span class="org-keyword">setq</span> org-startup-with-inline-images t)
(<span class="org-keyword">use-package</span> org-contrib)
(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (add-hook 'org-babel-after-execute-hook 'org-display-inline-images)
  (<span class="org-keyword">setq</span> org-confirm-babel-evaluate nil)
  (<span class="org-keyword">setq</span> org-link-elisp-confirm-function
        (<span class="org-keyword">lambda</span> (prompt)
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (buffer-file-name) (string-match <span class="org-string">"vendor"</span> (buffer-file-name)))
              (y-or-n-p prompt)
            t)))
  (<span class="org-keyword">require</span> '<span class="org-constant">ob-ledger</span>)
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((dot . t)
     (ditaa . t)
     (gnuplot . t)
     (mermaid . t)
     (emacs-lisp . t)
     (plantuml . t)
     (lilypond . t)
     (python . t)
     (shell . t)
     (calc . t)
     (js . t)
     (sqlite . t)
     (http . t)
     (ledger . t)
     (shell . t)
     (R . t)))
  (<span class="org-keyword">setq</span> org-babel-python-command <span class="org-string">"python3"</span>)
  (<span class="org-keyword">setq</span> python-shell-interpreter <span class="org-string">"python3"</span>)
  (add-to-list 'org-src-lang-modes '(<span class="org-string">"dot"</span> . graphviz-dot)))
</pre>
</div>
</div>
</div>
<div id="outline-container-counting" class="outline-3">
<h3 id="counting">Counting</h3>
<div class="outline-text-3" id="text-counting">
<p>
Good way to remind myself that I have lots of STARTED tasks.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-summarize-task-status</span> ()
  <span class="org-doc">"Count number of tasks by status.</span>
<span class="org-doc">      Probably should make this a dblock someday."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (result)
    (org-map-entries
     (<span class="org-keyword">lambda</span> ()
       (<span class="org-keyword">let</span> ((todo (elt (org-heading-components) 2)))
         (<span class="org-keyword">if</span> todo
             (<span class="org-keyword">if</span> (assoc todo result)
                 (setcdr (assoc todo result)
                         (1+ (cdr (assoc todo result))))
               (<span class="org-keyword">setq</span> result (cons (cons todo 1) result)))))))
    (message <span class="org-string">"%s"</span> (mapconcat (<span class="org-keyword">lambda</span> (x) (format <span class="org-string">"%s: %d"</span> (car x) (cdr x)))
                             result <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-spreadsheets" class="outline-3">
<h3 id="spreadsheets">Spreadsheets</h3>
<div class="outline-text-3" id="text-spreadsheets">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-days-between</span> (start end)
  <span class="org-doc">"Number of days between START and END (exclusive).</span>
<span class="org-doc">      This includes START but not END."</span>
  (- (calendar-absolute-from-gregorian (org-date-to-gregorian end))
     (calendar-absolute-from-gregorian (org-date-to-gregorian start))))
</pre>
</div>
</div>
</div>
<div id="outline-container-literate-programming" class="outline-3">
<h3 id="literate-programming">Literate programming</h3>
<div class="outline-text-3" id="text-literate-programming">
</div>
<div id="outline-container-editing-source-code" class="outline-4">
<h4 id="editing-source-code">Editing source code</h4>
<div class="outline-text-4" id="text-editing-source-code">
<p>
I don't want to get distracted by the same code in the other window, so I want org src to use the current window.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-src-window-setup 'current-window)
</pre>
</div>
</div>
</div>
<div id="outline-container-copying-and-sharing-code" class="outline-4">
<h4 id="copying-and-sharing-code">Copying and sharing code</h4>
<div class="outline-text-4" id="text-copying-and-sharing-code">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-code-as-org-block-and-gist</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((filename (<span class="org-keyword">or</span> (file-name-base) <span class="org-string">""</span>))
        (mode (symbol-name major-mode))
        (contents
         (<span class="org-keyword">if</span> (use-region-p) (buffer-substring beg end) (buffer-string)))
        (gist (<span class="org-keyword">if</span> (use-region-p) (gist-region beg end) (gist-buffer))))
    (kill-new
     (format <span class="org-string">"\n%s\n#+begin_src %s\n%s\n#+end_src\n"</span>
             (org-link-make-string (<span class="org-keyword">oref</span> (<span class="org-keyword">oref</span> gist <span class="org-builtin">:data</span>) <span class="org-builtin">:html-url</span>) filename)
             (replace-regexp-in-string <span class="org-string">"-mode$"</span> <span class="org-string">""</span> mode)
             contents))))
</pre>
</div>
</div>
</div>
<div id="outline-container-tables" class="outline-4">
<h4 id="tables">Tables</h4>
<div class="outline-text-4" id="text-tables">
<p>
Requires dash.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-table-as-alist</span> (table)
  <span class="org-doc">"Convert TABLE to an alist. Remember to set :colnames no."</span>
  (<span class="org-keyword">let</span> ((headers (seq-map 'intern (car table))))
    (<span class="org-keyword">cl-loop</span> for x in (cdr table) collect (-zip headers x))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-invoices" class="outline-3">
<h3 id="invoices">Invoices</h3>
<div class="outline-text-3" id="text-invoices">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> calendar-week-start-day 6) <span class="org-comment-delimiter">;; </span><span class="org-comment">My weeks start on Saturday</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-get-invoice-range-based-on-date</span> (date)
  (<span class="org-keyword">let*</span> ((invoice-date (org-date-to-gregorian date))
         (start (list (1- (car invoice-date)) 1 (elt invoice-date 2)))
         (end (list (car invoice-date) 1 (elt invoice-date 2))))
    (mapcar (<span class="org-keyword">lambda</span> (date)
              (format-time-string <span class="org-string">"%F %H:%M"</span> (encode-time 0 0 0 1 (elt date 0) (elt date 2))))
            (list start end))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-quantified-get-hours-based-on-range</span> (category start end)
  <span class="org-doc">"Return the number of hours for the specified category."</span>
  (/ (assoc-default category
                    (quantified-summarize-time start end)) <span class="org-warning">3600.0))</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">TODO: paginate</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-quantified-get-detailed-hours-based-on-range</span> (category start end)
  <span class="org-doc">"Return a list of (date week-ending-date dow seconds) for CATEGORY from START to END."</span>
  (<span class="org-keyword">let</span> ((entries
         (gethash <span class="org-string">"entries"</span>
                  (quantified-parse-json
                   (quantified-request (format <span class="org-string">"records.json?start=%s&amp;end=%s&amp;filter_string=%s&amp;per_page=1000&amp;split=split"</span> start end (url-encode-url category))
                                       nil <span class="org-string">"GET"</span>)))))
    (mapcar
     (<span class="org-keyword">lambda</span> (entry)
       (<span class="org-keyword">let</span> ((time (date-to-time (gethash <span class="org-string">"timestamp"</span> entry))))
         (list
          (format-time-string <span class="org-string">"%F"</span> time)
          (format-time-string <span class="org-string">"%F"</span> (my-get-week-end-for-time time))
          (format-time-string <span class="org-string">"%a"</span> time)
          (gethash <span class="org-string">"duration"</span> entry))))
     entries)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-week-end-for-time</span> (time <span class="org-type">&amp;optional</span> week-ends-on-day)
  <span class="org-doc">"WEEK-ENDS-ON-DAY: 0 is Sunday"</span>
  (<span class="org-keyword">let*</span> ((decoded (decode-time time))
         (dow (elt decoded 6))
         (end-week (<span class="org-keyword">or</span> week-ends-on-day (% (+ 6 calendar-week-start-day) 7))))
    (encode-time
     (elt decoded 0)
     (elt decoded 1)
     (elt decoded 2)
     (+ (elt decoded 3)
        (% (+ 7 (- end-week dow)) 7))
     (elt decoded 4)
     (elt decoded 5))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-get-week-ending-date</span> ()
  (<span class="org-keyword">let</span> ((calendar-week-start-day 6)
        (tests '(
                 (<span class="org-string">"2015-09-03"</span> . <span class="org-string">"2015-09-04"</span>)
                 (<span class="org-string">"2015-12-01"</span> . <span class="org-string">"2015-12-04"</span>)
                 (<span class="org-string">"2015-12-03"</span> . <span class="org-string">"2015-12-04"</span>)
                 (<span class="org-string">"2015-12-04"</span> . <span class="org-string">"2015-12-04"</span>)
                 (<span class="org-string">"2015-12-05"</span> . <span class="org-string">"2015-12-11"</span>))))
    (<span class="org-keyword">dolist</span> (test tests)
      (should (string=
               (format-time-string
                <span class="org-string">"%F"</span>
                (my-get-week-end-for-time (org-time-string-to-time (car test))))
               (cdr test)))
      (should (string=
               (format-time-string
                <span class="org-string">"%F"</span>
                (my-get-week-end-for-time (org-time-string-to-time (car test)) 5))
               (cdr test))))))



(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-quantified-format-detailed-hours-as-table</span> (list)
  <span class="org-doc">"Return a table with rows for LIST.</span>
<span class="org-doc">        | Week ending ____ | Sat | Sun | Mon | Tue | Wed | Thu | Fri | Total |</span>
<span class="org-doc">        LIST elements should be in the form (date week-end-date dow seconds).</span>
<span class="org-doc">        See `</span><span class="org-doc"><span class="org-constant">my-org-quantified-get-detailed-hours-based-on-range</span></span><span class="org-doc">'."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Group by week ending date</span>
  (<span class="org-keyword">let</span> ((days '(<span class="org-string">"Sat"</span> <span class="org-string">"Sun"</span> <span class="org-string">"Mon"</span> <span class="org-string">"Tue"</span> <span class="org-string">"Wed"</span> <span class="org-string">"Thu"</span> <span class="org-string">"Fri"</span>)))
    (append
     (list (append '(<span class="org-string">"Week ending"</span>) days '(<span class="org-string">"Total"</span>)))
     (mapcar
      (<span class="org-keyword">lambda</span> (row)
        (<span class="org-keyword">let</span> ((day-values (-group-by (<span class="org-keyword">lambda</span> (x) (elt x 2)) (cdr row)))
              (week-total 0))
          (append
           (list (format <span class="org-string">"Week ending %s"</span> (format-time-string <span class="org-string">"%b %-e"</span> (org-time-string-to-time (car row)))))
           (mapcar (<span class="org-keyword">lambda</span> (day)
                     (<span class="org-keyword">if</span> (assoc-default day day-values)
                         (format <span class="org-string">"%.1f"</span>
                                 (apply '+
                                        (mapcar
                                         (<span class="org-keyword">lambda</span> (day-val) (/ (elt day-val 3) 3600.0))
                                         (assoc-default day day-values))))
                       <span class="org-string">""</span>))
                   days)
           (list (format <span class="org-string">"%.1f"</span>
                         (apply '+ (mapcar (<span class="org-keyword">lambda</span> (day-val) (/ (elt day-val 3) 3600.0)) (cdr row)))))
           ))
        )
      (-sort (<span class="org-keyword">lambda</span> (a b) (string&lt; (car a) (car b))) (-group-by (<span class="org-keyword">lambda</span> (x) (elt x 1)) list))))))


(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-quantified-hours-table</span> ()
  (my-org-quantified-format-detailed-hours-as-table
   (apply 'my-org-quantified-get-detailed-hours-based-on-range
          (org-entry-get-with-inheritance <span class="org-string">"QUANTIFIED_CATEGORY"</span>)
          (my-org-get-invoice-range-based-on-date (org-entry-get-with-inheritance <span class="org-string">"INVOICE_DATE"</span>)))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-get-invoice-range-based-on-date</span> ()
  <span class="org-string">"Check if invoice range is sane."</span>
  (should (equal (my-org-get-invoice-range-based-on-date <span class="org-string">"2015-12-05"</span>)
                 '(<span class="org-string">"2015-11-01 00:00"</span> <span class="org-string">"2015-12-01 00:00"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-presentations" class="outline-3">
<h3 id="presentations">Presentations</h3>
<div class="outline-text-3" id="text-presentations">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org-re-reveal
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-re-reveal-revealjs-version <span class="org-string">"4"</span>)
  (<span class="org-keyword">setq</span> org-re-reveal-history t))
(<span class="org-keyword">use-package</span> oer-reveal
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> oer-reveal-plugin-4-config
        <span class="org-string">"audioslideshow RevealAudioSlideshow plugin/audio-slideshow/plugin.js</span>
<span class="org-string">anything RevealAnything https://cdn.jsdelivr.net/npm/reveal.js-plugins@latest/anything/plugin.js"</span>))
</pre>
</div>
</div>
<div id="outline-container-counting-words" class="outline-4">
<h4 id="counting-words">Counting words</h4>
<div class="outline-text-4" id="text-counting-words">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org5883211">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-note-words-target</span> (* 140 20))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-collect-notes</span> (<span class="org-type">&amp;optional</span> block-name)
  (<span class="org-keyword">let</span> (results)
    (org-block-map
     (<span class="org-keyword">lambda</span> ()
       (<span class="org-keyword">unless</span> (org-in-commented-heading-p)
         (<span class="org-keyword">let</span> ((elem (org-element-at-point)))
           (<span class="org-keyword">when</span> (string= (downcase (org-element-property <span class="org-builtin">:type</span> elem))
                          (<span class="org-keyword">or</span> block-name <span class="org-string">"notes"</span>))
             (<span class="org-keyword">push</span> (string-trim
                          (buffer-substring-no-properties
                           (org-element-property <span class="org-builtin">:contents-begin</span> elem)
                           (org-element-property <span class="org-builtin">:contents-end</span> elem)))
                   results))))))
    (reverse results)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-count-words-in-notes</span> (<span class="org-type">&amp;optional</span> target block-name)
  <span class="org-doc">"Count words in #+begin_notes blocks.</span>
<span class="org-doc">If TARGET or `</span><span class="org-doc"><span class="org-constant">my-org-note-words-target</span></span><span class="org-doc">' is specified, calculate percentage and words left.</span>
<span class="org-doc">If BLOCK-NAME is specified, use that block type instead."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((notes (my-org-collect-notes)))
    (<span class="org-keyword">with-temp-buffer</span>
      (insert (string-join notes <span class="org-string">"\n"</span>))
      (<span class="org-keyword">let</span> ((num (count-words-region (point-min) (point-max))))
        (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> target my-org-note-words-target)
            (message <span class="org-string">"%d words (%.f%% of %d, %d to go)"</span>
                     num
                     (/ (* 100.0 num) my-org-note-words-target)
                     my-org-note-words-target
                     (- my-org-note-words-target num))
          (message <span class="org-string">"%d words"</span> num))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-create-notes-buffer</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((notes (my-org-collect-notes)))
    (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Notes*"</span>)
      (insert (string-join notes <span class="org-string">"\n\n"</span>))
      (switch-to-buffer (current-buffer)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-allow-dashes-in-tags" class="outline-3">
<h3 id="allow-dashes-in-tags">Allow dashes in tags</h3>
<div class="outline-text-3" id="text-allow-dashes-in-tags">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-add-dashes-to-tag-regexps</span> ()
  (<span class="org-keyword">setq</span> org-complex-heading-regexp
        (concat <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span> org-todo-regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[#.\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">??"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[ \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-[:alnum:]_@#%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"[ \t]*$"</span>)
        org-complex-heading-regexp-format
        (concat <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span> org-todo-regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[#.\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span>
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Stats cookies can be stuck to body.</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">\\[[0-9%%/]+\\] *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">%s</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> *\\[[0-9%%/]+\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[ \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-[:alnum:]_@#%%:]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"[ \t]*$"</span>)
        org-todo-line-tags-regexp
        (concat <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\*+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +"</span> org-todo-regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string"> +</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">??"</span>
                <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">[ \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">:[-[:alnum:]:_@#%]+:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span>
                <span class="org-string">"[ \t]*$"</span>)))
(<span class="org-keyword">use-package</span> org <span class="org-builtin">:hook</span> (org-mode . my-org-add-dashes-to-tag-regexps))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgffa28c1" class="outline-3">
<h3 id="orgffa28c1">Convert from Markdown</h3>
<div class="outline-text-3" id="text-orgffa28c1">
<p>
ChatGPT likes to output Markdown. I like to think in Org Mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-convert-region-from-markdown</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (shell-command-on-region beg end <span class="org-string">"pandoc -t org"</span> nil t))
</pre>
</div>
</div>
</div>
<div id="outline-container-copying-information-from-my-phone" class="outline-3">
<h3 id="copying-information-from-my-phone">Copying information from my phone</h3>
<div class="outline-text-3" id="text-copying-information-from-my-phone">
<p>
I have a tiny Tasker script that makes it easy to log timestamped
entries as files in a directory that I synchronize with Dropbox. This
code pulls that information into my ~/Dropbox/tasker/
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-read-phone-entries</span> ()
  <span class="org-doc">"Copy phone data to a summary Org file."</span>
  (<span class="org-keyword">interactive</span>)
  (mapc
   (<span class="org-keyword">lambda</span> (filename)
     (<span class="org-keyword">let</span> ((base (file-name-base filename)) contents timestamp category encoded-time date)
       (<span class="org-keyword">when</span> (string-match <span class="org-string">"^[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+ [</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+ </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> - </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> base)
         (<span class="org-keyword">setq</span> time (seconds-to-time (/ (string-to-number (match-string 1 base)) 1000))
               encoded-time (decode-time time)
               date (list (elt encoded-time 4) (elt encoded-time 3) (elt encoded-time 5))
               category (match-string 2 base))
         (<span class="org-keyword">with-temp-buffer</span>
           (insert-file-contents filename)
           (<span class="org-keyword">setq</span> contents (s-trim (buffer-string))))
         (<span class="org-keyword">with-current-buffer</span>
             (find-file <span class="org-string">"~/dropbox/tasker/summary.txt"</span>)
           (org-datetree-find-date-create date)
           (<span class="org-keyword">unless</span> (<span class="org-keyword">save-excursion</span> (re-search-forward (regexp-quote base) nil t))
             (goto-char (line-end-position))
             (insert <span class="org-string">"\n"</span>)
             (insert <span class="org-string">"**** "</span> contents <span class="org-string">"  :"</span> category <span class="org-string">":\n"</span> base <span class="org-string">"\n"</span>)
             (insert (format-time-string <span class="org-string">"[%Y-%m-%d %a %H:%M]\n"</span> time))

             (<span class="org-keyword">if</span> (member category '(<span class="org-string">"Think"</span> <span class="org-string">"Do"</span>))
                 (<span class="org-keyword">save-excursion</span>
                   (org-back-to-heading t)
                   (<span class="org-keyword">if</span> (looking-at org-outline-regexp) (goto-char (1- (match-end 0))))
                   (<span class="org-keyword">unless</span> (looking-at org-todo-regexp)
                     (org-todo <span class="org-string">"TODO"</span>))))
             (<span class="org-keyword">if</span> (string-match <span class="org-string">"^Energy </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> contents)
                 (org-set-property <span class="org-string">"ENERGY"</span> (match-string 1 contents)))))
         (delete-file filename))))
   (directory-files <span class="org-string">"~/dropbox/tasker/data"</span> t <span class="org-string">"\\.txt$"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-emacs-news" class="outline-3">
<h3 id="emacs-news">Emacs packages, other settings for easy Emacs News generation</h3>
<div class="outline-text-3" id="text-emacs-news">
</div>
<div id="outline-container-ascii-export" class="outline-4">
<h4 id="ascii-export">ASCII export</h4>
<div class="outline-text-4" id="text-ascii-export">
<p>
This setting puts Org ASCII export links right after the text instead of in a separate section:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> org-ascii-links-to-notes nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-reddit" class="outline-4">
<h4 id="reddit">Reddit</h4>
<div class="outline-text-4" id="text-reddit">
<p>
This one exports links from my secret <code>my-reddit-upvoted-json</code>. You
can get your Reddit upvoted JSON URL at
<a href="https://www.reddit.com/prefs/feeds/">https://www.reddit.com/prefs/feeds/</a> .
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-reddit-list-upvoted</span> (date)
  (<span class="org-keyword">interactive</span> (list (org-read-date)))
  (<span class="org-keyword">let</span> ((threshold (org-read-date nil t (concat (substring date 0 (min (length date) 10)) <span class="org-string">" 0:00"</span>)))
        (url my-reddit-upvoted-json)
        results)
    (<span class="org-keyword">while</span> url
      (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
        (goto-char (point-min))
        (re-search-forward <span class="org-string">"^$"</span>)
        (<span class="org-keyword">let*</span> ((data (json-read))
               (items (assoc-default 'children (assoc-default 'data data)))
               (after (assoc-default 'after (assoc-default 'data data)))
               (result
                (mapconcat
                 (<span class="org-keyword">lambda</span> (item)
                   (<span class="org-keyword">let*</span> ((o (assoc-default 'data item))
                          (title (assoc-default 'title o))
                          (url (helm-html-decode-entities-string (assoc-default 'url o)))
                          (date (seconds-to-time (assoc-default 'created_utc o)))
                          (permalink (concat <span class="org-string">"https://reddit.com"</span> (assoc-default 'permalink o)))
                          (num-comments (assoc-default 'num_comments o 'eq 0)))
                     (<span class="org-keyword">when</span> (time-less-p threshold date)
                       (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt; num-comments 0) (not (string-match <span class="org-string">"reddit\\.com"</span> url)))
                           (format <span class="org-string">"- %s (%s)\n"</span>
                                   (org-link-make-string (url-unhex-string url) title)
                                   (org-link-make-string (url-unhex-string permalink) <span class="org-string">"Reddit"</span>))
                         (format <span class="org-string">"- %s\n"</span> (org-link-make-string (url-unhex-string url) title))))))
                 items <span class="org-string">""</span>)))

          (<span class="org-keyword">setq</span> results (concat result <span class="org-string">"\n"</span> results))
          (<span class="org-keyword">setq</span> url
                (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> after (&gt; (length result) 0))
                    (concat my-reddit-upvoted-json <span class="org-string">"&amp;after="</span> after)
                  nil)))))
    results))
<span class="org-comment-delimiter">;;  </span><span class="org-comment">(my-reddit-list-upvoted "-mon")</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sorting-org-mode-lists-using-a-sequence-of-regular-expressions" class="outline-4">
<h4 id="sorting-org-mode-lists-using-a-sequence-of-regular-expressions">Sorting Org Mode lists using a sequence of regular expressions&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h4>
<div class="outline-text-4" id="text-sorting-org-mode-lists-using-a-sequence-of-regular-expressions">
<p>
I manually categorize Emacs News links into an Org unordered list, and
then I reorganize the list by using M-S-up (org-shiftmetaup) and
M-S-down (org-shiftmetadown). I decide to combine or split categories
depending on the number of links. I have a pretty consistent order.
John Wiegley suggested promoting Emacs Lisp and Emacs development
links at the top of the list. I like to sort the rest of the list
roughly by interest: general links first, then Org, then coding, then
other links at the bottom.
</p>

<p>
Here's some code that sorts Org lists in a custom sequence, with
unknown items at the bottom for easy re-ordering. It will take a list like:
</p>

<pre class="example" id="orgc79680f">
- Other:
  - Link A
  - Link B
- Emacs development:
  - Link A
  - Link B
- Emacs Lisp:
  - Link A
  - Link B
</pre>

<p>
and turn it into:
</p>

<pre class="example" id="org4a7378f">
- Emacs Lisp:
  - Link A
  - Link B
- Emacs development:
  - Link A
  - Link B
- Other:
  - Link A
  - Link B
</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sort-list-in-custom-order</span> (order)
  <span class="org-doc">"Sort the current Org list so that items are in the specified order.</span>
<span class="org-doc">       ORDER is a list of regexps."</span>
  (org-sort-list
   nil ?f
   (<span class="org-keyword">lambda</span> ()
     (<span class="org-keyword">let</span> ((case-fold-search t)
           (item
            (<span class="org-keyword">when</span> (looking-at <span class="org-string">"[ \t]*[-+*0-9.)]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[ \t]+\\[[- X]\\]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?[ \t]+"</span>)
              (org-sort-remove-invisible (buffer-substring (match-end 0) (point-at-eol))))))
       (<span class="org-keyword">or</span> (cl-position item order <span class="org-builtin">:test</span> (<span class="org-keyword">lambda</span> (a b) (string-match b a))) (1+ (length order)))))
   '&lt;))
</pre>
</div>
</div>
</div>
<div id="outline-container-package-links" class="outline-4">
<h4 id="package-links">Package links</h4>
<div class="outline-text-4" id="text-package-links">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-package-open</span> (package-name)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MPackage name: "</span>)
  (describe-package (intern package-name)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-org-package-export</span> ()
  (should
   (string=
    (my-org-package-export <span class="org-string">"transcribe"</span> <span class="org-string">"transcribe"</span> 'html)
    <span class="org-string">"&lt;a target=\"_blank\" href=\"https://elpa.gnu.org/packages/transcribe.html\"&gt;transcribe&lt;/a&gt;"</span>
    ))
  (should
   (string=
    (my-org-package-export <span class="org-string">"fireplace"</span> <span class="org-string">"fireplace"</span> 'html)
    <span class="org-string">"&lt;a target=\"_blank\" href=\"http://melpa.org/#/fireplace\"&gt;fireplace&lt;/a&gt;"</span>
    )))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-package-export</span> (link description format <span class="org-type">&amp;optional</span> arg)
  (<span class="org-keyword">let*</span> ((package-info (car (assoc-default (intern link) package-archive-contents)))
         (package-source (<span class="org-keyword">and</span> package-info (package-desc-archive package-info)))
         (path (format
                (<span class="org-keyword">cond</span>
                 ((null package-source) link)
                 ((string= package-source <span class="org-string">"gnu"</span>) <span class="org-string">"https://elpa.gnu.org/packages/%s.html"</span>)
                 ((string= package-source <span class="org-string">"melpa"</span>) <span class="org-string">"http://melpa.org/#/%s"</span>)
                 ((string= package-source <span class="org-string">"nongnu"</span>) <span class="org-string">"https://elpa.nongnu.org/nongnu/%s.html"</span>)
                 (t (<span class="org-warning">error</span> 'unknown-source)))
                link))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">if</span> package-source
        (<span class="org-keyword">cond</span>
         ((eq format '11ty) (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
         ((eq format 'html) (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
         ((eq format 'wp) (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc))
         ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
         ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
         ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
         (t path))
      desc)))
(org-link-set-parameters <span class="org-string">"package"</span> <span class="org-builtin">:follow</span> 'my-org-package-open <span class="org-builtin">:export</span> 'my-org-package-export)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-save-when-emacs-loses-focus" class="outline-3">
<h3 id="save-when-emacs-loses-focus">Save when Emacs loses focus</h3>
<div class="outline-text-3" id="text-save-when-emacs-loses-focus">
<div class="org-src-container">
<pre class="src src-emacs-lisp">

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-save-all-org-buffers</span> ()
  (<span class="org-keyword">unless</span> my-unfocusing
    (<span class="org-keyword">let</span> ((my-unfocusing t))
      (my-org-debounce-idle-timer 10
                                  my-org-save-all-org-buffers-timer
                                  'org-save-all-org-buffers))))
(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">add-function</span> <span class="org-builtin">:after</span> after-focus-change-function 'my-org-save-all-org-buffers))
</pre>
</div>
</div>
<div id="outline-container-org-links" class="outline-4">
<h4 id="org-links">Org links</h4>
<div class="outline-text-4" id="text-org-links">
<p>
Based on <a href="https://xenodium.com/emacs-dwim-do-what-i-mean/">https://xenodium.com/emacs-dwim-do-what-i-mean/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-page-title</span> (url)
  (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
    (string-trim
     (replace-regexp-in-string
      <span class="org-string">"[ \n]+"</span> <span class="org-string">" "</span>
      (replace-regexp-in-string
       <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">^Github - </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">:: Sacha Chua</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> <span class="org-string">""</span>
       (<span class="org-keyword">or</span>
        (dom-text (car
                   (dom-by-tag (libxml-parse-html-region
                                (point-min)
                                (point-max))
                               'title)))
        <span class="org-string">""</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">ar/org-insert-link-dwim</span> (use-clipboard)
  <span class="org-doc">"Like `</span><span class="org-doc"><span class="org-constant">org-insert-link</span></span><span class="org-doc">' but with personal dwim preferences."</span>
  (<span class="org-keyword">interactive</span> (list (equal current-prefix-arg '(4))))
  (<span class="org-keyword">let*</span> ((point-in-link (org-in-regexp org-link-any-re 1))
         (clipboard-url (<span class="org-keyword">and</span> use-clipboard
                          (<span class="org-keyword">when</span> (string-match-p <span class="org-string">"^http"</span> (current-kill 0))
                            (current-kill 0))))
         (region-content (<span class="org-keyword">when</span> (region-active-p)
                           (buffer-substring-no-properties (region-beginning)
                                                           (region-end)))))
    (<span class="org-keyword">cond</span>
     ((<span class="org-keyword">and</span> (derived-mode-p 'markdown-mode) region-content clipboard-url)
      (delete-region (region-beginning) (region-end))
      (insert (format <span class="org-string">"[%s](%s)"</span> region-content clipboard-url)))
     ((<span class="org-keyword">and</span> (derived-mode-p 'markdown-mode) clipboard-url)
      (insert (format <span class="org-string">"[%s](%s)"</span> (my-page-title clipboard-url) clipboard-url)))
     ((derived-mode-p 'markdown-mode)
      (insert (format <span class="org-string">"[%s](%s)"</span> (read-string <span class="org-string">"Text: "</span>) (read-string <span class="org-string">"Link: "</span>))))
     ((<span class="org-keyword">and</span> region-content clipboard-url (not point-in-link))
      (delete-region (region-beginning) (region-end))
      (insert (org-link-make-string clipboard-url region-content)))
     ((<span class="org-keyword">and</span> clipboard-url (not point-in-link))
      (insert (org-link-make-string
               clipboard-url
               (read-string <span class="org-string">"title: "</span>
                            (my-page-title clipboard-url)))))
     (t
      (call-interactively 'org-insert-link)))))
(<span class="org-keyword">use-package</span> org <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> org-mode-map (<span class="org-string">"C-c C-l"</span> . ar/org-insert-link-dwim)))
(<span class="org-keyword">with-eval-after-load</span> 'markdown-mode
  (define-key markdown-mode-map (kbd <span class="org-string">"C-c C-l"</span>) #'ar/org-insert-link-dwim))



</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-clipboard" class="outline-3">
<h3 id="clipboard">Clipboard</h3>
<div class="outline-text-3" id="text-clipboard">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-clipboard</span> ()
  <span class="org-doc">"Convert clipboard contents from HTML to Org and then paste (yank)."</span>
  (<span class="org-keyword">interactive</span>)
  (insert (shell-command-to-string <span class="org-string">"xclip -o -selection clipboard -t text/html | pandoc -f html -t json | pandoc -f json -t org"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-setting-properties" class="outline-3">
<h3 id="setting-properties">Setting properties</h3>
<div class="outline-text-3" id="text-setting-properties">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-set-property</span> (property value)
  <span class="org-doc">"In the current entry, set PROPERTY to VALUE.</span>
<span class="org-doc">Use the region if active."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (org-read-property-name)
    (<span class="org-keyword">when</span> (region-active-p)
      (replace-regexp-in-string
       <span class="org-string">"[ \n\t]+"</span> <span class="org-string">" "</span>
       (buffer-substring (point) (mark))))))
  (org-set-property property value))
(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> org-mode-map
              (<span class="org-string">"C-c C-x p"</span> . my-org-set-property)))
</pre>
</div>
</div>
</div>
<div id="outline-container-linking-to-and-exporting-function-definitions-in-org-mode" class="outline-3">
<h3 id="linking-to-and-exporting-function-definitions-in-org-mode">Linking to and exporting function definitions in Org Mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h3>
<div class="outline-text-3" id="text-linking-to-and-exporting-function-definitions-in-org-mode">
<div class="update" id="orgc92e48f">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2024-01-11 Thu]</span></span>: Added ?link=1 to copy the context link</li>
<li>2023-09-12: added a way to force the defun to start open with ?open=1</li>
<li>2023-09-05: fixed the completion to include <code>defun:</code></li>
</ul>

</div>

<p>
I'd like to write more blog posts about little Emacs hacks, and I'd
like to do it with less effort. Including source code is handy even
when it's missing some context from other functions defined in the
same file, since sometimes people pick up ideas and having the source
code right there means less flipping between links. When I'm working
inside my config file or other literate programming documents, I can
just write my blog post around the function definitions. When I'm
talking about Emacs Lisp functions defined elsewhere, though, it's a
little more annoying to copy the function definition and put it in a
source block, especially if there are updates.
</p>

<p>
The following code creates a <code>defun</code> link type that exports the function
definition. It works for functions that can be located with
find-function, so only functions loaded from .el files, but that does
what I need for now. Probably once I post this, someone will mention a
much more elegant way to do things. Anyway, it makes it easier to use
<code>org-store-link</code> to capture a link to the function, insert it into a
blog post, navigate back to the function, and export HTML.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-complete</span> ()
  <span class="org-doc">"Return function definitions."</span>
  (concat <span class="org-string">"defun:"</span>
          (completing-read
           <span class="org-string">"Function: "</span>
           #'help--symbol-completion-table
           #'fboundp
           'confirm
           nil nil))) <span class="org-comment-delimiter">; </span><span class="org-comment">   (and fn (symbol-name fn)) ?</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-link-description</span> (link description)
  <span class="org-doc">"Add documentation string as part of the description"</span>
  (<span class="org-keyword">unless</span> description
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"defun:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> link)
      (<span class="org-keyword">let</span> ((symbol (intern (match-string 1 link))))
        (<span class="org-keyword">when</span> (documentation symbol)
          (concat (symbol-name symbol) <span class="org-string">": "</span>
                  (car (split-string (documentation symbol) <span class="org-string">"\n"</span>))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-open-complete</span> ()
  <span class="org-doc">"Return function definitions."</span>
  (concat <span class="org-string">"defun-open:"</span>
          (completing-read
           <span class="org-string">"Function: "</span>
           #'help--symbol-completion-table
           #'fboundp
           'confirm
           nil nil)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-open-export</span> (link description format _)
  (my-org-defun-export (concat link (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\?"</span> link) <span class="org-string">"&amp;open=1"</span> <span class="org-string">"?open=1"</span>)) description format _))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-export</span> (link description format _)
  <span class="org-doc">"Export the function."</span>
  (<span class="org-keyword">let</span> (symbol params path-and-query)
    (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\?"</span> link)
        (<span class="org-keyword">setq</span> path-and-query (url-path-and-query (url-generic-parse-url link))
              symbol (car path-and-query)
              params (url-parse-query-string (cdr path-and-query)))
      (<span class="org-keyword">setq</span> symbol link))
    (<span class="org-keyword">save-window-excursion</span>
      (my-org-defun-open symbol)
      (<span class="org-keyword">let</span> ((function-body (buffer-substring (point)
                                             (<span class="org-keyword">progn</span> (forward-sexp) (point))))
            body)
        (<span class="org-keyword">pcase</span> format
          ((<span class="org-keyword">or</span> '11ty 'html)
           (<span class="org-keyword">setq</span> body
                 (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"bare"</span> params 'string=)
                     (format <span class="org-string">"&lt;div class=\"org-src-container\"&gt;&lt;pre class=\"src src-emacs-lisp\"&gt;%s&lt;/pre&gt;&lt;/div&gt;"</span>
                             (org-html-do-format-code function-body <span class="org-string">"emacs-lisp"</span> nil nil nil nil))
                   (format <span class="org-string">"&lt;details%s&gt;&lt;summary&gt;%s&lt;/summary&gt;&lt;div class=\"org-src-container\"&gt;&lt;pre class=\"src src-emacs-lisp\"&gt;%s&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;"</span>
                           (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"open"</span> params 'string=) <span class="org-string">" open"</span>
                             <span class="org-string">""</span>)
                           (<span class="org-keyword">or</span> description
                               (<span class="org-keyword">and</span> (documentation (intern symbol))
                                    (concat
                                     symbol
                                     <span class="org-string">": "</span>
                                     (car (split-string (documentation (intern symbol)) <span class="org-string">"\n"</span>))))
                               symbol)
                           (org-html-do-format-code function-body <span class="org-string">"emacs-lisp"</span> nil nil nil nil))))
           (<span class="org-keyword">when</span> (assoc-default <span class="org-string">"link"</span> params)
             (<span class="org-keyword">setq</span> body (format <span class="org-string">"%s&lt;div&gt;&lt;a href=\"%s\"&gt;Context&lt;/a&gt;&lt;/div&gt;"</span> body (my-copy-link))))
           body)
          (`ascii function-body)
          (_ function-body))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-store</span> ()
  <span class="org-doc">"Store a link to the function."</span>
  (<span class="org-keyword">when</span> (derived-mode-p 'emacs-lisp-mode)
    (org-link-store-props <span class="org-builtin">:type</span> <span class="org-string">"defun"</span>
                          <span class="org-builtin">:link</span> (concat <span class="org-string">"defun:"</span> (lisp-current-defun-name)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-open</span> (symbol <span class="org-type">&amp;rest</span> _)
  <span class="org-doc">"Jump to the function definition.</span>
<span class="org-doc">If it's from a tangled file, follow the link."</span>
  (find-function (intern (replace-regexp-in-string <span class="org-string">"\\?.*$"</span> <span class="org-string">""</span> symbol)))
  (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"^;; \\[\\[file:"</span> nil t)
    (goto-char (match-end 0))
    (org-open-at-point-global)
    (<span class="org-keyword">when</span> (re-search-forward (concat <span class="org-string">"( *defun +"</span> (regexp-quote (replace-regexp-in-string <span class="org-string">"\\?.*$"</span> <span class="org-string">""</span> symbol)))
                             nil t)
      (goto-char (match-beginning 0)))))

(org-link-set-parameters <span class="org-string">"defun"</span> <span class="org-builtin">:follow</span> #'my-org-defun-open
                         <span class="org-builtin">:export</span> #'my-org-defun-export
                         <span class="org-builtin">:complete</span> #'my-org-defun-complete
                         <span class="org-builtin">:insert-description</span> #'my-org-defun-link-description
                         <span class="org-builtin">:store</span> #'my-org-def-store)

(org-link-set-parameters <span class="org-string">"defun-open"</span> <span class="org-builtin">:follow</span> #'my-org-defun-open
                         <span class="org-builtin">:export</span> #'my-org-defun-open-export
                         <span class="org-builtin">:complete</span> #'my-org-defun-open-complete
                         <span class="org-builtin">:insert-description</span> #'my-org-defun-link-description)
</pre>
</div>

<p>
<code>my-copy-link</code> is at <a href="https://sachachua.com/dotemacs#web-link">https://sachachua.com/dotemacs#web-link</a>.
</p>
</div>
<div id="outline-container-org547d85b" class="outline-4">
<h4 id="org547d85b"><span class="todo TODO">TODO</span> Still allow linking to the file</h4>
<div class="outline-text-4" id="text-org547d85b">
<p>
Sometimes I want to link to a defun and sometimes I want to link to
the file itself. Maybe I can have a file link with the same kind of
scoping so that it kicks in only when <code>defun:</code> would also kick in.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defun-store-file-link</span> ()
  <span class="org-doc">"Store a link to the file itself."</span>
  (<span class="org-keyword">when</span> (derived-mode-p 'emacs-lisp-mode)
    (org-link-store-props <span class="org-builtin">:type</span> <span class="org-string">"file"</span>
                          <span class="org-builtin">:link</span> (concat <span class="org-string">"file:"</span> (buffer-file-name)))))
(<span class="org-keyword">with-eval-after-load</span> 'org
  (org-link-set-parameters <span class="org-string">"_file"</span> <span class="org-builtin">:store</span> #'my-org-defun-store-file-link))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-including-variables" class="outline-3">
<h3 id="including-variables">Including variables</h3>
<div class="outline-text-3" id="text-including-variables">
<div class="update" id="orge7abd8b">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-01-20 Sat]</span></span>: Fixed org-def-store thanks to oantolin's comment.
</p>

</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defvar-complete</span> ()
  <span class="org-doc">"Return variable definitions."</span>
  (concat <span class="org-string">"defvar:"</span>
          (completing-read
           <span class="org-string">"Variable: "</span>
           #'help--symbol-completion-table
           #'indirect-variable
           'confirm
           nil nil))) <span class="org-comment-delimiter">; </span><span class="org-comment">   (and fn (symbol-name fn)) ?</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defvar-link-description</span> (link description)
  <span class="org-doc">"Add documentation string as part of the description"</span>
  (<span class="org-keyword">unless</span> description
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">defun</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">defvar</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> link)
      (<span class="org-keyword">let*</span> ((symbol (intern (match-string 1 link)))
             (doc (documentation-property symbol 'variable-documentation symbol)))
        (<span class="org-keyword">when</span> doc
          (concat (symbol-name symbol) <span class="org-string">": "</span>
                  (car (split-string doc <span class="org-string">"\n"</span>))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-def-export</span> (link description format _)
  <span class="org-doc">"Export the variable-or-function."</span>
  (<span class="org-keyword">let</span> (symbol params path-and-query)
    (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\?"</span> link)
        (<span class="org-keyword">setq</span> path-and-query (url-path-and-query (url-generic-parse-url link))
              symbol (car path-and-query)
              params (url-parse-query-string (cdr path-and-query)))
      (<span class="org-keyword">setq</span> symbol link))
    (<span class="org-keyword">save-window-excursion</span>
      (<span class="org-keyword">if</span> (functionp (intern symbol))
          (find-function (intern symbol))
        (find-variable (intern symbol)))
      (<span class="org-keyword">let</span> ((body (buffer-substring (point)
                                    (<span class="org-keyword">progn</span> (forward-sexp) (point)))))
        (<span class="org-keyword">pcase</span> format
          ((<span class="org-keyword">or</span> '11ty 'html)
           (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"bare"</span> params 'string= <span class="org-string">""</span>)
               (format <span class="org-string">"&lt;div class=\"org-src-container\"&gt;&lt;pre class=\"src src-emacs-lisp\"&gt;%s&lt;/pre&gt;&lt;/div&gt;"</span>
                       (org-html-do-format-code body <span class="org-string">"emacs-lisp"</span> nil nil nil nil))

             (format <span class="org-string">"&lt;details%s&gt;&lt;summary&gt;%s&lt;/summary&gt;&lt;div class=\"org-src-container\"&gt;&lt;pre class=\"src src-emacs-lisp\"&gt;%s&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;"</span>
                     (<span class="org-keyword">if</span> (assoc-default <span class="org-string">"open"</span> params 'string=) <span class="org-string">" open"</span>
                       <span class="org-string">""</span>)
                     (<span class="org-keyword">or</span> description
                         (<span class="org-keyword">and</span> (documentation (intern symbol))
                              (concat
                               symbol
                               <span class="org-string">": "</span>
                               (car (split-string (documentation (intern symbol)) <span class="org-string">"\n"</span>))))
                         symbol)
                     (org-html-do-format-code body <span class="org-string">"emacs-lisp"</span> nil nil nil nil))
             ))
          (`ascii body)
          (_ body))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-def-store</span> ()
  <span class="org-doc">"Store a link to the function."</span>
  (<span class="org-keyword">when</span> (derived-mode-p 'emacs-lisp-mode)
    (<span class="org-keyword">save-excursion</span>
      (<span class="org-keyword">or</span> (eobp) (forward-char 1))
      (beginning-of-defun)
      (<span class="org-keyword">let</span> ((data (read (current-buffer))))
        (<span class="org-keyword">if</span> (eq (car data) 'defun)
            (org-link-store-props <span class="org-builtin">:type</span> <span class="org-string">"defun"</span>
                                  <span class="org-builtin">:link</span> (concat <span class="org-string">"defun:"</span> (lisp-current-defun-name)))
          (org-link-store-props <span class="org-builtin">:type</span> <span class="org-string">"defvar"</span>
                                <span class="org-builtin">:link</span> (format <span class="org-string">"defvar:%s"</span> (cadr data))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-defvar-open</span> (symbol _)
  <span class="org-doc">"Jump to the function definition."</span>
  (find-variable (intern (replace-regexp-in-string <span class="org-string">"\\?.*$"</span> <span class="org-string">""</span> symbol))))

(org-link-set-parameters <span class="org-string">"defvar"</span> <span class="org-builtin">:follow</span> #'my-org-defvar-open
                         <span class="org-builtin">:export</span> #'my-org-def-export
                         <span class="org-builtin">:complete</span> #'my-org-defvar-complete
                         <span class="org-builtin">:insert-description</span> #'my-org-defvar-link-description
                         <span class="org-comment-delimiter">; </span><span class="org-comment">:store #'my-org-def-store  ; already added by defun link</span>
                         )
</pre>
</div>
</div>
</div>
<div id="outline-container-org-send-things-to-the-bottom-of-the-list" class="outline-3">
<h3 id="org-send-things-to-the-bottom-of-the-list">Org - send things to the bottom of the list</h3>
<div class="outline-text-3" id="text-org-send-things-to-the-bottom-of-the-list">
<p>
Handy for collecting items together.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-send-to-bottom-of-list</span> ()
  <span class="org-doc">"Send the current line to the bottom of the list."</span>
  (<span class="org-keyword">interactive</span>)
  (beginning-of-line)
  (<span class="org-keyword">let</span> ((kill-whole-line t))
    (<span class="org-keyword">save-excursion</span>
      (kill-line 1)
      (org-end-of-item-list)
      (yank))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org3afe919" class="outline-3">
<h3 id="org3afe919">Appearance - org-modern, variable pitch</h3>
<div class="outline-text-3" id="text-org3afe919">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org-modern
  <span class="org-builtin">:enabled</span> nil
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-modern-block-name nil)
  (global-org-modern-mode)
  )
</pre>
</div>

<p>
<a href="https://zzamboni.org/post/beautifying-org-mode-in-emacs/">https://zzamboni.org/post/beautifying-org-mode-in-emacs/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(set-face-attribute 'default nil <span class="org-builtin">:family</span> <span class="org-string">"Iosevka"</span>)
(set-face-attribute 'variable-pitch nil <span class="org-builtin">:family</span> <span class="org-string">"Iosevka Aile"</span>)
(set-face-attribute 'org-modern-symbol nil <span class="org-builtin">:family</span> <span class="org-string">"Iosevka"</span>)
(set-face-attribute 'org-table nil <span class="org-builtin">:inherit</span> 'fixed-pitch)
 (<span class="org-keyword">let*</span> ((variable-tuple
         (<span class="org-keyword">cond</span> ((x-list-fonts <span class="org-string">"ETBembo"</span>)         '(<span class="org-builtin">:font</span> <span class="org-string">"ETBembo"</span>))
               ((x-list-fonts <span class="org-string">"Source Sans Pro"</span>) '(<span class="org-builtin">:font</span> <span class="org-string">"Source Sans Pro"</span>))
               ((x-list-fonts <span class="org-string">"Lucida Grande"</span>)   '(<span class="org-builtin">:font</span> <span class="org-string">"Lucida Grande"</span>))
               ((x-list-fonts <span class="org-string">"Verdana"</span>)         '(<span class="org-builtin">:font</span> <span class="org-string">"Verdana"</span>))
               ((x-family-fonts <span class="org-string">"Sans Serif"</span>)    '(<span class="org-builtin">:family</span> <span class="org-string">"Sans Serif"</span>))
               (nil (<span class="org-warning">warn</span> <span class="org-string">"Cannot find a Sans Serif Font.  Install Source Sans Pro."</span>))))
        (base-font-color     (face-foreground 'default nil 'default))
        (headline           `(<span class="org-builtin">:inherit</span> default <span class="org-builtin">:weight</span> bold)))

   (custom-theme-set-faces
    'user
    `(org-level-8 ((t (,@headline ,@variable-tuple))))
    `(org-level-7 ((t (,@headline ,@variable-tuple))))
    `(org-level-6 ((t (,@headline ,@variable-tuple))))
    `(org-level-5 ((t (,@headline ,@variable-tuple))))
    `(org-level-4 ((t (,@headline ,@variable-tuple <span class="org-builtin">:height</span> 1.1))))
    `(org-level-3 ((t (,@headline ,@variable-tuple <span class="org-builtin">:height</span> 1.25))))
    `(org-level-2 ((t (,@headline ,@variable-tuple <span class="org-builtin">:height</span> 1.5))))
    `(org-level-1 ((t (,@headline ,@variable-tuple <span class="org-builtin">:height</span> 1.75))))
    `(org-document-title ((t (,@headline ,@variable-tuple <span class="org-builtin">:height</span> 2.0 <span class="org-builtin">:underline</span> nil))))))
(custom-theme-set-faces
  'user
  '(org-block ((t (<span class="org-builtin">:inherit</span> fixed-pitch))))
  '(org-code ((t (<span class="org-builtin">:inherit</span> (shadow fixed-pitch)))))
  '(org-document-info ((t (<span class="org-builtin">:foreground</span> <span class="org-string">"dark orange"</span>))))
  '(org-document-info-keyword ((t (<span class="org-builtin">:inherit</span> (shadow fixed-pitch)))))
  '(org-indent ((t (<span class="org-builtin">:inherit</span> (org-hide fixed-pitch)))))
  '(org-link ((t (<span class="org-builtin">:foreground</span> <span class="org-string">"royal blue"</span> <span class="org-builtin">:underline</span> t))))
  '(org-meta-line ((t (<span class="org-builtin">:inherit</span> (font-lock-comment-face fixed-pitch)))))
  '(org-property-value ((t (<span class="org-builtin">:inherit</span> fixed-pitch))) t)
  '(org-special-keyword ((t (<span class="org-builtin">:inherit</span> (font-lock-comment-face fixed-pitch)))))
  '(org-table ((t (<span class="org-builtin">:inherit</span> fixed-pitch))))
  '(org-tag ((t (<span class="org-builtin">:inherit</span> (shadow fixed-pitch) <span class="org-builtin">:weight</span> bold <span class="org-builtin">:height</span> 0.8))))
  '(org-verbatim ((t (<span class="org-builtin">:inherit</span> (shadow fixed-pitch))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-multimedia" class="outline-2">
<h2 id="multimedia">Multimedia</h2>
<div class="outline-text-2" id="text-multimedia">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> elfeed-tube
  <span class="org-builtin">:quelpa</span> (elfeed-tube <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"karthink/elfeed-tube"</span>)
  <span class="org-builtin">:after</span> elfeed
  <span class="org-builtin">:demand</span> t
  <span class="org-builtin">:commands</span>
  (elfeed-tube-fetch)
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">(setq elfeed-tube-auto-save-p nil) ;; t is auto-save (not default)</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">(setq elfeed-tube-auto-fetch-p t) ;;  t is auto-fetch (default)</span>
  (elfeed-tube-setup)
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> elfeed-show-mode-map
              (<span class="org-string">"F"</span> . elfeed-tube-fetch)
              ([remap save-buffer] . elfeed-tube-save)
              <span class="org-builtin">:map</span> elfeed-search-mode-map
              (<span class="org-string">"F"</span> . elfeed-tube-fetch)
              ([remap save-buffer] . elfeed-tube-save)))
(<span class="org-keyword">use-package</span> elfeed-tube-mpv
  <span class="org-builtin">:quelpa</span> (elfeed-tube-mpv <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"karthink/elfeed-tube"</span>)
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> elfeed-show-mode-map
              (<span class="org-string">"C-c C-f"</span> . elfeed-tube-mpv-follow-mode)
              (<span class="org-string">"C-c C-w"</span> . elfeed-tube-mpv-where)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> emms
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">emms-player-simple</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">emms-source-file</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">emms-source-playlist</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">emms-player-mpv</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">emms-info-native</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">emms-info-exiftool</span>)
  (emms-all)
  (add-to-list 'emms-info-functions 'emms-info-native)
  (add-to-list 'emms-info-functions 'emms-info-exiftool)

  (<span class="org-keyword">setq</span> emms-player-list '(emms-player-mpv)))
</pre>
</div>
</div>
<div id="outline-container-org1935798" class="outline-3">
<h3 id="org1935798">Renaming a set of files</h3>
<div class="outline-text-3" id="text-org1935798">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-rename-fileset</span> (new-prefix files <span class="org-type">&amp;optional</span> force)
  (<span class="org-keyword">interactive</span> (list
                (read-file-name
                 (format <span class="org-string">"New prefix (%s): "</span>
                         (file-name-base (car (dired-get-marked-files)))))
                (dired-get-marked-files)
                current-prefix-arg))
  (<span class="org-keyword">unless</span> force
    (<span class="org-keyword">dolist</span> (file files)
      (<span class="org-keyword">let</span> ((new-file (concat
                       new-prefix
                       <span class="org-string">"."</span>
                       (file-name-extension file))))
        (<span class="org-keyword">when</span> (file-exists-p new-file)
          (<span class="org-warning">error</span> <span class="org-string">"%s already exists."</span>
                 new-file)))))
  (<span class="org-keyword">dolist</span> (file files)
    (<span class="org-keyword">let</span> ((new-file (expand-file-name
                     (concat
                      new-prefix
                      <span class="org-string">"."</span>
                      (file-name-extension file)))))
      (rename-file file new-file t)))
  (<span class="org-keyword">when</span> (derived-mode-p 'dired-mode) (revert-buffer)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-coding" class="outline-2">
<h2 id="coding">Coding</h2>
<div class="outline-text-2" id="text-coding">
</div>
<div id="outline-container-scan-bin-and-turn-the-scripts-into-interactive-commands" class="outline-3">
<h3 id="scan-bin-and-turn-the-scripts-into-interactive-commands"><span class="done DONE">DONE</span> Scan ~/bin and turn the scripts into interactive commands</h3>
<div class="outline-text-3" id="text-scan-bin-and-turn-the-scripts-into-interactive-commands">
<p>
I want to automate little things on my computer so that I don't have
to look up command lines or stitch together different applications.
Many of these things make sense to turn into shell scripts. That way,
I can call them from other programs and assign keyboard shortcuts to
them. Still, I spend most of my computer time in Emacs, and I don't
want to think about whether I've defined a command in Emacs Lisp or in
a shell script. Besides, I like the way <a href="http://sachachua.com/blog/2014/03/emacs-basics-call-commands-name-m-x-tips-better-completion-using-ido-helm/">Helm</a> lets me type parts of
commands in order to select and call them.
</p>

<p>
Emacs Lisp allows you to define a macro that results in Emacs Lisp
code. In this case, I want to define interactive functions so I can
call them with <code>M-x</code>. In case I decide to call them from Emacs Lisp,
such as <code>(my-shell/rotate-screen "left")</code>, I want to be able to pass
arguments. I'm also using <a href="https://github.com/magnars/dash.el">dash.el</a> to provide functions like <code>-filter</code>
and <code>-not</code>, although I could rewrite this to just use the standard
Emacs Lisp functions.
</p>

<p>
Here's the code that scans a given directory for executable files and
creates interactive functions, and some code that calls it for my <a href="https://github.com/sachac/scripts">~/bin</a> directory.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> dash
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">defmacro</span> <span class="org-function-name">my-convert-shell-scripts-to-interactive-commands</span> (directory)
    <span class="org-doc">"Make the shell scripts in DIRECTORY available as interactive commands."</span>
    (cons 'progn
          (-map
           (<span class="org-keyword">lambda</span> (filename)
             (<span class="org-keyword">let</span> ((function-name (intern (concat <span class="org-string">"my-shell/"</span> (file-name-nondirectory filename)))))
               `(<span class="org-keyword">defun</span> ,function-name (<span class="org-type">&amp;rest</span> args)
                  (<span class="org-keyword">interactive</span>)
                  (<span class="org-keyword">cond</span>
                   ((not (called-interactively-p 'any))
                    (shell-command-to-string (mapconcat 'shell-quote-argument (cons ,filename args) <span class="org-string">" "</span>)))
                   ((region-active-p)
                    (apply 'call-process-region (point) (mark) ,filename nil (<span class="org-keyword">if</span> current-prefix-arg t nil) t args))
                   (t
                    (apply 'call-process ,filename nil (<span class="org-keyword">if</span> current-prefix-arg t nil) nil args))))))
           (-filter (-not #'file-directory-p)
                    (-filter #'file-executable-p (directory-files directory t))))))
  (my-convert-shell-scripts-to-interactive-commands <span class="org-string">"~/bin"</span>))
</pre>
</div>

<p>
Let's see how that goes!
</p>
</div>
</div>
<div id="outline-container-csvs" class="outline-3">
<h3 id="csvs">CSVs</h3>
<div class="outline-text-3" id="text-csvs">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> pcsv)
</pre>
</div>
</div>
</div>
<div id="outline-container-whitespace" class="outline-3">
<h3 id="whitespace">Whitespace</h3>
<div class="outline-text-3" id="text-whitespace">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ws-butler
  <span class="org-builtin">:config</span> (ws-butler-global-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-python" class="outline-3">
<h3 id="python">Python</h3>
<div class="outline-text-3" id="text-python">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> elpy
  <span class="org-builtin">:config</span>
  (elpy-enable)
  (<span class="org-keyword">setq</span> python-shell-interpreter <span class="org-string">"ipython3"</span>
        python-shell-interpreter-args <span class="org-string">"-i --simple-prompt"</span>)
  (<span class="org-keyword">setq</span> python-indent-offset 4)
  (add-hook 'python-mode-hook
      (<span class="org-keyword">lambda</span> ()
        (<span class="org-keyword">setq-local</span> tab-width 4)
        (<span class="org-keyword">setq-local</span> python-flymake-command '(<span class="org-string">"flake8"</span> <span class="org-string">"--append-config"</span> <span class="org-string">"/home/sacha/.config/flake8"</span> <span class="org-string">"-"</span>))
        (<span class="org-keyword">setq-local</span> python-check-command <span class="org-string">"flake8 --append-config /home/sacha/.config/flake8"</span>))
      70)
  )
(<span class="org-keyword">use-package</span> lsp-pyright
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:hook</span> (python-mode . (<span class="org-keyword">lambda</span> ()
                          (<span class="org-keyword">require</span> '<span class="org-constant">lsp-pyright</span>)
                          (lsp))))
(<span class="org-keyword">require</span> '<span class="org-constant">ansi-color</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">colorize-compilation-buffer</span> ()
  (<span class="org-keyword">when</span> (eq major-mode 'compilation-mode)
    (<span class="org-keyword">let</span> ((inhibit-read-only t))
      (ansi-color-apply-on-region compilation-filter-start (point-max)))))
(add-hook 'compilation-filter-hook 'colorize-compilation-buffer)
</pre>
</div>
</div>
</div>
<div id="outline-container-web-development" class="outline-3">
<h3 id="web-development">Web development</h3>
<div class="outline-text-3" id="text-web-development">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">from FAQ at http://web-mode.org/ for smartparens</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Avoid lockfiles because they mess up React projects</span>
(<span class="org-keyword">when</span> my-laptop-p
  (<span class="org-keyword">setq</span> create-lockfiles nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-web-mode-hook</span> ()
  (<span class="org-keyword">setq</span> web-mode-enable-auto-pairing nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sp-web-mode-is-code-context</span> (id action context)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (eq action 'insert)
             (not (<span class="org-keyword">or</span> (get-text-property (point) 'part-side)
                      (get-text-property (point) 'block-side))))
    t))

(<span class="org-keyword">use-package</span> web-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\.html?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">\\.njk</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> web-mode-markup-indent-offset 2)
    (<span class="org-keyword">setq</span> web-mode-code-indent-offset 2)
    (<span class="org-keyword">setq</span> web-mode-enable-current-element-highlight t)
    (<span class="org-keyword">setq</span> web-mode-ac-sources-alist
          '((<span class="org-string">"css"</span> . (ac-source-css-property))
            (<span class="org-string">"html"</span> . (ac-source-words-in-buffer ac-source-abbrev)))
          )))

</pre>
</div>
</div>
</div>
<div id="outline-container-lsp" class="outline-3">
<h3 id="lsp">LSP</h3>
<div class="outline-text-3" id="text-lsp">
<p>
<a href="https://emacs-lsp.github.io/lsp-mode/tutorials/reactjs-tutorial/">https://emacs-lsp.github.io/lsp-mode/tutorials/reactjs-tutorial/</a>
<a href="https://www.mattduck.com/lsp-python-getting-started.html">https://www.mattduck.com/lsp-python-getting-started.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> lsp-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> lsp-headerline-breadcrumb-enable t
        gc-cons-threshold (* 100 1024 1024)
        read-process-output-max (* 1024 1024)
        company-idle-delay 0.5
        company-minimum-prefix-length 1
        create-lockfiles nil <span class="org-comment-delimiter">;; </span><span class="org-comment">lock files will kill `npm start'</span>
        )
  (lsp-register-custom-settings
   '((<span class="org-string">"pyls.plugins.pyls_mypy.enabled"</span> t t)
     (<span class="org-string">"pyls.plugins.pyls_mypy.live_mode"</span> nil t)
     (<span class="org-string">"pyls.plugins.pyls_black.enabled"</span> t t)
     (<span class="org-string">"pyls.plugins.pyls_isort.enabled"</span> t t)))
  <span class="org-builtin">:hook</span> ((prog-mode-hook . lsp)
         (python-mode . lsp)
         (lsp-mode-hook . lsp-enable-which-key-integration)))
(<span class="org-keyword">use-package</span> lsp-ui
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:commands</span> lsp-ui-mode
  <span class="org-builtin">:after</span> lsp-mode)
(<span class="org-keyword">use-package</span> dap-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:after</span> lsp-mode)
</pre>
</div>
</div>
</div>
<div id="outline-container-turbo-log" class="outline-3">
<h3 id="turbo-log">Turbo log</h3>
<div class="outline-text-3" id="text-turbo-log">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> tree-sitter-langs
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:defer</span> t)

(<span class="org-keyword">use-package</span> tree-sitter
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:after</span> tree-sitter-langs
  <span class="org-builtin">:config</span>
  (global-tree-sitter-mode))

(<span class="org-keyword">use-package</span> turbo-log
  <span class="org-builtin">:quelpa</span> (turbo-log <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"Artawower/turbo-log"</span>)
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-s-l"</span> . turbo-log-print)
         (<span class="org-string">"C-s-i"</span> . turbo-log-print-immediately)
         (<span class="org-string">"C-s-h"</span> . turbo-log-comment-all-logs)
         (<span class="org-string">"C-s-s"</span> . turbo-log-uncomment-all-logs)
         (<span class="org-string">"C-s-["</span> . turbo-log-paste-as-logger)
         (<span class="org-string">"C-s-]"</span> . turbo-log-paste-as-logger-immediately)
         (<span class="org-string">"C-s-d"</span> . turbo-log-delete-all-logs))
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> turbo-log-msg-format-template <span class="org-string">"\"&#128640;: %s\""</span>)
  (<span class="org-keyword">setq</span> turbo-log-allow-insert-without-tree-sitter-p t))
</pre>
</div>
</div>
</div>
<div id="outline-container-tab-width-of-2-is-compact-and-readable" class="outline-3">
<h3 id="tab-width-of-2-is-compact-and-readable">Tab width of 2 is compact and readable</h3>
<div class="outline-text-3" id="text-tab-width-of-2-is-compact-and-readable">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq-default</span> tab-width 2)
</pre>
</div>
</div>
</div>
<div id="outline-container-more-indentation-things" class="outline-3">
<h3 id="more-indentation-things">More indentation things</h3>
<div class="outline-text-3" id="text-more-indentation-things">
<p>
From <a href="https://github.com/purcell/emacs.d/blob/master/lisp/init-editing-utils.el">https://github.com/purcell/emacs.d/blob/master/lisp/init-editing-utils.el</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/kill-back-to-indentation</span> ()
  <span class="org-doc">"Kill from point back to the first non-whitespace character on the line."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((prev-pos (point)))
    (back-to-indentation)
    (kill-region (point) prev-pos)))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-M-&lt;backspace&gt;"</span> 'sanityinc/kill-back-to-indentation)
</pre>
</div>
</div>
</div>
<div id="outline-container-alignment" class="outline-3">
<h3 id="alignment">Alignment</h3>
<div class="outline-text-3" id="text-alignment">
<p>
From <a href="https://blog.lambda.cx/posts/emacs-align-columns/">https://blog.lambda.cx/posts/emacs-align-columns/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-align-non-space</span> (BEG END)
  <span class="org-doc">"Align non-space columns in region BEG END."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (align-regexp BEG END <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\s-*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\S-+"</span> 1 1 t))
</pre>
</div>
</div>
</div>
<div id="outline-container-yaml" class="outline-3">
<h3 id="yaml">YAML</h3>
<div class="outline-text-3" id="text-yaml">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> yaml-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.yml\\'"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-expreg" class="outline-3">
<h3 id="expreg">Expand region with expreg</h3>
<div class="outline-text-3" id="text-expreg">
<p>
This is something I have to get the hang of too. It gradually expands the selection. Handy for Emacs Lisp.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> expreg
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"C-="</span> . expreg-expand)
  (<span class="org-string">"C-+"</span> . expreg-contract)
  (<span class="org-string">"C-&lt;prior&gt;"</span> . expreg-expand)
  (<span class="org-string">"C-&lt;next&gt;"</span> . expreg-contract))
</pre>
</div>
</div>
</div>
<div id="outline-container-compilation" class="outline-3">
<h3 id="compilation">Compilation</h3>
<div class="outline-text-3" id="text-compilation">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(eval-after-load 'python-mode
  '(bind-key <span class="org-string">"C-c C-c"</span> 'compile python-mode-map))
</pre>
</div>
</div>
</div>
<div id="outline-container-emacs-lisp" class="outline-3">
<h3 id="emacs-lisp">Emacs Lisp</h3>
<div class="outline-text-3" id="text-emacs-lisp">
<p>
Autocompile, but don't interrupt me with native compilation warnings.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> auto-compile
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span> (auto-compile-on-load-mode))
(<span class="org-keyword">setq</span> native-comp-async-report-warnings-errors nil)
</pre>
</div>

<p>
Memoize is handy for improving the performance when I use slow functions multiple times.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> memoize)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> eval-expression-print-length nil)
(<span class="org-keyword">setq</span> print-length nil)
(<span class="org-keyword">setq</span> edebug-print-length nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-set-sentence-end-double-space</span> ()
  (<span class="org-keyword">setq-local</span> sentence-end-double-space t))
(add-hook 'emacs-lisp-mode-hook
          'my-set-sentence-end-double-space)
</pre>
</div>
</div>
<div id="outline-container-easily-override-existing-functions" class="outline-4">
<h4 id="easily-override-existing-functions">Easily override existing functions</h4>
<div class="outline-text-4" id="text-easily-override-existing-functions">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-override-function</span> (symbol)
  (<span class="org-keyword">interactive</span> (list (completing-read
                      <span class="org-string">"Function: "</span>
                      #'help--symbol-completion-table
                      #'fboundp
                      'confirm nil nil)))
  (<span class="org-keyword">let</span> (function-body function-name)
    (<span class="org-keyword">save-window-excursion</span>
      (find-function (intern symbol))
      (<span class="org-keyword">setq</span> function-name (lisp-current-defun-name))
      (<span class="org-keyword">setq</span> function-body (buffer-substring (point)
                                            (<span class="org-keyword">progn</span> (forward-sexp) (point)))))
    (<span class="org-keyword">save-excursion</span>
      (insert function-body (format <span class="org-string">"\n\n(advice-add '%s :around 'my-%s)\n"</span> function-name function-name)))
    (<span class="org-keyword">save-excursion</span>
      (forward-char 1)
      (forward-sexp 1)
      (skip-syntax-forward <span class="org-string">" "</span>)
      (insert <span class="org-string">"my-"</span>)
      (forward-sexp 1)
      (skip-syntax-forward <span class="org-string">" "</span>)
      (forward-char 1)
      (insert <span class="org-string">"_ "</span>))))

</pre>
</div>
</div>
</div>
<div id="outline-container-lispy" class="outline-4">
<h4 id="lispy">Lispy</h4>
<div class="outline-text-4" id="text-lispy">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> lispy <span class="org-builtin">:hook</span> (emacs-lisp-mode . lispy-mode))
</pre>
</div>

<p>
Might need to tweak it because I use the Dvorak layout, so hjkl doesn't make as much sense for me.
</p>
</div>
<div id="outline-container-keep-track-of-the-number-of-times-specified-commands-have-been-called" class="outline-5">
<h5 id="keep-track-of-the-number-of-times-specified-commands-have-been-called">SOMEDAY Keep track of the number of times specified commands have been called</h5>
<div class="outline-text-5" id="text-keep-track-of-the-number-of-times-specified-commands-have-been-called">
<p>
Skip this for now
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> keyfreq
  <span class="org-builtin">:after</span> lispy
  <span class="org-builtin">:commands</span> keyfreq-mode
  <span class="org-builtin">:hook</span>
  (lispy-mode . keyfreq-mode)
  (lispy-mode . keyfreq-autosave-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defvar</span> <span class="org-variable-name">my-keyfreq-included-commands</span> (seq-filter (<span class="org-keyword">lambda</span> (sym)
              (<span class="org-keyword">and</span> (commandp sym)
                   (string-match <span class="org-string">"^lispy-"</span> (symbol-name sym))))
            obarray))
  (advice-add 'keyfreq-pre-command-hook <span class="org-builtin">:around</span>
              (<span class="org-keyword">lambda</span> (orig-fun)
                <span class="org-doc">"Limit to `</span><span class="org-doc"><span class="org-constant">my-keyfreq-included-commands</span></span><span class="org-doc">'."</span>
                (<span class="org-keyword">let</span> ((command real-last-command) count)
                  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> command (symbolp command)
                             (memq command my-keyfreq-included-commands))
                    (funcall orig-fun))))
              (list <span class="org-builtin">:name</span> <span class="org-string">"track-lispy"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-hydra-lispy" class="outline-5">
<h5 id="hydra-lispy">Emacs: Making a hydra cheatsheet for Lispy&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h5>
<div class="outline-text-5" id="text-hydra-lispy">
<p>
I wanted to get the hang of Lispy thanks to Leo Vivier's presentation
at EmacsSF, but there are <a href="https://oremacs.com/lispy/">a lot of keyboard shortcuts to explore</a>.
In <a href="https://karl-voit.at/2021/04/10/GLT21-emacs-org-features/">Karl Voit's demo of Org Mode at GLT21</a>, he showed how he uses
Hydra to make cheat sheets. That makes perfect sense, of course, as
Hydra can display text and allow you to run commands while the text
is displayed. I wanted to make a Hydra that would show me
categorized commands to make it easier to look up and eventually
remember them. I also wanted to skip the commands that I already knew or
that I didn't want to focus on just yet.
</p>

<p>
Fortunately, the function reference had a link to <a href="https://raw.githubusercontent.com/abo-abo/lispy/gh-pages/index.org">the Org file used to generate it</a>.
I copied the tables, merged them together, named them
with <code>#+NAME: bindings</code>, replaced the links with plain text, and added
a third column with the category I wanted to put commands into.
</p>

<div class="my_details" id="orgdabeaf2">
<table id="orgc8b8dac">


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">key</th>
<th scope="col" class="org-left">function</th>
<th scope="col" class="org-left">column</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&lt;</td>
<td class="org-left">lispy-barf</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">A</td>
<td class="org-left">lispy-beginning-of-defun</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">j</td>
<td class="org-left">lispy-down</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Z</td>
<td class="org-left">lispy-edebug-stop</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-left">lispy-ediff-regions</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">G</td>
<td class="org-left">lispy-goto-local</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">h</td>
<td class="org-left">lispy-left</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">N</td>
<td class="org-left">lispy-narrow</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">y</td>
<td class="org-left">lispy-occur</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left">lispy-other-mode</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">J</td>
<td class="org-left">lispy-outline-next</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">K</td>
<td class="org-left">lispy-outline-prev</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">P</td>
<td class="org-left">lispy-paste</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">l</td>
<td class="org-left">lispy-right</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">I</td>
<td class="org-left">lispy-shifttab</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&gt;</td>
<td class="org-left">lispy-slurp</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">SPC</td>
<td class="org-left">lispy-space</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">xB</td>
<td class="org-left">lispy-store-region-and-buffer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left">lispy-undo</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">k</td>
<td class="org-left">lispy-up</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">v</td>
<td class="org-left">lispy-view</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">V</td>
<td class="org-left">lispy-visit</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">W</td>
<td class="org-left">lispy-widen</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">D</td>
<td class="org-left">pop-tag-mark</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">x</td>
<td class="org-left">see</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">L</td>
<td class="org-left">unbound</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">U</td>
<td class="org-left">unbound</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">X</td>
<td class="org-left">unbound</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Y</td>
<td class="org-left">unbound</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">H</td>
<td class="org-left">lispy-ace-symbol-replace</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">lispy-clone</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">lispy-convolute</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">lispy-new-copy</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">O</td>
<td class="org-left">lispy-oneline</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">r</td>
<td class="org-left">lispy-raise</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">R</td>
<td class="org-left">lispy-raise-some</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">\</td>
<td class="org-left">lispy-splice</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">lispy-stringify</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">i</td>
<td class="org-left">lispy-tab</td>
<td class="org-left">Edit</td>
</tr>

<tr>
<td class="org-left">xj</td>
<td class="org-left">lispy-debug-step-in</td>
<td class="org-left">Eval</td>
</tr>

<tr>
<td class="org-left">xe</td>
<td class="org-left">lispy-edebug</td>
<td class="org-left">Eval</td>
</tr>

<tr>
<td class="org-left">xT</td>
<td class="org-left">lispy-ert</td>
<td class="org-left">Eval</td>
</tr>

<tr>
<td class="org-left">e</td>
<td class="org-left">lispy-eval</td>
<td class="org-left">Eval</td>
</tr>

<tr>
<td class="org-left">E</td>
<td class="org-left">lispy-eval-and-insert</td>
<td class="org-left">Eval</td>
</tr>

<tr>
<td class="org-left">xr</td>
<td class="org-left">lispy-eval-and-replace</td>
<td class="org-left">Eval</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">lispy-eval-other-window</td>
<td class="org-left">Eval</td>
</tr>

<tr>
<td class="org-left">q</td>
<td class="org-left">lispy-ace-paren</td>
<td class="org-left">Move</td>
</tr>

<tr>
<td class="org-left">z</td>
<td class="org-left">lispy-knight</td>
<td class="org-left">Move</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">lispy-move-down</td>
<td class="org-left">Move</td>
</tr>

<tr>
<td class="org-left">w</td>
<td class="org-left">lispy-move-up</td>
<td class="org-left">Move</td>
</tr>

<tr>
<td class="org-left">t</td>
<td class="org-left">lispy-teleport</td>
<td class="org-left">Move</td>
</tr>

<tr>
<td class="org-left">Q</td>
<td class="org-left">lispy-ace-char</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">-</td>
<td class="org-left">lispy-ace-subword</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">a</td>
<td class="org-left">lispy-ace-symbol</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">b</td>
<td class="org-left">lispy-back</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">d</td>
<td class="org-left">lispy-different</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">f</td>
<td class="org-left">lispy-flow</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">F</td>
<td class="org-left">lispy-follow</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">g</td>
<td class="org-left">lispy-goto</td>
<td class="org-left">Nav</td>
</tr>

<tr>
<td class="org-left">xb</td>
<td class="org-left">lispy-bind-variable</td>
<td class="org-left">Refactor</td>
</tr>

<tr>
<td class="org-left">xf</td>
<td class="org-left">lispy-flatten</td>
<td class="org-left">Refactor</td>
</tr>

<tr>
<td class="org-left">xc</td>
<td class="org-left">lispy-to-cond</td>
<td class="org-left">Refactor</td>
</tr>

<tr>
<td class="org-left">xd</td>
<td class="org-left">lispy-to-defun</td>
<td class="org-left">Refactor</td>
</tr>

<tr>
<td class="org-left">xi</td>
<td class="org-left">lispy-to-ifs</td>
<td class="org-left">Refactor</td>
</tr>

<tr>
<td class="org-left">xl</td>
<td class="org-left">lispy-to-lambda</td>
<td class="org-left">Refactor</td>
</tr>

<tr>
<td class="org-left">xu</td>
<td class="org-left">lispy-unbind-variable</td>
<td class="org-left">Refactor</td>
</tr>

<tr>
<td class="org-left">M</td>
<td class="org-left">lispy-multiline</td>
<td class="org-left">Other</td>
</tr>

<tr>
<td class="org-left">xh</td>
<td class="org-left">lispy-describe</td>
<td class="org-left">Other</td>
</tr>

<tr>
<td class="org-left">m</td>
<td class="org-left">lispy-mark-list</td>
<td class="org-left">Other</td>
</tr>
</tbody>
</table>

</div>


<p>
I wrote this Emacs Lisp code with the header arguments <code>#+begin_src emacs-lisp :var bindings=bindings :colnames yes</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(eval
 (append
  '(defhydra my-lispy-cheat-sheet (<span class="org-builtin">:hint</span> nil <span class="org-builtin">:foreign-keys</span> run)
     (<span class="org-string">"&lt;f14&gt;"</span> nil <span class="org-string">"Exit"</span> <span class="org-builtin">:exit</span> t))
  (<span class="org-keyword">cl-loop</span> for x in bindings
           unless (string= <span class="org-string">""</span> (elt x 2))
           collect
           (list (car x)
                 (intern (elt x 1))
                 (<span class="org-keyword">when</span> (string-match <span class="org-string">"lispy-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">eval-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                                     (elt x 1))
                   (match-string 1 (elt x 1)))
                 <span class="org-builtin">:column</span>
                 (elt x 2)))))
(<span class="org-keyword">with-eval-after-load</span> <span class="org-string">"lispy"</span>
  (define-key lispy-mode-map (kbd <span class="org-string">"&lt;f14&gt;"</span>) 'my-lispy-cheat-sheet/body)
  (define-key lispy-mode-map (kbd <span class="org-string">"C-?"</span>) 'my-lispy-cheat-sheet/body))
(<span class="org-keyword">with-eval-after-load</span> 'evil-lispy
  (evil-define-key nil evil-lispy-mode-map (kbd <span class="org-string">"&lt;f14&gt;"</span>) 'my-lispy-cheat-sheet/body))
</pre>
</div>

<p>
Here's the result:
</p>


<figure id="org95f5e5f">
<img src="https://sachachua.com/blog/wp-content/uploads/2021/04/Screenshot_20210413_002503.png" alt="Screenshot_20210413_002503.png">

<figcaption><span class="figure-number">Figure 10: </span>Hydra-based cheat sheet</figcaption>
</figure>

<p>
I'm experimenting with having my Windows key be <code>F14</code> if tapped and
<code>Super_L</code> if held down. I use KDE, so I <a href="https://zren.github.io/kde/#windowsmeta-key">disabled the Applications
shortcut</a> with:
</p>

<pre class="example" id="org8d2d80e">
kwriteconfig5 --file ~/.config/kwinrc --group ModifierOnlyShortcuts --key Meta ""
qdbus org.kde.KWin /KWin reconfigure
</pre>

<p>
and then used <code>xcape -e 'Super_L=F14'</code> to make it work.
</p>

<p>
Looking forward to getting the hang of this!
</p>
</div>
</div>
</div>
<div id="outline-container-smartparens-mode" class="outline-4">
<h4 id="smartparens-mode">Smartparens mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h4>
<div class="outline-text-4" id="text-smartparens-mode">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> smartparens
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    <span class="org-comment-delimiter">;</span><span class="org-comment">(require 'smartparens-config)</span>
    <span class="org-comment-delimiter">;</span><span class="org-comment">(add-hook 'emacs-lisp-mode-hook 'smartparens-mode)</span>
    <span class="org-comment-delimiter">;</span><span class="org-comment">(add-hook 'emacs-lisp-mode-hook 'show-smartparens-mode)</span>

      <span class="org-comment-delimiter">;;;;;;;;;;;;;;;;;;;;;;;;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">keybinding management</span>

    (define-key sp-keymap (kbd <span class="org-string">"C-c s r n"</span>) 'sp-narrow-to-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-f"</span>) 'sp-forward-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-b"</span>) 'sp-backward-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-d"</span>) 'sp-down-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-a"</span>) 'sp-backward-down-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-S-a"</span>) 'sp-beginning-of-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-S-d"</span>) 'sp-end-of-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-M-e"</span>) 'sp-up-sexp)
    (define-key emacs-lisp-mode-map (kbd <span class="org-string">")"</span>) 'sp-up-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-u"</span>) 'sp-backward-up-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-t"</span>) 'sp-transpose-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-M-n"</span>) 'sp-next-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-p"</span>) 'sp-previous-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-M-k"</span>) 'sp-kill-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-w"</span>) 'sp-copy-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"M-&lt;delete&gt;"</span>) 'sp-unwrap-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"M-&lt;backspace&gt;"</span>) 'sp-backward-unwrap-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"C-&lt;right&gt;"</span>) 'sp-forward-slurp-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-&lt;left&gt;"</span>) 'sp-forward-barf-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;left&gt;"</span>) 'sp-backward-slurp-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;right&gt;"</span>) 'sp-backward-barf-sexp)

    (define-key sp-keymap (kbd <span class="org-string">"M-D"</span>) 'sp-splice-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;delete&gt;"</span>) 'sp-splice-sexp-killing-forward)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-&lt;backspace&gt;"</span>) 'sp-splice-sexp-killing-backward)
    (define-key sp-keymap (kbd <span class="org-string">"C-S-&lt;backspace&gt;"</span>) 'sp-splice-sexp-killing-around)

    (define-key sp-keymap (kbd <span class="org-string">"C-]"</span>) 'sp-select-next-thing-exchange)
    (define-key sp-keymap (kbd <span class="org-string">"C-&lt;left_bracket&gt;"</span>) 'sp-select-previous-thing)
    (define-key sp-keymap (kbd <span class="org-string">"C-M-]"</span>) 'sp-select-next-thing)

    (define-key sp-keymap (kbd <span class="org-string">"M-F"</span>) 'sp-forward-symbol)
    (define-key sp-keymap (kbd <span class="org-string">"M-B"</span>) 'sp-backward-symbol)

    (define-key sp-keymap (kbd <span class="org-string">"C-c s t"</span>) 'sp-prefix-tag-object)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s p"</span>) 'sp-prefix-pair-object)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s c"</span>) 'sp-convolute-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s a"</span>) 'sp-absorb-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s e"</span>) 'sp-emit-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s p"</span>) 'sp-add-to-previous-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s n"</span>) 'sp-add-to-next-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s j"</span>) 'sp-join-sexp)
    (define-key sp-keymap (kbd <span class="org-string">"C-c s s"</span>) 'sp-split-sexp)

      <span class="org-comment-delimiter">;;;;;;;;;;;;;;;;;;</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">pair management</span>

    (sp-local-pair 'minibuffer-inactive-mode <span class="org-string">"'"</span> nil <span class="org-builtin">:actions</span> nil)
    (sp-local-pair 'web-mode <span class="org-string">"&lt;"</span> nil <span class="org-builtin">:when</span> '(my-sp-web-mode-is-code-context))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">markdown-mode</span>
    (sp-with-modes '(markdown-mode gfm-mode rst-mode)
      (sp-local-pair <span class="org-string">"*"</span> <span class="org-string">"*"</span> <span class="org-builtin">:bind</span> <span class="org-string">"C-*"</span>)
      (sp-local-tag <span class="org-string">"2"</span> <span class="org-string">"**"</span> <span class="org-string">"**"</span>)
      (sp-local-tag <span class="org-string">"s"</span> <span class="org-string">"```scheme"</span> <span class="org-string">"```"</span>)
      (sp-local-tag <span class="org-string">"&lt;"</span>  <span class="org-string">"&lt;_&gt;"</span> <span class="org-string">"&lt;/_&gt;"</span> <span class="org-builtin">:transform</span> 'sp-match-sgml-tags))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">tex-mode latex-mode</span>
    (sp-with-modes '(tex-mode plain-tex-mode latex-mode)
      (sp-local-tag <span class="org-string">"i"</span> <span class="org-string">"1d5f8e69396c521f645375107197ea4dfbc7b792quot;&lt;"</span> <span class="org-string">"1d5f8e69396c521f645375107197ea4dfbc7b792quot;&gt;"</span>))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">html-mode</span>
    (sp-with-modes '(html-mode sgml-mode web-mode)
      (sp-local-pair <span class="org-string">"&lt;"</span> <span class="org-string">"&gt;"</span>))

      <span class="org-comment-delimiter">;;; </span><span class="org-comment">lisp modes</span>
    (sp-with-modes sp--lisp-modes
      (sp-local-pair <span class="org-string">"("</span> nil <span class="org-builtin">:bind</span> <span class="org-string">"C-("</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-edit-list" class="outline-4">
<h4 id="edit-list">Edit list&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h4>
<div class="outline-text-4" id="text-edit-list">
<p>
M-x edit-list makes it easier to edit an Emacs Lisp list.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> edit-list
  <span class="org-builtin">:commands</span> edit-list
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">with-eval-after-load</span> 'embark
    (define-key embark-variable-map <span class="org-string">"l"</span> 'edit-list)))
</pre>
</div>
</div>
</div>
<div id="outline-container-libraries" class="outline-4">
<h4 id="libraries">General-purpose Emacs Lisp libraries</h4>
<div class="outline-text-4" id="text-libraries">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> dash <span class="org-builtin">:ensure</span> t)
(<span class="org-keyword">use-package</span> s <span class="org-builtin">:ensure</span> t)
</pre>
</div>
</div>
</div>
<div id="outline-container-let-s-try-this-setup" class="outline-4">
<h4 id="let-s-try-this-setup">Let's try this setup</h4>
<div class="outline-text-4" id="text-let-s-try-this-setup">
<p>
Copied from <a href="https://www.reddit.com/r/emacs/comments/1051bfu/comment/j38ymkn/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">https://www.reddit.com/r/emacs/comments/1051bfu/comment/j38ymkn/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'elisp-mode
  (define-key emacs-lisp-mode-map (kbd <span class="org-string">"C-c C-d C-d"</span>) 'describe-function)
  (define-key emacs-lisp-mode-map (kbd <span class="org-string">"C-c C-d d"</span>) 'describe-function)
  (define-key emacs-lisp-mode-map (kbd <span class="org-string">"C-c C-k"</span>) 'eval-buffer))

(<span class="org-keyword">use-package</span> highlight-quoted
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:hook</span>
  (emacs-lisp-mode . highlight-quoted-mode))

(<span class="org-keyword">use-package</span> eros
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:hook</span>
  (emacs-lisp-mode . eros-mode))

(<span class="org-keyword">use-package</span> suggest
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:defer</span> t)

(<span class="org-keyword">use-package</span> ipretty
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:config</span>
  (ipretty-mode 1))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Hide package namespaces</span>
(<span class="org-keyword">use-package</span> nameless
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:hook</span>
  (emacs-lisp-mode .  nameless-mode)
  <span class="org-builtin">:custom</span>
  (nameless-global-aliases '())
  (nameless-private-prefix t))

(<span class="org-keyword">use-package</span> erefactor
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:defer</span> t)

(<span class="org-keyword">use-package</span> flycheck-package
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:hook</span>
  (emacs-lisp-mode . flycheck-package-setup))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Emacs Lisp Static Analyzer</span>
(<span class="org-keyword">use-package</span> elsa
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:ensure</span> t)

(<span class="org-keyword">use-package</span> flycheck-elsa
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:hook</span>
  (emacs-lisp-mode . flycheck-elsa-setup))
</pre>
</div>
</div>
</div>
<div id="outline-container-edebug" class="outline-4">
<h4 id="edebug">Edebug</h4>
<div class="outline-text-4" id="text-edebug">
<p>
From <a href="https://xenodium.com/inline-previous-result-and-why-you-should-edebug/">https://xenodium.com/inline-previous-result-and-why-you-should-edebug/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">eros</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">adviced:edebug-previous-result</span> (_ <span class="org-type">&amp;rest</span> r)
  <span class="org-doc">"Adviced `</span><span class="org-doc"><span class="org-constant">edebug-previous-result</span></span><span class="org-doc">'."</span>
  (eros--make-result-overlay edebug-previous-result
    <span class="org-builtin">:where</span> (point)
    <span class="org-builtin">:duration</span> eros-eval-result-duration))

(advice-add #'edebug-previous-result
            <span class="org-builtin">:around</span>
            #'adviced:edebug-previous-result)

(<span class="org-keyword">defun</span> <span class="org-function-name">adviced:edebug-compute-previous-result</span> (_ <span class="org-type">&amp;rest</span> r)
  <span class="org-doc">"Adviced `</span><span class="org-doc"><span class="org-constant">edebug-compute-previous-result</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">let</span> ((previous-value (nth 0 r)))
    (<span class="org-keyword">if</span> edebug-unwrap-results
        (<span class="org-keyword">setq</span> previous-value
              (edebug-unwrap* previous-value)))
    (<span class="org-keyword">setq</span> edebug-previous-result
          (edebug-safe-prin1-to-string previous-value))))

(advice-add #'edebug-compute-previous-result
            <span class="org-builtin">:around</span>
            #'adviced:edebug-compute-previous-result)
</pre>
</div>
</div>
</div>
<div id="outline-container-testing" class="outline-4">
<h4 id="testing">Testing</h4>
<div class="outline-text-4" id="text-testing">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> buttercup
  <span class="org-builtin">:hook</span> '(buttercup-minor-mode . my-buttercup-set-up-imenu))

(<span class="org-keyword">use-package</span> package-lint)
</pre>
</div>
</div>
<div id="outline-container-ert" class="outline-5">
<h5 id="ert">ERT</h5>
<div class="outline-text-5" id="text-ert">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ert
  <span class="org-builtin">:config</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">handle truncated lists</span>
  (advice-add 'ert--pp-with-indentation-and-newline
              <span class="org-builtin">:around</span> (<span class="org-keyword">lambda</span> (oldfunc <span class="org-type">&amp;rest</span> args) (<span class="org-keyword">condition-case</span> nil (apply oldfunc args) (<span class="org-warning">error</span> nil)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-buttercup" class="outline-5">
<h5 id="buttercup">Buttercup</h5>
<div class="outline-text-5" id="text-buttercup">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-buttercup-source-buffer</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-buttercup-tests</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-track-source</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> my-buttercup-source-buffer (current-buffer))
  (<span class="org-keyword">setq</span> my-buttercup-tests (my-buttercup-tests-and-positions)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-run-dwim</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((lexical-binding t))
    (<span class="org-keyword">if</span> buttercup-minor-mode
        (my-buttercup-run-closest-at-point)
      (buttercup-run))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">(advice-remove 'buttercup-run 'my-buttercup-track-source)</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-run-closest-at-point</span> ()
  <span class="org-doc">"Run the buttercup suite at point."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((lexical-binding t)
        start)
    (<span class="org-keyword">setq</span> buttercup-suites nil)
    (<span class="org-keyword">save-selected-window</span>
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">save-restriction</span>
          <span class="org-comment-delimiter">;; </span><span class="org-comment">go up until we find a describe form</span>
          (<span class="org-keyword">while</span> (not (looking-at <span class="org-string">"([[:space:]]*describe[[:space:]]+"</span>))
            (backward-up-list nil t))
          (<span class="org-keyword">setq</span> start (point))
          (forward-sexp)
          (narrow-to-region start (point))
          (eval-last-sexp nil)
          (my-buttercup-track-source)))
      (buttercup-run))
    (message <span class="org-string">"Suite executed successfully"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-find-test</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (re-search-backward (make-string 40 ?=) nil t)
      (<span class="org-keyword">progn</span>
        (forward-line)
        (<span class="org-keyword">let</span> ((pos (assoc-default (buffer-substring (line-beginning-position)
                                                    (line-end-position))
                                  my-buttercup-tests)))
          (<span class="org-keyword">when</span> pos
            (pop-to-buffer my-buttercup-source-buffer)
            (goto-char pos))))
    (<span class="org-keyword">let</span> ((tests (my-buttercup-tests-and-positions)))
      (goto-char (assoc-default (completing-read <span class="org-string">"Test: "</span> tests) tests)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-test-name</span> ()
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> (list)
      (<span class="org-keyword">condition-case</span> err
          (<span class="org-keyword">progn</span>
            (<span class="org-keyword">while</span> (not (bobp))
              (<span class="org-keyword">let</span> ((form (<span class="org-keyword">save-excursion</span>
                            (<span class="org-keyword">ignore-errors</span>
                              (read (current-buffer))))))
                (<span class="org-keyword">when</span> (listp form) (<span class="org-keyword">and</span> (member (car form) '(describe it)))
                      (<span class="org-keyword">setq</span> list (cons (cadr form) list)))
                (backward-up-list nil t)))
            (string-join list <span class="org-string">" "</span>))
        (<span class="org-warning">error</span>
         (string-join list <span class="org-string">" "</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-tests-and-positions-lookup</span> ()
  <span class="org-doc">"Return a list of test names and points, for easier jumping."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">This is a very inefficient implementation. I wonder how to walk the tree...</span>
  (goto-char (point-min))
  (<span class="org-keyword">cl-loop</span> while (re-search-forward <span class="org-string">"([[:space:]]*it[[:space:]]+\""</span> nil t)
           collect (cons (my-buttercup-test-name) (point))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-tests-as-tree</span> ()
  <span class="org-doc">"Return the tests as nested lists ending with (description . point).</span>
<span class="org-doc">Useful as `</span><span class="org-doc"><span class="org-constant">imenu-create-index-function</span></span><span class="org-doc">'."</span>
  (goto-char (point-min))
  (<span class="org-keyword">let</span> (result)
    (<span class="org-keyword">condition-case</span> _
        (<span class="org-keyword">progn</span>
          (down-list)
          (<span class="org-keyword">while</span> (not (eobp))
            (<span class="org-keyword">cond</span>
             ((looking-at <span class="org-string">"describe\\_&gt;"</span>)
              (forward-sexp)
              (<span class="org-keyword">setq</span> result (cons
                            (cons (read (current-buffer))
                                  (<span class="org-keyword">save-restriction</span>
                                    (narrow-to-region
                                     (point)
                                     (<span class="org-keyword">progn</span>
                                       (up-list)
                                       (1- (point))))
                                    (my-buttercup-tests-as-tree)))
                            result)))
             ((looking-at <span class="org-string">"it\\_&gt;"</span>)
              (forward-sexp)
              (<span class="org-keyword">setq</span> result (cons
                            (cons (read (current-buffer)) (point))
                            result))
              (up-list)
              (down-list))
             (t
              <span class="org-comment-delimiter">;; </span><span class="org-comment">todo, handle other things</span>
              (up-list)
              (down-list)))))
      (scan-error
       <span class="org-comment-delimiter">;; </span><span class="org-comment">can't go down or forward</span>
       (reverse result)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-set-up-imenu</span> ()
  (<span class="org-keyword">setq-local</span> imenu-generic-expression nil)
  (<span class="org-keyword">setq-local</span> imenu-create-index-function #'my-buttercup-tests-as-tree))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-buttercup-tests-and-positions</span> ()
  <span class="org-doc">"Return test names and points to jump to."</span>
  (<span class="org-keyword">save-excursion</span>
    (goto-char (point-min))
    (<span class="org-keyword">condition-case</span> _
        (<span class="org-keyword">progn</span>
          (down-list)
          (<span class="org-keyword">let</span> (breadcrumbs sym result)
            (<span class="org-keyword">catch</span> '<span class="org-constant">done</span>
              (<span class="org-keyword">while</span> (not (eobp))
                (<span class="org-keyword">condition-case</span> _
                    (<span class="org-keyword">cond</span>
                     ((looking-at <span class="org-string">"describe[[:space:]]+"</span>)
                      (forward-sexp)
                      (<span class="org-keyword">setq</span> breadcrumbs (cons (read (current-buffer)) breadcrumbs))
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">ignore :var and :var*</span>
                      (<span class="org-keyword">when</span> (looking-at <span class="org-string">"[\n[:space:]]+:var\\*?"</span>)
                        (read (current-buffer))
                        (read (current-buffer)))
                      (down-list))
                     ((looking-at <span class="org-string">"it[[:space:]]+"</span>)
                      (forward-sexp)
                      (<span class="org-keyword">setq</span> result (cons (cons
                                          (string-join
                                           (reverse
                                            (delq nil
                                                  (cons (read (current-buffer)) breadcrumbs)))
                                           <span class="org-string">" "</span>)
                                          (point))
                                         result))
                      (up-list)
                      (down-list))
                     (t
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">might be something else that includes describe or it, so we explore it</span>
                      (<span class="org-keyword">setq</span> breadcrumbs (cons nil breadcrumbs))
                      (down-list)
                      ))
                  (scan-error
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">At the innermost thing, time to start going forward</span>
                   (<span class="org-keyword">condition-case</span> _
                       (<span class="org-keyword">progn</span>
                         <span class="org-comment-delimiter">;; </span><span class="org-comment">Try to go down. If we can, continue</span>
                         <span class="org-comment-delimiter">;; </span><span class="org-comment">processing. If we can't, go up until we</span>
                         <span class="org-comment-delimiter">;; </span><span class="org-comment">can go down.</span>
                         (<span class="org-keyword">while</span> (<span class="org-keyword">condition-case</span> _
                                    (down-list)
                                  (<span class="org-warning">error</span> t))
                           (up-list)
                           (<span class="org-keyword">setq</span> breadcrumbs (cdr breadcrumbs))))
                     (scan-error
                      (<span class="org-warning">error</span> (<span class="org-keyword">throw</span> '<span class="org-constant">done</span> (reverse result)))))))))
            (reverse result)))
      (<span class="org-warning">error</span> nil))))




(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-buttercup-tests-and-positions</span> ()
  (<span class="org-keyword">with-temp-buffer</span>
    (insert <span class="org-string">"(describe \"test\"</span>
<span class="org-string">  :var ((test))</span>
<span class="org-string">  (it \"1\")</span>
<span class="org-string">  (it \"2\")</span>
<span class="org-string">  (describe \"b\"</span>
<span class="org-string">    (before-each \"do this\")</span>
<span class="org-string">    (it \"3\")</span>
<span class="org-string">    (it \"4\"))</span>
<span class="org-string">  (describe \"c\"</span>
<span class="org-string">    (it \"5\")</span>
<span class="org-string">    (it \"6\")</span>
<span class="org-string">    (it \"7\")</span>
<span class="org-string">    (describe \"d\"</span>
<span class="org-string">      (it \"8\")))</span>
<span class="org-string">  (describe \"e\"</span>
<span class="org-string">    (it \"5\")</span>
<span class="org-string">    (it \"6\")</span>
<span class="org-string">    (it \"7\")</span>
<span class="org-string">    (describe \"f\"</span>
<span class="org-string">      (it \"8\")))</span>
<span class="org-string">  )"</span>)
    (<span class="org-keyword">let</span> ((tests (my-buttercup-tests-and-positions)))
      (expect (assoc <span class="org-string">"test 1"</span> tests))
      (expect (assoc <span class="org-string">"test 2"</span> tests))
      (expect (assoc <span class="org-string">"test b 3"</span> tests))
      (expect (assoc <span class="org-string">"test b 4"</span> tests))
      (expect (assoc <span class="org-string">"test c 5"</span> tests))
      (expect (assoc <span class="org-string">"test e f 8"</span> tests)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-undercover" class="outline-5">
<h5 id="undercover">Undercover</h5>
<div class="outline-text-5" id="text-undercover">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> undercover
  <span class="org-builtin">:quelpa</span> (<span class="org-keyword">undercover</span> <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"undercover-el/undercover.el"</span>)
  )
(<span class="org-keyword">use-package</span> coverage)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-eldoc" class="outline-4">
<h4 id="eldoc">Eldoc</h4>
<div class="outline-text-4" id="text-eldoc">
<p>
Eldoc provides minibuffer hints when working with Emacs Lisp.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> eldoc
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:diminish</span> eldoc-mode
  <span class="org-builtin">:commands</span> turn-on-eldoc-mode
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">progn</span>
    (add-hook 'emacs-lisp-mode-hook 'turn-on-eldoc-mode)
    (add-hook 'lisp-interaction-mode-hook 'turn-on-eldoc-mode)
    (add-hook 'ielm-mode-hook 'turn-on-eldoc-mode))
  <span class="org-builtin">:config</span>
  (eldoc-add-command-completions <span class="org-string">"paredit-"</span>)
  (eldoc-add-command-completions <span class="org-string">"lispy-"</span>))
</pre>
</div>

<p>
Related:
</p>
<ul class="org-ul">
<li><a href="https://www.masteringemacs.org/article/seamlessly-merge-multiple-documentation-sources-eldoc">Seamlessly Merge Multiple Documentation Sources with Eldoc - Mastering Emacs</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> flycheck
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:preface</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">mp-flycheck-eldoc</span> (callback <span class="org-type">&amp;rest</span> _ignored)
   <span class="org-doc">"Print flycheck messages at point by calling CALLBACK."</span>
   (<span class="org-keyword">when-let</span> ((flycheck-errors (<span class="org-keyword">and</span> flycheck-mode (flycheck-overlay-errors-at (point)))))
     (mapc
      (<span class="org-keyword">lambda</span> (err)
        (funcall callback
           (format <span class="org-string">"%s: %s"</span>
                   (<span class="org-keyword">let</span> ((level (flycheck-error-level err)))
                     (<span class="org-keyword">pcase</span> level
                       ('info (propertize <span class="org-string">"I"</span> 'face 'flycheck-error-list-info))
                       ('error (propertize <span class="org-string">"E"</span> 'face 'flycheck-error-list-error))
                       ('warning (propertize <span class="org-string">"W"</span> 'face 'flycheck-error-list-warning))
                       (_ level)))
                   (flycheck-error-message err))
           <span class="org-builtin">:thing</span> (<span class="org-keyword">or</span> (flycheck-error-id err)
                      (flycheck-error-group err))
           <span class="org-builtin">:face</span> 'font-lock-doc-face))
      flycheck-errors)))
  (<span class="org-keyword">defun</span> <span class="org-function-name">mp-flycheck-prefer-eldoc</span> ()
    (add-hook 'eldoc-documentation-functions #'mp-flycheck-eldoc nil t)
    (<span class="org-keyword">setq</span> eldoc-documentation-strategy 'eldoc-documentation-compose-eagerly)
    (<span class="org-keyword">setq</span> flycheck-display-errors-function nil)
    (<span class="org-keyword">setq</span> flycheck-help-echo-function nil))
  <span class="org-builtin">:hook</span> ((flycheck-mode . mp-flycheck-prefer-eldoc)))
(<span class="org-keyword">use-package</span> eglot
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:preface</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">mp-eglot-eldoc</span> ()
    (<span class="org-keyword">setq</span> eldoc-documentation-strategy
            'eldoc-documentation-compose-eagerly))
  <span class="org-builtin">:hook</span> ((eglot-managed-mode . mp-eglot-eldoc)))
</pre>
</div>
</div>
</div>
<div id="outline-container-refactoring" class="outline-4">
<h4 id="refactoring">Refactoring&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h4>
<div class="outline-text-4" id="text-refactoring">
<p>
More things that I need to get used to&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v l : elint current buffer in clean environment.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v L : elint current buffer by multiple emacs binaries.</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">See `</span><span class="org-comment"><span class="org-constant">erefactor-lint-emacsen</span></span><span class="org-comment">'</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v r : Rename symbol in current buffer.</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">Resolve `</span><span class="org-comment"><span class="org-constant">let</span></span><span class="org-comment">' binding as long as i can.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v R : Rename symbol in requiring modules and current buffer.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v h : Highlight current symbol in this buffer</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">and suppress `</span><span class="org-comment"><span class="org-constant">erefacthr-highlight-mode</span></span><span class="org-comment">'.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v d : Dehighlight all by above command.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v c : Switch prefix bunch of symbols.</span>
<span class="org-comment-delimiter">;;             </span><span class="org-comment">ex: '(hoge-var hoge-func) -&gt; '(foo-var foo-func)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">C-c C-v ? : Display flymake elint warnings/errors</span>

(<span class="org-keyword">use-package</span> erefactor
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> emacs-lisp-mode-map (<span class="org-string">"C-c C-v"</span> . erefactor-map)))

(<span class="org-keyword">use-package</span> redshank
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:init</span> (add-hook 'emacs-lisp-mode-hook 'redshank-mode))

</pre>
</div>
</div>
</div>
<div id="outline-container-jumping-to-code" class="outline-4">
<h4 id="jumping-to-code">Jumping to code</h4>
<div class="outline-text-4" id="text-jumping-to-code">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(define-key emacs-lisp-mode-map (kbd <span class="org-string">"C-c ."</span>) 'find-function-at-point)
</pre>
</div>
</div>
</div>
<div id="outline-container-sorting" class="outline-4">
<h4 id="sorting">Sorting</h4>
<div class="outline-text-4" id="text-sorting">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-sort-sexps-in-region</span> (beg end)
  <span class="org-doc">"Can be handy for sorting out duplicates.</span>
<span class="org-doc">       Sorts the sexps from BEG to END. Leaves the point at where it</span>
<span class="org-doc">       couldn't figure things out (ex: syntax errors)."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let</span> ((input (buffer-substring beg end))
        list last-point form result)
    (<span class="org-keyword">save-restriction</span>
      (<span class="org-keyword">save-excursion</span>
        (narrow-to-region beg end)
        (goto-char (point-min))
        (<span class="org-keyword">setq</span> last-point (point-min))
        (<span class="org-keyword">setq</span> form t)
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> form (not (eobp)))
          (<span class="org-keyword">setq</span> form (<span class="org-keyword">ignore-errors</span> (read (current-buffer))))
          (<span class="org-keyword">when</span> form
            (add-to-list
             'list
             (cons
              (prin1-to-string form)
              (buffer-substring last-point (point))))
            (<span class="org-keyword">setq</span> last-point (point))))
        (<span class="org-keyword">setq</span> list (sort list (<span class="org-keyword">lambda</span> (a b) (string&lt; (car a) (car b)))))
        (delete-region (point-min) (point))
        (insert (mapconcat 'cdr list <span class="org-string">"\n"</span>))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-evaluation" class="outline-4">
<h4 id="evaluation">Evaluation</h4>
<div class="outline-text-4" id="text-evaluation">
<p>
Borrowed from Steve Purcell's config. This pretty-prints the results.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">bind-key</span> <span class="org-string">"M-:"</span> 'pp-eval-expression)

(<span class="org-keyword">defun</span> <span class="org-function-name">sanityinc/eval-last-sexp-or-region</span> (prefix)
  <span class="org-doc">"Eval region from BEG to END if active, otherwise the last sexp."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (mark) (use-region-p))
      (eval-region (min (point) (mark)) (max (point) (mark)))
    (pp-eval-last-sexp prefix)))

(<span class="org-keyword">bind-key</span> <span class="org-string">"C-x C-e"</span> 'sanityinc/eval-last-sexp-or-region emacs-lisp-mode-map)
</pre>
</div>
</div>
</div>
<div id="outline-container-auto-insert" class="outline-4">
<h4 id="auto-insert">Auto insert</h4>
<div class="outline-text-4" id="text-auto-insert">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'auto-insert
  (add-to-list 'auto-insert-alist
               '((<span class="org-string">"\\.el\\'"</span> . <span class="org-string">"Emacs Lisp header"</span>)
                 <span class="org-string">"Short description: "</span>
                 <span class="org-string">";;; "</span> (file-name-nondirectory (buffer-file-name)) <span class="org-string">" --- "</span> str
     (make-string (max 2 (- 80 (current-column) 27)) ?\s)
     <span class="org-string">"-*- lexical-binding: t; -*-"</span> '(setq lexical-binding t)
     <span class="org-string">"</span>

<span class="org-string">;; Copyright (C) "</span> (format-time-string <span class="org-string">"%Y"</span>) <span class="org-string">"  "</span>
 (getenv <span class="org-string">"ORGANIZATION"</span>) | (<span class="org-keyword">progn</span> user-full-name) <span class="org-string">"</span>

<span class="org-string">;; Author: "</span> (user-full-name)
'(if (search-backward <span class="org-string">"&amp;"</span> (line-beginning-position) t)
     (replace-match (capitalize (user-login-name)) t t))
'(end-of-line 1) <span class="org-string">" &lt;"</span> (<span class="org-keyword">progn</span> user-mail-address) <span class="org-string">"&gt;</span>
<span class="org-string">"</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Keywords and completing-read with a require-match don't give me a way to break out</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">;; Keywords: "</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">'(require 'finder)</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">;;'(setq v1 (apply 'vector (mapcar 'car finder-known-keywords)))</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">'(setq v1 (mapcar (lambda (x) (list (symbol-name (car x))))</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">      finder-known-keywords)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment"> v2 (mapconcat (lambda (x) (format "%12s:  %s" (car x) (cdr x)))</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">    finder-known-keywords</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">    "\n"))</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">((let ((minibuffer-help-form v2))</span>
<span class="org-comment-delimiter">;;     </span><span class="org-comment">(completing-read "Keyword, C-h: " v1 nil t))</span>
<span class="org-comment-delimiter">;;     </span><span class="org-comment">str ", ")</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">&amp; -2</span>
 <span class="org-string">"</span>

<span class="org-string">\;; This program is free software; you can redistribute it and/or modify</span>
<span class="org-string">\;; it under the terms of the GNU General Public License as published by</span>
<span class="org-string">\;; the Free Software Foundation, either version 3 of the License, or</span>
<span class="org-string">\;; (at your option) any later version.</span>

<span class="org-string">\;; This program is distributed in the hope that it will be useful,</span>
<span class="org-string">\;; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="org-string">\;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="org-string">\;; GNU General Public License for more details.</span>

<span class="org-string">\;; You should have received a copy of the GNU General Public License</span>
<span class="org-string">\;; along with this program.  If not, see <a href="https://www.gnu.org/licenses/">&lt;https://www.gnu.org/licenses/&gt;</a>.</span>

<span class="org-string">\;;; Commentary:</span>

<span class="org-string">\;; "</span> _ <span class="org-string">"</span>

<span class="org-string">\;;; Code:</span>



<span class="org-string">\(provide '"</span>
       (file-name-base (buffer-file-name))
       <span class="org-string">")</span>
<span class="org-string">\;;; "</span> (file-name-nondirectory (buffer-file-name)) <span class="org-string">" ends here\n"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-stubbing" class="outline-4">
<h4 id="stubbing">Stubbing</h4>
<div class="outline-text-4" id="text-stubbing">
<p>
From <a href="https://ag91.github.io/blog/2020/12/31/top-down-elisping-a-simple-snippet-to-stub-a-function-while-your-are-designing-your-code/">https://ag91.github.io/blog/2020/12/31/top-down-elisping-a-simple-snippet-to-stub-a-function-while-your-are-designing-your-code/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-stub-elisp-defun</span> ()
  <span class="org-doc">"Stub an elisp function from symbol at point."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((fun (thing-at-point 'list 'no-properties)))
    (<span class="org-keyword">when</span> fun
      (<span class="org-keyword">let*</span> ((fun-list (car (read-from-string fun)))
             (name (symbol-name (nth 0 fun-list)))
             (args (cdr fun-list)))
        (<span class="org-keyword">save-excursion</span>
          (<span class="org-keyword">or</span> (search-backward <span class="org-string">"(defun"</span> nil 't) (goto-char (point-min)))
          (insert
           (s-concat
            <span class="org-string">"(defun "</span>
            name
            <span class="org-string">" "</span>
            (format <span class="org-string">"%s"</span> (--map (s-concat <span class="org-string">"arg"</span> (number-to-string it)) (number-sequence 1 (length args))))
            <span class="org-string">"\n  \"SomeDocs\"\n  nil)\n\n"</span>)))))))

(<span class="org-keyword">bind-key</span> <span class="org-string">"C-:"</span> #'my-stub-elisp-defun emacs-lisp-mode-map)
</pre>
</div>
</div>
</div>
<div id="outline-container-helpful" class="outline-4">
<h4 id="helpful">Helpful</h4>
<div class="outline-text-4" id="text-helpful">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> helpful
  <span class="org-builtin">:bind</span>
  ([remap describe-key] . helpful-key)
  ([remap describe-command] . helpful-command)
  ([remap describe-variable] . helpful-variable)
  ([remap describe-function] . helpful-callable))
</pre>
</div>
</div>
</div>
<div id="outline-container-elisp-demos" class="outline-4">
<h4 id="elisp-demos">elisp-demos</h4>
<div class="outline-text-4" id="text-elisp-demos">
<p>
elisp-demos lets you add text to a symbol's help documentation from
entries in an Org file. The Org file at
<a href="https://github.com/xuchunyang/elisp-demos">https://github.com/xuchunyang/elisp-demos</a> has many examples. I've
modified my version to allow me to have personal note files and a
button to add more examples. My diff: <a href="https://github.com/xuchunyang/elisp-demos/compare/master...sachac:elisp-demos:user-files">https://github.com/xuchunyang/elisp-demos/compare/master...sachac:elisp-demos:user-files</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> elisp-demos
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/elisp-demos"</span>
  <span class="org-builtin">:commands</span>
  elisp-demos-advice-helpful-update
  elisp-demos-add-demo
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">with-eval-after-load</span> 'helpful
    (advice-add 'helpful-update <span class="org-builtin">:after</span> #'elisp-demos-advice-helpful-update))
  <span class="org-builtin">:custom</span>
  elisp-demos-user-files '(<span class="org-string">"~/sync/orgzly/elisp-demos.org"</span>))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-snippets" class="outline-3">
<h3 id="snippets">Snippets</h3>
<div class="outline-text-3" id="text-snippets">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> yasnippet
  <span class="org-builtin">:diminish</span> yas-minor-mode
  <span class="org-builtin">:init</span> (yas-global-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">push</span> '(yasnippet backquote-change) warning-suppress-types)
  (yas-global-mode)
  (add-hook 'hippie-expand-try-functions-list 'yas-hippie-try-expand)
  (<span class="org-keyword">setq</span> yas-key-syntaxes '(<span class="org-string">"w_"</span> <span class="org-string">"w_."</span> <span class="org-string">"^ "</span>))
  (<span class="org-keyword">setq</span> yas-installed-snippets-dir <span class="org-string">"~/elisp/yasnippet-snippets"</span>)
  (<span class="org-keyword">setq</span> yas-expand-only-for-last-commands nil)
  (yas-global-mode 1)
  (<span class="org-keyword">bind-key</span> <span class="org-string">"\t"</span> 'hippie-expand yas-minor-mode-map)
)
<span class="org-comment-delimiter">;;        </span><span class="org-comment">(global-set-key (kbd "C-c y") (lambda () (interactive)</span>
<span class="org-comment-delimiter">;;                                         </span><span class="org-comment">(yas/load-directory "~/elisp/snippets")))</span>
</pre>
</div>

<p>
From <a href="http://emacswiki.org/emacs/Yasnippet">http://emacswiki.org/emacs/Yasnippet</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">shk-yas/helm-prompt</span> (prompt choices <span class="org-type">&amp;optional</span> display-fn)
  <span class="org-doc">"Use helm to select a snippet. Put this into `</span><span class="org-doc"><span class="org-constant">yas/prompt-functions.</span></span><span class="org-doc">'"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> display-fn (<span class="org-keyword">or</span> display-fn 'identity))
  (<span class="org-keyword">if</span> (<span class="org-keyword">require</span> '<span class="org-constant">helm-config</span>)
      (<span class="org-keyword">let</span> (tmpsource cands result rmap)
        (<span class="org-keyword">setq</span> cands (mapcar (<span class="org-keyword">lambda</span> (x) (funcall display-fn x)) choices))
        (<span class="org-keyword">setq</span> rmap (mapcar (<span class="org-keyword">lambda</span> (x) (cons (funcall display-fn x) x)) choices))
        (<span class="org-keyword">setq</span> tmpsource
              (list
               (cons 'name prompt)
               (cons 'candidates cands)
               '(action . ((<span class="org-string">"Expand"</span> . (<span class="org-keyword">lambda</span> (selection) selection))))
               ))
        (<span class="org-keyword">setq</span> result (helm-other-buffer '(tmpsource) <span class="org-string">"*helm-select-yasnippet"</span>))
        (<span class="org-keyword">if</span> (null result)
            (<span class="org-warning">signal</span> 'quit <span class="org-string">"user quit!"</span>)
          (cdr (assoc result rmap))))
    nil))
</pre>
</div>

<p>
From <a href="https://github.com/pcmantz/elisp/blob/master/my-bindings.el">https://github.com/pcmantz/elisp/blob/master/my-bindings.el</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> default-cursor-color <span class="org-string">"gray"</span>)
(<span class="org-keyword">setq</span> yasnippet-can-fire-cursor-color <span class="org-string">"purple"</span>)

<span class="org-comment-delimiter">;; </span><span class="org-comment">It will test whether it can expand, if yes, cursor color -&gt; green.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">yasnippet-can-fire-p</span> (<span class="org-type">&amp;optional</span> field)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> yas--condition-cache-timestamp (current-time))
  (<span class="org-keyword">let</span> (templates-and-pos)
    (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> yas-expand-only-for-last-commands
                 (not (member last-command yas-expand-only-for-last-commands)))
      (<span class="org-keyword">setq</span> templates-and-pos (<span class="org-keyword">if</span> field
                                  (<span class="org-keyword">save-restriction</span>
                                    (narrow-to-region (yas--field-start field)
                                                      (yas--field-end field))
                                    (yas--templates-for-key-at-point))
                                (yas--templates-for-key-at-point))))
    (<span class="org-keyword">and</span> templates-and-pos (first templates-and-pos))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-change-cursor-color-when-can-expand</span> (<span class="org-type">&amp;optional</span> field)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (eq last-command 'self-insert-command)
    (set-cursor-color (<span class="org-keyword">if</span> (my-can-expand)
                          yasnippet-can-fire-cursor-color
                        default-cursor-color))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-can-expand</span> ()
  <span class="org-doc">"Return true if right after an expandable thing."</span>
  (<span class="org-keyword">or</span> (abbrev--before-point) (yasnippet-can-fire-p)))

                                        <span class="org-comment-delimiter">; </span><span class="org-comment">As pointed out by Dmitri, this will make sure it will update color when needed.</span>
(remove-hook 'post-command-hook 'my-change-cursor-color-when-can-expand)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-space-or-expand</span> ()
  <span class="org-doc">"For binding to the SPC SPC keychord."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">condition-case</span> nil (<span class="org-keyword">or</span> (my-hippie-expand-maybe nil) (insert <span class="org-string">"  "</span>))))
</pre>
</div>

<p>
This requires me to modify the behaviour of hippie-expand so that it doesn't ding so much.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-hippie-expand-maybe</span> (arg)
  <span class="org-doc">"Try to expand text before point, using multiple methods.</span>
<span class="org-doc">      The expansion functions in `</span><span class="org-doc"><span class="org-constant">hippie-expand-try-functions-list</span></span><span class="org-doc">' are</span>
<span class="org-doc">      tried in order, until a possible expansion is found.  Repeated</span>
<span class="org-doc">      application of `</span><span class="org-doc"><span class="org-constant">hippie-expand</span></span><span class="org-doc">' inserts successively possible</span>
<span class="org-doc">      expansions.</span>
<span class="org-doc">      With a positive numeric argument, jumps directly to the ARG next</span>
<span class="org-doc">      function in this list.  With a negative argument or just \\[</span><span class="org-doc"><span class="org-constant">universal-argument</span></span><span class="org-doc">],</span>
<span class="org-doc">      undoes the expansion."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">hippie-exp</span>)
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (not arg)
          (<span class="org-keyword">and</span> (integerp arg) (&gt; arg 0)))
      (<span class="org-keyword">let</span> ((first (<span class="org-keyword">or</span> (= he-num -1)
                       (not (equal this-command last-command)))))
        (<span class="org-keyword">if</span> first
            (<span class="org-keyword">progn</span>
              (<span class="org-keyword">setq</span> he-num -1)
              (<span class="org-keyword">setq</span> he-tried-table nil)))
        (<span class="org-keyword">if</span> arg
            (<span class="org-keyword">if</span> (not first) (he-reset-string))
          (<span class="org-keyword">setq</span> arg 0))
        (<span class="org-keyword">let</span> ((i (max (+ he-num arg) 0)))
          (<span class="org-keyword">while</span> (not (<span class="org-keyword">or</span> (&gt;= i (length hippie-expand-try-functions-list))
                          (apply (nth i hippie-expand-try-functions-list)
                                 (list (= he-num i)))))
            (<span class="org-keyword">setq</span> i (1+ i)))
          (<span class="org-keyword">setq</span> he-num i))
        (<span class="org-keyword">if</span> (&gt;= he-num (length hippie-expand-try-functions-list))
            (<span class="org-keyword">progn</span> (<span class="org-keyword">setq</span> he-num -1) nil)
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> hippie-expand-verbose
                   (not (window-minibuffer-p)))
              (message <span class="org-string">"Using %s"</span>
                       (nth he-num hippie-expand-try-functions-list)))))
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt;= he-num 0)
             (eq (marker-buffer he-string-beg) (current-buffer)))
        (<span class="org-keyword">progn</span>
          (<span class="org-keyword">setq</span> he-num -1)
          (he-reset-string)
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> hippie-expand-verbose
                   (not (window-minibuffer-p)))
              (message <span class="org-string">"Undoing expansions"</span>))))))

</pre>
</div>

<p>
yas/expand
yas-expand
</p>

<p>
because
because
Because
</p>
</div>
</div>
<div id="outline-container-show-column-number" class="outline-3">
<h3 id="show-column-number">Show column number</h3>
<div class="outline-text-3" id="text-show-column-number">
<p>
I sometimes need to know where I am in a line.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(column-number-mode 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-don-t-show-whitespace-in-diff-but-show-context" class="outline-3">
<h3 id="don-t-show-whitespace-in-diff-but-show-context">Don't show whitespace in diff, but show context</h3>
<div class="outline-text-3" id="text-don-t-show-whitespace-in-diff-but-show-context">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> vc-diff-switches '(<span class="org-string">"-b"</span> <span class="org-string">"-B"</span> <span class="org-string">"-u"</span>))
(<span class="org-keyword">setq</span> vc-git-diff-switches nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-javascript" class="outline-3">
<h3 id="javascript">Javascript</h3>
<div class="outline-text-3" id="text-javascript">
<p>
I like js2-mode.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'auto-mode-alist '(<span class="org-string">"\\.js\\'</span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-backslash">\\</span></span></span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-construct">|</span></span></span><span class="org-string"><span class="org-constant">\\.json\\</span></span><span class="org-string">'"</span> . js2-mode))
</pre>
</div>

<p>
Handy shortcuts:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> js2-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.js\\'"</span>
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> js2-mode-map (<span class="org-string">"C-c C-c"</span> . projectile-compile-project)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> coffee-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.coffee\\'"</span>
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> coffee-mode-map (<span class="org-string">"C-c C-c"</span> . compile)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> jasminejs-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:after</span> js2-mode
  <span class="org-builtin">:hook</span> ((js2-mode . jasminejs-mode)
         (jasminejs-mode-hook . jasminejs-add-snippets-to-yas-snippet-dirs)))
</pre>
</div>

<p>
This makes script blocks easier to copy:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-javascript-test-regexp</span> (concat (regexp-quote <span class="org-string">"/** Testing **/"</span>) <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*\n</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*"</span>)
  <span class="org-doc">"Regular expression matching testing-related code to remove.</span>
<span class="org-doc">      See `</span><span class="org-doc"><span class="org-constant">my-copy-javascript-region-or-buffer</span></span><span class="org-doc">'."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-javascript-region-or-buffer</span> (beg end)
  <span class="org-doc">"Copy the active region or the buffer, wrapping it in script tags.</span>
<span class="org-doc">      Add a comment with the current filename and skip test-related</span>
<span class="org-doc">      code. See `</span><span class="org-doc"><span class="org-constant">my-javascript-test-regexp</span></span><span class="org-doc">' to change the way</span>
<span class="org-doc">      test-related code is detected."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">unless</span> (region-active-p)
    (<span class="org-keyword">setq</span> beg (point-min) end (point-max)))
  (kill-new
   (concat
    <span class="org-string">"&lt;script type=\"text/javascript\"&gt;\n"</span>
    (<span class="org-keyword">if</span> (buffer-file-name) (concat <span class="org-string">"// "</span> (file-name-nondirectory (buffer-file-name)) <span class="org-string">"\n"</span>) <span class="org-string">""</span>)
    (replace-regexp-in-string
     my-javascript-test-regexp
     <span class="org-string">""</span>
     (buffer-substring (point-min) (point-max))
     nil)
    <span class="org-string">"\n&lt;/script&gt;"</span>)))
</pre>
</div>

<p>
This makes it easier to debug:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-debug-counter</span> 1)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-or-flush-debug</span> (<span class="org-type">&amp;optional</span> reset beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"pr"</span>)
  (<span class="org-keyword">cond</span>
   ((= reset 4)
    (<span class="org-keyword">save-excursion</span>
      (flush-lines <span class="org-string">"console.log('DEBUG: [0-9]+"</span> (point-min) (point-max))
      (<span class="org-keyword">setq</span> my-debug-counter 1)))
   ((region-active-p)
    (<span class="org-keyword">save-excursion</span>
      (goto-char end)
      (insert <span class="org-string">");\n"</span>)
      (goto-char beg)
      (insert (format <span class="org-string">"console.log('DEBUG: %d', "</span> my-debug-counter))
      (<span class="org-keyword">setq</span> my-debug-counter (1+ my-debug-counter))
      (js2-indent-line)))
   (t
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Wrap the region in the debug</span>
    (insert (format <span class="org-string">"console.log('DEBUG: %d');\n"</span> my-debug-counter))
    (<span class="org-keyword">setq</span> my-debug-counter (1+ my-debug-counter))
    (backward-char 3)
    (js2-indent-line))))
</pre>
</div>

<p>
And the rest of the js2 config:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> js2-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:commands</span> js2-mode
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:interpreter</span> <span class="org-string">"node"</span>
  <span class="org-builtin">:init</span> (<span class="org-keyword">setq</span> js-indent-level 2)
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> js2-mode-map
              (<span class="org-string">"C-x C-e"</span> . js-send-last-sexp)
              (<span class="org-string">"C-M-x"</span> . js-send-last-sexp-and-go)
              (<span class="org-string">"C-c d"</span> . my-insert-or-flush-debug)
              (<span class="org-string">"C-c C-b"</span> . js-send-buffer-and-go)
              (<span class="org-string">"C-c w"</span> . my-copy-javascript-region-or-buffer))
  <span class="org-builtin">:config</span> (js2-imenu-extras-setup))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> coffee-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:defer</span> t
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq-default</span> coffee-js-mode 'js2-mode coffee-tab-width 2))
</pre>
</div>
</div>
<div id="outline-container-indium" class="outline-4">
<h4 id="indium">Indium</h4>
<div class="outline-text-4" id="text-indium">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> indium
<span class="org-builtin">:hook</span> ((js2-mode . indium-interaction-mode)))
</pre>
</div>
</div>
</div>
<div id="outline-container-react" class="outline-4">
<h4 id="react">React</h4>
<div class="outline-text-4" id="text-react">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> rjsx-mode
  <span class="org-builtin">:if</span> my-laptop-p)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-html" class="outline-3">
<h3 id="html">HTML</h3>
<div class="outline-text-3" id="text-html">
<p>
Convenience function for getting rid of annoying spans
offby1 says there's (setq nxml-sexp-element-flag t)
</p>

<p>
&lt;span&gt;&lt;span&gt;Hello world&lt;/span&gt;&lt;/span&gt;
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-clean-up-spans-in-region</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">let</span> ((changed t))
      (<span class="org-keyword">while</span> changed
        (<span class="org-keyword">setq</span> changed nil)
        (goto-char beg)
        (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;span&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&lt;]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/span&gt;"</span> end t)
          (replace-match <span class="org-string">"\\1"</span>)
          (<span class="org-keyword">setq</span> changed t)))
      (<span class="org-keyword">setq</span> changed t)
      (<span class="org-keyword">while</span> changed
        (<span class="org-keyword">setq</span> changed nil)
        (goto-char beg)
        (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;span&gt;*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">&lt;a[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&lt;]+&gt;[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">&lt;]*&lt;/a&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/span&gt;"</span> end t)
          (replace-match <span class="org-string">"\\1"</span>)
          (<span class="org-keyword">setq</span> changed t))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-clean-up-spans-in-string</span> (string)
  (<span class="org-keyword">with-temp-buffer</span>
    (insert string)
    (my-clean-up-spans-in-region (point-min) (point-max))
    (buffer-string)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-clean-up-spans-in-string</span> ()
  (should (string= (my-clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;span&gt;Hello world&lt;/span&gt;&lt;/span&gt;"</span>)
                   <span class="org-string">"Hello world"</span>))
  (should (string= (my-clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;span&gt;&lt;a href=\"http://example.com\"&gt;Hello another world&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;"</span>)
                   <span class="org-string">"&lt;a href=\"http://example.com\"&gt;Hello another world&lt;/a&gt;"</span>))
  (should (string= (my-clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;h1&gt;Leave alone&lt;/h1&gt;&lt;/span&gt;"</span>) <span class="org-string">"&lt;span&gt;&lt;h1&gt;Leave alone&lt;/h1&gt;&lt;/span&gt;"</span>))
  (should (string= (my-clean-up-spans-in-string <span class="org-string">"&lt;span&gt;&lt;a href=\"http://example.com\"&gt;Leave&lt;/a&gt; alone&lt;/span&gt;"</span>)
                   <span class="org-string">"&lt;span&gt;&lt;a href=\"http://example.com\"&gt;Leave&lt;/a&gt; alone&lt;/span&gt;"</span>)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">(ert "my-clean-up-spans-in-string")</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-shell" class="outline-3">
<h3 id="shell">Shell</h3>
<div class="outline-text-3" id="text-shell">
<p>
Make files executable if the first file has a shebang (ex: <code>#!/bin/bash#</code>)
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'after-save-hook
          'executable-make-buffer-file-executable-if-script-p)
</pre>
</div>
</div>
<div id="outline-container-shellcheck" class="outline-4">
<h4 id="shellcheck">Shellcheck</h4>
<div class="outline-text-4" id="text-shellcheck">
<p>
<a href="https://amitp.blogspot.com/2023/10/emacs-and-shellcheck.html">https://amitp.blogspot.com/2023/10/emacs-and-shellcheck.html</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> flymake
  <span class="org-builtin">:bind</span> ((<span class="org-string">"S-e"</span> . flymake-show-project-diagnostics)))

(<span class="org-keyword">use-package</span> sh-script
  <span class="org-builtin">:hook</span> (sh-mode . flymake-mode))

(<span class="org-keyword">use-package</span> flymake-shellcheck)
(<span class="org-keyword">use-package</span> flymake
  <span class="org-builtin">:bind</span> ((<span class="org-string">"S-e"</span> . my-consult-flymake-project))
  <span class="org-builtin">:preface</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">my/consult-flymake-project</span> ()
    (<span class="org-keyword">interactive</span>)
    (consult-flymake t))
  <span class="org-builtin">:custom</span>
  (flymake-suppress-zero-counters t)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defface</span> <span class="org-variable-name">my-flymake-modeline-error-echo</span>
    '((t <span class="org-builtin">:inherit</span> 'flymake-error-echo <span class="org-builtin">:background</span> <span class="org-string">"red"</span>))
    <span class="org-doc">"Mode line flymake errors"</span>)
  (put 'flymake-error 'mode-line-face 'my/flymake-modeline-error-echo)
  (<span class="org-keyword">defface</span> <span class="org-variable-name">my-flymake-modeline-warning-echo</span>
    '((t <span class="org-builtin">:inherit</span> 'flymake-warning-echo <span class="org-builtin">:background</span> <span class="org-string">"orange"</span>))
    <span class="org-doc">"Mode line flymake warnings"</span>)
  (put 'flymake-warning 'mode-line-face 'my-flymake-modeline-warning-echo))
</pre>
</div>
</div>
</div>
<div id="outline-container-dwim-shell-command" class="outline-4">
<h4 id="dwim-shell-command">dwim-shell-command</h4>
<div class="outline-text-4" id="text-dwim-shell-command">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-dwim-shell-command</span> (prefix)
  <span class="org-doc">"Execute DWIM shell command asynchronously using noweb templates.</span>

<span class="org-doc">Which files</span>

<span class="org-doc">  `</span><span class="org-doc"><span class="org-constant">dwim-shell-command</span></span><span class="org-doc">' attempts to guess which file(s) you may want</span>
<span class="org-doc">  the command to operate on.</span>

<span class="org-doc">  1. If visiting a `</span><span class="org-doc"><span class="org-constant">dired</span></span><span class="org-doc">' buffer, draw the marked file(s).</span>
<span class="org-doc">  2. If visiting any other buffer with an associated file, use that.</span>

<span class="org-doc">Templates</span>

<span class="org-doc">  Operate on drawn files using either the following:</span>

<span class="org-doc">    &lt;&lt;f&gt;&gt; (file path,used by default)</span>
<span class="org-doc">    &lt;&lt;fne&gt;&gt; (file path without extension)</span>
<span class="org-doc">    &lt;&lt;e&gt;&gt; (extension)</span>
<span class="org-doc">    &lt;&lt;td&gt;&gt; (generate a temporary directory)</span>
<span class="org-doc">    &lt;&lt;*&gt;&gt; (all files joined)</span>
<span class="org-doc">    &lt;&lt;cb&gt;&gt; (clipboard)</span>
<span class="org-doc">    &lt;&lt;n&gt;&gt;, &lt;&lt;1n&gt;&gt;, or &lt;&lt;An&gt;&gt; (for current iteration)</span>

<span class="org-doc">  For example:</span>

<span class="org-doc">    With drawn files '(\"path/to/image1.png\" \"path/to/image2.png\")</span>

<span class="org-doc">   \"convert '</span><span class="org-doc"><span class="org-constant">&lt;&lt;f&gt;&gt;</span></span><span class="org-doc">' '</span><span class="org-doc"><span class="org-constant">&lt;&lt;fne&gt;&gt;.jpg</span></span><span class="org-doc">'\" expands to</span>

<span class="org-doc">     \"convert '</span><span class="org-doc"><span class="org-constant">path/to/image1.png</span></span><span class="org-doc">' '</span><span class="org-doc"><span class="org-constant">path/to/image1.jpg</span></span><span class="org-doc">'\"</span>
<span class="org-doc">     \"convert '</span><span class="org-doc"><span class="org-constant">path/to/image2.png</span></span><span class="org-doc">' '</span><span class="org-doc"><span class="org-constant">path/to/image2.jpg</span></span><span class="org-doc">'\"</span>

<span class="org-doc">   while \"ls -lh &lt;&lt;*&gt;&gt;\" expands to</span>

<span class="org-doc">     \"ls -lh path/to/image1.png path/to/image2.png\"</span>

<span class="org-doc">Focus</span>

<span class="org-doc">  `</span><span class="org-doc"><span class="org-constant">dwim-shell-command</span></span><span class="org-doc">' creates a process buffer to capture command</span>
<span class="org-doc">  output, but doesn't display or focus on it by default.  Instead,</span>
<span class="org-doc">  it tries to guess what's more convenient to focus on.</span>

<span class="org-doc">  While the process is busy, show a spinner in the minibuffer.  No</span>
<span class="org-doc">  focus changes.</span>

<span class="org-doc">  After process is finished:</span>

<span class="org-doc">  1. If there were any files created in the `</span><span class="org-doc"><span class="org-constant">default-directory</span></span><span class="org-doc">',</span>
<span class="org-doc">  jump to a `</span><span class="org-doc"><span class="org-constant">dired</span></span><span class="org-doc">' buffer and move point to the new file (via</span>
<span class="org-doc">  `</span><span class="org-doc"><span class="org-constant">dired-jump</span></span><span class="org-doc">').</span>

<span class="org-doc">  2. If no new files were created, automatically switch focus to the</span>
<span class="org-doc">  process buffer and display its output.</span>

<span class="org-doc">    Note: You can prevent this automatic focus by prepending your</span>
<span class="org-doc">    command with whitespace.</span>

<span class="org-doc">      |</span>
<span class="org-doc">      V</span>
<span class="org-doc">    \" convert '</span><span class="org-doc"><span class="org-constant">&lt;&lt;f&gt;&gt;</span></span><span class="org-doc">' '</span><span class="org-doc"><span class="org-constant">&lt;&lt;fne&gt;&gt;.jpg</span></span><span class="org-doc">'\"</span>

<span class="org-doc">  3. If the shell command caused any errors, offer to focus the</span>
<span class="org-doc">  process buffer and display its output.</span>

<span class="org-doc">Quick exit</span>

<span class="org-doc">  Process buffers are read-only and can be quickly closed by</span>
<span class="org-doc">  pressing `</span><span class="org-doc"><span class="org-constant">q</span></span><span class="org-doc">'.</span>

<span class="org-doc">Prefix</span>

<span class="org-doc">  With PREFIX, execute command that number of times."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"p"</span>)
  (<span class="org-keyword">let</span> ((script (read-shell-command dwim-shell-command-prompt)))
    (<span class="org-keyword">unless</span> (string-match <span class="org-string">"&lt;&lt;"</span> script) (<span class="org-keyword">setq</span> script (concat script <span class="org-string">" &lt;&lt;f&gt;&gt;"</span>)))
    (dwim-shell-command-on-marked-files
     dwim-shell-command-buffer-name script
     <span class="org-builtin">:repeat</span> prefix
     <span class="org-builtin">:shell-util</span> dwim-shell-command-shell-util
     <span class="org-builtin">:shell-args</span> dwim-shell-command-shell-args
     <span class="org-builtin">:silent-success</span> (string-prefix-p <span class="org-string">" "</span> script)
     <span class="org-builtin">:error-autofocus</span> (not dwim-shell-command-prompt-on-error))))

(<span class="org-keyword">use-package</span> dwim-shell-command
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:bind</span> (([remap shell-command] . my-dwim-shell-command)
         <span class="org-builtin">:map</span> dired-mode-map
         ([remap dired-do-async-shell-command] . my-dwim-shell-command)
         ([remap dired-do-shell-command] . my-dwim-shell-command)
         ([remap dired-smart-shell-command] . my-dwim-shell-command))
  )
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-magit" class="outline-3">
<h3 id="magit">Magit - nice git interface</h3>
<div class="outline-text-3" id="text-magit">
<p>
<a id="org51e4a2b"></a>
</p>

<p>
Thanks to sheijk for hints on tweaking magit to limit it to the current directory!
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-magit-stage-all-and-commit</span> (message)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">progn</span> (magit-diff-unstaged) (read-string <span class="org-string">"Commit Message: "</span>))))
  (magit-stage-modified)
  (magit-commit-create (list <span class="org-string">"-m"</span> message))
  (call-interactively #'magit-push-current-to-pushremote))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-magit-limit-to-directory</span> nil <span class="org-doc">"Limit magit status to a specific directory."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-magit-status-in-directory</span> (directory)
  <span class="org-doc">"Displays magit status limited to DIRECTORY.</span>
<span class="org-doc">Uses the current `</span><span class="org-doc"><span class="org-constant">default-directory</span></span><span class="org-doc">', or prompts for a directory</span>
<span class="org-doc">if called with a prefix argument. Sets `</span><span class="org-doc"><span class="org-constant">my-magit-limit-to-directory</span></span><span class="org-doc">'</span>
<span class="org-doc">so that it's still active even after you stage a change. Very experimental."</span>
  (<span class="org-keyword">interactive</span> (list (expand-file-name
                        (<span class="org-keyword">if</span> current-prefix-arg
                            (read-directory-name <span class="org-string">"Directory: "</span>)
                          default-directory))))
    (<span class="org-keyword">setq</span> my-magit-limit-to-directory directory)
    (magit-status directory))
(<span class="org-keyword">use-package</span> magit
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> magit-diff-options '(<span class="org-string">"-b"</span>)) <span class="org-comment-delimiter">; </span><span class="org-comment">ignore whitespace</span>
  (<span class="org-keyword">defadvice</span> <span class="org-function-name">magit-insert-untracked-files</span> (around sacha activate)
    (<span class="org-keyword">if</span> my-magit-limit-to-directory
        (magit-with-section (section untracked 'untracked <span class="org-string">"Untracked files:"</span> t)
                            (<span class="org-keyword">let</span> ((files (cl-mapcan
                                          (<span class="org-keyword">lambda</span> (f)
                                            (<span class="org-keyword">when</span> (eq (aref f 0) ??) (list f)))
                                          (magit-git-lines
                                           <span class="org-string">"status"</span> <span class="org-string">"--porcelain"</span> <span class="org-string">"--"</span> my-magit-limit-to-directory))))
                              (<span class="org-keyword">if</span> (not files)
                                  (<span class="org-keyword">setq</span> section nil)
                                (<span class="org-keyword">dolist</span> (file files)
                                  (<span class="org-keyword">setq</span> file (magit-decode-git-path (substring file 3)))
                                  (magit-with-section (section file file)
                                                      (insert <span class="org-string">"\t"</span> file <span class="org-string">"\n"</span>)))
                                (insert <span class="org-string">"\n"</span>))))
      ad-do-it))

  (<span class="org-keyword">defadvice</span> <span class="org-function-name">magit-insert-unstaged-changes</span> (around sacha activate)
    (<span class="org-keyword">if</span> my-magit-limit-to-directory
        (<span class="org-keyword">let</span> ((magit-current-diff-range (cons 'index 'working))
              (magit-diff-options (copy-sequence magit-diff-options)))
          (magit-git-insert-section (unstaged <span class="org-string">"Unstaged changes:"</span>)
                                    #'magit-wash-raw-diffs
                                    <span class="org-string">"diff-files"</span>
                                    <span class="org-string">"--"</span> my-magit-limit-to-directory
                                    ))
      ad-do-it))

  (<span class="org-keyword">defadvice</span> <span class="org-function-name">magit-insert-staged-changes</span> (around sacha activate)
    <span class="org-doc">"Limit to `</span><span class="org-doc"><span class="org-constant">my-magit-limit-to-directory</span></span><span class="org-doc">' if specified."</span>
    (<span class="org-keyword">if</span> my-magit-limit-to-directory
        (<span class="org-keyword">let</span> ((no-commit (not (magit-git-success <span class="org-string">"log"</span> <span class="org-string">"-1"</span> <span class="org-string">"HEAD"</span>))))
          (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> no-commit (magit-anything-staged-p))
            (<span class="org-keyword">let</span> ((magit-current-diff-range (cons <span class="org-string">"HEAD"</span> 'index))
                  (base (<span class="org-keyword">if</span> no-commit
                            (magit-git-string <span class="org-string">"mktree"</span>)
                          <span class="org-string">"HEAD"</span>))
                  (magit-diff-options (append '(<span class="org-string">"--cached"</span>) magit-diff-options)))
              (magit-git-insert-section (staged <span class="org-string">"Staged changes:"</span>)
                                        (apply-partially #'magit-wash-raw-diffs t)
                                        <span class="org-string">"diff-index"</span> <span class="org-string">"--cached"</span> base <span class="org-string">"--"</span> my-magit-limit-to-directory))))
      ad-do-it))
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-x v C-d"</span> . my-magit-status-in-directory)
         (<span class="org-string">"C-c g"</span> . magit-file-dispatch)
         (<span class="org-string">"C-x g"</span> . magit-status)
         (<span class="org-string">"C-x v p"</span> . magit-push)
         (<span class="org-string">"C-x v c"</span> . my-magit-stage-all-and-commit)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">;; From http://endlessparentheses.com/merging-github-pull-requests-from-emacs.html</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">(defun endless/load-gh-pulls-mode ()</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">"Start `</span><span class="org-comment"><span class="org-constant">magit-gh-pulls-mode</span></span><span class="org-comment">' only after a manual request."</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(interactive)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(require 'magit-gh-pulls)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(add-hook 'magit-mode-hook 'turn-on-magit-gh-pulls)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(magit-gh-pulls-mode 1)</span>
<span class="org-comment-delimiter">;;   </span><span class="org-comment">(magit-gh-pulls-reload))</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">(use-package magit-gh-pulls)</span>
</pre>
</div>

<p>
The proper way to implement this is probably to patch or override the
definition of magit-git-insert-section so that it takes a list of
options to add at the end of the command, but that can wait for another time (or braver souls).
</p>
</div>
<div id="outline-container-make-this-better-by-adding-a-post-command-options-variable" class="outline-4">
<h4 id="make-this-better-by-adding-a-post-command-options-variable"><span class="todo TODO">TODO</span> Make this better by adding a post command options variable</h4>
<div class="outline-text-4" id="text-make-this-better-by-adding-a-post-command-options-variable">
</div>
</div>
<div id="outline-container-org5fff014" class="outline-4">
<h4 id="org5fff014">Finding repos with uncommitted changes</h4>
<div class="outline-text-4" id="text-org5fff014">
<p>
Based on <a href="http://yitang.uk/2024/01/14/atomic-habit-in-emacs-keep-git-repos-clean/">http://yitang.uk/2024/01/14/atomic-habit-in-emacs-keep-git-repos-clean/</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-git-find-unclean-repo</span> (root-dir)
  <span class="org-doc">"Find repo with modified files."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">(interactive)</span>
  (<span class="org-keyword">setq</span> out nil)
  (<span class="org-keyword">dolist</span> (dir (directory-files-recursively root-dir <span class="org-string">"\\.git$"</span> t))
    (message <span class="org-string">"checking repo %s"</span> dir)
    (<span class="org-keyword">let*</span> ((git-dir (file-name-parent-directory dir))
           (default-directory git-dir))
      (<span class="org-keyword">unless</span> (string= <span class="org-string">""</span> (shell-command-to-string <span class="org-string">"git status --untracked=no --porcelain"</span>))
        (<span class="org-keyword">push</span> git-dir out))))
  out)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-list-uncommitted-projects</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((s (string-join
            (seq-keep
             (<span class="org-keyword">lambda</span> (root)
               (<span class="org-keyword">when-let</span> ((repo (my-git-find-unclean-repo root)))
                 (concat <span class="org-string">"- "</span>
                         (org-link-make-string
                          (format <span class="org-string">"elisp:(magit-status \"%s\")"</span>
                                  (car repo))
                          (file-name-nondirectory (replace-regexp-in-string <span class="org-string">"/$"</span> <span class="org-string">""</span> root))))))
             (seq-uniq
              (mapcar (<span class="org-keyword">lambda</span> (row)
                        (<span class="org-keyword">or</span> (projectile-project-root
                             (car row))
                            (car row)))
                      (cons '(<span class="org-string">"~/sync/emacs"</span>) my-project-web-base-list))))
            <span class="org-string">"\n"</span>)))
    (<span class="org-keyword">when</span> (called-interactively-p 'any)
      (switch-to-buffer (get-buffer-create <span class="org-string">"*Uncommitted*"</span>))
      (erase-buffer)
      (insert s)
      (org-mode))
    s))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(my-list-uncommitted-projects)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-forge" class="outline-3">
<h3 id="forge">Forge</h3>
<div class="outline-text-3" id="text-forge">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> forge
  <span class="org-builtin">:after</span> magit)
</pre>
</div>
</div>
</div>
<div id="outline-container-checking-things-out" class="outline-3">
<h3 id="checking-things-out">Checking things out</h3>
<div class="outline-text-3" id="text-checking-things-out">
<p>
Based on <a href="http://xenodium.com/emacs-clone-git-repo-from-clipboard/">http://xenodium.com/emacs-clone-git-repo-from-clipboard/</a> :
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-git-clone-destination</span> <span class="org-string">"~/vendor"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-git-clone-clipboard-url</span> ()
  <span class="org-doc">"Clone git URL in clipboard asynchronously and open in dired when finished."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-warning">cl-assert</span> (string-match-p <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">http</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">https</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">ssh</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">://"</span> (current-kill 0)) nil <span class="org-string">"No URL in clipboard"</span>)
  (<span class="org-keyword">let*</span> ((url (current-kill 0))
         (download-dir (expand-file-name my-git-clone-destination))
         (project-dir (concat (file-name-as-directory download-dir)
                              (file-name-base url)))
         (default-directory download-dir)
         (command (format <span class="org-string">"git clone %s"</span> url))
         (buffer (generate-new-buffer (format <span class="org-string">"*%s*"</span> command)))
         (proc))
    (<span class="org-keyword">when</span> (file-exists-p project-dir)
      (<span class="org-keyword">if</span> (y-or-n-p (format <span class="org-string">"%s exists. delete?"</span> (file-name-base url)))
          (delete-directory project-dir t)
        (<span class="org-warning">user-error</span> <span class="org-string">"Bailed"</span>)))
    (switch-to-buffer buffer)
    (<span class="org-keyword">setq</span> proc (start-process-shell-command (nth 0 (split-string command)) buffer command))
    (<span class="org-keyword">with-current-buffer</span> buffer
      (<span class="org-keyword">setq</span> default-directory download-dir)
      (shell-command-save-pos-or-erase)
      (<span class="org-keyword">require</span> '<span class="org-constant">shell</span>)
      (shell-mode)
      (view-mode +1))
    (set-process-sentinel proc (<span class="org-keyword">lambda</span> (process state)
                                 (<span class="org-keyword">let</span> ((output (<span class="org-keyword">with-current-buffer</span> (process-buffer process)
                                                 (buffer-string))))
                                   (kill-buffer (process-buffer process))
                                   (<span class="org-keyword">if</span> (= (process-exit-status process) 0)
                                       (<span class="org-keyword">progn</span>
                                         (message <span class="org-string">"finished: %s"</span> command)
                                         (dired project-dir))
                                     (<span class="org-warning">user-error</span> (format <span class="org-string">"%s\n%s"</span> command output))))))
    (set-process-filter proc #'comint-output-filter)))
</pre>
</div>
</div>
</div>
<div id="outline-container-git-messenger-shows-commit-message" class="outline-3">
<h3 id="git-messenger-shows-commit-message">git-messenger - shows commit message</h3>
<div class="outline-text-3" id="text-git-messenger-shows-commit-message">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> git-messenger
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-x v m"</span> . git-messenger:popup-message)))
</pre>
</div>
</div>
</div>
<div id="outline-container-tag-files" class="outline-3">
<h3 id="tag-files">Tag files</h3>
<div class="outline-text-3" id="text-tag-files">
<p>
I don't often use a TAGS file, but when I do, I don't want to have
to set my tags file per project. I search for it in the directory
tree instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-recursive-find-file</span> (file <span class="org-type">&amp;optional</span> directory)
  <span class="org-doc">"Find the first FILE in DIRECTORY or its parents."</span>
  (<span class="org-keyword">setq</span> directory (<span class="org-keyword">or</span> directory (file-name-directory (buffer-file-name)) (pwd)))
  (<span class="org-keyword">if</span> (file-exists-p (expand-file-name file directory))
      (expand-file-name file directory)
    (<span class="org-keyword">unless</span> (string= directory <span class="org-string">"/"</span>)
      (my-recursive-find-file file (expand-file-name <span class="org-string">".."</span> directory)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-find-tags</span> ()
  <span class="org-doc">"Set the TAGS file."</span>
  (set (make-variable-buffer-local 'tags-table-list) nil)
  (set (make-variable-buffer-local 'tags-file-name)
       (my-recursive-find-file <span class="org-string">"TAGS"</span>)))

(eval-after-load 'drupal-mode
  '(progn
     (add-hook 'drupal-mode-hook 'my-find-tags)))
</pre>
</div>
</div>
</div>
<div id="outline-container-projects-and-projectile" class="outline-3">
<h3 id="projects-and-projectile">Projects and projectile</h3>
<div class="outline-text-3" id="text-projects-and-projectile">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> projectile
  <span class="org-builtin">:diminish</span> projectile-mode
  <span class="org-builtin">:config</span>
  (define-key projectile-mode-map (kbd <span class="org-string">"C-c p"</span>) 'projectile-command-map)
  (projectile-mode +1)
  (<span class="org-keyword">setq</span> projectile-completion-system 'default)
  (<span class="org-keyword">setq</span> projectile-enable-caching t)
  (<span class="org-keyword">setq</span> projectile-indexing-method 'alien)
  (add-to-list 'projectile-globally-ignored-files <span class="org-string">"node_modules"</span>)
  (add-to-list 'projectile-globally-ignored-files <span class="org-string">".cache"</span>)
  (add-to-list 'projectile-globally-ignored-files <span class="org-string">"_cache"</span>)
  (add-to-list 'projectile-globally-ignored-files <span class="org-string">"~"</span>)
  (add-to-list 'projectile-globally-ignored-files <span class="org-string">"#"</span>))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Call with C-c p m m</span>
(<span class="org-keyword">use-package</span> makefile-executor
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (add-hook 'makefile-mode-hook 'makefile-executor-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-exploring-melpa-recipes" class="outline-3">
<h3 id="exploring-melpa-recipes">Exploring MELPA recipes</h3>
<div class="outline-text-3" id="text-exploring-melpa-recipes">
<div class="org-src-container">
<pre class="src src-emacs-lisp">
</pre>
</div>
</div>
</div>
<div id="outline-container-ruby" class="outline-3">
<h3 id="ruby">Ruby</h3>
<div class="outline-text-3" id="text-ruby">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> rinari <span class="org-builtin">:if</span> my-laptop-p)
(<span class="org-keyword">use-package</span> bundler <span class="org-builtin">:if</span> my-laptop-p)
(<span class="org-keyword">use-package</span> robe
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:hook</span>
  ((ruby-mode-hook . robe-mode)
   (robe-mode-hook . ac-robe-setup)
   (ruby-mode-hook . auto-complete-mode)))
(<span class="org-keyword">use-package</span> haml-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.haml\\'"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-rspec-verify-single</span> ()
  <span class="org-doc">"Runs the specified example at the point of the current buffer."</span>
  (<span class="org-keyword">interactive</span>)
  (rspec-run-single-file
   (concat
    (rspec-spec-file-for (buffer-file-name))
    <span class="org-string">":"</span>
    (<span class="org-keyword">save-restriction</span>
      (widen)
      (number-to-string (line-number-at-pos))))
   (rspec-core-options)))

(<span class="org-keyword">use-package</span> rspec-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> rspec-command-options <span class="org-string">"--fail-fast --format documentation"</span>)
    (<span class="org-keyword">bind-key</span> <span class="org-string">"C-c , ,"</span> 'rspec-rerun rspec-mode-map)
    (fset 'rspec-verify-single 'my-rspec-verify-single)))

</pre>
</div>

<p>
SASS
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> sass-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:hook</span> (sass-mode-hook . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">setq</span> indent-tabs-mode nil))))
(<span class="org-keyword">setq-default</span> indent-tabs-mode nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-skewer" class="outline-3">
<h3 id="skewer">Skewer</h3>
<div class="outline-text-3" id="text-skewer">
<p>
This lets you send HTML, CSS, and Javascript fragments to Google
Chrome. You may need to start Chrome with <code>chrome
--allow-running-insecure-content</code>, if you're using the user script
with HTTPS sites.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> skewer-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:hook</span>
  ((js2-mode-hook . skewer-mode)
   (css-mode-hook . skewer-css-mode)
   (html-mode-hook . skewer-html-mode)))
</pre>
</div>
</div>
</div>
<div id="outline-container-autocomplete" class="outline-3">
<h3 id="autocomplete">Autocomplete</h3>
<div class="outline-text-3" id="text-autocomplete">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'company
  (define-key company-mode-map (kbd <span class="org-string">"&lt;tab&gt;"</span>) 'company-indent-or-complete-common))
(<span class="org-keyword">use-package</span> company
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:init</span> (add-hook 'prog-mode-hook 'company-mode))
(<span class="org-keyword">use-package</span> company-posframe <span class="org-builtin">:if</span> my-laptop-p <span class="org-builtin">:init</span> (company-posframe-mode 1) <span class="org-builtin">:diminish</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-tern-for-javascript" class="outline-3">
<h3 id="tern-for-javascript">Tern - for Javascript</h3>
<div class="outline-text-3" id="text-tern-for-javascript">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> tern
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> tern-mode-keymap (<span class="org-string">"C-c C-c"</span> . compile))
  <span class="org-builtin">:hook</span> (js2-mode-hook . tern-mode)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">when</span> (eq system-type 'windows-nt) (<span class="org-keyword">setq</span> tern-command '(<span class="org-string">"cmd"</span> <span class="org-string">"/c"</span> <span class="org-string">"tern"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-docker" class="outline-3">
<h3 id="docker">Docker</h3>
<div class="outline-text-3" id="text-docker">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> dockerfile-mode
  <span class="org-builtin">:mode</span> (<span class="org-string">"Dockerfile\\'"</span> . dockerfile-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-google-spreadsheets-and-python-automate-spreadsheet-stuff" class="outline-3">
<h3 id="google-spreadsheets-and-python-automate-spreadsheet-stuff">SOMEDAY Google Spreadsheets and Python - automate spreadsheet stuff?</h3>
<div class="outline-text-3" id="text-google-spreadsheets-and-python-automate-spreadsheet-stuff">
<p>
<a href="https://www.twilio.com/blog/2017/02/an-easy-way-to-read-and-write-to-a-google-spreadsheet-in-python.html">https://www.twilio.com/blog/2017/02/an-easy-way-to-read-and-write-to-a-google-spreadsheet-in-python.html</a>
</p>
</div>
</div>
<div id="outline-container-automation" class="outline-3">
<h3 id="automation">Automation</h3>
<div class="outline-text-3" id="text-automation">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-xdotool-click-as-shell-command</span> ()
  (<span class="org-keyword">interactive</span>)
  (insert
   (shell-command-to-string <span class="org-string">"xdotool getmouselocation | sed -E 's/x:([0-9]+) y:([0-9]+) .*/xdotool mousemove \\1 \\2 click 1/'"</span>)))
</pre>
</div>
</div>
<div id="outline-container-multiple-cursors-mode" class="outline-4">
<h4 id="multiple-cursors-mode">Multiple cursors mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="drill">drill</span></span></h4>
<div class="outline-text-4" id="text-multiple-cursors-mode">
<p>
I often define keyboard macros to process multiple lines in a region.
Maybe <code>multiple-cursors</code> will be an even better way. Looks promising!
<a href="http://emacsrocks.com/e13.html">See Emacs Rocks episode 13 (multiple-cursors) for a great demo</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> multiple-cursors
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"C-c m t"</span> . mc/mark-all-like-this)
   (<span class="org-string">"C-c m m"</span> . mc/mark-all-like-this-dwim)
   (<span class="org-string">"C-c m l"</span> . mc/edit-lines)
   (<span class="org-string">"C-c m e"</span> . mc/edit-ends-of-lines)
   (<span class="org-string">"C-c m a"</span> . mc/edit-beginnings-of-lines)
   (<span class="org-string">"C-c m n"</span> . mc/mark-next-like-this)
   (<span class="org-string">"C-c m p"</span> . mc/mark-previous-like-this)
   (<span class="org-string">"C-c m s"</span> . mc/mark-sgml-tag-pair)
   (<span class="org-string">"C-c m d"</span> . mc/mark-all-like-this-in-defun)))
(<span class="org-keyword">use-package</span> phi-search)
(<span class="org-keyword">use-package</span> phi-search-mc <span class="org-builtin">:config</span> (phi-search-mc/setup-keys))
(<span class="org-keyword">use-package</span> mc-extras <span class="org-builtin">:config</span> (define-key mc/keymap (kbd <span class="org-string">"C-. ="</span>) 'mc/compare-chars))
</pre>
</div>

<p>
Thanks to <a href="http://irreal.org/blog/?p=1733">Irreal</a> and <a href="http://planet.emacsen.org/">Planet Emacsen</a> for the link!
</p>
</div>
</div>
<div id="outline-container-org22842b4" class="outline-4">
<h4 id="org22842b4">iedit</h4>
<div class="outline-text-4" id="text-org22842b4">
<p>
<a href="https://www.reddit.com/r/emacs/comments/19ec8v5/comment/kjhuyrq/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">https://www.reddit.com/r/emacs/comments/19ec8v5/comment/kjhuyrq/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> iedit
  <span class="org-builtin">:bind</span>
  ((<span class="org-string">"C-;"</span>  . iedit-mode) <span class="org-comment-delimiter">; </span><span class="org-comment">also note: C-' toggles focus of matches</span>
   <span class="org-builtin">:map</span> iedit-mode-keymap
   (<span class="org-string">"C-g"</span> . iedit-mode)) <span class="org-comment-delimiter">; </span><span class="org-comment">so I can exit iedit with C-g</span>
  <span class="org-builtin">:config</span>
  (advice-add #'iedit--get-scope    <span class="org-comment-delimiter">; </span><span class="org-comment">switch default to function scope</span>
              <span class="org-builtin">:filter-args</span>
              (<span class="org-keyword">defun</span> <span class="org-function-name">my-iedit-defun-by-default</span> (arg)
                (<span class="org-keyword">cond</span> ((eq (car arg) nil) '(0))
                      ((eq (car arg) 0) '(nil))
                      (t arg)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-eshell" class="outline-3">
<h3 id="eshell">Eshell</h3>
<div class="outline-text-3" id="text-eshell">
<p>
<a href="https://www.reddit.com/r/emacs/comments/b6n3t8/what_would_it_take_to_get_terminal_colors_in/">https://www.reddit.com/r/emacs/comments/b6n3t8/what_would_it_take_to_get_terminal_colors_in/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> xterm-color
  <span class="org-builtin">:commands</span> (xterm-color-filter))
(<span class="org-keyword">use-package</span> eshell
  <span class="org-builtin">:after</span> xterm-color
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> eshell-scroll-to-bottom-on-input t)
  (define-key eshell-mode-map (kbd <span class="org-string">"&lt;tab&gt;"</span>) #'company-complete)
  (define-key eshell-hist-mode-map (kbd <span class="org-string">"M-r"</span>) #'consult-history)
  (add-hook 'eshell-mode-hook
            (<span class="org-keyword">lambda</span> ()
              (setenv <span class="org-string">"TERM"</span> <span class="org-string">"xterm-256color"</span>)))
  (add-hook 'eshell-before-prompt-hook (<span class="org-keyword">setq</span> xterm-color-preserve-properties t))
  (add-to-list 'eshell-preoutput-filter-functions 'xterm-color-filter)
  (<span class="org-keyword">setq</span> eshell-output-filter-functions
        (remove 'eshell-handle-ansi-color eshell-output-filter-functions)))

</pre>
</div>
</div>
<div id="outline-container-orgf7ec8f1" class="outline-4">
<h4 id="orgf7ec8f1">Eshell completion</h4>
<div class="outline-text-4" id="text-orgf7ec8f1">
<p>
<a href="https://www.emacs.dyerdwelling.family/emacs/20240827210257-emacs--enhancing-eshell-to-be-more-fishy/">Source</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> capf-autosuggest
   <span class="org-builtin">:hook</span>
   (eshell-mode . capf-autosuggest-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-correctly-complete-commands-in-subdirectories" class="outline-4">
<h4 id="correctly-complete-commands-in-subdirectories">Correctly complete commands in subdirectories</h4>
<div class="outline-text-4" id="text-correctly-complete-commands-in-subdirectories">
<p>
From <a href="https://www.n16f.net/blog/eshell-key-bindings-and-completion/">https://www.n16f.net/blog/eshell-key-bindings-and-completion/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'eshell
  (<span class="org-keyword">defun</span> <span class="org-function-name">eshell--complete-commands-list</span> ()
    <span class="org-doc">"Generate list of applicable, visible commands."</span>
    (<span class="org-keyword">let</span> ((filename (pcomplete-arg)) glob-name)
      (<span class="org-keyword">if</span> (file-name-directory filename)
          (<span class="org-keyword">if</span> eshell-force-execution
              (pcomplete-dirs-or-entries nil #'file-readable-p)
            (pcomplete-executables))
        (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt; (length filename) 0)
                 (eq (aref filename 0) eshell-explicit-command-char))
            (<span class="org-keyword">setq</span> filename (substring filename 1)
                  pcomplete-stub filename
                  glob-name t))
        (<span class="org-keyword">let*</span> ((paths (eshell-get-path))
               (cwd (file-name-as-directory
                     (expand-file-name default-directory)))
               (path <span class="org-string">""</span>) (comps-in-path ())
               (file <span class="org-string">""</span>) (filepath <span class="org-string">""</span>) (completions ()))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Go thru each path in the search path, finding completions.</span>
          (<span class="org-keyword">while</span> paths
            (<span class="org-keyword">setq</span> path (file-name-as-directory
                        (expand-file-name (<span class="org-keyword">or</span> (car paths) <span class="org-string">"."</span>)))
                  comps-in-path
                  (<span class="org-keyword">and</span> (file-accessible-directory-p path)
                       (file-name-all-completions filename path)))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Go thru each completion found, to see whether it should</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">be used.</span>
            (<span class="org-keyword">while</span> comps-in-path
              (<span class="org-keyword">setq</span> file (car comps-in-path)
                    filepath (concat path file))
              (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (not (member file completions)) <span class="org-comment-delimiter">;</span>
                       (<span class="org-keyword">or</span> (string-equal path cwd)
                           (not (file-directory-p filepath)))
                       (<span class="org-keyword">if</span> eshell-force-execution
                           (file-readable-p filepath)
                         (file-executable-p filepath)))
                  (<span class="org-keyword">setq</span> completions (cons file completions)))
              (<span class="org-keyword">setq</span> comps-in-path (cdr comps-in-path)))
            (<span class="org-keyword">setq</span> paths (cdr paths)))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">Add aliases which are currently visible, and Lisp functions.</span>
          (pcomplete-uniquify-list
           (<span class="org-keyword">if</span> glob-name
               completions
             (<span class="org-keyword">setq</span> completions
                   (append (<span class="org-keyword">if</span> (fboundp 'eshell-alias-completions)
                               (eshell-alias-completions filename))
                           (eshell-winnow-list
                            (mapcar
                             (<span class="org-keyword">lambda</span> (name)
                               (substring name 7))
                             (all-completions (concat <span class="org-string">"eshell/"</span> filename)
                                              obarray #'functionp))
                            nil '(eshell-find-alias-function))
                           completions))
             (append (<span class="org-keyword">and</span> (<span class="org-keyword">or</span> eshell-show-lisp-completions
                              (<span class="org-keyword">and</span> eshell-show-lisp-alternatives
                                   (null completions)))
                          (all-completions filename obarray #'functionp))
                     completions))))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7dcabf0" class="outline-3">
<h3 id="org7dcabf0">SQLite</h3>
<div class="outline-text-3" id="text-org7dcabf0">
<p>
From <a href="https://christiantietze.de/posts/2024/01/emacs-sqlite-mode-open-sqlite-files-automatically/">https://christiantietze.de/posts/2024/01/emacs-sqlite-mode-open-sqlite-files-automatically/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> sqlite-mode
  <span class="org-builtin">:commands</span> sqlite-mode-open-file
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">ct/sqlite-view-file-magically</span> ()
    <span class="org-doc">"Runs `</span><span class="org-doc"><span class="org-constant">sqlite-mode-open-file</span></span><span class="org-doc">' on the file name visited by the</span>
<span class="org-doc">current buffer, killing it."</span>
    (<span class="org-keyword">require</span> '<span class="org-constant">sqlite-mode</span>)
    (<span class="org-keyword">let</span> ((file-name buffer-file-name))
      (kill-current-buffer)
      (sqlite-mode-open-file file-name)))
  (add-to-list 'magic-mode-alist '(<span class="org-string">"SQLite format 3\x00"</span> . ct/sqlite-view-file-magically)))
</pre>
</div>
</div>
</div>
<div id="outline-container-documentation" class="outline-3">
<h3 id="documentation">Documentation</h3>
<div class="outline-text-3" id="text-documentation">
<p>
Hmm, disable this for now
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> dash-docs
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">unless</span> (file-directory-p (dash-docs-docsets-path))
    (make-directory (dash-docs-docsets-path)))
 <span class="org-builtin">:dash</span> (python-mode <span class="org-string">"NumPy"</span> <span class="org-string">"OpenCV Python"</span> <span class="org-string">"Pandas"</span>)
 (web-mode <span class="org-string">"HTML"</span> <span class="org-string">"CSS"</span> <span class="org-string">"Handlebars"</span> <span class="org-string">"jQuery"</span>)
 (haml-mode <span class="org-string">"Haml"</span>)
 (conf-mode <span class="org-string">"Nginx"</span>)
 (markdown-mode <span class="org-string">"Markdown"</span>)
 (js2-mode <span class="org-string">"NodeJS"</span> <span class="org-string">"Express"</span> <span class="org-string">"MomentJS"</span> <span class="org-string">"jQuery"</span>)
 (emacs-lisp-mode <span class="org-string">"Emacs Lisp"</span>)
 (sh-mode <span class="org-string">"Bash"</span>))
(<span class="org-keyword">use-package</span> consult-dash
  <span class="org-builtin">:bind</span> ((<span class="org-string">"M-s d"</span> . consult-dash))
  <span class="org-builtin">:config</span>
  (consult-customize consult-dash <span class="org-builtin">:initial</span> (thing-at-point 'symbol)))
</pre>
</div>
<p>
dash-docs-search
</p>
</div>
</div>
</div>
<div id="outline-container-internet-relay-chat" class="outline-2">
<h2 id="internet-relay-chat">Internet Relay Chat</h2>
<div class="outline-text-2" id="text-internet-relay-chat">
<p>
IRC is a great way to hang out with other Emacs geeks.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> erc
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> erc-track-remove-disconnected-buffers t)
  (<span class="org-keyword">setq</span> erc-hide-list '(<span class="org-string">"PART"</span> <span class="org-string">"QUIT"</span> <span class="org-string">"JOIN"</span>))
  (<span class="org-keyword">setq</span> erc-autojoin-channels-alist '((<span class="org-string">"freenode.net"</span>
                                       <span class="org-string">"#org-mode"</span>
                                       <span class="org-string">"#emacs"</span>
                                       <span class="org-string">"#emacs-beginners"</span>
                                       <span class="org-string">"#emacs-ops"</span>)
                                      (<span class="org-string">"irc.chat.twitch.tv"</span>
                                       <span class="org-string">"#sachachua"</span>)
                                      (<span class="org-string">"irc.tilde.chat"</span>
                                       <span class="org-string">"#emacs.ch"</span>))
        erc-server <span class="org-string">"irc.freenode.net"</span>
        erc-nick <span class="org-string">"sachac"</span>
        erc-track '(<span class="org-string">"NICK"</span> <span class="org-string">"333"</span> <span class="org-string">"353"</span> <span class="org-string">"JOIN"</span> <span class="org-string">"PART"</span> <span class="org-string">"AWAY"</span>))
  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-OPME</span> ()
    <span class="org-doc">"Request chanserv to op me."</span>
    (erc-message <span class="org-string">"PRIVMSG"</span>
                 (format <span class="org-string">"chanserv op %s %s"</span>
                         (erc-default-target)
                         (erc-current-nick)) <span class="org-warning">nil))</span>

  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-DEOPME</span> ()
    <span class="org-doc">"Deop myself from current channel."</span>
    (erc-cmd-DEOP (format <span class="org-string">"%s"</span> (erc-current-nick))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-BAN</span> (nick)
    (<span class="org-keyword">let*</span> ((chan (erc-default-target))
           (who (erc-get-server-user nick))
           (host (erc-server-user-host who))
           (user (erc-server-user-login who)))
      (erc-server-send (format <span class="org-string">"MODE %s +b *!%s@%s"</span> chan user host))))

  (<span class="org-keyword">defun</span> <span class="org-function-name">erc-cmd-KICKBAN</span> (nick <span class="org-type">&amp;rest</span> reason)
    (<span class="org-keyword">setq</span> reason (mapconcat #'identity reason <span class="org-string">" "</span>))
    (<span class="org-keyword">and</span> (string= reason <span class="org-string">""</span>)
         (<span class="org-keyword">setq</span> reason nil))
    (erc-cmd-BAN nick)
    (erc-server-send (format <span class="org-string">"KICK %s %s %s"</span>
                             (erc-default-target)
                             nick
                             (<span class="org-keyword">or</span> reason
                                 <span class="org-string">"Kicked (kickban)"</span>))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">my-erc-clean-up</span> ()
    <span class="org-doc">"Clean up dead ERC buffers."</span>
    (<span class="org-keyword">interactive</span>)
    (mapc #'kill-buffer (erc-buffer-list (<span class="org-keyword">lambda</span> () (null (erc-server-process-alive)))))
    (erc-update-mode-line))
  )
</pre>
</div>
</div>
<div id="outline-container-search-logs" class="outline-3">
<h3 id="search-logs">Search logs</h3>
<div class="outline-text-3" id="text-search-logs">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-search-irc-logs</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/backups/server/home/.znc/users/sachac/moddata/log"</span>))
    (call-interactively 'consult-ripgrep)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-mastodon" class="outline-2">
<h2 id="mastodon">Mastodon</h2>
<div class="outline-text-2" id="text-mastodon">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> mastodon
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:quelpa</span>
  (mastodon <span class="org-builtin">:fetcher</span> git <span class="org-builtin">:url</span> <span class="org-string">"https://codeberg.org/martianh/mastodon.el.git"</span> <span class="org-builtin">:branch</span> <span class="org-string">"develop"</span>)
  <span class="org-comment-delimiter">;</span><span class="org-comment">:load-path "~/vendor/mastodon.el/lisp"</span>
  <span class="org-builtin">:bind</span>
  (<span class="org-builtin">:map</span> mastodon-mode-map
        (<span class="org-string">"g"</span> . mastodon-tl--update)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">see org-capture-templates addition</span>
        (<span class="org-string">"o"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (org-capture nil <span class="org-string">"m"</span>))))
  <span class="org-builtin">:commands</span> (mastodon-http--api mastodon-http--post mastodon-mode mastodon-http--get-search-json
                                mastodon-tl--get-local-timeline)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> mastodon-instance-url <span class="org-string">"https://social.sachachua.com"</span>
        mastodon-active-user <span class="org-string">"sacha"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-clear-auth</span> ()
  <span class="org-doc">"Fix alist-get: Wrong type argument: listp, (error . \"The access token is invalid\") error. Then you can use `</span><span class="org-doc"><span class="org-constant">mastodon-auth--access-token</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> mastodon-client--active-user-details-plist nil)
  (delete-file (concat user-emacs-directory <span class="org-string">"mastodon.plstore"</span>))
  (<span class="org-keyword">setq</span> mastodon-auth--token-alist nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-toot-public-string</span> (message)
  (<span class="org-keyword">interactive</span> <span class="org-string">"sMessage: "</span>)
  (<span class="org-keyword">let*</span> ((endpoint (mastodon-http--api <span class="org-string">"statuses"</span>))
         (args `((<span class="org-string">"status"</span> . ,message)
                 (<span class="org-string">"visibility"</span> . <span class="org-string">"public"</span>))))
    (mastodon-http--post endpoint args nil)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-show-my-followers</span> ()
  (<span class="org-keyword">interactive</span>)
  (mastodon-profile--make-profile-buffer-for
   (mastodon-profile--lookup-account-in-status (mastodon-auth--get-account-name) nil)
   <span class="org-string">"followers"</span>
   #'mastodon-profile--add-author-bylines))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-yank-mastodon-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((url (current-kill 0))
         (url-parsed (url-generic-parse-url url))
         (user (file-name-base (url-filename url-parsed))))
    (<span class="org-keyword">cond</span>
     ((derived-mode-p 'oddmuse-mode) (insert <span class="org-string">"["</span> url <span class="org-string">" "</span> user
                                             <span class="org-string">"@"</span> (url-host url-parsed) <span class="org-string">"]"</span>))
     ((derived-mode-p 'org-mode) (insert <span class="org-string">"[["</span> url <span class="org-string">"]["</span> user
                                         <span class="org-string">"@"</span> (url-host url-parsed) <span class="org-string">"]]"</span>))
     (t (insert url)))))

(autoload 'mastodon-notifications--get-mentions <span class="org-string">"mastodon-notifications"</span> nil t)


</pre>
</div>

<p>
I use <a href="https://tusky.app/">Tusky</a> on my Android phone in order to share post content with
<a href="https://github.com/orgzly/orgzly-android">Orgzly</a> (synchronized via <a href="https://syncthing.net/">Syncthing</a>) so that I can add TODOs or notes
to my Org Mode files. The following code makes it easy to open links
to things that look like Mastodon URLs by using mastodon.el.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(autoload 'mastodon-url-lookup <span class="org-string">"mastodon"</span>)
(add-to-list 'browse-url-handlers '(<span class="org-string">"https?://[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+/@[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]+/.*"</span> . my-mastodon-browse-url))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-browse-url</span> (url <span class="org-type">&amp;rest</span> _)
  <span class="org-doc">"Open URL."</span>
  (<span class="org-keyword">if</span> (string-match <span class="org-string">"medium\\.com"</span> url)
      (funcall browse-url-browser-function url)
    (mastodon-url-lookup url)))
</pre>
</div>

<p>
(thanks, <a href="https://mas.to/@ParetoOptimalDev/109378647927115065">@ParetoOptimalDev</a>!)
</p>
</div>
<div id="outline-container-copy-mastodon-link-for-emacs-news" class="outline-3">
<h3 id="copy-mastodon-link-for-emacs-news">Copy Mastodon link for Emacs News</h3>
<div class="outline-text-3" id="text-copy-mastodon-link-for-emacs-news">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-copy-link-dwim</span> (prefix)
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">if</span> prefix
      (mastodon-toot--copy-toot-url)
    (my-mastodon-copy-toot-as-author-link)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-emacs-news-copy-mastodon-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((url (org-entry-get (point) <span class="org-string">"ITEM"</span>)))
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"https://</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">@.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/"</span> url)
      (kill-new (org-link-make-string url (concat (match-string 2 url) <span class="org-string">"@"</span> (match-string 1 url)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-emacs-news-summarize-mastodon-items</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">while</span> (not (eobp))
    (<span class="org-keyword">let*</span> ((info (my-mastodon-get-note-info))
           (title (<span class="org-keyword">when</span> (car (plist-get info <span class="org-builtin">:links</span>))
                    (my-page-title (car (plist-get info <span class="org-builtin">:links</span>)))))
           (summary (read-string
                     (<span class="org-keyword">if</span> title
                         (format <span class="org-string">"Summary (%s): "</span> title)
                       <span class="org-string">"Summary: "</span>)
                     title)))
      (org-cut-subtree)
      (<span class="org-keyword">unless</span> (string= summary <span class="org-string">""</span>)
        (insert <span class="org-string">"- "</span> (org-link-make-string
                      (<span class="org-keyword">or</span> (car (plist-get info <span class="org-builtin">:links</span>))
                          (plist-get info <span class="org-builtin">:url</span>))
                      summary)
                (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (car (plist-get info <span class="org-builtin">:links</span>))
                         (plist-get info <span class="org-builtin">:handle</span>))
                    (concat <span class="org-string">" ("</span> (org-link-make-string (plist-get info <span class="org-builtin">:url</span>)
                                                       (plist-get info <span class="org-builtin">:handle</span>))
                            <span class="org-string">")"</span>)
                  <span class="org-string">""</span>)
                <span class="org-string">"\n"</span>)))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-get-note-info</span> ()
  <span class="org-doc">"Return (:handle ... :url ... :links ... :text) for the current subtree."</span>
  (<span class="org-keyword">let</span> ((url (org-entry-get (point) <span class="org-string">"ITEM"</span>))
        beg end
        handle)
    (<span class="org-keyword">save-excursion</span>
      (org-back-to-heading)
      (org-end-of-meta-data)
      (<span class="org-keyword">setq</span> beg (point))
      (<span class="org-keyword">setq</span> end (org-end-of-subtree))
      (<span class="org-keyword">when</span> (string-match <span class="org-string">"https://</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">@.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/"</span> url)
        (<span class="org-keyword">setq</span> handle (concat
                      (match-string 2 url) <span class="org-string">"@"</span> (match-string 1 url))))

      (list
       <span class="org-builtin">:handle</span> handle
       <span class="org-builtin">:url</span> (<span class="org-keyword">if</span> (string-match org-link-bracket-re url) (match-string 1 url) url)
       <span class="org-builtin">:links</span> (mapcar (<span class="org-keyword">lambda</span> (o) (org-element-property <span class="org-builtin">:raw-link</span> o))
                      (my-org-get-links-in-region beg end))
       <span class="org-builtin">:text</span> (string-trim (buffer-substring-no-properties beg end))))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-mastodon-get-note-info</span> ()
 (should
  (equal
   (<span class="org-keyword">with-temp-buffer</span>
     (insert <span class="org-string">"** SOMEDAY https://mastodon.online/@jcastp/111762105597746747         :news:</span>
<span class="org-string">:PROPERTIES:</span>
<span class="org-string">:CREATED:  [2024-01-22 Mon 05:51]</span>
<span class="org-string">:END:</span>

<span class="org-string">jcastp@mastodon.online - I've shared my emacs config: https://codeberg.org/jcastp/emacs.d</span>

<span class="org-string">After years of reading other's configs, copying really useful snippets, and tinkering a little bit myself, I wanted to give something back, although I'm still an amateur (and it shows, but I want to improve!)</span>

<span class="org-string">If you can find there something you can use, then I'm happy to be useful to the community.</span>

<span class="org-string">#emacs</span>
<span class="org-string">"</span>)
     (org-mode)
     (my-mastodon-get-note-info))
   '(<span class="org-builtin">:handle</span> <span class="org-string">"@jcastp@mastodon.online"</span>
             <span class="org-builtin">:url</span>
             <span class="org-string">"https://mastodon.online/@jcastp/111762105597746747"</span>
             <span class="org-builtin">:links</span>
             (<span class="org-string">"https://codeberg.org/jcastp/emacs.d"</span>)
             <span class="org-builtin">:text</span>
             <span class="org-string">"jcastp@mastodon.online - I've shared my emacs config: https://codeberg.org/jcastp/emacs.d\n\nAfter years of reading other's configs, copying really useful snippets, and tinkering a little bit myself, I wanted to give something back, although I'm still an amateur (and it shows, but I want to improve!)\n\nIf you can find there something you can use, then I'm happy to be useful to the community.\n\n#emacs"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-emacs-news-copy-mastodon-item</span> (<span class="org-type">&amp;optional</span> name-only)
  (<span class="org-keyword">interactive</span> (list current-prefix-arg))
  (<span class="org-keyword">let</span> (s)
    (<span class="org-keyword">with-current-buffer</span>
        (<span class="org-keyword">if</span> (string-match <span class="org-string">"emacs-news/index.org"</span> (buffer-file-name))
            (<span class="org-keyword">save-window-excursion</span>
              (other-window 1)
              (current-buffer))
          (current-buffer))
      (<span class="org-keyword">let</span> ((url (<span class="org-keyword">or</span> (thing-at-point 'url)
                     (<span class="org-keyword">progn</span>
                       (<span class="org-keyword">save-restriction</span>
                         (org-back-to-heading)
                         (org-narrow-to-subtree)
                         (org-end-of-meta-data)
                         (<span class="org-keyword">if</span> (re-search-forward org-link-any-re nil t)
                             (thing-at-point 'url)
                           (<span class="org-keyword">setq</span> name-only t)
                           (org-entry-get (point) <span class="org-string">"ITEM"</span>)
                           )))))
            (toot (org-entry-get (point) <span class="org-string">"ITEM"</span>))
            attrib)
        (<span class="org-keyword">when</span> (string-match org-link-bracket-re toot)
          (<span class="org-keyword">setq</span> toot (match-string 1 toot)))
        (<span class="org-keyword">when</span> (string-match <span class="org-string">"https://</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">@.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/"</span> toot)
          (<span class="org-keyword">setq</span> attrib (org-link-make-string toot
                                             (concat
                                              (match-string 2 toot) <span class="org-string">"@"</span> (match-string 1 toot)))))
        (<span class="org-keyword">setq</span> s
              (<span class="org-keyword">if</span> name-only
                  (format <span class="org-string">" (%s)"</span> attrib)
                (format <span class="org-string">"- %s (%s)\n"</span>
                        (org-link-make-string
                         url
                         (my-page-title url))
                        attrib)))))
    (<span class="org-keyword">when</span> (called-interactively-p 'any)
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"emacs-news/index.org"</span> (buffer-file-name))
          (insert s)
        (kill-new s)))
    s))
</pre>
</div>
</div>
</div>
<div id="outline-container-storing-mastodon-links-in-org-mode" class="outline-3">
<h3 id="storing-mastodon-links-in-org-mode">Storing Mastodon links in Org mode</h3>
<div class="outline-text-3" id="text-storing-mastodon-links-in-org-mode">
<p>
This snippet makes it easier to store links to posts with
<code>org-store-link</code> and to use them as automatic annotations in
<code>org-capture</code>. (2022-12-11: Now it links to media attachments, too!)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org6ef4601">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-store-link</span> ()
  <span class="org-doc">"Store links in Mastodon buffers."</span>
  (<span class="org-keyword">when</span> (derived-mode-p 'mastodon-mode)
    (<span class="org-keyword">let</span> ((json (get-text-property (point) 'item-json)))
      (org-link-store-props
       <span class="org-builtin">:link</span> (mastodon-toot--toot-url)
       <span class="org-builtin">:content</span> (mastodon-tl--content json)
       <span class="org-builtin">:text</span>
       (concat
        (string-trim (mastodon-tl--render-text (mastodon-tl--content json)))
        (<span class="org-keyword">if</span> (assoc-default 'media_attachments json)
            (concat <span class="org-string">"\n\n"</span>
                    (mapconcat
                     (<span class="org-keyword">lambda</span> (attachment)
                       (org-link-make-string
                        (assoc-default 'url attachment)
                        (assoc-default 'description attachment)))
                     (assoc-default 'media_attachments json)
                     <span class="org-string">"\n"</span>
                     )))
            <span class="org-string">""</span>)
        ))))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"mastodon"</span>
   <span class="org-builtin">:store</span> 'my-mastodon-store-link)
  (add-to-list 'org-capture-templates
               `(<span class="org-string">"m"</span> <span class="org-string">"Mastodon"</span> entry (file ,my-org-inbox-file)
                 <span class="org-string">"* %?\n\n#+begin_quote\n%:text\n#+end_quote\n\n%a"</span>
                 <span class="org-builtin">:prepend</span> t)))
</pre>
</div>
</div>
</div>
<div id="outline-container-mastodon-news" class="outline-3">
<h3 id="mastodon-news">Collecting Emacs News from Mastodon</h3>
<div class="outline-text-3" id="text-mastodon-news">
<p>
One of the things I like about browsing Mastodon in Emacs using
<a href="https://codeberg.org/martianh/mastodon.el">mastodon.el</a> is that I can modify my workflow to make things easier.
For example, I often come across links that I'd like to save for Emacs
News. I want to boost the post and save it to an Org file, and I can
do that with a single keystroke. It uses the my-mastodon-store-link
defined elsewhere in <a href="https://sachachua.com/dotemacs/#mastodon">my config</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (add-to-list
   'org-capture-templates
   '(<span class="org-string">"w"</span> <span class="org-string">"Emacs News"</span> entry (file+headline <span class="org-string">"~/sync/orgzly/news.org"</span> <span class="org-string">"Collect Emacs News"</span>)
     <span class="org-string">"* %a  :news:</span>

<span class="org-string">#+begin_quote</span>
<span class="org-string">%:text</span>
<span class="org-string">#+end_quote</span>

<span class="org-string">"</span>
     <span class="org-builtin">:prepend</span> t <span class="org-builtin">:immediate-finish</span> t)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-save-toot-for-emacs-news</span> ()
  (<span class="org-keyword">interactive</span>)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">boost if not already boosted</span>
  (<span class="org-keyword">unless</span> (get-text-property
           (car
            (mastodon-tl--find-property-range 'byline (point)))
           'boosted-p)
    (mastodon-toot--toggle-boost-or-favourite 'boost))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">store a link and capture the note</span>
  (org-capture nil <span class="org-string">"w"</span>))

(<span class="org-keyword">use-package</span> mastodon
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> mastodon-mode-map (<span class="org-string">"w"</span> . my-mastodon-save-toot-for-emacs-news)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org5ac3684" class="outline-3">
<h3 id="org5ac3684"><span class="done DONE">DONE</span> Combining Mastodon timelines using mastodon.el&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h3>
<div class="outline-text-3" id="text-org5ac3684">
<p>
I like checking out the #emacs hashtag when I put together Emacs News. In the past, I usually browsed the hashtag timeline on emacs.ch, which also picked up updates from other people that emacs.ch was following. Now that <a href="https://sachachua.com/blog/2024/09/moving-from-sachac-emacs-ch-to-sacha-social-sachachua-com/">I've moved to @sacha@social.sachachua.com</a> and <a href="https://emacs.ch/@emacs/113087752901949391">emacs.ch is winding down</a>, I wanted to see if there was a way for me to see a combined view using <a href="https://mastodon.social/api/v1/timelines/tag/emacs?count=40">mastodon.social's API feed</a> (paging by
<code>max_id</code> as needed). I haven't enabled public
timeline feeds on my server, so I also need to reuse the OAuth mechanics from mastodon.el.
</p>

<p>
First, let's start by making a unified timeline. By digging around in <code>mastodon-tl.el</code>, I found that I could easily create a timeline view by passing it a vector of toot JSONs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-fetch-posts-after</span> (base-url after-date)
  <span class="org-doc">"Page backwards through BASE-URL using max_id for all the posts after AFTER-DATE."</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">plz</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">mastodon-http</span>)
  (<span class="org-keyword">let</span> ((results [])
        (url base-url)
        (use-mastodon-el (not (string-match <span class="org-string">"^http"</span> base-url)))
        page filtered)
    (<span class="org-keyword">while</span> url
      (<span class="org-keyword">setq</span> page (<span class="org-keyword">if</span> use-mastodon-el
                     (mastodon-http--get-json (mastodon-http--api url) nil <span class="org-builtin">:silent</span>)
                   (seq-map (<span class="org-keyword">lambda</span> (o)
                              (cons (cons 'external t) o))
                            (plz 'get url <span class="org-builtin">:as</span> #'json-read)))
            filtered (seq-filter (<span class="org-keyword">lambda</span> (o) (string&lt; after-date (assoc-default 'created_at o)))
                                 page))
      (<span class="org-keyword">if</span> filtered
          (<span class="org-keyword">progn</span>
            (<span class="org-keyword">setq</span> results (seq-concatenate 'vector filtered results)
                  url (concat base-url (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\?"</span> base-url) <span class="org-string">"&amp;"</span> <span class="org-string">"?"</span>)
                              <span class="org-string">"max_id="</span> (number-to-string (1- (string-to-number (assoc-default 'id (elt (last page) 0)))))))
            (message <span class="org-string">"%s %s"</span> (assoc-default 'created_at (elt (last page) 0)) url))
        (<span class="org-keyword">setq</span> url nil)))
    results))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-combined-tag-timeline</span> (later-than tag servers)
  <span class="org-doc">"Display items after LATER-THAN about TAG from SERVERS and the current mastodon.el account."</span>
  (<span class="org-keyword">interactive</span> (list
                (org-read-date nil nil nil nil nil <span class="org-string">"-Mon"</span>)
                <span class="org-string">"#emacs"</span>
                '(<span class="org-string">"mastodon.social"</span> <span class="org-string">"emacs.ch"</span>)))
  (<span class="org-keyword">require</span> '<span class="org-constant">mastodon</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">mastodon-tl</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">mastodon-toot</span>)
  (<span class="org-keyword">let*</span> ((limit 40)
         (sources (cons (format <span class="org-string">"timelines/tag/emacs?count=%d"</span> limit)
                        (mapcar (<span class="org-keyword">lambda</span> (s)
                                  (format <span class="org-string">"https://%s/api/v1/timelines/tag/emacs?count=%d"</span> s limit))
                                servers)))
         (combined
          (sort
           (seq-reduce (<span class="org-keyword">lambda</span> (prev val)
                         (seq-union prev
                                    (my-mastodon-fetch-posts-after val later-than)
                                    (<span class="org-keyword">lambda</span> (a b) (string= (assoc-default 'uri a)
                                                           (assoc-default 'uri b)))))
                       sources [])
           (<span class="org-keyword">lambda</span> (a b)
             (string&lt; (assoc-default 'created_at b)
                      (assoc-default 'created_at a))))))
    (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Combined*"</span>)
      (<span class="org-keyword">let</span> ((inhibit-read-only t))
        (erase-buffer)
        (mastodon-tl--timeline combined)
        (mastodon-mode))
      (<span class="org-keyword">setq</span> mastodon-tl--buffer-spec `(account ,(cons mastodon-active-user mastodon-instance-url) buffer-name ,(buffer-name)))
      (display-buffer (current-buffer)))))
</pre>
</div>

<p>
The tricky thing is that boosting and replying in
mastodon.el both use the toot IDs instead of the
toot URLs, so they only work for toots that came
in via my current mastodon.el account. Toots from
other timelines might not have been fetched by my
server yet. Adding an <code>external</code> property lets me
find that in the <code>item_json</code> text property in the
timeline buffer. For those toots, I can use
<code>(mastodon-url-lookup (mastodon-toot--toot-url))</code>
to open the toot in a new buffer that does allow
boosting or replying, which is probably enough for
my purposes.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-lookup-toot</span> ()
  (<span class="org-keyword">interactive</span>)
  (mastodon-url-lookup (mastodon-toot--toot-url)))
</pre>
</div>

<p>
When I go through Emacs News, I have a shortcut
ethat boosts a post and saves it to as an Org Mode
capture with a link to the toot. I sometimes want
to reply, too. So I just need to intervene before
boosting and replying. Boosting and favoriting
both use <code>mastodon-toot--action</code>, which looks up
the <code>base-item-id</code> text property. Replying looks
up the <code>item-json</code> property and gets the <code>id</code> from
it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-text-property-update-at-point</span> (pos prop value)
  (<span class="org-keyword">let</span> ((start (previous-single-property-change (<span class="org-keyword">or</span> pos (point)) prop))
        (end (next-single-property-change (<span class="org-keyword">or</span> pos (point)) prop)))
    (put-text-property (<span class="org-keyword">or</span> start (point-min))
                       (<span class="org-keyword">or</span> end (point-max))
                       prop value)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-update-external-item-id</span> (<span class="org-type">&amp;rest</span> _)
  (<span class="org-keyword">when</span> (mastodon-tl--field 'external (mastodon-tl--property 'item-json))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">ask the server to resolve it</span>
    (<span class="org-keyword">let*</span> ((response (mastodon-http--get-json (format <span class="org-string">"%s/api/v2/search"</span> mastodon-instance-url)
                                              `((<span class="org-string">"q"</span> . ,(mastodon-toot--toot-url))
                                                (<span class="org-string">"resolve"</span> . <span class="org-string">"t"</span>))))
           (id (alist-get 'id (seq-first (assoc-default 'statuses response))))
           (inhibit-read-only t)
           (json (get-text-property (point) 'item-json)))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> id json)
        (my-text-property-update-at-point (point) 'base-item-id id)
        (my-text-property-update-at-point (point) 'item-json
                                          (<span class="org-keyword">progn</span>
                                            (<span class="org-keyword">setf</span> (alist-get 'id json) id)
                                            (<span class="org-keyword">setf</span> (alist-get 'external json) nil)
                                            json))))))
</pre>
</div>

<p>
So now all I need to do is make sure that this is called before the relevant mastodon.el functions if I'm looking at an external toot.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'mastodon-tl
  (advice-add #'mastodon-toot--action <span class="org-builtin">:before</span> #'my-mastodon-update-external-item-id)
  (advice-add #'mastodon-toot--reply <span class="org-builtin">:before</span> #'my-mastodon-update-external-item-id)
  (advice-add #'mastodon-tl--thread <span class="org-builtin">:before</span> #'my-mastodon-update-external-item-id))
</pre>
</div>

<p>
The only thing is that I need to press RET after loading a thread with T (<code>mastodon-tl--thread</code>) for some reason, but that's okay. Now I can boost and save posts with my usual Emacs News shortcut, and I can reply easily too.
</p>

<p>
I'm curious: how many toots would I be missing if I looked at only one instance's hashtag? Let's look at the #emacs hashtag toots on 2024-09-12:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orge113507">(<span class="org-keyword">defun</span> <span class="org-function-name">my-three-way-comparison</span> (seq1 seq2 seq3 <span class="org-type">&amp;optional</span> test-fn)
  `((<span class="org-string">"1"</span> ,@(seq-difference seq1 (seq-union seq2 seq3 test-fn) test-fn))
    (<span class="org-string">"2"</span> ,@(seq-difference seq2 (seq-union seq1 seq3 test-fn) test-fn))
    (<span class="org-string">"3"</span> ,@(seq-difference seq3 (seq-union seq1 seq2 test-fn) test-fn))
    (<span class="org-string">"1&amp;2"</span> ,@(seq-difference (seq-intersection seq1 seq2 test-fn) seq3 test-fn))
    (<span class="org-string">"1&amp;3"</span> ,@(seq-difference (seq-intersection seq1 seq3 test-fn) seq2 test-fn))
    (<span class="org-string">"2&amp;3"</span> ,@(seq-difference (seq-intersection seq2 seq3 test-fn) seq1 test-fn))
    (<span class="org-string">"1&amp;2&amp;3"</span> ,@(seq-intersection (seq-intersection seq2 seq3 test-fn) seq1 test-fn))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-three-way-comparison-report</span> (label1 seq1 label2 seq2 label3 seq3 <span class="org-type">&amp;optional</span> test-fn)
  (<span class="org-keyword">let</span> ((list (my-three-way-comparison seq1 seq2 seq3)))
    `((,(format <span class="org-string">"%s only"</span> label1) ,@(assoc-default <span class="org-string">"1"</span> list #'string=))
      (,(format <span class="org-string">"%s only"</span> label2) ,@(assoc-default <span class="org-string">"2"</span> list #'string=))
      (,(format <span class="org-string">"%s only"</span> label3) ,@(assoc-default <span class="org-string">"3"</span> list #'string=))
      (,(format <span class="org-string">"%s &amp; %s"</span> label1 label2) ,@(assoc-default <span class="org-string">"1&amp;2"</span> list #'string=))
      (,(format <span class="org-string">"%s &amp; %s"</span> label1 label3) ,@(assoc-default <span class="org-string">"1&amp;3"</span> list #'string=))
      (,(format <span class="org-string">"%s &amp; %s"</span> label2 label3) ,@(assoc-default <span class="org-string">"2&amp;3"</span> list #'string=))
      (<span class="org-string">"all"</span> ,@(assoc-default <span class="org-string">"1&amp;2&amp;3"</span> list #'string=)))))

(assert (equal (my-three-way-comparison '(<span class="org-string">"A"</span> <span class="org-string">"A&amp;B"</span> <span class="org-string">"A&amp;C"</span> <span class="org-string">"A&amp;B&amp;C"</span> <span class="org-string">"A1"</span>)
                                        '(<span class="org-string">"B"</span> <span class="org-string">"A&amp;B"</span> <span class="org-string">"A&amp;B&amp;C"</span> <span class="org-string">"B&amp;C"</span>)
                                        '(<span class="org-string">"C"</span> <span class="org-string">"A&amp;C"</span> <span class="org-string">"A&amp;B&amp;C"</span> <span class="org-string">"B&amp;C"</span>))
               '((<span class="org-string">"1"</span> <span class="org-string">"A"</span> <span class="org-string">"A1"</span>)
                 (<span class="org-string">"2"</span> <span class="org-string">"B"</span>)
                 (<span class="org-string">"3"</span> <span class="org-string">"C"</span>)
                 (<span class="org-string">"1&amp;2"</span> <span class="org-string">"A&amp;B"</span>)
                 (<span class="org-string">"1&amp;3"</span> <span class="org-string">"A&amp;C"</span>)
                 (<span class="org-string">"2&amp;3"</span> <span class="org-string">"B&amp;C"</span>)
                 (<span class="org-string">"1&amp;2&amp;3"</span> <span class="org-string">"A&amp;B&amp;C"</span>))))

(<span class="org-keyword">let*</span> ((later-than <span class="org-string">"2024-09-12"</span>)
       (earlier-than <span class="org-string">"2024-09-13"</span>)
       (results
        (mapcar (<span class="org-keyword">lambda</span> (o)
                  (cons (car o)
                        (seq-map (<span class="org-keyword">lambda</span> (o) (assoc-default 'uri o))
                                 (seq-filter (<span class="org-keyword">lambda</span> (toot)
                                               (string&lt; (assoc-default 'created_at toot)
                                                        earlier-than))
                                             (my-mastodon-fetch-posts-after
                                              (format <span class="org-string">"%stimelines/tag/emacs?count=40"</span> (cdr o))
                                              later-than)))))
                `((mastodon-social . <span class="org-string">"https://mastodon.social/api/v1/"</span>)
                  (emacs-ch . <span class="org-string">"https://emacs.ch/api/v1/"</span>)
                  (my-instance . <span class="org-string">""</span>))))
       (intersections
        (<span class="org-keyword">let-alist</span> results
          (my-three-way-comparison-report
           <span class="org-string">"mastodon.social"</span>
           .mastodon-social
           <span class="org-string">"emacs.ch"</span>
           .emacs-ch
           <span class="org-string">"my instance"</span>
           .my-instance
           #'string=))))
  (mapcar
   (<span class="org-keyword">lambda</span> (row)
     (list (elt row 0) (length (cdr row))
           (string-join
            (seq-map-indexed (<span class="org-keyword">lambda</span> (o i)
                               (org-link-make-string o (number-to-string (1+ i))))
                             (cdr row))
            <span class="org-string">" "</span>)))
   intersections))
</pre>
</div>

<div class="bordered" id="org8764e5a">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">mastodon.social only</td>
<td class="org-right">3</td>
<td class="org-left"><a href="https://ubuntu.social/users/askubuntu/statuses/113126414967731060">1</a> <a href="https://fosstodon.org/users/yabozdar/statuses/113124526863236697">2</a> <a href="https://kolektiva.social/users/capita_picat/statuses/113124061187135721">3</a></td>
</tr>

<tr>
<td class="org-left">emacs.ch only</td>
<td class="org-right">1</td>
<td class="org-left"><a href="https://emacs.ch/users/pi/statuses/113121971331083227">1</a></td>
</tr>

<tr>
<td class="org-left">my instance only</td>
<td class="org-right">0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">mastodon.social &amp; emacs.ch</td>
<td class="org-right">9</td>
<td class="org-left"><a href="https://mastodon.sdf.org/users/weigand/statuses/113126692283977409">1</a> <a href="https://hostux.social/users/lfa/statuses/113126305338701924">2</a> <a href="https://hostux.social/users/fsf/statuses/113125825197787920">3</a> <a href="https://fosstodon.org/users/dliden/statuses/113125752869246982">4</a> <a href="https://mas.to/users/evgandr/statuses/113125145671040666">5</a> <a href="https://communick.news/post/1596509">6</a> <a href="https://metalhead.club/users/stevoooo/statuses/113123854333728005">7</a> <a href="https://hachyderm.io/users/fastloris/statuses/113127270000776260">8</a> <a href="https://hostux.social/users/fsf/statuses/113126828026063155">9</a></td>
</tr>

<tr>
<td class="org-left">mastodon.social &amp; my instance</td>
<td class="org-right">0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">emacs.ch &amp; my instance</td>
<td class="org-right">1</td>
<td class="org-left"><a href="https://emacs.ch/users/pi/statuses/113126219575933425">1</a></td>
</tr>

<tr>
<td class="org-left">all</td>
<td class="org-right">11</td>
<td class="org-left"><a href="https://social.howellcloud.org/users/james/statuses/113125822427655325">1</a> <a href="https://fosstodon.org/users/robjperez/statuses/113125629561857570">2</a> <a href="https://mastodon.sdf.org/users/bmp/statuses/113125454491301488">3</a> <a href="https://sonomu.club/users/kf/statuses/113125290519531930">4</a> <a href="https://mastodon.social/users/adbenitez/statuses/113125114284046731">5</a> <a href="https://mastodon.social/users/lisp_discussions/statuses/113124797381303645">6</a> <a href="https://mathstodon.xyz/users/lepisma/statuses/113124048647122410">7</a> <a href="https://mastodon.communick.com/users/raphael/statuses/113123503889071870">8</a> <a href="https://emacs.ch/users/ramin_hal9001/statuses/113123160658553524">9</a> <a href="https://fosstodon.org/users/willbush/statuses/113123135443452059">10</a> <a href="https://recurse.social/users/mclare/statuses/113126571790537222">11</a></td>
</tr>
</tbody>
</table>

</div>

<p>
Here's an Euler diagram visualizing it.
</p>


<figure id="org7f6210d">
<img src="file:///home/sacha/recordings/2024-09-13-12-45-10.png" alt="2024-09-13-12-45-10.png">

<figcaption><span class="figure-number">Figure 11: </span>#emacs posts on 2024-09-12 - an Euler diagram showing the table above</figcaption>
</figure>

<p>
I love that I can tinker with mastodon.el to get
it to combine the timelines. (I'm crossing the
streams!) Yay Emacs!
</p>
</div>
</div>
<div id="outline-container-following-people" class="outline-3">
<h3 id="following-people">Following people</h3>
<div class="outline-text-3" id="text-following-people">
<p>
I want to be able to follow people if I specify their ID.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-follow-user</span> (user-handle)
  <span class="org-doc">"Follow HANDLE."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MHandle: "</span>)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"https?://</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">@.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> user-handle)
    (<span class="org-keyword">setq</span> user-handle (concat (match-string 2 user-handle) <span class="org-string">"@"</span> (match-string 1 user-handle))))
  (<span class="org-keyword">let*</span> ((account (mastodon-profile--search-account-by-handle
                   user-handle))
         (user-id (mastodon-profile--account-field account 'id))
         (name (<span class="org-keyword">if</span> (not (string-empty-p (mastodon-profile--account-field account 'display_name)))
                   (mastodon-profile--account-field account 'display_name)
                 (mastodon-profile--account-field account 'username)))
         (url (mastodon-http--api (format <span class="org-string">"accounts/%s/%s"</span> user-id <span class="org-string">"follow"</span>))))
    (<span class="org-keyword">if</span> account
        (mastodon-tl--do-user-action-function url name user-handle <span class="org-string">"follow"</span>)
      (message <span class="org-string">"Cannot find a user with handle %S"</span> user-handle))))
</pre>
</div>
</div>
</div>
<div id="outline-container-mastodon-toot-subtree" class="outline-3">
<h3 id="mastodon-toot-subtree">Compose a Mastodon toot with the current Org subtree</h3>
<div class="outline-text-3" id="text-mastodon-toot-subtree">
<p>
I want to make it easier to microblog the current Org subtree.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-toot-subtree</span> ()
  <span class="org-doc">"Compose a buffer and include the current subtree."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((text (org-export-as 'md t nil t)))
    (mastodon-toot)
    (insert text)))
</pre>
</div>

<p>
The automatic link to my configuration is handled by a function that I add to <code>org-export-filter-body-functions</code>:
<a href="https://sachachua.com/dotemacs#config-footer">https://sachachua.com/dotemacs#config-footer</a>
</p>
</div>
</div>
<div id="outline-container-posting-the-latest-screenshot-with-mastodon-el" class="outline-3">
<h3 id="posting-the-latest-screenshot-with-mastodon-el">Posting the latest screenshot with mastodon.el</h3>
<div class="outline-text-3" id="text-posting-the-latest-screenshot-with-mastodon-el">
<p>
I want to make it easier to microblog the latest screenshot, or a
recent screenshot if I need to pick a different one. It might also be
a good time to add some text to the filename to make it easier to find
later on. I can use that text as alt-text for the image, too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-toot-screenshot</span> (<span class="org-type">&amp;optional</span> filename description)
  <span class="org-doc">"Compose a buffer and attach the latest screenshot.</span>
<span class="org-doc">Prompt for a description and add that to the filename as well.</span>
<span class="org-doc">When called with a prefix argument, prompt for the file.</span>
<span class="org-doc">Use consult to provide a preview."</span>
  (<span class="org-keyword">interactive</span>
   (<span class="org-keyword">let</span> ((filename
          (<span class="org-keyword">if</span> current-prefix-arg
              (expand-file-name
               (consult--read
                (reverse (directory-files my-screenshot-directory nil <span class="org-string">"\\.png$"</span>))
                <span class="org-builtin">:sort</span> nil
                <span class="org-builtin">:require-match</span> t
                <span class="org-builtin">:category</span> 'file
                <span class="org-builtin">:state</span> (<span class="org-keyword">lambda</span> (candidate state)
                         (<span class="org-keyword">when</span> candidate
                           (<span class="org-keyword">with-current-buffer</span> (find-file-noselect
                                                 (expand-file-name candidate my-screenshot-directory))
                             (display-buffer (current-buffer))))))
               my-screenshot-directory)
            (my-latest-file my-screenshot-directory))))
     (list
      filename
      (<span class="org-keyword">when</span> (string-match <span class="org-string">"^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]_[0-9][0-9]-[0-9][0-9]-[0-9][0-9]$"</span> (file-name-base filename))
        (display-buffer (find-file-noselect filename))
        (read-string <span class="org-string">"Description: "</span>)))))
  (<span class="org-keyword">let</span> ((new-filename (<span class="org-keyword">if</span> (string= (<span class="org-keyword">or</span> description <span class="org-string">""</span>) <span class="org-string">""</span>)
                          nil
                        (expand-file-name
                         (concat (file-name-base filename) <span class="org-string">" "</span> description
                                 (file-name-extension filename))
                         (file-name-directory filename)))))
    (<span class="org-keyword">if</span> new-filename
        (rename-file filename new-filename))
    (<span class="org-keyword">unless</span> (string-match <span class="org-string">"new toot"</span> (buffer-name)) <span class="org-comment-delimiter">; </span><span class="org-comment">can't match off major mode yet</span>
      (mastodon-toot))
    (mastodon-toot--attach-media
     (<span class="org-keyword">or</span> new-filename filename) <span class="org-string">"image/png"</span>
     (<span class="org-keyword">or</span> description
         (<span class="org-keyword">when</span> (string-match <span class="org-string">"^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]_[0-9][0-9]-[0-9][0-9]-[0-9][0-9] </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> (<span class="org-keyword">save-match-data</span> (file-name-base filename)))
           (match-string 1 (<span class="org-keyword">save-match-data</span> (file-name-base filename))))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-mastodon-keyboard-shortcuts-via-hydra" class="outline-3">
<h3 id="mastodon-keyboard-shortcuts-via-hydra">Mastodon keyboard shortcuts via Hydra</h3>
<div class="outline-text-3" id="text-mastodon-keyboard-shortcuts-via-hydra">
<p>
Based on <a href="https://github.com/holgerschurig/emacs-doom-config/blob/master/config.el#L2397">https://github.com/holgerschurig/emacs-doom-config/blob/master/config.el#L2397</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"> <span class="org-comment-delimiter">;; </span><span class="org-comment">Not in the following hydra, but mentioned in "M-x describe-mode". Also, the README.org</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">contains several functions that aren't in my hydra.</span>
  <span class="org-comment-delimiter">;;</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">TAB                     mastodon-tl--next-tab-item</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">D                       mastodon-toot--delete-and-redraft-toot</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">C-S-b                   mastodon-tl--unblock-user</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">S-TAB                   mastodon-tl--previous-tab-item</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">S-RET                   mastodon-tl--unmute-user</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">C-S-w                   mastodon-tl--unfollow-user</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">S-SPC                   scroll-down-command</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">&lt;backtab&gt;               mastodon-tl--previous-tab-item</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">C-M-i                   mastodon-tl--previous-tab-item</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">M-n                     mastodon-tl--next-tab-item</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">M-p                     mastodon-tl--previous-tab-item</span>

  (<span class="org-keyword">defhydra</span> my-mastodon-help (<span class="org-builtin">:color</span> blue <span class="org-builtin">:hint</span> nil)
    <span class="org-doc">"</span>
<span class="org-doc">Timelines^^   Toots^^^^           Own Toots^^   Profiles^^      Users/Follows^^  Misc^^</span>
<span class="org-doc">^^-----------------^^^^--------------------^^----------^^-------------------^^------^^-----</span>
<span class="org-doc">_h_ome        _n_ext _p_rev       _r_eply       _A_uthors       follo_W_         _X_ lists</span>
<span class="org-doc">_l_ocal       _T_hread of toot^^  wri_t_e       user _P_rofile  _N_otifications  f_I_lter</span>
<span class="org-doc">_F_ederated   (un) _b_oost^^      _e_dit        ^^              _R_equests       _C_opy URL</span>
<span class="org-doc">fa_V_orites   (un) _f_avorite^^   _d_elete      _O_wn           su_G_estions     _S_earch</span>
<span class="org-doc">_#_ tagged    (un) p_i_n^^        ^^            _U_pdate own    _M_ute user      _H_elp</span>
<span class="org-doc">_@_ mentions  (un) boo_k_mark^^   show _E_dits  ^^              _B_lock user</span>
<span class="org-doc">boo_K_marks   _v_ote^^</span>
<span class="org-doc">trendin_g_</span>
<span class="org-doc">_u_pdate      _w_rite Emacs news  _o_rg  _s_creenshot</span>
<span class="org-doc">"</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">my custom stuff</span>
    (<span class="org-string">"s"</span> my-mastodon-toot-screenshot)
    (<span class="org-string">"w"</span> my-mastodon-save-toot-for-emacs-news)
    (<span class="org-string">"o"</span> (org-capture nil <span class="org-string">"m"</span>))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">more general things</span>
    (<span class="org-string">"h"</span> (<span class="org-keyword">progn</span> (<span class="org-keyword">require</span> '<span class="org-constant">mastodon</span>) mastodon-tl--get-home-timeline))

    (<span class="org-string">"l"</span> mastodon-tl--get-local-timeline)
    (<span class="org-string">"F"</span> mastodon-tl--get-federated-timeline)
    (<span class="org-string">"V"</span> mastodon-profile--view-favourites)
    (<span class="org-string">"#"</span> mastodon-tl--get-tag-timeline)
    (<span class="org-string">"@"</span> (<span class="org-keyword">progn</span> (<span class="org-keyword">require</span> '<span class="org-constant">mastodon</span>) (mastodon-notifications--get-mentions)))
    (<span class="org-string">"K"</span> mastodon-profile--view-bookmarks)
    (<span class="org-string">"g"</span> mastodon-search--trending-tags)
    (<span class="org-string">"u"</span> mastodon-tl--update <span class="org-builtin">:exit</span> nil)

    (<span class="org-string">"n"</span> mastodon-tl--goto-next-toot)
    (<span class="org-string">"p"</span> mastodon-tl--goto-prev-toot)
    (<span class="org-string">"T"</span> mastodon-tl--thread)
    (<span class="org-string">"b"</span> mastodon-toot--toggle-boost <span class="org-builtin">:exit</span> nil)
    (<span class="org-string">"f"</span> mastodon-toot--toggle-favourite <span class="org-builtin">:exit</span> nil)
    (<span class="org-string">"i"</span> mastodon-toot--pin-toot-toggle <span class="org-builtin">:exit</span> nil)
    (<span class="org-string">"k"</span> mastodon-toot--bookmark-toot-toggle <span class="org-builtin">:exit</span> nil)
    (<span class="org-string">"c"</span> mastodon-tl--toggle-spoiler-text-in-toot)
    (<span class="org-string">"v"</span> mastodon-tl--poll-vote)

    (<span class="org-string">"A"</span> mastodon-profile--get-toot-author)
    (<span class="org-string">"P"</span> mastodon-profile--show-user)
    (<span class="org-string">"O"</span> mastodon-profile--my-profile)
    (<span class="org-string">"U"</span> mastodon-profile--update-user-profile-note)

    (<span class="org-string">"W"</span> mastodon-tl--follow-user)
    (<span class="org-string">"N"</span> mastodon-notifications-get)
    (<span class="org-string">"R"</span> mastodon-profile--view-follow-requests)
    (<span class="org-string">"G"</span> mastodon-tl--get-follow-suggestions)
    (<span class="org-string">"M"</span> mastodon-tl--mute-user)
    (<span class="org-string">"B"</span> mastodon-tl--block-user)

    (<span class="org-string">"r"</span> mastodon-toot--reply)
    (<span class="org-string">"t"</span> mastodon-toot)
    (<span class="org-string">"e"</span> mastodon-toot--edit-toot-at-point)
    (<span class="org-string">"d"</span> mastodon-toot--delete-toot)
    (<span class="org-string">"E"</span> mastodon-toot--view-toot-edits)

    (<span class="org-string">"I"</span> mastodon-tl--view-filters)
    (<span class="org-string">"X"</span> mastodon-tl--view-lists)
    (<span class="org-string">"C"</span> mastodon-toot--copy-toot-url)
    (<span class="org-string">"S"</span> mastodon-search--search-query)
    (<span class="org-string">"H"</span> describe-mode)

    (<span class="org-string">"q"</span> nil <span class="org-builtin">:exit</span> t)
  )
(<span class="org-keyword">use-package</span> mastodon
 <span class="org-builtin">:bind</span> (<span class="org-string">"s-m"</span> . my-mastodon-help/body))
</pre>
</div>
</div>
</div>
<div id="outline-container-mastodon-toot-config" class="outline-3">
<h3 id="mastodon-toot-config">Making it easier to toot my config</h3>
<div class="outline-text-3" id="text-mastodon-toot-config">
<p>
The following snippet composes a toot buffer with a link to the
relevant section of my configuration file, or to the relevant blog
post if specified.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-toot-config</span> (<span class="org-type">&amp;optional</span> include-screenshot)
  <span class="org-doc">"Toot this part of my config."</span>
  (<span class="org-keyword">interactive</span> (list current-prefix-arg))
  (<span class="org-keyword">let</span> ((link (<span class="org-keyword">if</span> (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>)
                  (concat <span class="org-string">"https://sachachua.com"</span> (org-entry-get (point) <span class="org-string">"EXPORT_ELEVENTY_PERMALINK"</span>))
                (concat <span class="org-string">"https://sachachua.com/dotemacs/#"</span> (org-entry-get (point) <span class="org-string">"CUSTOM_ID"</span>))))
        text)
    (<span class="org-keyword">save-excursion</span>
      (org-back-to-heading)
      (org-end-of-meta-data)
      (<span class="org-keyword">setq</span> text (buffer-substring (point) (org-end-of-subtree))))
    (mastodon-toot)
    (insert text <span class="org-string">"\n\nLink: "</span> link)))
</pre>
</div>
</div>
</div>
<div id="outline-container-mastodon-org-contacts" class="outline-3">
<h3 id="mastodon-org-contacts">Org contacts</h3>
<div class="outline-text-3" id="text-mastodon-org-contacts">
</div>
<div id="outline-container-mastodon-org-contacts-capture" class="outline-4">
<h4 id="mastodon-org-contacts-capture">Capture</h4>
<div class="outline-text-4" id="text-mastodon-org-contacts-capture">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-org-contact-add</span> ()
  <span class="org-doc">"Add current toot author as a contact."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let-alist</span> (get-text-property (point) 'item-json)
    (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (car org-contacts-files))
      (<span class="org-keyword">if</span> (org-find-property <span class="org-string">"MASTODON"</span> .account.acct)
          (message <span class="org-string">"Already exists."</span>)
        (org-insert-heading)
        (insert (format <span class="org-string">"%s\n:PROPERTIES:\n:NAME: %s\n:MASTODON: %s\n:ALIAS: %s\n:END:\n"</span>
                        .account.display_name
                        .account.display_name
                        .account.acct
                        .account.username))
        (message <span class="org-string">"Added %s"</span> .account.acct)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-mastodon-org-contacts-complete" class="outline-4">
<h4 id="mastodon-org-contacts-complete">Completion</h4>
<div class="outline-text-4" id="text-mastodon-org-contacts-complete">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-contacts-complete-mastodon</span> (string)
  (<span class="org-keyword">let*</span> ((completion-ignore-case org-contacts-completion-ignore-case)
         (completion-list
          (<span class="org-keyword">cl-loop</span> for contact in (org-contacts-filter)
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">The contact name is always the car of the assoc-list</span>
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">returned by `</span><span class="org-comment"><span class="org-constant">org-contacts-filter</span></span><span class="org-comment">'.</span>
                   for contact-name = (car contact)
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">Build the list of the Mastodon handles which have expired</span>
                   for ignore-list = (org-contacts-split-property
                                      (<span class="org-keyword">or</span> (cdr (assoc-string org-contacts-ignore-property
                                                             (nth 2 contact))) <span class="org-string"><span class="org-warning">""</span></span><span class="org-warning">))</span>
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">Build the list of the user Mastodon handles.</span>
                   for handle-list = (org-contacts-remove-ignored-property-values
                                      ignore-list
                                      (org-contacts-split-property
                                       (<span class="org-keyword">or</span> (cdr (assoc-string <span class="org-string">"MASTODON"</span>
                                                              (nth 2 contact))) <span class="org-string"><span class="org-warning">""</span></span><span class="org-warning">)))</span>
                   nconc (<span class="org-keyword">cl-loop</span> for handle in handle-list
                                  collect (format <span class="org-string">"%s (%s)"</span> contact-name handle))))
         (completion-list (org-contacts-all-completions-prefix
                           string
                           (org-uniquify completion-list))))
    (<span class="org-keyword">when</span> completion-list
      (org-contacts-make-collection-prefix completion-list))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-complete-contact</span> ()
  <span class="org-doc">"Suitable for adding to `</span><span class="org-doc"><span class="org-constant">completion-at-point-functions</span></span><span class="org-doc">'."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((beg
         (<span class="org-keyword">save-excursion</span>
           (re-search-backward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\`</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">[\n:,]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[ \t]*"</span>)
           (goto-char (match-end 0))
           (point)))
        (end (point)))
    (list beg
          end
          (completion-table-dynamic
           (<span class="org-keyword">lambda</span> (string)
             (my-org-contacts-complete-mastodon string))))))
(<span class="org-keyword">with-eval-after-load</span> 'mastodon-toot
  (<span class="org-keyword">with-eval-after-load</span> 'org-contacts
    (add-hook 'mastodon-toot-mode-hook
              (<span class="org-keyword">lambda</span> ()
                (add-hook 'completion-at-point-functions
                          #'my-mastodon-complete-contact nil t)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org08d1e58" class="outline-3">
<h3 id="org08d1e58">Copy Mastodon toot URL as author link</h3>
<div class="outline-text-3" id="text-org08d1e58">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-copy-toot-as-author-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((url (mastodon-toot--toot-url))
         (handle (concat <span class="org-string">"@"</span>
                         (<span class="org-keyword">let-alist</span> (<span class="org-keyword">or</span> (mastodon-tl--property 'base-toot)
                                        (mastodon-tl--property 'item-json))
                           .account.acct))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">figure out how to properly add to org-stored-links someday</span>
    (kill-new (org-link-make-string url handle))
    (message <span class="org-string">"Link stored (%s, %s)."</span> handle url)))
</pre>
</div>
</div>
</div>
<div id="outline-container-mastodon-org-feed" class="outline-3">
<h3 id="mastodon-org-feed">Collect my recent toots in an Org file so that I can refile them</h3>
<div class="outline-text-3" id="text-mastodon-org-feed">
<p>
I want to use my microblog posts on Mastodon as building blocks for
longer posts on my blog. Getting them into an Org file makes it easier
to link to them or refile them to other parts of my Org files so that
I can build up my notes.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> pandoc)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-mastodon-org-feed-formatter</span> (entry)
  (concat <span class="org-string">"* "</span> (pandoc-convert-stdio
                (dom-text (dom-by-tag
                           (<span class="org-keyword">with-temp-buffer</span>
                             (insert <span class="org-string">"&lt;item&gt;"</span>
                                     (plist-get entry <span class="org-builtin">:item-full-text</span>)
                                     <span class="org-string">"&lt;/item&gt;"</span>)
                             (xml-parse-region (point-min) (point-max)))
                           'description))
                <span class="org-string">"html"</span> <span class="org-string">"org"</span>)
          <span class="org-string">"\n\n["</span> (format-time-string (cdr org-time-stamp-formats)
                                      (date-to-time (plist-get entry <span class="org-builtin">:pubDate</span>)))
<span class="org-string">"]\n"</span> (plist-get entry <span class="org-builtin">:link</span>)))
(<span class="org-keyword">setq</span> org-feed-alist '((<span class="org-string">"Mastodon"</span> <span class="org-string">"https://emacs.ch/@sachac/with_replies.rss"</span>
                        <span class="org-string">"~/sync/orgzly/toots.org"</span> <span class="org-string">"Toots"</span>
                        <span class="org-builtin">:formatter</span> my-mastodon-org-feed-formatter)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-feed-sort</span> (pos entries)
  (<span class="org-keyword">save-excursion</span>
    (goto-char pos)
    (<span class="org-keyword">when</span> (looking-at org-complex-heading-regexp)
      (org-sort-entries nil ?T))))
(advice-add #'org-feed-add-items <span class="org-builtin">:after</span> #'my-org-feed-sort)
</pre>
</div>

<p>
Now I can use <code>org-feed-update-all</code> (<code>C-c C-x g</code>) to pull things into my toots.org file.
</p>
</div>
</div>
</div>
<div id="outline-container-web" class="outline-2">
<h2 id="web">Web</h2>
<div class="outline-text-2" id="text-web">
</div>
<div id="outline-container-checking-urls" class="outline-3">
<h3 id="checking-urls">Checking URLs</h3>
<div class="outline-text-3" id="text-checking-urls">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-test-urls</span> (urls)
  <span class="org-doc">"Given a list of URLs, return a list of any URLS that don't result in an OK value."</span>
  (delq nil
        (mapcar (<span class="org-keyword">lambda</span> (url)
                  (<span class="org-keyword">let</span> ((url-request-method <span class="org-string">"HEAD"</span>))
                    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously url)
                      (goto-char (point-min))
                      (<span class="org-keyword">unless</span> (looking-at <span class="org-string">"HTTP/1.1 200 OK"</span>) url))))
                urls)))
</pre>
</div>
</div>
</div>
<div id="outline-container-search" class="outline-3">
<h3 id="search">Search</h3>
<div class="outline-text-3" id="text-search">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> engine-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defengine</span> my-blog <span class="org-string">"https://www.google.ca/search?q=site:sachachua.com+%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"b"</span>)
  (<span class="org-keyword">defengine</span> mail <span class="org-string">"https://mail.google.com/mail/u/0/#search/%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"m"</span>)
  (<span class="org-keyword">defengine</span> google <span class="org-string">"https://google.com/search?q=%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"g"</span>)
  (<span class="org-keyword">defengine</span> emacswiki <span class="org-string">"https://google.com/search?q=site:emacswiki.org+%s"</span> <span class="org-builtin">:keybinding</span> <span class="org-string">"e"</span>)
  (engine-mode)
  <span class="org-builtin">:hydra</span>
  (my-engine-mode-hydra
   (<span class="org-builtin">:color</span> blue)
   <span class="org-string">"Engine mode"</span>
   (<span class="org-string">"b"</span> engine/search-my-blog <span class="org-string">"blog"</span>)
   (<span class="org-string">"m"</span> engine/search-mail <span class="org-string">"mail"</span>)
   (<span class="org-string">"g"</span> engine/search-google <span class="org-string">"google"</span>)
   (<span class="org-string">"e"</span> engine/search-emacswiki <span class="org-string">"emacswiki"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-spookfox" class="outline-3">
<h3 id="spookfox">Spookfox</h3>
<div class="outline-text-3" id="text-spookfox">
</div>
<div id="outline-container-spookfox-babel" class="outline-4">
<h4 id="spookfox-babel">Running the current Org Mode Babel Javascript block from Emacs using Spookfox&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span>&#xa0;<span class="spookfox">spookfox</span></span></h4>
<div class="outline-text-4" id="text-spookfox-babel">
<p>
I often want to send Javascript from Emacs to the web browser. It's handy for testing code snippets or working with data on pages that require Javascript or authentication. I could start Google Chrome or Mozilla Firefox with their remote debugging protocols, copy the websocket URLs, and talk to the browser through  something like Puppeteer, but it's so much easier to use the <a href="https://github.com/bitspook/spookfox">Spookfox</a> extension for Mozilla to execute code in the active tab.
<code>spookfox-js-injection-eval-in-active-tab</code> lets you evaluate Javascript and get the results back in Emacs Lisp.
</p>

<p>
I wanted to be able to execute code even more
easily. This code lets me add a <code>:spookfox t</code>
parameter to Org Babel Javascript blocks so that I
can run the block in my Firefox active tab.
For example, if I have <code>(spookfox-init)</code> set up, Spookfox connected, and <a href="https://planet.emacslife.com">https://planet.emacslife.com</a> in my active tab, I can use it with the following code:
</p>

<div class="org-src-container">
<pre class="src src-org"><span class="org-org-block-begin-line">#+begin_src js :eval never-export :spookfox t :exports results</span>
<span class="org-org-block">[...document.querySelectorAll(</span><span class="org-org-block"><span class="org-string">'.post &gt; h2'</span></span><span class="org-org-block">)].slice(0,5).map((o) =&gt; </span><span class="org-org-block"><span class="org-string">'- '</span></span><span class="org-org-block"> + o.textContent.trim().replace(</span><span class="org-org-block"><span class="org-string">/[ \n]+/</span></span><span class="org-org-block">g, </span><span class="org-org-block"><span class="org-string">' '</span></span><span class="org-org-block">) + </span><span class="org-org-block"><span class="org-string">'\n'</span></span><span class="org-org-block">).join(</span><span class="org-org-block"><span class="org-string">''</span></span><span class="org-org-block">)</span>
<span class="org-org-block-end-line">#+end_src</span>
</pre>
</div>

<p>
<a href="https://planet.emacslife.com/">https://planet.emacslife.com/</a>
</p>

<ul class="org-ul">
<li>Sacha Chua: Yay Emacs: Using elisp: links in Org Mode to note the time and display messages on stream</li>
<li>Irreal: Quick Accents</li>
<li>Kisaragi Hiu: 我的 KDE 翻譯流程</li>
<li>James Dyer: Emacs asynchronous copying using dired-async-mode</li>
<li>Corwin Brust: Emacs 29.2 Windows Binaries</li>
</ul>

<p>

</p>

<p>
To do this, we wrap some advice around the <code>org-babel-execute:js</code> function that's called by <code>org-babel-execute-src-block</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-babel-execute:js-spookfox</span> (old-fn body params)
  <span class="org-doc">"Maybe execute Spookfox."</span>
  (<span class="org-keyword">if</span> (assq <span class="org-builtin">:spookfox</span> params)
      (spookfox-js-injection-eval-in-active-tab
       body t)
    (funcall old-fn body params)))
(<span class="org-keyword">with-eval-after-load</span> 'ob-js
  (advice-add 'org-babel-execute:js <span class="org-builtin">:around</span> #'my-org-babel-execute:js-spookfox))
</pre>
</div>

<p>
I can also run the block in Spookfox without adding the parameter if I make an interactive function:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-eval-org-block</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((block (org-element-context)))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (eq (org-element-type block) 'src-block)
               (string= (org-element-property <span class="org-builtin">:language</span> block) <span class="org-string">"js"</span>))
      (spookfox-js-injection-eval-in-active-tab
       (nth 2 (org-src--contents-area block))
       t))))
</pre>
</div>

<p>
I can add that as an Embark context action:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">with-eval-after-load</span> 'embark-org
  (define-key embark-org-src-block-map <span class="org-string">"f"</span> #'my-spookfox-eval-org-block))
</pre>
</div>

<p>
In Javascript buffers, I want the ability to send the current line, region, or buffer too, just like package:nodejs-repl does.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-send-region</span> (start end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (spookfox-js-injection-eval-in-active-tab (buffer-substring start end) t))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-send-buffer</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-spookfox-send-region (point-min) (point-max)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-send-line</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-spookfox-send-region (line-beginning-position) (line-end-position)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-send-last-expression</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-spookfox-send-region (<span class="org-keyword">save-excursion</span> (nodejs-repl--beginning-of-expression)) (point)))

(<span class="org-keyword">defvar-keymap</span> my-js-spookfox-minor-mode-map
  <span class="org-builtin">:doc</span> <span class="org-doc">"Send parts of the buffer to Spookfox."</span>
  <span class="org-string">"C-x C-e"</span> 'my-spookfox-send-last-expression
  <span class="org-string">"C-c C-j"</span> 'my-spookfox-send-line
  <span class="org-string">"C-c C-r"</span> 'my-spookfox-send-region
  <span class="org-string">"C-c C-c"</span> 'my-spookfox-send-buffer)

(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">my-js-spookfox-minor-mode</span> <span class="org-doc">"Send code to Spookfox."</span>)
</pre>
</div>

<p>
I usually edit Javascript files with package:js2-mode, so I can use <code>my-js-spookfox-minor-mode</code> in addition to that.
</p>

<p>
I can turn the minor mode on automatically for <code>:spookfox t</code> source blocks. There's no <code>org-babel-edit-prep:js</code> yet, I think, so we need to define it instead of advising it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-edit-prep:js</span> (info)
  (<span class="org-keyword">when</span> (assq <span class="org-builtin">:spookfox</span> (nth 2 info))
    (my-js-spookfox-minor-mode 1)))
</pre>
</div>

<p>
Let's try it out by sending the last line repeatedly:
</p>

<p>

</p>

<p>
I used to do this kind of interaction with <a href="https://github.com/skeeto/skewer-mode">Skewer</a>, which also has some extra stuff for evaluating CSS and HTML. Skewer hasn't been updated in a while, but maybe I should also check that out again to see if I can get it working.
</p>

<p>
Anyway, now it's just a little bit easier to tinker with Javascript!
</p>
</div>
</div>
<div id="outline-container-spookfox" class="outline-4">
<h4 id="spookfox">Using Spookfox to scroll Firefox up and down from Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="web">web</span>&#xa0;<span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-spookfox">
<p>
I open lots of pages in the process of making Emacs News. I like to
open the pages in Mozilla Firefox, but I want the keyboard focus to
stay with Emacs so that I can quickly categorize the links. I also
sometimes want to scroll the page up or down. While reading the
<a href="https://bitspook.in/blog/reading-and-not-forgetting/">Reading, and not forgetting</a> post, I came across <a href="https://github.com/bitspook/spookfox">Spookfox</a>, which
bridges Emacs and Firefox using an Firefox add-on and websockets.
After I started spookfox and connected to it by clicking on the
extension in Firefox, I was able to interact with it from Emacs Lisp.
I feel a little nervous about it security-wise, but at least it's only
listening on the local port. There might be another way to do it with
the Marionette support in Firefox, but I haven't looked into it yet.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> spookfox
  <span class="org-comment-delimiter">;</span><span class="org-comment">:quelpa (spookfox :fetcher github :repo "bitspook/spookfox"</span>
  <span class="org-comment-delimiter">; </span><span class="org-comment">:files ("lisp/*.el" "lisp/apps/*.el"))</span>
  <span class="org-builtin">:load-path</span> (<span class="org-string">"~/vendor/spookfox/lisp"</span> <span class="org-string">"~/vendor/spookfox/lisp/apps"</span>)
  <span class="org-builtin">:when</span> my-laptop-p
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">spookfox-tabs</span>)
  <span class="org-comment-delimiter">;</span><span class="org-comment">(require 'spookfox-org-tabs)</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">spookfox-js-injection</span>)
  (add-to-list 'spookfox-enabled-apps 'spookfox-tabs)
  (<span class="org-keyword">with-eval-after-load</span> 'spookfox-org-tabs (add-to-list 'spookfox-enabled-apps 'spookfox-org-tabs))
  (add-to-list 'spookfox-enabled-apps 'spookfox-js-injection)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">(spookfox-init) ; don't automatically enable it; run (spookfox-init) to manually enable</span>
  )
</pre>
</div>

<p>
Anyway, this code seems to do the job of scrolling my Firefox window:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-scroll-down</span> ()
  (<span class="org-keyword">interactive</span>)
  (spookfox-js-injection-eval-in-active-tab <span class="org-string">"window.scrollBy(0, document.documentElement.clientHeight);"</span> t))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-scroll-up</span> ()
  (<span class="org-keyword">interactive</span>)
  (spookfox-js-injection-eval-in-active-tab <span class="org-string">"window.scrollBy(0, -document.documentElement.clientHeight);"</span>))

(keymap-global-set <span class="org-string">"C-s-v"</span> 'my-spookfox-scroll-down)
(keymap-global-set <span class="org-string">"S-s-v"</span> 'my-spookfox-scroll-up)
</pre>
</div>

<p>
This code opens a tab without switching keyboard focus away from Emacs:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-background-tab</span> (url <span class="org-type">&amp;rest</span> args)
  <span class="org-doc">"Open URL as a background tab."</span>
  (<span class="org-keyword">if</span> spookfox--connected-clients
      (spookfox-tabs--request (cl-first spookfox--connected-clients) <span class="org-string">"OPEN_TAB"</span> `(<span class="org-builtin">:url</span> ,url))
    (browse-url url)))
</pre>
</div>

<p>
My Emacs News code for processing my upvoted Reddit posts can
automatically grab the links from Reddit link posts, but sometimes
people post Reddit text or image posts and then include the link to
the actual project in the post body or a comment instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-get-links</span> ()
  (seq-uniq
   (spookfox-eval-js-in-active-tab <span class="org-string">"[...(document.querySelector('[data-testid=post-container]')?.parentElement || document).querySelectorAll('</span><span class="org-string"><span class="org-constant">a</span></span><span class="org-string">')].map(a =&gt; a.href).filter(a =&gt; a &amp;&amp; (!window.location.host.match(/reddit/) || !a.match(/redd</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">.?it/)) &amp;&amp; !a.match(window.location.host))"</span> t)))
<span class="org-comment-delimiter">;;</span><span class="org-comment">https://emacs.stackexchange.com/questions/41801/how-to-stop-completing-read-ivy-completing-read-from-sorting</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-presorted-completion-table</span> (completions)
  (<span class="org-keyword">lambda</span> (string pred action)
    (<span class="org-keyword">if</span> (eq action 'metadata)
        '(metadata
          (cycle-sort-function . identity)
          (display-sort-function . identity))
      (complete-with-action action completions string pred))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-complete-link</span> (<span class="org-type">&amp;optional</span> prompt)
  (completing-read
   (<span class="org-keyword">or</span> prompt <span class="org-string">"Link: "</span>)
   (my-presorted-completion-table
    (my-spookfox-get-links))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-insert-link-from-page</span> (link)
  (<span class="org-keyword">interactive</span> (list (my-spookfox-complete-link)))
  (insert (org-link-make-string link (my-page-title link))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-open-link-from-page</span> (link)
  (<span class="org-keyword">interactive</span> (list (my-spookfox-complete-link)))
  (my-spookfox-background-tab link))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-insert-link-to-tab</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((tab (spookfox-request-active-tab)))
    (insert (org-link-make-string
             (plist-get tab <span class="org-builtin">:url</span>)
             (plist-get tab <span class="org-builtin">:title</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-spookfox-insert-url" class="outline-4">
<h4 id="spookfox-insert-url">Emacs and Spookfox: org-capture the current tab from Firefox or a link from the page</h4>
<div class="outline-text-4" id="text-spookfox-insert-url">
<p>
I want to quickly capture notes based on the current tab in Firefox or
a link from the page's main body. I have the <a href="https://addons.mozilla.org/en-CA/firefox/addon/org-capture/">Org Capture Firefox
extension</a> and <code>Ctrl-Shift-L</code> seems to be the keyboard shortcut for
capturing with it, so I probably just have to get the hang of using
it.
</p>

<p>
I also want to make it easier to add notes even when I've already
switched back to Emacs. I could use <code>s-2</code> to shift to Firefox (I have
some Autokey shortcuts for focusing specific applications; <code>s-1</code> is
Emacs), but sometimes I just want to add a link at point.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-insert-url</span> ()
  (<span class="org-keyword">interactive</span>)
  (insert (spookfox-js-injection-eval-in-active-tab <span class="org-string">"window.location.href"</span> t)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-spookfox-insert-org-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (insert (apply #'org-link-make-string
                 (append (spookfox-js-injection-eval-in-active-tab <span class="org-string">"[window.location.href, document.title]"</span> t) nil))))
(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">cl-pushnew</span>
   `(<span class="org-string">"f"</span> <span class="org-string">"Firefox"</span> entry
      (file ,my-org-inbox-file)
      <span class="org-string">"* %^{Note}\n:PROPERTIES:\n:CREATED: %U\n:END:\n\n%(apply #'org-link-make-string</span>
<span class="org-string">                 (append (spookfox-js-injection-eval-in-active-tab \"[window.location.href, document.title]\" t) nil))"</span>)
   org-capture-templates)
  (<span class="org-keyword">cl-pushnew</span>
   `(<span class="org-string">"F"</span> <span class="org-string">"Firefox link"</span> entry
      (file ,my-org-inbox-file)
      <span class="org-string">"* %^{Note}\n:PROPERTIES:\n:CREATED: %U\n:END:\n\n%(org-link-make-string</span>
<span class="org-string">(my-spookfox-complete-link))"</span>)
   org-capture-templates))
</pre>
</div>

<p>
This uses <code>my-spookfox-complete-link</code> from <a href="https://sachachua.com/dotemacs#spookfox">https://sachachua.com/dotemacs#spookfox</a>.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-self-tracking-statistics-and-other-data-transformations" class="outline-2">
<h2 id="self-tracking-statistics-and-other-data-transformations">Self-tracking, statistics, and other data transformations</h2>
<div class="outline-text-2" id="text-self-tracking-statistics-and-other-data-transformations">
</div>
<div id="outline-container-clock-in" class="outline-3">
<h3 id="clock-in">Quantified Awesome</h3>
<div class="outline-text-3" id="text-clock-in">
<p>
<a id="org31bfbbf"></a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-org-with-current-task</span> (<span class="org-type">&amp;rest</span> body)
  <span class="org-doc">"Execute BODY with the point at the subtree of the current task."</span>
  (<span class="org-keyword">declare</span> (debug t))
  `(<span class="org-keyword">if</span> (derived-mode-p 'org-agenda-mode)
       (<span class="org-keyword">save-window-excursion</span>
         (org-agenda-switch-to)
         ,@body)
     ,@body))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-clock-in-and-track</span> ()
  <span class="org-doc">"Start the clock running. Clock into Quantified Awesome."</span>
  (<span class="org-keyword">interactive</span>)
  (my-org-with-current-task
   (org-clock-in)
   (call-interactively 'my-org-quantified-track)
   <span class="org-comment-delimiter">;</span><span class="org-comment">(when (websocket-openp obs-websocket)  (my-stream-message (org-get-heading t t t t)))</span>
   (<span class="org-keyword">cond</span>
    ((org-entry-get (point) <span class="org-string">"AUTO"</span>)
     (org-link-open-from-string (org-entry-get (point) <span class="org-string">"AUTO"</span>)))
    (t
     (<span class="org-keyword">save-restriction</span>
       (org-narrow-to-subtree)
       (org-next-link)
       (<span class="org-keyword">when</span> (looking-at org-link-any-re)
         (org-open-at-point)))))))
(<span class="org-keyword">bind-key</span> <span class="org-string">"!"</span> 'my-org-clock-in-and-track org-agenda-mode-map)

(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-with-org-task</span> (<span class="org-type">&amp;rest</span> body)
  <span class="org-doc">"Run BODY within the current agenda task, clocked task, or cursor task."</span>
  `(<span class="org-keyword">cond</span>
    ((derived-mode-p 'org-agenda-mode)
     (<span class="org-keyword">let*</span> ((marker (org-get-at-bol 'org-marker))
            (buffer (marker-buffer marker))
            (pos (marker-position marker)))
       (<span class="org-keyword">with-current-buffer</span> buffer
         (<span class="org-keyword">save-excursion</span>
           (<span class="org-keyword">save-restriction</span>
             (widen)
             (goto-char pos)
             ,@body)))))
    ((<span class="org-keyword">and</span> (derived-mode-p 'org-mode) (org-at-heading-p)) (<span class="org-keyword">save-excursion</span> ,@body))
    ((org-clocking-p) (<span class="org-keyword">save-excursion</span> (org-clock-goto) ,@body))
    ((derived-mode-p 'org-mode) ,@body)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-quantified-track</span> (<span class="org-type">&amp;optional</span> category note)
  <span class="org-doc">"Create a tracking record using CATEGORY and NOTE.</span>
<span class="org-doc">      Default to the current task in the agenda, the currently-clocked</span>
<span class="org-doc">      entry, or the current subtree in Org."</span>
  (<span class="org-keyword">interactive</span> (list nil nil))
  (<span class="org-keyword">unless</span> (<span class="org-keyword">and</span> category note)
    (my-with-org-task
     (<span class="org-keyword">setq</span> category (<span class="org-keyword">or</span> category
                        (org-entry-get-with-inheritance <span class="org-string">"QUANTIFIED"</span>)))
     (<span class="org-keyword">cond</span>
      ((null category)
       (<span class="org-keyword">setq</span> category (read-string <span class="org-string">"Category: "</span>))
       (org-set-property <span class="org-string">"QUANTIFIED"</span> category))
      ((string= category ' <span class="org-string">"ask"</span>)
       (<span class="org-keyword">setq</span> category (read-string <span class="org-string">"Category: "</span>))))
     (<span class="org-keyword">setq</span> note
           (concat
            (<span class="org-keyword">if</span> (string= (<span class="org-keyword">or</span> (org-entry-get-with-inheritance <span class="org-string">"QUANTIFIEDQUIET"</span>) <span class="org-string">""</span>) <span class="org-string">"t"</span>)
                <span class="org-string">"!private "</span>
              <span class="org-string">""</span>)
            (<span class="org-keyword">or</span> note (elt (org-heading-components) 4) (read-string <span class="org-string">"Note: "</span>))))))
  (quantified-track (concat category <span class="org-string">" | "</span> note)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-quick-clock-in-task</span> (location jump)
  <span class="org-doc">"Track and clock in on the specified task.</span>
<span class="org-doc">      If JUMP is non-nil or the function is called with the prefix argument, jump to that location afterwards."</span>
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">save-excursion</span> (my-org-refile-get-location <span class="org-string">"Location"</span>)) current-prefix-arg))
  (<span class="org-keyword">when</span> location
    (<span class="org-keyword">if</span> jump
        (<span class="org-keyword">progn</span> (org-refile 4 nil location) (my-org-clock-in-and-track))
      (<span class="org-keyword">save-window-excursion</span>
        (org-refile 4 nil location)
        (my-org-clock-in-and-track)))))
(<span class="org-keyword">bind-key</span> <span class="org-string">"C-c q"</span> 'my-org-quick-clock-in-task)

(<span class="org-keyword">require</span> '<span class="org-constant">quantified</span> nil t)
</pre>
</div>
</div>
</div>
<div id="outline-container-compare-time" class="outline-3">
<h3 id="compare-time">Compare times and effort estimates</h3>
<div class="outline-text-3" id="text-compare-time">
<p>
<a id="org6ffba6d"></a>
</p>

<p>
This is for comparing times in column view and in tables.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-compare-times</span> (clocked estimated)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (&gt; (length clocked) 0) estimated)
      (format <span class="org-string">"%.2f"</span>
              (/ (* 1.0 (org-hh:mm-string-to-minutes clocked))
                 (org-hh:mm-string-to-minutes estimated)))
    <span class="org-string">""</span>))
</pre>
</div>

<p>
Use with <code>#+COLUMNS: %40ITEM %17Effort(Estimated){:} %CLOCKSUM</code>, <code>#+BEGIN: columnview :hlines 1</code> &#x2026; <code>#+END:</code>, and
</p>

<pre class="example" id="orgfd00a18">
#+TBLFM: $4='(my-compare-times $3 $2)
</pre>
</div>
<div id="outline-container-using-the-calendar-date-echo-text-variable-to-help-plot-a-heatmap-on-a-year-long-calendar-in-emacs" class="outline-4">
<h4 id="using-the-calendar-date-echo-text-variable-to-help-plot-a-heatmap-on-a-year-long-calendar-in-emacs">Using the calendar-date-echo-text variable to help plot a heatmap on a year-long calendar in Emacs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-using-the-calendar-date-echo-text-variable-to-help-plot-a-heatmap-on-a-year-long-calendar-in-emacs">

<figure id="org1c67705">
<img src="file:///home/sacha/recordings/output-2023-01-06-10:26:49.gif" alt="output-2023-01-06-10:26:49.gif">

<figcaption><span class="figure-number">Figure 12: </span>Sketch heatmap from 2008-2023</figcaption>
</figure>

<p>
Building on <a href="https://sachachua.com/blog/2023/01/display-a-calendar-heat-map-using-emacs-lisp/">Display a calendar heat map using Emacs Lisp</a>,
I figured out how to use <code>calendar-date-echo-text</code> to store
the date so that I can pick it up when plotting the heatmap:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">This seems to be the only way we can hack the date in for now</span>
(<span class="org-keyword">setq</span> calendar-date-echo-text '(apply #'format (list <span class="org-string">"%04d-%02d-%02d"</span> year month day)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-calendar-heat-map-using-echo-text</span> (<span class="org-type">&amp;rest</span> _)
  (<span class="org-keyword">when</span> my-calendar-count-scaled
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (not (eobp))
        (<span class="org-keyword">let*</span> ((help (get-text-property (point) 'help-echo))
               (next-change
                (<span class="org-keyword">or</span> (next-single-property-change (point) 'help-echo)
                    (point-max)))
               (inhibit-read-only t)
               (count-scaled (<span class="org-keyword">and</span> help
                                  (assoc-default
                                   help
                                   my-calendar-count-scaled))))
          (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> help
                     (string-match <span class="org-string">"[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]"</span> help)
                     count-scaled)
            (put-text-property
             (point) (+ 2 (point))
             'face (intern (format <span class="org-string">"calendar-scale-%d"</span> count-scaled))))
          (goto-char next-change))))))

(advice-add #'calendar <span class="org-builtin">:after</span> #'my-calendar-heat-map-using-echo-text)
(advice-add #'calendar-redraw <span class="org-builtin">:after</span> #'my-calendar-heat-map-using-echo-text)
(advice-add #'year-calendar <span class="org-builtin">:after</span> #'my-calendar-heat-map-using-echo-text)
</pre>
</div>

<p>
So now I don't need the advice around <code>calendar-generate-month</code>, just
the code that sets up the faces, loads the values, and figures out the
data.
</p>

<div class="my_details" id="org722646e">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-1</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#eceff1"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#263238"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-2</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#cfd8dc"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#37474f"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-3</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#b0bec5"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#455a64"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-4</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#90a4ae"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#546e7a"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-5</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#78909c"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#607d8b"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-6</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#607d8b"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#78909c"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-7</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#546e7a"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#90a4ae"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-8</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#455a64"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#b0bec5"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-9</span>  '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#37474f"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#cfd8dc"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-count-calendar-entries</span> (grouped-entries)
  (mapcar (<span class="org-keyword">lambda</span> (entry) (cons (car entry) (length (cdr entry)))) grouped-entries))

(<span class="org-keyword">defface</span> <span class="org-variable-name">calendar-scale-10</span> '((((background light)) <span class="org-builtin">:foreground</span> <span class="org-string">"white"</span> <span class="org-builtin">:background</span> <span class="org-string">"#263238"</span>)
                             (((background dark))  <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span> <span class="org-builtin">:background</span> <span class="org-string">"#eceff1"</span>)) <span class="org-doc"><span class="org-warning">""</span></span><span class="org-warning">)</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-scale-calendar-entries</span> (grouped-entries <span class="org-type">&amp;optional</span> scale-max)
  (<span class="org-keyword">let*</span> ((count (my-count-calendar-entries grouped-entries))
         (count-max (apply #'max (mapcar (<span class="org-keyword">lambda</span> (o) (<span class="org-keyword">if</span> (car o) (cdr o) 0)) count))))
    (mapcar (<span class="org-keyword">lambda</span> (entry)
              (cons (car entry)
                    (/ (* 1.0 (<span class="org-keyword">or</span> scale-max 1.0) (cdr entry)) count-max)))
            count)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-scale-calendar-entries-logarithmically</span> (grouped-entries <span class="org-type">&amp;optional</span> scale-max)
  (<span class="org-keyword">let*</span> ((count (my-count-calendar-entries grouped-entries))
         (count-max (apply #'max (mapcar (<span class="org-keyword">lambda</span> (o) (<span class="org-keyword">if</span> (car o) (cdr o) 0)) count))))
    (mapcar (<span class="org-keyword">lambda</span> (entry)
              (cons (car entry)
                    (/ (* 1.0 (<span class="org-keyword">or</span> scale-max 1.0) (log (cdr entry))) (log count-max))))
            count)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-calendar-count-scaled</span> nil <span class="org-doc">"Values to display."</span>)
</pre>
</div>

</div>

<p>
Now I can have it display the last year of data or so.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-calendar-visualize</span> (values)
  (<span class="org-keyword">setq</span> my-calendar-count-scaled values)
  (<span class="org-keyword">let*</span> ((date (calendar-current-date))
         (month (calendar-extract-month date))
         (year (calendar-extract-year date)))
    (year-calendar month (1- year))))
</pre>
</div>

<p>
The code to load the data stays the same.
</p>

<div class="my_details" id="org58f31e6">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-calendar-visualize-journal-entries</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-calendar-visualize
   (mapcar
    (<span class="org-keyword">lambda</span> (o)
      (cons
       (car o)
       (ceiling (+ 1 (* 7.0 (cdr o))))))
    (my-scale-calendar-entries
     (seq-group-by #'my-journal-date
                   (cdr (pcsv-parse-file <span class="org-string">"~/Downloads/entries.csv"</span>)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-calendar-visualize-sketches</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((my-calendar-sketches
         (assoc-delete-all
          nil
          (seq-group-by
           (<span class="org-keyword">lambda</span> (o)
             (<span class="org-keyword">when</span> (string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9][0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[-_]?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[-_]?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9][0-9]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> o)
               (format <span class="org-string">"%s-%s-%s"</span>
                       (match-string 1 o)
                       (match-string 2 o)
                       (match-string 3 o))))
           (append
            (directory-files <span class="org-string">"~/sync/sketches"</span> nil <span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span>)
            (directory-files <span class="org-string">"~/sync/private-sketches"</span> nil <span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\'"</span>))))))
    (my-calendar-visualize
     (mapcar
      (<span class="org-keyword">lambda</span> (o)
        (cons (car o)
              <span class="org-comment-delimiter">;; </span><span class="org-comment">many days have just 1 sketch, so I set the low end of the scale</span>
              <span class="org-comment-delimiter">;; </span><span class="org-comment">to make them visible, and use a logarithmic scale for the rest</span>
              (ceiling (+ 3 (* 7.0 (cdr o))))))
      (my-scale-calendar-entries-logarithmically my-calendar-sketches)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-calendar-visualize-tantrums</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-calendar-visualize
   (mapcar
    (<span class="org-keyword">lambda</span> (o)
      (cons
       (car o)
       (ceiling (* 10.0 (cdr o)))))
    (my-scale-calendar-entries
     (seq-group-by #'my-journal-date
                   (seq-filter (<span class="org-keyword">lambda</span> (o) (string-match <span class="org-string">"tantrum</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">grump</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">angry</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">meltdown"</span>
                                                           (my-journal-note o)))
                               (cdr (pcsv-parse-file <span class="org-string">"~/Downloads/entries.csv"</span>))))))))

</pre>
</div>

</div>

<p>
Here's the code from lawlist's StackOverflow answer that <a href="https://stackoverflow.com/questions/9547912/emacs-calendar-show-more-than-3-months">displays the Emacs calendar for a year</a>:
</p>

<div class="my_details" id="org74c8f87">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="org-comment-delimiter">;;;                                                                            </span><span class="org-comment">;;;</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Scroll a yearly calendar by month -- in a forwards or backwards direction. ;;;</span>
<span class="org-comment-delimiter">;;;                                                                            </span><span class="org-comment">;;;</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">To try out this example, evaluate the entire code snippet and type:        ;;;</span>
<span class="org-comment-delimiter">;;;                                                                            </span><span class="org-comment">;;;</span>
<span class="org-comment-delimiter">;;;     </span><span class="org-comment">M-x year-calendar                                                      ;;;</span>
<span class="org-comment-delimiter">;;;                                                                            </span><span class="org-comment">;;;</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">To scroll forward by month, type the key:  &gt;                               ;;;</span>
<span class="org-comment-delimiter">;;;                                                                            </span><span class="org-comment">;;;</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">To scroll backward by month, type the key:  &lt;                              ;;;</span>
<span class="org-comment-delimiter">;;;                                                                            </span><span class="org-comment">;;;</span>
<span class="org-comment-delimiter">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

(eval-after-load <span class="org-string">"calendar"</span> '(progn
  (define-key calendar-mode-map <span class="org-string">"&lt;"</span> 'lawlist-scroll-year-calendar-backward)
  (define-key calendar-mode-map <span class="org-string">"&gt;"</span> 'lawlist-scroll-year-calendar-forward) ))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">lawlist-calendar-for-loop</span> (var from init to final do <span class="org-type">&amp;rest</span> body)
  <span class="org-doc">"Execute a for loop.</span>
<span class="org-doc">Evaluate BODY with VAR bound to successive integers from INIT to FINAL,</span>
<span class="org-doc">inclusive.  The standard macro `</span><span class="org-doc"><span class="org-constant">dotimes</span></span><span class="org-doc">' is preferable in most cases."</span>
  `(<span class="org-keyword">let</span> ((,var (1- ,init)))
    (<span class="org-keyword">while</span> (&gt;= ,final (<span class="org-keyword">setq</span> ,var (1+ ,var)))
      ,@body)))

(<span class="org-keyword">defun</span> <span class="org-function-name">year-calendar</span> (<span class="org-type">&amp;optional</span> month year)
  <span class="org-doc">"Generate a one (1) year calendar that can be scrolled by month in each direction.</span>
<span class="org-doc">This is a modification of:  http://homepage3.nifty.com/oatu/emacs/calendar.html</span>
<span class="org-doc">See also:  http://ivan.kanis.fr/caly.el"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">calendar</span>)
  (<span class="org-keyword">let*</span> ((current-year (number-to-string (nth 5 (decode-time (current-time)))))
         (month (<span class="org-keyword">if</span> month month
           (string-to-number
             (read-string <span class="org-string">"Please enter a month number (e.g., 1):  "</span> nil nil <span class="org-string">"1"</span>))))
         (year (<span class="org-keyword">if</span> year year
           (string-to-number
             (read-string <span class="org-string">"Please enter a year (e.g., 2014):  "</span>
               nil nil current-year)))))
    (switch-to-buffer (get-buffer-create calendar-buffer))
    (<span class="org-keyword">when</span> (not (eq major-mode 'calendar-mode))
      (calendar-mode))
    (<span class="org-keyword">setq</span> displayed-month month)
    (<span class="org-keyword">setq</span> displayed-year year)
    (<span class="org-keyword">setq</span> buffer-read-only nil)
    (erase-buffer)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">horizontal rows</span>
    (lawlist-calendar-for-loop j from 0 to 3 do
      <span class="org-comment-delimiter">;; </span><span class="org-comment">vertical columns</span>
      (lawlist-calendar-for-loop i from 0 to 2 do
        (calendar-generate-month
          <span class="org-comment-delimiter">;; </span><span class="org-comment">month</span>
          (<span class="org-keyword">cond</span>
            ((&gt; (+ (* j 3) i month) 12)
              (- (+ (* j 3) i month) 12))
            (t
              (+ (* j 3) i month)))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">year</span>
          (<span class="org-keyword">cond</span>
            ((&gt; (+ (* j 3) i month) 12)
             (+ year 1))
            (t
              year))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">indentation / spacing between months</span>
          (+ 5 (* 25 i))))
      (goto-char (point-max))
      (insert (make-string (- 10 (count-lines (point-min) (point-max))) ?\n))
      (widen)
      (goto-char (point-max))
      (narrow-to-region (point-max) (point-max)))
    (widen)
    (goto-char (point-min))
    (<span class="org-keyword">setq</span> buffer-read-only t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">lawlist-scroll-year-calendar-forward</span> (<span class="org-type">&amp;optional</span> arg event)
  <span class="org-doc">"Scroll the yearly calendar by month in a forward direction."</span>
  (<span class="org-keyword">interactive</span> (list (prefix-numeric-value current-prefix-arg)
                     last-nonmenu-event))
  (<span class="org-keyword">unless</span> arg (<span class="org-keyword">setq</span> arg 1))
  (<span class="org-keyword">save-selected-window</span>
    (<span class="org-keyword">if</span> (<span class="org-keyword">setq</span> event (event-start event)) (select-window (posn-window event)))
    (<span class="org-keyword">unless</span> (zerop arg)
      (<span class="org-keyword">let</span> ((month displayed-month)
            (year displayed-year))
        (<span class="org-keyword">calendar-increment-month</span> month year arg)
        (year-calendar month year)))
    (goto-char (point-min))
    (run-hooks 'calendar-move-hook)))

(<span class="org-keyword">defun</span> <span class="org-function-name">lawlist-scroll-year-calendar-backward</span> (<span class="org-type">&amp;optional</span> arg event)
  <span class="org-doc">"Scroll the yearly calendar by month in a backward direction."</span>
  (<span class="org-keyword">interactive</span> (list (prefix-numeric-value current-prefix-arg)
                     last-nonmenu-event))
  (lawlist-scroll-year-calendar-forward (- (<span class="org-keyword">or</span> arg 1)) event))
</pre>
</div>

</div>

<p>
It might be fun to scroll by year:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-scroll-year-calendar-forward-year</span> (<span class="org-type">&amp;optional</span> arg event)
  <span class="org-doc">"Scroll the yearly calendar by year in a forward direction."</span>
  (<span class="org-keyword">interactive</span> (list (prefix-numeric-value current-prefix-arg)
                     last-nonmenu-event))
  (<span class="org-keyword">unless</span> arg (<span class="org-keyword">setq</span> arg 1))
  (<span class="org-keyword">save-selected-window</span>
    (<span class="org-keyword">if</span> (<span class="org-keyword">setq</span> event (event-start event)) (select-window (posn-window event)))
    (<span class="org-keyword">unless</span> (zerop arg)
      (<span class="org-keyword">setq</span> displayed-year (+ (<span class="org-keyword">or</span> arg 1) displayed-year))
      (year-calendar displayed-month displayed-year))
    (goto-char (point-min))
    (run-hooks 'calendar-move-hook)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-scroll-year-calendar-backward-year</span> (<span class="org-type">&amp;optional</span> arg event)
  <span class="org-doc">"Scroll the yearly calendar by month in a backward direction."</span>
  (<span class="org-keyword">interactive</span> (list (prefix-numeric-value current-prefix-arg)
                     last-nonmenu-event))
  (my-scroll-year-calendar-forward-year (- (<span class="org-keyword">or</span> arg 1)) event))
(eval-after-load <span class="org-string">"calendar"</span> '(progn
  (define-key calendar-mode-map <span class="org-string">"{"</span> 'my-scroll-year-calendar-backward-year)
  (define-key calendar-mode-map <span class="org-string">"}"</span> 'my-scroll-year-calendar-forward-year)))
</pre>
</div>

<p>
I used <code>M-x gif-screencast</code> to make the animated GIF. Yay Emacs!
</p>
</div>
</div>
</div>
<div id="outline-container-workrave" class="outline-3">
<h3 id="workrave">Workrave</h3>
<div class="outline-text-3" id="text-workrave">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-workrave-file</span> (expand-file-name <span class="org-string">".\\Workrave\\historystats"</span> (getenv <span class="org-string">"AppData"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-workrave-transform-statistics</span> (<span class="org-type">&amp;optional</span> file)
  (<span class="org-keyword">interactive</span> (list my-workrave-file))
  (<span class="org-keyword">with-current-buffer</span> (find-file-noselect file)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">D day month-1 year hour min day month-1 year hour min</span>
    (<span class="org-keyword">let</span> ((result <span class="org-string">"Date\tStart\tEnd\tClicks\tKeystrokes\n"</span>))
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"^D </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
        (<span class="org-keyword">let</span> ((dates (split-string (match-string 1))))
          (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"^m </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
              (<span class="org-keyword">let</span> ((info (split-string (match-string 1))))
                (<span class="org-keyword">setq</span> result
                      (concat result
                              (format <span class="org-string">"%d-%d-%s\t%s:%02d\t%s:%02d\t%s\t%s\n"</span>
                                      (+ 1900 (string-to-number (elt dates 2))) <span class="org-comment-delimiter">; </span><span class="org-comment">year</span>
                                      (1+ (string-to-number (elt dates 1))) <span class="org-comment-delimiter">; </span><span class="org-comment">month</span>
                                      (elt dates 0) <span class="org-comment-delimiter">; </span><span class="org-comment">day</span>
                                      (elt dates 3) <span class="org-comment-delimiter">; </span><span class="org-comment">start hour</span>
                                      (string-to-number (elt dates 4)) <span class="org-comment-delimiter">; </span><span class="org-comment">start min</span>
                                      (elt dates 8) <span class="org-comment-delimiter">; </span><span class="org-comment">end hour</span>
                                      (string-to-number (elt dates 9)) <span class="org-comment-delimiter">; </span><span class="org-comment">end min</span>
                                      (elt info 5) <span class="org-comment-delimiter">; </span><span class="org-comment">clicks</span>
                                      (elt info 6) <span class="org-comment-delimiter">; </span><span class="org-comment">keystrokes</span>
                                      )))))))
      (<span class="org-keyword">if</span> (interactive-p)
          (kill-new result)
        result))))
</pre>
</div>
</div>
</div>
<div id="outline-container-blog" class="outline-3">
<h3 id="blog">Blog</h3>
<div class="outline-text-3" id="text-blog">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-strip-blog-share</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (base)
    (<span class="org-keyword">save-excursion</span>
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward
              <span class="org-string">"&lt;div class=\"sharedaddy sd-sharing-enabled\"&gt;.*?&lt;div class=\"sharing-clear\"&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;"</span> nil t)
        (replace-match <span class="org-string">""</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-time-tracking-previous-weekly-review" class="outline-3">
<h3 id="time-tracking-previous-weekly-review">Time tracking, previous weekly review</h3>
<div class="outline-text-3" id="text-time-tracking-previous-weekly-review">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-quantified-categories</span>
  '((<span class="org-string">"Business"</span>
     (<span class="org-string">"Earn"</span> . <span class="org-string">"Business - Earn"</span>)
     (<span class="org-string">"E1"</span> . <span class="org-string">"Business - Earn - Consulting - E1"</span>)
     (<span class="org-string">"Connect"</span> . <span class="org-string">"Business - Connect"</span>)
     (<span class="org-string">"Build"</span> . <span class="org-string">"Business - Build"</span>))
    (<span class="org-string">"Discretionary"</span>
     (<span class="org-string">"Social"</span> . <span class="org-string">"Discretionary - Social"</span>)
     (<span class="org-string">"Productive"</span> . <span class="org-string">"Discretionary - Productive"</span>)
     (<span class="org-string">"Sewing"</span> . <span class="org-string">"Discretionary - Productive - Sewing"</span>)
     (<span class="org-string">"Writing"</span> . <span class="org-string">"Discretionary - Productive - Writing"</span>)
     (<span class="org-string">"Emacs"</span> . <span class="org-string">"Discretionary - Productive - Emacs"</span>)
     (<span class="org-string">"Play"</span> . <span class="org-string">"Discretionary - Play"</span>))
    (<span class="org-string">"Personal"</span> <span class="org-comment-delimiter">;</span><span class="org-comment">("Biking" . "Personal - Bike")</span>
     (<span class="org-string">"Routines"</span> . <span class="org-string">"Personal - Routines"</span>))
    (<span class="org-string">"Sleep"</span> nil)
    (<span class="org-string">"Unpaid work"</span>
     (<span class="org-string">"Commuting"</span> . <span class="org-string">"Unpaid work - Subway"</span>)
     (<span class="org-string">"Cook"</span> . <span class="org-string">"Unpaid work - Cook"</span>)
     (<span class="org-string">"Tidy"</span> . <span class="org-string">"Unpaid work - Tidy up"</span>)))
  <span class="org-doc">"Categories for time summary."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-summarize-time-use</span> (<span class="org-type">&amp;optional</span> start end)
  (<span class="org-keyword">interactive</span> (list (org-read-date) (org-read-date)))
  (<span class="org-keyword">let</span> ((time-summary (quantified-summarize-time start end))
        (categories my-org-quantified-categories)
        result)
    (<span class="org-keyword">setq</span> result
          (mapconcat
           (<span class="org-keyword">lambda</span> (a)
             (<span class="org-keyword">if</span> (assoc (car a) time-summary)
                 (concat
                  (format <span class="org-string">"- %s: %.1f hours"</span> (car a) (/ (cdr (assoc (car a) time-summary)) 3600.0))
                  (<span class="org-keyword">if</span> (cdr a)
                      (<span class="org-keyword">let</span> ((detail
                             (delq nil
                                   (mapcar (<span class="org-keyword">lambda</span> (b)
                                             (<span class="org-keyword">if</span> (assoc (cdr b) time-summary)
                                                 (format <span class="org-string">"%s: %.1f"</span>
                                                         (car b)
                                                         (/ (cdr (assoc (cdr b) time-summary)) 3600.0))
                                               nil))
                                           (cdr a)))))
                        (<span class="org-keyword">if</span> detail
                            (concat <span class="org-string">" ("</span> (mapconcat 'identity detail <span class="org-string">", "</span>) <span class="org-string">")"</span>)
                          <span class="org-string">""</span>))
                    <span class="org-string">""</span>)
                  (<span class="org-keyword">if</span> (string-equal (car a) <span class="org-string">"Sleep"</span>)
                      (format <span class="org-string">" - average of %.1f hours per day"</span> (/ (cdr (assoc (car a) time-summary)) 3600.0 7.0))
                    <span class="org-string">""</span>)
                  <span class="org-string">"\n"</span>)))
           categories <span class="org-string">""</span>))
    (<span class="org-keyword">if</span> (called-interactively-p 'any)
        (insert result)
      result)))
</pre>
</div>
</div>
<div id="outline-container-list-upcoming-tasks-so-that-i-can-see-if-i-m-overloaded" class="outline-4">
<h4 id="list-upcoming-tasks-so-that-i-can-see-if-i-m-overloaded">List upcoming tasks so that I can see if I'm overloaded</h4>
<div class="outline-text-4" id="text-list-upcoming-tasks-so-that-i-can-see-if-i-m-overloaded">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-summarize-upcoming-week</span> ()
  <span class="org-doc">"Summarize upcoming tasks as a list."</span>
  (<span class="org-keyword">interactive</span>)
  (org-agenda nil <span class="org-string">"w"</span>)
  (<span class="org-keyword">let</span> ((string (buffer-string))
        business relationships life)
    (<span class="org-keyword">with-temp-buffer</span>
      (insert string)
      (goto-char (point-min))
      (<span class="org-keyword">while</span> (re-search-forward my-weekly-review-line-regexp nil t)
        (<span class="org-keyword">cond</span>
         ((string= (match-string 1) <span class="org-string">"routines"</span>) nil) <span class="org-comment-delimiter">; </span><span class="org-comment">skip routine tasks</span>
         ((string= (match-string 1) <span class="org-string">"business"</span>)
          (add-to-list 'business (concat <span class="org-string">"  - [ ] "</span> (match-string 3))))
         ((string= (match-string 1) <span class="org-string">"people"</span>)
          (add-to-list 'relationships (concat <span class="org-string">"  - [ ] "</span> (match-string 3))))
         (t (add-to-list 'life (concat <span class="org-string">"  - [ ] "</span> (match-string 3)))))))
    (<span class="org-keyword">setq</span> string
          (concat
           <span class="org-string">"*Plans for next week*\n"</span>
           <span class="org-string">"- Business\n"</span>
           (mapconcat 'identity business <span class="org-string">"\n"</span>)
           <span class="org-string">"\n- Relationships\n"</span>
           (mapconcat 'identity relationships <span class="org-string">"\n"</span>)
           <span class="org-string">"\n- Life\n"</span>
           (mapconcat 'identity life <span class="org-string">"\n"</span>)))
    (<span class="org-keyword">if</span> (called-interactively-p 'any)
        (kill-new string)
      string)))
</pre>
</div>

<p>
This uses Org Agenda's log mode to summarize the tasks that I checked
off. I still need to match it up with the plans for the previous week
to see which items I'd planned ahead, and which ones were new tasks.
(Hmm, is it important to track those separately? I might just skip it.)
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-summarize-previous-week</span> ()
  <span class="org-doc">"Summarize previously-completed tasks as a list."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-window-excursion</span>
    (org-agenda nil <span class="org-string">"w"</span>)
    (org-agenda-later -1)
    (org-agenda-log-mode 16)
    (<span class="org-keyword">let</span> ((string (buffer-string))
          business relationships life)
      (<span class="org-keyword">with-temp-buffer</span>
        (insert string)
        (goto-char (point-min))
        (<span class="org-keyword">while</span> (re-search-forward my-weekly-review-line-regexp nil t)
          (<span class="org-keyword">cond</span>
           ((string= (match-string 1) <span class="org-string">"routines"</span>) nil) <span class="org-comment-delimiter">; </span><span class="org-comment">skip routine tasks</span>
           ((string= (match-string 1) <span class="org-string">"business"</span>)
            (add-to-list 'business (concat <span class="org-string">"  - "</span> (match-string 2))))
           ((string= (match-string 1) <span class="org-string">"people"</span>)
            (add-to-list 'relationships (concat <span class="org-string">"  - "</span> (match-string 2))))
           (t (add-to-list 'life (concat <span class="org-string">"  - "</span> (match-string 2)))))))
      (<span class="org-keyword">setq</span> string
            (concat
             <span class="org-string">"*Accomplished this week*\n\n"</span>
             <span class="org-string">"- Business\n"</span>
             (mapconcat 'identity business <span class="org-string">"\n"</span>)
             <span class="org-string">"\n- Relationships\n"</span>
             (mapconcat 'identity relationships <span class="org-string">"\n"</span>)
             <span class="org-string">"\n- Life\n"</span>
             (mapconcat 'identity life <span class="org-string">"\n"</span>)))
      (<span class="org-keyword">if</span> (called-interactively-p 'any)
          (kill-new string)
        string))))

</pre>
</div>
</div>
</div>
<div id="outline-container-compare-time-use" class="outline-4">
<h4 id="compare-time-use">Compare time use</h4>
<div class="outline-text-4" id="text-compare-time-use">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-quantified-compare</span> (start1 end1 start2 end2 <span class="org-type">&amp;optional</span> categories label1 label2)
  <span class="org-doc">"Return a table comparing the times for START1 - END1 and START2 - END2."</span>
  (<span class="org-keyword">let*</span> ((start2 (org-read-date nil nil (<span class="org-keyword">or</span> start2 <span class="org-string">"-sat"</span>)))
         (end2 (org-read-date nil nil (<span class="org-keyword">or</span> end2 <span class="org-string">"+1"</span>)))
         (start1 (org-read-date nil nil (<span class="org-keyword">or</span> start1 <span class="org-string">"-4sat"</span>)))
         (end1 (org-read-date nil nil (<span class="org-keyword">or</span> end1 <span class="org-string">"-sat"</span>)))
         (time2 (quantified-summarize-time start2 end2))
         (time1 (quantified-summarize-time start1 end1))
         (label1 (<span class="org-keyword">or</span> label1 <span class="org-string">"Period 1 %"</span>))
         (label2 (<span class="org-keyword">or</span> label2 <span class="org-string">"Period 2 %"</span>))
         (total2 (* 0.01 (- (org-time-string-to-seconds end2) (org-time-string-to-seconds start2))))
         (total1 (* 0.01 (- (org-time-string-to-seconds end1) (org-time-string-to-seconds start1))))
         (keys (<span class="org-keyword">or</span> categories (-union (mapcar 'car time1) (mapcar 'car time2)))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Build a list comparing the two</span>
    (append
     `((<span class="org-string">"Category"</span> ,label1 ,label2 <span class="org-string">"Diff %"</span> <span class="org-string">"h/wk"</span> <span class="org-string">"Diff h/wk"</span>) hline)
     (sort
      (mapcar (<span class="org-keyword">lambda</span> (key)
                (list
                 key
                 (format <span class="org-string">"%.1f"</span> (/ (<span class="org-keyword">or</span> (assoc-default key time1) 0) total1))
                 (format <span class="org-string">"%.1f"</span> (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total2))
                 (format <span class="org-string">"%.1f"</span> (- (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total2)
                                   (/ (<span class="org-keyword">or</span> (assoc-default key time1) 0) total1)))
                 (format <span class="org-string">"%.1f"</span> (* (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total1) 1.68))
                 (format <span class="org-string">"%.1f"</span>
                         (* (- (/ (<span class="org-keyword">or</span> (assoc-default key time2) 0) total2)
                               (/ (<span class="org-keyword">or</span> (assoc-default key time1) 0) total1)) <span class="org-warning">1.68))</span>
                 )) <span class="org-warning">keys)</span>
      (<span class="org-keyword">lambda</span> (a b)
        (&lt;
         (string-to-number (car (last b)))
         (string-to-number (car (last a)))))))))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-on-my-phone" class="outline-2">
<h2 id="on-my-phone">Emacs and my phone</h2>
<div class="outline-text-2" id="text-on-my-phone">
<p>
I use Orgzly Revived on an Android phone, synchronizing my files with
Syncthing. (See <code>my-resolve-orgzly-syncthing</code> elsewhere in this
config.) Sometimes I use Termux, too.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> browse-url-browser-function 'browse-url-firefox)
(<span class="org-keyword">unless</span> window-system
  (xterm-mouse-mode 1)
  (global-set-key [mouse-4] (<span class="org-keyword">lambda</span> ()
                              (<span class="org-keyword">interactive</span>)
                              (scroll-down 1)))
  (global-set-key [mouse-5] (<span class="org-keyword">lambda</span> ()
                              (<span class="org-keyword">interactive</span>)
                              (scroll-up 1))))
(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">when</span> my-phone-p
    (add-to-list 'org-file-apps '(<span class="org-string">"\\.png\\'"</span> . default))
    (add-to-list 'org-file-apps '(<span class="org-string">"\\.jpg\\'"</span> . default))
    (add-to-list 'org-file-apps '(<span class="org-string">"\\.jpeg\\'"</span> . default)))
  )

(<span class="org-keyword">defun</span> <span class="org-function-name">my-format-intent</span> (intent <span class="org-type">&amp;optional</span> params)
  <span class="org-doc">"Return a command string for sending INTENT with PARAMS.</span>
<span class="org-doc">      PARAMS is an alist of (\"key\" . \"value\") pairs."</span>
  (format <span class="org-string">"am broadcast --user 0 -a %s %s"</span>
          intent
          (mapconcat
           (<span class="org-keyword">lambda</span> (o)
             (format
              <span class="org-string">"-e %s %s"</span>
              (shell-quote-argument (car o))
              (shell-quote-argument (cdr o))))
           params
           <span class="org-string">" "</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-send-intent</span> (intent <span class="org-type">&amp;optional</span> params)
  <span class="org-doc">"Send broadcast INTENT to my phone.</span>
<span class="org-doc">      PARAMS is a plist of :key value pairs."</span>
  (<span class="org-keyword">let</span> ((command (my-format-intent intent params)))
    (<span class="org-keyword">if</span> my-phone-p
        (shell-command command)
      (shell-command (format <span class="org-string">"ssh phone %s"</span> (shell-quote-argument command))))))

</pre>
</div>
</div>
<div id="outline-container-syncthing" class="outline-3">
<h3 id="syncthing">Syncthing</h3>
<div class="outline-text-3" id="text-syncthing">
<p>
From <a href="https://www.reddit.com/r/emacs/comments/bqqqra/quickly_find_syncthing_conflicts_and_resolve_them/">https://www.reddit.com/r/emacs/comments/bqqqra/quickly_find_syncthing_conflicts_and_resolve_them/</a>
In termux, you also need to <code>pkg install diffutils</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> ediff-toggle-skip-similar t
      ediff-diff-options <span class="org-string">"-w"</span>
      ediff-window-setup-function 'ediff-setup-windows-plain
      ediff-split-window-function 'split-window-horizontally)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-resolve-orgzly-syncthing</span> ()
  (<span class="org-keyword">interactive</span>)
  (ibizaman/syncthing-resolve-conflicts <span class="org-string">"~/sync/orgzly"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-resolve-conflicts</span> (directory)
  <span class="org-doc">"Resolve all conflicts under given DIRECTORY."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"D"</span>)
  (<span class="org-keyword">let*</span> ((all (ibizaman/syncthing--get-sync-conflicts directory))
         (chosen (ibizaman/syncthing--pick-a-conflict all)))
    (ibizaman/syncthing-resolve-conflict chosen)))


(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-show-conflicts-dired</span> (directory)
  <span class="org-doc">"Open dired buffer at DIRECTORY showing all syncthing conflicts."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"D"</span>)
  (find-name-dired directory <span class="org-string">"*.sync-conflict-*org"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-resolve-conflict-dired</span> (<span class="org-type">&amp;optional</span> arg)
  <span class="org-doc">"Resolve conflict of first marked file in dired or close to point with ARG."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">let</span> ((chosen (car (dired-get-marked-files nil arg))))
    (ibizaman/syncthing-resolve-conflict chosen)))

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing-resolve-conflict</span> (conflict)
  <span class="org-doc">"Resolve CONFLICT file using ediff."</span>
  (<span class="org-keyword">let*</span> ((normal (ibizaman/syncthing--get-normal-filename conflict)))
    (ibizaman/ediff-files
     (list conflict normal)
     `(<span class="org-keyword">lambda</span> ()
        (<span class="org-keyword">when</span> (y-or-n-p <span class="org-string">"Delete conflict file? "</span>)
          (kill-buffer (get-file-buffer ,conflict))
          (delete-file ,conflict))))))



(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing--get-sync-conflicts</span> (directory)
  <span class="org-doc">"Return a list of all sync conflict files in a DIRECTORY."</span>
  (seq-filter (<span class="org-keyword">lambda</span> (o) (not (string-match <span class="org-string">"\\.stversions"</span> o))) (directory-files-recursively directory <span class="org-string">"\\.sync-conflict-.*org$"</span>)))


(<span class="org-keyword">defvar</span> <span class="org-variable-name">ibizaman/syncthing--conflict-history</span> nil
  <span class="org-doc">"Completion conflict history"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing--pick-a-conflict</span> (conflicts)
  <span class="org-doc">"Let user choose the next conflict from CONFLICTS to investigate."</span>
  (completing-read <span class="org-string">"Choose the conflict to investigate: "</span> conflicts
                   nil t nil ibizaman/syncthing--conflict-history))


(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/syncthing--get-normal-filename</span> (conflict)
  <span class="org-doc">"Get non-conflict filename matching the given CONFLICT."</span>
  (replace-regexp-in-string <span class="org-string">"\\.sync-conflict-.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\..*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> <span class="org-string">"\\1"</span> conflict))


(<span class="org-keyword">defun</span> <span class="org-function-name">ibizaman/ediff-files</span> (<span class="org-type">&amp;optional</span> files quit-hook)
  (<span class="org-keyword">interactive</span>)
  (lexical-let ((files (<span class="org-keyword">or</span> files (dired-get-marked-files)))
                (quit-hook quit-hook)
                (wnd (current-window-configuration)))
    (<span class="org-keyword">if</span> (&lt;= (length files) 2)
        (<span class="org-keyword">let</span> ((file1 (car files))
              (file2 (<span class="org-keyword">if</span> (cdr files)
                         (cadr files)
                       (read-file-name
                        <span class="org-string">"file: "</span>
                        (dired-dwim-target-directory)))))
          (<span class="org-keyword">if</span> (file-newer-than-file-p file1 file2)
              (ediff-files file2 file1)
            (ediff-files file1 file2))
          (add-hook 'ediff-after-quit-hook-internal
                    (<span class="org-keyword">lambda</span> ()
                      (<span class="org-keyword">setq</span> ediff-after-quit-hook-internal nil)
                      (<span class="org-keyword">when</span> quit-hook (funcall quit-hook))
                      (set-window-configuration wnd))))
      (<span class="org-warning">error</span> <span class="org-string">"no more than 2 files should be marked"</span>))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-clipboard" class="outline-2">
<h2 id="clipboard">Clipboard</h2>
<div class="outline-text-2" id="text-clipboard">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> clipmon
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:init</span> (<span class="org-keyword">progn</span> (<span class="org-keyword">setq</span> clipmon-action 'kill-new clipmon-timeout nil clipmon-sound nil clipmon-cursor-color nil clipmon-suffix nil) (clipmon-mode)))
</pre>
</div>

<p>
On my phone:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> xclip <span class="org-builtin">:if</span> my-phone-p) <span class="org-comment-delimiter">; </span><span class="org-comment">Turn on with xclip-mode</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-mail-and-news" class="outline-2">
<h2 id="mail-and-news">Mail and news</h2>
<div class="outline-text-2" id="text-mail-and-news">
</div>
<div id="outline-container-notmuch" class="outline-3">
<h3 id="notmuch">Notmuch</h3>
<div class="outline-text-3" id="text-notmuch">
<p>
I use Notmuch with <a href="https://github.com/gauteh/lieer">Lieer</a> to fetch my mail from Gmail.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> notmuch-message-headers '(<span class="org-string">"Subject"</span> <span class="org-string">"To"</span> <span class="org-string">"Cc"</span> <span class="org-string">"Date"</span> <span class="org-string">"Reply-To"</span>))
(<span class="org-keyword">use-package</span> notmuch
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq-default</span> notmuch-search-oldest-first nil)
  (<span class="org-keyword">setq</span> notmuch-fcc-dirs nil)
  (<span class="org-keyword">setq</span> notmuch-archive-tags '(<span class="org-string">"-inbox"</span> <span class="org-string">"-flagged"</span> <span class="org-string">"-unread"</span> <span class="org-string">"-new"</span>)))
(<span class="org-keyword">use-package</span> ol-notmuch
  <span class="org-builtin">:if</span> my-laptop-p)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-notmuch-flagged</span> ()
  (<span class="org-keyword">interactive</span>)
  (notmuch-search <span class="org-string">"tag:flagged and not tag:trash"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-notmuch-inbox</span> ()
  (<span class="org-keyword">interactive</span>)
  (notmuch-search <span class="org-string">"tag:inbox and not tag:trash"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-notmuch-important-inbox</span> ()
  (<span class="org-keyword">interactive</span>)
  (notmuch-search <span class="org-string">"tag:primary and tag:inbox and not tag:trash"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-notmuch-search-this-author</span> ()
  (<span class="org-keyword">interactive</span>)
  (notmuch-search (format <span class="org-string">"from:\"%s\""</span>
                          (plist-get (get-text-property (point) 'notmuch-search-result) <span class="org-builtin">:authors</span>))))
</pre>
</div>
</div>
<div id="outline-container-act-on-current-message-with-embark" class="outline-4">
<h4 id="act-on-current-message-with-embark">Act on current message with Embark</h4>
<div class="outline-text-4" id="text-act-on-current-message-with-embark">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">mail-embark-finder</span> ()
  <span class="org-doc">"Identify when we're in a notmuch message."</span>
  (<span class="org-keyword">cond</span> ((derived-mode-p 'notmuch-show-mode)
         `(mail . ,(plist-get (plist-get (notmuch-show-get-message-properties) <span class="org-builtin">:headers</span>) <span class="org-builtin">:From</span>)))))
(<span class="org-keyword">with-eval-after-load</span> 'embark
  (add-to-list 'embark-target-finders 'mail-embark-finder)
  )

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-gnus" class="outline-3">
<h3 id="gnus">Gnus</h3>
<div class="outline-text-3" id="text-gnus">
<p>
I still use Gnus so that I can use <a href="http://gmane.org">Gmane</a> to read mailing lists.
</p>

<p>
I used to have my config in in <code>~/.gnus</code>, but people might find it
handy, so I've added it to my public <a href="http://sachacuha.com/dotemacs">Emacs configuration</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> gnus-select-method '(nnnil <span class="org-string">""</span>))
(<span class="org-keyword">setq</span> gnus-secondary-select-methods
      '((nntp <span class="org-string">"news.gmane.io"</span>)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(nnmaildir "mail"</span>
        <span class="org-comment-delimiter">;;            </span><span class="org-comment">(directory "~/Maildir/account.gmail")</span>
        <span class="org-comment-delimiter">;;            </span><span class="org-comment">(directory-files nnheader-directory-files-safe)</span>
        <span class="org-comment-delimiter">;;           </span><span class="org-comment">(get-new-mail nil))</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(nnimap "imap.googlemail.com"</span>
        <span class="org-comment-delimiter">;;         </span><span class="org-comment">(nnimap-address "imap.googlemail.com")</span>
        <span class="org-comment-delimiter">;;         </span><span class="org-comment">(nnimap-server-port 993)</span>
        <span class="org-comment-delimiter">;;         </span><span class="org-comment">(nnimap-stream ssl)</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(nnimap-authenticator login))</span>
        (nnimap <span class="org-string">"localhost"</span>
          (nnimap-address <span class="org-string">"localhost"</span>)
          (nnimap-stream network)
          (nnimap-user <span class="org-string">"sacha"</span>)
          (nnimap-authenticator login)
          (nnimap-authinfo-file <span class="org-string">"~/.authinfo.gpg"</span>))
        ))
(<span class="org-keyword">setq</span> smtpmail-smtp-server <span class="org-string">"smtp.googlemail.com"</span>
      smtpmail-smtp-service 587
      smtpmail-auth-credentials <span class="org-string">"~/.authinfo.gpg"</span>
      send-mail-function 'smtpmail-send-it
      message-send-mail-function 'smtpmail-send-it
      gnus-check-new-newsgroups nil
      gnus-activate-level 2
      gnus-ignored-newsgroups <span class="org-string">"^to\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[0-9. ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">$</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^[\"]\"[#'()]"</span>)
</pre>
</div>

<p>
I now use Dovecot with OfflineIMAP for local IMAP access to my mail
and synchronization with Gmail, but you can see the commented-out
information for Gmail in case you prefer that. I have two-factor
authentication enabled for Gmail, so I set up an app-specific password
for Gnus. I have GPG set up for encryption, and an <code>~/.authinfo.gpg</code>
file set up with something like:
</p>

<pre class="example" id="org9f9e6e4">
machine imap.gmail.com login sacha@sachachua.com password mysecretapppassword
machine imap.gmail.com login sacha@sachachua.com password mysecretapppassword port 993
machine smtp.gmail.com login sacha@sachachua.com password mysecretapppassword port 587
machine localhost login sacha password mysecretlocalpassword port 993
machine localhost login sacha password mysecretlocalpassword port 143
</pre>

<p>
If you don't have GPG set up and you don't mind saving your passwords
in the clear, you can set up an <code>~/.authinfo</code> file instead.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> gnus
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">mm-decode</span>)
  (<span class="org-keyword">setq</span> mm-discouraged-alternatives
        '(<span class="org-string">"text/html"</span> <span class="org-string">"text/richtext"</span>)
        mm-automatic-display
        (-difference mm-automatic-display '(<span class="org-string">"text/html"</span> <span class="org-string">"text/enriched"</span> <span class="org-string">"text/richtext"</span>))))
</pre>
</div>

<p>
Hide quoted text.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> gnus-treat-hide-citation t)
</pre>
</div>

<p>
Get smarter about filtering depending on what I reed or mark. I use <code>!</code> (tick) for marking threads as something that interests me.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> gnus-use-adaptive-scoring t)
(<span class="org-keyword">setq</span> gnus-default-adaptive-score-alist
      '((gnus-unread-mark)
        (gnus-ticked-mark (subject 10))
        (gnus-killed-mark (subject -5))
        (gnus-catchup-mark (subject -1))))
</pre>
</div>
</div>
<div id="outline-container-windows" class="outline-4">
<h4 id="windows">Windows</h4>
<div class="outline-text-4" id="text-windows">
<div class="update" id="org698763f">
<p>
I don't use Windows much any more, but this is here in case it's helpful for people who still do.
</p>

</div>

<p>
Sending e-mail on Windows was a bit of a pain. Fortunately, I
eventually found something that works. I've configured <a href="http://emailrelay.sourceforge.net/">emailrelay</a> to
accept the mail and forward it to Gmail. The server starts with this
batch file:
</p>

<pre class="example" id="org434f443">
start "emailrelay" "C:\Program Files (x86)\emailrelay\emailrelay.exe" --as-proxy smtp.gmail.com:25 --client-auth "C:/sacha/.emailrelay" --client-tls --log --pid-file "C:\Program Files (x86)\emailrelay\emailrelay.pid" --spool-dir C:\sacha\tmp\emailrelay
</pre>

<p>
Sending queued mail works with this batch file:
</p>

<pre class="example" id="orgd4a4506">
"c:\Program Files (x86)\emailrelay\emailrelay.exe" --as-client smtp.gmail.com:587 --client-auth c:\sacha\.emailrelay --client-tls --spool-dir c:\sacha\tmp\emailrelay
</pre>

<p>
I should probably get around to using <code>--as-proxy</code> properly, since it still seems to hold mail until I explicitly send it.
</p>

<p>
On Linux, it's simply a matter of setting up a mail server such as
<a href="https://easyengine.io/tutorials/linux/ubuntu-postfix-gmail-smtp/">Postfix</a>.
</p>

<p>
Hide HTML mail. I need to fiddle with this some more, since Gnus still
tries to display them. Sometimes my Gnus crashes when it tries to
display HTML mail.
</p>
</div>
</div>
</div>
<div id="outline-container-approve-or-discard-mailman-messages" class="outline-3">
<h3 id="approve-or-discard-mailman-messages">Approve or discard Mailman messages</h3>
<div class="outline-text-3" id="text-approve-or-discard-mailman-messages">
<p>
The mailing lists for <a href="https://lists.gnu.org/mailman/listinfo/emacsconf-org">emacsconf-org</a>, <a href="https://lists.gnu.org/mailman/listinfo/emacsconf-org-private">emacsconf-org-private</a>,
<a href="https://lists.gnu.org/mailman/listinfo/emacsconf-submit">emacsconf-submit</a>, and <a href="https://lists.gnu.org/mailman/listinfo/emacs-tangents">emacs-tangents</a> are all handled by the Mailman
program. We usually set mailing lists to moderated so that
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mailman-approve</span> ()
  <span class="org-doc">"Approve this mailing list message."</span>
  (<span class="org-keyword">interactive</span>)
  (goto-char (point-min))
  (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"From: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">-request@.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\nSubject: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">confirm [0-9a-f]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
    (<span class="org-keyword">let*</span> ((id (match-string 2)))
      (compose-mail (match-string 1) (match-string 3)
                    `((<span class="org-string">"Approved"</span> . ,(string-trim (shell-command-to-string
                                                   (concat <span class="org-string">"pass "</span> (match-string 2)))))))
      (message-send-and-exit))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mailman-discard</span> ()
  <span class="org-doc">"Discard the current message."</span>
  (<span class="org-keyword">interactive</span>)
  (goto-char (point-min))
  (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"From: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">-request@.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\nSubject: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">confirm [0-9a-f]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
    (compose-mail (match-string 1) (match-string 3))
    (message-send-and-exit)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mailman-web</span> (<span class="org-type">&amp;optional</span> list-id)
  <span class="org-doc">"Open the web admin interface."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (derived-mode-p 'notmuch-show-mode)
             (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">https://.+?/mailman/admindb/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t))
       (match-string 2)
     (completing-read <span class="org-string">"List: "</span> '(<span class="org-string">"emacsconf-org"</span> <span class="org-string">"emacsconf-org-private"</span> <span class="org-string">"emacs-tangents"</span> <span class="org-string">"emacsconf-submit"</span>)))))
  (goto-char (point-min))
  (browse-url (concat <span class="org-string">"https://lists.gnu.org/mailman/admindb/"</span> list-id <span class="org-string">"?adminpw="</span>
                        (url-hexify-string (string-trim (shell-command-to-string
                                                         (concat <span class="org-string">"pass "</span> list-id)))))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-emacs-server" class="outline-2">
<h2 id="emacs-server">Emacs server</h2>
<div class="outline-text-2" id="text-emacs-server">
<p>
<code>(server-start)</code> permits the use of <code>emacsclient</code>, <code>emacsclientw</code>, and
<code>org-protocol</code>. I used to start a server as part of my config. Now I'm
switching to using <code>emacs --daemon</code>, which starts a server
automatically. Anyway, with <code>--daemon</code>, Emacs doesn't start off in a
graphical environment, so the frames that <code>emacsclient -c</code> creates
don't get the theme applied. This fixes that:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-hook 'after-make-frame-functions
          (<span class="org-keyword">lambda</span> (frame)
            (select-frame frame)
            (my-setup-color-theme)))
</pre>
</div>
</div>
</div>
<div id="outline-container-collaboration" class="outline-2">
<h2 id="collaboration">Collaboration</h2>
<div class="outline-text-2" id="text-collaboration">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> crdt
  <span class="org-builtin">:quelpa</span> (crdt <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"zaeph/crdt.el"</span>)
  <span class="org-builtin">:commands</span> (crdt-share-buffer crdt-connect)
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/crdt.el"</span>
  <span class="org-builtin">:if</span> my-laptop-p)

</pre>
</div>
</div>
</div>
<div id="outline-container-streaming" class="outline-2">
<h2 id="streaming">Streaming</h2>
<div class="outline-text-2" id="text-streaming">
</div>
<div id="outline-container-simple-streaming" class="outline-3">
<h3 id="simple-streaming">Simple streaming with FFmpeg</h3>
<div class="outline-text-3" id="text-simple-streaming">
<div class="update" id="orgbad2878">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-01-20 Sat]</span></span>: As it turns out, my X230T can't
handle streaming with FFMmpeg. I get like half a
frame a second. I'll try using vdo.ninja to send
my screen over to another computer that might be
able to handle OBS.
</p>

</div>

<p>
My X230T can't handle OBS, but maybe I can stream with FFmpeg.

</p>

<div class="org-src-container">
<pre class="src src-sh" id="org804c5ec"><span class="org-comment-delimiter"># </span><span class="org-comment">From pacmd list-sources | egrep '^\s+name'</span>
<span class="org-builtin">export</span> <span class="org-variable-name">LAPEL</span>=alsa_input.usb-Jieli_Technology_USB_Composite_Device_433035383239312E-00.mono-fallback <span class="org-comment-delimiter">#</span>
<span class="org-builtin">export</span> <span class="org-variable-name">YETI</span>=alsa_input.usb-Blue_Microphones_Yeti_Stereo_Microphone_REV8-00.analog-stereo
<span class="org-builtin">export</span> <span class="org-variable-name">SYSTEM</span>=alsa_output.pci-0000_00_1b.0.analog-stereo.monitor
<span class="org-comment-delimiter"># </span><span class="org-comment">MIC=$LAPEL</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">AUDIO_WEIGHTS="1 1"</span>
<span class="org-builtin">export</span> <span class="org-variable-name">MIC</span>=$<span class="org-variable-name">YETI</span>
<span class="org-builtin">export</span> <span class="org-variable-name">AUDIO_WEIGHTS</span>=<span class="org-string">"0.5 0.5"</span>
<span class="org-builtin">export</span> <span class="org-variable-name">OFFSET</span>=+1920,430
<span class="org-builtin">export</span> <span class="org-variable-name">SIZE</span>=1280x720
<span class="org-builtin">export</span> <span class="org-variable-name">SCREEN</span>=LVDS-1  <span class="org-comment-delimiter"># </span><span class="org-comment">from xrandr</span>
xrandr --output $<span class="org-variable-name">SCREEN</span> --mode 1280x720
</pre>
</div>

<p>
I switch to a larger size and a light theme. I also turn <a href="https://github.com/minad/consult">consult</a> previews off to minimize the risk of leaking data through buffer previews.
</p>

<p>
<a href="https://sachachua.com/dotemacs#prepare-for-emacsconf-screenshots-or-recordings">https://sachachua.com/dotemacs#prepare-for-emacsconf-screenshots-or-recordings</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">source</span> ~/bin/setup-laptop-for-streaming
<span class="org-variable-name">DATE</span>=$(<span class="org-sh-quoted-exec">date "+%Y-%m-%d-%H-%M-%S"</span>)
ffmpeg -f x11grab -framerate 30 -video_size $<span class="org-variable-name">SIZE</span> -i :0.0$<span class="org-variable-name">OFFSET</span> -f pulse -i $<span class="org-variable-name">MIC</span> -f pulse -i $<span class="org-variable-name">SYSTEM</span> -filter_complex <span class="org-string">"amix=inputs=2:weights=$AUDIO_WEIGHTS:duration=longest:normalize=0[audio]"</span> -c:v libx264 -preset fast -maxrate 690k -bufsize 2000k -g 60 -vf <span class="org-variable-name">format</span>=yuv420p -c:a aac -b:a 96k -y -f tee -map 0:v -map <span class="org-string">'[audio]'</span> -flags +global_header  <span class="org-string">"/home/sacha/recordings/$DATE.flv|[f=flv]rtmp://a.rtmp.youtube.com/live2/$YOUTUBE_KEY"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">source</span> ~/bin/setup-laptop-for-streaming
<span class="org-variable-name">DATE</span>=$(<span class="org-sh-quoted-exec">date "+%Y-%m-%d-%H-%M-%S"</span>)
ffmpeg -f x11grab -framerate 30 -video_size $<span class="org-variable-name">SIZE</span> -i :0.0$<span class="org-variable-name">OFFSET</span> -f pulse -i $<span class="org-variable-name">MIC</span> -f pulse -i $<span class="org-variable-name">SYSTEM</span> -filter_complex <span class="org-string">"amix=inputs=2:weights=$AUDIO_WEIGHTS:duration=longest:normalize=0[audio]"</span> -c:v libx264 -preset fast -maxrate 690k -bufsize 2000k -g 60 -vf <span class="org-variable-name">format</span>=yuv420p -c:a aac -b:a 96k -map 0:v -map <span class="org-string">'[audio]'</span> -y <span class="org-string">"/home/sacha/recordings/$DATE.flv"</span>
</pre>
</div>

<p>
Some code to start and stop the stream:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-process</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-type</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-offset-seconds</span> 2 <span class="org-doc">"Number of seconds to offset timestamps."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-start-time</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-toggle</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (process-live-p my-stream-process)
      (my-stream-stop)
    (my-stream-start)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-recording-toggle</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (process-live-p my-stream-process)
      (my-recording-stop)
    (my-recording-start)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-start</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">unless</span> (process-live-p my-stream-process)
    (<span class="org-keyword">unless</span> (getenv <span class="org-string">"YOUTUBE_KEY"</span>)
      (setenv <span class="org-string">"YOUTUBE_KEY"</span> (auth-info-password (auth-source-search <span class="org-builtin">:host</span> <span class="org-string">"https://studio.youtube.com"</span>))))
    (<span class="org-keyword">setq</span> my-stream-type 'stream)
    (<span class="org-keyword">setq</span> my-stream-start-time (current-time))
    (<span class="org-keyword">setq</span> my-stream-process (start-process <span class="org-string">"ffmpeg"</span> (get-buffer-create <span class="org-string">"*stream-ffmpeg*"</span>)
                                           <span class="org-string">"bash"</span> (expand-file-name <span class="org-string">"~/bin/stream-laptop"</span>)))
    (message <span class="org-string">"Streaming."</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-recording-start</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">unless</span> (process-live-p my-stream-process)
    (<span class="org-keyword">setq</span> my-stream-type 'record)
    (<span class="org-keyword">setq</span> my-stream-start-time (current-time))
    (<span class="org-keyword">setq</span> my-stream-process (start-process <span class="org-string">"ffmpeg"</span> (get-buffer-create <span class="org-string">"*stream-ffmpeg*"</span>)
                                           <span class="org-string">"bash"</span> (expand-file-name <span class="org-string">"~/bin/record-laptop"</span>)))
    (message <span class="org-string">"Recording."</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-stop</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (process-live-p my-stream-process)
    (<span class="org-keyword">setq</span> my-stream-type nil)
    (<span class="org-keyword">setq</span> my-stream-start-time nil)
    (stop-process my-stream-process)
    (kill-process my-stream-process)))

(<span class="org-keyword">defalias</span> '<span class="org-function-name">my-recording-stop</span> #'my-stream-stop)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-recordings-dired</span> ()
  (<span class="org-keyword">interactive</span>)
  (dired my-recordings-dir <span class="org-string">"-lt"</span>))
</pre>
</div>

<p>
Let's have relative timestamps:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-insert-timestamp</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> my-stream-start-time
    (<span class="org-keyword">let</span> ((time (format-seconds <span class="org-string">"%.2h:%z%.2m:%.2s"</span>
                                (- (time-to-seconds (current-time))
                                   (time-to-seconds my-stream-start-time)
                                   (<span class="org-keyword">if</span> (eq my-stream-type 'stream) my-stream-offset-seconds 0)))))
      (insert (org-link-make-string
               (concat <span class="org-string">"video:"</span> (my-latest-file <span class="org-string">"~/recordings"</span> <span class="org-string">"flv"</span>)
                       <span class="org-string">":"</span> time)
               time)
              <span class="org-string">" "</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-set-recording-file</span> ()
  (<span class="org-keyword">interactive</span>)
  (org-entry-put (point) <span class="org-string">"RECORDING"</span>
                 (my-latest-file <span class="org-string">"~/recordings"</span> <span class="org-string">"flv"</span>)))
</pre>
</div>

<p>
Ideas for next steps:
</p>

<ul class="org-ul">
<li>Add a <code>[REC]</code> indicator to the modeline.</li>
<li>Get video links to jump to the right spot, maybe based on org-media-note or subed</li>
</ul>
</div>
</div>
<div id="outline-container-controlling-my-stream-audio-from-emacs-background-music-typing-sounds-and-push-to-talk" class="outline-3">
<h3 id="controlling-my-stream-audio-from-emacs-background-music-typing-sounds-and-push-to-talk">Controlling my stream audio from Emacs: background music, typing sounds, and push to talk&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span></span></h3>
<div class="outline-text-3" id="text-controlling-my-stream-audio-from-emacs-background-music-typing-sounds-and-push-to-talk">
<div class="update" id="org91c42b8">
<ul class="org-ul">
<li>2021-02-11: Parsed <code>pacmd list-sources</code> so that I can mute/unmute devices by regular expression.</li>
<li>2021-02-07: Made it work with my USB microphone.</li>
</ul>

</div>

<p>
I was experimenting with streaming Emacs geeking around on <a href="https://twitch.tv/sachachua">twitch.tv</a>.
Someone asked me to have soft background music and typing sounds.
Since I'm a little clueless about music and don't want to bother with
hunting down nice royalty-free music, I figured I could just use the
<a href="https://en.wikipedia.org/wiki/Musikalisches_W%C3%BCrfelspiel#:~:text=The%20most%20well%2Dknown%20was,to%20create%20a%20musical%20piece.">Mozart dice game</a> to programmatically generate music.
</p>

<p>
I installed the <a href="https://developer.aliyun.com/mirror/npm/package/mozart-dice-game">mozart-dice-game</a> NPM package and used this bit of
Javascript to generate a hundred MIDI files.
</p>

<div class="org-src-container">
<pre class="src src-js2">const x = require('mozart-dice-game')
for (let i = 0; i &lt; 100; i++) { x.saveMinuet('minuet' + String(i).padStart('3', '0') + '.mid'); }
</pre>
</div>

<p>
Then I wrote this Emacs Lisp function to turn it on and off.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-background-music-process</span> nil <span class="org-doc">"Process for playing background music"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-toggle-background-music</span> (<span class="org-type">&amp;optional</span> enable)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> my-background-music-process
          (<span class="org-keyword">and</span> (numberp enable) (&lt; enable 0)))
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">when</span> (process-live-p my-background-music-process)
          (kill-process my-background-music-process))
        (<span class="org-keyword">setq</span> my-background-music-process nil))
    (<span class="org-keyword">let</span> ((files (directory-files <span class="org-string">"~/proj/music"</span> t <span class="org-string">"mid\\'"</span>)))
      (<span class="org-keyword">setq</span> my-background-music-process
            (apply
             'start-process
             <span class="org-string">"*Music*"</span>
             nil
             (append (list <span class="org-string">"timidity"</span> <span class="org-string">"-idlr"</span> <span class="org-string">"--volume=10"</span>) files))))))
</pre>
</div>

<p>
People also suggested typing sounds. I guess that's a good way to get
a sense of activity. The default selectric sound was a little too loud
for me, so we'll use the move sound for now. It would be nice to make
this more random-sounding someday.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-selectric-type-sound</span> ()
  <span class="org-doc">"Make the sound of typing."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Someday, randomize this or something</span>
  (selectric-make-sound (expand-file-name <span class="org-string">"selectric-move.wav"</span> selectric-files-path)))

(<span class="org-keyword">use-package</span> selectric-mode
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:diminish</span> <span class="org-string">""</span>
  <span class="org-builtin">:config</span>
  (fset #'selectric-type-sound #'my-selectric-type-sound))
</pre>
</div>

<div class="update" id="orgfb462c5">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-01-10 Wed]</span></span>: I'm using the Blue Yeti microphone now, so I can use the
hardware mute button instead of push to talk.
</p>

</div>

<p>
I was having a hard time remembering to go back on mute during
meetings, since the LED on the mute button wasn't working at the time
and the system tray icon was a little hard to notice. The LED has
mysteriously decided to start working again, but push-to-talk is handy
anyway. I want to be able to tap a key to toggle my microphone on and
off, and hold it down in order to make it push-to-talk. It looks like
my key repeat is less than 0.5 seconds, so I can set a timer that will
turn things off after a little while. This code doesn't pick up any
changes that happen outside Emacs, but it'll do for now. I used <code>pacmd list-sources</code> to list the sources and get the IDs.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-pacmd-set-device</span> (regexp status)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*pacmd*"</span>)
    (erase-buffer)
    (shell-command <span class="org-string">"pacmd list-sources"</span> (current-buffer))
    (goto-char (point-max))
    (<span class="org-keyword">let</span> (results)
      (<span class="org-keyword">while</span> (re-search-backward regexp nil t)
        (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"index: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[[:digit:]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
          (<span class="org-keyword">setq</span> results (cons (match-string 1) results))
          (shell-command-to-string (format <span class="org-string">"pacmd set-source-mute %s %d"</span>
                                           (match-string 1)
                                           (<span class="org-keyword">if</span> (equal status 'on) 0 1)))))
      results)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-mic-p</span> nil <span class="org-doc">"Non-nil means microphone is on"</span>)
(add-to-list 'mode-line-front-space '(<span class="org-builtin">:eval</span> (<span class="org-keyword">if</span> my-mic-p <span class="org-string">"*MIC*"</span> <span class="org-string">""</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-mic-off</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-pacmd-set-device <span class="org-string">"Yeti"</span> 'off)
  (my-pacmd-set-device <span class="org-string">"Internal Microphone"</span> 'off)
  (<span class="org-keyword">setq</span> my-mic-p nil))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-mic-on</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-pacmd-set-device <span class="org-string">"Yeti"</span> 'on)
  (my-pacmd-set-device <span class="org-string">"Internal Microphone"</span> 'on)
  (<span class="org-keyword">setq</span> my-mic-p t))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-mic-toggle</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> my-mic-p (my-mic-off) (my-mic-on)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-push-to-talk-mute-timer</span> nil <span class="org-doc">"Timer to mute things again."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-push-to-talk-last-time</span> nil <span class="org-doc">"Last time my-push-to-talk was run"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-push-to-talk-threshold</span> 0.5 <span class="org-doc">"Number of seconds"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-push-to-talk-mute</span> ()
  (<span class="org-keyword">interactive</span>)
  (message <span class="org-string">"Muting."</span>)
  (my-mic-off)
  (force-mode-line-update)
  (<span class="org-keyword">when</span> obs-websocket-recording-p (my-obs-websocket-add-caption <span class="org-string">"[Microphone off]"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-push-to-talk</span> ()
  <span class="org-doc">"Tap to toggle microphone on and off, or repeat the command to make it push to talk."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
   ((null my-mic-p) <span class="org-comment-delimiter">;; </span><span class="org-comment">It's off, so turn it on</span>
    (<span class="org-keyword">when</span> (timerp my-push-to-talk-mute-timer)
      (cancel-timer my-push-to-talk-mute-timer))
    (my-mic-on)
    (<span class="org-keyword">when</span> obs-websocket-recording-p (my-obs-websocket-add-caption <span class="org-string">"[Microphone on]"</span>))
    (<span class="org-keyword">setq</span> my-push-to-talk-last-time (current-time)))
   ((timerp my-push-to-talk-mute-timer) <span class="org-comment-delimiter">;; </span><span class="org-comment">Push-to-talk mode</span>
    (cancel-timer my-push-to-talk-mute-timer)
    (<span class="org-keyword">setq</span> my-push-to-talk-mute-timer
          (run-at-time my-push-to-talk-threshold nil #'my-push-to-talk-mute)))
   <span class="org-comment-delimiter">;; </span><span class="org-comment">Might be push to talk, if we're within the key repeating time</span>
   ((&lt; (- (time-to-seconds (current-time)) (time-to-seconds my-push-to-talk-last-time))
       my-push-to-talk-threshold)
    (<span class="org-keyword">setq</span> my-push-to-talk-mute-timer
          (run-at-time my-push-to-talk-threshold nil #'my-push-to-talk-mute)))
   <span class="org-comment-delimiter">;; </span><span class="org-comment">It's been a while since I turned the mic on.</span>
   (t (my-push-to-talk-mute))))

<span class="org-comment-delimiter">;</span><span class="org-comment">(global-set-key (kbd "&lt;f12&gt;") #'my-push-to-talk)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-more-background-music" class="outline-3">
<h3 id="more-background-music">More background music</h3>
<div class="outline-text-3" id="text-more-background-music">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-emms-toggle-background</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">unless</span> (emms-playlist-buffer-list)
    (emms-play-directory <span class="org-string">"~/sync/Phone/music/freepd/"</span>))
  (emms-pause)
  (emms-show))
</pre>
</div>
</div>
</div>
<div id="outline-container-show-emacs-related-tasks" class="outline-3">
<h3 id="show-emacs-related-tasks">Show Emacs-related tasks</h3>
<div class="outline-text-3" id="text-show-emacs-related-tasks">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-show-emacs-tasks</span> ()
  (<span class="org-keyword">interactive</span>)
  (org-ql-search (org-agenda-files)
    '(and (todo)
          (parent (<span class="org-keyword">and</span> (tags <span class="org-string">"project"</span>) (tags <span class="org-string">"emacs"</span>) (not (tags <span class="org-string">"inactive"</span>)))))
    <span class="org-builtin">:title</span> <span class="org-string">"Emacs-related project tasks"</span>
    <span class="org-builtin">:sort</span> '(date priority todo)
    <span class="org-builtin">:super-groups</span> '((<span class="org-builtin">:auto-parent</span> t))))
</pre>
</div>
</div>
</div>
<div id="outline-container-general-streaming-configuration" class="outline-3">
<h3 id="general-streaming-configuration">General streaming configuration</h3>
<div class="outline-text-3" id="text-general-streaming-configuration">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-captions-insert</span> nil <span class="org-doc">"Non-nil means insert into the current buffer."</span>)
(<span class="org-keyword">defhydra</span> my-stream ()
  (<span class="org-string">"w"</span> (org-open-link-from-string <span class="org-string">"[[file:~/proj/stream/index.org::#streaming-workflow][Streaming]]"</span>) <span class="org-string">"Workflow"</span> <span class="org-builtin">:column</span> <span class="org-string">"Setup"</span>)
  <span class="org-comment-delimiter">;</span><span class="org-comment">("a" my-show-emacs-tasks "Agenda")</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">("t" my-stream-insert-timestamp "Timestamp" :exit t)</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">("bt" selectric-mode "Typing sounds")</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">("bm" my-stream-toggle-background-music "Background music")</span>
  (<span class="org-string">"y"</span> (browse-url <span class="org-string">"https://studio.youtube.com/channel/UClT2UAbC6j7TqOWurVhkuHQ/livestreaming/dashboard"</span>) <span class="org-string">"Youtube"</span>)
  (<span class="org-string">"ts"</span> (browse-url <span class="org-string">"https://twitch.tv/sachachua"</span>) <span class="org-string">"View stream"</span>)
  (<span class="org-string">"tv"</span> (browse-url <span class="org-string">"https://dashboard.twitch.tv/u/sachachua/stream-manager"</span>) <span class="org-string">"View manager"</span>)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">("s" my-stream-toggle</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">  (format "Streaming [%s]"</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">          (if (eq my-stream-type 'stream) "X" " "))</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">  :exit t</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">  :column "Streaming/recording")</span>
  (<span class="org-string">"r"</span> my-recording-toggle
    (format <span class="org-string">"Recording [%s]"</span>
            (<span class="org-keyword">if</span> (eq my-stream-type 'record) <span class="org-string">"X"</span> <span class="org-string">" "</span>))
    <span class="org-builtin">:exit</span> t)
  (<span class="org-string">"r"</span> (org-capture nil <span class="org-string">"y"</span>) <span class="org-string">"Capture"</span> <span class="org-builtin">:column</span> <span class="org-string">"During"</span>)
  (<span class="org-string">"o"</span> (org-open-link-from-string <span class="org-string">"[[file:~/proj/stream/index.org::#plans]]"</span>)
   <span class="org-string">"Notes"</span>
   <span class="org-builtin">:exit</span> t)
  (<span class="org-string">"m"</span> my-stream-message <span class="org-string">"Message"</span> <span class="org-builtin">:exit</span> t)
  (<span class="org-string">"p"</span> my-stream-publish-and-sync-notes <span class="org-string">"Publish"</span> <span class="org-builtin">:exit</span> t)
  (<span class="org-string">"v"</span> (my-play-latest-recording) <span class="org-string">"Play last"</span> <span class="org-builtin">:exit</span> t))
(keymap-global-set <span class="org-string">"&lt;f8&gt;"</span> #'my-stream/body)
(keymap-global-set <span class="org-string">"s-r"</span> #'my-stream/body)
(keymap-global-set <span class="org-string">"s-v"</span> #'my-stream/body)
(keymap-global-set <span class="org-string">"s-SPC"</span> #'my-stream/body)
</pre>
</div>
</div>
</div>
<div id="outline-container-org4f57e2c" class="outline-3">
<h3 id="org4f57e2c">Stream message</h3>
<div class="outline-text-3" id="text-org4f57e2c">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-message</span> (message)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MMessage: "</span>)
  (<span class="org-keyword">with-temp-file</span> <span class="org-string">"~/proj/stream/message.html"</span>
    (insert <span class="org-string">"&lt;style&gt;body { font-size: large; color: white; font-family: sans-serif; padding: 10px; background-color: black }&lt;/style&gt;"</span>
            message))
  (shell-command <span class="org-string">"scp ~/proj/stream/message.html web:/var/www/yayemacs.com"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-playing-recordings" class="outline-3">
<h3 id="playing-recordings">Playing recordings</h3>
<div class="outline-text-3" id="text-playing-recordings">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> mpv <span class="org-builtin">:if</span> my-laptop-p)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-recordings-dir</span> <span class="org-string">"~/recordings/"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-delete-latest-recording</span> ()
  (<span class="org-keyword">interactive</span>)
  (delete-file (my-latest-file my-recordings-dir)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-latest-recording</span> ()
  (<span class="org-keyword">interactive</span>)
  (find-file (my-latest-file my-recordings-dir)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-play-latest-recording</span> (<span class="org-type">&amp;optional</span> arg)
  (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
  (<span class="org-keyword">let</span> ((latest (my-latest-file my-recordings-dir)))
    (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> arg (file-exists-p (my-obs-websocket-caption-file latest)))
        (<span class="org-keyword">with-current-buffer</span> (find-file-noselect (my-obs-websocket-caption-file (my-latest-file my-recordings-dir)))
          (goto-char (point-min))
          (subed-mpv-find-video latest)
          (pop-to-buffer (current-buffer)))
      (mpv-play (my-latest-file my-recordings-dir)))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-rename-last-recording</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((latest (my-latest-file my-recordings-dir))
        (new-name (read-string <span class="org-string">"New name: "</span> (format-time-string <span class="org-string">"%Y-%m-%d-"</span>))))
    (rename-file latest
                 (expand-file-name
                  (concat new-name
                          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (file-name-extension latest) (null (file-name-extension new-name)))
                              (concat <span class="org-string">"."</span> (file-name-extension latest))
                            <span class="org-string">""</span>))
                  my-recordings-dir))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-upload-recording</span> (recording tags)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">let</span> ((latest (my-latest-file my-recordings-dir <span class="org-string">"mkv</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">mp4</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">webm"</span>)))
                       (read-file-name <span class="org-string">"Recording: "</span> my-recordings-dir latest t)
                       (read-string <span class="org-string">"Tags: "</span> <span class="org-string">"emacs"</span>))))
  (start-process <span class="org-string">"youtube-upload"</span> nil <span class="org-string">"youtube-upload"</span> recording <span class="org-string">"--privacy=unlisted"</span> <span class="org-string">"--license=creativeCommon"</span>
                 (format
                  <span class="org-string">"--tags=\"%s\""</span>
                  tags)
                 <span class="org-string">"--open-link"</span>
                 (format <span class="org-string">"--title=%s"</span> (shell-quote-argument (file-name-base recording)))
                 (format <span class="org-string">"--client-secrets=%s"</span> google-video-credentials)))
</pre>
</div>
</div>
</div>
<div id="outline-container-stream-notes" class="outline-3">
<h3 id="stream-notes">Stream notes</h3>
<div class="outline-text-3" id="text-stream-notes">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-save-and-tangle-stream-notes</span> ()
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (buffer-file-name)
             (string= (expand-file-name (buffer-file-name))
                      (expand-file-name <span class="org-string">"~/proj/stream/index.org"</span>)))
    (add-hook 'after-save-hook #'my-stream-publish-and-sync-notes nil t)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-publish-and-sync-notes</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (find-file <span class="org-string">"~/proj/stream/index.org"</span>)
    (org-html-export-to-html)
    (<span class="org-keyword">let</span> ((org-icalendar-timezone <span class="org-string">"America/Toronto"</span>)
          (org-icalendar-date-time-format <span class="org-string">":%Y%m%dT%H%M%SZ"</span>))
      (org-icalendar-export-to-ics))
    (shell-command <span class="org-string">"rsync -aze ssh ./ web:/var/www/yayemacs.com"</span>)))
(<span class="org-keyword">with-eval-after-load</span> 'org
  (add-hook 'org-mode-hook 'my-org-save-and-tangle-stream-notes))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">based on https://www.reddit.com/r/emacs/comments/57nps0/comment/d8umsr4/?context=3</span>
(<span class="org-keyword">setq</span> imp-default-user-filters '((org-mode . my-impatient-org-export-as-html-filter)
                                 (mhtml-mode . nil)
                                 (html-mode . nil)
                                 (web-mode  . nil)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-imp-htmlize-filter</span> (buffer)
  <span class="org-doc">"Alternate htmlization of BUFFER before sending to clients."</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">leave the result in the current-buffer</span>
  (<span class="org-keyword">let</span> ((noninteractive t)
        (org-export-use-babel nil)
        (m (<span class="org-keyword">with-current-buffer</span> buffer major-mode)))
    (case m
      (org-mode
       (insert
        (<span class="org-keyword">with-current-buffer</span> buffer
          (org-export-as 'html))))
      (t
       (<span class="org-keyword">let</span> ((html-buffer (<span class="org-keyword">save-match-data</span> (htmlize-buffer buffer))))
         (insert-buffer-substring html-buffer)
         (kill-buffer html-buffer))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-impatient-org-export-as-html-filter</span> (buffer)
  (<span class="org-keyword">let</span> ((output-buffer (current-buffer))
        (log-message-max nil))
    (<span class="org-keyword">with-current-buffer</span> buffer
      (<span class="org-keyword">let</span> ((output (org-export-as 'html)))
        (<span class="org-keyword">with-current-buffer</span> output-buffer (insert output))))))
(<span class="org-keyword">use-package</span> impatient-mode
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> impatient-mode-delay 1)
  (<span class="org-keyword">setq</span> httpd-port 8085)
  (imp-set-user-filter 'my/impatient-org-export-as-html-filter))
</pre>
</div>
</div>
</div>
<div id="outline-container-streaming-chapters" class="outline-3">
<h3 id="streaming-chapters">Chapters</h3>
<div class="outline-text-3" id="text-streaming-chapters">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-youtube-copy-chapters</span> ()
  <span class="org-doc">"Call from a VTT file with NOTE comments."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((subtitles (subed-subtitle-list)))
    (kill-new
     (concat (<span class="org-keyword">if</span> (elt (car subtitles) 4)
                 <span class="org-string">""</span>
               <span class="org-string">"0:00 Intro\n"</span>)
             (mapconcat (<span class="org-keyword">lambda</span> (o)
                          (<span class="org-keyword">if</span> (elt o 4)
                              (concat (format-seconds <span class="org-string">"%m:%.2s"</span> (/ (elt o 2) 1000))
                                      <span class="org-string">" "</span>
                                      (elt o 4)
                                      <span class="org-string">"\n"</span>)
                            <span class="org-string">""</span>))
                        subtitles
                        <span class="org-string">""</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-speech-to-text" class="outline-3">
<h3 id="speech-to-text">CANCELLED Try continuous streaming and the Google Speech Recognition API</h3>
<div class="outline-text-3" id="text-speech-to-text">
<p>
With data logging $0.004 USD / 15 seconds
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-captions-websocket</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-captions-history</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-captions-last-caption</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-insert</span> () (<span class="org-keyword">interactive</span>) (<span class="org-keyword">setq</span> my-stream-captions-insert (not my-stream-captions-insert)))

(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">my-stream-captions-minor-mode</span> <span class="org-doc">"Toggle the captions server."</span>
  <span class="org-builtin">:lighter</span> <span class="org-string">"CAP"</span>
  <span class="org-builtin">:global</span> t)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-last-n-chars</span> (text limit)
  (<span class="org-keyword">if</span> (&lt; (length text) limit)
      text
    (substring text (- (length text) limit))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-on-message</span> (websocket frame)
  (<span class="org-keyword">let*</span> ((payload (<span class="org-keyword">let</span> ((json-object-type 'plist) (json-array-type 'list)) (json-read-from-string (websocket-frame-payload frame))))
         (type (plist-get payload <span class="org-builtin">:type</span>))
         (caption (string-trim (plist-get (car (plist-get (car (plist-get (plist-get payload <span class="org-builtin">:stream</span>) <span class="org-builtin">:results</span>)) <span class="org-builtin">:alternatives</span>)) <span class="org-builtin">:transcript</span>))))

    (<span class="org-keyword">if</span> (string= type <span class="org-string">"interim"</span>)
        (<span class="org-keyword">when</span> (websocket-openp obs-websocket) (obs-websocket-send <span class="org-string">"SendCaptions"</span> <span class="org-builtin">:text</span> (my-get-last-n-chars caption 80)))
      (<span class="org-keyword">setq</span> my-stream-captions-last-caption caption)
      (call-process <span class="org-string">"notify-send"</span> nil nil nil caption)
      (my-obs-websocket-add-caption caption)
      (<span class="org-keyword">when</span> my-stream-captions-insert (insert caption))
      (<span class="org-keyword">setq</span> my-stream-captions-history (cons caption my-stream-captions-history)))))


(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-edit-last</span> (caption)
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Caption: "</span> my-stream-captions-last-caption 'my-stream-captions-history my-stream-captions-last-caption)))
  (<span class="org-keyword">when</span> (&gt; (length caption) 0)
    (my-obs-websocket-add-caption caption)))
(keymap-global-set  <span class="org-string">"&lt;f11&gt;"</span> 'my-stream-captions-edit-last)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-on-close</span> (<span class="org-type">&amp;rest</span> args)
  (message <span class="org-string">"Captions websocket closed."</span>)
  (my-stream-captions-minor-mode 0)
  (<span class="org-keyword">setq</span> my-stream-captions-websocket nil))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-websocket-connect</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> my-stream-captions-history nil)
  (my-stream-captions-minor-mode 1)
  (<span class="org-keyword">setq</span> my-stream-captions-websocket (websocket-open <span class="org-string">"ws://localhost:8085"</span>
                                                     <span class="org-builtin">:on-message</span> #'my-stream-captions-on-message
                                                     <span class="org-builtin">:on-close</span> #'my-stream-captions-on-close)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-stream-captions-process</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-start</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/proj/speech"</span>))
    (<span class="org-keyword">setq</span> my-stream-captions-process (start-process <span class="org-string">"Stream captions"</span> (get-buffer-create <span class="org-string">"*stream captions*"</span>) <span class="org-string">"node"</span> <span class="org-string">"test.js"</span>))
    (sleep-for 2)
    (my-stream-captions-websocket-connect)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-sentinel</span> (process event)
  (<span class="org-keyword">let</span> ((status (process-status my-stream-captions-process)))
    (<span class="org-keyword">if</span> (member status '(stop exit signal))
        (my-stream-captions-minor-mode -1))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-stream-captions-stop</span> ()
  (<span class="org-keyword">interactive</span>)
  (stop-process my-stream-captions-process))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-file-misc" class="outline-2">
<h2 id="file-misc">Miscellaneous</h2>
<div class="outline-text-2" id="text-file-misc">
</div>
<div id="outline-container-ledger-personal-finance-in-my-config" class="outline-3">
<h3 id="ledger-personal-finance-in-my-config">Ledger</h3>
<div class="outline-text-3" id="text-ledger-personal-finance-in-my-config">
<p>
Make it easier to review my credit card transactions
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> ledger-mode
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/ledger-mode"</span>
  <span class="org-builtin">:mode</span> <span class="org-string">"\\.ledger$"</span>
  <span class="org-builtin">:bind</span> (<span class="org-builtin">:map</span> ledger-mode-map
              (<span class="org-string">"C-c C-n"</span> . my-ledger-change-account)
              (<span class="org-string">"C-c a"</span> . my-ledger-set-unknown-account)
              (<span class="org-string">"C-c f"</span> . (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (find-file (my-latest-file <span class="org-string">"~/Downloads"</span>))))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> flycheck-ledger
  <span class="org-builtin">:after</span> (flycheck ledger-mode)
  <span class="org-builtin">:hook</span> (ledger-mode . flycheck-mode)
  <span class="org-builtin">:demand</span> t)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-ledger-account-list-cache</span> nil)
(make-variable-buffer-local 'my-ledger-account-list-cache)
(<span class="org-keyword">defadvice</span> <span class="org-function-name">ledger-accounts-list</span> (around sacha activate)
  <span class="org-doc">"Cache"</span>
  (<span class="org-keyword">setq</span> ad-return-value (<span class="org-keyword">or</span> my-ledger-account-list-cache
                            (<span class="org-keyword">setq</span> my-ledger-account-list-cache ad-do-it))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-ledger-set-unknown-account</span> (account point)
  (<span class="org-keyword">interactive</span> (list (ledger-read-account-with-prompt <span class="org-string">"Account"</span>) (point)))
  (<span class="org-keyword">let</span> ((extents (ledger-navigate-find-xact-extents point)))
    (<span class="org-keyword">save-excursion</span>
      (goto-char (car extents))
      (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"Expenses:</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">Unknown</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">Play</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> (cadr extents) t)
          (replace-match account t t)
        (goto-char point)
        (beginning-of-line)
        (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> \t]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">  "</span> (line-end-position) nil)
          (replace-match account t t nil 1))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-ledger-go-to-beginning-of-entry</span> ()
  <span class="org-doc">"Move to the beginning of the current entry."</span>
  (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (not (bobp))
              (eq (ledger-context-line-type (ledger-context-at-point))
                  'acct-transaction))
    (forward-line -1)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-ledger-entry-date</span> ()
  <span class="org-doc">"Returns the date of the entry containing point or nil."</span>
  (<span class="org-keyword">save-excursion</span>
    (my-ledger-go-to-beginning-of-entry)
    (<span class="org-keyword">let</span> ((context-info (ledger-context-other-line 0)))
      (<span class="org-keyword">when</span> (eq (ledger-context-line-type context-info) 'entry)
        (goto-char (line-beginning-position))
        (<span class="org-keyword">if</span> (looking-at <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[-0-9\\./]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
            (match-string-no-properties 1))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-ledger-guess-mbna</span> ()
  <span class="org-doc">"Adds a sub-account for the dates for my credit card transactions."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (my-ledger-go-to-beginning-of-entry)
    (forward-line 1)
    (<span class="org-keyword">let</span> ((amount 0) (date (my-ledger-entry-date)) month)
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"[0-9]+[-\\.]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[-\\.]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> date)
          (<span class="org-keyword">setq</span> month (string-to-number (match-string 1 date))))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Is this a payment or a charge?</span>
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (eq (ledger-context-line-type (ledger-context-at-point))
                        'acct-transaction)
                    (not (eobp)))
          (<span class="org-keyword">let</span> ((context (ledger-context-at-point)))
            (<span class="org-keyword">if</span> (ledger-context-field-value context 'amount)
                (<span class="org-keyword">if</span> (string-match <span class="org-string">"MBNA"</span> (ledger-context-field-value context 'account))
                    (<span class="org-keyword">setq</span> amount (string-to-number (ledger-context-field-value context 'amount)))
                  (<span class="org-keyword">setq</span> amount (- (string-to-number (ledger-context-field-value context 'amount)))))))
          (forward-line 1)))
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (eq (ledger-context-line-type (ledger-context-at-point))
                        'acct-transaction)
                    (not (eobp)))
          (<span class="org-keyword">let</span> ((context (ledger-context-at-point)))
            (<span class="org-keyword">if</span> (string-match <span class="org-string">"MBNA"</span> (ledger-context-field-value context 'account))
                (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">MBNA</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[ \t]*[-$</span><span class="org-string"><span class="org-warning">\</span></span><span class="org-string">.0-9]*[ \t]*$"</span> (line-end-position) t)
                    (replace-match
                     (concat <span class="org-string">"MBNA:"</span>
                             (elt
                              '(<span class="org-string">"January"</span> <span class="org-string">"February"</span> <span class="org-string">"March"</span> <span class="org-string">"April"</span> <span class="org-string">"May"</span> <span class="org-string">"June"</span> <span class="org-string">"July"</span> <span class="org-string">"August"</span> <span class="org-string">"September"</span> <span class="org-string">"October"</span> <span class="org-string">"November"</span> <span class="org-string">"December"</span>)
                              (% (+ (<span class="org-keyword">if</span> (&gt; amount 0) 10 11) month) 12)))
                     t t nil 1))))
          (forward-line 1))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-latest-file</span> (path <span class="org-type">&amp;optional</span> filter)
  <span class="org-doc">"Return the newest file in PATH. Optionally filter by FILTER."</span>
  (car (sort (seq-remove #'file-directory-p (directory-files path 'full filter t)) #'file-newer-than-file-p)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-ledger-change-account</span> (account)
  (<span class="org-keyword">interactive</span> (list (ledger-read-account-with-prompt (concat (ledger-xact-payee) <span class="org-string">": "</span>))))
  (beginning-of-line)
  (re-search-forward ledger-account-name-or-directive-regex)
  (replace-match (concat <span class="org-string">"  "</span> account <span class="org-string">"  "</span>) t t))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-ledger-fix-unknown</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"Expenses:Unknown.*$ </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
    (my-ledger-change-account (ledger-read-account-with-prompt
                               (format <span class="org-string">"%s %s: "</span> (s-trim (<span class="org-keyword">save-match-data</span> (ledger-xact-payee)))
                                       (match-string 1))))))

</pre>
</div>
</div>
</div>
<div id="outline-container-ssh-and-daemon" class="outline-3">
<h3 id="ssh-and-daemon">SSH and &#x2013;daemon</h3>
<div class="outline-text-3" id="text-ssh-and-daemon">
<p>
From <a href="https://github.com/nhoffman/.emacs.d/blob/master/init.org">https://github.com/nhoffman/.emacs.d/blob/master/init.org</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-ssh-refresh</span> ()
  <span class="org-doc">"Reset the environment variable SSH_AUTH_SOCK"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> (ssh-auth-sock-old (getenv <span class="org-string">"SSH_AUTH_SOCK"</span>))
    (setenv <span class="org-string">"SSH_AUTH_SOCK"</span>
            (car (split-string
                  (shell-command-to-string
                   <span class="org-string">"ls -t $(find /tmp/ssh-* -user $USER -name '</span><span class="org-string"><span class="org-constant">agent.*</span></span><span class="org-string">' 2&gt; /dev/null)"</span>))))
    (message
     (format <span class="org-string">"SSH_AUTH_SOCK %s --&gt; %s"</span>
             ssh-auth-sock-old (getenv <span class="org-string">"SSH_AUTH_SOCK"</span>)))))
(my-ssh-refresh)
</pre>
</div>
</div>
</div>
<div id="outline-container-encryption" class="outline-3">
<h3 id="encryption">Encryption</h3>
<div class="outline-text-3" id="text-encryption">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> epa-file-encrypt-to '(<span class="org-string">"sacha@sachachua.com"</span>))
(<span class="org-keyword">setq</span> epa-pinentry-mode 'loopback)
(<span class="org-keyword">setq</span> epg-pinentry-mode 'loopback)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-links" class="outline-2">
<h2 id="links">Other cool configs you may want to check out</h2>
<div class="outline-text-2" id="text-links">
<p>
<a id="org31b69ea"></a>
</p>

<ul class="org-ul">
<li><a href="http://doc.norang.ca/org-mode.html">Bernt Hansen</a>: Lots of Org-related config. I picked up the graph-drawing stuff from this.</li>
<li><a href="https://github.com/bzg/dotemacs">Bastien Guerry</a>: Org, Gnus, ERC - Explained in this <a href="http://sachachua.com/blog/2013/05/emacs-chat-bastien-guerry/">Emacs Chat (~1h)</a></li>
<li><a href="https://github.com/iani/emacs-prelude">Iannis Zannos</a>: Explained in this <a href="https://www.youtube.com/watch?v=0F8aCbC9z3A">Emacs Chat (~1h)</a></li>
<li><a href="https://github.com/magnars/.emacs.d">Magnar Sveen</a>: <a href="http://whattheemacsd.com/">http://whattheemacsd.com/</a> has some explanations. <a href="http://sachachua.com/blog/2013/11/emacs-chat-magnar-sveen-emacs-rocks/">Emacs Chat (~1h)</a></li>
<li><a href="https://github.com/jwiegley/dot-emacs">John Wiegley</a>: Also see his <a href="http://www.youtube.com/watch?v=RvPFZL6NJNQ">Emacs Lisp Development talk</a> (sorry, sucky video) and <a href="http://www.youtube.com/watch?v=ytNsHmRLZGM">Emacs Chat video</a></li>
</ul>
</div>
</div>
<div id="outline-container-inactive-infrequent-things" class="outline-2">
<h2 id="inactive-infrequent-things">Inactive/infrequent things</h2>
<div class="outline-text-2" id="text-inactive-infrequent-things">
</div>
<div id="outline-container-exwm" class="outline-3">
<h3 id="exwm">Exwm</h3>
<div class="outline-text-3" id="text-exwm">
<p>
Hmmm, I'm having a hard time getting used to this.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> exwm
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">require</span> '<span class="org-constant">exwm-config</span>)
    (exwm-config-default)
    (exwm-enable)
    (exwm-input-set-key (kbd <span class="org-string">"s-p"</span>) 'fhd/toggle-exwm-input-line-mode-passthrough)
    (exwm-input-set-key (kbd <span class="org-string">"s-i"</span>) #'fhd/exwm-input-toggle-mode)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">https://emacs.stackexchange.com/questions/33326/how-do-i-cut-and-paste-effectively-between-applications-while-using-exwm</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/exwm-input-line-mode</span> ()
  <span class="org-doc">"Set exwm window to line-mode and show mode line"</span>
  (call-interactively #'exwm-input-grab-keyboard)
  (exwm-layout-show-mode-line))

(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/exwm-input-char-mode</span> ()
  <span class="org-doc">"Set exwm window to char-mode and hide mode line"</span>
  (call-interactively #'exwm-input-release-keyboard)
  (exwm-layout-hide-mode-line))

(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/exwm-input-toggle-mode</span> ()
  <span class="org-doc">"Toggle between line- and char-mode"</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (window-buffer)
    (<span class="org-keyword">when</span> (eq major-mode 'exwm-mode)
      (<span class="org-keyword">if</span> (equal (second (second mode-line-process)) <span class="org-string">"line"</span>)
          (fhd/exwm-input-char-mode)
        (fhd/exwm-input-line-mode)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">fhd/toggle-exwm-input-line-mode-passthrough</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> exwm-input-line-mode-passthrough
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">setq</span> exwm-input-line-mode-passthrough nil)
        (message <span class="org-string">"App receives all the keys now (with some simulation)"</span>))
    (<span class="org-keyword">progn</span>
      (<span class="org-keyword">setq</span> exwm-input-line-mode-passthrough t)
      (message <span class="org-string">"emacs receives all the keys now"</span>)))
  (force-mode-line-update))
</pre>
</div>
</div>
</div>
<div id="outline-container-emacspeak" class="outline-3">
<h3 id="emacspeak">Emacspeak</h3>
<div class="outline-text-3" id="text-emacspeak">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;</span><span class="org-comment">(setq emacspeak-prefix "\C-E")</span>
  (<span class="org-keyword">defun</span> <span class="org-function-name">my-emacspeak</span> ()
    (<span class="org-keyword">interactive</span>)
    (load-file <span class="org-string">"/home/sacha/vendor/emacspeak/lisp/emacspeak-setup.el"</span>)
    (keymap-global-set <span class="org-string">"s-e"</span> 'emacspeak-prefix-command)
    (keymap-global-set <span class="org-string">"C-e"</span> 'end-of-line)
    (<span class="org-keyword">setq</span> emacspeak-use-auditory-icons t)
    (<span class="org-keyword">setq-default</span> emacspeak-use-auditory-icons t)
    (<span class="org-keyword">setq-default</span> dtk-quiet nil)
    (<span class="org-keyword">setq</span> dtk-quiet nil))

  (<span class="org-keyword">defun</span> <span class="org-function-name">my-emacspeak-quiet</span> ()
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">setq</span> emacspeak-use-auditory-icons nil)
    (<span class="org-keyword">setq-default</span> emacspeak-use-auditory-icons nil)
    (<span class="org-keyword">setq-default</span> dtk-quiet t)
    (<span class="org-keyword">setq</span> dtk-quiet t)
    (dtk-interp-sync)
    (ad-disable-regexp <span class="org-string">"emacspeak"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-manage-photos-with-geeqie" class="outline-3">
<h3 id="manage-photos-with-geeqie">TOBLOG Manage photos with geeqie</h3>
<div class="outline-text-3" id="text-manage-photos-with-geeqie">
<p>
Opening images directly in Emacs seems a little slow. Geeqie is pretty
fast (after generating thumbnails) and can be remotely controlled via
the command-line. I wrote a few functions to help me flip through
images, add extra stuff to filenames, change dates, and insert
references.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-scan-directory</span> <span class="org-string">"~/sync/scans/"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-ipad-directory</span> <span class="org-string">"~/sync/ipad"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-portfolio-directory</span> <span class="org-string">"~/sync/portfolio"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-camera-directory</span> <span class="org-string">"~/sync/camera"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-private-sketches-directory</span> <span class="org-string">"~/sync/private-sketches"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-sketches-directory</span> <span class="org-string">"~/sync/sketches"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-scans-dired</span> () (<span class="org-keyword">interactive</span>) (dired my-scan-directory <span class="org-string">"-lt"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-next</span> ()
  (<span class="org-keyword">interactive</span>)
  (shell-command <span class="org-string">"geeqie --remote -n"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-previous</span> ()
  (<span class="org-keyword">interactive</span>)
  (shell-command <span class="org-string">"geeqie --remote -b"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-filename</span> ()
  (string-trim (shell-command-to-string <span class="org-string">"geeqie --remote --tell"</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-insert-file-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (insert (org-link-make-string (concat <span class="org-string">"file:"</span> (string-trim (shell-command-to-string <span class="org-string">"geeqie --remote --tell"</span>))))))
(<span class="org-keyword">use-package</span> org <span class="org-builtin">:config</span> (<span class="org-keyword">require</span> '<span class="org-constant">org-attach</span>))


(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-view</span> (filenames)
  (<span class="org-keyword">interactive</span> <span class="org-string">"f"</span>)
  (start-process-shell-command <span class="org-string">"geeqie"</span> nil
                               (concat <span class="org-string">"geeqie --remote "</span>
                                       (mapconcat (<span class="org-keyword">lambda</span> (f)
                                                    (concat <span class="org-string">"file:"</span> (shell-quote-argument f)))
                                                  (<span class="org-keyword">cond</span>
                                                   ((listp filenames) filenames)
                                                   ((file-directory-p filenames)
                                                    (list (car (seq-filter #'file-regular-p (directory-files filenames t)))))
                                                   (t (list filenames)))
                                                  <span class="org-string">" "</span>))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-rotate-jpeg-using-exiftran</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-rotate-image-clockwise</span> (filename)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> my-rotate-jpeg-using-exiftran
           (string-match <span class="org-string">"jpe?g"</span> (file-name-extension filename)))
      (call-process <span class="org-string">"exiftran"</span> nil nil nil <span class="org-string">"-i"</span> <span class="org-string">"-9"</span> filename)
    (call-process <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-rotate"</span> <span class="org-string">"90"</span> filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-rotate-image-counterclockwise</span> (filename)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> my-rotate-jpeg-using-exiftran
           (string-match <span class="org-string">"jpe?g"</span> (file-name-extension filename)))
      (call-process <span class="org-string">"exiftran"</span> nil nil nil <span class="org-string">"-i"</span> <span class="org-string">"-2"</span> filename)
    (call-process <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-rotate"</span> <span class="org-string">"270"</span> filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-rotate-clockwise</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-rotate-image-clockwise (my-geeqie-filename))
  (my-geeqie-view (my-geeqie-filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-rotate-counterclockwise</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-rotate-image-counterclockwise (my-geeqie-filename))
  (my-geeqie-view (my-geeqie-filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-rename-file-based-on-modification-time</span> (filename)
  <span class="org-doc">"Rename files to their modification time."</span>
  (rename-file filename
               (expand-file-name
                (concat
                 (format-time-string <span class="org-string">"%Y-%m-%d_%H%M%S"</span>
                                     (file-attribute-modification-time (file-attributes filename)))
                 <span class="org-string">"."</span>
                 (file-name-extension filename))
                (file-name-directory filename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-change-date</span> (filename new-time)
  (<span class="org-keyword">interactive</span> (list (my-geeqie-filename)
                     (<span class="org-keyword">let</span> ((org-read-date-prefer-future nil))
                       (org-read-date nil t))))
  (<span class="org-keyword">let</span> ((new-file (expand-file-name
                   (replace-regexp-in-string
                    <span class="org-string">"^[0-9]*"</span>
                    (format-time-string
                     <span class="org-string">"%Y%m%d"</span>
                     new-time)
                    (file-name-nondirectory filename))
                   (file-name-directory filename))))
    (rename-file filename new-file)
    (my-geeqie-view new-file)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-rename-current</span> (old-filename new-filename)
  (<span class="org-keyword">interactive</span>
   (list (my-geeqie-filename)
         (read-string <span class="org-string">"Filename: "</span> (concat (file-name-base (my-geeqie-filename)) <span class="org-string">" "</span>))))
  (rename-file old-filename
               (expand-file-name
                (concat new-filename <span class="org-string">"."</span> (file-name-extension old-filename))
                (file-name-directory old-filename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-crop-to-rectangle</span> ()
  (<span class="org-keyword">interactive</span>)
  (call-process
   <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-crop"</span>
   (string-trim (shell-command-to-string <span class="org-string">"geeqie --remote --get-rectangle"</span>))
   (my-geeqie-filename))
  (my-geeqie-view (my-geeqie-filename)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-scans</span> ()
  <span class="org-doc">"Rename files and open the first one."</span>
  (<span class="org-keyword">interactive</span>)
  (mapc 'my-rename-file-based-on-modification-time (directory-files my-scan-directory t <span class="org-string">"^scan"</span>))
  (call-process <span class="org-string">"geeqie"</span> nil nil nil <span class="org-string">"--remote"</span> (concat <span class="org-string">"file:"</span> (shell-quote-argument (seq-find 'file-regular-p (directory-files <span class="org-string">"~/sync/scans"</span> t <span class="org-string">"^[0-9].*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">gif</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-delete-and-next</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((file (my-geeqie-filename)))
    (my-geeqie-next)
    (delete-file file t)))

(<span class="org-keyword">use-package</span> ewmctrl)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-geeqie-setup</span> ()
  (<span class="org-keyword">interactive</span>)
  (shell-command <span class="org-string">"wmctrl -r :ACTIVE: -b remove,maximized_vert,maximized_horz; xdotool getactivewindow windowsize 50% 100%"</span>)
  (shell-command <span class="org-string">"geeqie &amp;"</span>))
(<span class="org-keyword">use-package</span> pretty-hydra
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">pretty-hydra-define</span> my-geeqie ()
    (<span class="org-string">"Open"</span>
     ((<span class="org-string">"oo"</span> my-geeqie-setup <span class="org-string">"Setup"</span>)
      (<span class="org-string">"op"</span> (my-geeqie-view my-portfolio-directory) <span class="org-string">"Portfolio"</span>)
      (<span class="org-string">"oc"</span> (my-geeqie-view my-camera-directory) <span class="org-string">"Camera"</span>)
      (<span class="org-string">"oi"</span> (my-geeqie-view my-ipad-directory) <span class="org-string">"iPad"</span>)
      (<span class="org-string">"ox"</span> (my-geeqie-view <span class="org-string">"~/screenshots"</span>) <span class="org-string">"Screenshots"</span>)
      (<span class="org-string">"os"</span> my-geeqie-scans <span class="org-string">"Scans"</span>))
     <span class="org-string">"Modify"</span>
     ((<span class="org-string">"["</span> my-geeqie-rotate-counterclockwise <span class="org-string">"CCW"</span>)
      (<span class="org-string">"]"</span> my-geeqie-rotate-clockwise <span class="org-string">"CW"</span>)
      (<span class="org-string">"r"</span> my-geeqie-rename-current <span class="org-string">"Rename"</span>)
      (<span class="org-string">"d"</span> my-geeqie-change-date <span class="org-string">"Change date"</span>)
      (<span class="org-string">"c"</span> my-geeqie-crop-to-rectangle <span class="org-string">"Crop"</span>)
      (<span class="org-string">"k"</span> (start-process <span class="org-string">"krita"</span> nil <span class="org-string">"krita"</span> (my-geeqie-filename)) <span class="org-string">"krita"</span>)
      (<span class="org-string">"O"</span> (shell-command (format <span class="org-string">"mogrify -auto-orient %s"</span> (shell-quote-argument (my-geeqie-filename)))) <span class="org-string">"Rotate based on EXIF"</span>)
      (<span class="org-string">"g"</span> (start-process <span class="org-string">"gimp"</span> nil <span class="org-string">"gimp"</span> (my-geeqie-filename)) <span class="org-string">"gimp"</span>))
     <span class="org-string">"Navigate"</span>
     ((<span class="org-string">"n"</span> my-geeqie-next <span class="org-string">"Next"</span>)
      (<span class="org-string">"p"</span> my-geeqie-previous <span class="org-string">"Previous"</span>)
      (<span class="org-string">"x"</span> my-geeqie-delete-and-next <span class="org-string">"Delete"</span>))
     <span class="org-string">"Save"</span>
     ((<span class="org-string">"p"</span> (rename-file (my-geeqie-filename)
                        (expand-file-name (file-name-nondirectory (my-geeqie-filename)) my-sketches-directory))
       <span class="org-string">"Portfolio"</span>)
      (<span class="org-string">"s"</span> (rename-file (my-geeqie-filename)
                        (expand-file-name (file-name-nondirectory (my-geeqie-filename)) my-sketches-directory))
       <span class="org-string">"Sketch"</span>))
     <span class="org-string">"Other"</span>
     ((<span class="org-string">"&lt;up&gt;"</span> (forward-line -1) <span class="org-builtin">:hint</span> nil)
      (<span class="org-string">"&lt;down&gt;"</span> forward-line <span class="org-builtin">:hint</span> nil)

      (<span class="org-string">"im"</span> (insert (format <span class="org-string">"{{&lt;photo nas=\"1\" src=\"%s\"&gt;}}"</span> (my-geeqie-filename))))
      (<span class="org-string">"if"</span> (insert (my-geeqie-filename) <span class="org-string">"\n"</span>)
       <span class="org-string">"Insert filename"</span>)
      (<span class="org-string">"v"</span> (my-geeqie-view (string-trim (thing-at-point 'line))) <span class="org-string">"View"</span>)
      (<span class="org-string">"il"</span> (insert <span class="org-string">"- "</span> (my-geeqie-filename) <span class="org-string">"\n"</span>) <span class="org-string">"Insert filename as list item"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-move-portfolio-files</span> ()
  (<span class="org-keyword">interactive</span>)
  (mapc (<span class="org-keyword">lambda</span> (f)
          (<span class="org-keyword">let</span> ((new-dir
                 (<span class="org-keyword">cond</span>
                  ((string-match <span class="org-string">"#private"</span> f) my-private-sketches-directory)
                  ((string-match <span class="org-string">"#me\\&gt;"</span> f) my-sketches-directory)
                  (t my-portfolio-directory))))
            (<span class="org-keyword">when</span> new-dir (rename-file f (expand-file-name (file-name-nondirectory f) new-dir)))))
        (seq-filter
         'file-regular-p
         (directory-files my-scan-directory t <span class="org-string">"^[0-9]+.*#"</span>)))
  (shell-command-to-string <span class="org-string">"make-sketch-thumbnails"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-plover" class="outline-3">
<h3 id="plover">Plover</h3>
<div class="outline-text-3" id="text-plover">
<p>
<a href="https://github.com/sachac/plover-websocket-el">https://github.com/sachac/plover-websocket-el</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> plover-websocket
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/proj/plover-websocket-el"</span>
  <span class="org-builtin">:after</span> websocket
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq</span> plover-websocket-plover-command <span class="org-string">"cd ~/vendor/plover; tox -e launch"</span>)
  <span class="org-builtin">:hydra</span>
  (my-plover (<span class="org-builtin">:exit</span> t)
             (<span class="org-string">"&lt;f1&gt;"</span> plover-websocket-connect <span class="org-string">"Open websocket"</span>)
             (<span class="org-string">"&lt;f2&gt;"</span> plover-websocket-add-translation <span class="org-string">"Add translation"</span>)
             (<span class="org-string">"&lt;f3&gt;"</span> plover-websocket-lookup <span class="org-string">"Lookup"</span>)
             (<span class="org-string">"&lt;f4&gt;"</span> plover-websocket-configure <span class="org-string">"Configure"</span>)
             (<span class="org-string">"&lt;f5&gt;"</span> plover-websocket-focus <span class="org-string">"Focus"</span>)
             (<span class="org-string">"&lt;f6&gt;"</span> plover-websocket-toggle-plover <span class="org-string">"Toggle Plover"</span>)
             (<span class="org-string">"&lt;f7&gt;"</span> plover-websocket-quit <span class="org-string">"Quit"</span>)
             (<span class="org-string">"&lt;f8&gt;"</span> my-plover-drilling-time <span class="org-string">"Drill"</span>))
  <span class="org-builtin">:bind</span>
  (<span class="org-string">"&lt;f6&gt;"</span> . #'my-plover/body))

</pre>
</div>
</div>
<div id="outline-container-looking-things-up" class="outline-4">
<h4 id="looking-things-up">Looking things up</h4>
<div class="outline-text-4" id="text-looking-things-up">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-search-dictionary-for-strokes-jq</span> (stroke-regexp)
  (json-parse-string
   (shell-command-to-string
    (format <span class="org-string">"cat ~/.config/plover/main.json | jq 'with_entries(if (.key|test(\"%s\")) then ( {key: .key, value: .value}) else empty end)'"</span>
      stroke-regexp))
   <span class="org-builtin">:object-type</span> 'alist))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-main-dict</span>
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> my-laptop-p (file-exists-p <span class="org-string">"~/.config/plover/main.json"</span>))
(mapcar (<span class="org-keyword">lambda</span> (o) (cons (symbol-name (car o)) (cdr o)))
  (json-read-file <span class="org-string">"~/.config/plover/main.json"</span>))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-search-dictionary-for-strokes</span> (stroke-regexp)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MStroke regexp: "</span>)
  (<span class="org-keyword">let</span> ((results (seq-filter (<span class="org-keyword">lambda</span> (o) (string-match stroke-regexp (car o))) my-plover-main-dict)))
    (<span class="org-keyword">when</span> (called-interactively-p 'any) (my-plover-display-dictionary-results results))
    results))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-dict-cache</span> nil <span class="org-doc">"Alist of (filename . ((stroke . translation) ...))"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-home</span> <span class="org-string">"~/.config/plover"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-dict</span> (<span class="org-type">&amp;optional</span> filename)
  (<span class="org-keyword">setq</span> filename (expand-file-name (<span class="org-keyword">or</span> filename <span class="org-string">"main.json"</span>) my-plover-home))
  (<span class="org-keyword">or</span> (cdr (assoc-default filename my-plover-dict-cache))
(<span class="org-keyword">let</span> ((result (mapcar (<span class="org-keyword">lambda</span> (o) (cons (symbol-name (car o)) (cdr o))) (json-read-file filename))))
  (<span class="org-keyword">push</span> (cons filename result) my-plover-dict-cache )
  result)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-search-dictionary-for-translation</span> (translation <span class="org-type">&amp;optional</span> start file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTranslation: \nP"</span>)
  (<span class="org-keyword">let*</span> ((regexp (concat <span class="org-string">"^"</span> (regexp-quote translation) (<span class="org-keyword">unless</span> start <span class="org-string">"$"</span>)))
   (results (seq-filter (<span class="org-keyword">lambda</span> (o) (string-match regexp (cdr o))) (my-plover-dict file))))
    (<span class="org-keyword">when</span> (called-interactively-p 'any) (my-plover-display-dictionary-results results))
    results))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-display-dictionary-results</span> (results)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Plover*"</span>)
    (erase-buffer)
    (insert (format <span class="org-string">"%d entries\n"</span> (length results))
      (mapconcat (<span class="org-keyword">lambda</span> (o) (format <span class="org-string">"%s\t%s"</span> (car o) (cdr o))) results <span class="org-string">"\n"</span>))
    (goto-char (point-min))
    (display-buffer (current-buffer))))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-with-plover-fingerspelling</span> (<span class="org-type">&amp;rest</span> body)
  `(<span class="org-keyword">progn</span>
     (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{PLOVER:SOLO_DICT:+commands.json,+fingerspelling.json}"</span>)
     (<span class="org-keyword">prog1</span> (<span class="org-keyword">progn</span> ,@body)
 (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{PLOVER:END_SOLO_DICT}"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-consult-plover-read-stroke-or-translation</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((dict (mapcar (<span class="org-keyword">lambda</span> (o) (cons (format <span class="org-string">"%s: %s"</span> (car o) (cdr o)) o))
    (my-plover-dict))))
    (my-with-plover-fingerspelling
     (consult--read
dict
<span class="org-builtin">:prompt</span> <span class="org-string">"Strokes/translation: "</span>
<span class="org-builtin">:category</span> 'plover-stroke))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-consult-plover-and-execute-strokes</span> (choice)
  (<span class="org-keyword">interactive</span> (list (my-consult-plover-read-stroke-or-translation)))
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> choice)
    (plover-websocket-send <span class="org-builtin">:translation</span> (match-string 2 choice) <span class="org-builtin">:force</span> t <span class="org-builtin">:zero_last_stroke_length</span> t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-consult-plover-search-strokes</span> (regexp solo-p)
  (<span class="org-keyword">interactive</span> (list (with-plover-plain (read-string <span class="org-string">"Strokes: "</span>)) current-prefix-arg))
  (consult--read
   (mapcar (<span class="org-keyword">lambda</span> (o) (cons (format <span class="org-string">"%s: %s"</span> (car o) (cdr o)) o))
     (my-plover-search-dictionary-for-strokes (<span class="org-keyword">if</span> solo-p (concat <span class="org-string">"^"</span> regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(?:</span></span><span class="org-string">/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">$</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> ) (concat <span class="org-string">"^"</span> regexp))))
   <span class="org-builtin">:prompt</span> <span class="org-string">"Narrow: "</span>))



<span class="org-comment-delimiter">;; </span><span class="org-comment">(list</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">(benchmark-run 2 (my-plover-search-dictionary-for-strokes-jq "^THER"))</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">(benchmark-run 2 (my-plover-search-dictionary-for-translation "stenography" t "typey-type.json")</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">(benchmark-run 2 (my-plover-search-dictionary-for-translation "stenography" t))</span>
<span class="org-comment-delimiter">;;  </span><span class="org-comment">(benchmark-run 2 (my-plover-search-dictionary-for-strokes "^THER/")))</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-adding-steno-hints-as-i-type" class="outline-4">
<h4 id="adding-steno-hints-as-i-type">Adding steno hints as I type&#xa0;&#xa0;&#xa0;<span class="tag"><span class="steno">steno</span>&#xa0;<span class="emacs">emacs</span></span></h4>
<div class="outline-text-4" id="text-adding-steno-hints-as-i-type">
<p>
When I type with steno, I want to see little hints. I borrowed some
code from company-posframe to display hints based on the last few
words, even ones I ended up fingerspelling or typing on my keyboard.
This makes it easier to learn new words if I have to spell them out.
There's probably a better way to do it, but this is a good start.
</p>


<figure id="org09a1082">
<img src="images/steno.png" alt="steno.png">

<figcaption><span class="figure-number">Figure 13: </span>This is how the hint appears</figcaption>
</figure>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-steno-hint-dict</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-steno-hint-dictionaries</span>
  '(<span class="org-string">"~/.config/plover/user.json"</span>
    <span class="org-string">"~/vendor/steno-dictionaries/dictionaries/dict.json"</span>))
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-steno-hint-buffer</span> <span class="org-string">" *steno hint*"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-load-dictionary</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> my-steno-hint-dict
        (seq-mapcat
         (<span class="org-keyword">lambda</span> (filename)
           (<span class="org-keyword">with-temp-buffer</span>
             (insert-file-contents filename)
             (goto-char (point-min))
             (json-parse-buffer <span class="org-builtin">:object-type</span> 'alist)))
         my-steno-hint-dictionaries)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-lookup</span> (search)
  (<span class="org-keyword">let</span> ((search-list (list search (downcase search))))
    (seq-group-by
     'cdr
     (seq-filter
      (<span class="org-keyword">lambda</span> (entry)
        (member (cdr entry) search-list))
      my-steno-hint-dict))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-find</span> (<span class="org-type">&amp;optional</span> buffer)
  <span class="org-doc">"Return a steno hint for the last 1-4 words, if any."</span>
  (<span class="org-keyword">setq</span> buffer (<span class="org-keyword">or</span> buffer (current-buffer)))
  (<span class="org-keyword">when</span> (buffer-live-p buffer)
    (<span class="org-keyword">with-current-buffer</span> buffer
      (<span class="org-keyword">let</span> ((pos (point)) result hint)
        (<span class="org-keyword">save-excursion</span>
          (<span class="org-keyword">dotimes</span> (i 4)
            (backward-word)
            (<span class="org-keyword">setq</span> result
                  (cons
                   (my-steno-hint-lookup
                    (string-trim (buffer-substring-no-properties (point) pos)))
                   result)))
          (delq nil result))))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-steno-hint-display-functions</span> '(my-steno-hint-show-posframe))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-show-posframe</span> (result <span class="org-type">&amp;optional</span> command)
  (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> result (<span class="org-keyword">or</span> (null command)
                      (member command '(self-insert-command org-self-insert-command))))
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">with-current-buffer</span> (get-buffer-create my-steno-hint-buffer)
          (erase-buffer)
          (insert
           (propertize
            (mapconcat
             (<span class="org-keyword">lambda</span> (entries)
               (mapconcat
                (<span class="org-keyword">lambda</span> (entry)
                  (concat
                   (car entry) <span class="org-string">": "</span>
                   (mapconcat (<span class="org-keyword">lambda</span> (stroke)
                                (symbol-name (car stroke)))
                              (cdr entry) <span class="org-string">", "</span>)))
                entries <span class="org-string">"\n"</span>))
             result <span class="org-string">"\n"</span>)
            'face 'lispy-face-hint)
           <span class="org-string">"\n"</span>
           (mapconcat 'my-steno-hint-propertized-layout
                       (split-string (symbol-name (car (cadar (car result)))) <span class="org-string">"/"</span>)
                       <span class="org-string">"\n\n"</span>)))
        (posframe-show my-steno-hint-buffer <span class="org-builtin">:position</span> (point) <span class="org-builtin">:border-width</span> 1))
    (posframe-hide my-steno-hint-buffer)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-steno-hint--timer</span> nil)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-recent-when-idle</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (timerp my-steno-hint--timer)
    (cancel-timer my-steno-hint--timer))
  (<span class="org-keyword">setq</span> my-steno-hint--timer
        (run-with-idle-timer 0.1 nil #'my-steno-hint-recent (current-buffer) this-command)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-recent</span> (buffer command)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">setq</span> my-steno-hint--timer nil)
  (run-hook-with-args 'my-steno-hint-display-functions (my-steno-hint-find buffer) command))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-split-keys</span> (s)
  <span class="org-doc">"Return a list of individual steno keys for RTFCRE."</span>
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[STKPWHR]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">-</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[AOEU*]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[FRPBLGTSDZ]*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> s)
    (append
     (mapcar (<span class="org-keyword">lambda</span> (ch) (format <span class="org-string">"%s-"</span> (char-to-string ch))) (match-string 1 s))
     (mapcar 'char-to-string (match-string 3 s))
     (mapcar (<span class="org-keyword">lambda</span> (ch) (format <span class="org-string">"-%s"</span> (char-to-string ch))) (match-string 4 s)))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">(my-steno-split-keys "HR-")</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">(my-steno-split-keys "HRAEUT")</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">(my-steno-split-keys "HR*T")</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-propertized-layout</span> (s)
  (<span class="org-keyword">let</span> ((keys (my-steno-split-keys s))
        (steno-layout <span class="org-string">"STPH*FPLTD\nSKWR*RBGSZ\n  AO EU"</span>)
        after-mid)
    (mapconcat
     (<span class="org-keyword">lambda</span> (ch)
       (<span class="org-keyword">setq</span> ch (char-to-string ch))
       (<span class="org-keyword">pcase</span> ch
         (<span class="org-string">"\n"</span> (<span class="org-keyword">setq</span> after-mid nil) <span class="org-string">"\n"</span>)
         (<span class="org-string">" "</span> <span class="org-string">"  "</span>)
         (_
          (<span class="org-keyword">let</span> (found)
            (<span class="org-keyword">if</span> (string-match <span class="org-string">"[AEOU*]"</span> ch)
                (<span class="org-keyword">setq</span> after-mid t
                      found (member ch keys))
              (<span class="org-keyword">setq</span> found
                    (member
                     (<span class="org-keyword">if</span> after-mid (concat <span class="org-string">"-"</span> ch)
                       (concat ch <span class="org-string">"-"</span>))
                     keys)))
            (<span class="org-keyword">if</span> found
              (concat (propertize ch 'face '(<span class="org-builtin">:inverse-video</span> t)) <span class="org-string">" "</span>)
              (concat ch <span class="org-string">" "</span>))))))
     steno-layout
     <span class="org-string">""</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-hint-window-change</span> ()
  (<span class="org-keyword">when</span> (posframe-workable-p)
    (<span class="org-keyword">unless</span> (string= (buffer-name)
                     my-steno-hint-buffer)
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> my-steno-hint-buffer
                 (get-buffer my-steno-hint-buffer))
        (posframe-hide my-steno-hint-buffer)))))

(<span class="org-keyword">define-minor-mode</span> <span class="org-function-name">my-steno-hint-minor-mode</span>
  <span class="org-doc">"Show hints for recent words."</span>
  <span class="org-builtin">:init-value</span> nil
  <span class="org-builtin">:lighter</span> <span class="org-string">"Hint"</span>
  (<span class="org-keyword">if</span> my-steno-hint-minor-mode
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">unless</span> my-steno-hint-dict (my-steno-hint-load-dictionary))
        (add-hook 'post-command-hook #'my-steno-hint-recent-when-idle nil t)
        (add-hook 'window-configuration-change-hook #'my-steno-hint-window-change))

    (remove-hook 'post-command-hook #'my-steno-hint-recent-when-idle t)
    (remove-hook 'window-configuration-change-hook #'my-steno-hint-window-change)
    (<span class="org-keyword">when</span> (timerp my-steno-hint--timer)
      (cancel-timer my-steno-hint--timer))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> my-steno-hint-buffer
               (get-buffer my-steno-hint-buffer))
      (posframe-delete my-steno-hint-buffer))))
</pre>
</div>
</div>
</div>
<div id="outline-container-running-plover-drills-from-emacs" class="outline-4">
<h4 id="running-plover-drills-from-emacs">Running Plover drills from Emacs</h4>
<div class="outline-text-4" id="text-running-plover-drills-from-emacs">
<p>
I'm learning stenography because I deal with a lot of text, and it
seems interesting. I'd like to someday be able to live-caption
EmacsConf, meetups, and other technical things. I've got a lot of
muscle memory to pick up, which means drills drills drills drills.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-drills</span>
  (append
   (mapcar (<span class="org-keyword">lambda</span> (desc)
             (cons desc (concat <span class="org-string">"https://joshuagrams.github.io/steno-jig/learn-keyboard.html?drill="</span> (url-encode-url (replace-regexp-in-string <span class="org-string">"\\+"</span> <span class="org-string">"%2B"</span> desc)))))
           '(<span class="org-string">"Left hand, bottom row"</span>
             <span class="org-string">"Right hand, bottom row"</span>
             <span class="org-string">"Left hand, top row"</span>
             <span class="org-string">"Right hand, top row"</span>
             <span class="org-string">"Right hand, full bottom row"</span>
             <span class="org-string">"Right hand, full top row"</span>
             <span class="org-string">"Vowels"</span>
             <span class="org-string">"Left hand"</span>
             <span class="org-string">"Right hand"</span>
             <span class="org-string">"All keys"</span>
             <span class="org-string">"Left + Right"</span>
             <span class="org-string">"Left + Vowel"</span>
             <span class="org-string">"Vowel + Right"</span>
             <span class="org-string">"Left + Vowel + Right"</span>
             <span class="org-string">"Columns: D, B, L, -N"</span>
             <span class="org-string">"x"</span>))
   (mapcar (<span class="org-keyword">lambda</span> (desc)
             (cons desc (concat <span class="org-string">"https://joshuagrams.github.io/steno-jig/learn-plover.html?hints=yes&amp;type=randomly&amp;timeLimit=2&amp;drill="</span> (url-encode-url (replace-regexp-in-string <span class="org-string">"\\+"</span> <span class="org-string">"%2B"</span> desc)))))
           '(<span class="org-string">"One Syllable Words"</span> <span class="org-string">"Consonant Clusters"</span> <span class="org-string">"Where's the TRUFT?"</span> <span class="org-string">"Dropping Unstressed Vowels"</span> <span class="org-string">"Inversion"</span> <span class="org-string">"The Fifth Vowel Key"</span> <span class="org-string">"Long Vowel Chords"</span> <span class="org-string">"Diphthong Chords"</span> <span class="org-string">"Vowel Disambiguator Chords"</span> <span class="org-string">"The Missing Keys"</span> <span class="org-string">"The Remaining Missing Letters"</span> <span class="org-string">"Review Through Missing Letters"</span> <span class="org-string">"Digraphs"</span> <span class="org-string">"Review Through Digraphs"</span> <span class="org-string">"Common Compound Clusters"</span> <span class="org-string">"Review Through Common Compound Clusters"</span> <span class="org-string">"Common Briefs 1-20"</span> <span class="org-string">"Common Briefs 21-40"</span> <span class="org-string">"Common Briefs 41-60"</span> <span class="org-string">"Common Briefs 61-80"</span> <span class="org-string">"Common Briefs 81-100"</span>))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-drill-history</span> nil <span class="org-doc">"Previous drills"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-drill-file</span> <span class="org-string">"~/proj/plover-notes/README.org"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-stenojig-custom-drill</span> (words)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MWords: "</span>)
  (plover-websocket-resume-plover)
  (<span class="org-keyword">unwind-protect</span>
    (<span class="org-keyword">progn</span>
    (browse-url-chrome (concat <span class="org-string">"file:///home/sacha/vendor/steno-jig/from-url.html?go=true&amp;type=randomly&amp;timeLimit=2&amp;name=test&amp;hints=true&amp;drillItems="</span> (url-encode-url words)))
    (read-string <span class="org-string">"Ignore this: "</span>))
  (plover-websocket-suspend-plover)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-drill</span> (drill)
  <span class="org-doc">"Run a single Plover keyboard drill and capture stats in an Org table."</span>
  (<span class="org-keyword">interactive</span> (list (consult--read my-plover-drills <span class="org-builtin">:prompt</span> <span class="org-string">"Drill: "</span> <span class="org-builtin">:sort</span> nil
                                    <span class="org-builtin">:history</span> my-plover-drill-history
                                    <span class="org-builtin">:default</span> (car my-plover-drill-history))))
  (<span class="org-keyword">unless</span> (string= (downcase (string-trim drill)) <span class="org-string">"x"</span>)
    (<span class="org-keyword">let</span> ((url (assoc-default drill my-plover-drills)))
      (plover-websocket-resume-plover)
      (<span class="org-keyword">when</span> (string-match <span class="org-string">"learn-keyboard"</span> url)
        (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{PLOVER:TOGGLE_DICT:-main.json,-user.json}"</span>))
      (switch-to-buffer (find-file my-plover-drill-file))
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"#\\+NAME: drill\n"</span>)
      (insert (format <span class="org-string">"| %s | %s |  |\n"</span>
                      (org-link-make-string url drill)
                      (format-time-string <span class="org-string">"[%Y-%m-%d %a %H:%M]"</span>)))
      (backward-char 3)
      (browse-url url)
      (read-string <span class="org-string">"Ignore this: "</span>)
      (<span class="org-keyword">when</span> (string-match <span class="org-string">"learn-keyboard"</span> url)
        (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{PLOVER:TOGGLE_DICT:+main.json,+user.json}"</span>))
      (insert (read-string (format <span class="org-string">"Time (%s): "</span> (string-join (reverse (my-plover-recent-stats drill)) <span class="org-string">", "</span>))))
      (end-of-line)
      (forward-char 1)
      t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-recent-stats</span> (drill-name)
  (mapcar
   (<span class="org-keyword">lambda</span> (o) (substring-no-properties (elt o 2)))
   (seq-take
    (sort (seq-filter (<span class="org-keyword">lambda</span> (o) (string-match (regexp-quote drill-name) (car o)))
                      (<span class="org-keyword">org-with-wide-buffer</span>
                       (<span class="org-keyword">save-excursion</span>
                         (goto-char (point-min))
                         (<span class="org-keyword">if</span> (re-search-forward <span class="org-string">"#\\+NAME: drill\n"</span> nil t)
                            (org-table-to-lisp)))))
          (<span class="org-keyword">lambda</span> (a b) (string&lt; (string-trim (elt b 1))
                                 (string-trim (elt a 1)))))
    3)))

 (<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-drilling-time</span> ()
   <span class="org-doc">"Keep drilling Plover.</span>
<span class="org-doc">Restore main dictionary and turn off Plover when done."</span>
   (<span class="org-keyword">interactive</span>)
   (quantified-track <span class="org-string">"Steno"</span>)
   (call-process <span class="org-string">"wmctrl"</span> nil 0 nil <span class="org-string">"-i"</span> <span class="org-string">"-a"</span> (number-to-string (my-wmctl-get-id <span class="org-string">"emacs"</span>)))
   (<span class="org-keyword">while</span> (my-plover-drill (consult--read my-plover-drills <span class="org-builtin">:prompt</span> <span class="org-string">"Drill: "</span> <span class="org-builtin">:sort</span> nil
                                          <span class="org-builtin">:history</span> 'my-plover-drill-history
                                          <span class="org-builtin">:default</span> (car my-plover-drill-history)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-making-it-easier-to-execute-commands" class="outline-4">
<h4 id="making-it-easier-to-execute-commands">Making it easier to execute commands</h4>
<div class="outline-text-4" id="text-making-it-easier-to-execute-commands">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> enable-recursive-minibuffers t)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-replace-heading</span> (new-text)
  (<span class="org-keyword">interactive</span> (list (read-string (concat (org-get-heading t t t t) <span class="org-string">": "</span>))))
  (org-back-to-heading)
  (<span class="org-keyword">when</span> (looking-at org-complex-heading-regexp)
    (replace-match new-text t t nil 4)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-process-inbox-entries</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">catch</span> '<span class="org-constant">exit</span>
    (<span class="org-keyword">while</span> t
      (plover-websocket-send <span class="org-builtin">:stroke</span> '[<span class="org-string">"K-"</span> <span class="org-string">"P-"</span> <span class="org-string">"A-"</span> <span class="org-string">"*"</span>])
      (my-read-command-string
       (<span class="org-keyword">lambda</span> () (concat (org-get-heading t t t t) <span class="org-string">": "</span>))
       '((<span class="org-string">"replace and post"</span>
          (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>)
            (call-interactively 'my-replace-heading)
            (call-interactively 'my-org-mark-done-and-add-to-journal)
            (org-forward-heading-same-level 1)))
         (<span class="org-string">"edit"</span> my-replace-heading)
         (<span class="org-string">"post"</span> my-org-mark-done-and-add-to-journal)
         (<span class="org-string">"refile"</span> org-refile)
         (<span class="org-string">"to do"</span> org-todo)
         (<span class="org-string">"next"</span> org-forward-heading-same-level)
         (<span class="org-string">"open link"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>)
                        (<span class="org-keyword">save-excursion</span>
                          (<span class="org-keyword">when</span> (re-search-forward org-link-any-re nil t)
                            (goto-char (match-beginning 0))
                            (org-open-at-point)))))
         (<span class="org-string">"yesterday"</span> (<span class="org-keyword">lambda</span> ()  (<span class="org-keyword">interactive</span>)
                        (<span class="org-keyword">save-excursion</span>
                          (re-search-forward org-element--timestamp-regexp)
                          (goto-char (match-beginning 0))
                          (org-timestamp-down-day))))
         (<span class="org-string">"previous"</span> org-backward-heading-same-level)
         (<span class="org-string">"new journal"</span> my-journal-post)
         (<span class="org-string">"practice"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (quantified-track <span class="org-string">"steno"</span>) (browse-url <span class="org-string">"https://didoesdigital.com/typey-type/progress"</span>)))
         (<span class="org-string">"lowercase"</span> downcase-word)
         (<span class="org-string">"capitalize"</span> capitalize-dwim)
         (<span class="org-string">"clean"</span> my-org-clean-up-inbox)
         (<span class="org-string">"replace heading"</span> my-replace-heading)
         (<span class="org-string">"cut subtree"</span> org-cut-subtree)
         (<span class="org-string">"export subtree to 11ty"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (org-11ty-export-to-11ty t t)))
         (<span class="org-string">"exit"</span> (<span class="org-keyword">throw</span> '<span class="org-constant">exit</span> nil)))
       (<span class="org-keyword">lambda</span> (input)
         (my-replace-heading input)
         (call-interactively 'my-org-mark-done-and-add-to-journal)
         (org-forward-heading-same-level 1))
       t))))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">my-read-command-string</span> (prompt commands default-fn <span class="org-type">&amp;optional</span> include-commands)
  (<span class="org-keyword">declare</span> (debug t))
  `(<span class="org-keyword">let*</span> ((command
           (consult--read
            (append ,commands
                    (<span class="org-keyword">if</span> ,include-commands
                        (<span class="org-keyword">let</span> (res)
                          (mapatoms
                           (<span class="org-keyword">lambda</span> (o)
                             (<span class="org-keyword">when</span> (commandp o) (<span class="org-keyword">push</span> (symbol-name o) res))))
                          res)))
            <span class="org-builtin">:prompt</span> (<span class="org-keyword">cond</span>
                     ((functionp ,prompt) (funcall ,prompt))
                     ((stringp ,prompt) ,prompt)
                     (t <span class="org-string">"Command: "</span>))
            <span class="org-builtin">:category</span> 'function
            <span class="org-builtin">:sort</span> nil))
          (entry (assoc-default command ,commands)))
     (<span class="org-keyword">cond</span>
      ((<span class="org-keyword">and</span> entry (listp (car entry)))
       (<span class="org-keyword">if</span> (functionp (car entry))
           (funcall (car entry))
         (eval (car entry) t)))
      (entry (call-interactively (car entry)))
      ((commandp (intern command)) (call-interactively (intern command)))
      ((functionp ,default-fn) (funcall ,default-fn command)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-read-commands</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
   ((derived-mode-p 'org-mode)
    (my-process-inbox-entries))
   ((derived-mode-p 'subed-mode)
    (my-plover/edit-subtitles))))

</pre>
</div>
</div>
</div>
<div id="outline-container-suggesting-briefs" class="outline-4">
<h4 id="suggesting-briefs">Suggesting briefs</h4>
<div class="outline-text-4" id="text-suggesting-briefs">
<p>
Only checks one dictionary for now, but probably good enough
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-briefpedia</span> (translation)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTranslation: "</span>)
  (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously (concat <span class="org-string">"http://briefpedia.com/AjaxTables3.php?search="</span> (url-encode-url translation)))
    (goto-char (point-min))
    (re-search-forward <span class="org-string">"^$"</span>)
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;/?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">th</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[ &gt;]"</span> nil t)
      (replace-match <span class="org-string">"td"</span> nil nil nil 1))
    (goto-char (point-min))
    (re-search-forward <span class="org-string">"^$"</span>)
    (<span class="org-keyword">save-excursion</span>
      (insert <span class="org-string">"&lt;div&gt;"</span>)
      (goto-char (point-max)) (insert <span class="org-string">"&lt;/div&gt;"</span>))
    (<span class="org-keyword">let*</span> ((data (xml-parse-region (point-min) (point-max)))
           (entries (mapcar (<span class="org-keyword">lambda</span> (o) (string-trim (dom-text o))) (dom-by-tag (dom-by-id data <span class="org-string">"divEnglishTable"</span>) 'a)))
           (conflicts (seq-group-by 'car
                                    (mapcar (<span class="org-keyword">lambda</span> (row) (mapcar (<span class="org-keyword">lambda</span> (cell) (string-trim (dom-texts cell))) (dom-by-tag row 'td)))
                                            (cdr (dom-by-tag (dom-by-id data <span class="org-string">"divCrossTable"</span>) 'tr)))))
           (result
            (mapcar (<span class="org-keyword">lambda</span> (entry) (cons entry (mapcar 'cadr (assoc-default entry conflicts)))) entries)))
      (<span class="org-keyword">when</span> (called-interactively-p 'any)
        (message <span class="org-string">"%s"</span>
                 (mapconcat (<span class="org-keyword">lambda</span> (entry)
                              (concat (car entry)
                                      (<span class="org-keyword">if</span> (cdr entry)
                                          (concat <span class="org-string">" ("</span>
                                                  (string-join (cdr entry) <span class="org-string">", "</span>)
                                                  <span class="org-string">")"</span>)
                                        <span class="org-string">""</span>)))
                            result
                            <span class="org-string">"; "</span>)))
      result)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-read-outline-for-brief</span> (base-prompt)
  (<span class="org-keyword">let*</span> ((prompt (<span class="org-keyword">or</span> base-prompt <span class="org-string">"Outline: "</span>))
         new-brief
         (brief (with-plover-plain (read-string prompt)))
         (my-conflicts (my-plover-check-for-conflict brief)))
    (<span class="org-keyword">while</span> my-conflicts
      (<span class="org-keyword">setq</span> prompt (format <span class="org-string">"%s%s conflicts %s (alt: %s): "</span>
                           (<span class="org-keyword">if</span> base-prompt (concat base-prompt <span class="org-string">"\n"</span>) <span class="org-string">""</span>)
                           brief (car my-conflicts) (string-join (cdr my-conflicts) <span class="org-string">", "</span>)))
      (<span class="org-keyword">setq</span> new-brief (with-plover-plain (read-string prompt)))
      (<span class="org-keyword">if</span> (string= new-brief <span class="org-string">""</span>)
          (<span class="org-keyword">setq</span> my-conflicts nil)
        (<span class="org-keyword">setq</span> brief new-brief)
        (<span class="org-keyword">setq</span> my-conflicts (my-plover-check-for-conflict brief))))
    brief))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-brief-with-check</span> (translation)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTranslation: "</span>)
  (<span class="org-keyword">setq</span> translation (string-trim translation))
  (<span class="org-keyword">let</span> ((brief (my-plover-read-outline-for-brief (format <span class="org-string">"Outline for %s: "</span> translation))))
    (<span class="org-keyword">when</span> brief
      (kill-new (format <span class="org-string">"| %s | %s |"</span> brief translation))
      (plover-websocket-add-translation brief translation))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-briefpedia-suggest</span> (translation)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MTranslation: "</span>)
  (<span class="org-keyword">setq</span> translation (string-trim translation))
  (<span class="org-keyword">let*</span> ((entries (my-plover-briefpedia translation))
         (current (my-plover-search-dictionary-for-translation translation))
         (brief
          (my-plover-read-outline-for-brief
           (concat
            (<span class="org-keyword">if</span> current (format <span class="org-string">"Current: %s\n"</span> (mapconcat 'car current <span class="org-string">"; "</span>)) <span class="org-string">""</span>)
            (<span class="org-keyword">if</span> entries
                (concat (mapconcat
                         (<span class="org-keyword">lambda</span> (entry)
                           (<span class="org-keyword">let</span> ((dict-conflict (my-plover-check-for-conflict (car entry))))
                             (<span class="org-keyword">cond</span>
                              ((<span class="org-keyword">and</span> (cdr entry) dict-conflict)
                               (format <span class="org-string">"%s - dict conflict: %s (%s)\nbrief conflict: %s"</span>
                                       (car entry)
                                       (car dict-conflict)
                                       (string-join (cdr dict-conflict) <span class="org-string">"; "</span>)
                                       (string-join (cdr entry) <span class="org-string">"; "</span>)))
                              ((cdr entry)
                               (format <span class="org-string">"%s - brief conflict: %s"</span>
                                       (car entry)
                                       (string-join (cdr entry) <span class="org-string">"; "</span>)))
                              (t (car entry)))))
                         entries
                         <span class="org-string">"\n"</span>)
                        <span class="org-string">"\nOutline: "</span>)
              <span class="org-string">"No suggestions. Outline: "</span>)))))
    (<span class="org-keyword">when</span> brief
      (kill-new (format <span class="org-string">"| %s | %s |"</span> brief translation))
      (plover-websocket-add-translation brief translation))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-check-for-conflict</span> (outline)
  (<span class="org-keyword">let*</span> ((case-fold-search nil)
         (translation (cdar (my-plover-search-dictionary-for-strokes (concat <span class="org-string">"^"</span> outline <span class="org-string">"$"</span>))))
         (alternatives (<span class="org-keyword">and</span> translation (my-plover-search-dictionary-for-translation translation))))
    (<span class="org-keyword">if</span> translation (cons translation (mapcar 'car alternatives)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-practising-within-emacs" class="outline-4">
<h4 id="practising-within-emacs">Practising within Emacs</h4>
<div class="outline-text-4" id="text-practising-within-emacs">
<p>
Main function: <code>M-x my-practise-steno</code>, called in an Org table of <code>| translation | outline |</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno-interleave</span> (base item)
  <span class="org-doc">"Interleave BASE words with item."</span>
  (cons item
        (-interleave base (make-list (length base) item))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Copied from elfeed--shuffle</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno-shuffle</span> (seq)
  <span class="org-doc">"Destructively shuffle SEQ."</span>
  (<span class="org-keyword">let</span> ((n (length seq)))
    (<span class="org-keyword">prog1</span> seq
      (<span class="org-keyword">dotimes</span> (i n)
        (<span class="org-keyword">cl-rotatef</span> (elt seq i) (elt seq (+ i (cl-random (- n i)))))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno-repeat</span> (seq times)
  (funcall 'append (make-list times seq)))
(<span class="org-keyword">defface</span> <span class="org-variable-name">my-practise-steno-correct</span> '((t <span class="org-builtin">:foreground</span> <span class="org-string">"green"</span>)) <span class="org-doc">"Correct."</span>)
(<span class="org-keyword">defface</span> <span class="org-variable-name">my-practise-steno-wrong</span> '((t <span class="org-builtin">:foreground</span> <span class="org-string">"red"</span>)) <span class="org-doc">"Wrong."</span>)
(<span class="org-keyword">defface</span> <span class="org-variable-name">my-practise-steno-highlight</span> '((t <span class="org-builtin">:background</span> <span class="org-string">"white"</span> <span class="org-builtin">:foreground</span> <span class="org-string">"black"</span>)) <span class="org-doc">"Focus."</span>)
(<span class="org-keyword">defface</span> <span class="org-variable-name">my-practise-steno-base</span> '((t <span class="org-builtin">:height</span> 150)) <span class="org-doc">"Base."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-items</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-index</span> 0)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-buffer-name</span> <span class="org-string">"*Steno practice*"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-start-of-input</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-current-overlay</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-previous-overlay</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-highlight-overlay</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-stroke-buffer</span> nil)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-practise-steno-for-review</span> nil)

<span class="org-comment-delimiter">;; </span><span class="org-comment">From https://stackoverflow.com/questions/1249497/command-to-center-screen-horizontally-around-cursor-on-emacs</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-horizontal-recenter</span> ()
  <span class="org-doc">"Make the point horizontally centered in the window."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((mid (/ (window-width) 2))
        (pixel-pos (car (window-absolute-pixel-position)))
        (pixel-mid (/ (window-pixel-width) 2))
        (line-len (<span class="org-keyword">save-excursion</span> (end-of-line) (current-column)))
        (cur (current-column)))
    (<span class="org-keyword">while</span> (&lt; pixel-mid pixel-pos)
      (set-window-hscroll (selected-window)
                          (1+ (window-hscroll)))
      (<span class="org-keyword">setq</span> pixel-pos (car (window-absolute-pixel-position))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno--handle-correct</span> ()
  (<span class="org-keyword">if</span> my-practise-steno-previous-overlay
      (move-overlay my-practise-steno-previous-overlay (overlay-start my-practise-steno-previous-overlay)
                    (+ (overlay-end my-practise-steno-previous-overlay) (match-end 0)))
    (<span class="org-keyword">setq</span> my-practise-steno-previous-overlay
          (make-overlay (overlay-end my-practise-steno-previous-overlay)
                        (+ (overlay-end my-practise-steno-previous-overlay) (match-end 0))))
    (overlay-put my-practise-steno-previous-overlay 'face 'my-practise-steno-correct)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno--mark-incorrect-and-fixed</span> ()
  (overlay-put (make-overlay (overlay-end my-practise-steno-previous-overlay)
                             (+ (overlay-end my-practise-steno-previous-overlay) (match-beginning 0)))
               'face 'my-practise-steno-wrong)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">make a new overlay</span>
  (<span class="org-keyword">setq</span> my-practise-steno-previous-overlay (copy-overlay my-practise-steno-previous-overlay))
  (move-overlay my-practise-steno-previous-overlay
                (+ (overlay-end my-practise-steno-previous-overlay) (match-beginning 0))
                (+ (overlay-end my-practise-steno-previous-overlay) (match-end 0)))
  (<span class="org-keyword">setq</span> my-practise-steno-for-review (append my-practise-steno-for-review (list (elt my-practise-steno-items my-practise-steno-index))))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">highlight the sample as incorrect, too</span>
  (<span class="org-keyword">let</span> ((incorrect-sample (copy-overlay my-practise-steno-highlight-overlay)))
    (overlay-put incorrect-sample 'face 'my-practise-steno-wrong)
    (<span class="org-keyword">save-excursion</span>
      (goto-char (overlay-start my-practise-steno-highlight-overlay))
      (insert (make-string
               (+
                (<span class="org-keyword">if</span> (bolp) 1 0)
                (match-beginning 0))
               ?\ )))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno--move-to-next-item</span> ()
  (<span class="org-keyword">setq</span> my-practise-steno-stroke-buffer nil)
  (<span class="org-keyword">setq</span> my-practise-steno-index (1+ my-practise-steno-index))
  (move-overlay my-practise-steno-current-overlay (overlay-end my-practise-steno-previous-overlay) (point))
  (<span class="org-keyword">if</span> (elt my-practise-steno-items my-practise-steno-index)
      (move-overlay my-practise-steno-highlight-overlay
                    (1+ (overlay-end my-practise-steno-highlight-overlay))
                    (+ (overlay-end my-practise-steno-highlight-overlay)
                       1 (length (car (elt my-practise-steno-items my-practise-steno-index)))))
    (<span class="org-keyword">when</span> my-practise-steno-for-review
      (goto-char (point-max))
      (kill-new (mapconcat 'car my-practise-steno-for-review <span class="org-string">" "</span>))
      (insert <span class="org-string">"\nFor review: "</span> (mapconcat 'car my-practise-steno-for-review <span class="org-string">" "</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno--handle-completed-item</span> ()
  <span class="org-comment-delimiter">;; </span><span class="org-comment">extend the feedback overlay to the current point</span>
  (<span class="org-keyword">if</span> (= (match-beginning 0) 0)
      (my-practise-steno--handle-correct)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">mark incorrect area</span>
    (my-practise-steno--mark-incorrect-and-fixed))
  (my-practise-steno--move-to-next-item))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno-check</span> (<span class="org-type">&amp;rest</span> _)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((sample (car (elt my-practise-steno-items my-practise-steno-index)))
         (input (<span class="org-keyword">and</span> (&lt; (overlay-end my-practise-steno-previous-overlay) (point))
                     (buffer-substring-no-properties (overlay-end my-practise-steno-previous-overlay) (point)))))
    (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> sample input)
      (<span class="org-keyword">if</span> (string-match (concat <span class="org-string">" *"</span> (regexp-quote sample) <span class="org-string">" *"</span>) input)
          (my-practise-steno--handle-completed-item)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">still in progress</span>
        (move-overlay my-practise-steno-current-overlay
                      (overlay-start my-practise-steno-current-overlay)
                      (1+ (point))))
      (my-horizontal-recenter))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno-store-strokes</span> (payload)
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (plist-get payload <span class="org-builtin">:stroked</span>) (string= (buffer-name) my-practise-steno-buffer-name))
    (<span class="org-keyword">let</span> ((current-item (elt my-practise-steno-items my-practise-steno-index))
          (rtfcre (plist-get (plist-get payload <span class="org-builtin">:stroked</span>) <span class="org-builtin">:rtfcre</span>)))
      (<span class="org-keyword">save-excursion</span>
        (goto-char (point-max))
        (insert (<span class="org-keyword">if</span> (bolp) <span class="org-string">""</span> <span class="org-string">" "</span>) rtfcre))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (cadr current-item)
               (&gt; (- (overlay-end my-practise-steno-current-overlay)
                     (overlay-start my-practise-steno-current-overlay))
                  (length (car current-item))))
        (<span class="org-keyword">setq</span> my-practise-steno-stroke-buffer (append my-practise-steno-stroke-buffer (list rtfcre)))
        (momentary-string-display (format <span class="org-string">" (%s -&gt; %s)"</span>
                                          (string-join my-practise-steno-stroke-buffer <span class="org-string">" "</span>)
                                          (cadr current-item))
                                  (point)
                                  ?\0
                                  <span class="org-string">""</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno</span> (items)
  <span class="org-doc">"Display ITEMS for practicing.</span>
<span class="org-doc">ITEMS should be a list like ((word) (word) (word))."</span>
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">let</span> ((table (org-table-to-lisp)))
                       (<span class="org-keyword">if</span> table
                           (<span class="org-keyword">if</span> current-prefix-arg
                               (subseq table
                                       (1- (org-table-current-line))
                                       (min (length table) (+ (org-table-current-line) current-prefix-arg -1)))
                             table)
                         my-practise-steno-items))))
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create my-practise-steno-buffer-name)
    (erase-buffer)
    (insert <span class="org-string">"\n"</span> (mapconcat 'car items <span class="org-string">" "</span>) <span class="org-string">"\n"</span>)
    (<span class="org-keyword">save-excursion</span> (insert <span class="org-string">"\n\n"</span>))
    (toggle-truncate-lines 1)
    (<span class="org-keyword">setq</span> my-practise-steno-items items
          my-practise-steno-index 0
          my-practise-steno-start-of-input (point)
          my-practise-steno-for-review nil
          my-practise-steno-current-overlay (make-overlay (point) (1+ (point)))
          my-practise-steno-previous-overlay (make-overlay (point) (point))
          my-practise-steno-stroke-buffer nil
          my-practise-steno-highlight-overlay (make-overlay (1+ (point-min)) (+ 1 (point-min) (length (car (car items))))))
    (buffer-face-set <span class="org-string">"my-practise-steno-base"</span>)
    (overlay-put my-practise-steno-previous-overlay 'face 'my-practise-steno-correct)
    (overlay-put my-practise-steno-highlight-overlay 'face 'my-practise-steno-highlight)
    (overlay-put my-practise-steno-current-overlay 'modification-hooks '(my-practise-steno-check))
    (overlay-put my-practise-steno-current-overlay 'insert-in-front-hooks '(my-practise-steno-check))
    (overlay-put my-practise-steno-current-overlay 'face 'my-practise-steno-wrong)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">(add-hook 'after-change-functions 'my-practise-steno-check nil t)</span>
    (add-hook 'plover-websocket-on-message-payload-functions 'my-practise-steno-store-strokes)
    (switch-to-buffer (current-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-practise-steno-word-list</span> (words)
  (<span class="org-keyword">interactive</span> (list (mapcar 'list (split-string (read-string <span class="org-string">"Words: "</span>)))))
  (my-practise-steno words))


<span class="org-comment-delimiter">;; </span><span class="org-comment">(call-interactively 'my-practise-steno)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-editing-subtitles" class="outline-4">
<h4 id="editing-subtitles">Editing subtitles</h4>
<div class="outline-text-4" id="text-editing-subtitles">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-subed-subtitle-set-text</span> (text)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MNew text: "</span>)
  (subed-jump-to-subtitle-text)
  (delete-region (point) (<span class="org-keyword">or</span> (subed-jump-to-subtitle-end) (point)))
  (insert text))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover/edit-find-target</span> (input)
  (<span class="org-keyword">or</span> (looking-at (concat <span class="org-string">"\\b"</span> (regexp-quote input) <span class="org-string">"\\b"</span>))
      (re-search-forward (concat <span class="org-string">"\\b"</span> (regexp-quote input) <span class="org-string">"\\b"</span>)
                         nil t)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover/edit-subtitles</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">catch</span> '<span class="org-constant">exit</span>
    (<span class="org-keyword">while</span> t
      (my-read-command-string
       <span class="org-string">"Command: "</span>
       '((<span class="org-string">"toggle"</span> subed-mpv-toggle-pause)
         (<span class="org-string">"jump"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (subed-mpv-jump-to-current-subtitle)))
         (<span class="org-string">"split [text before split]"</span> subed-split-subtitle)
         (<span class="org-string">"center"</span> recenter-top-bottom)
         (<span class="org-string">" previous"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (subed-merge-with-previous) (fill-paragraph)))
         (<span class="org-string">"merge next"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (subed-merge-with-next) (fill-paragraph)))
         (<span class="org-string">"slow"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (subed-mpv-playback-speed 0.5)))
         (<span class="org-string">"fast"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (subed-mpv-playback-speed 2)))
         (<span class="org-string">"scroll"</span> scroll-up-command)
         (<span class="org-string">"fill"</span> fill-paragraph)
         (<span class="org-string">"next [text]"</span> search-forward)
         (<span class="org-string">"replace &lt;text&gt;"</span>)
         (<span class="org-string">"previous [text]"</span> search-backward)
         (<span class="org-string">"cap [text]"</span> capitalize-word)
         (<span class="org-string">"delete [text]"</span> kill-word)
         (<span class="org-string">", [text]"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (insert <span class="org-string">","</span>)))
         (<span class="org-string">"end [text] - adds period and capitalizes next word"</span> (<span class="org-keyword">lambda</span> () (<span class="org-keyword">interactive</span>) (insert <span class="org-string">"."</span>) (capitalize-word 1)))
         (<span class="org-string">"oops"</span> 'undo)
         (<span class="org-string">"exit"</span> (<span class="org-keyword">throw</span> '<span class="org-constant">exit</span> nil)))
       (<span class="org-keyword">lambda</span> (input)
         (<span class="org-keyword">cond</span>
          ((string-match <span class="org-string">"^split </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (<span class="org-keyword">when</span> (my-plover/edit-find-target (match-string 1 input))
             (goto-char (match-end 0))
             (subed-split-subtitle)
             (fill-paragraph)))
          ((string-match <span class="org-string">"^delete </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (<span class="org-keyword">when</span> (my-plover/edit-find-target (match-string 1 input))
             (replace-match <span class="org-string">""</span>)))
          ((string-match <span class="org-string">"^, </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (<span class="org-keyword">when</span> (my-plover/edit-find-target (match-string 1 input))
             (goto-char (match-end 0))
             (insert <span class="org-string">","</span>)))
          ((string-match <span class="org-string">"^end </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (<span class="org-keyword">when</span> (my-plover/edit-find-target (match-string 1 input))
             (goto-char (match-end 0))
             (insert <span class="org-string">"."</span>)
             (<span class="org-keyword">unless</span> (<span class="org-keyword">save-excursion</span> (subed-jump-to-subtitle-end))
               (subed-forward-subtitle-text))
             (capitalize-word 1)))
          ((string-match <span class="org-string">"^zap </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> input)
           (delete-region (point)
                          (my-plover/edit-find-target (match-string 1 input))))
          ((string-match <span class="org-string">"^replace </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> input)
           (kill-word 1)
           (insert (match-string 1 input)))
          ((string-match <span class="org-string">"^cap </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (<span class="org-keyword">when</span> (my-plover/edit-find-target (match-string 1 input))
             (replace-match (capitalize (match-string 0)) t t)))
          ((string-match <span class="org-string">"^... </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (<span class="org-keyword">when</span> (my-plover/edit-find-target (match-string 1 input))
             (insert <span class="org-string">"..."</span>)))
          ((string-match <span class="org-string">"^next </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (my-plover/edit-find-target (match-string 1 input)))
          ((string-match <span class="org-string">"^previous </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *$"</span> input)
           (re-search-backward (concat <span class="org-string">"\\b"</span> (regexp-quote (match-string 1 input)) <span class="org-string">"\\b"</span>) nil t)
           (goto-char (match-end 0)))
          (t (re-search-forward (concat <span class="org-string">"\\b"</span> (regexp-quote input) <span class="org-string">"\\b"</span>)))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">(t (my-subed-subtitle-set-text input))</span>
          ))
       nil))))
</pre>
</div>
</div>
</div>
<div id="outline-container-plover_clippy_buffer" class="outline-4">
<h4 id="plover_clippy_buffer">Using inotify to add Plover Clippy suggestions into Emacs</h4>
<div class="outline-text-4" id="text-plover_clippy_buffer">
<p>
Update 2021-06-19: Changed to a vertical layout, added extra notes, simplified
</p>

<p>
I don't have a lot of screen space on my laptop, so I don't usually
have the <a href="https://github.com/openstenoproject/plover">Plover</a> suggestion window open as I type. I came up with a
<a href="https://github.com/sachac/plover-sacha-plugin/blob/main/plover_sacha_plugin/commands.py">Plover plugin</a> to let me flash the last <a href="https://github.com/tckmn/plover_clippy">Plover Clippy</a> suggestion as a
temporary notification. It went by too quickly, though, so I wrote
something that uses inotify to monitor the clippy.txt log and put it
an Emacs buffer instead. It results in text like this:
</p>

<pre class="example" id="orgc7bf8c3">
Clippy
KHREUP PEU
added
ATD
</pre>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-clippy-recent-suggestions</span> nil <span class="org-doc">"Recent suggestions, limited by `my-clippy-recent-suggestions-limit`."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-clippy-recent-suggestions-limit</span> nil <span class="org-doc">"If non-nil, keep this many suggestions."</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-clippy-extra-notes</span> nil <span class="org-doc">"Extra notes to add at the end."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-clippy-last</span> ()
  (<span class="org-keyword">let</span> ((value (string-trim (shell-command-to-string <span class="org-string">"tail -1 ~/.config/plover/clippy.txt | cut -c 23-"</span>))))
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[ \t]+|| .*? -&gt; </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> value)
      (cons (match-string 1 value) (match-string 2 value)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-clippy-show</span> (<span class="org-type">&amp;rest</span> _)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Clippy*"</span>)
    (<span class="org-keyword">let</span> ((last (my-clippy-last)))
      (<span class="org-keyword">if</span> my-clippy-recent-suggestions-limit
          (<span class="org-keyword">progn</span>
            (<span class="org-keyword">unless</span> (equal last (car my-clippy-recent-suggestions))
              (<span class="org-keyword">setq</span> my-clippy-recent-suggestions (seq-take (cons last my-clippy-recent-suggestions) my-clippy-recent-suggestions-limit)))
            (erase-buffer)
            (insert (mapconcat (<span class="org-keyword">lambda</span> (o) (format <span class="org-string">"| %s | %s |\n"</span>  (car o) (cdr o))) my-clippy-recent-suggestions <span class="org-string">""</span>)))
        (<span class="org-keyword">unless</span> (equal last (car my-clippy-recent-suggestions))
          (<span class="org-keyword">setq</span> my-clippy-recent-suggestions (cons last my-clippy-recent-suggestions))
          (goto-char (point-min))
          (insert (format <span class="org-string">"| %s | %s |\n"</span> (car last) (cdr last))))))
    (<span class="org-keyword">when</span> (get-buffer-window (current-buffer))
      (set-window-point (get-buffer-window (current-buffer)) (point-min)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-symbol</span> (symbol-name)
  (<span class="org-keyword">interactive</span> (list
                (<span class="org-keyword">let</span> ((orig-buffer (current-buffer)))
                  (completing-read
                   <span class="org-string">"Insert symbol: "</span>
                   #'help--symbol-completion-table
                   (<span class="org-keyword">lambda</span> (vv)
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">In case the variable only exists in the buffer</span>
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">the command we switch back to that buffer before</span>
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">we examine the variable.</span>
                     (<span class="org-keyword">with-current-buffer</span> orig-buffer
                       (<span class="org-keyword">or</span> (get vv 'variable-documentation)
                           (functionp vv)
                           (<span class="org-keyword">and</span> (boundp vv) (not (keywordp vv))))))))))
  (insert symbol-name))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-variable-value</span> (symbol-name)
  (<span class="org-keyword">interactive</span> (list
                (<span class="org-keyword">let</span> ((orig-buffer (current-buffer)))
                  (completing-read
                   <span class="org-string">"Insert variable: "</span>
                   #'help--symbol-completion-table
                   (<span class="org-keyword">lambda</span> (vv)
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">In case the variable only exists in the buffer</span>
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">the command we switch back to that buffer before</span>
                     <span class="org-comment-delimiter">;; </span><span class="org-comment">we examine the variable.</span>
                     (<span class="org-keyword">with-current-buffer</span> orig-buffer
                       (<span class="org-keyword">or</span> (get vv 'variable-documentation)
                           (<span class="org-keyword">and</span> (boundp vv) (not (keywordp vv))))))))))
  (insert (symbol-value (intern symbol-name))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-function</span> (symbol-name)
  (<span class="org-keyword">interactive</span> (list
                (completing-read
                 <span class="org-string">"Insert function: "</span>
                 #'help--symbol-completion-table
                 'functionp)))
  (insert symbol-name))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-clippy-monitor</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-clippy-toggle-monitor</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">if</span> (inotify-valid-p my-clippy-monitor)
      (<span class="org-keyword">progn</span>
        (message <span class="org-string">"Turning off"</span>)
        (inotify-rm-watch my-clippy-monitor))
    (message <span class="org-string">"Turning on"</span>)
    (<span class="org-keyword">setq</span> my-clippy-monitor
          (inotify-add-watch
           (expand-file-name <span class="org-string">"~/.config/plover/clippy.txt"</span>) 'modify
           #'my-clippy-show))))
</pre>
</div>
</div>
</div>
<div id="outline-container-stenoing-interface" class="outline-4">
<h4 id="stenoing-interface">Stenoing interface</h4>
<div class="outline-text-4" id="text-stenoing-interface">
<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-quick-notes</span> <span class="org-string">"~/proj/plover-notes/scratch.org"</span>)
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-plover-current-stroke-buffer</span> <span class="org-string">"*Current stroke*"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-add-note</span> (string)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MNote: "</span>)
  (<span class="org-keyword">with-current-buffer</span> (find-file-noselect my-plover-quick-notes)
    (goto-char (point-min))
    (insert string)
    (<span class="org-keyword">unless</span> (bolp) (insert <span class="org-string">"\n"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-add-last-clippy-to-notes</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-plover-add-note (format <span class="org-string">"| %s | %s |\n"</span> (caar my-clippy-recent-suggestions) (cdar my-clippy-recent-suggestions))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-scroll-notes</span> ()
  (<span class="org-keyword">interactive</span>)
  (message <span class="org-string">"Hello"</span>)
  (<span class="org-keyword">when</span> (get-buffer-window (get-file-buffer my-plover-quick-notes))
    (<span class="org-keyword">with-selected-window</span> (get-buffer-window (get-file-buffer my-plover-quick-notes))
      (scroll-up))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-scroll-notes-down</span> ()
  (<span class="org-keyword">interactive</span>)
  (message <span class="org-string">"World"</span>)
  (<span class="org-keyword">when</span> (get-buffer-window (get-file-buffer my-plover-quick-notes))
    (<span class="org-keyword">with-selected-window</span> (get-buffer-window (get-file-buffer my-plover-quick-notes))
      (scroll-down))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-spectra-last-clippy</span> ()
  (<span class="org-keyword">interactive</span>)
  (browse-url (format <span class="org-string">"http://localhost:8081/?outline=%s&amp;translation=%s"</span>
                      (car (split-string (cdar my-clippy-recent-suggestions) <span class="org-string">", "</span>))
                      (caar my-clippy-recent-suggestions))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-layout-windows</span> ()
  <span class="org-doc">"Organize my windows."</span>
  (<span class="org-keyword">interactive</span>)
  (delete-other-windows)
  (<span class="org-keyword">when</span> plover-websocket-stroke-buffer-name
    (<span class="org-keyword">with-selected-window</span> (split-window-below -4)
      (switch-to-buffer plover-websocket-stroke-buffer-name)))
  (<span class="org-keyword">with-selected-window</span> (split-window-right 100)
    (switch-to-buffer (get-buffer-create <span class="org-string">"*Clippy*"</span>))
    (<span class="org-keyword">when</span> my-plover-quick-notes
      (<span class="org-keyword">with-selected-window</span> (split-window-below 10)
        (switch-to-buffer (find-file my-plover-quick-notes))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-clear-stroke-log</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create plover-websocket-stroke-buffer-name)
    (erase-buffer)))

(<span class="org-keyword">setq</span> plover-websocket-stroke-buffer-name <span class="org-string">"*Stroke log*"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-cheat-sheets" class="outline-4">
<h4 id="cheat-sheets">Cheat sheets</h4>
<div class="outline-text-4" id="text-cheat-sheets">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-steno-quick-help</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-selected-window</span>
      (display-buffer-at-bottom
       (find-file-noselect <span class="org-string">"~/proj/plover-notes/cheat-sheet.txt"</span>)'())
    <span class="org-comment-delimiter">;; </span><span class="org-comment">... mark it as dedicated to prevent focus from being stolen</span>
    (set-window-dedicated-p (selected-window) t)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">... and shrink it immediately.</span>
    (fit-window-to-buffer)))

(<span class="org-keyword">defhydra</span> my-hydra/cheatsheet/plover ()
  <span class="org-doc">"SKHW- symbols -LTZ modifiers TWR- journal phrases</span>
<span class="org-doc">newparSKWRAURBGS bsPW-FP capKPA !space!capTK-LS cap!spaceKPA rmspcTK-FPS*</span>
<span class="org-doc">number: dupeD, revEU, 00/#OD, 00Z, $DZ, timeK- or -BG</span>
<span class="org-doc">`KH-FG  ^KR-RT ~T*LD &lt;AEPBGT =QA*LS &gt;A*EPBGT |PAO*EUP \\_R*UND</span>
<span class="org-doc">-H-N --TK-RB ,KW-BG ;SKWR*RBGS :capSTPH-FPLT :KL-N !SKHRAPL</span>
<span class="org-doc">?H-F /OI .nspP-P ...SKWR-RBGS 'A*E,AE \"KW-GS,KR-GS</span>
<span class="org-doc">(PREN,* [PWR-BGT,* {TPR-BGT,* @KWRAT $TK-PL *STA*R</span>
<span class="org-doc">\\SPWHRAERB \\&amp;SP-PBD #HAERB percPERS +PHR*US</span>
<span class="org-doc">retro KA*PD cap last *UPD cap all HRO*ERD lowered #* star AFPS add space TK-FPS del space</span>
<span class="org-doc">next HRO*ER lower KPA*L cap all</span>
<span class="org-doc">mode SPH-: RL lower R reset T Title -FPLT _RBGS"</span>)

(<span class="org-keyword">defhydra</span> my-hydra/cheatsheet/jade-plover-phrasing ()
  <span class="org-doc">"S: SWR I, KPWR you, KWHR he, SKWHR she, TWH they, TWR we, KPWH it, STKPWHR nothing</span>
<span class="org-doc">M: OE don't (AOE really don't OEU don't really)</span>
<span class="org-doc">AU didn't, E doesn't, O can't, A or U really, AOEU don't even</span>
<span class="org-doc">E: PB know, P want, RPL remember, BL believe, FG forget, R are</span>
<span class="org-doc">BG can, BGD could, BGT can't, BLG like, BLGT like to, BLGTS likes to</span>
<span class="org-doc">BLT believe that, BS said, BT be the, BTS be said to, BTZ say to</span>
<span class="org-doc">D had, F have, FGT forgot, FLG feel like, FLGT felt like, FLT felt</span>
<span class="org-doc">FPLT must, FR ever, FRB wish, FRBT wish to, FS was, FT have to, FTS has to, FZ has, GT get, L will, LG love, PBD need, PBG think, PBL mean,</span>
<span class="org-doc">PLD mind, PLG imagine, PLT might</span>
<span class="org-doc">"</span>
  )

(<span class="org-keyword">defhydra</span> my-hydra/cheatsheet/emily-symbols ()
  <span class="org-doc">"SKHW+ A (spc before) O (spc after) * (cap)</span>
<span class="org-doc">        v   E         U     EU</span>
<span class="org-doc">FG ws   Tab Backspace Del   Esc</span>
<span class="org-doc">RPBG    Up  Left      Right Down</span>
<span class="org-doc">FPBL    &#8593;   &#8592;         &#8594;     &#8595;</span>
<span class="org-doc">FRPBG   PgU Home      End   PgD</span>
<span class="org-doc">blank   ''  {*!}      {*?}  spc</span>
<span class="org-doc">FPL     (   [         &lt;     {</span>
<span class="org-doc">RBG     )   ]         &gt;     }</span>
<span class="org-doc">'F *L +G &amp;FBG \"FP #FRLG $RPBL percFRPB</span>
<span class="org-doc">,B -PL .R /RP :LG ;RB =PBLG @FRPBLG \\FB \\^RPG</span>
<span class="org-doc">_BG `P |PB ~FPBG</span>
<span class="org-doc">-S 2x -T 3x -ST 4x"</span>
  )
(<span class="org-keyword">defhydra</span> my-hydra/cheatsheet/emily-modifiers ()
  <span class="org-doc">"-LTZ F (C-) R (S-) P(s-) B(M-)</span>
<span class="org-doc">Z is STKPW</span>
<span class="org-doc">AO makes SKWR binary 0-9</span>
<span class="org-doc">Symbols with *, AO variants</span>
<span class="org-doc">TR tab delete backspace esc</span>
<span class="org-doc">KPWR up left down right</span>
<span class="org-doc">KPWHR pgup end home pgdown</span>
<span class="org-doc">blank esc tab return spc</span>
<span class="org-doc">TPH ( &lt; [ {</span>
<span class="org-doc">KWR ) &gt; ] }</span>
<span class="org-doc">P `</span>
<span class="org-doc">H '</span>
<span class="org-doc">!HR \"PH #TKHR $KPWH percPWHR &amp;SKP *T +K ,W -TP .R /WH :TK ;WR</span>
<span class="org-doc">=TKPW ?TPW @TKPWHR \\PR ^KPR |PW ~TPWR"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-coding-with-plover" class="outline-4">
<h4 id="coding-with-plover">Coding with Plover</h4>
<div class="outline-text-4" id="text-coding-with-plover">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-insert-defun</span> ()
  <span class="org-doc">"Prompt for parts of a function definition."</span>
  (<span class="org-keyword">interactive</span>)
  (insert <span class="org-string">"(defun "</span>)
  (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{MODE:LOWER}{MODE:SET_SPACE:-}"</span>)
  (insert (replace-regexp-in-string <span class="org-string">"-$"</span> <span class="org-string">""</span> (read-string <span class="org-string">"Function name: "</span>)))
  (insert <span class="org-string">" ("</span>)
  (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{MODE:SET_SPACE: }"</span>)
  (<span class="org-keyword">let</span> ((args (replace-regexp-in-string <span class="org-string">"\\&lt;</span><span class="org-string"><span class="org-variable-name">optional\\</span></span><span class="org-string">&gt;"</span> <span class="org-string">"&amp;optional"</span> (string-trim (read-string <span class="org-string">"Args: "</span>)))))
    (insert args)
    (insert <span class="org-string">")\n"</span>)
    (<span class="org-keyword">if</span> (y-or-n-p <span class="org-string">"Interactive? "</span>)
        (<span class="org-keyword">if</span> (string= args <span class="org-string">""</span>)
            (insert <span class="org-string">"(interactive)\n"</span>)
          (insert <span class="org-string">"(interactive (list))\n"</span>))))
  (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{MODE:RESET}{}{-|}"</span>)
  (insert (format <span class="org-string">"\"%s\"\n"</span>
                  (replace-regexp-in-string <span class="org-string">"\""</span> <span class="org-string">"\\\""</span> (string-trim (read-string <span class="org-string">"Docstring: "</span>)))))
  (<span class="org-keyword">save-excursion</span> (insert <span class="org-string">")"</span>) (lispy--normalize-1))
  (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{MODE:LOWER}"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-plover-insert-defvar</span> ()
  (<span class="org-keyword">interactive</span>)
  <span class="org-string">"Define a variable."</span>
  (insert <span class="org-string">"(defvar "</span>)
  (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{MODE:LOWER}{MODE:SET_SPACE:-}"</span>)
  (insert (replace-regexp-in-string <span class="org-string">"-$"</span> <span class="org-string">""</span> (read-string <span class="org-string">"Variable name: "</span>)))
  (insert <span class="org-string">" "</span>)
  (plover-websocket-send <span class="org-builtin">:translation</span> <span class="org-string">"{MODE:RESET}{}{-|}"</span>)
  (insert (string-trim (read-string <span class="org-string">"Default value: "</span>)))
  (insert (format <span class="org-string">" \"%s\")\n"</span>
                  (replace-regexp-in-string <span class="org-string">"\""</span> <span class="org-string">"\\\""</span> (string-trim (read-string <span class="org-string">"Docstring: "</span>))))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-edit-special-dwim</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
    ((org-src-edit-buffer-p) (org-edit-src-exit))
    ((org-in-src-block-p) (org-edit-special))
    ((derived-mode-p 'org-mode)
     (org-insert-structure-template <span class="org-string">"src emacs-lisp"</span>)
     (org-edit-special))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-execute-special-dwim</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
    ((org-src-edit-buffer-p) (eval-buffer))
    ((org-in-src-block-p) (org-babel-execute-src-block))
    (t (eval-buffer))))
</pre>
</div>
</div>
</div>
<div id="outline-container-measuring-wpm" class="outline-4">
<h4 id="measuring-wpm">Measuring WPM</h4>
<div class="outline-text-4" id="text-measuring-wpm">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> typing-speed <span class="org-builtin">:if</span> my-laptop-p <span class="org-builtin">:load-path</span> <span class="org-string">"~/elisp"</span>
  <span class="org-builtin">:config</span> (<span class="org-keyword">setq</span> typing-speed-window 120))
</pre>
</div>
</div>
<div id="outline-container-measure-strokes-per-second-strokes-per-word" class="outline-5">
<h5 id="measure-strokes-per-second-strokes-per-word"><span class="todo TODO">TODO</span> measure strokes per second, strokes per word</h5>
<div class="outline-text-5" id="text-measure-strokes-per-second-strokes-per-word">
</div>
</div>
</div>
<div id="outline-container-displaying-frequency-sorted-completions-with-stroke-hints" class="outline-4">
<h4 id="displaying-frequency-sorted-completions-with-stroke-hints">Displaying frequency-sorted completions with stroke hints</h4>
<div class="outline-text-4" id="text-displaying-frequency-sorted-completions-with-stroke-hints">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-company-strokedict--grep-executable</span> <span class="org-string">"grep"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-company-strokedict--candidates</span> (prefix)
  <span class="org-doc">"Fetches the candidates matching PREFIX."</span>
  (mapcar (<span class="org-keyword">lambda</span> (o)
            (<span class="org-keyword">let</span> ((data (split-string o <span class="org-string">"\t"</span>)))
              (propertize (car data) 'meta (cadr data))))
          (split-string
           (shell-command-to-string (concat
                                     my-company-strokedict--grep-executable
                                     <span class="org-string">" -i "</span>
                                     (shell-quote-argument (concat <span class="org-string">"^"</span> prefix))
                                     <span class="org-string">" "</span>
                                     <span class="org-string">"~/.config/plover/annotated.txt -m 10"</span>))
           <span class="org-string">"\n"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-company-strokedict--annotation</span> (candidate)
  (<span class="org-keyword">let</span> ((stroke (get-text-property 0 'meta candidate)))
    (<span class="org-keyword">if</span> stroke
        (format <span class="org-string">" (%s)"</span> stroke)
      <span class="org-string">""</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-company-strokedict</span> (command <span class="org-type">&amp;optional</span> arg <span class="org-type">&amp;rest</span> ignored)
  <span class="org-doc">"`</span><span class="org-doc"><span class="org-constant">company-mode</span></span><span class="org-doc">' backend for user-provided dictionaries. Dictionary files are lazy</span>
<span class="org-doc">loaded."</span>
  (<span class="org-keyword">interactive</span> (list 'interactive))
  (<span class="org-keyword">cl-case</span> command
    (<span class="org-keyword">interactive</span>     (company-begin-backend 'my-company-strokedict))
    (candidates      (my-company-strokedict--candidates arg))
    (prefix  (<span class="org-keyword">when-let</span> ((prefix (company-grab-word))) (substring-no-properties prefix)))
    (annotation (my-company-strokedict--annotation arg))
    (sorted          t)
    (duplicates      t)
    (no-cache        t)))

(<span class="org-keyword">use-package</span> company
  <span class="org-builtin">:hook</span>
  (prog-mode . company-mode)
  <span class="org-comment-delimiter">;</span><span class="org-comment">(add-to-list 'company-backends 'my-company-strokedict)</span>
  )
</pre>
</div>

<p>
This code added stroke annotations from the Typey Type dictionary to the frequency-sorted word list from <a href="https://github.com/hermitdave/FrequencyWords/blob/master/content/2018/en/en_full.txt">https://github.com/hermitdave/FrequencyWords/blob/master/content/2018/en/en_full.txt</a>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> json

<span class="org-keyword">with</span> <span class="org-builtin">open</span>(<span class="org-string">"/home/sacha/tmp/en_full.txt"</span>) <span class="org-keyword">as</span> f:
    <span class="org-variable-name">lines</span> <span class="org-operator">=</span> f.readlines()
<span class="org-keyword">with</span> <span class="org-builtin">open</span>(<span class="org-string">"/home/sacha/.config/plover/dictionaries/typey-type.json"</span>) <span class="org-keyword">as</span> f:
    <span class="org-variable-name">typey</span> <span class="org-operator">=</span> json.load(f)
<span class="org-variable-name">typey_inv</span> <span class="org-operator">=</span> {v: k <span class="org-keyword">for</span> k, v <span class="org-keyword">in</span> typey.items()}
<span class="org-keyword">with</span> <span class="org-builtin">open</span>(<span class="org-string">"/home/sacha/.config/plover/dictionaries/combined.json"</span>) <span class="org-keyword">as</span> f:
    <span class="org-variable-name">combined</span> <span class="org-operator">=</span> json.load(f)
<span class="org-variable-name">combined_inv</span> <span class="org-operator">=</span> {}
<span class="org-keyword">for</span> k, v <span class="org-keyword">in</span> combined.items():
    <span class="org-keyword">if</span> v <span class="org-keyword">in</span> combined_inv:
        <span class="org-variable-name">combined_inv</span>[v] <span class="org-operator">=</span> combined_inv[v] <span class="org-operator">+</span> <span class="org-string">', '</span> <span class="org-operator">+</span> k
    <span class="org-keyword">else</span>:
        <span class="org-variable-name">combined_inv</span>[v] <span class="org-operator">=</span> k
<span class="org-keyword">with</span> <span class="org-builtin">open</span>(<span class="org-string">"/home/sacha/.config/plover/annotated.txt"</span>, <span class="org-string">"w"</span>) <span class="org-keyword">as</span> f:
    <span class="org-keyword">for</span> line <span class="org-keyword">in</span> lines:
        <span class="org-variable-name">word</span> <span class="org-operator">=</span> line.split()[0]
        <span class="org-keyword">if</span> word <span class="org-keyword">in</span> typey_inv:
            f.write(<span class="org-string">"%s</span><span class="org-constant">\t</span><span class="org-string">%s</span><span class="org-constant">\n</span><span class="org-string">"</span> <span class="org-operator">%</span> (word, typey_inv[word]))
        <span class="org-keyword">elif</span> word <span class="org-keyword">in</span> combined:
            f.write(<span class="org-string">"%s</span><span class="org-constant">\t</span><span class="org-string">%s</span><span class="org-constant">\n</span><span class="org-string">"</span> <span class="org-operator">%</span> (word, combined[word]))
        <span class="org-keyword">else</span>:
            f.write(<span class="org-string">"%s</span><span class="org-constant">\n</span><span class="org-string">"</span> <span class="org-operator">%</span> word)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-mineclone" class="outline-3">
<h3 id="mineclone">MineClone</h3>
<div class="outline-text-3" id="text-mineclone">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-mineclone-ripgrep</span> ()
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/vendor/MineClone2"</span>))
      (call-interactively 'consult-ripgrep)))
(keymap-global-set <span class="org-string">"s-M"</span> 'my-mineclone-ripgrep)
</pre>
</div>
</div>
</div>
<div id="outline-container-emacsconf" class="outline-3">
<h3 id="emacsconf">EmacsConf</h3>
<div class="outline-text-3" id="text-emacsconf">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(autoload 'emacsconf-mail-prepare <span class="org-string">"emacsconf-mail"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-emacsconf-search-mail</span> (talk)
  (<span class="org-keyword">interactive</span> (list (emacsconf-complete-talk)))
  (emacsconf-with-talk-heading talk
    (notmuch-search (format <span class="org-string">"from:%s or to:%s"</span> (org-entry-get (point) <span class="org-string">"EMAIL"</span>)
                            (org-entry-get (point) <span class="org-string">"EMAIL"</span>)))))
(<span class="org-keyword">use-package</span> emacsconf
  <span class="org-builtin">:after</span> hydra
  <span class="org-builtin">:bind</span> ((<span class="org-string">"C-c e"</span> . emacsconf/body)
         (<span class="org-string">"M-g t"</span> . emacsconf-go-to-talk))
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">emacsconf-autoloads</span>)
  <span class="org-builtin">:hook</span>
  (message-send . emacsconf-mail-check-for-zzz-before-sending)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">defhydra</span> emacsconf
    (<span class="org-builtin">:exit</span> t)
    (<span class="org-string">"t"</span> emacsconf-go-to-talk <span class="org-string">"talk"</span>)
    (<span class="org-string">"n"</span> emacsconf-mail-notmuch-search-for-talk <span class="org-string">"notmuch search"</span>)
    (<span class="org-string">"f"</span> emacsconf-cache-find-file <span class="org-string">"file"</span>)
    (<span class="org-string">"c"</span> (find-file emacsconf-org-file) <span class="org-string">"conf.org"</span>)

    (<span class="org-string">"C"</span> (<span class="org-keyword">let</span> ((default-directory (file-name-directory emacsconf-org-file)))
           (call-interactively #'projectile-find-file)) <span class="org-string"><span class="org-warning">"org dir"</span></span><span class="org-warning">)</span>
    (<span class="org-string">"w"</span> (<span class="org-keyword">let</span> ((default-directory emacsconf-directory))
           (call-interactively #'projectile-find-file)))
    (<span class="org-string">"o"</span>
     (<span class="org-keyword">progn</span>
       (find-file (expand-file-name <span class="org-string">"2024/organizers-notebook/index.org"</span> emacsconf-directory))
       (call-interactively #'consult-org-heading))
     <span class="org-string">"org notes"</span>)
    (<span class="org-string">"a"</span> (<span class="org-keyword">let</span> ((default-directory emacsconf-ansible-directory))
           (call-interactively #'projectile-find-file)) <span class="org-string"><span class="org-warning">"ansible"</span></span><span class="org-warning">)</span>
    (<span class="org-string">"A"</span> emacsconf-prep-agenda <span class="org-string">"agenda"</span>)
    (<span class="org-string">"I"</span> emacsconf-extract-irc/body <span class="org-string">"IRC extract"</span>)
    (<span class="org-string">"ie"</span> emacsconf-insert-talk-email <span class="org-string">"email"</span>)
    (<span class="org-string">"it"</span> emacsconf-insert-talk-title <span class="org-string">"title"</span>)
    (<span class="org-string">"O"</span> (switch-to-buffer (erc-get-buffer <span class="org-string">"#emacsconf-org"</span>)))
    (<span class="org-string">"l"</span> (<span class="org-keyword">let</span> ((default-directory <span class="org-string">"~/proj/emacsconf/lisp"</span>))
           (call-interactively #'projectile-find-file)))
    (<span class="org-string">"b"</span> emacsconf-backstage-dired <span class="org-string">"backstage"</span>)
    (<span class="org-string">"u"</span> emacsconf-upload-dired <span class="org-string">"upload"</span>)
    (<span class="org-string">"vie"</span> emacsconf-volunteer-insert-email <span class="org-string">"volunteer email"</span>)
    (<span class="org-string">"U"</span> emacsconf-res-upload-dired <span class="org-string">"upload"</span>))
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/proj/emacsconf/lisp"</span>)
(keymap-global-set <span class="org-string">"M-g t"</span> 'emacsconf-go-to-talk)
</pre>
</div>
</div>
</div>
<div id="outline-container-chatgpt-ai" class="outline-3">
<h3 id="chatgpt-ai">ChatGPT, AI, and large-language models</h3>
<div class="outline-text-3" id="text-chatgpt-ai">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> chat
  <span class="org-builtin">:quelpa</span> (chat <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"iwahbe/chat.el"</span>))
(<span class="org-keyword">use-package</span> org-ai
  <span class="org-builtin">:quelpa</span> (org-ai <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"rksm/org-ai"</span>))
(<span class="org-keyword">use-package</span> khoj
  <span class="org-builtin">:after</span> org
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:quelpa</span> (khoj <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"debanjum/khoj"</span> <span class="org-builtin">:files</span> (<span class="org-builtin">:defaults</span> <span class="org-string">"src/interface/emacs/khoj.el"</span>))
  <span class="org-builtin">:bind</span> (<span class="org-string">"C-c s"</span> . 'khoj))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> gptel
  <span class="org-builtin">:commands</span> (gptel gptel-send gptel-set-topic gptel-menu)
  <span class="org-builtin">:hook</span>
  (gptel-post-stream . gptel-auto-scroll)
  (gptel-post-response . gptel-end-of-response))
</pre>
</div>
</div>
</div>
<div id="outline-container-chronos" class="outline-3">
<h3 id="chronos">Chronos timers</h3>
<div class="outline-text-3" id="text-chronos">
<p>
Tip from zaeph. Might not use this much yet, as I don't spend that much time in front of my computer. Could be handy someday, though.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> chronos
 <span class="org-builtin">:config</span>
 (add-hook 'chronos-expiry-functions #'chronos-desktop-notifications-notify)
 (add-hook 'chronos-expiry-functions #'chronos-buffer-notify))
</pre>
</div>
</div>
</div>
<div id="outline-container-paint" class="outline-3">
<h3 id="paint">Paint</h3>
<div class="outline-text-3" id="text-paint">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> paint
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/sync/cloud/elisp"</span>
  <span class="org-builtin">:init</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> paint-foreground-color <span class="org-string">"white"</span> paint-background-color <span class="org-string">"black"</span>)
    (<span class="org-keyword">defun</span> <span class="org-function-name">my-paint</span> () (<span class="org-keyword">interactive</span>) (delete-other-windows) (paint 1600 900 nil))))
</pre>
</div>
</div>
</div>
<div id="outline-container-oddmuse" class="outline-3">
<h3 id="oddmuse">Oddmuse</h3>
<div class="outline-text-3" id="text-oddmuse">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> oddmuse
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/oddmuse-el"</span>
  <span class="org-builtin">:ensure</span> nil
  <span class="org-builtin">:config</span> (oddmuse-mode-initialize)
  <span class="org-builtin">:hook</span> (oddmuse-mode-hook .
                           (<span class="org-keyword">lambda</span> ()
                             (<span class="org-keyword">unless</span> (string-match <span class="org-string">"question"</span> oddmuse-post)
                               (<span class="org-keyword">when</span> (string-match <span class="org-string">"EmacsWiki"</span> oddmuse-wiki)
                                 (<span class="org-keyword">setq</span> oddmuse-post (concat <span class="org-string">"uihnscuskc=1;"</span> oddmuse-post)))
                               (<span class="org-keyword">when</span> (string-match <span class="org-string">"OddmuseWiki"</span> oddmuse-wiki)
                                 (<span class="org-keyword">setq</span> oddmuse-post (concat <span class="org-string">"ham=1;"</span> oddmuse-post)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-mapping-blog-posts-and-image-urls-from-bulk-exports" class="outline-3">
<h3 id="org-mapping-blog-posts-and-image-urls-from-bulk-exports">Org - mapping blog posts and image URLs from bulk exports</h3>
<div class="outline-text-3" id="text-org-mapping-blog-posts-and-image-urls-from-bulk-exports">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-map-blog-and-image-urls</span> ()
  <span class="org-doc">"Extract and map blog post / image URLs."</span>
  (<span class="org-keyword">interactive</span>)
  (goto-char (point-min))
  (keep-lines <span class="org-string">"h2</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">img"</span>)
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (re-search-forward
          <span class="org-string">"^.*?h2.*?a href=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\".*$"</span> nil t)
    (replace-match <span class="org-string">"\\1"</span>))
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (re-search-forward
          <span class="org-string">"^.*?src=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\".*$"</span> nil t)
    (replace-match <span class="org-string">"\\1"</span>))
  (<span class="org-keyword">let</span> (last-post current-url result)
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"http://</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
      (<span class="org-keyword">setq</span> current-url (match-string 0))
      (<span class="org-keyword">if</span> (string-match <span class="org-string">"/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">/]*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">_thumb</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">-640x.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?.png"</span> current-url)
          (<span class="org-keyword">setq</span> result (cons (concat (match-string 1 current-url) <span class="org-string">"\t"</span> last-post) result))
        (<span class="org-keyword">setq</span> last-post current-url)))
    (kill-new (mapconcat 'identity result <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-transcript-editing" class="outline-3">
<h3 id="transcript-editing">Transcript editing</h3>
<div class="outline-text-3" id="text-transcript-editing">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-split-sentence-and-capitalize</span> ()
  (<span class="org-keyword">interactive</span>)
  (delete-char 1)
  (insert <span class="org-string">"."</span>)
  (capitalize-word 1))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-split-sentence-delete-word-and-capitalize</span> ()
  (<span class="org-keyword">interactive</span>)
  (delete-char 1)
  (insert <span class="org-string">"."</span>)
  (kill-word 1)
  (capitalize-word 1))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-delete-word-and-capitalize</span> ()
  (<span class="org-keyword">interactive</span>)
  (skip-syntax-backward <span class="org-string">"w"</span>)
  (kill-word 1)
  (capitalize-word 1))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-emms-player-mplayer-set-speed</span> (speed)
  <span class="org-doc">"Depends on mplayer's -slave mode"</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MSpeed: "</span>)
  (process-send-string emms-player-simple-process-name
                       (format <span class="org-string">"speed_set %s\n"</span> speed)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-emms-player-mplayer-speed-increment</span> 0.1)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-emms-player-mplayer-speed-up</span> ()
  <span class="org-doc">"Depends on mplayer's -slave mode"</span>
  (<span class="org-keyword">interactive</span>)
  (process-send-string emms-player-simple-process-name
                       (format <span class="org-string">"speed_incr %f\n"</span> my-emms-player-mplayer-speed-increment)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-emms-player-mplayer-slow-down</span> ()
  <span class="org-doc">"Depends on mplayer's -slave mode"</span>
  (<span class="org-keyword">interactive</span>)
  (process-send-string emms-player-simple-process-name
                       (format <span class="org-string">"speed_incr %f\n"</span> (- 0 my-emms-player-mplayer-speed-increment))))


</pre>
</div>
</div>
</div>
<div id="outline-container-beeminder" class="outline-3">
<h3 id="beeminder">Beeminder</h3>
<div class="outline-text-3" id="text-beeminder">
<p>
<a id="org2ecabc1"></a>
</p>

<p>
<a href="https://github.com/sachac/beeminder.el">https://github.com/sachac/beeminder.el</a>
</p>

<p>
This bit of code lets me track sent messages in Gnus:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-beeminder-track-message</span> ()
  (<span class="org-keyword">save-excursion</span>
    (goto-char (point-min))
    (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"Newsgroups: .*emacs"</span>)
      (goto-char (point-min))
      (<span class="org-keyword">when</span> (re-search-forward <span class="org-string">"Subject: </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
        (beeminder-add-data <span class="org-string">"orgml"</span> <span class="org-string">"1"</span> (match-string 1))))))
</pre>
</div>

<p>
And this loads the beeminder code:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> beeminder
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:config</span> (add-hook 'message-send-news-hook 'my-beeminder-track-message))
</pre>
</div>
</div>
</div>
<div id="outline-container-animation-for-emacs-chats" class="outline-3">
<h3 id="animation-for-emacs-chats">Animation for Emacs chats</h3>
<div class="outline-text-3" id="text-animation-for-emacs-chats">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-animate-emacs-chat</span> ()
  (<span class="org-keyword">interactive</span>)
  (text-scale-set 6)
  (erase-buffer)
  (sit-for 3)
  (<span class="org-keyword">let</span> ((list '(<span class="org-string">"Emacs Chat: Sacha Chua"</span>
                <span class="org-string">"interviewed by Bastien Guerry"</span>
                <span class="org-string">""</span>
                <span class="org-string">"July 24, 2013"</span>
                <span class="org-string">"sachachua.com/emacs-chat"</span>))
        (approx-width 41)
        (approx-height 16)
        row)
    (<span class="org-keyword">setq</span> row (/ (- approx-height (length list)) 2))
    (mapcar
     (<span class="org-keyword">lambda</span> (x)
       (animate-string x
                       row
                       (/ (- approx-width (length x)) 2))
       (<span class="org-keyword">setq</span> row (1+ row)))
     list)))
</pre>
</div>
</div>
</div>
<div id="outline-container-idle-timer" class="outline-3">
<h3 id="idle-timer">Idle timer</h3>
<div class="outline-text-3" id="text-idle-timer">
<p>
This snippet is from John Wiegley -
<a href="http://lists.gnu.org/archive/html/emacs-orgmode/2010-03/msg00367.html">http://lists.gnu.org/archive/html/emacs-orgmode/2010-03/msg00367.html</a>.
It shows the org agenda when Emacs is idle.
</p>

<p>
Thanks to winner-mode, I can get back to my previous buffers with C-c
left.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">jump-to-org-agenda</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((buf (get-buffer <span class="org-string">"*Org Agenda*"</span>))
        wind)
    (<span class="org-keyword">if</span> buf
        (<span class="org-keyword">if</span> (<span class="org-keyword">setq</span> wind (get-buffer-window buf))
            (select-window wind)
          (<span class="org-keyword">if</span> (called-interactively-p 'any)
              (<span class="org-keyword">progn</span>
                (select-window (display-buffer buf t t))
                (org-fit-window-to-buffer)
                <span class="org-comment-delimiter">;; </span><span class="org-comment">(org-agenda-redo)</span>
                )
            (<span class="org-keyword">with-selected-window</span> (display-buffer buf)
              (org-fit-window-to-buffer)
              <span class="org-comment-delimiter">;; </span><span class="org-comment">(org-agenda-redo)</span>
              )))
      (call-interactively 'org-agenda-list)))
  <span class="org-comment-delimiter">;;</span><span class="org-comment">(let ((buf (get-buffer "*Calendar*")))</span>
  <span class="org-comment-delimiter">;;  </span><span class="org-comment">(unless (get-buffer-window buf)</span>
  <span class="org-comment-delimiter">;;    </span><span class="org-comment">(org-agenda-goto-calendar)))</span>
  )

(run-with-idle-timer 300 t 'jump-to-org-agenda)

</pre>
</div>
</div>
</div>
<div id="outline-container-old-flickr-evernote-export" class="outline-3">
<h3 id="old-flickr-evernote-export">Old Flickr/Evernote export</h3>
<div class="outline-text-3" id="text-old-flickr-evernote-export">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">I don't use these as much now that I have the functions above.</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-evernote-extract-links</span> (filename)
  <span class="org-doc">"Extract note names and URLs from an ENEX file."</span>
  (<span class="org-keyword">interactive</span>)

  (goto-char (point-min))
  (<span class="org-keyword">let</span> (list)
    (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"&lt;title&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.+?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">&lt;/title&gt;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?\n</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">*?.*?href=\"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\""</span> nil t)
      (<span class="org-keyword">setq</span> list (cons (cons (match-string-no-properties 1) (match-string-no-properties 3)) list)))
    (delete-region (point-min) (point-max))
    (insert (mapconcat (<span class="org-keyword">lambda</span> (x) (concat <span class="org-string">"- [["</span> (cdr x) <span class="org-string">"]["</span> (car x) <span class="org-string">"]]"</span>)) list <span class="org-string">"\n"</span>))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-flickr-extract-this-week</span> ()
  <span class="org-doc">"Extract this week's sketch titles and URLs from the flickr_metadata CSV."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((base-date (apply 'encode-time (org-read-date-analyze <span class="org-string">"-fri"</span> nil '(0 0 0))))
        start end list)
    (<span class="org-keyword">setq</span> start (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (- (time-to-number-of-days base-date) 6))))
    (<span class="org-keyword">setq</span> end (format-time-string <span class="org-string">"%Y-%m-%d"</span> (days-to-time (1+ (time-to-number-of-days base-date)))))
    (<span class="org-keyword">setq</span> list (csv-parse-buffer t))
    (erase-buffer)
    (insert
     (mapconcat (<span class="org-keyword">lambda</span> (x) (concat <span class="org-string">"- [["</span> (car x) <span class="org-string">"]["</span> (cdr x) <span class="org-string">"]]"</span>))
                (sort
                 (delq nil
                       (mapcar (<span class="org-keyword">lambda</span> (x)
                                 (<span class="org-keyword">let</span> ((title (cdr (assoc <span class="org-string">"FileName"</span> x))))
                                   (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (not (string&lt; title start))
                                            (string&lt; title end))
                                       (cons (cdr (assoc <span class="org-string">"URL"</span> x)) title))))
                               list))
                 (<span class="org-keyword">lambda</span> (a b) (string&lt;  (cdr a) (cdr b)))
                 )
                <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-completion-at-point" class="outline-3">
<h3 id="completion-at-point">Completion at point?</h3>
<div class="outline-text-3" id="text-completion-at-point">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> corfu <span class="org-builtin">:init</span> (global-corfu-mode))
(<span class="org-keyword">use-package</span> cape
  <span class="org-builtin">:bind</span> ((<span class="org-string">"M-/"</span> . completion-at-point))
  <span class="org-builtin">:init</span>
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  (add-to-list 'completion-at-point-functions #'cape-abbrev)
  (add-to-list 'completion-at-point-functions #'cape-dict)
  (add-to-list 'completion-at-point-functions #'cape-line)

  )
</pre>
</div>
</div>
</div>
<div id="outline-container-enable-minibuffer-completion" class="outline-3">
<h3 id="enable-minibuffer-completion">Enable minibuffer completion</h3>
<div class="outline-text-3" id="text-enable-minibuffer-completion">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2013-03-31 Sun] </span></span> Superseded by ido-hacks?
</p>

<p>
It can be difficult to remember the full names of Emacs commands, so I
use <code>icomplete-mode</code> for minibuffer completion. This also makes it
easier to discover commands.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(icomplete-mode 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-encryption" class="outline-3">
<h3 id="encryption">Encryption</h3>
<div class="outline-text-3" id="text-encryption">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">org-crypt</span>)
(org-crypt-use-before-save-magic)
(<span class="org-keyword">setq</span> org-tags-exclude-from-inheritance (<span class="org-keyword">quote</span> (<span class="org-string">"crypt"</span>)))

(<span class="org-keyword">setq</span> org-crypt-key nil)
<span class="org-comment-delimiter">;; </span><span class="org-comment">GPG key to use for encryption</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Either the Key ID or set to nil to use symmetric encryption.</span>

<span class="org-comment-delimiter">;;     </span><span class="org-comment">(setq auto-save-default nil)</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Auto-saving does not cooperate with org-crypt.el: so you need</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">to turn it off if you plan to use org-crypt.el quite often.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Otherwise, you'll get an (annoying) message each time you</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">start Org.</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">To turn it off only locally, you can insert this:</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment"># -*- buffer-auto-save-file-name: nil; -*-</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-drawing" class="outline-3">
<h3 id="drawing">Drawing</h3>
<div class="outline-text-3" id="text-drawing">
<p>
<a id="orga42b9f1"></a>
</p>
</div>
<div id="outline-container-imagemagick" class="outline-4">
<h4 id="imagemagick">Imagemagick</h4>
<div class="outline-text-4" id="text-imagemagick">
<p>
<a href="https://xenodium.com/emacs-viewing-webp-images/">https://xenodium.com/emacs-viewing-webp-images/</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> image-use-external-converter t)
</pre>
</div>
</div>
</div>
<div id="outline-container-artrage" class="outline-4">
<h4 id="artrage">Artrage</h4>
<div class="outline-text-4" id="text-artrage">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-artrage-export-png</span> (directory <span class="org-type">&amp;optional</span> prefix)
  <span class="org-doc">"Change an Artrage script file (arscript) to export images to DIRECTORY.</span>
<span class="org-doc">          If PREFIX is specified, use that instead of image-."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MPath: "</span>)
  (<span class="org-keyword">unless</span> (file-directory-p directory)
    (make-directory directory t))
  (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"[0-9\\.]+s"</span> nil t)
    (replace-match <span class="org-string">"0.000s"</span>))
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (search-forward <span class="org-string">"&lt;StrokeEvent&gt;"</span> nil t)
    (replace-match (concat
                    <span class="org-string">"EvType: Command    CommandID: ExportLayer    Idx: -1    Channels: NO    Path: \""</span>
                    directory
                    <span class="org-string">"/"</span> (<span class="org-keyword">or</span> prefix <span class="org-string">"image-"</span>)
                    <span class="org-string">".png\"</span>
<span class="org-string">      &lt;StrokeEvent&gt;"</span>) t t)))

</pre>
</div>
</div>
</div>
<div id="outline-container-tablet-clicks-count-as-drags" class="outline-4">
<h4 id="tablet-clicks-count-as-drags">Tablet clicks count as drags</h4>
<div class="outline-text-4" id="text-tablet-clicks-count-as-drags">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">widget-button-click</span> (event)
  <span class="org-doc">"Invoke the button that the mouse is pointing at."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"e"</span>)
  (<span class="org-keyword">if</span> (widget-event-point event)
      (<span class="org-keyword">let*</span> ((oevent event)
             (mouse-1 (memq (event-basic-type event) '(mouse-1 down-mouse-1)))
             (pos (widget-event-point event))
             (start (event-start event))
             (button (get-char-property
                      pos 'button (<span class="org-keyword">and</span> (windowp (posn-window start))
                                       (window-buffer (posn-window start)))))
             newpoint)
        (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (null button)
                  (<span class="org-keyword">catch</span> '<span class="org-constant">button-press-cancelled</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">Mouse click on a widget button.  Do the following</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">in a save-excursion so that the click on the button</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">doesn't change point.</span>
                    (<span class="org-keyword">save-selected-window</span>
                      (select-window (posn-window (event-start event)))
                      (<span class="org-keyword">save-excursion</span>
                        (goto-char (posn-point (event-start event)))
                        (<span class="org-keyword">let*</span> ((overlay (widget-get button <span class="org-builtin">:button-overlay</span>))
                               (pressed-face (<span class="org-keyword">or</span> (widget-get button <span class="org-builtin">:pressed-face</span>)
                                                 widget-button-pressed-face))
                               (face (overlay-get overlay 'face))
                               (mouse-face (overlay-get overlay 'mouse-face)))
                          (<span class="org-keyword">unwind-protect</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">Read events, including mouse-movement</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">events, waiting for a release event.  If we</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">began with a mouse-1 event and receive a</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">movement event, that means the user wants</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">to perform drag-selection, so cancel the</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">button press and do the default mouse-1</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">action.  For mouse-2, just highlight/</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">unhighlight the button the mouse was</span>
                              <span class="org-comment-delimiter">;; </span><span class="org-comment">initially on when we move over it.</span>
                              (<span class="org-keyword">save-excursion</span>
                                (<span class="org-keyword">when</span> face  <span class="org-comment-delimiter">; </span><span class="org-comment">avoid changing around image</span>
                                  (overlay-put overlay 'face pressed-face)
                                  (overlay-put overlay 'mouse-face pressed-face))
                                (<span class="org-keyword">unless</span> (widget-apply button <span class="org-builtin">:mouse-down-action</span> event)
                                  (<span class="org-keyword">let</span> ((track-mouse t))
                                    (<span class="org-keyword">while</span> (not (widget-button-release-event-p event))
                                      (<span class="org-keyword">setq</span> event (read-event))

                                      <span class="org-comment-delimiter">;; </span><span class="org-comment">Sacha: Commented this section out so that my stylus</span>
                                      <span class="org-comment-delimiter">;; </span><span class="org-comment">clicks don't get reported as mouse movement</span>

                                      <span class="org-comment-delimiter">;; </span><span class="org-comment">(when (and mouse-1 (mouse-movement-p event))</span>
                                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(push event unread-command-events)</span>
                                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(setq event oevent)</span>
                                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(throw 'button-press-cancelled t))</span>
                                      (<span class="org-keyword">unless</span> (<span class="org-keyword">or</span> (integerp event)
                                                  (memq (car event) '(switch-frame select-window))
                                                  (eq (car event) 'scroll-bar-movement))
                                        (<span class="org-keyword">setq</span> pos (widget-event-point event))
                                        (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> pos
                                                 (eq (get-char-property pos 'button)
                                                     button))
                                            (<span class="org-keyword">when</span> face
                                              (overlay-put overlay 'face pressed-face)
                                              (overlay-put overlay 'mouse-face pressed-face))
                                          (overlay-put overlay 'face face)
                                          (overlay-put overlay 'mouse-face mouse-face))))))

                                <span class="org-comment-delimiter">;; </span><span class="org-comment">When mouse is released over the button, run</span>
                                <span class="org-comment-delimiter">;; </span><span class="org-comment">its action function.</span>
                                (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> pos (eq (get-char-property pos 'button) button))
                                  (goto-char pos)
                                  (widget-apply-action button event)
                                  (<span class="org-keyword">if</span> widget-button-click-moves-point
                                      (<span class="org-keyword">setq</span> newpoint (point)))))
                            (overlay-put overlay 'face face)
                            (overlay-put overlay 'mouse-face mouse-face))))

                      (<span class="org-keyword">if</span> newpoint (goto-char newpoint))
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">This loses if the widget action switches windows. -- cyd</span>
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">(unless (pos-visible-in-window-p (widget-event-point event))</span>
                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(mouse-set-point event)</span>
                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(beginning-of-line)</span>
                      <span class="org-comment-delimiter">;;   </span><span class="org-comment">(recenter))</span>
                      )
                    nil))
          (<span class="org-keyword">let</span> ((up t) command)
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Mouse click not on a widget button.  Find the global</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">command to run, and check whether it is bound to an</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">up event.</span>
            (<span class="org-keyword">if</span> mouse-1
                (<span class="org-keyword">cond</span> ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">down event</span>
                             (lookup-key widget-global-map [down-mouse-1]))
                       (<span class="org-keyword">setq</span> up nil))
                      ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">up event</span>
                             (lookup-key widget-global-map [mouse-1]))))
              (<span class="org-keyword">cond</span> ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">down event</span>
                           (lookup-key widget-global-map [down-mouse-2]))
                     (<span class="org-keyword">setq</span> up nil))
                    ((<span class="org-keyword">setq</span> command  <span class="org-comment-delimiter">;</span><span class="org-comment">up event</span>
                           (lookup-key widget-global-map [mouse-2])))))
            (<span class="org-keyword">when</span> up
              <span class="org-comment-delimiter">;; </span><span class="org-comment">Don't execute up events twice.</span>
              (<span class="org-keyword">while</span> (not (widget-button-release-event-p event))
                (<span class="org-keyword">setq</span> event (read-event))))
            (<span class="org-keyword">when</span> command
              (call-interactively command)))))
    (message <span class="org-string">"You clicked somewhere weird."</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-svg" class="outline-4">
<h4 id="svg">SVG</h4>
<div class="outline-text-4" id="text-svg">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(auto-image-file-mode -1)
</pre>
</div>
</div>
<div id="outline-container-how-can-i-generate-png-frames-that-step-through-the-highlights" class="outline-5">
<h5 id="how-can-i-generate-png-frames-that-step-through-the-highlights"><span class="todo TODO">TODO</span> Animating SVGs</h5>
<div class="outline-text-5" id="text-how-can-i-generate-png-frames-that-step-through-the-highlights">
<p>
Detailed notes are at <a href="https://sachachua.com/blog/2024/01/animating-svg-topic-maps-with-inkscape-emacs-ffmpeg-and-reveal-js/">Animating SVG topic maps with Inkscape, Emacs, FFmpeg, and Reveal.js</a>.
</p>
</div>
<ul class="org-ul">
<li><a id="org7320557"></a>Breaking up a PDF from Supernote<br>
<div class="outline-text-6" id="text-org7320557">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-convert-pdf</span> (pdf-file)
  <span class="org-doc">"Returns the SVG filename."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"FPDF: "</span>)
  (<span class="org-keyword">unless</span> (file-exists-p (concat (file-name-sans-extension pdf-file) <span class="org-string">".svg"</span>))
    (call-process <span class="org-string">"pdftocairo"</span> nil nil nil <span class="org-string">"-svg"</span> (expand-file-name pdf-file)
                  (expand-file-name (concat (file-name-sans-extension pdf-file) <span class="org-string">".svg"</span>))))
  (expand-file-name (concat (file-name-sans-extension pdf-file) <span class="org-string">".svg"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-recolor</span> (dom color-map <span class="org-type">&amp;optional</span> selector)
  <span class="org-doc">"Colors are specified as ((\"#input\" . \"#output\") ...)."</span>
  (<span class="org-keyword">if</span> (symbolp color-map)
      (<span class="org-keyword">setq</span> color-map
            (assoc-default color-map my-sketch-color-map)))
  (<span class="org-keyword">let</span> ((map-re (regexp-opt (mapcar 'car color-map))))
    (<span class="org-keyword">dolist</span> (path (<span class="org-keyword">if</span> selector (dom-search dom selector)
                    (dom-by-tag dom 'path)))
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (<span class="org-keyword">dom-attr</span> path 'style)
                 (string-match map-re (<span class="org-keyword">dom-attr</span> path 'style)))
        (dom-set-attribute
         path 'style
         (replace-regexp-in-string
          map-re
          (<span class="org-keyword">lambda</span> (match)
            (assoc-default match color-map))
          (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> path 'style) <span class="org-string">""</span>))))))
  dom)


(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-regroup</span> (dom groups)
  <span class="org-doc">"Move matching paths to their own group.</span>
<span class="org-doc">GROUPS is specified as ((id . (lambda (elem) ..)))."</span>
  (<span class="org-keyword">dolist</span> (group groups)
    (<span class="org-keyword">when-let*</span> ((matches (dom-search dom (cdr group)))
                (node (dom-node 'g '((id . <span class="org-string">"highlights"</span>)))))
      (<span class="org-keyword">dolist</span> (p matches)
        (dom-remove-node dom p)
        (dom-append-child node p))
      (dom-append-child dom node)))
  dom)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-break-apart</span> (dom selector)
  <span class="org-doc">"Break paths apart.</span>
<span class="org-doc">SELECTOR can be a function that takes the node as an argument and returns non-nil,</span>
<span class="org-doc">or a list of nodes."</span>
  (<span class="org-keyword">dolist</span> (path (<span class="org-keyword">if</span> (functionp selector) (dom-search dom selector) selector))
    (<span class="org-keyword">let</span> ((parent (dom-parent dom path)))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">break apart</span>
      (<span class="org-keyword">when</span> (<span class="org-keyword">dom-attr</span> path 'd)
        (<span class="org-keyword">dolist</span> (part (split-string (<span class="org-keyword">dom-attr</span> path 'd) <span class="org-string">"M "</span> t <span class="org-string">" +"</span>))
          (dom-append-child
           parent
           (dom-node 'path `((style . ,(<span class="org-keyword">dom-attr</span> path 'style))
                             (d . ,(concat <span class="org-string">"M "</span> part))))))
        (dom-remove-node dom path))))
  dom)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-add-bg</span> (dom)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">add background rectangle</span>
  (<span class="org-keyword">let</span> ((view-box (mapcar 'string-to-number (split-string (<span class="org-keyword">dom-attr</span> dom 'viewBox)))))
    (<span class="org-keyword">push</span> (dom-node 'rect `((x . 0)
                            (y . 0)
                            (width . ,(elt view-box 2))
                            (height . ,(elt view-box 3))
                            (fill . <span class="org-string">"#ffffff"</span>)))
          (cddr (car (dom-by-id dom <span class="org-string">"surface1"</span>)))))
  dom)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-clean</span> (dom)
  <span class="org-doc">"Remove USE and IMAGE tags."</span>
  (<span class="org-keyword">dolist</span> (use (dom-by-tag dom 'use))
    (dom-remove-node dom use))
  (<span class="org-keyword">dolist</span> (use (dom-by-tag dom 'image))
    (dom-remove-node dom use))
  dom)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-rotate</span> (dom)
  (<span class="org-keyword">let*</span> ((old-width (<span class="org-keyword">dom-attr</span> dom 'width))
         (old-height (<span class="org-keyword">dom-attr</span> dom 'height))
         (view-box (mapcar 'string-to-number (split-string (<span class="org-keyword">dom-attr</span> dom 'viewBox))))
         (rotate (format <span class="org-string">"rotate(90) translate(0 %s)"</span> (- (elt view-box 3)))))
    (dom-set-attribute dom 'width old-height)
    (dom-set-attribute dom 'height old-width)
    (dom-set-attribute dom 'viewBox (format <span class="org-string">"0 0 %d %d"</span> (elt view-box 3) (elt view-box 2)))
    (<span class="org-keyword">dolist</span> (g (dom-by-tag dom 'g))
      (dom-set-attribute g 'transform rotate)))
  dom)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-mix-blend-mode-darken</span> (dom <span class="org-type">&amp;optional</span> selector)
  (<span class="org-keyword">dolist</span> (p (<span class="org-keyword">if</span> (functionp selector) (dom-search dom selector) (<span class="org-keyword">or</span> selector (dom-by-tag dom 'path))))
    (<span class="org-keyword">when</span> (<span class="org-keyword">dom-attr</span> p 'style)
      (dom-set-attribute
       p 'style
       (replace-regexp-in-string <span class="org-string">";;</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">^;"</span> <span class="org-string">""</span>
                                 (concat
                                  (<span class="org-keyword">dom-attr</span> p 'style)
                                  <span class="org-string">";mix-blend-mode:darken"</span>)))))
  dom)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-color-to-hex</span> (dom <span class="org-type">&amp;optional</span> selector)
  (<span class="org-keyword">dolist</span> (p (<span class="org-keyword">if</span> (functionp selector) (dom-search dom selector)
               (<span class="org-keyword">or</span> selector (dom-search dom
                                        (<span class="org-keyword">lambda</span> (p) (<span class="org-keyword">dom-attr</span> p 'style))))))
    (<span class="org-keyword">when</span> (<span class="org-keyword">dom-attr</span> p 'style)
      (dom-set-attribute
       p 'style
       (replace-regexp-in-string
        <span class="org-string">"rgb(</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9\\.]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">%,</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9\\.%]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">%,</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9\\.]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">%)"</span>
        (<span class="org-keyword">lambda</span> (s)
          (color-rgb-to-hex
           (* 0.01 (string-to-number (match-string 1 s)))
           (* 0.01 (string-to-number (match-string 2 s)))
           (* 0.01 (string-to-number (match-string 3 s)))
           2))
        (<span class="org-keyword">dom-attr</span> p 'style)))))
  dom)

<span class="org-comment-delimiter">;; </span><span class="org-comment">default for now, but will support more colour schemes someday</span>
(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-sketch-color-map</span>
  '((blue
     (<span class="org-string">"#9d9d9d"</span> . <span class="org-string">"#2b64a9"</span>)
     (<span class="org-string">"#9c9c9c"</span> . <span class="org-string">"#2b64a9"</span>)
     (<span class="org-string">"#c9c9c9"</span> . <span class="org-string">"#b3e3f1"</span>)
     (<span class="org-string">"#c8c8c8"</span> . <span class="org-string">"#b3e3f1"</span>)
     (<span class="org-string">"#cacaca"</span> . <span class="org-string">"#b3e3f1"</span>))
    (t
     (<span class="org-string">"#9d9d9d"</span> . <span class="org-string">"#884636"</span>)
     (<span class="org-string">"#9c9c9c"</span> . <span class="org-string">"#884636"</span>)
     (<span class="org-string">"#cacaca"</span> . <span class="org-string">"#f6f396"</span>)
     (<span class="org-string">"#c8c8c8"</span> . <span class="org-string">"#f6f396"</span>)
     (<span class="org-string">"#c9c9c9"</span> . <span class="org-string">"#f6f396"</span>))))

(<span class="org-keyword">cl-defun</span> <span class="org-function-name">my-sketch-convert-pdf-and-break-up-paths</span> (pdf-file <span class="org-type">&amp;key</span> rotate color-map color-scheme selector)
  <span class="org-doc">"Convert PDF to SVG and break up paths."</span>
  (<span class="org-keyword">interactive</span> (list (read-file-name
                      (format <span class="org-string">"PDF (%s): "</span>
                              (my-latest-file <span class="org-string">"~/Dropbox/Supernote/EXPORT/"</span> <span class="org-string">"pdf"</span>))
                      <span class="org-string">"~/Dropbox/Supernote/EXPORT/"</span>
                      (my-latest-file <span class="org-string">"~/Dropbox/Supernote/EXPORT/"</span> <span class="org-string">"pdf"</span>)
                      t
                      nil
                      (<span class="org-keyword">lambda</span> (s) (string-match <span class="org-string">"pdf"</span> s)))))
  (<span class="org-keyword">let</span> ((dom (xml-parse-file (my-sketch-convert-pdf pdf-file)))
        (new-file (expand-file-name (concat (file-name-sans-extension pdf-file) <span class="org-string">"-split.svg"</span>))))
    (<span class="org-keyword">setq</span> dom (my-sketch-clean dom))
    (<span class="org-keyword">setq</span> dom (my-sketch-color-to-hex dom))
    (<span class="org-keyword">setq</span> dom (my-sketch-add-bg dom))
    (<span class="org-keyword">setq</span> dom (my-sketch-regroup
               dom
               '((<span class="org-string">"highlights"</span> . (<span class="org-keyword">lambda</span> (elem)
                                   (<span class="org-keyword">and</span> (<span class="org-keyword">dom-attr</span> elem 'style)
                                        (string-match <span class="org-string">"#c"</span>
                                                      (<span class="org-keyword">dom-attr</span> elem 'style))))))))
    (<span class="org-keyword">setq</span> dom (my-sketch-mix-blend-mode-darken dom))
    (<span class="org-keyword">when</span> rotate (<span class="org-keyword">setq</span> dom (my-sketch-rotate dom)))
    (<span class="org-keyword">setq</span> dom (my-sketch-break-apart dom (<span class="org-keyword">or</span> selector
                                             (dom-by-tag dom 'path))))
    (<span class="org-keyword">setq</span> dom (my-sketch-recolor dom
                                 (<span class="org-keyword">or</span> color-map
                                     color-scheme)))
    (<span class="org-keyword">with-temp-file</span> new-file
      (svg-print (car dom)))
    new-file))
</pre>
</div>

<p>
:CUSTOM_ID: svg-breaking-up-supernote
</p>
</div>
</li>
<li><a id="svg-identifying-paths"></a>Identifying paths<br>
<div class="outline-text-6" id="text-svg-identifying-paths">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-svg-auto-resize-timer</span> nil)
<span class="org-comment-delimiter">;; </span><span class="org-comment">based on image-mode</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-svg-resize-with-window</span> (window)
  (<span class="org-keyword">when</span> (numberp image-auto-resize-on-window-resize)
    (<span class="org-keyword">when</span> my-svg-auto-resize-timer
      (cancel-timer my-svg-auto-resize-timer))
    (<span class="org-keyword">setq</span> my-svg-auto-resize-timer
          (run-with-idle-timer 1 nil
                               #'my-svg-fit-to-window window))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-svg-fit-to-window</span> (window)
  (<span class="org-keyword">when</span> (window-live-p window)
    (<span class="org-keyword">with-current-buffer</span> (window-buffer window)
      (<span class="org-keyword">let</span> ((spec (get-text-property (point-min) 'display)))
        (<span class="org-keyword">when</span> (eq (car-safe spec) 'image)
          (<span class="org-keyword">let*</span> ((image-width  (plist-get (cdr spec) <span class="org-builtin">:max-width</span>))
                 (image-height (plist-get (cdr spec) <span class="org-builtin">:max-height</span>))
                 (edges (window-inside-pixel-edges window))
                 (window-width  (- (nth 2 edges) (nth 0 edges)))
                 (window-height (- (nth 3 edges) (nth 1 edges))))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">If the size has been changed manually (with `</span><span class="org-comment"><span class="org-constant">+</span></span><span class="org-comment">'/`</span><span class="org-comment"><span class="org-constant">-</span></span><span class="org-comment">'),</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">then :max-width/:max-height is nil.  In that case, do</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">no automatic resizing.</span>
            (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> image-width image-height
                       <span class="org-comment-delimiter">;; </span><span class="org-comment">Don't do resizing if we have a manual</span>
                       <span class="org-comment-delimiter">;; </span><span class="org-comment">rotation (from the `</span><span class="org-comment"><span class="org-constant">r</span></span><span class="org-comment">' command), either.</span>
                       (not (plist-get (cdr spec) <span class="org-builtin">:rotation</span>))
                       (<span class="org-keyword">or</span> (not (= image-width  window-width))
                           (not (= image-height window-height))))
              (<span class="org-keyword">unless</span> image-fit-to-window-lock
                (<span class="org-keyword">unwind-protect</span>
                    (<span class="org-keyword">progn</span>
                      (<span class="org-keyword">setq-local</span> image-fit-to-window-lock t)
                      (<span class="org-keyword">ignore-error</span> remote-file-error
                        (setcdr spec
                                (plist-put
                                 (plist-put (cdr spec) <span class="org-builtin">:max-width</span> window-width)
                                 <span class="org-builtin">:max-height</span> window-height))
                        (put-text-property (point-min) (1+ (point-min))
                                           'display spec)))
                  (<span class="org-keyword">setq</span> image-fit-to-window-lock nil))))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-svg-bounding-box</span> (path)
  <span class="org-doc">"Note: Relative paths don't work very well yet, so it's probably</span>
<span class="org-doc">better to set Inkscape's Preferences - Input/Output - SVG output</span>
<span class="org-doc">- Path string format - Absolute."</span>
  (<span class="org-keyword">require</span> '<span class="org-constant">s</span>)
  (<span class="org-keyword">let</span> ((x1 most-positive-fixnum)
        (y1 most-positive-fixnum)
        (x2 most-negative-fixnum)
        (y2 most-negative-fixnum)
        (x 0)
        (y 0)
        (i 0))
    (<span class="org-keyword">dolist</span> (seg (s-slice-at <span class="org-string">" *[MCmc] *"</span> path))
      (<span class="org-keyword">unless</span> (string= (string-trim seg) <span class="org-string">""</span>)
        (<span class="org-keyword">setq</span> seg (split-string seg <span class="org-string">"[ ,]"</span>) i 0)
        (<span class="org-keyword">let</span> ((points (mapcar 'string-to-number (cdr seg))))
          (<span class="org-keyword">pcase</span> (car seg)
            ((<span class="org-keyword">or</span> <span class="org-string">"m"</span> <span class="org-string">"M"</span>)
             (<span class="org-keyword">if</span> (<span class="org-keyword">or</span> (eq (car seg) <span class="org-string">"M"</span>) (= i 0))
                 <span class="org-comment-delimiter">;; </span><span class="org-comment">starting points are always absolute</span>
                 (<span class="org-keyword">setq</span> x (car points)
                       y (cadr points))
               <span class="org-comment-delimiter">;; </span><span class="org-comment">m, so relative movement</span>
               (<span class="org-keyword">setq</span> x (+ x (car points))
                     y (+ y (cadr points))))
             (<span class="org-keyword">when</span> (&lt; x x1) (<span class="org-keyword">setq</span> x1 x))
             (<span class="org-keyword">when</span> (&lt; y y1) (<span class="org-keyword">setq</span> y1 y))
             (<span class="org-keyword">when</span> (&gt; x x2) (<span class="org-keyword">setq</span> x2 x))
             (<span class="org-keyword">when</span> (&gt; y y2) (<span class="org-keyword">setq</span> y2 y)))
            (<span class="org-string">"c"</span>
             (<span class="org-keyword">let</span> ((old-x x) (old-y y))
               (<span class="org-keyword">dolist</span> (set (seq-partition points 6))
                 <span class="org-comment-delimiter">;; </span><span class="org-comment">relative movement? still very fuzzy on how this should work</span>
                 (<span class="org-keyword">setq</span> x (+ x (elt set 4))
                       y (+ y (elt set 5)))
                 (<span class="org-keyword">when</span> (&lt; x x1) (<span class="org-keyword">setq</span> x1 x))
                 (<span class="org-keyword">when</span> (&lt; y y1) (<span class="org-keyword">setq</span> y1 y))
                 (<span class="org-keyword">when</span> (&gt; x x2) (<span class="org-keyword">setq</span> x2 x))
                 (<span class="org-keyword">when</span> (&gt; y y2) (<span class="org-keyword">setq</span> y2 y))))
             )
            (<span class="org-string">"C"</span>
             (<span class="org-keyword">dolist</span> (set (seq-partition points 2))
               (<span class="org-keyword">setq</span> x (elt set 0))
               (<span class="org-keyword">setq</span> y (elt set 1))
               (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> x y)
                 (<span class="org-keyword">when</span> (&lt; x x1) (<span class="org-keyword">setq</span> x1 x))
                 (<span class="org-keyword">when</span> (&lt; y y1) (<span class="org-keyword">setq</span> y1 y))
                 (<span class="org-keyword">when</span> (&gt; x x2) (<span class="org-keyword">setq</span> x2 x))
                 (<span class="org-keyword">when</span> (&gt; y y2) (<span class="org-keyword">setq</span> y2 y))))))
          (<span class="org-keyword">cl-incf</span> i))))
    (list x1 y1 x2 y2)))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-svg-bounding-box</span> ()
  (should (equal (my-svg-bounding-box <span class="org-string">"M 15.838959,27.678234 C 15.838959,27.678234 50.667557,45.01362 62.948412,30.731177 75.229269,16.448732 98.309577,20.617771 102.23147,26.236269"</span>)))
  (should
   (equal (my-svg-bounding-box <span class="org-string">"M 1025.609375 852.070312 C 1025.660156 853.179688 1026.097656 854.332031 1026.914062 854.871094 C 1028.179688 855.707031 1033.238281 855.589844 1033.761719 854.746094 C 1034.320312 853.839844 1032.726562 851.054688 1031.199219 850.105469 C 1030.3125 849.554688 1029.003906 849.210938 1027.953125 849.207031 C 1027.144531 849.207031 1026.625 849.296875 1026.109375 849.976562 C 1025.710938 850.496094 1025.574219 851.332031 1025.609375 852.070312"</span>)
          '(1025.609375 849.207031 1033.761719 854.871094)))
  (should
   (equal (my-svg-bounding-box <span class="org-string">"m 1160.0156,382.75391 c 0.3867,4.04296 1.2696,9.02343 1.1719,12.88281 -1.6953,1.875 -5.8711,0.25781 -8.3906,1.05469 -0.6055,0.26171 -0.9063,0.65234 -0.9063,1.28906 0,0.64844 0.2969,0.98047 0.8907,1.21094 2.5664,0.20703 5.1289,0.41406 7.6953,0.62109 1.3672,1 0.9218,4.21484 3.4453,4.29297 0.7344,0.0273 1.0742,-0.29688 1.2109,-0.88281 0.035,-1.375 -0.625,-2.5 0.457,-3.56641 2.9375,-1.20313 5.8711,-2.41016 8.8086,-3.61328 0.9727,-0.47656 1.793,-1.08203 1.7539,-2.0625 -0.035,-0.99219 -0.8789,-1.27344 -1.871,-1.17969 -2.9336,0.74219 -5.8672,1.48047 -8.7969,2.22266 -1.8281,-2.50782 -1.6758,-7.36328 -2.1953,-11.23828 -0.2813,-0.95704 -1.1446,-1.80469 -2.1875,-1.86719 -0.7305,-0.043 -0.9922,0.26953 -1.086,0.83594 m 11.9219,24.23828 c 0.7188,2.97656 1.4375,5.94922 2.1563,8.92187 -0.027,1.29297 -1.125,3.60156 -2.3438,4.05078 -1.1836,0.44141 -3.1602,-0.78515 -4.4961,-1.76172 -1.5625,-1.13671 -2.7851,-2.75781 -4.0351,-4.40234 -2.625,-2.01953 0.1328,-5.14844 -1.3594,-6.60156 -0.9766,-0.60938 -2.9571,0.32812 -3.1133,1.64844 -0.5391,1.83984 -0.3594,4.5 0.7695,6.35546 1.9532,2.94532 5.1953,6.72266 8.3203,7.9336 1.6993,0.57422 4.7149,0.65625 6.3125,0.19531 1.0039,-0.28906 1.4297,-0.96094 1.8633,-2.05078 0.8008,-1.99609 1.5196,-4.24609 1.375,-6.26953 -0.8554,-2.90625 -0.9883,-6.82031 -3.4179,-8.94922 -1.0157,-0.50781 -1.875,-0.0508 -2.0313,0.92969 m -13.3789,26.9375 c -0.078,1.33593 -0.1328,2.92187 0.293,4.17968 0.9453,1.51172 1.8867,3.02344 2.8281,4.53907 -0.6524,0.73828 -1.3086,1.47656 -1.9609,2.21484 -0.7305,2.76172 -0.875,9.38672 0.1484,12.29297 1.0859,2.86719 4.3516,4.23047 7.0312,5.91016 1.9375,0.79296 4.3946,0.40234 6.3516,-0.21485 0.6641,-0.21094 1.2969,-0.46875 1.6484,-0.96484 0.5274,-0.7461 0.5274,-2.09766 -0.027,-2.64844 -1.9102,0.008 -3.8203,0.0156 -5.7305,0.0273 -1.7773,-0.49218 -4.207,-1.9414 -5.6484,-3.60156 -1.8672,-2.39453 -0.8125,-5.0625 -0.9766,-7.5625 0.1758,-1.18359 0.8164,-2.70703 1.8867,-3.11328 2.5977,0.14844 5.1915,0.29688 7.7891,0.44531 1.0625,-0.0664 1.918,-0.27734 2.8945,-1.19531 1.2657,-1.19531 2.086,-2.81641 2.3008,-4.16406 0.3164,-2 0.1094,-4.34375 -0.5312,-6.33203 -0.2149,-0.66016 -0.4805,-1.29297 -1.0157,-1.63282 -0.4882,-0.30859 -1.1914,-0.30078 -1.6093,0.0156 -1.4844,1.51562 0.1953,4.54687 -0.2383,6.68359 -0.2969,0.9375 -1.3047,1.9961 -2.2344,2.72266 -0.9765,0.76562 -1.7734,1.05469 -2.7187,0.95703 -1.461,-0.14844 -3.1953,-1.41797 -4.5274,-2.86328 -1.2578,-1.37109 -2.5078,-3.19922 -2.7187,-4.59375 -0.1289,-0.86719 0.2734,-1.10938 1.1289,-0.38672 1.3867,1.78125 2.7695,3.55859 4.1562,5.33594 0.586,0.28515 1.2813,0.2539 1.7071,-0.125 0.6796,-0.60547 0.6523,-1.85156 0.25,-2.94922 -0.6368,-1.73828 -2.043,-3.77734 -3.1602,-5.26953 -0.7656,-1.01953 -1.668,-1.77344 -2.8086,-1.94922 -0.6992,-0.10938 -1.5234,0.004 -2.2461,0.37891 -1.6445,0.85937 -2.1758,2.46093 -2.2617,3.86328 m -44.8516,12.89843 c -0.1562,7.03125 -0.1875,14.48047 0.1016,21.36719 0.2305,0.60938 0.5703,0.91016 1.1914,0.91406 0.625,0 0.9648,-0.30078 1.1953,-0.89843 0.6914,-3.53125 -0.582,-10 0.8906,-11.95313 4.9375,6.73438 15.668,16.79688 20.3321,24.84766 -1.0469,9.58203 -3.8399,19.17187 -6.2578,28.75 -1.8321,3.38672 -3.668,6.77344 -5.5039,10.16015 -0.1485,1.13672 0.3281,2.05469 1.3789,2.11329 1.0625,0.0586 2.0625,-0.78516 2.8046,-1.76954 1.8125,-2.41406 3.2461,-5.60937 4.129,-8.1914 2.9101,-11.14063 5.621,-21.85156 7.3515,-33.25781 -3.9726,-6.83594 -13.1719,-14.88672 -17.6406,-20.35938 -1.8203,-2.29297 -6.4102,-8.75 -6.3594,-9.76953 0.035,-0.78906 2.4805,-1.89844 3.8164,-2.04688 1.668,0.19141 3.3321,0.38672 5,0.57813 0.875,-0.26563 1.3047,-1.26953 0.7383,-2.34766 -0.3984,-0.7539 -1.0117,-1.07031 -1.7031,-1.26562 -2.0547,-0.57031 -5.2188,-0.38281 -7.2813,-0.0703 -1.6797,0.16015 -3.9687,1.58203 -4.1836,3.19921 m 35.4766,21.35547 c -0.668,0.67188 -0.7461,2.96485 0.039,3.65625 0.6523,0.56641 1.9531,0.3086 2.9531,-0.67578 0.9961,-0.98437 1.2695,-2.28515 0.6836,-2.9414 -0.7071,-0.79297 -3.0117,-0.70313 -3.6758,-0.0391 m 25.8633,-0.39062 c -2.7031,1.03906 -5.4024,2.07812 -8.1055,3.11719 -1.3398,-0.0742 -2.6836,-0.14844 -4.0234,-0.22266 -0.9102,0.23047 -1.3477,1.27734 -0.7813,2.34766 0.3946,0.75 1.0274,1.08203 1.7227,1.26953 1.3515,0.36328 2.9023,0.0469 4.2109,-0.27344 2.4883,-0.60547 6.1172,-1.4375 8.1797,-2.63281 0.7969,-0.46094 1.2578,-1.35938 1,-2.41016 -0.2578,-1.05469 -1.0547,-1.3125 -2.2031,-1.19531 m 0.2304,28.30078 c 0.4258,1.11719 -0.2382,2.55078 -1.375,2.75781 -1.871,-0.043 -4.7148,-3.05078 -6.0546,-5.01562 -0.4727,-0.92188 -0.4532,-1.77344 -0.012,-2.64063 0.4454,-0.87109 1.3633,-1.84765 2.0664,-1.92187 1.8711,0.53906 4.0547,4.24218 5.375,6.82031 m 3.0899,-2.16406 c -1.0859,-2.19141 -2.168,-4.38282 -3.25,-6.57422 1.2812,-0.79688 2.5586,-1.59375 3.8398,-2.39063 0.6172,-0.96093 0.6602,-3.09765 -0.1601,-3.80468 -2.2735,-1.32813 -4.2344,3.59765 -6.8633,3.10546 -3.6523,-0.54296 -7.3047,-1.08203 -10.957,-1.625 -2.8828,0.15625 -6.6953,-0.55468 -8.8477,0.5586 -0.6953,0.88281 -0.4726,2.82031 0.6484,3.00781 3.2657,0.89844 7.7657,1.15234 10.7071,1.50391 0.6289,0.41797 0.2226,6.12109 1.4258,8.48437 1.0195,1.99219 2.8632,3.76563 4.8945,5.17969 1.4844,1.03516 2.7617,1.15234 4.2695,1.03516 1.3711,-0.10547 3.086,-0.37891 3.8164,-1.3711 0.9766,-1.32812 0.7188,-5.28125 0.4766,-7.10937 M 1167,513.47266 1167.5273,514 1167,514.52734 1166.4727,514 1167,513.47266 m 10.8203,-7.64844 c 0.3906,2.33594 0.7774,4.66797 1.1641,7.0039 -0.4024,1.29297 -2.8242,3.76172 -4.0078,4.0625 -0.8868,0.22657 -1.586,-0.41796 -2.3125,-1.30468 -1.5469,-2.1836 -3.0938,-4.3711 -4.6407,-6.55469 -0.875,-0.5 -2.0898,-0.54297 -3.1992,0.0352 -1.1719,0.60937 -1.8789,1.70703 -2.1406,2.83203 -0.8633,2.57812 1.2852,4.94922 2.1484,7.125 -0.4062,1.29687 -0.8086,2.59375 -1.2148,3.89062 -0.3281,2.24219 -0.2422,4.94922 0.3203,7.21875 0.4297,1.72656 1.2578,3.50391 2.5195,5.2461 0.7696,1.0625 1.4141,1.71875 2.4258,1.92187 2.5938,0.52344 7.75,-0.74609 10.3945,-1.55078 1.0547,-0.32422 1.7735,-0.68359 1.9766,-1.78516 0.1992,-1.08984 -0.2422,-1.89843 -1.0703,-2.01953 -2.9961,0.375 -5.9961,0.75391 -8.9961,1.12891 -2.207,-1.27735 -4.4453,-4.15235 -4.6523,-6.15235 -0.086,-1.98828 0.4921,-4.85937 1.9531,-5.94531 2.5547,0.0547 5.1133,0.10938 7.6719,0.16406 1.5898,-0.55468 3.7968,-2.25 4.9414,-3.92187 1.125,-1.64063 1.375,-3.51953 1.2812,-5.1875 -0.3476,-2.22266 -0.8398,-5.41016 -2.5117,-6.94922 -0.9102,-0.53125 -1.8203,-0.11328 -2.0508,0.74219"</span>)
          nil                           <span class="org-comment-delimiter">; </span><span class="org-comment">don't know what</span>
          )))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-svg-display</span> (buffer-name svg <span class="org-type">&amp;optional</span> highlight-id full-window)
  <span class="org-doc">"HIGHLIGHT-ID is a string ID or a node."</span>
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create buffer-name)
    (<span class="org-keyword">when</span> highlight-id
      <span class="org-comment-delimiter">;; </span><span class="org-comment">make a copy</span>
      (<span class="org-keyword">setq</span> svg (<span class="org-keyword">with-temp-buffer</span> (svg-print svg) (car (xml-parse-region (point-min) (point-max)))))
      (<span class="org-keyword">if-let*</span> ((path (<span class="org-keyword">if</span> (stringp highlight-id) (dom-by-id svg highlight-id) highlight-id))
                (view-box (split-string (<span class="org-keyword">dom-attr</span> svg 'viewBox)))
                (box (my-svg-bounding-box (<span class="org-keyword">dom-attr</span> path 'd)))
                (parent (car path)))
          (<span class="org-keyword">progn</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">find parents for possible rotation</span>
            (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> parent (not (<span class="org-keyword">dom-attr</span> parent 'transform)))
              (<span class="org-keyword">setq</span> parent (dom-parent svg parent)))
            (dom-set-attribute path 'style
                               (concat (<span class="org-keyword">dom-attr</span> path 'style) <span class="org-string">"; stroke: 1px red; fill: #ff0000 !important"</span>))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">add a crosshair</span>
            (dom-append-child
             (<span class="org-keyword">or</span> parent svg)
             (dom-node 'path
                       `((d .
                            ,(format <span class="org-string">"M %f,0 V %s M %f,0 V %s M 0,%f H %s M 0,%f H %s"</span>
                                     (elt box 0)
                                     (elt view-box 3)
                                     (elt box 2)
                                     (elt view-box 3)
                                     (elt box 1)
                                     (elt view-box 2)
                                     (elt box 3)
                                     (elt view-box 2)))
                         (stroke-dasharray . <span class="org-string">"5,5"</span>)
                         (style . <span class="org-string">"fill:none;stroke:gray;stroke-width:3px"</span>)))))
        (<span class="org-warning">error</span> <span class="org-string">"Could not find %s"</span> highlight-id)))
    (<span class="org-keyword">let*</span> ((inhibit-read-only t)
           (image (svg-image svg))
           (edges (window-inside-pixel-edges (get-buffer-window))))
      (erase-buffer)
      (<span class="org-keyword">if</span> full-window
          (<span class="org-keyword">progn</span>
            (delete-other-windows)
            (switch-to-buffer (current-buffer)))
        (display-buffer (current-buffer)))
      (insert-image (append image
                            (list <span class="org-builtin">:max-width</span>
                                  (floor (* 0.8 (- (nth 2 edges) (nth 0 edges))))
                                  <span class="org-builtin">:max-height</span>
                                  (floor (* 0.8 (- (nth 3 edges) (nth 1 edges)))) )))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(my-svg-resize-with-window (selected-window))</span>
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(add-hook 'window-state-change-functions #'my-svg-resize-with-window t)</span>
      (current-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-svg-identify-paths</span> (filename <span class="org-type">&amp;optional</span> selector)
  <span class="org-doc">"Prompt for IDs for each path in FILENAME."</span>
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"SVG: "</span> nil nil
                                     (<span class="org-keyword">lambda</span> (f) (string-match <span class="org-string">"\\.svg$"</span> f)))))
  (<span class="org-keyword">let*</span> ((dom (car (xml-parse-file filename)))
         (paths (<span class="org-keyword">if</span> (functionp selector) (dom-search dom selector)
                  (<span class="org-keyword">or</span> selector
                      (dom-by-tag dom 'path))))
         (vertico-count 3)
         (ids (seq-keep (<span class="org-keyword">lambda</span> (path)
                          (<span class="org-keyword">and</span> (<span class="org-keyword">dom-attr</span> path 'id)
                               (<span class="org-keyword">unless</span> (string-match <span class="org-string">"path[0-9]+"</span> (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> path 'id) <span class="org-string">"path0"</span>))
                                 (<span class="org-keyword">dom-attr</span> path 'id))))
                        paths))
         (edges (window-inside-pixel-edges (get-buffer-window)))
         id)
    (my-svg-display <span class="org-string">"*image*"</span> dom nil t)
    (<span class="org-keyword">dolist</span> (path paths)
      (<span class="org-keyword">when</span> (string-match <span class="org-string">"path[0-9]+"</span> (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> path 'id) <span class="org-string">"path0"</span>))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">display the image with an outline</span>
        (<span class="org-keyword">unwind-protect</span>
            (<span class="org-keyword">progn</span>
              (my-svg-display <span class="org-string">"*image*"</span> dom path t)
              (<span class="org-keyword">setq</span> id (completing-read
                        (format <span class="org-string">"ID (%s): "</span> (<span class="org-keyword">dom-attr</span> path 'id))
                        ids))
              <span class="org-comment-delimiter">;; </span><span class="org-comment">already exists, merge with existing element</span>
              (<span class="org-keyword">if-let</span> ((old (dom-by-id dom id)))
                  (<span class="org-keyword">progn</span>
                    (dom-set-attribute
                     old
                     'd
                     (concat (<span class="org-keyword">dom-attr</span> (dom-by-id dom id) 'd)
                             <span class="org-string">" "</span>
                             <span class="org-comment-delimiter">;; </span><span class="org-comment">change relative to absolute</span>
                             (replace-regexp-in-string <span class="org-string">"^m"</span> <span class="org-string">"M"</span>
                                                       (<span class="org-keyword">dom-attr</span> path 'd))))
                    (dom-remove-node dom path)
                    (<span class="org-keyword">setq</span> id nil))
                (dom-set-attribute path 'id id)
                (add-to-list 'ids id))))
        <span class="org-comment-delimiter">;; </span><span class="org-comment">save the image just in case we get interrupted halfway through</span>
        (<span class="org-keyword">with-temp-file</span> filename
          (svg-print dom))))))
</pre>
</div>
</div>
</li>
<li><a id="svg-sorting-paths"></a>Sorting paths<br>
<div class="outline-text-6" id="text-svg-sorting-paths">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-svg-reorder-paths</span> (filename <span class="org-type">&amp;optional</span> ids output-filename)
  <span class="org-doc">"Sort paths in FILENAME."</span>
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"SVG: "</span> nil nil (<span class="org-keyword">lambda</span> (f) (string-match <span class="org-string">"\\.svg$"</span> f)))
                     nil (read-file-name <span class="org-string">"Output: "</span>)))
  (<span class="org-keyword">let*</span> ((dom (car (xml-parse-file filename)))
         (paths (dom-by-tag dom 'path))
         (parent (dom-parent dom (car paths)))
         (ids-left
          (nreverse (seq-keep (<span class="org-keyword">lambda</span> (path)
                                (<span class="org-keyword">unless</span> (string-match <span class="org-string">"path[0-9]+"</span> (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> path 'id) <span class="org-string">"path0"</span>))
                                  (<span class="org-keyword">dom-attr</span> path 'id)))
                              paths)))
         list)
    (<span class="org-keyword">when</span> (called-interactively-p)
      (<span class="org-keyword">while</span> ids-left
        (my-svg-display <span class="org-string">"*image*"</span> dom (car ids-left))
        (<span class="org-keyword">let</span> ((current (completing-read
                        (format <span class="org-string">"ID (%s): "</span>
                                (car ids-left))
                        ids-left nil nil nil nil (car ids-left)))
              node)
          (add-to-list 'ids current)
          (<span class="org-keyword">setq</span> ids-left (seq-remove (<span class="org-keyword">lambda</span> (o) (string= o current)) ids-left)))))
    (<span class="org-keyword">if</span> ids <span class="org-comment-delimiter">;; </span><span class="org-comment">reorganize under the first path's parent</span>
        (<span class="org-keyword">progn</span>
          (<span class="org-keyword">dolist</span> (id ids)
            (<span class="org-keyword">if-let</span> ((node (car (dom-by-id dom id))))
                (<span class="org-keyword">progn</span>
                  (dom-remove-node dom node)
                  (dom-append-child parent node))
              (message <span class="org-string">"Could not find %s"</span> id)))
          (<span class="org-keyword">with-temp-file</span> (<span class="org-keyword">or</span> output-filename filename)
            (svg-print dom))))
    (nreverse (seq-keep (<span class="org-keyword">lambda</span> (path)
                          (<span class="org-keyword">unless</span> (string-match <span class="org-string">"path[0-9]+"</span> (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> path 'id) <span class="org-string">"path0"</span>))
                            (<span class="org-keyword">dom-attr</span> path 'id)))
                        (dom-by-tag dom 'path)))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(my-svg-reorder-paths <span class="org-string">"~/proj/2023-12-audio-workflow/map.svg"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(my-svg-reorder-paths <span class="org-string">"~/proj/2023-12-audio-workflow/map.svg"</span>
                      '(<span class="org-string">"t-start"</span> <span class="org-string">"h-audio"</span> <span class="org-string">"h-capture"</span> <span class="org-string">"t-but"</span> <span class="org-string">"t-mic"</span> <span class="org-string">"h-mic"</span>
                        <span class="org-string">"t-reviewing"</span> <span class="org-string">"h-reviewing"</span>
                        <span class="org-string">"t-words"</span> <span class="org-string">"h-words"</span> <span class="org-string">"t-workflow"</span> <span class="org-string">"h-workflow"</span>
                        <span class="org-string">"t-lapel"</span>
                        <span class="org-string">"h-lapel"</span>
                        <span class="org-string">"mic-recorder"</span>
                        <span class="org-string">"t-recorder"</span>
                        <span class="org-string">"h-recorder"</span>
                        <span class="org-string">"t-syncthing"</span> <span class="org-string">"h-sync"</span>
                        <span class="org-string">"t-keywords"</span> <span class="org-string">"h-keywords"</span> <span class="org-string">"t-keyword-types"</span>
                        <span class="org-string">"t-lines"</span>
                        <span class="org-string">"h-lines"</span>
                        <span class="org-string">"t-align"</span>
                        <span class="org-string">"h-align"</span>
                        <span class="org-string">"arrow"</span>
                        <span class="org-string">"t-org"</span> <span class="org-string">"h-org"</span> <span class="org-string">"t-todo"</span> <span class="org-string">"h-todo"</span> <span class="org-string">"h-linked"</span>
                        <span class="org-string">"t-jump"</span> <span class="org-string">"h-jump"</span>
                        <span class="org-string">"t-waveform"</span> <span class="org-string">"h-waveform"</span>
                        <span class="org-string">"t-someday"</span>
                        <span class="org-string">"h-sections"</span>
                        <span class="org-string">"t-speech-recognition"</span> <span class="org-string">"h-speech-recognition"</span>
                        <span class="org-string">"t-ai"</span>
                        <span class="org-string">"h-ai"</span>
                        <span class="org-string">"t-summary"</span>
                        <span class="org-string">"extra"</span>)
                      <span class="org-string">"~/proj/2023-12-audio-workflow/map-output.svg"</span>
                      )
</pre>
</div>
</div>
</li>
<li><a id="svg-animating-paths-in-order"></a>Animating paths in order<br>
<div class="outline-text-6" id="text-svg-animating-paths-in-order">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-animate-svg-paths</span> (filename output-dir)
  <span class="org-doc">"Add one path at a time. Save the resulting SVGs to OUTPUT-DIR."</span>
  (<span class="org-keyword">unless</span> (file-directory-p output-dir)
    (make-directory output-dir t))
  (<span class="org-keyword">let*</span> ((dom (xml-parse-file filename))
         (paths (seq-filter (<span class="org-keyword">lambda</span> (e) (<span class="org-keyword">dom-attr</span> e 'style))
                            (dom-by-tag dom 'path)))
         (total (length paths))
         (frame-num (length paths))
         result)
    (<span class="org-keyword">dolist</span> (elem paths)
      (dom-set-attribute elem 'style
                         (concat
                          (<span class="org-keyword">dom-attr</span> elem 'style)
                          <span class="org-string">";mix-blend-mode:darken"</span>)))
    (<span class="org-keyword">with-temp-file</span> (expand-file-name (format <span class="org-string">"frame-%03d.svg"</span> (1+ frame-num)) output-dir)
      (xml-print dom))
    (<span class="org-keyword">dolist</span> (elem paths)
      (dom-set-attribute elem 'style
                         (concat
                          (<span class="org-keyword">dom-attr</span> elem 'style)
                          <span class="org-string">";fill-opacity:0"</span>)))
    (<span class="org-keyword">dolist</span> (elem paths)
      (<span class="org-keyword">with-temp-file</span> (expand-file-name
                       (format <span class="org-string">"frame-%03d.svg"</span>
                               (- total frame-num))
                       output-dir)
        (message <span class="org-string">"%03d"</span> frame-num)
        (dom-set-attribute elem 'style
                           (concat (<span class="org-keyword">dom-attr</span> elem 'style)
                                   <span class="org-string">";fill-opacity:1"</span>))
        (<span class="org-keyword">push</span> (list (format <span class="org-string">"frame-%03d.svg"</span>
                            (1+ (- total frame-num)))
                    (<span class="org-keyword">dom-attr</span> elem 'id))
              result)
        (<span class="org-keyword">setq</span> frame-num (1- frame-num))
        (xml-print dom)))
    (reverse result)))
</pre>
</div>

<p>
Example:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(my-animate-svg-paths <span class="org-string">"~/proj/2023-12-audio-workflow/map-output.svg"</span>
                      <span class="org-string">"~/proj/2023-12-audio-workflow/frames/"</span>)
</pre>
</div>

<p>
for FILE in *.svg; do inkscape &#x2013;export-type=png &#x2013;export-dpi=96 &#x2013;export-background-opacity=1 $FILE; done
</p>

<p>
One image per second
</p>
<ul class="org-ul">
<li>ffmpeg -i frame-%03d.svg.png -vf palettegen palette.png</li>
<li>ffmpeg -f image2 -framerate 1 -i frame-%03d.svg.png -loop -1 animation.gif</li>
<li>ffmpeg -framerate 1 -i frame-%03d.svg.png -i palette.png -lavfi "paletteuse" -loop -1 animation.gif</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-ffmpeg-animate-images</span> (files output-file <span class="org-type">&amp;optional</span> framerate)
  <span class="org-doc">"Make an animated GIF or WEBM out of FILES.</span>
<span class="org-doc">Save it to OUTPUT-FILE.</span>
<span class="org-doc">If FRAMERATE is specified, use that instead of 30."</span>
  (<span class="org-keyword">setq</span> framerate (<span class="org-keyword">or</span> framerate 30))
  (<span class="org-keyword">if</span> (string-match <span class="org-string">"\\.webm$"</span> output-file)
      (<span class="org-keyword">let</span> ((compile-media-ffmpeg-arguments
             (append compile-media-ffmpeg-arguments
                     (list <span class="org-string">"-r"</span>
                           (number-to-string framerate)))))
        (compile-media `((video ,@(mapcar (<span class="org-keyword">lambda</span> (o) (list <span class="org-builtin">:source</span> o <span class="org-builtin">:duration-ms</span> (/ 1000.0 framerate)
                                                            <span class="org-builtin">:before-input</span>
                                                            (list <span class="org-string">"-width"</span> compile-media-output-video-width)))
                                          files)))
                       output-file))
    (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*gif*"</span>)
      (erase-buffer)
      (<span class="org-keyword">let</span> ((frame-input (seq-mapcat (<span class="org-keyword">lambda</span> (o) (list <span class="org-string">"-i"</span> o)) files))
            (palette (make-temp-file <span class="org-string">"palette"</span> nil <span class="org-string">".png"</span>)))
        (insert <span class="org-string">"ffmpeg "</span>
                (string-join (append frame-input (list <span class="org-string">"-vf"</span> <span class="org-string">"palettegen"</span> <span class="org-string">"-y"</span> palette)) <span class="org-string">" "</span>)
                <span class="org-string">"\n"</span>)
        (apply #'call-process <span class="org-string">"ffmpeg"</span> nil t t
               (append frame-input (list <span class="org-string">"-vf"</span> <span class="org-string">"palettegen"</span> <span class="org-string">"-y"</span> palette)))
        (insert <span class="org-string">"ffmpeg "</span>
                (string-join (append (list <span class="org-string">"-i"</span> palette <span class="org-string">"-lavfi"</span> <span class="org-string">"paletteuse"</span>)
                                     (list <span class="org-string">"-framerate"</span> (number-to-string framerate))
                                     frame-input
                                     (list <span class="org-string">"-loop"</span> <span class="org-string">"-1"</span> <span class="org-string">"-y"</span> output-file)) <span class="org-string"><span class="org-warning">" "</span></span><span class="org-warning">)</span>
                <span class="org-string">"\n"</span>)
        (apply #'call-process <span class="org-string">"ffmpeg"</span> nil t t
               (append (list <span class="org-string">"-i"</span> palette <span class="org-string">"-lavfi"</span> <span class="org-string">"paletteuse"</span>)
                       (list <span class="org-string">"-framerate"</span> (number-to-string framerate))
                       frame-input
                       (list <span class="org-string">"-loop"</span> <span class="org-string">"-1"</span> <span class="org-string">"-y"</span> output-file)))
        (delete-file palette))
      (display-buffer (current-buffer))))
  output-file)
</pre>
</div>
</div>
</li>
<li><a id="reveal-js-sketch-animation"></a>RevealJS CSS animation of sketches<br>
<div class="outline-text-6" id="text-reveal-js-sketch-animation">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orgd7cba2a">(<span class="org-keyword">defun</span> <span class="org-function-name">my-reveal-svg-animation</span> (slide)
  (string-join
   (seq-map-indexed
    (<span class="org-keyword">lambda</span> (step-ids i)
      (format <span class="org-string">"%s { fill: #f6f396; transition: fill %ds; transition-delay: %ds }"</span>
              (mapconcat
               (<span class="org-keyword">lambda</span> (id) (format <span class="org-string">"#slide-%s.present #%s"</span> (car slide) id))
               (split-string step-ids <span class="org-string">","</span>)
               <span class="org-string">", "</span>)
              highlight-duration
              (* i highlight-duration)))
    (split-string (elt slide 1) <span class="org-string">";"</span>))
   <span class="org-string">"\n"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-reveal-svg-highlight-different-colors</span> (slide)
  (<span class="org-keyword">let*</span> ((colors '(<span class="org-string">"#f6f396"</span> <span class="org-string">"#c6c6c6"</span>)) <span class="org-comment-delimiter">; </span><span class="org-comment">reverse</span>
         (steps (split-string (elt slide 1) <span class="org-string">";"</span>))
         (step-length 0.5))
    (string-join
     (seq-map-indexed
      (<span class="org-keyword">lambda</span> (step-ids i)
        (format <span class="org-string">"%s { fill: %s; opacity: 1 !important; transition: fill %.1fs; transition-delay: %.1fs }"</span>
                (mapconcat
                 (<span class="org-keyword">lambda</span> (id) (format <span class="org-string">"#slide-%s.present #%s"</span> (car slide) id))
                 (split-string step-ids <span class="org-string">","</span>)
                 <span class="org-string">", "</span>)
                (elt colors (- (length steps) i 1))
                step-length
                (* i 0.5)))
      steps))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-reveal-svg-progression-css</span> (map-progression <span class="org-type">&amp;optional</span> highlight-duration)
  <span class="org-doc">"Make the CSS.</span>
<span class="org-doc">map-progression should be a list of lists with the following format:</span>
<span class="org-doc">((\"slide-id\" \"prev1,prev2;cur1\" \"id-to-add1,id-to-add2\") ...)."</span>
  (<span class="org-keyword">setq</span> highlight-duration (<span class="org-keyword">or</span> highlight-duration 2))
  (<span class="org-keyword">let</span> (full)
    (format
     <span class="org-string">"&lt;style&gt;%s&lt;/style&gt;"</span>
     (mapconcat
      (<span class="org-keyword">lambda</span> (slide)
        (<span class="org-keyword">setq</span> full (append (split-string (elt slide 2) <span class="org-string">","</span>) full))
        (format <span class="org-string">"#slide-%s.present path { opacity: 0.2 }</span>
<span class="org-string">%s { opacity: 1 !important }</span>
<span class="org-string">%s"</span>
                (car slide)
                (mapconcat (<span class="org-keyword">lambda</span> (id) (format <span class="org-string">"#slide-%s.present #%s"</span> (car slide) id))
                           full
                           <span class="org-string">", "</span>)
                (my-reveal-svg-highlight-different-colors slide)))
      map-progression
      <span class="org-string">"\n"</span>))))
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-finding-sketches" class="outline-4">
<h4 id="finding-sketches">Finding sketches</h4>
<div class="outline-text-4" id="text-finding-sketches">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-sketch-directories</span>
  '(<span class="org-string">"~/sync/sketches"</span>
    <span class="org-string">"~/sync/private-sketches"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-sketch-filenames-between-dates</span> (start end filter)
  <span class="org-doc">"Returns index card filenames between START and END."</span>
  (<span class="org-keyword">setq</span> start (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> start))
  (<span class="org-keyword">setq</span> end (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> end))
  (my-get-sketch-filenames
   (<span class="org-keyword">lambda</span> (filename)
     (<span class="org-keyword">let</span> ((f (replace-regexp-in-string <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">0-9]"</span> <span class="org-string">""</span> (file-name-nondirectory filename))))
       (<span class="org-keyword">and</span> (string&gt; f start)
            (string&gt; end f)
            (<span class="org-keyword">or</span> (not filter) (string-match filter filename)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-sketch-filenames</span> (base <span class="org-type">&amp;optional</span> as-regexp)
  (my-get-image-filenames base as-regexp my-sketch-directories))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-image-filenames</span> (base <span class="org-type">&amp;optional</span> as-regexp directories)
  <span class="org-doc">"Check several directories for files matching BASE.</span>
<span class="org-doc">           Return the matching filenames, if any.</span>
<span class="org-doc">           If AS-REGEXP is non-nil, treat BASE as a regular expression.</span>
<span class="org-doc">           If BASE is a function, use that to filter."</span>
  (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (stringp base) (string-match <span class="org-string">"^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]"</span> base))
    (<span class="org-keyword">setq</span> base (match-string 0 base)))
  (<span class="org-keyword">let</span> ((base-regexp (<span class="org-keyword">unless</span> (functionp base)
                       (concat
                        <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">"</span>
                        (<span class="org-keyword">if</span> as-regexp base (regexp-quote base))
                        <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>
                        <span class="org-string">".*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">tiff</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">svg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span>))))
    (-filter
     (<span class="org-keyword">lambda</span> (o) (not (string-match <span class="org-string">"\\.xmp"</span> o)))
     (sort (-flatten
            (delq nil
                  (mapcar
                   (<span class="org-keyword">lambda</span> (dir)
                     (<span class="org-keyword">and</span> (file-directory-p dir)
                          (<span class="org-keyword">if</span> (functionp base)
                              (-filter base (directory-files dir t <span class="org-string">".*\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">tiff</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">svg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?$"</span>))
                            (directory-files
                             dir t
                             base-regexp))))
                   (<span class="org-keyword">or</span> directories my-image-directories))))
           'string&lt;))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-image-filename</span> (base <span class="org-type">&amp;optional</span> as-regexp directories)
  <span class="org-doc">"Check several directories for files matching BASE.</span>
<span class="org-doc">Return the first matching filename, if any.</span>
<span class="org-doc">If AS-REGEXP is non-nil, treat BASE as a regular expression."</span>
  (<span class="org-keyword">if</span> (file-exists-p base)
      base
    (car (my-get-image-filenames base as-regexp directories))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-sketch-filename</span> (base <span class="org-type">&amp;optional</span> as-regexp)
  (my-get-image-filename base as-regexp my-sketch-directories))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-list-sketches</span> (regexp <span class="org-type">&amp;optional</span> full-filename directories)
  <span class="org-doc">"Return a list of sketch filenames matching REGEXP."</span>
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Filter: "</span>)))
  (<span class="org-keyword">let</span> ((my-sketch-directories (<span class="org-keyword">or</span> directories my-sketch-directories)))
    (funcall (<span class="org-keyword">if</span> (called-interactively-p 'interactive)
                 (<span class="org-keyword">lambda</span> (x) (insert (mapconcat (<span class="org-keyword">lambda</span> (y) (concat <span class="org-string">"- "</span> (org-link-make-string (concat <span class="org-string">"sketchLink:"</span> y)))) x <span class="org-string">"\n"</span>))) 'identity)
             (sort (-uniq
                    (mapcar (<span class="org-keyword">if</span> full-filename 'identity
                              'file-name-nondirectory)
                            (my-get-sketch-filenames regexp t)))
                   'string&gt;))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sketch-rename-recolor" class="outline-4">
<h4 id="sketch-rename-recolor">Renaming and recoloring sketches</h4>
<div class="outline-text-4" id="text-sketch-rename-recolor">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-02-07 Wed]</span></span>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-rename</span> (file)
  (<span class="org-keyword">interactive</span> <span class="org-string">"FFile: "</span>)
  (<span class="org-keyword">let</span> ((data (my-image-recognize file))
        new-id)
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]"</span> data)
      (<span class="org-keyword">setq</span> new-id (match-string 0 data))
      (rename-file file
                   (expand-file-name
                    (concat new-id <span class="org-string">"."</span> (file-name-extension file))
                    (file-name-directory file)))
      (<span class="org-keyword">when</span> (file-exists-p (concat (file-name-sans-extension file) <span class="org-string">".json"</span>))
        (rename-file (concat (file-name-sans-extension file) <span class="org-string">".json"</span>)
                     (expand-file-name
                      (concat new-id <span class="org-string">".json"</span>)
                      (file-name-directory file)))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-sketch-recolor-png</span> (file color-scheme)
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"File: "</span>)
                     (completing-read <span class="org-string">"Scheme: "</span> (mapcar (<span class="org-keyword">lambda</span> (o) (symbol-name (car o)))
                                                         my-sketch-color-map))))
  (call-process <span class="org-string">"/home/sacha/bin/recolor.py"</span> nil nil nil
                <span class="org-string">"--colors"</span>
                (mapconcat
                 (<span class="org-keyword">lambda</span> (row)
                   (concat (car row) <span class="org-string">","</span> (cdr row)))
                 (assoc-default (<span class="org-keyword">if</span> (stringp color-scheme)
                                    (intern color-scheme)
                                  color-scheme)
                                my-sketch-color-map)
                 <span class="org-string">","</span>)
                (expand-file-name file)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org-mode-sketch-links" class="outline-4">
<h4 id="org-mode-sketch-links">Org Mode sketch: links</h4>
<div class="outline-text-4" id="text-org-mode-sketch-links">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-images-in-krita</span> (files)
  (apply 'call-process <span class="org-string">"krita"</span> nil 0 nil <span class="org-string">"--nosplash"</span> files))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-images-in-gwenview</span> (files)
  (apply 'call-process <span class="org-string">"gwenview"</span> nil 0 nil <span class="org-string">"--slideshow"</span> files))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-images-in-feh</span> (files)
  (apply 'call-process <span class="org-string">"feh"</span> nil nil nil <span class="org-string">"-D"</span> <span class="org-string">"1"</span> <span class="org-string">"-F"</span> files))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-image-open</span> (id <span class="org-type">&amp;optional</span> arg directories)
  <span class="org-doc">"Open image named ID.</span>
<span class="org-doc">      If ARG is specified, prompt for application to open it in."</span>
  (<span class="org-keyword">interactive</span> (list
                (completing-read <span class="org-string">"Sketch ID: "</span> (my-list-sketches <span class="org-string">"."</span>))
                (current-prefix-arg)))
  (<span class="org-keyword">let*</span> ((files (mapcar (<span class="org-keyword">lambda</span> (o) (my-get-image-filename o (<span class="org-keyword">or</span> my-image-directories))) (<span class="org-keyword">if</span> (listp id) id (list id))))
         (input (<span class="org-keyword">if</span> arg (read-char <span class="org-string">"(k)rita, (g)wenview, (f)eh: "</span>) ?k)))
    (funcall
     (<span class="org-keyword">cond</span>
      ((eq input ?g) 'my-open-images-in-gwenview)
      ((eq input ?f) 'my-open-images-in-feh)
      (t 'my-open-images-in-krita))
     files)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sketch-edit</span> (id <span class="org-type">&amp;optional</span> arg)
  (my-org-image-open id arg my-sketch-directories))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sketch-open</span> (id <span class="org-type">&amp;optional</span> arg)
  (delete-other-windows)
  (<span class="org-keyword">with-selected-window</span> (split-window-right)
    (find-file (my-get-image-filename
                id my-sketch-directories))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-image-export</span> (link description format info)
  (<span class="org-keyword">let*</span> ((path (concat <span class="org-string">"https://sketches.sachachua.com/filename/"</span> link))
         (image (concat <span class="org-string">"https://sketches.sachachua.com/static/"</span> link))
         (backend (org-export-backend-name (plist-get info <span class="org-builtin">:back-end</span>)))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">cond</span>
     ((eq backend '11ty) (format <span class="org-string">"{%% sketchLink \"%s\", \"%s\" %%}"</span> link desc))
     ((<span class="org-keyword">or</span> (eq format 'html) (eq format 'wp))
      (<span class="org-keyword">if</span> description
          (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc)
        (format <span class="org-string">"&lt;div style=\"text-align: center\"&gt;&lt;a target=\"_blank\" href=\"%s\"&gt;&lt;img src=\"%s\" style=\"max-height: 90vw; height: auto; width: auto\"&gt;&lt;br /&gt;%s&lt;/a&gt;&lt;/div&gt;"</span> path image desc)))
     ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
     ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
     ((eq format 'md)
      (<span class="org-keyword">if</span> (file-exists-p (expand-file-name link <span class="org-string">"~/sketches"</span>))
          (format <span class="org-string">"{{&lt;photo src=\"%s\"&gt;}}"</span> image)
        (format <span class="org-string">"{{&lt;photo nas=\"1\" src=\"%s\"&gt;}}"</span> link)))
     ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
     (t path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-image-export-link</span> (link description format info)
  (<span class="org-keyword">let*</span> ((backend (<span class="org-keyword">if</span> (plist-get info <span class="org-builtin">:backend</span>) (org-export-backend-name (plist-get info <span class="org-builtin">:back-end</span>))
                    format))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">cond</span> ((eq backend 'md)
           (format <span class="org-string">"[%s](%s)"</span> desc link))
          ((eq backend '11ty)
           (format <span class="org-string">"{%% sketchLink \"%s\", \"%s\" %%}"</span> (file-name-base link) desc))
          ((eq backend 'html)
           (format <span class="org-string">"&lt;a href=\"https://sketches.sachachua.com/filename/%s\"&gt;%s&lt;/a&gt;"</span> (file-name-nondirectory link) desc))
          (t (format <span class="org-string">"[[%s][%s]]"</span> link desc)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-image-export-thumb</span> (link description format info)
  (<span class="org-keyword">let*</span> ((path (concat <span class="org-string">"https://sketches.sachachua.com/filename/"</span> link))
         (image (concat <span class="org-string">"https://sketches.sachachua.com/static/"</span> link))
         (backend (org-export-backend-name (plist-get info <span class="org-builtin">:back-end</span>)))
         (desc (replace-regexp-in-string <span class="org-string">"%23"</span> <span class="org-string">"#"</span> (<span class="org-keyword">or</span> description link))))
    (<span class="org-keyword">cond</span>
     ((eq backend '11ty) (format <span class="org-string">"{%% sketchThumb \"%s\", \"%s\" %%}"</span> (file-name-base link) desc))
     ((<span class="org-keyword">or</span> (eq format 'html) (eq format 'wp))
      (<span class="org-keyword">if</span> description
          (format <span class="org-string">"&lt;a target=\"_blank\" href=\"%s\"&gt;%s&lt;/a&gt;"</span> path desc)
        (format <span class="org-string">"&lt;div class=\"sketch-thumbnail\"&gt;&lt;a target=\"_blank\" href=\"%s\"&gt;&lt;img src=\"%s\"&gt;&lt;br /&gt;%s&lt;/a&gt;&lt;/div&gt;"</span> path image desc)))
     ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
     ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
     ((eq format 'md)
      (<span class="org-keyword">if</span> (file-exists-p (expand-file-name link <span class="org-string">"~/sketches"</span>))
          (format <span class="org-string">"{{&lt;photo src=\"%s\"&gt;}}"</span> image)
        (format <span class="org-string">"{{&lt;photo nas=\"1\" src=\"%s\"&gt;}}"</span> link)))
     ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
     (t path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-image-export-full</span> (link description format info)
  (<span class="org-keyword">let*</span> ((path (concat <span class="org-string">"https://sketches.sachachua.com/filename/"</span> link))
         (image (concat <span class="org-string">"https://sketches.sachachua.com/static/"</span> link))
         (backend (org-export-backend-name (plist-get info <span class="org-builtin">:back-end</span>)))
         (desc (<span class="org-keyword">or</span> description link)))
    (<span class="org-keyword">cond</span>
     ((eq backend '11ty) (format <span class="org-string">"{%% sketchFull \"%s\", \"%s\" %%}"</span> link desc))
     ((<span class="org-keyword">or</span> (eq format 'html) (eq format 'wp))
      (<span class="org-keyword">if</span> description
          (format <span class="org-string">"&lt;figure&gt;&lt;a target=\"_blank\" href=\"%s\"&gt;&lt;img src=\"%s\" /&gt;&lt;br /&gt;&lt;/a&gt;&lt;figcaption&gt;%s&lt;/figcaption&gt;&lt;/figure&gt;"</span> path image desc)
        (format <span class="org-string">"&lt;figure&gt;&lt;a target=\"_blank\" href=\"%s\"&gt;&lt;img src=\"%s\" /&gt;&lt;br /&gt;&lt;figcaption&gt;%s&lt;/figcaption&gt;&lt;/a&gt;&lt;/figure&gt;"</span> path image desc)))
     ((eq format 'latex) (format <span class="org-string">"\\href{%s}{%s}"</span> path desc))
     ((eq format 'texinfo) (format <span class="org-string">"@uref{%s,%s}"</span> path desc))
     ((eq format 'md)
      (<span class="org-keyword">if</span> (file-exists-p (expand-file-name link <span class="org-string">"~/sketches"</span>))
          (format <span class="org-string">"{{&lt;photo src=\"%s\"&gt;}}"</span> image)
        (format <span class="org-string">"{{&lt;photo nas=\"1\" src=\"%s\"&gt;}}"</span> link)))
     ((eq format 'ascii) (format <span class="org-string">"%s &lt;%s&gt;"</span> desc path))
     (t path))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sketch-complete</span> (<span class="org-type">&amp;optional</span> prefix)
  (concat <span class="org-string">"sketch:"</span> (file-name-nondirectory (my-complete-sketch-filename))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sketch-complete-full</span> (<span class="org-type">&amp;optional</span> prefix)
  (concat <span class="org-string">"sketchFull:"</span> (file-name-nondirectory (my-complete-sketch-filename))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-image-complete</span> (<span class="org-type">&amp;optional</span> prefix)
  (concat <span class="org-string">"image:"</span>
          (completing-read <span class="org-string">"Image: "</span> (my-list-sketches <span class="org-string">"."</span> nil my-image-directories))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">Based on https://emacs.stackexchange.com/questions/38098/org-mode-custom-youtube-link-syntax</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sketch-preview</span> (start end path bracketp)
  <span class="org-doc">"Include overlays for sketches."</span>
  (<span class="org-keyword">when</span> (display-graphic-p)
    (<span class="org-keyword">let</span> ((filename (my-get-sketch-filename path))
          (refresh nil)
          (link (<span class="org-keyword">save-excursion</span>
                  (goto-char start)
                  (org-element-lineage
                   (<span class="org-keyword">save-match-data</span> (org-element-context))
                   '(link) t)))) <span class="org-comment-delimiter">;; </span><span class="org-comment">set this someday</span>
      (<span class="org-keyword">when</span> (<span class="org-keyword">and</span> (not (org-element-property <span class="org-builtin">:contents-begin</span> link)) filename)
        (<span class="org-keyword">let</span> ((width
               <span class="org-comment-delimiter">;; </span><span class="org-comment">Apply `</span><span class="org-comment"><span class="org-constant">org-image-actual-width</span></span><span class="org-comment">' specifications.</span>
               (<span class="org-keyword">cond</span>
                ((not (image-type-available-p 'imagemagick)) nil)
                ((eq org-image-actual-width t) nil)
                ((numberp org-image-actual-width) org-image-actual-width)
                <span class="org-comment-delimiter">;; </span><span class="org-comment">Pick this up from the paragraph someday</span>
                ))
              (old (get-char-property-and-overlay start 'org-image-overlay)))
          (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (car-safe old) refresh)
              (image-refresh (overlay-get (cdr old) 'display))
            (<span class="org-keyword">let</span> ((image (create-image filename
                                       (<span class="org-keyword">and</span> width 'imagemagick)
                                       nil
                                       <span class="org-builtin">:width</span> width)))
              (<span class="org-keyword">when</span> image
                (<span class="org-keyword">let*</span> ((ov (make-overlay start end)))
                  (overlay-put ov 'display image)
                  (overlay-put ov 'face 'default)
                  (overlay-put ov 'org-image-overlay t)
                  (overlay-put
                   ov 'modification-hooks
                   (list 'org-display-inline-remove-overlay))
                  (<span class="org-keyword">push</span> ov org-inline-image-overlays))))))))))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-image-actual-width 600)
  (org-link-set-parameters
   <span class="org-string">"sketch"</span>
   <span class="org-builtin">:follow</span> 'my-org-sketch-open
   <span class="org-builtin">:export</span> 'my-org-image-export-link
   <span class="org-builtin">:complete</span> 'my-org-sketch-complete
   <span class="org-builtin">:activate-func</span> nil)
  (org-link-set-parameters
   <span class="org-string">"sketchLink"</span>
   <span class="org-builtin">:follow</span> 'my-org-sketch-open
   <span class="org-builtin">:export</span> 'my-org-image-export-link
   <span class="org-builtin">:complete</span> 'my-org-sketch-complete
   <span class="org-builtin">:activate-func</span> nil)
  (org-link-set-parameters
   <span class="org-string">"sketchThumb"</span>
   <span class="org-builtin">:follow</span> 'my-org-sketch-open
   <span class="org-builtin">:export</span> 'my-org-image-export-thumb
   <span class="org-builtin">:complete</span> 'my-org-sketch-complete
   <span class="org-builtin">:activate-func</span> nil)
  (org-link-set-parameters
   <span class="org-string">"sketchFull"</span>
   <span class="org-builtin">:follow</span> 'my-org-sketch-open
   <span class="org-builtin">:export</span> 'my-org-image-export-full
   <span class="org-builtin">:complete</span> 'my-org-sketch-complete-full
   <span class="org-builtin">:activate-func</span> nil))

(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> org-image-actual-width 600)
  (org-link-set-parameters
   <span class="org-string">"image"</span>
   <span class="org-builtin">:follow</span> 'my-org-image-open
   <span class="org-builtin">:export</span> 'my-org-image-export
   <span class="org-builtin">:complete</span> 'my-org-image-complete))

</pre>
</div>
</div>
</div>
<div id="outline-container-org-mode-copy" class="outline-4">
<h4 id="org-mode-copy">Org Mode custom link: copy to clipboard&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h4>
<div class="outline-text-4" id="text-org-mode-copy">
<p>
I have a tiny corporation for my consulting. I do
all of my own paperwork. I have lots of notes in
Org Mode for infrequent tasks like the tax-related
paperwork I do once a year. My notes include
checklists, links, and Org Babel blocks for
calculations. I often need to copy standard text
(ex: the name of the company) or parts of the
output of my Org Babel blocks (ex: tax collected)
so that I can fill in web forms on the Canada
Revenue Agency website.
</p>

<p>
This little snippet makes it easy to copy text for
pasting. It defines a custom Org link that starts
with <code>copy:</code>. When I follow the link by clicking
on it or using <code>C-c C-o</code> (<code>org-open-at-point</code>), it
copies the text to the kill ring (which is what
Emacs calls the clipboard) so that I can paste it
anywhere. For example, <code>[[copy:Hello world]]</code>
becomes a link to copy "Hello world". Copying
means never having to worry about typos or
accidentally selecting only part of the text.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"copy"</span>
   <span class="org-builtin">:follow</span> (<span class="org-keyword">lambda</span> (link) (kill-new link))
   <span class="org-builtin">:export</span> (<span class="org-keyword">lambda</span> (_ desc <span class="org-type">&amp;rest</span> _) desc)))
</pre>
</div>

<p>
I can use these links as part of my checklist so
that I can quickly fill in things like my business
name and other details. I can put sensitive
information like my social insurance number in a
GPG-encrypted file. (Just set up your GPG keys and
end a filename with <code>.gpg</code>, and Emacs will take
care of transparently encrypting and decrypting
the file.)
</p>

<p>
I can also export those links as part of my Org
Babel output. For example, the following code
calculates the numbers I need to fill in a T5 form
for the other-than-eligible dividends that I issue
myself according to the <a href="https://www.canada.ca/en/revenue-agency/services/tax/businesses/topics/completing-slips-summaries/financial-slips-summaries/return-investment-income-t5/t5-slip/completing-t5-slip.html">T5 instructions from the CRA</a>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let*</span> ((box-10 1234) <span class="org-comment-delimiter">; </span><span class="org-comment">fake number for demo</span>
       (box-11 (* 1.15 box-10))
       (box-12 (* 0.090301 box-11)))
  `((box-10 ,(format <span class="org-string">"[[copy:%.2f][%.2f]]"</span> box-10 box-10))
    (box-11 ,(format <span class="org-string">"[[copy:%.2f][%.2f]]"</span> box-11 box-11))
    (box-12 ,(format <span class="org-string">"[[copy:%.2f][%.2f]]"</span> box-12 box-12))))
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-left">box-10</td>
<td class="org-right">1234.00</td>
</tr>

<tr>
<td class="org-left">box-11</td>
<td class="org-right">1419.10</td>
</tr>

<tr>
<td class="org-left">box-12</td>
<td class="org-right">128.15</td>
</tr>
</tbody>
</table>

<p>

</p>

<p>
Hello world
On my computer, the numbers become links that I
can click and copy. Another little shortcut thanks
to Emacs and Org Mode!
</p>
</div>
</div>
<div id="outline-container-config" class="outline-4">
<h4 id="config">Config</h4>
<div class="outline-text-4" id="text-config">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org
  <span class="org-builtin">:config</span>
  (org-link-set-parameters
   <span class="org-string">"config"</span>
   <span class="org-builtin">:follow</span> (<span class="org-keyword">lambda</span> (id) (org-open-link-from-string (format <span class="org-string">"[[~/sync/emacs/Sacha.org::%s]]"</span> id)))
   <span class="org-builtin">:export</span> (<span class="org-keyword">lambda</span> (link description format)
             (format <span class="org-string">"&lt;a href=\"https://sachachua.com/dotemacs#%s\"&gt;%s&lt;/a&gt;"</span> link description))))

</pre>
</div>
</div>
</div>
<div id="outline-container-helm-completion-with-my-helm-org-sketches" class="outline-4">
<h4 id="helm-completion-with-my-helm-org-sketches">Helm completion with my-helm-org-sketches</h4>
<div class="outline-text-4" id="text-helm-completion-with-my-helm-org-sketches">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-source-org-sketch-list</span> ()
  (my-list-sketches <span class="org-string">"."</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-org-insert-sketch-candidates</span> (<span class="org-type">&amp;optional</span> candidates)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (org-insert-link nil (concat <span class="org-string">"sketch:"</span> o))
          (insert <span class="org-string">"\n"</span>))
        (helm-marked-candidates)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-open-sketches-in-krita</span> (<span class="org-type">&amp;optional</span> candidates)
  (my-sketch-open-in-krita (helm-marked-candidates)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-open-sketches-in-gwenview</span> (<span class="org-type">&amp;optional</span> candidates)
  (my-sketch-open-in-gwenview (helm-marked-candidates)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-open-sketches-in-feh</span> (<span class="org-type">&amp;optional</span> candidates)
  (my-sketch-open-in-feh (helm-marked-candidates)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-helm-source-org-sketches</span>
  '((name . <span class="org-string">"Sketches"</span>)
    (candidates . my-helm-source-org-sketch-list)
    (action . ((<span class="org-string">"Insert"</span> . my-helm-org-insert-sketch-candidates)
               (<span class="org-string">"Open in Krita"</span> . my-helm-open-sketches-in-krita)
               (<span class="org-string">"Open in Gwenview"</span> . my-helm-open-sketches-in-gwenview)
               (<span class="org-string">"Open as Feh slideshow"</span> . my-helm-open-sketches-in-feh)))
    (persistent-action . my-helm-open-sketches-in-gwenview)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-org-sketches</span> ()
  (<span class="org-keyword">interactive</span>)
  (helm <span class="org-builtin">:sources</span> '(my-helm-source-org-sketches)
        <span class="org-builtin">:buffer</span> <span class="org-string">"*helm-org-sketches*"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-button-based-interface" class="outline-4">
<h4 id="button-based-interface">Button-based interface</h4>
<div class="outline-text-4" id="text-button-based-interface">
<p>
This makes a buffer with big buttons so that I can easily tap them with my stylus.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-set-up-sketch-buffer</span> ()
  <span class="org-doc">"Populate a widget buffer with a few handy buttons."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Done*"</span>)
    (<span class="org-keyword">let</span> ((inhibit-read-only t))
      (erase-buffer)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-org-clock-in-and-track-by-name <span class="org-string">"Draw"</span>))
                     <span class="org-string">"Track: Draw"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-org-clock-in-and-track-by-name <span class="org-string">"Draw journal entries"</span>))
                     <span class="org-string">"Track: Journal"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-org-sketch-open (my-prepare-index-card-template)))
                     <span class="org-string">"New"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-org-sketch-open (my-prepare-large-template)))
                     <span class="org-string">"New large"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-org-sketch-open (my-prepare-index-card-template nil (org-read-date))))
                     <span class="org-string">"Date"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore) (shell-command <span class="org-string">"~/bin/rotate-screen"</span>)) <span class="org-string">"Rotate"</span>)
      (insert <span class="org-string">"\n"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (shell-command <span class="org-string">"~/bin/add-output-png"</span>))
                     <span class="org-string">"Add output.png"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-rotate-screen 0)
                               (kill-buffer)
                               (my-rename-scanned-cards))
                     <span class="org-string">"Process"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-rotate-screen 0)
                               (delete-window)
                               (my-rename-scanned-cards))
                     <span class="org-string">"Rename"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-rotate-screen 0)
                               (delete-window)
                               (my-convert-and-upload-cards))
                     <span class="org-string">"Upload"</span>)
      (widget-create 'push-button
                     <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> ignore)
                               (my-rotate-screen 0)
                               (org-clock-out)
                               (kill-buffer))
                     <span class="org-string">"Quit"</span>)
      (text-scale-set 10)
      (widget-setup)
      (widget-minor-mode)
      (pop-to-buffer (current-buffer))
      (goto-char (point-min))
      (current-buffer))))

(<span class="org-keyword">setq</span> my-sketch-executable <span class="org-string">"krita"</span>
      my-sketch-inbox-directory <span class="org-string">"~/Dropbox/Inbox"</span>
      my-index-card-template-file <span class="org-string">"~/Dropbox/drawings/templates/0 - index.psd"</span>
      my-sketch-large-template-file <span class="org-string">"/home/sacha/Dropbox/drawings/templates/0 - base.psd"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-index-cards</span> (n)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">or</span> current-prefix-arg 5)))
  (<span class="org-keyword">let</span> ((counter 1)
        (directory <span class="org-string">"~/Dropbox/Inbox"</span>)
        (template my-index-card-template-file)
        (date (substring (org-read-date nil nil <span class="org-string">"."</span>) 0 10))
        temp-file)
    (quantified-track <span class="org-string">"Drawing"</span>)
    (<span class="org-keyword">dotimes</span> (i 5) (my-org-sketch-open (my-prepare-index-card-template)))
    (my-rotate-screen 180)
    (my-set-up-sketch-buffer)))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-index-card-file-name</span> nil <span class="org-doc">"Most recent index card file name."</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-rotate-screen</span> (degrees)
  (<span class="org-keyword">cond</span>
   ((eq system-type 'windows-nt)
    (shell-command (format <span class="org-string">"c:/sacha/Dropbox/bin/orient /rotate:%d"</span> degrees)))
   ((eq system-type 'gnu/linux)
    (shell-command (format <span class="org-string">"~/bin/rotate-screen %s"</span>
                           (<span class="org-keyword">cond</span>
                            ((= degrees 0) <span class="org-string">"normal"</span>)
                            ((= degrees 180) <span class="org-string">"inverted"</span>)
                            ((= degrees 90) <span class="org-string">"left"</span>)
                            ((= degrees 270) <span class="org-string">"right"</span>)))))))

</pre>
</div>
</div>
</div>
<div id="outline-container-templates" class="outline-4">
<h4 id="templates">Templates</h4>
<div class="outline-text-4" id="text-templates">
<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-drawing-template</span> (<span class="org-type">&amp;optional</span> name date template)
  <span class="org-doc">"Create the image file for NAME. Return the new filename."</span>
  (<span class="org-keyword">let*</span> ((date (<span class="org-keyword">or</span> date (substring (org-read-date nil nil <span class="org-string">"."</span>) 0 10)))
         (data (my-journal-post (<span class="org-keyword">or</span> name <span class="org-string">"sketch"</span>) <span class="org-builtin">:Date</span> date)))
    (<span class="org-keyword">setq</span> name (expand-file-name
                (concat (assoc-default 'ZIDString data)
                        (<span class="org-keyword">if</span> name
                            (concat <span class="org-string">" "</span>
                                    (my-convert-sketch-title-to-filename (<span class="org-keyword">or</span> name <span class="org-string">""</span>)))

                              <span class="org-string">""</span>)
                            <span class="org-string">"."</span> (file-name-extension template))
                    <span class="org-string">"~/Dropbox/Inbox"</span>))
    (copy-file (<span class="org-keyword">or</span> template my-index-card-template-file) name)
    name))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-new-index-card-link</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((filename
         (my-prepare-index-card-template)))
    (insert <span class="org-string">"[[sketch:"</span> filename <span class="org-string">"]]\n"</span>)
    (<span class="org-keyword">save-window-excursion</span>
      (my-rotate-screen 180)
      (shell-command
       (concat (shell-quote-argument my-sketch-executable)
               <span class="org-string">" "</span> (shell-quote-argument filename) <span class="org-string">" &amp;"</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-index-card-template</span> (<span class="org-type">&amp;optional</span> name date)
  <span class="org-doc">"Create the image file for NAME. Return the new filename."</span>
  (my-prepare-drawing-template name date my-index-card-template-file))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-large-template</span> (<span class="org-type">&amp;optional</span> name date)
  <span class="org-doc">"Create the image file for NAME. Return the new filename."</span>
  (my-prepare-drawing-template name date my-sketch-large-template-file))


(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-index-card</span> (<span class="org-type">&amp;optional</span> name date)
  <span class="org-doc">"Prepare the index card for NAME.</span>
<span class="org-doc">              Rotate the screen and show a button to un-rotate the screen."</span>
  (<span class="org-keyword">interactive</span> (list (read-string <span class="org-string">"Name: "</span>)
                     (substring (<span class="org-keyword">if</span> current-prefix-arg (org-read-date) (org-read-date nil nil <span class="org-string">"."</span>)) 0 10)))
  (<span class="org-keyword">setq</span> my-index-card-file-name (my-prepare-index-card-template name date))
  (<span class="org-keyword">save-window-excursion</span>
    (my-rotate-screen 180)
    (shell-command
     (concat (shell-quote-argument my-sketch-executable)
             <span class="org-string">" "</span> (shell-quote-argument my-index-card-file-name) <span class="org-string">" &amp;"</span>)))
  (my-set-up-sketch-buffer))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-index-card-for-subtree</span> ()
  <span class="org-doc">"Create an index card template for the current subtree."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((heading (elt (org-heading-components) 4)))
    (<span class="org-keyword">unless</span> (org-entry-get (point) <span class="org-string">"Effort"</span>) (org-set-property <span class="org-string">"Effort"</span> <span class="org-string">"0:15"</span>))
    (<span class="org-keyword">if</span> (derived-mode-p 'org-agenda-mode) (org-agenda-clock-in) (org-clock-in))
    (my-org-quantified-track <span class="org-string">"Drawing"</span>)
    (<span class="org-keyword">if</span> (org-at-heading-p) (forward-line 1))
    (my-prepare-index-card heading)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-org-prepare-index-card-for-subtree</span> (candidate)
  (<span class="org-keyword">let</span> ((location (org-refile--get-location candidate my-helm-org-refile-locations)))
    (<span class="org-keyword">save-window-excursion</span>
      (<span class="org-keyword">save-excursion</span>
        (org-refile 4 nil location)
        (my-prepare-index-card-for-subtree)) <span class="org-warning">t)))</span>




</pre>
</div>
</div>
</div>
<div id="outline-container-easily-backfill-my-journal" class="outline-4">
<h4 id="easily-backfill-my-journal">Easily backfill my journal</h4>
<div class="outline-text-4" id="text-easily-backfill-my-journal">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-draw-journal-entry</span> (date)
  <span class="org-doc">"Creates a blank journal entry for DATE and brings up the log."</span>
  (<span class="org-keyword">interactive</span> (list (org-read-date)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Open the Quantified Awesome time log for that date</span>
  (<span class="org-keyword">let</span> ((filename (my-get-journal-entry date))
        (day (format-time-string <span class="org-string">"%A"</span> (org-time-string-to-time date))))
    (<span class="org-keyword">if</span> filename
        (my-org-sketch-open filename)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">(browse-url (format "http://quantifiedawesome.com/records?start=%s&amp;end=%s"</span>
      <span class="org-comment-delimiter">;;                     </span><span class="org-comment">date</span>
      <span class="org-comment-delimiter">;;                     </span><span class="org-comment">(format-time-string</span>
      <span class="org-comment-delimiter">;;                      </span><span class="org-comment">"%Y-%m-%d"</span>
      <span class="org-comment-delimiter">;;                      </span><span class="org-comment">(seconds-to-time</span>
      <span class="org-comment-delimiter">;;                       </span><span class="org-comment">(+ (org-time-string-to-seconds date) 86400)))))</span>
      (<span class="org-keyword">setq</span> filename
            (my-prepare-index-card-template (concat day <span class="org-string">" #daily #journal"</span>) date))
      (my-org-sketch-open filename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-journal-entry</span> (date)
  <span class="org-doc">"Returns the filename for the journal sketch for DATE."</span>
  (car
   (-filter (<span class="org-keyword">lambda</span> (x) (not (string-match <span class="org-string">"weekly"</span> x)))
            (my-get-sketch-filenames
             (format <span class="org-string">"%s.* .*#daily"</span> date)
             t))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-missing-journal-dates</span> (start-date end-date)
  <span class="org-doc">"Return a list of dates missing journal entries.</span>
<span class="org-doc">      Range is specified by START-DATE (inclusive) and END-DATE (exclusive)."</span>
  (<span class="org-keyword">let*</span> ((current-day (org-time-string-to-absolute end-date))
         (start-day (org-time-string-to-absolute start-date))
         current-date
         current-date-string
         missing-list)
    (<span class="org-keyword">while</span> (&gt;= current-day start-day)
      (<span class="org-keyword">setq</span> current-date (calendar-gregorian-from-absolute current-day))
      (<span class="org-keyword">setq</span> current-date-string (format <span class="org-string">"%04d-%02d-%02d"</span> (elt current-date 2) (elt current-date 0) (elt current-date 1)))
      (<span class="org-keyword">unless</span> (my-get-journal-entry current-date-string)
        (add-to-list 'missing-list current-date-string))
      (<span class="org-keyword">setq</span> current-day (1- current-day)))
    missing-list))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-show-missing-journal-entries</span> (since)
  (<span class="org-keyword">interactive</span> (list (<span class="org-keyword">if</span> current-prefix-arg (org-read-date) (org-read-date nil nil <span class="org-string">"-7"</span>))))
  (<span class="org-keyword">let</span> ((missing-dates (my-get-missing-journal-dates since (org-read-date nil nil <span class="org-string">"."</span>))))
    (<span class="org-keyword">with-current-buffer</span> (my-set-up-sketch-buffer)
      (mapc
       (<span class="org-keyword">lambda</span> (date)
         (widget-create 'push-button
                        <span class="org-builtin">:date</span> date
                        <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (widget <span class="org-type">&amp;rest</span> ignore)
                                  (my-draw-journal-entry (plist-get (cdr widget) <span class="org-builtin">:date</span>)))
                        date))
       missing-dates)
      (widget-setup)
      (widget-minor-mode))))
</pre>
</div>
</div>
</div>
<div id="outline-container-rename-scanned-index-cards" class="outline-4">
<h4 id="rename-scanned-index-cards">Rename scanned index cards</h4>
<div class="outline-text-4" id="text-rename-scanned-index-cards">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> s)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-process-tiff</span> (files)
  <span class="org-doc">"Convert, display, rename, and upload FILES."</span>
  (<span class="org-keyword">interactive</span> (list (dired-get-marked-files)))
  (<span class="org-keyword">unless</span> (listp files) (<span class="org-keyword">setq</span> files (list files)))
  (<span class="org-keyword">save-window-excursion</span>
    (apply 'call-process <span class="org-string">"mogrify"</span> nil nil nil (append (list <span class="org-string">"-format"</span> <span class="org-string">"png"</span> <span class="org-string">"-quality"</span> <span class="org-string">"1"</span>) files))
    (delete-other-windows)
    (<span class="org-keyword">setq</span> files
          (mapcar
           (<span class="org-keyword">lambda</span> (filename)
             (find-file (<span class="org-keyword">setq</span> filename (s-append <span class="org-string">".png"</span> (s-chop-suffix <span class="org-string">".tif"</span> filename))))
             (<span class="org-keyword">let</span> ((new-name
                    (read-string <span class="org-string">"New name: "</span>
                                 (concat
                                  (<span class="org-keyword">if</span> (string-match <span class="org-string">"/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> ?.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\.png"</span> filename)
                                      (match-string 1 filename)
                                    filename)
                                  <span class="org-string">" "</span>))))
               (rename-file filename (concat new-name <span class="org-string">".png"</span>))
               (<span class="org-keyword">setq</span> filename (expand-file-name (concat new-name <span class="org-string">".png"</span>) (file-name-directory filename)))))
           files)))
  (find-file <span class="org-string">"~/Dropbox/Public/sharing/index.org"</span>)
  (goto-char (point-min))
  (<span class="org-keyword">when</span> (re-search-forward (regexp-quote <span class="org-string">"#+ORGLST: sketchinbox"</span>))
    (forward-line 1)
    (org-end-of-item-list)
    (apply 'call-process <span class="org-string">"up"</span> nil t nil files)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-convert-index-card-to-png</span> (o)
  (<span class="org-keyword">lambda</span> (o)
    (call-process <span class="org-string">"krita"</span> nil nil nil o <span class="org-string">"--export"</span> <span class="org-string">"--export-filename"</span>
                  (concat (file-name-sans-extension o) <span class="org-string">".png"</span>))
    (rename-file o <span class="org-string">"~/Dropbox/Inbox/backup/"</span> t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-convert-index-card-tiffs-to-pngs</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((pattern <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">IMG</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.*.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">tif</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span>))
    (<span class="org-keyword">when</span> (directory-files <span class="org-string">"~/Dropbox/Inbox/"</span> t pattern)
      <span class="org-comment-delimiter">;; </span><span class="org-comment">Convert the TIFFs first</span>
      (mapc 'my-convert-index-card-to-png
            (directory-files <span class="org-string">"~/Dropbox/Inbox/"</span> t pattern)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-convert-and-upload-cards</span> ()
  <span class="org-doc">"Trust in existing filenames, upload without modification."</span>
  (<span class="org-keyword">interactive</span>)
  (my-convert-index-card-tiffs-to-pngs)
  (my-upload-scanned-cards))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-rename-scanned-card</span> (filename)
  (find-file filename)
  (delete-other-windows)
  (<span class="org-keyword">let</span> ((base (file-name-sans-extension filename))
        notes)
    (<span class="org-keyword">when</span> (string-match <span class="org-string">"/IMG.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> ?.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> base)
      (<span class="org-keyword">let</span> ((kill-buffer-query-functions nil)
            old-name
            (new-name (read-string <span class="org-string">"New name: "</span>
                                   (<span class="org-keyword">if</span> (match-string 1 base)
                                       (concat (match-string 1 base))
                                     <span class="org-string">""</span>))))
        (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (string-match <span class="org-string">"^[0-9]+-[0-9]+-[0-9]+[a-z]"</span> new-name)
                    (<span class="org-keyword">setq</span> old-name (my-get-sketch-filename (match-string 0 new-name)))
                    (<span class="org-keyword">and</span> old-name
                         (not (string= old-name filename))
                         (not (string= (file-name-nondirectory old-name)
                                       (concat (s-trim new-name) <span class="org-string">"."</span> (file-name-extension filename))))))
          (<span class="org-keyword">setq</span> new-name
                (read-string (format <span class="org-string">"Already exists (%s) - new name: "</span> old-name)
                             new-name)))
        (<span class="org-keyword">when</span> (string-match new-name <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> *| *</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
          (<span class="org-keyword">with-current-buffer</span> (find-file <span class="org-string">"~/sync/orgzly/Inbox.org"</span>)
            (goto-char (point-max))
            (insert <span class="org-string">"\n* "</span> (match-string 1 new-name) <span class="org-string">"\n"</span> (match-string 2 new-name))
            (save-buffer))
          (<span class="org-keyword">setq</span> new-name (match-string 1 new-name)))
        (<span class="org-keyword">when</span> (&gt; (length new-name) 0)
          (revert-buffer t t)
          (rename-file filename (concat (s-trim new-name) <span class="org-string">"."</span> (file-name-extension filename)) t)
          (kill-buffer))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-rename-scanned-cards</span> ()
  <span class="org-doc">"Display and rename the scanned or saved files."</span>
  (<span class="org-keyword">interactive</span>)
  (my-convert-index-card-tiffs-to-pngs)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (<span class="org-keyword">when</span> (string= (file-name-extension o) <span class="org-string">"psd"</span>)
            (my-convert-index-card-to-png o)
            (<span class="org-keyword">setq</span> o (concat (file-name-sans-extension o) <span class="org-string">".png"</span>)))
          (my-rename-scanned-card o))
        (reverse (directory-files <span class="org-string">"~/Dropbox/Inbox/"</span> t <span class="org-string">"^</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">IMG</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">.*.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">psd</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)))
  (my-upload-scanned-cards))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-clean-index-card-directory</span> ()
  <span class="org-doc">"Remove files marked for deletion and move private files."</span>
  (shell-command <span class="org-string">"mv ~/Dropbox/Inbox/*delete* ~/Dropbox/Inbox/backup"</span>)
  (shell-command <span class="org-string">"mv ~/Dropbox/Inbox/*private* ~/cloud/private-sketches/"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-upload-scanned-cards</span> ()
  (<span class="org-keyword">interactive</span>)
  (my-clean-index-card-directory)
  (<span class="org-keyword">with-current-buffer</span> (get-buffer-create <span class="org-string">"*Files to be uploaded*"</span>)
    (erase-buffer)
    (insert (mapconcat 'identity (directory-files <span class="org-string">"~/Dropbox/Inbox"</span> nil <span class="org-string">"^[0-9]+-[0-9]+-[0-9]+[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> ]? .*.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>) <span class="org-string">"\n"</span>))
    (goto-char (point-min))
    (switch-to-buffer (current-buffer))
    (delete-other-windows))
  (shell-command <span class="org-string">"~/bin/copy-sketches"</span>))
</pre>
</div>

<p>
I might tweak the files a little more after I rename them, so I don't
automatically upload them. When I'm happy with the files, I use a <a href="http://sachachua.com/blog/?p=27830&amp;shareadraft=baba27830_54b92ac511e86">Node
script</a> to upload the files to Flickr, move them to my <code>To blog</code>
directory, and copy Org-formatted text that I can paste into my
learning outline.
</p>
</div>
</div>
<div id="outline-container-automatically-resize-images" class="outline-4">
<h4 id="automatically-resize-images">Automatically resize images</h4>
<div class="outline-text-4" id="text-automatically-resize-images">
<p>
The <code>image+</code> package is handy for displaying the images so
that they're scaled to the window size.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> image+
  <span class="org-builtin">:if</span> my-laptop-p
  <span class="org-comment-delimiter">;;    </span><span class="org-comment">:load-path "~/elisp/Emacs-imagex"</span>
  <span class="org-builtin">:commands</span> (imagex-global-sticky-mode imagex-auto-adjust-mode)
  <span class="org-builtin">:init</span> (<span class="org-keyword">progn</span> (imagex-global-sticky-mode) (imagex-auto-adjust-mode)))
</pre>
</div>
</div>
</div>
<div id="outline-container-get-information-for-sketched-books" class="outline-4">
<h4 id="get-information-for-sketched-books">Get information for sketched books</h4>
<div class="outline-text-4" id="text-get-information-for-sketched-books">
<p>
For sketchnotes of books, I set up the filename based on properties in
my Org Mode tree for that book.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-sketchnote-file</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((base-name (org-entry-get-with-inheritance  <span class="org-string">"BASENAME"</span>)))
    (<span class="org-keyword">unless</span> base-name (<span class="org-warning">error</span> <span class="org-string">"Missing basename property"</span>))
    (my-org-sketch-open (my-prepare-large-template base-name))))
</pre>
</div>

<p>
By using Emacs Lisp functions to set up files that I'm going to use in
an external application, I minimize fussing about with the keyboard
while still being able to take advantage of structured information.
</p>

<p>
Do you work with external applications? Where does it make sense to
use Emacs Lisp to make setup or processing easier?
</p>
</div>
</div>
<div id="outline-container-make-it-easy-to-follow-up-on-a-sketch" class="outline-4">
<h4 id="make-it-easy-to-follow-up-on-a-sketch">Make it easy to follow up on a sketch</h4>
<div class="outline-text-4" id="text-make-it-easy-to-follow-up-on-a-sketch">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-follow-up-on-sketch</span> (filename)
  <span class="org-doc">"Prompt for FILENAME to follow up on.</span>
<span class="org-doc">      Create an index card with it as a layer, and add the ref to the filename."</span>
  (<span class="org-keyword">interactive</span> (list (helm-read-file-name <span class="org-string">"Image: "</span> <span class="org-builtin">:initial-input</span> <span class="org-string">"~/sketches/"</span>)))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Allow the specification of a short identifier</span>
  (<span class="org-keyword">unless</span> (file-exists-p filename)
    (<span class="org-keyword">setq</span> filename (car (directory-files <span class="org-string">"~/sketches"</span> t (concat <span class="org-string">"^"</span> filename)))))
  (<span class="org-keyword">let</span> ((async-shell-command-buffer 'new-buffer)
        (index-card (my-prepare-index-card-template
                     (format <span class="org-string">"-- index card ref %s"</span>
                             (<span class="org-keyword">and</span> (string-match <span class="org-string">"^[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string"> \\.]+"</span> (file-name-nondirectory filename))
                                  (match-string 0 (file-name-nondirectory filename)))))))
    (shell-command (format <span class="org-string">"convert %s %s -colorspace cmyk %s"</span>
                           (shell-quote-argument (expand-file-name my-index-card-template-file))
                           (shell-quote-argument (expand-file-name filename))
                           (shell-quote-argument (expand-file-name index-card))))
    (shell-command (format <span class="org-string">"%s %s &amp;"</span>
                           (shell-quote-argument my-sketch-executable)
                           (shell-quote-argument (expand-file-name index-card))))
    (my-rotate-screen 180)
    (my-set-up-sketch-buffer)))
</pre>
</div>
</div>
</div>
<div id="outline-container-digital-index-piles-with-emacs" class="outline-4">
<h4 id="digital-index-piles-with-emacs">Digital index piles with Emacs</h4>
<div class="outline-text-4" id="text-digital-index-piles-with-emacs">
<p>
Somewhat daunted by the prospect of categorizing more than a hundred
sketches and blog posts for my monthly review, I spent some time
figuring out how to create the digital equivalent of sorting index
cards into various piles.
</p>

<p>
<a href="https://www.flickr.com/photos/sachac/16234413499/">2015-02-01 Digital piles of index cards &#x2013; index card #indexing #organization #pkm</a>
</p>

<p>
In fact, wouldn't it be super-cool if the items could automatically
guess which category they should probably go in, prompting me only if
it wasn't clear?
</p>

<p>
I wanted to write a function that could take a list structured like this:
</p>

<ul class="org-ul">
<li>Keyword A
<ul class="org-ul">
<li>Previous links</li>
</ul></li>
<li>Keyword B
<ul class="org-ul">
<li>Previous links</li>
</ul></li>
<li>Link 1 with Keyword A</li>
<li>Link 2 with Keyword B</li>
<li>Link 3 with Keyword A</li>
<li><p>
Link 4
</p>

<p>
It should file Link 1 and 3 under Keyword A, Link 2 under Keyword B,
and prompt me for the category for Link 4. At that prompt, I should be
able to select Keyword A or Keyword B, or specify a new category.
</p>

<p>
Inspired by John Kitchin's recent post on <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/01/24/Anatomy-of-a-helm-source/">defining a Helm source</a>, I
wanted to get it to work with Helm.
</p>

<p>
First step: I needed to figure out the structure of the list, maybe
including a sample from the category to make it clearer what's
included. <code>org-list.el</code> seemed to have useful functions for this.
<code>org-list-struct</code> gave me the structure of the current list. Let's say
that a category is anything whose text does not match
<code>org-link-bracket-re</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-get-list-categories</span> ()
  <span class="org-doc">"Return a list of (category indent matching-regexp sample).</span>
<span class="org-doc">        List categories are items that don't contain links."</span>
  (<span class="org-keyword">let</span> ((list (org-list-struct)) last-category results)
    (<span class="org-keyword">save-excursion</span>
      (mapc
       (<span class="org-keyword">lambda</span> (x)
         (goto-char (car x))
         (<span class="org-keyword">let</span> ((current-item
                (buffer-substring-no-properties
                 (+ (point)
                    (elt x 1)
                    (length (elt x 2)))
                 (line-end-position))))
           (<span class="org-keyword">if</span> (string-match
                org-link-bracket-re
                (buffer-substring-no-properties
                 (point)
                 (line-end-position)))
               <span class="org-comment-delimiter">;; </span><span class="org-comment">Link - update the last category</span>
               (<span class="org-keyword">when</span> last-category
                 (<span class="org-keyword">if</span> (&lt; (elt x 1) (elt last-category 1))
                     (<span class="org-keyword">setq</span> results
                           (cons (append last-category
                                         (list
                                          (match-string-no-properties
                                           3
                                           (buffer-substring-no-properties
                                            (point)
                                            (line-end-position)))))
                                 (cdr results))))
                 (<span class="org-keyword">setq</span> last-category nil))
             <span class="org-comment-delimiter">;; </span><span class="org-comment">Category</span>
             (<span class="org-keyword">setq</span> results
                   (cons
                    (<span class="org-keyword">setq</span> last-category
                          (list
                           current-item
                           (elt x 1)
                           (concat <span class="org-string">"^"</span>
                                   (make-string (elt x 1) ?\ )
                                   (regexp-quote
                                    (concat (elt x 2)
                                            current-item))
                                   <span class="org-string">"$"</span>)))
                    results)))))
       list))
    (append '((<span class="org-string">"x"</span> 2 <span class="org-string">"^$"</span> nil)) results)))
</pre>
</div>

<p>
The next step was to write a function that guessed the list category
based on the item text, and moved the item there.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-helm-org-list-candidates</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-helm-org-list-categories-init-candidates</span> ()
  <span class="org-doc">"Return a list of categories from this list in a form ready for Helm."</span>
  (<span class="org-keyword">setq</span> my-helm-org-list-candidates
        (mapcar (<span class="org-keyword">lambda</span> (x)
                  (cons (<span class="org-keyword">if</span> (elt x 3)
                            (format <span class="org-string">"%s - %s"</span> (car x) (elt x 3))
                          (car x))
                        x))
                (my-org-get-list-categories))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-move-current-item-to-category</span> (category)
    <span class="org-doc">"Move current list item under CATEGORY earlier in the list.</span>
<span class="org-doc">  CATEGORY can be a string or a list of the form (text indent regexp).</span>
<span class="org-doc">  Point should be on the next line to process, even if a new category</span>
<span class="org-doc">  has been inserted."</span>
    (<span class="org-keyword">interactive</span> (list (completing-read <span class="org-string">"Category: "</span> (my-org-get-list-categories))))
    (<span class="org-keyword">when</span> category
      (<span class="org-keyword">let*</span> ((col (current-column))
             (item (point-at-bol))
             (struct (org-list-struct))
             (category-text (<span class="org-keyword">if</span> (stringp category) category (elt category 0)))
             (category-indent (<span class="org-keyword">if</span> (stringp category) 2 (+ 2 (elt category 1))))
             (category-regexp (<span class="org-keyword">if</span> (stringp category) category (elt category 2)))
             (pos (point))
             s)
        (<span class="org-keyword">setq</span> s (org-remove-indentation (buffer-substring-no-properties item (org-list-get-item-end item struct))))
        (<span class="org-keyword">save-excursion</span>
          (<span class="org-keyword">if</span> (string= category-text <span class="org-string">"x"</span>)
              (org-list-send-item item 'delete struct)
            (goto-char (caar struct))
            (<span class="org-keyword">if</span> (re-search-forward category-regexp nil t)
                (<span class="org-keyword">progn</span>
                  <span class="org-comment-delimiter">;; </span><span class="org-comment">needs a patch to ol.el to check if stringp</span>
                  (org-list-send-item item (point-at-bol) struct)
                  (org-move-item-down)
                  (org-indent-item))
              (goto-char (car (last (car (last struct)))))
              (org-list-insert-item
               (point-at-bol)
               struct (org-list-prevs-alist struct))
              (<span class="org-keyword">let</span> ((old-struct (copy-tree struct)))
                (org-list-set-ind (point-at-bol) struct 0)
                (org-list-struct-fix-bul struct (org-list-prevs-alist struct))
                (org-list-struct-apply-struct struct old-struct))
              (goto-char (point-at-eol))
              (insert category-text)
              (org-list-send-item item 'end struct)
              (org-indent-item)
              (org-indent-item))
            (recenter))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-guess-list-category</span> (<span class="org-type">&amp;optional</span> categories)
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">require</span> '<span class="org-constant">cl-lib</span>)
  (<span class="org-keyword">unless</span> categories
    (<span class="org-keyword">setq</span> categories
          (my-helm-org-list-categories-init-candidates)))
  (<span class="org-keyword">let*</span> ((beg (line-beginning-position))
         (end (line-end-position))
         (string (buffer-substring-no-properties beg end))
         (found
          (cl-member string
                     categories
                     <span class="org-builtin">:test</span>
                     (<span class="org-keyword">lambda</span> (string cat-entry)
                       (<span class="org-keyword">unless</span> (string= (car cat-entry) <span class="org-string">"x"</span>)
                         (string-match (regexp-quote (downcase (car cat-entry)))
                                       string))))))
    (<span class="org-keyword">when</span> (car found)
      (my-org-move-current-item-to-category
       (cdr (car found)))
      t)))
</pre>
</div>

<p>
After that, I wrote a function that used Helm to prompt me for a
category in case it couldn't guess the category. It took me a while to
figure out that I needed to use <code>:init</code> instead of <code>:candidates</code>
because I wanted to read information from the buffer before Helm
kicked in.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-browse-link-while-categorizing</span> 'eww-readable
  <span class="org-doc">"Set to nil to skip browsing."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-guess-uncategorized</span> ()
  <span class="org-doc">"Interactively move linked list items to categories from the list.</span>
<span class="org-doc">        Try to guess categories based on substring matches."</span>
  (<span class="org-keyword">interactive</span>)
                                        <span class="org-comment-delimiter">;</span><span class="org-comment">(my-helm-org-list-categories-init-candidates)</span>
  (<span class="org-keyword">let</span> ((categories (my-org-get-list-categories))
        category)
    (<span class="org-keyword">while</span> (<span class="org-keyword">and</span> (looking-at <span class="org-string">"^[-+] \\[\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
                (not (string= <span class="org-string">"done"</span> category)))
      (<span class="org-keyword">save-excursion</span>
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(when (eq my-org-browse-link-while-categorizing 'eww-readable)</span>
        <span class="org-comment-delimiter">;;   </span><span class="org-comment">(save-excursion (save-match-data (my-eww-browse-readable (match-string 1)))))</span>
        (<span class="org-keyword">setq</span> category (completing-read (match-string 2) categories))
        (<span class="org-keyword">unless</span> (string= category <span class="org-string">"done"</span>)
          (my-org-move-current-item-to-category category))))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">From https://emacs.stackexchange.com/questions/36284/how-to-open-eww-in-readable-mode/47757</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-eww-readable-nonce</span> ()
  <span class="org-doc">"Once-off call to `</span><span class="org-doc"><span class="org-constant">eww-readable</span></span><span class="org-doc">' after EWW is done rendering."</span>
  (<span class="org-keyword">unwind-protect</span>
      (eww-readable)
    (remove-hook 'eww-after-render-hook #'my-eww-readable-nonce)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-eww-browse-readable</span> (url)
  (<span class="org-keyword">when</span> (looking-at <span class="org-string">"^[-+] \\[\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span>)
    (add-hook 'eww-after-render-hook #'my-eww-readable-nonce)
    (eww (match-string 1))))

</pre>
</div>

<p>
Actually, it might be helpful to be able to sort lists by a keyword.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-sort-list-by-regexp</span> (regexp)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MRegexp: "</span>)
  (<span class="org-keyword">let</span> ((sort-func
         (<span class="org-keyword">lambda</span> ()
           (<span class="org-keyword">let</span> ((line (buffer-substring-no-properties (point) (line-end-position))))
             (<span class="org-keyword">if</span> (string-match regexp line)
                 (<span class="org-keyword">if</span> (string-match org-link-bracket-re line)
                     (match-string 2 line)
                   <span class="org-string">"ZZZ"</span>)
               <span class="org-string">"ZZZZZ"</span>)))))
    (funcall
     (<span class="org-keyword">cond</span>
      ((org-at-table-p) 'org-table-sort-lines)
      ((org-at-item-p) 'org-sort-list)
      (t 'org-sort-entries))
     nil ?f sort-func (<span class="org-keyword">lambda</span> (a b) (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> (stringp a) (stringp b)) (string&lt; a b) t)))))
</pre>
</div>

<p>
This one files sketches into the headings I've started using in questions.org.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-refile-sketches-to-questions</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">while</span> (looking-at <span class="org-string">"^  \\+ \\[\\[</span><span class="org-string"><span class="org-constant">.*?\\</span></span><span class="org-string">]\\[</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> -- </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">\\]\\]\n"</span>)
    (<span class="org-keyword">let</span> ((link (match-string 0))
          (title (match-string 1)))
      (<span class="org-keyword">save-excursion</span>
        (<span class="org-keyword">if</span> (<span class="org-keyword">save-match-data</span> (search-forward (concat <span class="org-string">"* "</span> title) nil t))
            (<span class="org-keyword">progn</span> (forward-line) (insert (match-string 0)) (replace-match <span class="org-string">""</span>))
          (forward-line 1))))))
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-xournalpp-and-krita" class="outline-4">
<h4 id="xournalpp-and-krita">Xournalpp and Krita</h4>
<div class="outline-text-4" id="text-xournalpp-and-krita">
<p>
Let's try xournal++.
</p>


<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> org-krita
  <span class="org-builtin">:ensure</span> t
  <span class="org-builtin">:quelpa</span> (org-krita <span class="org-builtin">:fetcher</span> github <span class="org-builtin">:repo</span> <span class="org-string">"lepisma/org-krita"</span> <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span> <span class="org-string">"resources"</span>))
  <span class="org-builtin">:hook</span> (org-mode . org-krita-mode))
(<span class="org-keyword">use-package</span> org-xournalpp
  <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:quelpa</span> (org-xournalpp <span class="org-builtin">:fetcher</span> gitlab <span class="org-builtin">:repo</span> <span class="org-string">"vherrmann/org-xournalpp"</span> <span class="org-builtin">:files</span> (<span class="org-string">"*.el"</span> <span class="org-string">"resources"</span>))
  <span class="org-builtin">:hook</span> (org-mode . org-xournalpp-mode))
</pre>
</div>

<p>
I think I prefer Krita because I'm more used to cropping with it.
Xournal++ uses vectors and makes it easier to insert space when
drawing notebook-style stuff, so that might be interesting too. I
probably want to write something that converts it to PNG for export.
</p>
</div>
</div>
<div id="outline-container-insert-point" class="outline-4">
<h4 id="insert-point">Sketched books</h4>
<div class="outline-text-4" id="text-insert-point">
<p>
Convenience functions to make my life easier when sketchnoting books.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">setq</span> yas-indent-line 'fixed)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-convert-sketch-title-to-filename</span> (text)
  (<span class="org-keyword">setq</span> text (replace-regexp-in-string <span class="org-string">"[?!]$"</span> <span class="org-string">""</span> text))
  (<span class="org-keyword">setq</span> text (replace-regexp-in-string <span class="org-string">"[?!:] "</span> <span class="org-string">" - "</span> text)))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-convert-sketch-title-to-filename</span> ()
  (should (string= (my-convert-sketch-title-to-filename <span class="org-string">"Test"</span>) <span class="org-string">"Test"</span>))
  (should (string= (my-convert-sketch-title-to-filename <span class="org-string">"Another Test!"</span>) <span class="org-string">"Another Test"</span>))
  (should (string= (my-convert-sketch-title-to-filename <span class="org-string">"Does this work? Yes"</span>) <span class="org-string">"Does this work - Yes"</span>))
  (should (string= (my-convert-sketch-title-to-filename <span class="org-string">"Title: Subtitle"</span>) <span class="org-string">"Title - Subtitle"</span>))
  )

(<span class="org-keyword">defun</span> <span class="org-function-name">my-convert-sketched-book-to-png</span> ()
  <span class="org-doc">"Convert TIFF to PNG."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((basename (org-entry-get-with-inheritance <span class="org-string">"BASENAME"</span>)))
    (shell-command (format <span class="org-string">"convert \"c:/sacha/dropbox/inbox/%s.tif\" \"c:/sacha/dropbox/inbox/%s.png\""</span>
                           basename
                           basename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-index-sketched-book</span> ()
  <span class="org-doc">"Add entries to sketched books index."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let*</span> ((title (org-entry-get-with-inheritance <span class="org-string">"SHORT_TITLE"</span>))
         (author (org-entry-get-with-inheritance <span class="org-string">"AUTHOR"</span>))
         (basename (org-entry-get-with-inheritance <span class="org-string">"BASENAME"</span>))
         (base-file (format <span class="org-string">"~/Dropbox/Inbox/%s.png"</span> basename)))
    (<span class="org-keyword">when</span> (file-exists-p base-file)
      (copy-file base-file
                 (format <span class="org-string">"~/Dropbox/Packaging/sketched-books/%s.png"</span> basename) t t))
    (find-file <span class="org-string">"~/Dropbox/Packaging/sketched-books/index.org"</span>)
    (vc-git-register (list (format <span class="org-string">"%s.png"</span> basename)))
    (goto-char (point-min))
    (re-search-forward <span class="org-string">"&lt;&lt;insert-point&gt;&gt;"</span>)
    (insert (format <span class="org-string">"\n- [[file:%s.png][%s - %s (sketched %s)]]\n  [[file:%s.png]]\n\n"</span>
                    basename
                    title
                    author
                    (substring basename 0 10)
                    basename))
    (find-file <span class="org-string">"~/Dropbox/Packaging/sketched-books/ebook.org"</span>)
    (goto-char (point-min))
    (re-search-forward <span class="org-string">"&lt;&lt;insert-point&gt;&gt;"</span>)
    (insert (format <span class="org-string">"\n* %s - %s (sketched %s)\n\n[[file:%s.png]]\n\n"</span>
                    title
                    author
                    (substring basename 0 10)
                    basename))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-package-sketched-book</span> ()
  <span class="org-doc">"Add the latest sketch and package the collection."</span>
  (<span class="org-keyword">interactive</span>)
  (shell-command
   (format <span class="org-string">"plink -A vagrant@127.0.0.1 -P 2222 \"cd ~/Dropbox/Packaging/sketched-books; git add '</span><span class="org-string"><span class="org-constant">%s.png</span></span><span class="org-string">'; git commit -m 'Added %s - %s' -a; git push; make all\" &amp;"</span>
           (org-entry-get-with-inheritance <span class="org-string">"BASENAME"</span>)
           (org-entry-get-with-inheritance <span class="org-string">"SHORT_TITLE"</span>)
           (org-entry-get-with-inheritance <span class="org-string">"AUTHOR"</span>))))

</pre>
</div>
</div>
</div>
<div id="outline-container-other-sketches" class="outline-4">
<h4 id="other-sketches">Other sketches</h4>
<div class="outline-text-4" id="text-other-sketches">
<p>
Based on <a href="http://williamedwardscoder.tumblr.com/post/84505278488/making-image-mosaics">http://williamedwardscoder.tumblr.com/post/84505278488/making-image-mosaics</a>
Aspect ratio is width / height
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-tile-dimensions</span> (num-items orig-width orig-height target-aspect-ratio)
  (<span class="org-keyword">let</span> ((rows 1) (cols 1)
        (current-aspect (/ orig-width (float orig-height)))
        add-col-aspect
        add-row-aspect)
    (<span class="org-keyword">while</span> (&lt; (* rows cols) num-items)
      (<span class="org-keyword">setq</span> add-col-aspect (/ (* (1+ cols) (float orig-width))
                              (* rows orig-height))
            add-row-aspect (/ (* cols (float orig-width))
                              (* (1+ rows) orig-height)))
      (<span class="org-keyword">if</span> (&lt;  (abs (- add-col-aspect target-aspect-ratio))
              (abs (- add-row-aspect target-aspect-ratio)))
          (<span class="org-keyword">setq</span> cols (1+ cols))
        (<span class="org-keyword">setq</span> rows (1+ rows))))
    (cons cols rows)))
(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">my-get-tile-dimensions</span> ()
  (should (equal (my-get-tile-dimensions 2 2 1 1) (cons 1 2)))
  (should (equal (my-get-tile-dimensions 4 2 1 0.5) (cons 1 4)))
  (should (equal (my-get-tile-dimensions 12 1 1 (/ 4.0 3.0)) (cons 4 3)))
  (should (equal (my-get-tile-dimensions 11 1 1 (/ 4.0 3.0)) (cons 4 3)))
  (should (equal (my-get-tile-dimensions 13 1 1 (/ 4.0 3.0)) (cons 4 4))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-extract-image-filenames</span> (beg end)
  <span class="org-doc">"Return the filenames from the links in this region."</span>
  (<span class="org-keyword">let</span> (files)
    (<span class="org-keyword">save-excursion</span>
      (goto-char (min beg end))
      (<span class="org-keyword">while</span> (re-search-forward <span class="org-string">"sketch:"</span> (max beg end) t)
        (<span class="org-keyword">let</span> ((link (org-element-context)))
          (add-to-list 'files (org-element-property <span class="org-builtin">:path</span> link))))
      files)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-create-sketch-montage</span> (files <span class="org-type">&amp;optional</span> tiles)
  <span class="org-doc">"Combine the sketches in the region."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode)
        (dired-get-marked-files)
      (mapcar 'my-get-sketch-filename
              (my-extract-image-filenames (min (point) (mark)) (max (point) (mark)))))
    (<span class="org-keyword">if</span> current-prefix-arg (read-string <span class="org-string">"Tiling: "</span>))))
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Extract the links</span>
  (<span class="org-keyword">let</span> ((output-file <span class="org-string">"~/Dropbox/Inbox/output.png"</span>))
    (<span class="org-keyword">unless</span> tiles
      (<span class="org-keyword">setq</span> tiles
            (format <span class="org-string">"%dx"</span>
                    (car (my-get-tile-dimensions (length files) 1500 900 (/ 4.0 3))))))
    (<span class="org-keyword">with-temp-buffer</span>
      (cd <span class="org-string">"~/Dropbox/Inbox/To blog"</span>)
      (apply 'call-process
             <span class="org-string">"montage"</span> nil nil nil
             (append
              files
              (list
               <span class="org-string">"-geometry"</span> <span class="org-string">"1500x900&gt;+0+0"</span>
               <span class="org-string">"-tile"</span> tiles
               (expand-file-name output-file)))))
    (<span class="org-keyword">if</span> (called-interactively-p 'any) (find-file output-file))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-create-week-montage</span> (beg end)
  (<span class="org-keyword">interactive</span> <span class="org-string">"r"</span>)
  (<span class="org-keyword">let*</span> ((date (org-read-date nil nil (<span class="org-keyword">unless</span> current-prefix-arg <span class="org-string">"-fri"</span>)))
         (filename (format <span class="org-string">"Week ending %s #journal #weekly"</span> date))
         (full-filename (my-get-sketch-filename filename)))
    (<span class="org-keyword">if</span> full-filename
        (my-org-sketch-open full-filename)
      (my-create-index-card-montage
       (mapcar 'my-get-sketch-filename
               (my-extract-image-filenames (min (point) (mark)) (max (point) (mark))))
       <span class="org-string">"2x"</span>
       (my-prepare-index-card-template filename)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-create-index-card-montage</span> (files <span class="org-type">&amp;optional</span> tiling filename)
  <span class="org-doc">"Prepare an index card with a montage of the selected sketches as a layer."</span>
  (<span class="org-keyword">interactive</span>
   (list
    (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode)
        (dired-get-marked-files)
      (mapcar 'my-get-sketch-filename
              (my-extract-image-filenames (min (point) (mark)) (max (point) (mark)))))))
  (<span class="org-keyword">let</span> ((async-shell-command-buffer 'new-buffer)
        (index-card (<span class="org-keyword">or</span> filename (my-prepare-index-card-template))))
    (my-create-sketch-montage files tiling)
    (shell-command
     (format <span class="org-string">"convert %s </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string"> %s -resize 1500x900 </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"> -colorspace cmyk %s"</span>
             (shell-quote-argument (expand-file-name my-index-card-template-file))
             (shell-quote-argument (expand-file-name <span class="org-string">"~/Dropbox/Inbox/output.png"</span>))
             (shell-quote-argument (expand-file-name index-card))))
    (shell-command (format <span class="org-string">"%s %s &amp;"</span>
                           (shell-quote-argument my-sketch-executable)
                           (shell-quote-argument (expand-file-name index-card))))
    (my-rotate-screen 180)
    (my-set-up-sketch-buffer)))

</pre>
</div>

<p>
add-output-png is:
</p>

<div class="org-src-container">
<pre class="src src-sh">xdotool windowactivate --sync $(<span class="org-sh-quoted-exec">xdotool search --name krita | tail -1</span>); sleep 1
xdotool key --delay 50 Alt+l n m ; sleep 3
xdotool type ~/Dropbox/Inbox/output.png ; sleep 1
xdotool key Return ; sleep 3
xdotool key Alt+l l ; sleep 1
xdotool key Tab Tab ; sleep 1
xdotool type 896 ; sleep 1
xdotool key Return
</pre>
</div>
</div>
</div>
<div id="outline-container-other-sketch-related-functions" class="outline-4">
<h4 id="other-sketch-related-functions">Other sketch-related functions</h4>
<div class="outline-text-4" id="text-other-sketch-related-functions">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-show-sketches-as-slideshow</span> (list <span class="org-type">&amp;optional</span> shuffle)
  <span class="org-doc">"Display a quick slideshow of sketches in LIST.</span>
<span class="org-doc">          If LIST is a string, look up those sketch filenames in my Flickr copy."</span>
  (<span class="org-keyword">interactive</span> <span class="org-string">"MFilter: \nP"</span>)
  (apply 'call-process <span class="org-string">"feh"</span> nil nil nil <span class="org-string">"-D"</span> <span class="org-string">"1"</span> <span class="org-string">"-F"</span> (<span class="org-keyword">if</span> shuffle <span class="org-string">"-z"</span> <span class="org-string">""""</span>)
         (-filter (<span class="org-keyword">lambda</span> (x) (string-match <span class="org-string">"photostream"</span> x))
                  (<span class="org-keyword">if</span> (stringp list)
                      (my-list-sketches list t)
                    list))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-org-index-card-source</span> nil)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-prompt-index-cards</span> ()
  <span class="org-doc">"Display a buffer for easy selection of questions to work on."</span>
  (<span class="org-keyword">interactive</span>)
  (find-file <span class="org-string">"~/personal/questions.org"</span>)
  (<span class="org-keyword">let</span> ((questions
         (cl-sort (org-map-entries 'org-heading-components <span class="org-string">"TODO=\"DRAW\""</span>)
                  '&lt; <span class="org-builtin">:key</span> (<span class="org-keyword">lambda</span> (x) (<span class="org-keyword">or</span> (elt x 3) 100)))))
    (<span class="org-keyword">setq</span> my-org-index-card-source (current-buffer))
    (my-rotate-screen 180)
    (my-set-up-sketch-buffer)
    (mapc (<span class="org-keyword">lambda</span> (q)
            (widget-create 'push-button
                           <span class="org-builtin">:notify</span> (<span class="org-keyword">lambda</span> (widget <span class="org-type">&amp;rest</span> ignore)
                                     (my-org-sketch-open
                                      (my-prepare-index-card-template
                                       (widget-value widget)))
                                     (<span class="org-keyword">with-current-buffer</span> my-org-index-card-source
                                       (<span class="org-keyword">save-excursion</span>
                                         (goto-char (org-find-exact-headline-in-buffer (widget-value widget) my-org-index-card-source t))
                                         (org-set-property <span class="org-string">"Effort"</span> <span class="org-string">"0:15"</span>)
                                         (org-clock-in)
                                         (org-todo <span class="org-string">"LINK"</span>)))
                                     (widget-delete widget))
                           (elt q 4))
            (insert <span class="org-string">"\n"</span>))
          questions)
    (text-scale-set 5)
    (widget-setup)
    (widget-minor-mode)
    (goto-char (point-min))
    (<span class="org-keyword">when</span> (functionp 'scroll-bar-mode) (scroll-bar-mode))
    (switch-to-buffer (current-buffer))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-prepare-index-card-for-journal</span> ()
  <span class="org-doc">"Create an index card for my process journal."</span>
  (<span class="org-keyword">interactive</span>)
  (quantified-track <span class="org-string">"Drawing"</span>)
  (my-prepare-index-card <span class="org-string">"Journal"</span>))

(<span class="org-keyword">with-eval-after-load</span> 'org
  (<span class="org-keyword">let</span> ((listvar (<span class="org-keyword">if</span> (boundp 'org-speed-commands) 'org-speed-commands
                   'org-speed-commands-user)))
    (add-to-list listvar '(<span class="org-string">"d"</span> call-interactively 'my-prepare-index-card-for-subtree))))
</pre>
</div>
</div>
</div>
<div id="outline-container-write-about-half-page-scans" class="outline-4">
<h4 id="write-about-half-page-scans">SOMEDAY Write about half-page scans</h4>
<div class="outline-text-4" id="text-write-about-half-page-scans">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-insert-sketch-and-text</span> (sketch)
  (<span class="org-keyword">interactive</span> (list (my-complete-sketch-filename)))
  (insert (file-name-base sketch)
          (format <span class="org-string">"\n\n[[sketchFull:%s][%s]]\n\n"</span> (file-name-nondirectory sketch) (file-name-base sketch)))
  (insert <span class="org-string">"#+begin_my_details Text from sketch\n"</span>)
  (my-sketch-insert-text-from-json sketch)
  (insert <span class="org-string">"\n#+end_my_details"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-write-about-sketch</span> (sketch)
  (<span class="org-keyword">interactive</span> (list (my-complete-sketch-filename)))
  (shell-command <span class="org-string">"make-sketch-thumbnails"</span>)
  (find-file <span class="org-string">"~/sync/orgzly/posts.org"</span>)
  (goto-char (point-max))
  (org-insert-heading nil nil t)
  (my-insert-sketch-and-text sketch)
  (my-org-11ty-prepare-subtree)
  (delete-other-windows)
  (<span class="org-keyword">save-excursion</span>
    (<span class="org-keyword">with-selected-window</span> (split-window-horizontally)
      (find-file sketch))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-write-about-half-page-scan</span> (filename)
  (<span class="org-keyword">interactive</span> (list (read-file-name (format <span class="org-string">"Sketch (%s): "</span>
                                             (file-name-base (my-latest-file my-scan-directory)))
                                     (expand-file-name my-scan-directory)
                                     (my-latest-file my-scan-directory)
                                     nil
                                     (expand-file-name my-scan-directory)
                                     (<span class="org-keyword">lambda</span> (f) (string-match <span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">jpg</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">png</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> f)))))
  (<span class="org-keyword">let</span> (new-name)
    (shell-command (concat <span class="org-string">"~/bin/prepare-half-page "</span> (shell-quote-argument filename)))
    (<span class="org-keyword">if</span> (string-match <span class="org-string">"[0-9]+-[0-9]+-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[a-z]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">-[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">? .*"</span> (file-name-base filename))
        (<span class="org-keyword">progn</span>
          (rename-file filename (expand-file-name (file-name-nondirectory filename) my-sketches-directory) t)
          (<span class="org-keyword">setq</span> new-name filename))
      (<span class="org-keyword">save-window-excursion</span>
        (find-file filename)
        (<span class="org-keyword">setq</span> new-name (expand-file-name (concat (read-string <span class="org-string">"New name: "</span>) <span class="org-string">"."</span> (file-name-extension filename))
                                         my-sketches-directory))
        (rename-file filename new-name)))
    (my-write-about-sketch new-name)))
</pre>
</div>
</div>
</div>
<div id="outline-container-supernote" class="outline-4">
<h4 id="supernote">Supernote</h4>
<div class="outline-text-4" id="text-supernote">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-supernote-export-dir</span> <span class="org-string">"~/Dropbox/Supernote/EXPORT"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-supernote-process-latest</span> ()
  (<span class="org-keyword">interactive</span>)
  (find-file (my-latest-file my-supernote-export-dir))
  (my-supernote-process-sketch (read-string (format <span class="org-string">"New name for %s: "</span> (file-name-base (buffer-file-name))))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-supernote-export-dired</span> ()
  (<span class="org-keyword">interactive</span>)
  (dired my-supernote-export-dir <span class="org-string">"-tl"</span>))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-supernote-process-sketch</span> (new-name)
  (<span class="org-keyword">interactive</span> (list
                (completing-read <span class="org-string">"New name: "</span> (my-sketches))))
  (<span class="org-keyword">unless</span> (member (file-name-extension new-name) '(<span class="org-string">"png"</span> <span class="org-string">"jpg"</span>))
    (<span class="org-keyword">setq</span> new-name (concat new-name <span class="org-string">"."</span> (file-name-extension (buffer-file-name)))))
  (<span class="org-keyword">let</span> ((dest (<span class="org-keyword">if</span> (string-match <span class="org-string">"#private"</span> new-name)
                  <span class="org-string">"~/sync/private-sketches"</span>
                <span class="org-string">"~/sync/sketches"</span>)))
    (<span class="org-keyword">when</span> (string-match <span class="org-string">" #ccw"</span> new-name)
      (<span class="org-keyword">setq</span> new-name (replace-match <span class="org-string">""</span> t t new-name))
      (call-process <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-rotate"</span> <span class="org-string">"270"</span> (buffer-file-name)))
    (<span class="org-keyword">when</span> (string-match <span class="org-string">" #cw"</span> new-name)
      (<span class="org-keyword">setq</span> new-name (replace-match <span class="org-string">""</span> t t new-name))
      (call-process <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-rotate"</span> <span class="org-string">"90"</span> (buffer-file-name)))
    (<span class="org-keyword">when</span> (file-exists-p (expand-file-name (file-name-nondirectory new-name) dest))
      (delete-file (expand-file-name (file-name-nondirectory new-name) dest)))
    (rename-visited-file
     (expand-file-name (file-name-nondirectory new-name) dest))
    (kill-buffer)))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-open-latest-export</span> ()
  (<span class="org-keyword">interactive</span>)
  (find-file (my-latest-file <span class="org-string">"~/Dropbox/Supernote/EXPORT"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-copy-latest-export-filename</span> ()
  (<span class="org-keyword">interactive</span>)
  (kill-new (my-latest-file <span class="org-string">"~/Dropbox/Supernote/EXPORT"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-supernote-copy-latest-download</span> ()
  (<span class="org-keyword">interactive</span>)
  (call-process <span class="org-string">"sn"</span> nil nil nil (my-latest-file <span class="org-string">"~/Downloads"</span>))
  (message <span class="org-string">"%s"</span> (my-latest-file <span class="org-string">"~/Downloads"</span>)))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-supernote-inbox</span> <span class="org-string">"~/Dropbox/Supernote/INBOX"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-save-manpage-to-supernote</span> (path)
  (<span class="org-keyword">interactive</span> (list (woman-file-name nil)))
  (<span class="org-keyword">unless</span> (file-exists-p path) (<span class="org-keyword">setq</span> path (woman-file-name path)))
  (<span class="org-keyword">let*</span> ((base (file-name-base path))
         (temp-html (make-temp-file base nil <span class="org-string">".html"</span>)))
    (<span class="org-keyword">with-temp-buffer</span>
      (insert-file-contents path)
      (call-process-region (point-min) (point-max) <span class="org-string">"man2html"</span> t t)
      (<span class="org-keyword">when</span> (re-search-backward <span class="org-string">"Invalid Man Page"</span> nil t)
        (delete-file temp-html)
        (<span class="org-warning">error</span> <span class="org-string">"Could not convert."</span>))
      (write-file temp-html))
    (call-process <span class="org-string">"ebook-convert"</span> nil (get-buffer-create <span class="org-string">"*temp*"</span>) nil temp-html
                  (expand-file-name (concat base <span class="org-string">".epub"</span>) my-supernote-inbox))
    (delete-file temp-html)))
</pre>
</div>

<p>
Info file:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-save-info-to-supernote</span> (path)
  (<span class="org-keyword">interactive</span> (list (read-file-name <span class="org-string">"Texi: "</span> nil nil
                                     (<span class="org-keyword">and</span> Info-current-file
                                          (file-exists-p (concat Info-current-file <span class="org-string">".texi"</span>))
                                          (concat Info-current-file <span class="org-string">".texi"</span>))
                                     nil
                                     (<span class="org-keyword">lambda</span> (f)
                                       (<span class="org-keyword">or</span>
                                        (string-match <span class="org-string">"\\.texi\\'"</span> f)
                                        (file-directory-p f))))))
  (call-process <span class="org-string">"texi2pdf"</span> nil <span class="org-string">"*temp*"</span> t (expand-file-name path)
                <span class="org-string">"-o"</span>
                (expand-file-name (concat (file-name-base path) <span class="org-string">".pdf"</span>)
                                                              my-supernote-inbox)))
</pre>
</div>

<p>
And in general:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-supernote-css</span> <span class="org-string">"~/proj/static-blog/assets/css/style.css"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-save-to-supernote</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">cond</span>
   ((derived-mode-p 'Man-mode) (my-save-manpage-to-supernote Man-arguments))
   ((derived-mode-p 'Info-mode)
    (my-save-info-to-supernote
     (<span class="org-keyword">or</span> (<span class="org-keyword">and</span> Info-current-file
              (file-exists-p (concat Info-current-file <span class="org-string">".texi"</span>))
              (concat Info-current-file <span class="org-string">".texi"</span>))
         (read-file-name
          <span class="org-string">"Texi: "</span> nil nil nil nil
          (<span class="org-keyword">lambda</span> (f)
            (<span class="org-keyword">or</span>
             (string-match <span class="org-string">"\\.texi\\'"</span> f)
             (file-directory-p f)))))))
   ((derived-mode-p 'org-mode)
    (org-latex-export-to-pdf)
    (copy-file (concat (file-name-base (buffer-file-name)) <span class="org-string">".pdf"</span>)
               (expand-file-name (concat (file-name-base (buffer-file-name)) <span class="org-string">".pdf"</span>)
                                 my-supernote-inbox) <span class="org-warning">t))</span>
   ((<span class="org-keyword">or</span> (derived-mode-p 'html-mode)
        (derived-mode-p 'web-mode)
        (derived-mode-p 'markdown-mode))
    (call-process <span class="org-string">"pandoc"</span> nil nil nil (buffer-file-name) <span class="org-string">"-t"</span> <span class="org-string">"latex"</span>
                  <span class="org-string">"-o"</span>
                  (expand-file-name (concat (file-name-base (buffer-file-name)) <span class="org-string">".pdf"</span>)
                                    my-supernote-inbox)))
   ((<span class="org-keyword">and</span> (buffer-file-name) (string-match <span class="org-string">"\\.</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">pdf</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">epub</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">$"</span> (buffer-file-name)))
    (copy-file (buffer-file-name)
               (expand-file-name (file-name-nondirectory (buffer-file-name))
                                 my-supernote-inbox)
               t))
   (t
    (<span class="org-keyword">let</span> ((filename (expand-file-name
                     (concat (file-name-base (<span class="org-keyword">or</span> (buffer-file-name)
                                                 (format-time-string <span class="org-string">"%Y-%m-%d-%H-%M-%S"</span>)))
                             <span class="org-string">".pdf"</span>)
                     my-supernote-inbox)))
      (<span class="org-keyword">with-current-buffer</span> (htmlize-buffer)
        (call-process-region
         (point-min) (point-max) <span class="org-string">"wkhtmltopdf"</span> nil nil nil <span class="org-string">"--no-background"</span> <span class="org-string">"-"</span>
         filename))))))

(<span class="org-keyword">setq</span> htmlize-css-name-prefix <span class="org-string">"org-"</span>)
(<span class="org-keyword">setq</span> htmlize-head-tags <span class="org-string">"&lt;link rel=\"stylesheet\" href=\"https://sachachua.com/assets/css/style.css\" /&gt;"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-using-puppeteer-to-grab-an-image-from-the-supernote-s-screen-mirror" class="outline-4">
<h4 id="using-puppeteer-to-grab-an-image-from-the-supernote-s-screen-mirror"><span class="done DONE">DONE</span> Using Puppeteer to grab an image from the SuperNote's screen mirror&#xa0;&#xa0;&#xa0;<span class="tag"><span class="supernote">supernote</span></span></h4>
<div class="outline-text-4" id="text-using-puppeteer-to-grab-an-image-from-the-supernote-s-screen-mirror">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-09-13 Fri] </span></span> I added a <code>mogrify</code> call to automatically trim the image.
</p>

<p>
Partly inspired by John Kitchin's video showing how to <a href="https://www.youtube.com/watch?v=rGGAr1AWkTc">copy
screenshots from his iPad and do optical character recognition</a> so he
can use the images and text in Org Mode, I'd like to be able to draw
quick notes while I'm thinking through a topic on my computer.
</p>

<p>
<a href="https://krita.org/en/">Krita</a> might work, but it's awkward to draw on my tablet PC's screen
when it's in laptop mode because of the angle. Flipping it to
tablet mode is a bit disruptive.
</p>

<p>
I can draw on my Supernote, which feels a bit more natural. I
have a good workflow for ,
but exporting via Dropbox is a little slow since it synchronizes all
the folders. The SuperNote has a built-in screen mirroring mode with
an MJPEG that I can open in a web browser. Saving it to an image is a
little complicated, though. ffmpeg doesn't work with the MJPEG that it
streams, and I can't figure out how to get stuff out aside from using
a browser. I can work around this by using Puppeteer and getting a
screenshot. Here's a NodeJS snippet that saves that screenshot to a file.
</p>

<div class="org-src-container">
<pre class="src src-js"><span class="org-comment-delimiter">/* </span><span class="org-comment">This file is tangled to ~/bin/supernote-screenshot.js from my config at https://sachachua.com/dotemacs</span>
<span class="org-comment">Usage: supernote-screenshot.js [filename]</span>
<span class="org-comment">Set SUPERNOTE_URL to the URL.</span>
<span class="org-comment-delimiter">*/</span>

<span class="org-keyword">const</span> <span class="org-variable-name">process</span> = require(<span class="org-string">'process'</span>);
<span class="org-keyword">const</span> <span class="org-variable-name">puppeteer</span> = require(<span class="org-string">'puppeteer'</span>);
<span class="org-keyword">const</span> <span class="org-variable-name">url</span> = process.env[<span class="org-string">'SUPERNOTE_URL'</span>] || <span class="org-string">'http://192.168.1.221:8080/screencast.mjpeg'</span>;
<span class="org-keyword">const</span> <span class="org-variable-name">scale</span> = 0.5;
<span class="org-keyword">const</span> <span class="org-variable-name">delay</span> = 2000;

<span class="org-keyword">async</span> <span class="org-keyword">function</span> takeSupernoteScreenshot() {
  <span class="org-keyword">const</span> <span class="org-variable-name">browser</span> = <span class="org-keyword">await</span> puppeteer.launch({headless: <span class="org-string">'new'</span>});
  <span class="org-keyword">const</span> <span class="org-variable-name">page</span> = <span class="org-keyword">await</span> browser.newPage();
  <span class="org-keyword">await</span> page.setViewport({width: 2808 * scale, height: 3744 * scale, deviceScaleFactor: 1});
  page.<span class="org-keyword">goto</span>(url);
  <span class="org-keyword">await</span> <span class="org-keyword">new</span> <span class="org-type">Promise</span>((resolve, reject) =&gt; setTimeout(resolve, delay));
  <span class="org-keyword">let</span> <span class="org-variable-name">filename</span> = process.argv[2] || <span class="org-string">'screenshot.png'</span>;
  <span class="org-keyword">await</span> page.screenshot({type: <span class="org-string">'png'</span>, path: filename, fullPage: <span class="org-constant">true</span>});
  <span class="org-keyword">await</span> browser.close();
}

takeSupernoteScreenshot();
</pre>
</div>

<p>
Then I can call that from Emacs Lisp and run it through my usual <a href="https://sachachua.com/dotemacs#org-mode-create-a-quick-timestamped-note-and-capture-a-screenshot">screenshot insertion process</a>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-supernote-screenshot-from-mirror</span> ()
  <span class="org-doc">"Copy the current image from the SuperNote mirror."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((filename (expand-file-name (format-time-string <span class="org-string">"%Y-%m-%d-%H-%M-%S.png"</span>) <span class="org-string">"~/recordings"</span>)))
    (shell-command-to-string (concat <span class="org-string">"NODE_PATH=/usr/lib/node_modules node ~/bin/supernote-screenshot.js "</span> (shell-quote-argument filename)))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">trim it</span>
    (call-process <span class="org-string">"mogrify"</span> nil nil nil <span class="org-string">"-trim"</span> <span class="org-string">"+repage"</span> filename)
    (shell-command-to-string (concat <span class="org-string">"~/bin/recolor.py --colors c0c0c0,f6f396 "</span> (shell-quote-argument filename)))
    (call-interactively 'my-org-insert-screenshot)))
</pre>
</div>

<p>
<span class="timestamp-wrapper"><span class="timestamp">[2024-09-13 Fri] </span></span> I already have some code elsewhere for using the Google Cloud Vision API to extract text from an image, so I should hook that up sometime.
Also, OpenAI supports multimodal requests, so I've been thinking about using AI to recognize text and diagrams like in <a href="https://www.reddit.com/r/Supernote/s/5cINfAEIAA">this Supernote to Markdown example</a>. Fun fun fun!
</p>
</div>
</div>
</div>
<div id="outline-container-tools-for-organizing" class="outline-3">
<h3 id="tools-for-organizing">Tools for organizing</h3>
<div class="outline-text-3" id="text-tools-for-organizing">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">my-rename-bank-statements</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((months '(<span class="org-string">"Jan"</span> <span class="org-string">"Feb"</span> <span class="org-string">"Mar"</span> <span class="org-string">"Apr"</span> <span class="org-string">"May"</span> <span class="org-string">"Jun"</span> <span class="org-string">"Jul"</span> <span class="org-string">"Aug"</span> <span class="org-string">"Sep"</span> <span class="org-string">"Oct"</span> <span class="org-string">"Nov"</span> <span class="org-string">"Dec"</span>)))
    (<span class="org-keyword">cl-loop</span> for i from 1 to 12 do
             (message <span class="org-string">"%d"</span> i)
             (goto-char (point-min))
             (<span class="org-keyword">while</span> (re-search-forward (elt months (1- i)) nil t)
               (<span class="org-keyword">ignore-errors</span>
                 (replace-match (format <span class="org-string">"%02d"</span> i))
                 )))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-rename-scanned-receipts</span> ()
  <span class="org-doc">"Display and rename the scanned or saved files."</span>
  (<span class="org-keyword">interactive</span>)
  (delete-other-windows)
  (mapc (<span class="org-keyword">lambda</span> (o)
          (find-file o)
          (<span class="org-keyword">let</span> ((new-name (concat (read-string <span class="org-string">"New filename: "</span>) <span class="org-string">".jpg"</span>)))
            (kill-buffer)
            (<span class="org-keyword">unless</span> (string= new-name <span class="org-string">".jpg"</span>)
              (rename-file o new-name))))
        (<span class="org-keyword">or</span> (<span class="org-keyword">if</span> (derived-mode-p 'dired-mode)
                (dired-get-marked-files))
            (directory-files default-directory t <span class="org-string">"^[-_0-9]+\\.jpg"</span>))))
</pre>
</div>
</div>
</div>
<div id="outline-container-fun-and-games" class="outline-3">
<h3 id="fun-and-games">Fun and games</h3>
<div class="outline-text-3" id="text-fun-and-games">
</div>
<div id="outline-container-orgbe1004b" class="outline-4">
<h4 id="orgbe1004b"><span class="todo TODO">TODO</span> Make memes from Emacs</h4>
<div class="outline-text-4" id="text-orgbe1004b">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> meme
  <span class="org-comment-delimiter">;</span><span class="org-comment">:quelpa (meme :fetcher github :repo "larsmagne/meme")</span>
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/meme"</span>
  <span class="org-builtin">:init</span> (<span class="org-keyword">provide</span> '<span class="org-constant">imgur</span>)  <span class="org-comment-delimiter">; </span><span class="org-comment">fake this</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> meme-dir <span class="org-string">"~/vendor/meme/images"</span>)
  (<span class="org-keyword">setq</span> meme-font <span class="org-string">"Roboto"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-cubing" class="outline-4">
<h4 id="cubing">Cubing</h4>
<div class="outline-text-4" id="text-cubing">
</div>
<div id="outline-container-rubik-s-cube" class="outline-5">
<h5 id="rubik-s-cube">Rubik's Cube</h5>
<div class="outline-text-5" id="text-rubik-s-cube">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> eagle
  <span class="org-builtin">:quelpa</span> (eagle <span class="org-builtin">:fetcher</span> git
                 <span class="org-builtin">:url</span> <span class="org-string">"https://codeberg.org/akib/emacs-eagle.git"</span>))
(<span class="org-keyword">use-package</span> cube
  <span class="org-builtin">:quelpa</span> (cube <span class="org-builtin">:fetcher</span> git
                <span class="org-builtin">:url</span> <span class="org-string">"https://codeberg.org/akib/emacs-cube.git"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-diagrams" class="outline-5">
<h5 id="diagrams">Diagrams</h5>
<div class="outline-text-5" id="text-diagrams">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Start of cubing code</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-cubing-pos</span> (size n i)
  (list
   (* (/ size n) (% i n))
   (* (/ size n) (/ i n))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-cubing-last-layer-arrows</span> (arrows)
  <span class="org-doc">"Draw ARROWS.</span>
<span class="org-doc">Arrows are defined as a list of lists of the form</span>
<span class="org-doc">((from to) (from to t) ...). Ex: '(my-cubing-last-layer-arrows '((3 1 t) (2 8 t)))</span>
<span class="org-doc">Cells are numbered from left to right, top to bottom, with the top left box being 0.</span>
<span class="org-doc">"</span>
  (<span class="org-keyword">let*</span> ((size 99)
         (n 3)
         (arrow-color <span class="org-string">"#000"</span>)
         (svg (svg-create size size)))
    (svg--append
     svg
     (dom-node
      'defs
      nil
      (dom-node
       'marker
       '((id . <span class="org-string">"arrowhead"</span>)
         (markerWidth . <span class="org-string">"10"</span>)
         (markerHeight . <span class="org-string">"7"</span>)
         (refX . <span class="org-string">"0"</span>)
         (refY . <span class="org-string">"3.5"</span>)
         (orient . <span class="org-string">"auto-start-reverse"</span>))
       (dom-node
        'polygon
        `((fill . ,arrow-color)
          (points . <span class="org-string">"0 0, 4 3.5, 0 7"</span>)))
       )))
    (<span class="org-keyword">dotimes</span> (i (* n n))
      (<span class="org-keyword">let</span> ((pos (my-cubing-pos size n i)))
        (svg-rectangle
         svg
         (car pos)
         (cadr pos)
         (/ size n)
         (/ size n)
         <span class="org-builtin">:fill</span> <span class="org-string">"#fff"</span>
         <span class="org-builtin">:stroke-width</span> 1
         <span class="org-builtin">:stroke</span> <span class="org-string">"#666"</span>)))
    (<span class="org-keyword">dolist</span> (arrow arrows)
      (<span class="org-keyword">let</span> ((from (car arrow))
            (to (cadr arrow)))
        (apply 'svg-line
               (append
                (list svg)
                (mapcar (<span class="org-keyword">lambda</span> (o) (+ o (/ size (* 2 n))))
                        (my-cubing-pos size n from))
                (mapcar (<span class="org-keyword">lambda</span> (o) (+ o (/ size (* 2 n))))
                        (my-cubing-pos size n to))
                (list
                 <span class="org-builtin">:stroke-width</span> 2
                 <span class="org-builtin">:stroke</span> arrow-color
                 <span class="org-builtin">:marker-start</span> (<span class="org-keyword">if</span> (elt arrow 2) <span class="org-string">"url(#arrowhead)"</span>)
                 <span class="org-builtin">:marker-end</span> <span class="org-string">"url(#arrowhead)"</span>)))))
    (<span class="org-keyword">with-temp-buffer</span>
      (svg-print svg)
      (buffer-string))))

(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-cubing-colors</span> '((?R  . <span class="org-string">"#ff0000"</span>)
                           (?G  . <span class="org-string">"#00ff00"</span>)
                           (?B  . <span class="org-string">"#0000ff"</span>)
                           (?O  . <span class="org-string">"#ed7117"</span>)
                           (?Y  . <span class="org-string">"#ffff00"</span>)
                           (?W  . <span class="org-string">"#ffffff"</span>)
                           (?\? . <span class="org-string">"#666666"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-cubing-last-layer-with-sides</span> (sides top arrows)
  <span class="org-doc">"Draw a diagram of the top of the cube.</span>
<span class="org-doc">The style is similar to https://www.cubeskills.com/uploads/pdf/tutorials/pll-algorithms.pdf .</span>
<span class="org-doc">SIDES is a string specifying colors going clockwise from the back-left side.</span>
<span class="org-doc">TOP is a string specifying colors going from left to right, top to bottom.</span>
<span class="org-doc">Arrows are defined as a list of lists of the form ((from to) (from to t) ...).</span>
<span class="org-doc">Cells are numbered from left to right, top to bottom, with the top left box being 0.</span>
<span class="org-doc">Ex: (my-cubing-last-layer-with-sides \"ORRBOOGGGRBB\" \"YYYYYYYYY\" '((3 1 t) (2 8 t)))</span>
<span class="org-doc">"</span>
  (<span class="org-keyword">let*</span> ((size 99)
         (n 3)
         (side-size 10)
         (cell-size (/ (- size (* 2 side-size)) n))
         (arrow-color <span class="org-string">"#000"</span>)
         (svg (svg-create size size)))
    (svg--append
     svg
     (dom-node
      'defs
      nil
      (dom-node
       'marker
       '((id . <span class="org-string">"arrowhead"</span>)
         (markerWidth . <span class="org-string">"10"</span>)
         (markerHeight . <span class="org-string">"7"</span>)
         (refX . <span class="org-string">"0"</span>)
         (refY . <span class="org-string">"3.5"</span>)
         (orient . <span class="org-string">"auto-start-reverse"</span>))
       (dom-node
        'polygon
        `((fill . ,arrow-color)
          (points . <span class="org-string">"0 0, 4 3.5, 0 7"</span>))))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Draw the sides. It's a string of colors going clockwise from back left</span>
    (<span class="org-keyword">when</span> sides
      (<span class="org-keyword">dotimes</span> (i (* n 4))
        (apply 'svg-rectangle
               (append
                (list svg)
                (<span class="org-keyword">pcase</span> (/ i n)
                  (0 (list (+ (* (% i n) cell-size) side-size)
                           0
                           cell-size
                           side-size))
                  (1 (list (+ side-size (* n cell-size))
                           (+ (* (% i n) cell-size) side-size)
                           side-size
                           cell-size))
                  (2 (list (+ (* (- n (% i n) 1) cell-size) side-size)
                           (+ (* n cell-size) side-size)
                           cell-size
                           side-size))
                  (3 (list 0
                           (+ (* (- n (% i n) 1) cell-size) side-size)
                           side-size
                           cell-size)))
                (list
                 <span class="org-builtin">:stroke-width</span> 1
                 <span class="org-builtin">:stroke</span> <span class="org-string">"#666"</span>
                 <span class="org-builtin">:fill</span> (assoc-default (elt sides i)
                                      my-cubing-colors
                                      'eq
                                      (assoc-default ?\? my-cubing-colors)))))))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Draw the top face specified by a string of colors going from left to right, top to bottom</span>
    (<span class="org-keyword">dotimes</span> (i (* n n))
      (<span class="org-keyword">let</span> ((pos (my-cubing-pos (* cell-size n) n i)))
        (svg-rectangle
         svg
         (+ side-size (car pos))
         (+ side-size (cadr pos))
         cell-size
         cell-size
         <span class="org-builtin">:fill</span> (<span class="org-keyword">if</span> top
                   (assoc-default (elt top i) my-cubing-colors
                                  'eq
                                  (assoc-default ?\? my-cubing-colors))
                 (assoc-default ?\? my-cubing-colors))
         <span class="org-builtin">:stroke-width</span> 1
         <span class="org-builtin">:stroke</span> <span class="org-string">"#666"</span>)))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Draw the arrows</span>
    (<span class="org-keyword">dolist</span> (arrow arrows)
      (<span class="org-keyword">let</span> ((from (car arrow))
            (to (cadr arrow)))
        (apply 'svg-line
               (append
                (list svg)
                (mapcar (<span class="org-keyword">lambda</span> (o) (+ side-size o (/ cell-size 2)))
                        (my-cubing-pos (* n cell-size) n from))
                (mapcar (<span class="org-keyword">lambda</span> (o) (+ side-size o (/ cell-size 2)))
                        (my-cubing-pos (* n cell-size) n to))
                (list
                 <span class="org-builtin">:stroke-width</span> 2
                 <span class="org-builtin">:stroke</span> arrow-color
                 <span class="org-builtin">:opacity</span> 0.5
                 <span class="org-builtin">:marker-start</span> (<span class="org-keyword">if</span> (elt arrow 2) <span class="org-string">"url(#arrowhead)"</span>)
                 <span class="org-builtin">:marker-end</span> <span class="org-string">"url(#arrowhead)"</span>)))))
    (<span class="org-keyword">with-temp-buffer</span>
      (svg-print svg)
      (buffer-string))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">end of cubing code</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-minecraft" class="outline-4">
<h4 id="minecraft">Minecraft</h4>
<div class="outline-text-4" id="text-minecraft">
<p>
<a href="https://github.com/rasensuihei/mcf">https://github.com/rasensuihei/mcf</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> mcf
  <span class="org-comment-delimiter">;</span><span class="org-comment">:quelpa (mcf :fetcher github :repo "sachac/mcf")</span>
  <span class="org-builtin">:load-path</span> <span class="org-string">"~/vendor/mcf"</span>
  <span class="org-builtin">:mode</span> (<span class="org-string">"\\.mcfunction\\'"</span> . mcf-mode)
  <span class="org-comment-delimiter">;; </span><span class="org-comment">rcon settings are in my .emacs.secrets file</span>
  <span class="org-builtin">:commands</span> (mcf-rcon mcf-mode)
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-typing-of-emacs" class="outline-4">
<h4 id="typing-of-emacs">Typing of Emacs</h4>
<div class="outline-text-4" id="text-typing-of-emacs">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> typing <span class="org-builtin">:disabled</span> t
  <span class="org-builtin">:init</span>
  (autoload 'typing-of-emacs <span class="org-string">"typing"</span> nil t)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">progn</span>
    (<span class="org-keyword">setq</span> toe-starting-length 6)
    (<span class="org-keyword">setq</span> toe-starting-time-per-word 2)
    (<span class="org-keyword">setq</span> toe-max-length 20)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-speech-synthesis-experimental" class="outline-3">
<h3 id="speech-synthesis-experimental">Speech synthesis (experimental)</h3>
<div class="outline-text-3" id="text-speech-synthesis-experimental">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-espeak-command</span> <span class="org-string">"c:/program files (x86)/espeak/command_line/espeak.exe"</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-say</span> (string <span class="org-type">&amp;optional</span> speed)
  (<span class="org-keyword">interactive</span> <span class="org-string">"MString: "</span>)
  (<span class="org-keyword">setq</span> speed (<span class="org-keyword">or</span> speed 175))
  (call-process my-espeak-command nil nil nil string <span class="org-string">"-s"</span> speed))
</pre>
</div>
</div>
</div>
<div id="outline-container-shopping" class="outline-3">
<h3 id="shopping">Comparison-shopping with Org Mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="emacs">emacs</span>&#xa0;<span class="org">org</span></span></h3>
<div class="outline-text-3" id="text-shopping">
<p>
I don't like shopping. We're lucky to be able to choose, but I get
overwhelmed with all the choices. I'm trying to get the hang of it,
though, since I'll need to shop for lots of things for A- over the
years. One of the things that's stressful is comparing choices between
different webpages, especially if I want to get A-'s opinion on
something. Between the challenge of remembering things as we flip
between pages and the temptations of other products she sees along the
way&#x2026; Ugh.
</p>

<p>
I think there are web browser extensions for shopping, but I prefer to
work within Org Mode so that I can capture links from my phone's web
browser, refile entries into different categories, organize them with
keyboard shortcuts, and tweak things the way I like. So if I have
subheadings with the <code>NAME</code>, <code>PRICE</code>, <code>IMAGE</code>, and <code>URL</code> properties, I
can make a table that looks like this:
</p>


<figure id="org1be078a">
<img src="images/comparison-shopping.png" alt="comparison-shopping.png">

<figcaption><span class="figure-number">Figure 14: </span>Comparison-shopping</figcaption>
</figure>

<p>
using code that looks like this:
</p>

<div class="org-src-container">
<pre class="src src-org"><span class="org-org-block-begin-line">#+begin_src emacs-lisp :eval yes :exports results :wrap EXPORT html</span>
<span class="org-org-block">(my-org-format-shopping-subtree)</span>
<span class="org-org-block-end-line">#+end_src</span>
</pre>
</div>

<p>
and I can view the table by exporting the subtree with HTML using
<code>org-export-dispatch</code> (<code>C-c C-e C-s h o</code>). When I add new items, I can
use <code>C-u C-c C-e</code> to reexport the subtree without navigating up to the
root.
</p>

<p>
Here's the very rough code I use for that:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defvar</span> <span class="org-variable-name">my-get-shopping-details-functions</span> '(my-get-shopping-details-amazon my-get-shopping-details-uniqlo my-get-shopping-details-manually))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-shopping-details-manually</span> (link)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"theshoecompany</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">|</span></span><span class="org-string">dsw"</span> link)
    (browse-url link)
    (list
     (cons 'url link)
     (cons 'image (read-string <span class="org-string">"Image: "</span>))
     (cons 'price (read-string <span class="org-string">"Price: "</span>)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-shopping-details-amazon</span> (link)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"amazon.ca"</span> link)
    (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously link)
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"^$"</span>)
      (<span class="org-keyword">let</span> ((doc (libxml-parse-html-region (point) (point-max))))
        (list (cons 'name (dom-text (dom-by-tag doc 'title)))
              (cons 'description (dom-texts (dom-by-id doc <span class="org-string">"productDescription"</span>)))
              (cons 'image (<span class="org-keyword">dom-attr</span> (dom-by-tag (dom-by-id doc <span class="org-string">"imgTagWrapperId"</span>) 'img) 'src))
              (cons 'price
                    (dom-texts (dom-by-id doc <span class="org-string">"priceblock_ourprice"</span>))))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-shopping-details</span> ()
  (goto-char (point-min))
  (<span class="org-keyword">let</span> (data)
    (<span class="org-keyword">cond</span>
     ((re-search-forward <span class="org-string">"  data-section-data</span>
<span class="org-string">&gt;"</span> nil t)
      (<span class="org-keyword">setq</span> data (json-read))
      (<span class="org-keyword">let-alist</span> data
        (list (cons 'name .product.title)
              (cons 'brand .product.vendor)
              (cons 'description .product.description)
              (cons 'image (concat <span class="org-string">"https:"</span> .product.featured_image))
              (cons 'price (/ .product.price 100.0)))))
     ((<span class="org-keyword">and</span> (re-search-forward <span class="org-string">"&lt;script type=\"application/ld\\+json\"&gt;"</span> nil t)
           (null (re-search-forward <span class="org-string">"Fabric Fabric"</span> nil t))) <span class="org-comment-delimiter">; </span><span class="org-comment">Carter's, Columbia?</span>
      (<span class="org-keyword">setq</span> data (json-read))
      (<span class="org-keyword">if</span> (vectorp data) (<span class="org-keyword">setq</span> data (elt data 0)))
      (<span class="org-keyword">if</span> (assoc-default '@graph data)
          (<span class="org-keyword">setq</span> data (assoc-default '@graph data)))
      (<span class="org-keyword">if</span> (vectorp data) (<span class="org-keyword">setq</span> data (elt data 0)))
      (<span class="org-keyword">let-alist</span> data
        (list (cons 'name .name)
              (cons 'url (<span class="org-keyword">or</span> .url .@id))
              (cons 'brand .brand.name)
              (cons 'description .description)
              (cons 'rating .aggregateRating.ratingValue)
              (cons 'ratingCount .aggregateRating.reviewCount)
              (cons 'image (<span class="org-keyword">cond</span>
                            ((stringp .image) .image)
                            ((stringp .image.url) .image.url)
                            (t (elt .image 0))))
              (cons 'price
                    (assoc-default 'price (<span class="org-keyword">cond</span>
                                           ((arrayp .offers)
                                            (elt .offers 0))
                                           (t .offers)))))))
     (t
      (goto-char (point-min))
      (re-search-forward <span class="org-string">"^$"</span>)
      (<span class="org-keyword">let*</span> ((doc (libxml-parse-html-region (point) (point-max)))
             (result
              `((name . ,(string-trim (dom-text (dom-by-tag doc <span class="org-string">"title"</span>))))
                (description . ,(string-trim (dom-text (dom-by-tag doc <span class="org-string">"title"</span>)))))
              ))
        (mapc (<span class="org-keyword">lambda</span> (property)
                (<span class="org-keyword">let</span> ((node
                       (dom-search
                        doc
                        (<span class="org-keyword">lambda</span> (o)
                          (delq nil
                                (mapcar (<span class="org-keyword">lambda</span> (p)
                                          (<span class="org-keyword">or</span> (string= (<span class="org-keyword">dom-attr</span> o 'property) p)
                                              (string-match p (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> o 'class) <span class="org-string">""</span>))))
                                        (cdr property)))))))
                  (<span class="org-keyword">when</span> node (add-to-list 'result (cons (car property)
                                                        (<span class="org-keyword">or</span> (<span class="org-keyword">dom-attr</span> node 'content)
                                                            (string-trim (dom-text node))))))))
              '((name <span class="org-string">"og:title"</span> <span class="org-string">"pdp-product-title"</span>)
                (brand <span class="org-string">"og:brand"</span>)
                (url <span class="org-string">"og:url"</span>)
                (image <span class="org-string">"og:image"</span>)
                (description <span class="org-string">"og:description"</span>)
                (price <span class="org-string">"og:price:amount"</span> <span class="org-string">"product:price:amount"</span> <span class="org-string">"pdp-price-label"</span>)))
        result)
      ))))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-insert-shopping-details</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (org-insert-heading)
    (<span class="org-keyword">save-excursion</span> (yank))
    (my-org-update-shopping-details)
    (<span class="org-keyword">when</span> (org-entry-get (point) <span class="org-string">"NAME"</span>)
      (org-edit-headline (org-entry-get (point) <span class="org-string">"NAME"</span>)))))


<span class="org-comment-delimiter">;; </span><span class="org-comment">(my-org-get-shopping-details-uniqlo "https://www.uniqlo.com/ca/en/products/E451023-000?colorCode=COL07&amp;sizeCode=KSS020")</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-update-shopping-details</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">when</span> (re-search-forward org-link-any-re (<span class="org-keyword">save-excursion</span> (org-end-of-subtree)) t)
    (<span class="org-keyword">let*</span> ((link (org-element-property <span class="org-builtin">:raw-link</span> (org-element-context)))
           data)
      (<span class="org-keyword">setq</span>
       data
       (<span class="org-keyword">or</span> (run-hook-with-args-until-success 'my-get-shopping-details-functions link)
           (<span class="org-keyword">with-current-buffer</span> (url-retrieve-synchronously link)
             (my-get-shopping-details))))
      (<span class="org-keyword">when</span> data
        (<span class="org-keyword">let-alist</span> data
          (org-entry-put (point) <span class="org-string">"NAME"</span> .name)
          (org-entry-put (point) <span class="org-string">"URL"</span> link)
          (org-entry-put (point) <span class="org-string">"BRAND"</span> .brand)
          (org-entry-put (point) <span class="org-string">"DESCRIPTION"</span> (replace-regexp-in-string <span class="org-string">"&amp;#039;"</span> <span class="org-string">"'"</span> (replace-regexp-in-string <span class="org-string">"\n"</span> <span class="org-string">" "</span> (<span class="org-keyword">or</span> .description <span class="org-string">""</span>))))
          (org-entry-put (point) <span class="org-string">"IMAGE"</span>
                         (<span class="org-keyword">if</span> (string-match <span class="org-string">"https?"</span> .image)
                             .image
                           (concat <span class="org-string">"https:"</span> .image)))
          (org-entry-put (point) <span class="org-string">"PRICE"</span> (<span class="org-keyword">cond</span> ((stringp .price) .price) ((numberp .price) (format <span class="org-string">"%.2f"</span> .price)) (t <span class="org-string">""</span>)))
          (<span class="org-keyword">if</span> .rating (org-entry-put (point) <span class="org-string">"RATING"</span> (<span class="org-keyword">if</span> (stringp .rating) .rating (format <span class="org-string">"%.1f"</span> .rating))))
          (<span class="org-keyword">if</span> .ratingCount (org-entry-put (point) <span class="org-string">"RATING_COUNT"</span> (<span class="org-keyword">if</span> (stringp .ratingCount) .ratingCount (number-to-string .ratingCount))))
          )))))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-org-format-shopping-subtree</span> (<span class="org-type">&amp;optional</span> height large)
  (concat
   <span class="org-string">"&lt;style&gt;body { max-width: 100% !important } #content { max-width: 100% !important } .item img { max-height: "</span>
   (<span class="org-keyword">or</span> height <span class="org-string">"100px"</span>)
   <span class="org-string">" } .item img:hover { max-height: "</span> (<span class="org-keyword">or</span> large <span class="org-string">"400px"</span>) <span class="org-string">" }&lt;/style&gt;&lt;div style=\"display: flex; flex-wrap: wrap; align-items: flex-start\"&gt;"</span>
   (string-join
    (<span class="org-keyword">save-excursion</span>
      (org-map-entries
       (<span class="org-keyword">lambda</span> ()
         (<span class="org-keyword">if</span> (org-entry-get (point) <span class="org-string">"URL"</span>)
             (format
              <span class="org-string">"&lt;div class=item style=\"width: %s\"&gt;&lt;div&gt;&lt;a href=\"%s\"&gt;&lt;img src=\"%s\" height=100&gt;&lt;/a&gt;&lt;/div&gt;</span>
<span class="org-string">&lt;div&gt;%s&lt;/div&gt;</span>
<span class="org-string">&lt;div&gt;&lt;a href=\"%s\"&gt;%s&lt;/a&gt;&lt;/div&gt;</span>
<span class="org-string">&lt;div&gt;%s&lt;/div&gt;</span>
<span class="org-string">&lt;div&gt;%s&lt;/div&gt;&lt;/div&gt;"</span>
              (<span class="org-keyword">or</span> height <span class="org-string">"200px"</span>)
              (org-entry-get (point) <span class="org-string">"URL"</span>)
              (org-entry-get (point) <span class="org-string">"IMAGE"</span>)
              (<span class="org-keyword">or</span>  (org-entry-get (point) <span class="org-string">"PRICE"</span>) <span class="org-string">""</span>)
              (org-entry-get (point) <span class="org-string">"URL"</span>)
              (url-domain (url-generic-parse-url (org-entry-get (point) <span class="org-string">"URL"</span>)))
              (<span class="org-keyword">or</span> (org-entry-get (point) <span class="org-string">"NAME"</span>) <span class="org-string">""</span>)
              (<span class="org-keyword">or</span> (org-entry-get (point) <span class="org-string">"NOTES"</span>) <span class="org-string">""</span>))
           <span class="org-string">""</span>))
       nil
       (<span class="org-keyword">if</span> (org-before-first-heading-p) nil 'tree)))
    <span class="org-string">""</span>)
   <span class="org-string">"&lt;/div&gt;"</span>))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-get-shopping-details-uniqlo</span> (link)
  (<span class="org-keyword">when</span> (string-match <span class="org-string">"https://www.uniqlo.com/ca/en/products/</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">?]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\?</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">.*</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">?"</span> link)
    (<span class="org-keyword">let</span> ((code (match-string 1 link))
          (params (org-protocol-convert-query-to-plist (match-string 3 link)))
          item)
      (<span class="org-keyword">setq</span> item
            (car
             (assoc-default
              'items
              (assoc-default
               'result
               (<span class="org-keyword">with-current-buffer</span>
                   (url-retrieve-synchronously
                    (concat <span class="org-string">"https://www.uniqlo.com/ca/api/commerce/v3/en/products/"</span> code))
                 (goto-char (point-min))
                 (re-search-forward <span class="org-string">"^$"</span>)
                 (json-parse-buffer <span class="org-builtin">:object-type</span> 'alist <span class="org-builtin">:array-type</span> 'list <span class="org-builtin">:null-object</span> nil))))))
      (list
       (cons 'price
             (<span class="org-keyword">or</span> (assoc-default
                  'value
                  (<span class="org-keyword">or</span>
                   (assoc-default 'promo (assoc-default 'prices item))
                   (assoc-default 'base (assoc-default 'prices item))))
                 <span class="org-string">""</span>))
       (cons 'image
             (assoc-default
              'url
              (seq-find
               (<span class="org-keyword">lambda</span> (entry)
                 (<span class="org-keyword">or</span> (null (plist-get params <span class="org-builtin">:colorCode</span>))
                     (string=
                      (concat <span class="org-string">"COL"</span> (<span class="org-keyword">or</span> (assoc-default 'colorCode entry) <span class="org-string">""</span>))
                      (plist-get params <span class="org-builtin">:colorCode</span>))))
               (assoc-default 'main (assoc-default 'images item)))))
       (cons 'price
             (<span class="org-keyword">or</span> (assoc-default
                  'value
                  (assoc-default
                   'promo
                   (assoc-default 'prices item)))
                 (assoc-default 'base (assoc-default 'prices item))
                 <span class="org-string">""</span>))
       (cons 'name
             (assoc-default 'name item))
       (cons 'description
             (concat (assoc-default 'longDescription item) <span class="org-string">" - "</span>
                     (assoc-default 'washingDescription item)))
       (cons 'url link)))))
</pre>
</div>

<p>
At some point, it would be nice to keep track of how I feel about
different return policies, and to add more rules for automatically
extracting information from different websites. (<a href="https://github.com/Chobbes/org-chef">org-chef</a> might be a
good model.) In the meantime, this makes it a little less stressful to
look for stuff.
</p>
</div>
</div>
</div>
<div id="outline-container-style-stuff" class="outline-2">
<h2 id="style-stuff">Style stuff and other exports</h2>
<div class="outline-text-2" id="text-style-stuff">
<style>
@font-face {
    font-family: 'sachacHand-Regular';
    font-display: swap;
    src: local('sachacHand Regular'), url(/assets/sachacHand-Regular.woff), url(https://sachachua.com/assets/sachacHand-Regular.woff);
}
h1, h2, h3, h4, h5, h6 {
    font-family: 'sachacHand-Regular',"Helvetica Neue","Helvetica",Helvetica,Arial,sans-serif;
    font-weight: normal;
}
h1 { font-size: 400% }
h2 { font-size: 285.7% }
h3 { font-size: 228.5% }
h4 { font-size: 171.4% }
h5 { font-size: 150% }
h6 { font-size: 100% }

</style>

<p>
Update the URL as we scroll: (<a href="https://stackoverflow.com/questions/14660580/change-url-when-manually-scrolled-to-an-anchor">based on this</a>)
</p>

<script>
function updateHref() {
  let all = document.querySelectorAll('#text-table-of-contents .active > a');
  if (all.length == 0) return;
  let active = all[all.length - 1];
  if (active && active.href != window.location.hash) {
    let loc = window.location.toString().split('#')[0];
    let hash = active.href.split('#')[1];
    history.replaceState(null, null, loc + '#' + hash);
  }
}
window.addEventListener('DOMContentLoaded', function() {
  $(window).on('activate.bs.scrollspy', updateHref);
});
</script>

<p>
You can <a href="mailto:sacha@sachachua.com">e-mail me</a> or <a rel="me" href="https://emacs.ch/@sachac">find me on Mastodon</a>.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Sacha Chua</p>
<p class="date">Created: 2024-09-16 Mon 09:36</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
